package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import java.io.Serializable;
import de.itemis.mps.editor.diagram.runtime.model.SerializableObjectHolder;
import jetbrains.mps.nodeEditor.cells.EditorCell;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import de.itemis.mps.editor.celllayout.runtime.LayoutInterceptor;
import de.itemis.mps.editor.diagram.runtime.model.ScalableEditorCell;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import com.mxgraph.view.mxCellState;
import java.awt.Graphics2D;
import de.itemis.mps.editor.celllayout.runtime.BorderPainter;
import de.itemis.mps.editor.diagram.runtime.EditorUtil;
import java.awt.geom.Rectangle2D;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import de.itemis.mps.editor.celllayout.boxmodel.Size;
import de.itemis.mps.editor.celllayout.runtime.IEditorCellBasedLayoutable;
import de.itemis.mps.editor.celllayout.runtime.LayoutableAdapters;
import de.itemis.mps.editor.celllayout.runtime.LayoutEngine;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import de.itemis.mps.editor.celllayout.layout.ILayoutable;
import java.awt.event.MouseEvent;
import jetbrains.mps.openapi.editor.EditorComponent;
import jetbrains.mps.openapi.editor.cells.CellConditions;
import jetbrains.mps.nodeEditor.cells.EditorCell_Label;
import de.itemis.mps.selection.runtime.SelectionUtil;
import com.intellij.openapi.util.SystemInfo;
import jetbrains.mps.openapi.editor.selection.SelectionManager;
import jetbrains.mps.openapi.editor.selection.Selection;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.openapi.editor.cells.CellTraversalUtil;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import de.itemis.mps.editor.celllayout.layout.IndentLayout;

public class MPSCell implements Serializable {

  public static String OVERRIDDEN_MAX_WIDTH_KEY = MPSCell.class.getName() + "_OVERRIDDEN_MAX_WIDTH_KEY";

  private SerializableObjectHolder<EditorCell> myMPSCell;
  @NotNull
  private SerializableObjectHolder<MyGraph> myGraph;

  private double myAdditionalScale = 1.0;
  private double myStateRelativeX;
  private double myStateRelativeY;
  private SerializableObjectHolder<Tuples._2<Double, Double>> myMinSize;
  private IMPSCellContainer myContainer;

  protected MPSCell(@NotNull jetbrains.mps.openapi.editor.cells.EditorCell cell, @NotNull MyGraph graph, IMPSCellContainer container) {
    if (cell == null) {
      throw new NullPointerException();
    }
    myMPSCell = new SerializableObjectHolder<EditorCell>((EditorCell) cell);
    myGraph = new SerializableObjectHolder<MyGraph>(graph);
    myContainer = container;
  }

  public MyGraph getGraph() {
    return myGraph.get();
  }

  public jetbrains.mps.openapi.editor.cells.EditorCell getEditorCell() {
    return myMPSCell.get();
  }

  public void relayout() {
    LayoutInterceptor.installRecursive(getEditorCell());
    ScalableEditorCell.withScalingDisabled(() -> {
      jetbrains.mps.openapi.editor.cells.EditorCell editorCell = getEditorCell();
      LayoutDependencies.getInstance(editorCell).layout(editorCell);
      myMinSize = new SerializableObjectHolder<Tuples._2<Double, Double>>(MultiTuple.<Double,Double>from((double) LayoutDependencies.getWidth(editorCell), (double) LayoutDependencies.getHeight(editorCell)));
    });
  }

  public void setAdditionalScale(double scale) {
    myAdditionalScale = scale;
  }

  public double getTotalScale() {
    return getViewScale() * myAdditionalScale;
  }

  protected double getViewScale() {
    return myGraph.get().getView().getScale();
  }

  public double getExpectedX() {
    BaseDCell container = (BaseDCell) getContainer();
    mxCellState state = CellExtensions.getGraph(container).getView().getState(container);
    return getDiagramCell().getX() + state.getX() + myStateRelativeX;
  }

  public double getExpectedY() {
    BaseDCell container = (BaseDCell) getContainer();
    mxCellState state = CellExtensions.getGraph(container).getView().getState(container);
    return getDiagramCell().getY() + state.getY() + myStateRelativeY;
  }

  public void setStateRelativePos(double x, double y) {
    myStateRelativeX = x;
    myStateRelativeY = y;
    moveCell();
  }

  public double getStateRelativeX() {
    return myStateRelativeX;
  }

  public double getStateRelativeY() {
    return myStateRelativeY;
  }

  public void paint(final Graphics2D g_, final mxCellState state) {
    if (getTotalScale() < 0.1) {
      // you can't read anything
      return;
    }
    ScalableEditorCell.withScalingDisabled(() -> DrawUtil.executeWithGraphicsCopy(g_, (Graphics2D g) -> {
      g.clip(ExtensionMethods.toRectangle2D(state));
      g.translate(getStateRelativeX(), getStateRelativeY());
      g.translate(state.getX(), state.getY());
      g.scale(getTotalScale(), getTotalScale());
      EditorCell cell = myMPSCell.get();
      g.translate(-cell.getX(), -cell.getY());
      cell.paint(g);
      BorderPainter painter = new BorderPainter();
      painter.paintBorders(g, cell, true);
      painter.processQueue(g);

    }));
  }

  protected void moveCell() {
    EditorCell cell = myMPSCell.get();
    if (cell != null) {
      EditorUtil.forceMoveTo(cell, de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt(getExpectedX()), de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt(getExpectedY()));
    }
  }

  public Rectangle2D getBounds() {
    return EditorUtil.getBounds(myMPSCell.get());
  }

  public Rectangle2D getScaledBounds() {
    Rectangle2D unscaled = getBounds();
    return new Rectangle2D.Double(unscaled.getX(), unscaled.getY(), unscaled.getWidth() * getTotalScale(), unscaled.getHeight() * getTotalScale());
  }

  public boolean trySetSize(double width, double height) {
    jetbrains.mps.openapi.editor.cells.EditorCell editorCell = getEditorCell();
    List<SubDiagramECell> subdiagrams = EditorUtil.firstLevelDescendants(editorCell, SubDiagramECell.class);
    if (ListSequence.fromList(subdiagrams).isEmpty()) {
      return false;
    }

    ListSequence.fromList(subdiagrams).visitAll((it) -> it.clearFixedSize());

    final Wrappers._T<Size> size = new Wrappers._T<Size>(new Size(de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt(width), de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt(height)));
    IEditorCellBasedLayoutable layoutable = LayoutableAdapters.getAdapter(editorCell);
    size.value = size.value.max(layoutable.getMinSize(size.value));
    size.value = size.value.min(layoutable.getMaxSize(size.value));
    // The layouter is not able to shrink the height at the moment
    size.value = size.value.max(layoutable.getPreferredSize(size.value).deriveWidth(0));

    new LayoutEngine().layoutSubtree(editorCell, new _FunctionTypes._void_P1_E0<ILayoutable>() {
      public void invoke(ILayoutable layoutable) {
        layoutable.setSize(size.value.getWidth(), size.value.getHeight());
      }
    });

    return true;
  }

  public Rectangle2D getBoundsInDiagram() {
    BaseDCell container = (BaseDCell) getContainer();
    mxCellState state = CellExtensions.getGraph(container).getView().getState(container);
    EditorCell cell = myMPSCell.get();
    Rectangle2D.Double bounds = new Rectangle2D.Double(state.getX() + myStateRelativeX, state.getY() + myStateRelativeY, getTotalScale() * LayoutDependencies.getWidth(cell), getTotalScale() * LayoutDependencies.getHeight(cell));
    return bounds;
  }

  /**
   * Position in the diagram to position in the MPS cell (in EditorComponent coordinates)
   */
  public Tuples._2<Double, Double> convertPosition(double x, double y) {
    BaseDCell container = (BaseDCell) getContainer();
    mxCellState state = CellExtensions.getGraph(container).getView().getState(container);
    jetbrains.mps.openapi.editor.cells.EditorCell cell = myMPSCell.get();
    return MultiTuple.<Double,Double>from(LayoutDependencies.getX(cell) + (x - state.getX() - myStateRelativeX) / getTotalScale(), LayoutDependencies.getY(cell) + (y - state.getY() - myStateRelativeY) / getTotalScale());
  }

  public jetbrains.mps.openapi.editor.cells.EditorCell findLeaf(double x, double y) {
    final Wrappers._double _x = new Wrappers._double(x);
    final Wrappers._double _y = new Wrappers._double(y);
    {
      Tuples._2<Double, Double> _tmp_gfmb0p_a0yb = convertPosition(_x.value, _y.value);
      _x.value = _tmp_gfmb0p_a0yb._0();
      _y.value = _tmp_gfmb0p_a0yb._1();
    }
    final jetbrains.mps.openapi.editor.cells.EditorCell cell = myMPSCell.get();
    final Wrappers._T<jetbrains.mps.openapi.editor.cells.EditorCell> leaf = new Wrappers._T<jetbrains.mps.openapi.editor.cells.EditorCell>();
    ScalableEditorCell.withScalingDisabled(() -> leaf.value = cell.findLeaf(de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt(_x.value), de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt(_y.value)));
    return leaf.value;
  }

  public RootDiagramECell getDiagramCell() {
    for (jetbrains.mps.openapi.editor.cells.EditorCell c = myMPSCell.get(); c != null; c = c.getParent()) {
      if (c instanceof RootDiagramECell) {
        return (RootDiagramECell) c;
      }
    }
    return null;
  }

  public boolean couldHandleMouseEvent(MouseEvent event) {
    return getBoundsInDiagram().contains(event.getX(), event.getY());
  }

  public boolean handleMouseEvent(MouseEvent event) {
    if (couldHandleMouseEvent(event)) {
      Tuples._2<Double, Double> convertedPosition = convertPosition(event.getX(), event.getY());
      boolean handled = handleMouseEvent(event, myMPSCell.get(), de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt((double) convertedPosition._0()), de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt((double) convertedPosition._1()), getTotalScale());
      if (handled) {
        return true;
      }
    }
    return false;
  }

  public boolean setSelection(double x, double y) {
    final Wrappers._double _x = new Wrappers._double(x);
    final Wrappers._double _y = new Wrappers._double(y);
    final jetbrains.mps.openapi.editor.cells.EditorCell cell = myMPSCell.get();
    if (cell == null) {
      return false;
    }
    {
      Tuples._2<Double, Double> _tmp_gfmb0p_c0gc = convertPosition(_x.value, _y.value);
      _x.value = _tmp_gfmb0p_c0gc._0();
      _y.value = _tmp_gfmb0p_c0gc._1();
    }
    EditorComponent editorComponent = cell.getEditorComponent();
    final Wrappers._T<jetbrains.mps.openapi.editor.cells.EditorCell> leaf = new Wrappers._T<jetbrains.mps.openapi.editor.cells.EditorCell>();
    ScalableEditorCell.withScalingDisabled(() -> leaf.value = cell.findNearestLeafOnLine(de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt(_x.value), de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt(_y.value), CellConditions.SELECTABLE));
    if (leaf.value == null) {
      return false;
    }
    if (leaf.value instanceof EditorCell_Label) {
      EditorCell_Label label = (EditorCell_Label) leaf.value;
      int caretPos = SelectionUtil.xCoordToCaretPos(label, de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods.toInt(_x.value));
      editorComponent.getSelectionManager().setSelection(label, caretPos);
    } else {
      editorComponent.getSelectionManager().setSelection(leaf.value);
    }
    return true;
  }

  public static boolean handleMouseEvent(MouseEvent event, EditorCell cell, int convertedX, int convertedY, double scale) {
    if (event.getID() == MouseEvent.MOUSE_PRESSED && event.getButton() == MouseEvent.BUTTON1) {
      boolean ctrlDown = (SystemInfo.isMac ? event.isMetaDown() : event.isControlDown());
      if (ctrlDown) {
        jetbrains.mps.nodeEditor.EditorComponent editorComponent = (jetbrains.mps.nodeEditor.EditorComponent) cell.getEditorComponent();
        jetbrains.mps.openapi.editor.cells.EditorCell leaf = cell.findLeaf(convertedX, convertedY);
        editorComponent.getSelectionManager().setSelection(leaf);

        if (event.isAltDown()) {
          editorComponent.showCellError();
        } else {
          editorComponent.goByCurrentReference();
        }
        return true;
      } else {
        boolean changed = changeSelection(convertedX, convertedY, event, cell);
        return true;
      }
    }
    return false;
  }

  public static boolean changeSelection(int x, int y, MouseEvent sourceEvent, EditorCell cell) {
    EditorComponent editorComponent = cell.getEditorComponent();
    jetbrains.mps.openapi.editor.cells.EditorCell newSelectedCell = cell.findLeaf(x, y);
    SelectionManager selectionManager = editorComponent.getSelectionManager();
    if (newSelectedCell != null && newSelectedCell.isSelectable() && (sourceEvent.getButton() != MouseEvent.BUTTON3 || !(isUnderSelection(selectionManager.getSelection(), newSelectedCell)))) {
      selectionManager.setSelection(newSelectedCell);
      jetbrains.mps.nodeEditor.EditorComponent destination = (jetbrains.mps.nodeEditor.EditorComponent) editorComponent;
      MouseEvent convertedEvent = new MouseEvent(destination, sourceEvent.getID(), sourceEvent.getWhen(), sourceEvent.getModifiers() | sourceEvent.getModifiersEx(), x, y, sourceEvent.getXOnScreen(), sourceEvent.getYOnScreen(), sourceEvent.getClickCount(), sourceEvent.isPopupTrigger(), sourceEvent.getButton());
      ((EditorCell) newSelectedCell).processMousePressed(convertedEvent);
      return true;
    }
    return false;
  }


  private static boolean isUnderSelection(Selection selection, jetbrains.mps.openapi.editor.cells.EditorCell cell) {
    return ((Boolean) ReflectionUtil.callMethod(jetbrains.mps.nodeEditor.EditorComponent.class, ((jetbrains.mps.nodeEditor.EditorComponent) cell.getEditorComponent()), "isUnderSelection", new Class[]{Selection.class, jetbrains.mps.openapi.editor.cells.EditorCell.class}, new Object[]{selection, cell}));
  }

  public Tuples._2<Double, Double> getMinSize() {
    jetbrains.mps.openapi.editor.cells.EditorCell editorCell = this.getEditorCell();
    Size minSize = new LayoutEngine().getPreferredSize(editorCell);
    return MultiTuple.<Double,Double>from(minSize.getWidth() + 0.0, minSize.getHeight() + 0.0);
  }

  public void setMaxWidthAttribute(int width) {
    jetbrains.mps.openapi.editor.cells.EditorCell editorCell = getEditorCell();
    for (jetbrains.mps.openapi.editor.cells.EditorCell descendantCell : Sequence.fromIterable(CellTraversalUtil.iterateTree(editorCell, editorCell, true))) {
      if (descendantCell instanceof EditorCell_Collection) {
        jetbrains.mps.nodeEditor.cells.EditorCell_Collection descendantAsCollection = ((jetbrains.mps.nodeEditor.cells.EditorCell_Collection) descendantCell);
        Style style = descendantCell.getStyle();
        Integer maxWidth = style.get(StyleAttributes.MAX_WIDTH);
        boolean condition = maxWidth == null || (editorCell.getUserObject(OVERRIDDEN_MAX_WIDTH_KEY) != null && descendantAsCollection.getCellLayout() instanceof IndentLayout);
        if (condition) {
          style.set(StyleAttributes.MAX_WIDTH, width);
          descendantCell.putUserObject(OVERRIDDEN_MAX_WIDTH_KEY, true);
        }
      }
    }
  }

  public IMPSCellContainer getContainer() {
    return myContainer;
  }
}
