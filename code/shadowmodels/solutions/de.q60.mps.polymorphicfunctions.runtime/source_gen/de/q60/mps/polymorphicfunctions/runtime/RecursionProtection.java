package de.q60.mps.polymorphicfunctions.runtime;

/*Generated by MPS */

import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.LinkedHashSet;
import jetbrains.mps.internal.collections.runtime.Sequence;

public class RecursionProtection {


  private ThreadLocal<Set<Evaluation>> myActiveEvaluations = new ThreadLocal<Set<Evaluation>>() {
    @Override
    protected Set<Evaluation> initialValue() {
      return SetSequence.fromSet(new LinkedHashSet<Evaluation>());
    }
  };

  public RecursionProtection() {
  }

  public Object evaluate(IFunctionImplementation impl, ParameterList parameters, IPFContext context) {
    Evaluation evaluation = new Evaluation(impl, parameters);
    SetSequence.fromSet(myActiveEvaluations.get()).addElement(evaluation);
    try {
      return impl.execute(context, parameters);
    } finally {
      SetSequence.fromSet(myActiveEvaluations.get()).removeElement(evaluation);
    }
  }

  public Iterable<IFunctionImplementation> filter(Iterable<IFunctionImplementation> implementations, final ParameterList parameters) {
    return Sequence.fromIterable(implementations).where((it) -> !(SetSequence.fromSet(myActiveEvaluations.get()).contains(new Evaluation(it, parameters)))).toList();
  }

  public class Evaluation {
    private IFunctionImplementation impl;
    private ParameterList parameters;

    public Evaluation(IFunctionImplementation impl1, ParameterList parameters1) {
      impl = impl1;
      parameters = parameters1;
    }


    @Override
    public boolean equals(Object o) {
      if (this == o) {
        return true;
      }
      if (o == null || this.getClass() != o.getClass()) {
        return false;
      }

      Evaluation that = (Evaluation) o;
      if ((impl != null ? !(impl.equals(that.impl)) : that.impl != null)) {
        return false;
      }
      if ((parameters != null ? !(parameters.equals(that.parameters)) : that.parameters != null)) {
        return false;
      }

      return true;
    }

    @Override
    public int hashCode() {
      int result = 0;
      result = 31 * result + ((impl != null ? ((Object) impl).hashCode() : 0));
      result = 31 * result + ((parameters != null ? ((Object) parameters).hashCode() : 0));
      return result;
    }
  }
}
