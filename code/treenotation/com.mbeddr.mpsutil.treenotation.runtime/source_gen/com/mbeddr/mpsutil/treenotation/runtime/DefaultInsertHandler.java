package com.mbeddr.mpsutil.treenotation.runtime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.action.NodeFactoryManager;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import javax.swing.Icon;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.ide.icons.GlobalIconManager;

public class DefaultInsertHandler extends AbstractInsertHandler {
  private final SAbstractConcept koncept;
  private final SContainmentLink targetLink;
  private EditorContext editorContext;

  public DefaultInsertHandler(EditorContext editorContext, SAbstractConcept koncept, SContainmentLink targetLink) {
    this.koncept = koncept;
    this.targetLink = targetLink;
    this.editorContext = editorContext;
  }

  protected SAbstractConcept getConcept() {
    return this.koncept;
  }

  @Override
  public void insert(EditorContext editorContext, SNode node, int index) {
    SNode newChild = NodeFactoryManager.createNode(koncept, null, node, editorContext.getModel());
    if (index >= ListSequence.fromList(SNodeOperations.getChildren(node, targetLink)).count()) {
      SNodeOperations.getChildren(node, targetLink).add(newChild);
    } else {
      SNodeOperations.getChildren(node, targetLink).add(index, newChild);
    }
  }

  @Override
  public String getDescription() {
    String description = koncept.getConceptAlias();
    if ((description == null || description.length() == 0)) {
      description = koncept.getName();
    }
    return description;
  }

  @Override
  public Icon getIcon() {
    final Wrappers._T<Icon> icon = new Wrappers._T<Icon>(null);
    editorContext.getRepository().getModelAccess().runReadAction(() -> icon.value = GlobalIconManager.getInstance().getIconFor(koncept));
    return icon.value;
  }
}
