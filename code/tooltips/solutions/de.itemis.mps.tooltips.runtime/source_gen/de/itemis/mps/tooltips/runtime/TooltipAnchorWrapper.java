package de.itemis.mps.tooltips.runtime;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.nodeEditor.cellLayout.CellLayout_Horizontal;
import jetbrains.mps.nodeEditor.EditorComponent;
import java.awt.Point;
import java.awt.Graphics;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import java.awt.Graphics2D;
import java.awt.AlphaComposite;
import com.intellij.ui.JBColor;
import java.awt.BasicStroke;
import java.awt.Rectangle;
import java.awt.Component;
import org.jetbrains.annotations.Nullable;
import java.util.List;
import java.util.Collections;

public class TooltipAnchorWrapper extends EditorCell_Collection implements ITooltip, ITooltipProvider {

  private EditorCell myAnchorCell;
  private LazyTooltip myTooltipCell;
  private float myMarkOpacity = 0.0f;

  public TooltipAnchorWrapper(EditorContext context, SNode node, EditorCell anchorCell, LazyTooltip tooltip) {
    super(context, node, new CellLayout_Horizontal(), null);

    TooltipManager.getInstance((EditorComponent) context.getEditorComponent());

    myAnchorCell = anchorCell;
    myTooltipCell = tooltip;

    addEditorCell(anchorCell);
  }

  @Override
  public Point getCenter() {
    Point center = new Point();
    center.setLocation(myAnchorCell.getX() + myAnchorCell.getWidth() / 2, myAnchorCell.getY() + myAnchorCell.getHeight() / 2);
    return center;
  }

  @Override
  public void paintCell(Graphics graphics, ParentSettings settings) {
    super.paintCell(graphics, settings);
    if (myMarkOpacity != 0.0f) {
      paintMark(graphics);
    }
  }

  private void paintMark(Graphics graphics) {
    Graphics2D g2 = ((Graphics2D) graphics.create());

    g2.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER, myMarkOpacity));
    g2.setColor(JBColor.BLUE);
    g2.setStroke(new BasicStroke(2.0f));
    Rectangle rect = getRect(myAnchorCell);
    g2.drawRect(rect.x, rect.y, rect.width, rect.height);

    g2.dispose();
  }

  @Override
  public void setMarkOpacity(float opacity) {
    myMarkOpacity = opacity;
    Rectangle markRect = expand(getRect(myAnchorCell), 3);
    ((Component) getEditorComponent()).repaint(markRect.x, markRect.y, markRect.width, markRect.height);
  }

  @Nullable
  @Override
  public EditorCell getTooltipCell() {
    return myTooltipCell.getTooltipCell();
  }

  public EditorCell getAnchor() {
    return myAnchorCell;
  }

  @Override
  public ITooltip getTooltipAt(int x, int y) {
    if (getX() <= x && x <= getX() + getWidth() && getY() <= y && y <= getY() + getHeight()) {
      return this;
    } else {
      return null;
    }
  }

  public List<ITooltip> getTooltips() {
    return Collections.<ITooltip>singletonList(this);
  }

  public static Rectangle expand(Rectangle rect, int amount) {
    Rectangle expanded = new Rectangle(rect);
    expanded.x -= amount;
    expanded.y -= amount;
    expanded.width += amount * 2;
    expanded.height += amount * 2;
    return expanded;
  }

  private static Rectangle getRect(EditorCell cell) {
    Rectangle rect = new Rectangle();
    rect.x = cell.getX();
    rect.y = cell.getY();
    rect.width = cell.getWidth();
    rect.height = cell.getHeight();
    return rect;
  }

  @Override
  public void onRemove() {
    super.onRemove();
    myTooltipCell.dispose();
  }
}
