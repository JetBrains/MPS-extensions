package de.itemis.mps.editor.diagram.runtime.plugin;

/*Generated by MPS */

import jetbrains.mps.plugins.tool.GeneratedTool;
import javax.swing.Icon;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.wm.ToolWindowAnchor;
import com.intellij.idea.AppMode;
import jetbrains.mps.nodeEditor.UIEditorComponent;
import jetbrains.mps.ide.project.ProjectHelper;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;
import jetbrains.mps.ide.editor.MPSFileNodeEditor;
import jetbrains.mps.openapi.editor.Editor;
import de.itemis.mps.editor.diagram.runtime.jgraph.RootDiagramECell;
import jetbrains.mps.nodeEditor.cells.CellFinderUtil;
import org.jetbrains.mps.util.Condition;
import com.intellij.openapi.fileEditor.FileEditorManager;
import java.util.Objects;
import javax.swing.JComponent;

public class Diagram_Viewer_Tool extends GeneratedTool {
  private static final Icon ICON = null;
  private EditorComponent editorComponent;
  private EditorCell editorCell;
  private jetbrains.mps.nodeEditor.cells.EditorCell noContentCell;
  private Project ideaProject;
  public Diagram_Viewer_Tool(Project project) {
    super(project, "Diagram Viewer", null, ICON, ToolWindowAnchor.RIGHT, false);
  }
  public void init(Project project) {
    super.init(project);
    Diagram_Viewer_Tool.this.ideaProject = project;
    if (AppMode.isHeadless()) {
      return;
    }
    Diagram_Viewer_Tool.this.editorComponent = new UIEditorComponent(ProjectHelper.fromIdeaProject(project).getRepository(), null) {
      @Override
      public void setRootCell(@NotNull EditorCell rootCell) {
        // only show the editor for the diagram and not the full root node
        if (!(rootCell.isBig()) || getRootCell() == Diagram_Viewer_Tool.this.noContentCell) {
          if (rootCell instanceof EditorCell_Constant) {
            EditorCell_Constant constantCell = ((EditorCell_Constant) rootCell);
            if (constantCell.getText().equals("<no node>")) {
              return;
            }
          }
          super.setRootCell(rootCell);
        }
      }
      @Override
      public boolean isReadOnly() {
        return true;
      }
    };
    Diagram_Viewer_Tool.this.noContentCell = new EditorCell_Constant(Diagram_Viewer_Tool.this.editorComponent.getEditorContext(), null, "No active diagram");
    Diagram_Viewer_Tool.this.editorComponent.setRootCell(Diagram_Viewer_Tool.this.noContentCell);

  }
  public void dispose() {
    if (Diagram_Viewer_Tool.this.editorCell != null) {
      Diagram_Viewer_Tool.this.editorCell.getSNode().putUserObject("showInViewer", null);
      Diagram_Viewer_Tool.this.editorComponent.dispose();
    }
    super.dispose();
  }
  public void restore() {
    MPSFileNodeEditor mpsFileNodeEditor = Diagram_Viewer_Tool.this.getOpenedMPSEditor();
    if (mpsFileNodeEditor == null) {
      return;
    }

    Editor editor = mpsFileNodeEditor.getNodeEditor();
    jetbrains.mps.openapi.editor.EditorComponent editorComponent = editor.getCurrentEditorComponent();

    RootDiagramECell diagramCell = (RootDiagramECell) CellFinderUtil.findChildByCondition(editorComponent.getRootCell(), new Condition<EditorCell>() {
      @Override
      public boolean met(EditorCell cell) {
        return cell instanceof RootDiagramECell && cell.getSNode().getUserObject("showInViewer") != null;
      }
    }, true);

    if (diagramCell != null) {
      Diagram_Viewer_Tool.this.update(diagramCell, editorComponent, true);
    }
  }
  public EditorCell getDiagramCell() {
    return Diagram_Viewer_Tool.this.editorCell;
  }
  public MPSFileNodeEditor getOpenedMPSEditor() {
    FileEditorManager fileEditorManager = FileEditorManager.getInstance(Diagram_Viewer_Tool.this.ideaProject);
    return as_86jfv0_a0b0k(fileEditorManager.getSelectedEditor(), MPSFileNodeEditor.class);
  }
  public void update(@NotNull final RootDiagramECell diagramCell, jetbrains.mps.openapi.editor.EditorComponent editorComponent, boolean showInViewer) {
    if (showInViewer) {
      jetbrains.mps.openapi.editor.EditorComponent originalEditorComponent = diagramCell.getEditorComponent();
      diagramCell.getSNode().putUserObject("showInViewer", true);
      diagramCell.setShowInViewer(true);
      diagramCell.onRemove();
      originalEditorComponent.update();
      Diagram_Viewer_Tool.this.editorComponent.editNode(diagramCell.getSNode());
      RootDiagramECell newDiagramCell = (RootDiagramECell) CellFinderUtil.findChildByCondition(Diagram_Viewer_Tool.this.editorComponent.getRootCell(), new Condition<EditorCell>() {
        @Override
        public boolean met(EditorCell cell) {
          return Objects.equals(cell.getCellId(), diagramCell.getCellId());
        }
      }, true);
      if (newDiagramCell != null) {
        Diagram_Viewer_Tool.this.editorComponent.setRootCell(newDiagramCell);
      }
      Diagram_Viewer_Tool.this.editorCell = newDiagramCell;
      Diagram_Viewer_Tool.this.openTool(true);
      Diagram_Viewer_Tool.this.editorComponent.update();
    } else {
      Diagram_Viewer_Tool.this.editorCell = null;
      Diagram_Viewer_Tool.this.editorComponent.setRootCell(Diagram_Viewer_Tool.this.noContentCell);
      diagramCell.getSNode().putUserObject("showInViewer", null);
      editorComponent.update();
    }
  }
  public JComponent getComponent() {
    Diagram_Viewer_Tool.this.restore();
    return Diagram_Viewer_Tool.this.editorComponent;
  }
  private static <T> T as_86jfv0_a0b0k(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
