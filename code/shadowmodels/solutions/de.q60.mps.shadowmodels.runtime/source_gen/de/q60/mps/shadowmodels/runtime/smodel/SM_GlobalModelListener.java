package de.q60.mps.shadowmodels.runtime.smodel;

/*Generated by MPS */

import org.jetbrains.mps.openapi.module.SRepositoryListener;
import org.jetbrains.mps.openapi.module.SRepositoryListenerBase;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.module.SModuleListener;
import org.jetbrains.mps.openapi.module.SModuleListenerBase;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.Set;
import org.jetbrains.mps.openapi.module.SRepository;
import gnu.trove.set.hash.THashSet;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;

public abstract class SM_GlobalModelListener {

  protected SRepositoryListener repositoryListener = new SRepositoryListenerBase() {
    public void moduleAdded(@NotNull SModule m) {
      start(m);
    }
    public void beforeModuleRemoved(@NotNull SModule m) {
      stop(m);
    }
  };
  protected SModuleListener moduleListener = new SModuleListenerBase() {
    public void modelAdded(SModule module, SModel model) {
      start(model);
    }
    public void beforeModelRemoved(SModule module, SModel model) {
      stop(model);
    }
  };

  protected Set<SRepository> myRepositories = new THashSet<SRepository>();
  protected Set<SModule> myModules = new THashSet<SModule>();
  protected Set<SModel> myModels = new THashSet<SModel>();

  public SM_GlobalModelListener() {
  }

  public void start(final SRepository repo) {
    if (SetSequence.fromSet(myRepositories).contains(repo)) {
      return;
    }
    SetSequence.fromSet(myRepositories).addElement(repo);

    repo.addRepositoryListener(repositoryListener);
    repo.getModelAccess().runReadAction(() -> {
      for (SModule module : Sequence.fromIterable(repo.getModules())) {
        start(module);
      }
    });

    addListener(repo);
  }

  public void start(SModule module) {
    if (SetSequence.fromSet(myModules).contains(module)) {
      return;
    }
    SetSequence.fromSet(myModules).addElement(module);

    module.addModuleListener(moduleListener);
    for (SModel model : Sequence.fromIterable(module.getModels())) {
      start(model);
    }

    addListener(module);
  }

  public void start(SModel model) {
    if (SetSequence.fromSet(myModels).contains(model)) {
      return;
    }
    SetSequence.fromSet(myModels).addElement(model);

    addListener(model);
  }

  protected void addListener(SRepository repository) {
  }
  protected void addListener(SModule module) {
  }
  protected abstract void addListener(SModel model);

  public void stop() {
    for (final SRepository repo : ListSequence.fromListWithValues(new ArrayList<SRepository>(), myRepositories)) {
      repo.getModelAccess().runReadAction(() -> stop(repo));
    }
  }

  public void stop(SRepository repo) {
    if (!(SetSequence.fromSet(myRepositories).contains(repo))) {
      return;
    }
    SetSequence.fromSet(myRepositories).removeElement(repo);

    repo.removeRepositoryListener(repositoryListener);
    for (SModule module : Sequence.fromIterable(repo.getModules())) {
      stop(module);
    }

    removeListener(repo);
  }

  public void stop(SModule module) {
    if (!(SetSequence.fromSet(myModules).contains(module))) {
      return;
    }
    SetSequence.fromSet(myModules).removeElement(module);

    module.removeModuleListener(moduleListener);
    for (SModel model : Sequence.fromIterable(module.getModels())) {
      stop(model);
    }

    removeListener(module);
  }

  public void stop(SModel model) {
    if (!(SetSequence.fromSet(myModels).contains(model))) {
      return;
    }
    SetSequence.fromSet(myModels).removeElement(model);

    removeListener(model);
  }

  protected void removeListener(SRepository repository) {
  }
  protected void removeListener(SModule module) {
  }
  protected abstract void removeListener(SModel model);

}
