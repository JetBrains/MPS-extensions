package de.itemis.mps.editor.pagination.runtime.ui;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import de.itemis.mps.editor.pagination.runtime.pages.PagesUserObject;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import de.itemis.mps.editor.pagination.runtime.pages.Pages;

public class PaginationSearchResultManager {
  public static final String USER_OBJECT_CURRENT_RESULT_KEY = "pagination_current_result";
  public static final String USER_OBJECT_FOUND_NODES_KEY = "pagination_found_in_search";
  public static final String USER_OBJECT_LAST_SEARCH = "pagination_last_search";

  private static PaginationSearchResultManager INSTANCE = new PaginationSearchResultManager();

  private PaginationSearchResultManager() {
  }

  public static PaginationSearchResultManager getInstance() {
    return INSTANCE;
  }

  public void includeNodeInResults(SNode node, boolean flag) {
    if (flag) {
      node.putUserObject(USER_OBJECT_FOUND_NODES_KEY, flag);
    } else {
      node.putUserObject(USER_OBJECT_FOUND_NODES_KEY, null);
    }
  }

  public boolean isIncludedInResults(SNode n) {
    return n.getUserObject(USER_OBJECT_FOUND_NODES_KEY) != null;
  }

  public SNode getCurrentlySelectedNode(PagesUserObject userObj) {
    return ListSequence.fromList(userObj.getAllChildren()).findFirst((it) -> isCurrentlySelected(it));
  }

  public void goToNextResult(PagesUserObject userObject, boolean forward, EditorContext context) {
    SNode currentNode = PaginationSearchResultManager.getInstance().getCurrentlySelectedNode(userObject);

    if (forward) {
      while ((SNodeOperations.getNextSibling(currentNode) != null)) {
        currentNode = SNodeOperations.getNextSibling(currentNode);
        if (isIncludedInResults(currentNode)) {
          break;
        }
      }
    } else {
      while ((SNodeOperations.getPrevSibling(currentNode) != null)) {
        currentNode = SNodeOperations.getPrevSibling(currentNode);
        if (isIncludedInResults(currentNode)) {
          break;
        }
      }
    }

    if (currentNode != null) {
      PaginationSearchResultManager.getInstance().changeSelection(userObject, currentNode, context);
    }
  }

  public boolean isCurrentlySelected(SNode node) {
    return node.getUserObject(USER_OBJECT_CURRENT_RESULT_KEY) != null;
  }

  public void setCurrentlySelected(PagesUserObject userObj, SNode node, boolean flag) {
    check_yijd2v_a0a02(getCurrentlySelectedNode(userObj), USER_OBJECT_CURRENT_RESULT_KEY, this);

    if (flag) {
      node.putUserObject(USER_OBJECT_CURRENT_RESULT_KEY, true);
    } else {
      node.putUserObject(USER_OBJECT_CURRENT_RESULT_KEY, null);
    }
  }

  public void changeSelection(PagesUserObject userObj, SNode node, EditorContext context) {
    setCurrentlySelected(userObj, node, true);
    Pages pages = userObj.getPages();
    userObj.setPages(pages.getPagesWith(pages.findPageFor(node)));

    context.getEditorComponent().rebuildEditorContent();
    context.select(node);
  }

  public void setLastSearchText(PagesUserObject userObj, String text) {
    userObj.getNodeWithPagination().putUserObject(USER_OBJECT_LAST_SEARCH, text);
  }

  public String getLastSearchText(PagesUserObject userObj) {
    return as_yijd2v_a0a0ab(userObj.getNodeWithPagination().getUserObject(USER_OBJECT_LAST_SEARCH), String.class);
  }

  public void clearResults(PagesUserObject userObj, EditorContext context) {
    SNode currentlySelectedNode = getCurrentlySelectedNode(userObj);
    if ((currentlySelectedNode != null)) {
      setCurrentlySelected(userObj, currentlySelectedNode, false);
    }
    ListSequence.fromList(userObj.getAllChildren()).visitAll((it) -> includeNodeInResults(it, false));
    context.getSelectionManager().clearSelection();
    setLastSearchText(userObj, null);

    userObj.goTo(1);
    context.getEditorComponent().rebuildEditorContent();
  }
  private static void check_yijd2v_a0a02(SNode checkedDotOperand, String USER_OBJECT_CURRENT_RESULT_KEY, PaginationSearchResultManager checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      checkedDotOperand.putUserObject(USER_OBJECT_CURRENT_RESULT_KEY, null);
    }

  }
  private static <T> T as_yijd2v_a0a0ab(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
