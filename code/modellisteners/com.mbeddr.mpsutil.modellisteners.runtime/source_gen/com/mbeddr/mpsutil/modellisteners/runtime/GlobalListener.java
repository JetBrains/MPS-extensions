package com.mbeddr.mpsutil.modellisteners.runtime;

/*Generated by MPS */

import jetbrains.mps.smodel.event.SModelListener;
import jetbrains.mps.classloading.DeployListener;
import jetbrains.mps.logging.Logger;
import java.util.Map;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.util.containers.MultiMap;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import java.util.Collection;
import java.util.ArrayList;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.classloading.ClassLoaderManager;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.module.ReloadableModule;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import java.util.Objects;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.extapi.model.SModelDescriptorStub;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.smodel.event.SModelChildEvent;
import jetbrains.mps.smodel.FastNodeFinderManager;
import jetbrains.mps.smodel.event.SModelReferenceEvent;
import jetbrains.mps.smodel.event.SModelPropertyEvent;
import jetbrains.mps.smodel.event.SModelRenamedEvent;
import jetbrains.mps.smodel.event.SModelRootEvent;
import jetbrains.mps.smodel.event.SModelDevKitEvent;
import jetbrains.mps.smodel.event.SModelImportEvent;
import jetbrains.mps.smodel.event.SModelLanguageEvent;
import jetbrains.mps.smodel.loading.ModelLoadingState;
import org.jetbrains.mps.openapi.model.SReference;

public class GlobalListener extends GlobalModelListener implements SModelListener, DeployListener {
  private static final Logger LOG = Logger.getLogger(GlobalListener.class);
  private Map<SModule, IModelListenersDescriptor> myDescriptors = MapSequence.fromMap(new HashMap<SModule, IModelListenersDescriptor>());
  private MultiMap<SAbstractConcept, IModelListener> myListeners = new MultiMap<SAbstractConcept, IModelListener>() {
    @Override
    protected Collection<IModelListener> createCollection() {
      return new ArrayList<IModelListener>(1);
    }
  };
  private Set<IModelListener> myActiveListeners = SetSequence.fromSet(new HashSet<IModelListener>());

  public void install(SRepository repo) {
    start(repo);
    ClassLoaderManager.getInstance().addListener(this);

    for (SModule module : Sequence.fromIterable(repo.getModules())) {
      if (module instanceof ReloadableModule) {
        loadModule((ReloadableModule) module);
      }
    }
    updateListeners();
  }

  public void uninstall() {
    stop();
    ClassLoaderManager.getInstance().removeListener(this);
  }

  @Override
  public void onUnloaded(Set<ReloadableModule> modules, @NotNull ProgressMonitor progress) {
    for (ReloadableModule module : SetSequence.fromSet(modules)) {
      if (Objects.equals(module.getModuleReference(), PersistenceFacade.getInstance().createModuleReference("7197c640-b458-406b-8636-40c7936ef8c8(com.mbeddr.mpsutil.modellisteners.runtime)"))) {
        uninstall();
        MapSequence.fromMap(myDescriptors).clear();
        return;
      }
      MapSequence.fromMap(myDescriptors).removeKey(module);
    }
    updateListeners();
  }

  @Override
  public void onLoaded(Set<ReloadableModule> modules, @NotNull ProgressMonitor progress) {
    for (ReloadableModule module : SetSequence.fromSet(modules)) {
      loadModule(module);
    }
    updateListeners();
  }

  @Override
  protected void addListener(SModel model) {
    ((SModelDescriptorStub) model).addModelListener(this);
  }

  @Override
  protected void removeListener(SModel model) {
    ((SModelDescriptorStub) model).removeModelListener(this);
  }

  protected void loadModule(ReloadableModule module) {
    IModelListenersDescriptor descriptor = getDescriptor(module);
    if (descriptor != null) {
      MapSequence.fromMap(myDescriptors).put(module, descriptor);
    }
  }

  public void updateListeners() {
    myListeners.clear();
    for (IModelListenersDescriptor descriptor : Sequence.fromIterable(MapSequence.fromMap(myDescriptors).values())) {
      for (IModelListener listener : Sequence.fromIterable(descriptor.getListeners())) {
        myListeners.putValue(listener.getParentConcept(), listener);
      }
    }
  }

  protected IModelListenersDescriptor getDescriptor(ReloadableModule module) {
    String className = ListenersAspect.getName(module) + "." + IModelListenersDescriptor.CLASS_NAME;
    try {
      Class<? extends IModelListenersDescriptor> descriptorClass = (Class<? extends IModelListenersDescriptor>) module.getOwnClass(className);
      if (descriptorClass != null) {
        IModelListenersDescriptor descriptor = descriptorClass.newInstance();
        return descriptor;
      }
    } catch (Exception e) {
    }
    return null;
  }

  protected <ListenerType extends IModelListener> void forwardEvent(SAbstractConcept affectedConcept, Class<ListenerType> listenerType, IForwarder<ListenerType> forwarder) {
    if (affectedConcept == null) {
      return;
    }
    for (SAbstractConcept concept : ListSequence.fromList(SConceptOperations.getAllSuperConcepts(affectedConcept, true))) {
      for (IModelListener listener : CollectionSequence.fromCollection(myListeners.get(concept))) {
        if (listenerType.isInstance(listener)) {
          forwardSafe(forwarder, (ListenerType) listener);
        }
      }
    }
  }

  protected <ListenerType extends IModelListener> void forwardSafe(IForwarder<ListenerType> forwarder, ListenerType listener) {
    // prevent endless recursions caused by listeners producing events they listen on

    if (SetSequence.fromSet(myActiveListeners).contains(listener)) {
      return;
    }
    try {
      SetSequence.fromSet(myActiveListeners).addElement(listener);
      forwarder.forward((ListenerType) listener);
    } catch (Exception ex) {
      if (LOG.isErrorLevel()) {
        LOG.error(String.format("Error in model listener for concept %s", listener.getParentConcept().getQualifiedName()), ex);
      }
    } finally {
      SetSequence.fromSet(myActiveListeners).removeElement(listener);
    }
  }

  @Override
  public void beforeChildRemoved(final SModelChildEvent event) {
    forwardEvent(event.getParent().getConcept(), IChildListener.class, new IForwarder<IChildListener>() {
      public void forward(IChildListener listener) {
        if (roleMatches(listener, event)) {
          listener.beforeChildRemoved(event.getParent(), event.getChild());
        }
      }
    });
  }

  @Override
  public void childAdded(final SModelChildEvent event) {
    forwardEvent(event.getParent().getConcept(), IChildListener.class, new IForwarder<IChildListener>() {
      public void forward(IChildListener listener) {
        if (roleMatches(listener, event)) {
          listener.childAdded(event.getParent(), event.getChild());
        }
      }
    });
  }

  @Override
  public void childRemoved(final SModelChildEvent event) {
    forwardEvent(event.getParent().getConcept(), IChildListener.class, new IForwarder<IChildListener>() {
      public void forward(IChildListener listener) {
        if (roleMatches(listener, event)) {
          listener.childRemoved(event.getParent(), event.getChild());
        }
      }
    });
    FastNodeFinderManager.dispose(event.getModel());
  }

  protected boolean roleMatches(IChildListener listener, SModelChildEvent event) {
    return listener.getRole() == null || Objects.equals(listener.getRole().getRoleName(), event.getChildRole());
  }
  protected boolean roleMatches(IReferenceListener listener, SModelReferenceEvent event) {
    return listener.getRole() == null || Objects.equals(listener.getRole(), event.getReference().getLink());
  }
  protected boolean roleMatches(IPropertyListener listener, SModelPropertyEvent event) {
    return listener.getProperty() == null || Objects.equals(listener.getProperty().getName(), event.getPropertyName());
  }

  @Override
  public void beforeModelDisposed(SModel model) {
  }
  @Override
  public void beforeModelRenamed(SModelRenamedEvent event) {
  }
  @Override
  public void beforeRootRemoved(final SModelRootEvent event) {
    forwardEvent(event.getRoot().getConcept(), IRootBeforeRemovedListener.class, new IForwarder<IRootBeforeRemovedListener>() {
      public void forward(IRootBeforeRemovedListener listener) {
        listener.beforeRootRemoved(event.getRoot(), event.getModel());
      }
    });
  }
  @Override
  public void devkitAdded(SModelDevKitEvent event) {
  }
  @Override
  public void devkitRemoved(SModelDevKitEvent event) {
  }
  @NotNull
  @Override
  public SModelListener.SModelListenerPriority getPriority() {
    return SModelListener.SModelListenerPriority.CLIENT;
  }
  @Override
  public void importAdded(SModelImportEvent event) {
  }
  @Override
  public void importRemoved(SModelImportEvent event) {
  }
  @Override
  public void languageAdded(SModelLanguageEvent event) {
  }
  @Override
  public void languageRemoved(SModelLanguageEvent event) {
  }
  @Override
  public void modelLoadingStateChanged(SModel model, ModelLoadingState state) {
  }
  @Override
  public void modelRenamed(SModelRenamedEvent event) {
  }
  @Override
  public void modelSaved(SModel model) {
  }
  @Override
  public void propertyChanged(final SModelPropertyEvent event) {
    forwardEvent(event.getNode().getConcept(), IPropertyListener.class, new IForwarder<IPropertyListener>() {
      public void forward(IPropertyListener listener) {
        if (roleMatches(listener, event)) {
          listener.propertyChanged(event.getNode(), event.getPropertyName(), event.getOldPropertyValue(), event.getNewPropertyValue());
        }
      }
    });
  }
  @Override
  public void referenceAdded(final SModelReferenceEvent event) {
    final SReference reference = event.getReference();
    forwardEvent(reference.getSourceNode().getConcept(), IReferenceAddedListener.class, new IForwarder<IReferenceAddedListener>() {
      public void forward(IReferenceAddedListener listener) {
        if (roleMatches(listener, event)) {
          listener.referenceAdded(reference.getSourceNode(), reference.getTargetNode(), reference.getLink());
        }
      }
    });
  }
  @Override
  public void referenceRemoved(final SModelReferenceEvent event) {
    final SReference reference = event.getReference();
    forwardEvent(reference.getSourceNode().getConcept(), IReferenceRemovedListener.class, new IForwarder<IReferenceRemovedListener>() {
      public void forward(IReferenceRemovedListener listener) {
        if (roleMatches(listener, event)) {
          listener.referenceRemoved(reference.getSourceNode(), reference.getTargetNode(), reference.getLink());
        }
      }
    });
  }
  @Deprecated
  @Override
  public void rootAdded(final SModelRootEvent event) {
    forwardEvent(event.getRoot().getConcept(), IRootAddedListener.class, new IForwarder<IRootAddedListener>() {
      public void forward(IRootAddedListener listener) {
        listener.rootAdded(event.getRoot(), event.getModel());
      }
    });
  }
  @Deprecated
  @Override
  public void rootRemoved(final SModelRootEvent event) {
    forwardEvent(event.getRoot().getConcept(), IRootRemovedListener.class, new IForwarder<IRootRemovedListener>() {
      public void forward(IRootRemovedListener listener) {
        listener.rootRemoved(event.getRoot(), event.getModel());
      }
    });
  }

}
