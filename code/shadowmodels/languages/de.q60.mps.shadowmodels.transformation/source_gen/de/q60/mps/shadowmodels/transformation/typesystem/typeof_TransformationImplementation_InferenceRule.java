package de.q60.mps.shadowmodels.transformation.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractInferenceRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.InferenceRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.typesystem.inference.EquationInfo;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.Iterator;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.typechecking.TypecheckingFacade;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import java.util.List;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;

public class typeof_TransformationImplementation_InferenceRule extends AbstractInferenceRule_Runtime implements InferenceRule_Runtime {
  public typeof_TransformationImplementation_InferenceRule() {
  }
  public void applyRule(final SNode n, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    if (ListSequence.fromList(SLinkOperations.getChildren(n, LINKS.output$lKKp)).count() == 1) {
      {
        SNode _nodeToCheck_1029348928467 = n;
        EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251286724587", 0, null);
        typeCheckingContext.createEquation((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251286723932", true), (SNode) typeCheckingContext.typeOf(ListSequence.fromList(SLinkOperations.getChildren(n, LINKS.output$lKKp)).first(), "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251286724603", true), _info_12389875345);
      }
    } else {
      {
        SNode _nodeToCheck_1029348928467 = n;
        EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251286754118", 0, null);
        typeCheckingContext.createEquation((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251286753361", true), (SNode) _quotation_createNode_jjprpb_a1a0c0a0a0a1(ListSequence.fromList(SLinkOperations.getChildren(n, LINKS.output$lKKp)).select(new _FunctionTypes._return_P1_E0<SNode, SNode>() {
          public SNode invoke(SNode it) {
            final SNode itType_typevar_5973274251290707955 = typeCheckingContext.createNewRuntimeTypesVariable();
            {
              SNode _nodeToCheck_1029348928467 = it;
              EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251290712638", 0, null);
              typeCheckingContext.createEquation((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251290710829", true), (SNode) typeCheckingContext.getRepresentative(itType_typevar_5973274251290707955), _info_12389875345);
            }
            return typeCheckingContext.getRepresentative(itType_typevar_5973274251290707955);
          }
        }).toList()), _info_12389875345);
      }
    }

    if ((SLinkOperations.getTarget(n, LINKS.base$tIn4) != null)) {
      {
        Iterator<SNode> intfParam_it = ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(n, LINKS.base$tIn4), LINKS.input$hSH9)).iterator();
        Iterator<SNode> implParam_it = ListSequence.fromList(SLinkOperations.getChildren(n, LINKS.input$hSH9)).iterator();
        SNode intfParam_var;
        SNode implParam_var;
        while (intfParam_it.hasNext() && implParam_it.hasNext()) {
          intfParam_var = intfParam_it.next();
          implParam_var = implParam_it.next();
          if (!(typeCheckingContext.isSingleTypeComputation())) {
            {
              SNode _nodeToCheck_1029348928467 = implParam_var;
              EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "4225291329827839006", 0, null);
              typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "4225291329827838320", true), (SNode) typeCheckingContext.typeOf(intfParam_var, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "4225291329827839046", true), true, true, _info_12389875345);
            }
          }
        }
      }
      {
        Iterator<SNode> intfParam__it = ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(n, LINKS.base$tIn4), LINKS.output$lKKp)).iterator();
        Iterator<SNode> implParam__it = ListSequence.fromList(SLinkOperations.getChildren(n, LINKS.output$lKKp)).iterator();
        SNode intfParam__var;
        SNode implParam__var;
        while (intfParam__it.hasNext() && implParam__it.hasNext()) {
          intfParam__var = intfParam__it.next();
          implParam__var = implParam__it.next();
          final SNode implParam = implParam__var;
          final SNode intfParam = intfParam__var;
          {
            final SNode implType = typeCheckingContext.typeOf(implParam, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251290521690", true);
            typeCheckingContext.whenConcrete(implType, () -> {
              {
                final SNode intfType = typeCheckingContext.typeOf(intfParam, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251290521762", true);
                typeCheckingContext.whenConcrete(intfType, () -> {
                  // It's not always possible to know the output concept statically. Disable the typecheck in this case.
                  boolean implConceptUnknown = SNodeOperations.isInstanceOf(typeCheckingContext.getExpandedNode(implType), CONCEPTS.SNodeType$hR) && (SLinkOperations.getTarget(SNodeOperations.cast(typeCheckingContext.getExpandedNode(implType), CONCEPTS.SNodeType$hR), LINKS.concept$OMgE) == null);
                  if (!(implConceptUnknown)) {
                    SNode implSequence = TypecheckingFacade.getFromContext().coerceType(typeCheckingContext.getExpandedNode(implType), CONCEPTS.SequenceType$_s);
                    SNode intfSequence = TypecheckingFacade.getFromContext().coerceType(typeCheckingContext.getExpandedNode(intfType), CONCEPTS.SequenceType$_s);
                    if ((intfSequence != null) && (implSequence == null)) {
                      // A single element is also valid when then interface allows multiple
                      if (!(typeCheckingContext.isSingleTypeComputation())) {
                        {
                          SNode _nodeToCheck_1029348928467 = n;
                          EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251290569315", 0, null);
                          typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.getExpandedNode(implType), (SNode) SLinkOperations.getTarget(intfSequence, LINKS.elementType$KpjL), true, true, _info_12389875345);
                        }
                      }
                    } else if ((implSequence != null) && (intfSequence == null)) {
                      if (!(typeCheckingContext.isSingleTypeComputation())) {
                        {
                          SNode _nodeToCheck_1029348928467 = n;
                          EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "7535673100886295655", 0, null);
                          typeCheckingContext.createLessThanInequality((SNode) SLinkOperations.getTarget(implSequence, LINKS.elementType$KpjL), (SNode) typeCheckingContext.getExpandedNode(intfType), true, true, _info_12389875345);
                        }
                      }
                    } else {
                      if (!(typeCheckingContext.isSingleTypeComputation())) {
                        {
                          SNode _nodeToCheck_1029348928467 = n;
                          EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "4225291329827839117", 0, null);
                          typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.getExpandedNode(implType), (SNode) typeCheckingContext.getExpandedNode(intfType), true, true, _info_12389875345);
                        }
                      }
                    }
                  }
                }, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251290521760", false, false);
              }
            }, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5973274251290521629", false, false);
          }
        }
      }
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.Transformation$Gz;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }
  private static SNode _quotation_createNode_jjprpb_a1a0c0a0a0a1(Object parameter_1) {
    SNode quotedNode_2 = null;
    SNode quotedNode_3 = null;
    SNodeBuilder nb = new SNodeBuilder(null, null).init(MetaAdapterFactory.getConcept(MetaAdapterFactory.getLanguage(0xa247e09e243545baL, 0xb8d207e93feba96aL, "jetbrains.mps.baseLanguage.tuples"), 0x1207157a8dcL, "IndexedTupleType"));
    quotedNode_2 = nb.getResult();
    for (SNode child : (List<SNode>) parameter_1) {
      quotedNode_2.addChild(MetaAdapterFactory.getContainmentLink(0xa247e09e243545baL, 0xb8d207e93feba96aL, 0x1207157a8dcL, 0x1207158795cL, "componentType"), SNodeOperations.copyIfNecessary(child));
    }
    return quotedNode_2;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink output$lKKp = MetaAdapterFactory.getContainmentLink(0x94b64715a2634c36L, 0xa1388da14705ffa7L, 0x65cd987c65c46e26L, 0x65cd987c65c5f60cL, "output");
    /*package*/ static final SReferenceLink base$tIn4 = MetaAdapterFactory.getReferenceLink(0x94b64715a2634c36L, 0xa1388da14705ffa7L, 0x65cd987c65c46e26L, 0x56056ad9288ed681L, "base");
    /*package*/ static final SContainmentLink input$hSH9 = MetaAdapterFactory.getContainmentLink(0x94b64715a2634c36L, 0xa1388da14705ffa7L, 0x65cd987c65c46e26L, 0x65cd987c65c4b8b3L, "input");
    /*package*/ static final SReferenceLink concept$OMgE = MetaAdapterFactory.getReferenceLink(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x108f968b3caL, 0x1090e46ca51L, "concept");
    /*package*/ static final SContainmentLink elementType$KpjL = MetaAdapterFactory.getContainmentLink(0x8388864671ce4f1cL, 0x9c53c54016f6ad4fL, 0x10c260e9444L, 0x10c260ee40eL, "elementType");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept SNodeType$hR = MetaAdapterFactory.getConcept(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x108f968b3caL, "jetbrains.mps.lang.smodel.structure.SNodeType");
    /*package*/ static final SConcept SequenceType$_s = MetaAdapterFactory.getConcept(0x8388864671ce4f1cL, 0x9c53c54016f6ad4fL, 0x10c260e9444L, "jetbrains.mps.baseLanguage.collections.structure.SequenceType");
    /*package*/ static final SConcept Transformation$Gz = MetaAdapterFactory.getConcept(0x94b64715a2634c36L, 0xa1388da14705ffa7L, 0x65cd987c65c46e26L, "de.q60.mps.shadowmodels.transformation.structure.Transformation");
  }
}
