package com.dslfoundry.langvis.plugin.plugin;

/*Generated by MPS */

import javax.swing.JLabel;
import java.awt.Image;
import com.intellij.util.concurrency.AppExecutorUtil;
import javax.imageio.ImageIO;
import java.io.File;
import java.io.IOException;
import jetbrains.mps.baseLanguage.logging.rt.LogContext;
import com.intellij.openapi.application.ApplicationManager;
import javax.swing.ImageIcon;

public class ImageViewer extends JLabel {
  private Image unscaledImage;
  private double currentZoom = 1;
  private final int maxSize = 10000;
  private final int minSize = 50;
  private final double highZoom = 1000;

  public ImageViewer() {
    super("", JLabel.CENTER);
  }

  public double getZoom(double width, double height, double maxwidth, double maxheight, double desiredZoom) {
    double clampedHorizontalScale = Math.min(width * desiredZoom, maxwidth) / width;
    double clampedVerticalScale = Math.min(height * desiredZoom, maxheight) / height;
    double maxScale = Math.min(clampedHorizontalScale, clampedVerticalScale);
    return maxScale;
  }

  public void reloadImage(String path) {
    AppExecutorUtil.getAppExecutorService().execute(() -> {
      // Load image from disk
      try {
        this.unscaledImage = ImageIO.read(new File(path));
      } catch (IOException ex) {
        LogContext.with(ImageViewer.class, ex, null, null).error(String.format("Could not read '%s'", path));
        return;
      }
      // Redraw image with current settings
      ApplicationManager.getApplication().invokeAndWait(() -> refreshView());
    });
  }

  public void refreshView() {
    refreshView(currentZoom);
  }

  public void refreshView(double desiredZoom) {
    int width = unscaledImage.getWidth(null);
    int height = unscaledImage.getHeight(null);
    currentZoom = getZoom(width, height, maxSize, maxSize, desiredZoom);
    int newwidth = (int) (width * desiredZoom);
    int newheight = (int) (height * desiredZoom);
    if (newwidth < minSize) {
      newwidth = minSize;
    }
    if (newheight < minSize) {
      newheight = minSize;
    }

    Image scaledImage;
    scaledImage = unscaledImage.getScaledInstance(newwidth, newheight, Image.SCALE_SMOOTH);

    setIcon(new ImageIcon(scaledImage));
    revalidate();
    repaint();
  }

  public double zoomMax(int clientWidth, int clientHeight) {
    int width = unscaledImage.getWidth(null);
    int height = unscaledImage.getHeight(null);
    double maxZoom = getZoom(width, height, clientWidth, clientHeight, this.highZoom);
    refreshView(maxZoom);
    return maxZoom;
  }
}
