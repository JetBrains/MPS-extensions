package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import de.itemis.mps.editor.collapsible.runtime.CollapsibleCell;
import de.itemis.mps.editor.diagram.runtime.model.IScalingInfo;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import org.jetbrains.annotations.Nullable;
import de.itemis.mps.editor.diagram.runtime.EditorUtil;
import java.awt.geom.Rectangle2D;
import de.itemis.mps.editor.diagram.runtime.model.Box;
import de.itemis.mps.editor.diagram.runtime.model.Bounds;
import de.itemis.mps.editor.diagram.runtime.model.ScalingInfoUtil;

public class DiagramCollapsibleCell extends CollapsibleCell implements IScalingInfo {
  public DiagramCollapsibleCell(EditorContext context, SNode node, @NotNull EditorCell expandedCell, @Nullable EditorCell collapsedCell, boolean showCollapsedAlways, boolean collapsedByDefault, boolean drawBracketLine) {
    super(context, node, expandedCell, collapsedCell, showCollapsedAlways, collapsedByDefault, drawBracketLine);
  }

  @Override
  public void setCollapsibleCollapsed(boolean newValue) {

    RootDiagramECell diagramECell = EditorUtil.getAncestor(this, RootDiagramECell.class);
    if (diagramECell == null) {
      super.setCollapsibleCollapsed(newValue);
      return;
    }

    MyGraph graph = diagramECell.getGraph();
    MPSCell mpsCell = graph.getMPSCellRegistry().findAncestor(this);
    Rectangle2D prevCellBounds = mpsCell.getBounds();

    super.setCollapsibleCollapsed(newValue);
    mpsCell.relayout();
    diagramECell.getSynchronizer().model2Graph();
    mpsCell.relayout();

    Rectangle2D newCellBounds = mpsCell.getBounds();
    BoxDCell boxDCell = as_d8clv0_a0a41a2(mpsCell.getContainer(), BoxDCell.class);
    Box box = check_d8clv0_a0p0c(boxDCell);
    if (box != null) {
      Bounds boxBounds = box.getBounds();
      boxBounds.setWidth(boxBounds.getWidth() + newCellBounds.getWidth() - prevCellBounds.getWidth());
      boxBounds.setHeight(boxBounds.getHeight() + newCellBounds.getHeight() - prevCellBounds.getHeight());
      box.setBounds(boxBounds);
      PortLayouter.layoutPortCells(boxDCell);
    }
    diagramECell.getSynchronizer().model2Graph();

  }

  public boolean allowScaling() {
    return ScalingInfoUtil.allowScaling(myCollapsedCell) && ScalingInfoUtil.allowScaling(myExpandedCell);
  }
  private static Box check_d8clv0_a0p0c(BoxDCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getBox();
    }
    return null;
  }
  private static <T> T as_d8clv0_a0a41a2(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
