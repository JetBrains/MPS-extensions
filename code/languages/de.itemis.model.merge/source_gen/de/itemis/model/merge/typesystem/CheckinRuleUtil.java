package de.itemis.model.merge.typesystem;

/*Generated by MPS */

import java.util.Set;
import org.jetbrains.mps.openapi.model.SNode;
import de.itemis.model.merge.runtime.runtime.PolicyMergerResolver;
import de.itemis.model.merge.runtime.runtime.MissingMergingPolicies;
import com.google.common.collect.Sets;
import java.util.Collections;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.module.SRepository;
import java.util.Map;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.structure.behavior.AbstractConceptDeclaration__BehaviorDescriptor;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class CheckinRuleUtil {


  public static Set<SNode> conceptsWithMissingMergePolicy(SNode modelMerge) {
    try {
      PolicyMergerResolver.run(modelMerge);
    } catch (MissingMergingPolicies mp) {
      return Sets.newHashSet(mp.missingPoliciesFor());
    }
    return Collections.<SNode>emptySet();
  }


  public static <X> void warn(Iterable<SAbstractConcept> concepts, SRepository repo, Map<SAbstractConcept, Set<X>> conceptToX, final _FunctionTypes._return_P1_E0<? extends Set<X>, ? super SNode> needToCoverXs, final _FunctionTypes._void_P2_E0<? super SAbstractConcept, ? super X> warning) {
    for (final SAbstractConcept c : Sequence.fromIterable(concepts)) {
      SNode declarationNode = ((SNode) (c.getSourceNode().resolve(repo)));

      if (SNodeOperations.isInstanceOf(declarationNode, CONCEPTS.InterfaceConceptDeclaration$CG)) {
        continue;
      }

      Set<X> existentX = (conceptToX.getOrDefault(c, Collections.<X>emptySet()));

      Iterable<SNode> allSuperConcepts = Sequence.fromIterable(AbstractConceptDeclaration__BehaviorDescriptor.getAllSuperConcepts_id2A8AB0rAWpG.invoke(declarationNode, ((boolean) true))).where((it) -> !((boolean) AbstractConceptDeclaration__BehaviorDescriptor.is_id4MKjpUYmGW0.invoke(it, CONCEPTS.BaseConcept$gP)));
      HashSet<X> allX = Sets.newHashSet(Sequence.fromIterable(allSuperConcepts).translate((it) -> needToCoverXs.invoke(it)));
      Set<X> xsWithoutMergePolicies = Sets.difference(allX, existentX);
      SetSequence.fromSet(xsWithoutMergePolicies).visitAll((it) -> warning.invoke(c, it));
    }
  }

  public static SNode warningNode(SNode modelMerge, final SAbstractConcept sac) {
    SNode warningNode = Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(modelMerge, LINKS.policies$z8dk), CONCEPTS.ConceptMergingPolicy$RB)).findFirst((it) -> (boolean) AbstractConceptDeclaration__BehaviorDescriptor.is_id4MKjpUYmGW0.invoke(SLinkOperations.getTarget(it, LINKS.conceptRef$p8vY), sac));
    return ((warningNode == null) ? modelMerge : warningNode);
  }

  public static SNode defaultIdFunction() {
    return createIdFunction_o6zztx_a0a9(createStatementList_o6zztx_a0a0a0a9(Sequence.<SNode>singleton(createReturnStatement_o6zztx_a0a0a0a0a0a0a9(createStringLiteral_o6zztx_a0a0a0a0a0a0a0a0a9()))));
  }
  private static SNode createIdFunction_o6zztx_a0a9(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.IdFunction$2_);
    n0.forChild(LINKS.body$e68K).initNode(p0, CONCEPTS.StatementList$m_, true);
    return n0.getResult();
  }
  private static SNode createStatementList_o6zztx_a0a0a0a9(Iterable<? extends SNode> p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.StatementList$m_);
    n0.forChild(LINKS.statement$53DE).initNodeList(p0, CONCEPTS.Statement$P6);
    return n0.getResult();
  }
  private static SNode createReturnStatement_o6zztx_a0a0a0a0a0a0a9(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ReturnStatement$lt);
    n0.forChild(LINKS.expression$eJ92).initNode(p0, CONCEPTS.Expression$mB, true);
    return n0.getResult();
  }
  private static SNode createStringLiteral_o6zztx_a0a0a0a0a0a0a0a0a9() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.StringLiteral$xu);
    n0.setProperty(PROPS.value$w7MM, "");
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept InterfaceConceptDeclaration$CG = MetaAdapterFactory.getConcept(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0x1103556dcafL, "jetbrains.mps.lang.structure.structure.InterfaceConceptDeclaration");
    /*package*/ static final SConcept BaseConcept$gP = MetaAdapterFactory.getConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, "jetbrains.mps.lang.core.structure.BaseConcept");
    /*package*/ static final SConcept ConceptMergingPolicy$RB = MetaAdapterFactory.getConcept(0x539e893908ef497cL, 0xa5fd25dd10137a55L, 0x1a8b8d3e42de4bf5L, "de.itemis.model.merge.structure.ConceptMergingPolicy");
    /*package*/ static final SConcept IdFunction$2_ = MetaAdapterFactory.getConcept(0x539e893908ef497cL, 0xa5fd25dd10137a55L, 0x630e54bf61025dc7L, "de.itemis.model.merge.structure.IdFunction");
    /*package*/ static final SConcept StatementList$m_ = MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8cc56b200L, "jetbrains.mps.baseLanguage.structure.StatementList");
    /*package*/ static final SConcept Statement$P6 = MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8cc56b215L, "jetbrains.mps.baseLanguage.structure.Statement");
    /*package*/ static final SConcept ReturnStatement$lt = MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8cc67c7feL, "jetbrains.mps.baseLanguage.structure.ReturnStatement");
    /*package*/ static final SConcept Expression$mB = MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8c37f506fL, "jetbrains.mps.baseLanguage.structure.Expression");
    /*package*/ static final SConcept StringLiteral$xu = MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf93d565d10L, "jetbrains.mps.baseLanguage.structure.StringLiteral");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink policies$z8dk = MetaAdapterFactory.getContainmentLink(0x539e893908ef497cL, 0xa5fd25dd10137a55L, 0x1a8b8d3e42dcce87L, 0x1a8b8d3e42de4bf6L, "policies");
    /*package*/ static final SReferenceLink conceptRef$p8vY = MetaAdapterFactory.getReferenceLink(0x539e893908ef497cL, 0xa5fd25dd10137a55L, 0x1a8b8d3e42de4bf5L, 0x39f51297bd7a5aedL, "conceptRef");
    /*package*/ static final SContainmentLink body$e68K = MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x108bbca0f48L, 0x108bbd29b4aL, "body");
    /*package*/ static final SContainmentLink statement$53DE = MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8cc56b200L, 0xf8cc6bf961L, "statement");
    /*package*/ static final SContainmentLink expression$eJ92 = MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8cc67c7feL, 0xf8cc6bf96cL, "expression");
  }

  private static final class PROPS {
    /*package*/ static final SProperty value$w7MM = MetaAdapterFactory.getProperty(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf93d565d10L, 0xf93d565d11L, "value");
  }
}
