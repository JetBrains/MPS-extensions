package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import de.itemis.mps.editor.diagram.runtime.model.SerializableObjectHolder;
import de.itemis.mps.editor.diagram.runtime.model.EdgeLabel;
import java.util.List;
import com.mxgraph.model.mxGeometry;
import com.mxgraph.view.mxGraphView;
import com.mxgraph.view.mxCellState;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import org.jetbrains.annotations.Nullable;
import java.util.Collections;
import java.awt.Graphics2D;
import com.mxgraph.canvas.mxGraphics2DCanvas;
import de.itemis.mps.editor.diagram.runtime.model.RelativePosition;
import org.apache.commons.math3.geometry.euclidean.twod.Vector2D;
import com.mxgraph.model.mxICell;
import de.itemis.mps.editor.diagram.runtime.model.Bounds;
import java.awt.BasicStroke;
import com.intellij.ui.ColorUtil;
import com.intellij.ui.JBColor;
import java.awt.geom.Line2D;
import java.awt.geom.Point2D;
import de.itemis.mps.editor.diagram.runtime.model.Edge;
import java.util.ArrayList;
import de.itemis.mps.editor.diagram.runtime.model.IDiagramElement;

public class LabelDCell extends BaseDCell implements ISelfPaintingCell, IMPSCellContainer, IDiagramDCell {

  private SerializableObjectHolder<EdgeLabel> myLabel;
  private List<MPSCell> myMPSCells;


  public LabelDCell(MyGraph graph) {
    super(graph);
  }

  @Override
  public mxGeometry getGeometry() {
    return super.getGeometry();
  }

  @Override
  public void setGeometry(mxGeometry geometry) {
    super.setGeometry(geometry);
  }

  @Override
  public void updateMPSCellPositions(mxGraphView view, mxCellState state) {
    for (MPSCell mpsCell : ListSequence.fromList(myMPSCells)) {
      double scale = view.getScale();
      double x = state.getX();
      double y = state.getY();

      mpsCell.setStateRelativePos(x - state.getX(), y - state.getY());
    }

    EditorCell rootCell = check_2mjdfd_a0c0l(check_2mjdfd_a0a2a11(myLabel));
    if (rootCell instanceof EditorCell_Collection) {
    }
  }

  public void setLabel(@Nullable EdgeLabel label) {
    myLabel = new SerializableObjectHolder<EdgeLabel>(label);
    EditorCell cell = check_2mjdfd_a0b0n(label);
    myMPSCells = (cell != null ? Collections.singletonList(myGraph.get().getMPSCellRegistry().getInstance(cell, this)) : Collections.<MPSCell>emptyList());
  }

  @Override
  public void paintBackground(Graphics2D g, mxGraphics2DCanvas canvas, mxCellState state) {

    // draw shape
    DrawUtil.drawShape(canvas, state);
  }

  @Override
  public void paintForeground(Graphics2D g, mxGraphics2DCanvas canvas, mxCellState state) {

    for (MPSCell mpsCell : ListSequence.fromList(myMPSCells)) {
      // Compartments
      DrawUtil.drawCompartments(g, mpsCell, state);

      // MPS cell
      mpsCell.paint(g, state);
    }
  }

  @Override
  public void paintTop(Graphics2D g, mxGraphics2DCanvas canvas, mxCellState state) {
    if (!(check_2mjdfd_a0a0t(check_2mjdfd_a0a0a91(myLabel.get())))) {
      return;
    }
    RelativePosition relPos = check_2mjdfd_a0b0t(myLabel.get());
    if (relPos == null) {
      relPos = new RelativePosition();
    }
    double scale = state.getView().getScale();
    Vector2D absolutePoint = VectorExtensions.toVector2D(relPos.getAbsolutePoint(scale));

    Vector2D pointOnEdge = VectorExtensions.toVector2D(relPos.getReferencePoint());

    // the position is relative to the parent, but we draw relative to the root
    mxICell currentParent = getParent();
    while (currentParent != null) {
      pointOnEdge = pointOnEdge.add(VectorExtensions.toVector2D(currentParent.getGeometry()));
      currentParent = currentParent.getParent();
    }

    pointOnEdge = VectorExtensions.toVector2D(JGraphUtil.convertToView(state.getView(), VectorExtensions.toPoint(pointOnEdge)));

    Vector2D nearestPointOnEdge = nearestPointOnEdge(new Vector2D(state.getCenterX(), state.getCenterY()));
    if (nearestPointOnEdge != null) {
      pointOnEdge = nearestPointOnEdge;
    }

    Vector2D pointOnBorder = findNearestPositionOnBorder(new Bounds(state.getX(), state.getY(), state.getWidth(), state.getHeight()), pointOnEdge);

    if (pointOnEdge.distance(pointOnBorder) > 10 * scale) {
      g.setStroke(new BasicStroke(((float) (1.0 * scale))));
      g.setColor(ColorUtil.withAlpha(JBColor.BLACK, 0.078));
      g.draw(new Line2D.Double(pointOnBorder.getX(), pointOnBorder.getY(), pointOnEdge.getX(), pointOnEdge.getY()));
    }


  }

  @Nullable
  protected Vector2D nearestPointOnEdge(Vector2D referencePoint) {
    return nearestPointOnEdge(getEdgeState(), referencePoint);
  }

  public static Vector2D nearestPointOnEdge(mxCellState edgeState, Vector2D referencePoint) {
    if (edgeState == null) {
      return null;
    }

    Vector2D nearest = null;
    for (int i = 1; i < edgeState.getAbsolutePointCount(); i++) {
      Point2D p0 = VectorExtensions.toPoint2D(edgeState.getAbsolutePoint(i - 1));
      Point2D p1 = VectorExtensions.toPoint2D(edgeState.getAbsolutePoint(i));
      Vector2D projection = JGraphUtil.projectPointOnLine(referencePoint, VectorExtensions.lineTo(p0, p1), true);
      if (nearest == null) {
        nearest = projection;
      } else {
        if (projection.distance(referencePoint) < nearest.distance(referencePoint)) {
          nearest = projection;
        }
      }
    }

    return nearest;
  }

  protected mxCellState getEdgeState() {
    Edge edge = check_2mjdfd_a0a0z(myLabel.get());
    if (edge == null) {
      return null;
    }
    String cellId = _getGraph().getSynchronizer().getElementMapper().getCellId(edge);
    if (cellId == null) {
      return null;
    }
    EdgeDCell cell = (EdgeDCell) _getGraph().getModel().getCell(cellId);
    if (cell == null) {
      return null;
    }
    mxCellState state = _getGraph().getView().getState(cell);
    return state;
  }

  public static Vector2D findNearestPositionOnBorder(Bounds bounds, Vector2D referencePoint) {
    // find position on the outline nearest to the reference point
    Vector2D[] corners = new Vector2D[4];
    corners[0] = new Vector2D(bounds.getX(), bounds.getMinY());
    corners[1] = new Vector2D(bounds.getMaxX(), bounds.getMinY());
    corners[2] = new Vector2D(bounds.getMaxX(), bounds.getMaxY());
    corners[3] = new Vector2D(bounds.getMinX(), bounds.getMaxY());
    Vector2D nearestPosition = corners[0];
    for (int i = 1; i < corners.length; i++) {
      if (corners[i].distance(referencePoint) < nearestPosition.distance(referencePoint)) {
        nearestPosition = corners[i];
      }
    }
    // top
    if (referencePoint.getX() > corners[0].getX() && referencePoint.getX() < corners[1].getX() && referencePoint.getY() < corners[0].getY()) {
      nearestPosition = new Vector2D(referencePoint.getX(), corners[0].getY());
    }
    // bottom
    if (referencePoint.getX() > corners[3].getX() && referencePoint.getX() < corners[2].getX() && referencePoint.getY() > corners[0].getY()) {
      nearestPosition = new Vector2D(referencePoint.getX(), corners[3].getY());
    }
    // left
    if (referencePoint.getY() > corners[0].getY() && referencePoint.getY() < corners[3].getY() && referencePoint.getX() < corners[0].getX()) {
      nearestPosition = new Vector2D(corners[3].getX(), referencePoint.getY());
    }
    // right
    if (referencePoint.getY() > corners[1].getY() && referencePoint.getY() < corners[2].getY() && referencePoint.getX() > corners[1].getX()) {
      nearestPosition = new Vector2D(corners[2].getX(), referencePoint.getY());
    }

    return nearestPosition;
  }

  @Override
  public boolean canPaintSelf(mxGraphics2DCanvas canvas, mxCellState state) {
    jetbrains.mps.nodeEditor.cells.EditorCell editorCell = as_2mjdfd_a0a0a92(check_2mjdfd_a0a0a92(check_2mjdfd_a0a0a0db(myLabel)), jetbrains.mps.nodeEditor.cells.EditorCell.class);
    return editorCell != null;
  }

  @Override
  public List<MPSCell> getMPSCells() {
    return (myMPSCells == null || !(check_2mjdfd_a0a0a0fb(check_2mjdfd_a0a0a0a13(myLabel.get()))) ? Collections.<MPSCell>emptyList() : new ArrayList<MPSCell>(myMPSCells));
  }

  @Override
  public boolean doesAdditionalPaintingOnly() {
    return false;
  }
  @Override
  public EditorCell getBigCell() {
    return check_2mjdfd_a0a43(check_2mjdfd_a0a0ib(myLabel));
  }

  @Override
  public boolean allowScaling() {
    return false;
  }

  @Nullable
  public IDiagramElement getDiagramElement() {
    return null;
  }
  private static EditorCell check_2mjdfd_a0c0l(EdgeLabel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCell();
    }
    return null;
  }
  private static EdgeLabel check_2mjdfd_a0a2a11(SerializableObjectHolder<EdgeLabel> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static EditorCell check_2mjdfd_a0b0n(EdgeLabel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCell();
    }
    return null;
  }
  private static boolean check_2mjdfd_a0a0t(Edge checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.isVisible();
    }
    return false;
  }
  private static Edge check_2mjdfd_a0a0a91(EdgeLabel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getEdge();
    }
    return null;
  }
  private static RelativePosition check_2mjdfd_a0b0t(EdgeLabel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getPosition();
    }
    return null;
  }
  private static Edge check_2mjdfd_a0a0z(EdgeLabel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getEdge();
    }
    return null;
  }
  private static EditorCell check_2mjdfd_a0a0a92(EdgeLabel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCell();
    }
    return null;
  }
  private static EdgeLabel check_2mjdfd_a0a0a0db(SerializableObjectHolder<EdgeLabel> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static boolean check_2mjdfd_a0a0a0fb(Edge checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.isVisible();
    }
    return false;
  }
  private static Edge check_2mjdfd_a0a0a0a13(EdgeLabel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getEdge();
    }
    return null;
  }
  private static EditorCell check_2mjdfd_a0a43(EdgeLabel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCell();
    }
    return null;
  }
  private static EdgeLabel check_2mjdfd_a0a0ib(SerializableObjectHolder<EdgeLabel> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static <T> T as_2mjdfd_a0a0a92(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
