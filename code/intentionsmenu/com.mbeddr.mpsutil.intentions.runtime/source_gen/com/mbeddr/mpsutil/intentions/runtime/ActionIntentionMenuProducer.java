package com.mbeddr.mpsutil.intentions.runtime;

/*Generated by MPS */

import jetbrains.mps.editor.intentions.IntentionMenuProducer;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.nodeEditor.IntentionsSupport;
import com.intellij.openapi.actionSystem.ActionGroup;
import com.intellij.openapi.actionSystem.ActionManager;
import jetbrains.mps.ide.actions.MPSActions;
import org.jetbrains.annotations.Nullable;
import com.intellij.openapi.actionSystem.DataContext;
import java.util.List;
import com.intellij.openapi.actionSystem.AnAction;
import java.util.ArrayList;
import jetbrains.mps.nodeEditor.EditorContext;
import jetbrains.mps.util.Pair;
import jetbrains.mps.openapi.intentions.IntentionExecutable;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import org.jetbrains.mps.openapi.module.ModelAccess;
import jetbrains.mps.editor.runtime.commands.EditorCommand;
import jetbrains.mps.nodeEditor.IntentionActionsProvider;
import java.util.Arrays;
import com.intellij.openapi.actionSystem.Presentation;
import jetbrains.mps.intentions.icons.IntentionIconProvider;
import java.util.Collection;
import java.util.Set;
import java.util.LinkedHashSet;
import jetbrains.mps.intentions.IntentionsManager;
import jetbrains.mps.typechecking.TypecheckingFacade;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.editor.runtime.cells.ReadOnlyUtil;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.openapi.intentions.IntentionDescriptor;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SProperty;

public class ActionIntentionMenuProducer extends IntentionMenuProducer {

  @NotNull
  protected EditorComponent editor;
  protected final IntentionsSupport intentionsSupport;

  private static final NonPopupGroup ACTIONS_AS_INTENTIONS_NON_POPUP = new NonPopupGroup((ActionGroup) ActionManager.getInstance().getAction(MPSActions.ACTIONS_AS_INTENTIONS_GROUP));

  public ActionIntentionMenuProducer(EditorComponent editor) {
    super(editor);
    this.editor = editor;
    this.intentionsSupport = MyIntentionsSupport.getIntentionsSupport(editor);
  }

  @Nullable
  @Override
  public ActionGroup getIntentionsGroup(@NotNull DataContext dataContext) {
    ActionGroupWithSections result = new ActionGroupWithSections();

    // intentions
    List<AnAction> actions = new ArrayList<>();
    EditorContext editorContext = editor.getEditorContext();

    for (Pair<IntentionExecutable, SNode> pair : CollectionSequence.fromCollection(getEnabledIntentions())) {
      result.addAction(createActionForIntention(pair.o1, editorContext, pair.o2));
    }

    result.add(ACTIONS_AS_INTENTIONS_NON_POPUP);

    result.addAll(actions);
    return result;
  }

  public void executeIntention(final IntentionExecutable intention, final SNode node) {
    ModelAccess modelAccess = editor.getEditorContext().getRepository().getModelAccess();
    modelAccess.executeCommandInEDT(new EditorCommand(editor) {
      @Override
      public void doExecute() {
        intention.execute(node, editor.getEditorContext());
      }
    });
  }

  private static AnAction createActionForIntention(@NotNull final IntentionExecutable intention, jetbrains.mps.openapi.editor.EditorContext editorContext, @NotNull final SNode node) {

    List<AnAction> intentionActions = new ArrayList<AnAction>();

    for (IntentionActionsProvider provider : IntentionActionsProvider.EP_NAME.getExtensions()) {
      intentionActions.addAll(Arrays.asList(provider.getIntentionActions(intention)));
    }

    IntentionActionGroup intentionActionGroup = new IntentionActionGroup(intention, editorContext, node);

    Presentation templatePresentation = intentionActionGroup.getTemplatePresentation();
    ActionSection.setSectionAndText(templatePresentation, intention.getDescription(node, editorContext));
    templatePresentation.setIcon(new IntentionIconProvider(intention.getDescriptor().getKind()).getIcon());
    templatePresentation.setPerformGroup(true);
    templatePresentation.setPopupGroup(true);

    intentionActionGroup.addAll(intentionActions);

    return intentionActionGroup;
  }

  @Override
  protected Collection<Pair<IntentionExecutable, SNode>> getEnabledIntentions() {
    final Set<Pair<IntentionExecutable, SNode>> result = new LinkedHashSet<Pair<IntentionExecutable, SNode>>();
    final SNode node = editor.getSelectedNode();
    final EditorContext editorContext = editor.getEditorContext();
    if (node != null) {
      final IntentionsManager.QueryDescriptor query = new IntentionsManager.QueryDescriptor();
      query.setEnabledOnly(true);
      final Collection<Pair<IntentionExecutable, SNode>> availableIntentions = TypecheckingFacade.getFromContext().computeWithSession(editor.getTypecheckingSession(), () -> IntentionsManager.getInstance().getAvailableIntentions(query, node, editorContext));
      for (Pair<IntentionExecutable, SNode> availableIntention : CollectionSequence.fromCollection(availableIntentions)) {
        SNode intentionDeclaration = SNodeOperations.as(check_2xdrxv_a0a0a3a3a41(check_2xdrxv_a0a0a0d0d0o(check_2xdrxv_a0a0a0a3a3a41(check_2xdrxv_a0a0a0a0d0d0o(availableIntention))), editorContext), CONCEPTS.BaseIntentionDeclaration$Wx);
        if (!(ReadOnlyUtil.isSelectionReadOnlyInEditor(editor)) || SPropertyOperations.getBoolean(new IAttributeDescriptor.NodeAttribute(CONCEPTS.ShowIntentionInReadOnlyCell$N0).get(intentionDeclaration), PROPS.flag$lrAD)) {
          SetSequence.fromSet(result).addElement(availableIntention);
        }
      }
    }
    return result;
  }
  private static SNode check_2xdrxv_a0a0a3a3a41(SNodeReference checkedDotOperand, EditorContext editorContext) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.resolve(editorContext.getRepository());
    }
    return null;
  }
  private static SNodeReference check_2xdrxv_a0a0a0d0d0o(IntentionDescriptor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getIntentionNodeReference();
    }
    return null;
  }
  private static IntentionDescriptor check_2xdrxv_a0a0a0a3a3a41(IntentionExecutable checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getDescriptor();
    }
    return null;
  }
  private static IntentionExecutable check_2xdrxv_a0a0a0a0d0d0o(Pair<IntentionExecutable, SNode> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.o1;
    }
    return null;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept BaseIntentionDeclaration$Wx = MetaAdapterFactory.getConcept(0xd7a92d38f7db40d0L, 0x8431763b0c3c9f20L, 0x2303633a9c3cc675L, "jetbrains.mps.lang.intentions.structure.BaseIntentionDeclaration");
    /*package*/ static final SConcept ShowIntentionInReadOnlyCell$N0 = MetaAdapterFactory.getConcept(0xb92f861d0184446dL, 0xb88b6dcf0e070241L, 0x3dbc5379fd641f5L, "com.mbeddr.mpsutil.intentions.structure.ShowIntentionInReadOnlyCell");
  }

  private static final class PROPS {
    /*package*/ static final SProperty flag$lrAD = MetaAdapterFactory.getProperty(0xb92f861d0184446dL, 0xb88b6dcf0e070241L, 0x3dbc5379fd641f5L, 0x3dbc5379fd6cba7L, "flag");
  }
}
