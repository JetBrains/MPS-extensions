package nl.f1re.testing.runtime;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.util.Pair;
import jetbrains.mps.openapi.intentions.IntentionExecutable;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.util.Condition;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Collection;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.intentions.IntentionsManager;

public class IntentionTester {
  private final EditorContext myEditorContext;
  private final boolean mySurroundWith;

  public IntentionTester(EditorContext editorContext) {
    this(editorContext, false);
  }

  public IntentionTester(EditorContext editorContext, boolean surroundWith) {
    myEditorContext = editorContext;
    mySurroundWith = surroundWith;
  }

  public Pair<IntentionExecutable, SNode> getSingleMatchingIntention(final SNode node, Condition<IntentionExecutable> intentionCondition) {
    List<Pair<IntentionExecutable, SNode>> matches = Sequence.fromIterable(getMatchingIntentions(node, intentionCondition)).toList();

    if (ListSequence.fromList(matches).count() != 1) {
      throw new RuntimeException("Expected one, found " + ListSequence.fromList(matches).count() + " intentions matching " + intentionCondition);
    }

    return ListSequence.fromList(matches).getElement(0);
  }

  private Iterable<Pair<IntentionExecutable, SNode>> getMatchingIntentions(SNode node, final Condition<IntentionExecutable> condition) {
    Collection<Pair<IntentionExecutable, SNode>> intentions = getAvailableIntentions(node);
    return CollectionSequence.fromCollection(intentions).where((it) -> condition.met(it.o1));
  }

  private Collection<Pair<IntentionExecutable, SNode>> getAvailableIntentions(final SNode node) {
    IntentionsManager.QueryDescriptor query = new IntentionsManager.QueryDescriptor();
    query.setCurrentNodeOnly(false);
    query.setSurroundWith(mySurroundWith);
    return IntentionsManager.getInstance().getAvailableIntentions(query, node, myEditorContext);
  }
}
