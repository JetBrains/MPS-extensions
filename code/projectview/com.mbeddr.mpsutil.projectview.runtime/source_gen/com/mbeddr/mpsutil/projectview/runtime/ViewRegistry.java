package com.mbeddr.mpsutil.projectview.runtime;

/*Generated by MPS */

import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Collections;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.Objects;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import org.jetbrains.annotations.Nullable;
import java.util.HashSet;

public class ViewRegistry {

  private static ViewRegistry ourInstance = new ViewRegistry();

  public static ViewRegistry getInstance() {
    return ourInstance;
  }

  private Map<ViewId, IViewDescriptor> myDescriptors = MapSequence.fromMap(new HashMap<ViewId, IViewDescriptor>());
  private Map<ViewId, Map<ElementId, Set<Class>>> myPossibleDescendantTypes = null;

  public void register(IViewDescriptor viewDescriptor) {
    MapSequence.fromMap(myDescriptors).put(viewDescriptor.getId(), viewDescriptor);
    invalidatePossibleDescendantTypes();
  }

  public void unregister(IViewDescriptor viewDescriptor) {
    MapSequence.fromMap(myDescriptors).removeKey(viewDescriptor.getId());
    invalidatePossibleDescendantTypes();
  }

  public Iterable<IViewDescriptor> getDescriptors(ViewId id) {
    final IViewDescriptor descriptor = MapSequence.fromMap(myDescriptors).get(id);
    if (descriptor == null) {
      return Sequence.fromIterable(Collections.<IViewDescriptor>emptyList());
    }
    return Sequence.fromIterable(MapSequence.fromMap(myDescriptors).values()).where((it) -> doesExtend(it, descriptor) || isBaseView(descriptor, it));
  }

  public IViewDescriptor getDescriptor(ViewId id) {
    return MapSequence.fromMap(myDescriptors).get(id);
  }

  public Iterable<IViewDescriptor> getDescriptors() {
    return MapSequence.fromMap(myDescriptors).values();
  }

  public Iterable<IViewDescriptor> getVisibleDescriptors() {
    return Sequence.fromIterable(getDescriptors()).where((it) -> it.getLabel() != null);
  }

  public Iterable<IViewElementDescriptor> getAllElements(ViewId viewId) {
    return Sequence.fromIterable(getDescriptors(viewId)).translate(new _FunctionTypes._return_P1_E0<Iterable<IViewElementDescriptor>, IViewDescriptor>() {
      public Iterable<IViewElementDescriptor> invoke(IViewDescriptor it) {
        return it.getElements();
      }
    });
  }

  public Iterable<IViewElementDescriptor> getQueryableElements(ViewId viewId) {
    return Sequence.fromIterable(getAllElements(viewId)).where(new _FunctionTypes._return_P1_E0<Boolean, IViewElementDescriptor>() {
      public Boolean invoke(IViewElementDescriptor it) {
        return it.isQueryable();
      }
    });
  }

  public IViewElementDescriptor getElement(ElementId id) {
    if (id == null) {
      return null;
    }
    return check_spq8lt_a1a42(MapSequence.fromMap(myDescriptors).get(id.getViewId()), id);
  }

  public Iterable<IViewElementDescriptor> getElementAndBaseElements(ElementId id) {
    IViewElementDescriptor element = getElement(id);
    if (element == null) {
      return Sequence.fromIterable(Collections.<IViewElementDescriptor>emptyList());
    }

    Iterable<IViewElementDescriptor> result = Sequence.<IViewElementDescriptor>singleton(element);
    if (element.getExtendsId() != null) {
      result = Sequence.fromIterable(result).concat(Sequence.fromIterable(getElementAndBaseElements(element.getExtendsId())));
    }
    return result;
  }

  public Iterable<IViewElementDescriptor> getElementAndOverridingElements(final ElementId id, final ViewId viewId) {
    IViewElementDescriptor element = getElement(id);
    if (element == null) {
      return Sequence.fromIterable(Collections.<IViewElementDescriptor>emptyList());
    }

    Iterable<IViewElementDescriptor> result = Sequence.fromIterable(getAllElements(viewId)).where(new _FunctionTypes._return_P1_E0<Boolean, IViewElementDescriptor>() {
      public Boolean invoke(IViewElementDescriptor it) {
        return Objects.equals(it.getExtendsId(), id) && it.isOverride();
      }
    }).translate(new _FunctionTypes._return_P1_E0<Iterable<IViewElementDescriptor>, IViewElementDescriptor>() {
      public Iterable<IViewElementDescriptor> invoke(IViewElementDescriptor it) {
        return getElementAndOverridingElements(it.getId(), viewId);
      }
    }).concat(Sequence.fromIterable(Sequence.<IViewElementDescriptor>singleton(element)));

    return Sequence.fromIterable(result).toList();
  }

  public Iterable<IViewElementDescriptor> getElementAndSubElements(final ElementId id, final ViewId viewId) {
    IViewElementDescriptor element = getElement(id);
    if (element == null) {
      return Sequence.fromIterable(Collections.<IViewElementDescriptor>emptyList());
    }

    Iterable<IViewElementDescriptor> result = Sequence.fromIterable(getAllElements(viewId)).where(new _FunctionTypes._return_P1_E0<Boolean, IViewElementDescriptor>() {
      public Boolean invoke(IViewElementDescriptor it) {
        return Objects.equals(it.getExtendsId(), id);
      }
    }).translate(new _FunctionTypes._return_P1_E0<Iterable<IViewElementDescriptor>, IViewElementDescriptor>() {
      public Iterable<IViewElementDescriptor> invoke(IViewElementDescriptor it) {
        return getElementAndSubElements(it.getId(), viewId);
      }
    }).concat(Sequence.fromIterable(Sequence.<IViewElementDescriptor>singleton(element)));

    return Sequence.fromIterable(result).toList();
  }

  public Iterable<IViewElementDescriptor> getInheritanceHierachy(ElementId id, final ViewId viewId) {
    List<IViewElementDescriptor> a = Sequence.fromIterable(getElementAndBaseElements(id)).toList();
    List<IViewElementDescriptor> b = ListSequence.fromList(a).translate(new _FunctionTypes._return_P1_E0<Iterable<IViewElementDescriptor>, IViewElementDescriptor>() {
      public Iterable<IViewElementDescriptor> invoke(IViewElementDescriptor it) {
        return getElementAndOverridingElements(it.getId(), viewId);
      }
    }).toList();
    Iterable<IViewElementDescriptor> c = ListSequence.fromList(b).sort(new _FunctionTypes._return_P1_E0<Comparable<?>, IViewElementDescriptor>() {
      public Comparable<?> invoke(IViewElementDescriptor it) {
        return (it.isOverride() ? 0 : 1);
      }
    }, true);
    return c;
  }

  public boolean doesExtend(IViewDescriptor extending, IViewDescriptor extended) {
    if (extending == null || extended == null) {
      return false;
    }
    if (extending == extended) {
      return true;
    }
    if (extending.getLabel() != null) {
      return false;
    }
    if (extending.getExtendsId() == null) {
      return false;
    }
    if (Objects.equals(extending.getExtendsId(), extended.getId())) {
      return true;
    }
    return doesExtend(MapSequence.fromMap(myDescriptors).get(extending.getExtendsId()), extended);
  }

  public boolean isBaseView(IViewDescriptor subView, IViewDescriptor baseView) {
    if (subView == null || baseView == null) {
      return false;
    }
    if (subView == baseView) {
      return true;
    }
    if (subView.getExtendsId() == null) {
      return false;
    }
    if (Objects.equals(subView.getExtendsId(), baseView.getId())) {
      return true;
    }
    return isBaseView(MapSequence.fromMap(myDescriptors).get(subView.getExtendsId()), baseView);
  }

  public boolean doesExtend(IViewElementDescriptor extending, IViewElementDescriptor extended) {
    if (extending == null || extended == null) {
      return false;
    }
    if (extending == extended) {
      return true;
    }
    if (extending.getExtendsId() == null) {
      return false;
    }
    if (Objects.equals(extending.getExtendsId(), extended.getId())) {
      return true;
    }
    return doesExtend(getElement(extending.getExtendsId()), extended);
  }

  public boolean doesExtend(ElementId extending, ElementId extended) {
    return doesExtend(getElement(extending), getElement(extended));
  }

  protected void initPossibleDescendantTypes() {
    myPossibleDescendantTypes = MapSequence.fromMap(new HashMap<ViewId, Map<ElementId, Set<Class>>>());

    for (ViewId viewId : SetSequence.fromSet(MapSequence.fromMap(myDescriptors).keySet())) {
      MapSequence.fromMap(myPossibleDescendantTypes).put(viewId, MapSequence.fromMap(new HashMap<ElementId, Set<Class>>()));
      for (IViewElementDescriptor parentDescriptor : Sequence.fromIterable(MapSequence.fromMap(myDescriptors).values()).translate(new _FunctionTypes._return_P1_E0<Iterable<IViewElementDescriptor>, IViewDescriptor>() {
        public Iterable<IViewElementDescriptor> invoke(IViewDescriptor it) {
          return it.getElements();
        }
      }).concat(Sequence.fromIterable(Sequence.<IViewElementDescriptor>singleton(null)))) {
        for (ElementId descendant : SetSequence.fromSet(getPossibleDescendantDescriptors(check_spq8lt_a0a0b0c0qb(parentDescriptor), viewId))) {
          registerDescendantType(getElement(descendant).getOutputType(), check_spq8lt_b0a0a0b0c0qb(parentDescriptor), viewId);
        }
      }
    }
  }

  public Iterable<IViewElementDescriptor> getPossibleParents(ElementId childId, ViewId contextView) {
    return Sequence.fromIterable(getElementAndSubElements(childId, contextView)).select(new _FunctionTypes._return_P1_E0<IViewElementDescriptor, IViewElementDescriptor>() {
      public IViewElementDescriptor invoke(IViewElementDescriptor it) {
        return getElement(it.getParentId());
      }
    }).where(new _FunctionTypes._return_P1_E0<Boolean, IViewElementDescriptor>() {
      public Boolean invoke(IViewElementDescriptor it) {
        return it != null;
      }
    }).distinct();
  }

  public void invalidatePossibleDescendantTypes() {
    myPossibleDescendantTypes = null;
  }

  protected void registerDescendantType(Class type, @Nullable ElementId descriptorId, ViewId contextView) {
    if (type == null) {
      return;
    }

    Set<Class> types = MapSequence.fromMap(MapSequence.fromMap(myPossibleDescendantTypes).get(contextView)).get(descriptorId);
    if (types == null) {
      types = SetSequence.fromSet(new HashSet<Class>());
      MapSequence.fromMap(MapSequence.fromMap(myPossibleDescendantTypes).get(contextView)).put(descriptorId, types);
    }
    SetSequence.fromSet(types).addElement(type);
  }

  public Set<Class> getPossibleDescendantTypes(@Nullable ElementId elementId, ViewId contextView) {
    if (myPossibleDescendantTypes == null) {
      initPossibleDescendantTypes();
    }
    Set<Class> types = MapSequence.fromMap(MapSequence.fromMap(myPossibleDescendantTypes).get(contextView)).get(elementId);
    return (types != null ? types : Collections.<Class>emptySet());
  }

  public Iterable<IViewElementDescriptor> getChildDescriptors(@Nullable final ElementId parentId, ViewId viewId) {
    Iterable<IViewElementDescriptor> concreteDescriptors = getQueryableElements(viewId);
    final Set<ElementId> hierachy = SetSequence.fromSetWithValues(new HashSet<ElementId>(), Sequence.fromIterable(getInheritanceHierachy(parentId, viewId)).select(new _FunctionTypes._return_P1_E0<ElementId, IViewElementDescriptor>() {
      public ElementId invoke(IViewElementDescriptor it) {
        return it.getId();
      }
    }));
    return Sequence.fromIterable(concreteDescriptors).where(new _FunctionTypes._return_P1_E0<Boolean, IViewElementDescriptor>() {
      public Boolean invoke(IViewElementDescriptor it) {
        return Objects.equals(it.getParentId(), parentId) || SetSequence.fromSet(hierachy).contains(it.getParentId());
      }
    });
  }

  public Set<ElementId> getPossibleDescendantDescriptors(@Nullable ElementId parentId, ViewId contextView) {
    Set<ElementId> result = SetSequence.fromSet(new HashSet<ElementId>());
    collectPossibleDescendantDescriptors(parentId, contextView, result);
    return result;
  }

  protected void collectPossibleDescendantDescriptors(@Nullable ElementId parentId, ViewId contextView, Set<ElementId> result) {
    for (IViewElementDescriptor child : Sequence.fromIterable(getChildDescriptors(parentId, contextView))) {
      ElementId childId = child.getId();
      if (SetSequence.fromSet(result).contains(childId)) {
        continue;
      }
      SetSequence.fromSet(result).addElement(childId);
      collectPossibleDescendantDescriptors(childId, contextView, result);
    }
  }
  private static IViewElementDescriptor check_spq8lt_a1a42(IViewDescriptor checkedDotOperand, ElementId id) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getElement(id);
    }
    return null;
  }
  private static ElementId check_spq8lt_b0a0a0b0c0qb(IViewElementDescriptor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getId();
    }
    return null;
  }
  private static ElementId check_spq8lt_a0a0b0c0qb(IViewElementDescriptor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getId();
    }
    return null;
  }
}
