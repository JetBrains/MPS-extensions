package de.q60.mps.shadowmodels.runtime.engine;

/*Generated by MPS */

import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Collections;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.Objects;

public class SiblingScopes {
  public Iterable<IScope> findSiblings(IScope sourceScope, ITransformationEngine engine) {
    if (sourceScope instanceof StageScope) {
      StageScope cast_it = (StageScope) sourceScope;
      return findSiblings(cast_it, engine);
    } else if (sourceScope instanceof NamedScope) {
      NamedScope cast_it = (NamedScope) sourceScope;
      return findSiblings(cast_it, engine);
    } else if (sourceScope instanceof RootScope) {
      RootScope cast_it = (RootScope) sourceScope;
      return Sequence.fromIterable(Collections.<IScope>emptyList());
    } else {
      return Sequence.fromIterable(Collections.<IScope>emptyList());
    }
  }

  public Iterable<IScope> findSiblings(StageScope scope, ITransformationEngine engine) {
    final ISubgraphStage ownStage = scope.getStage(engine);
    final ISubgraphCall ownCall = check_u6v27k_a0b0c(check_u6v27k_a0a1a2(as_u6v27k_a0a0a1a2(scope.getStage().getSubgraphRef(), ChildSubgraphRef.class)));
    if (ownCall == null) {
      return Sequence.fromIterable(Collections.<IScope>emptyList());
    }

    final SubgraphStage parentStage = as_u6v27k_a0a4a2(check_u6v27k_a0a4a2(scope.getParent(), engine), SubgraphStage.class);
    if (parentStage == null) {
      return Sequence.fromIterable(Collections.<IScope>emptyList());
    }

    Iterable<IUniqueContainmentTarget> allSubgraphs = Sequence.fromIterable(parentStage.getAllContent()).where(new _FunctionTypes._return_P1_E0<Boolean, IUniqueContainmentTarget>() {
      public Boolean invoke(IUniqueContainmentTarget it) {
        return it.getTarget() instanceof ISubgraphCall;
      }
    });
    Iterable<IUniqueContainmentTarget> siblingsSubgraphs = Sequence.fromIterable(allSubgraphs).where(new _FunctionTypes._return_P1_E0<Boolean, IUniqueContainmentTarget>() {
      public Boolean invoke(IUniqueContainmentTarget it) {
        return !(Objects.equals(it.getTarget(), ownCall)) && areSiblings(ownCall, (ISubgraphCall) it.getTarget());
      }
    });
    Iterable<IStageReference> siblingStageRefs = Sequence.fromIterable(siblingsSubgraphs).select(new _FunctionTypes._return_P1_E0<IStageReference, IUniqueContainmentTarget>() {
      public IStageReference invoke(IUniqueContainmentTarget it) {
        return getSiblingStageRef(ownStage.getStageReference(), new ChildSubgraphRef(parentStage.getStageReference(), it));
      }
    });
    return Sequence.fromIterable(siblingStageRefs).select((it) -> {
      IScope s = new StageScope(it);
      return s;
    }).toList();
  }

  public Iterable<IScope> findSiblings(NamedScope scope, ITransformationEngine engine) {
    return Sequence.fromIterable(Collections.<IScope>emptyList());
  }

  public boolean areSiblings(ISubgraphCall a, ISubgraphCall b) {
    if (a instanceof ForkCall) {
      ForkCall cast_it = (ForkCall) a;
      return b instanceof ForkCall && Objects.equals(((ForkCall) b).getId(), cast_it.getId());
    } else if (a instanceof GoalCall) {
      GoalCall cast_it = (GoalCall) a;
      return b instanceof GoalCall && Objects.equals(((GoalCall) b).getGoalId(), cast_it.getGoalId());
    } else {
      return false;
    }
  }

  public IStageReference getSiblingStageRef(IStageReference sourceStage, ISubgraphRef siblingSubgraph) {
    if (sourceStage instanceof SubstepStageReference) {
      SubstepStageReference cast_it = (SubstepStageReference) sourceStage;
      return new StepStageReference(siblingSubgraph, cast_it.getStepNumber());
    } else if (sourceStage instanceof StepStageReference) {
      StepStageReference cast_it = (StepStageReference) sourceStage;
      return new StepStageReference(siblingSubgraph, cast_it.getStepNumber());
    } else {
      return new FinalStageReference(siblingSubgraph);
    }
  }
  private static ISubgraphCall check_u6v27k_a0b0c(IUniqueContainmentTarget<ISubgraphCall> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getTarget();
    }
    return null;
  }
  private static IUniqueContainmentTarget<ISubgraphCall> check_u6v27k_a0a1a2(ChildSubgraphRef checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCall();
    }
    return null;
  }
  private static ISubgraphStage check_u6v27k_a0a4a2(IScope checkedDotOperand, ITransformationEngine engine) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getStage(engine);
    }
    return null;
  }
  private static <T> T as_u6v27k_a0a0a1a2(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_u6v27k_a0a4a2(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
