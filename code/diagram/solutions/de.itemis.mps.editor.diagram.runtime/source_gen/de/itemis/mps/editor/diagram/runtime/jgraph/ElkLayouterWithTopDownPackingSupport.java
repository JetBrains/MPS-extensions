package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.eclipse.elk.core.options.TopdownNodeTypes;
import org.eclipse.elk.core.options.TopdownSizeApproximator;
import org.eclipse.elk.core.options.Direction;
import org.eclipse.elk.graph.ElkNode;
import org.eclipse.elk.core.util.IElkProgressMonitor;
import org.eclipse.elk.core.options.CoreOptions;
import de.itemis.mps.editor.diagram.runtime.model.IAccessorKey;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;

public abstract class ElkLayouterWithTopDownPackingSupport extends ElkLayouter {
  protected double topdownHierarchicalNodeAspectRatio;
  protected double topdownHierachicalNodeWidth;
  protected boolean topdownLayout;
  protected double topdownScaleCap;

  protected Map<Object, Double> topdownHierarchicalNodeAspectRatios = MapSequence.fromMap(new HashMap<Object, Double>());
  protected Map<Object, Double> topdownHierachicalNodeWidths = MapSequence.fromMap(new HashMap<Object, Double>());
  protected Map<Object, TopdownNodeTypes> topdownHierachicalNodeTypes = MapSequence.fromMap(new HashMap<Object, TopdownNodeTypes>());
  protected Map<Object, TopdownSizeApproximator> topdownSizeApproximators = MapSequence.fromMap(new HashMap<Object, TopdownSizeApproximator>());

  public ElkLayouterWithTopDownPackingSupport() {
    super(Direction.RIGHT);
  }

  public ElkLayouterWithTopDownPackingSupport(Direction direction) {
    super(direction);
  }

  @Override
  protected void addLayoutInformationToGraph(ElkNode graph, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToGraph(graph, progressMonitor);
    ElkNode layout = graph;

    layout.setProperty(CoreOptions.TOPDOWN_HIERARCHICAL_NODE_ASPECT_RATIO, topdownHierarchicalNodeAspectRatio);
    layout.setProperty(CoreOptions.TOPDOWN_HIERARCHICAL_NODE_WIDTH, topdownHierachicalNodeWidth);
    layout.setProperty(CoreOptions.TOPDOWN_LAYOUT, topdownLayout);
    layout.setProperty(CoreOptions.TOPDOWN_SCALE_CAP, topdownScaleCap);

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(layout, "graph", progressMonitor);
    }
  }

  @Override
  protected void addLayoutInformationToNode(ElkNode knode, BoxDCell box, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToNode(knode, box, progressMonitor);
    ElkNode layout = knode;
    IAccessorKey ID = box.getBox().getAccessor().getId();

    Double aspectRatio = MapSequence.fromMap(topdownHierarchicalNodeAspectRatios).get(ID);
    if (aspectRatio != null) {
      layout.setProperty(CoreOptions.TOPDOWN_HIERARCHICAL_NODE_ASPECT_RATIO, aspectRatio);
    }

    Double width = MapSequence.fromMap(topdownHierachicalNodeWidths).get(ID);
    if (width != null) {
      layout.setProperty(CoreOptions.TOPDOWN_HIERARCHICAL_NODE_WIDTH, width);
    }

    TopdownNodeTypes nodeTypes = MapSequence.fromMap(topdownHierachicalNodeTypes).get(ID);
    if (nodeTypes != null) {
      layout.setProperty(CoreOptions.TOPDOWN_NODE_TYPE, nodeTypes);
    }

    TopdownSizeApproximator sizeApproximator = MapSequence.fromMap(topdownSizeApproximators).get(ID);
    if (sizeApproximator != null) {
      layout.setProperty(CoreOptions.TOPDOWN_SIZE_APPROXIMATOR, sizeApproximator);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(layout, "node", progressMonitor);
    }
  }

  @Override
  public void setParentsStyle(Style style) {
    super.setParentsStyle(style);

    topdownHierarchicalNodeAspectRatio = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-topdown-hierarchical-node-aspect-ratio"));
    topdownHierachicalNodeWidth = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-topdown-hierarchical-node-width"));
    topdownLayout = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-topdown-layout"));
    topdownScaleCap = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-topdown-scale-cap"));
  }

  @Override
  public void addNodesStyle(Style style, Object key) {
    super.addNodesStyle(style, key);
    MapSequence.fromMap(topdownHierarchicalNodeAspectRatios).put(key, style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-topdown-hierarchical-node-aspect-ratio")));
    MapSequence.fromMap(topdownHierachicalNodeWidths).put(key, style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-topdown-hierarchical-node-width")));
    MapSequence.fromMap(topdownHierachicalNodeTypes).put(key, style.get(StyleAttributes.getInstance().<TopdownNodeTypes>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-topdown-node-type")));
    MapSequence.fromMap(topdownSizeApproximators).put(key, style.get(StyleAttributes.getInstance().<TopdownSizeApproximator>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-topdown-size-approximator")));
  }
}
