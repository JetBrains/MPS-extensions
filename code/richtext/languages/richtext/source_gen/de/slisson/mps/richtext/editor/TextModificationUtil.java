package de.slisson.mps.richtext.editor;

/*Generated by MPS */

import org.jetbrains.mps.util.Condition;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.cells.CellTraversalUtil;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.openapi.editor.cells.EditorCell_Label;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import de.slisson.mps.editor.multiline.cells.EditorCell_Word;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class TextModificationUtil {
  public static Condition<EditorCell> isRichtextDescendant(final EditorCell myCell) {
    return new Condition<EditorCell>() {
      public boolean met(EditorCell cell) {
        return CellTraversalUtil.isAncestor(myCell, cell);
      }
    };
  }

  public static void duplicateCurrentLine(EditorContext context) {
    EditorCell_Label selected = TextCellModifier.getSelectedLabel(context);
    context.getEditorComponent().getSelectionManager().getSelection().executeAction(CellActionType.HOME);
    context.getEditorComponent().getSelectionManager().getSelection().executeAction(CellActionType.SELECT_END);
    context.getEditorComponent().getSelectionManager().getSelection().executeAction(CellActionType.COPY);
    context.getEditorComponent().getSelectionManager().getSelection().executeAction(CellActionType.RIGHT);
    context.getEditorComponent().getSelectionManager().getSelection().executeAction(CellActionType.END);
    context.getEditorComponent().getSelectionManager().getSelection().executeAction(CellActionType.INSERT);
    context.getEditorComponent().getSelectionManager().getSelection().executeAction(CellActionType.PASTE);
  }

  public static void removeTextFromCaretToLineStart(EditorContext context) {
    EditorCell_Label selected = TextCellModifier.getSelectedLabel(context);
    if (!(selected instanceof EditorCell_Word)) {
      SNode selectedNode = selected.getSNode();
      selectedNode = SNodeOperations.getNodeAncestor(selectedNode, CONCEPTS.IWord$8d, true, false);
      selected = as_pbhcl_a0a2a1a4(CellTraversalUtil.getPrevLeaf(selected), EditorCell_Label.class);
      context.getSelectionManager().setSelection(selected, selected.getText().length());
      SNodeOperations.deleteNode(selectedNode);
    }
    EditorCell_Word homeCell = as_pbhcl_a0a2a4(TextCellModifier.getHomeCell(selected, TextModificationUtil.isRichtextDescendant(selected.getParent())), EditorCell_Word.class);
    EditorCell_Word selectedCell = as_pbhcl_a0a3a4(context.getSelectedCell(), EditorCell_Word.class);
    selectedCell.changeText(selectedCell.getTextAfterCaret());
    int startIndex = homeCell.getWordNum();
    int endIndex = selectedCell.getWordNum() - 1;
    if (endIndex >= startIndex) {
      selectedCell.getParent().deleteWords(startIndex, endIndex);
    }
    context.selectWRTFocusPolicy(homeCell);
    homeCell.setCaretPosition(0);
    if (homeCell.getParent().isCaretAtLineStart()) {
      //  We are at the end of the multiline cell but there might be a IWord next to it.
      jetbrains.mps.nodeEditor.cells.EditorCell prevSibling = homeCell.getParent().getPrevSibling();
      if (prevSibling != null) {
        context.selectWRTFocusPolicy(prevSibling);
        removeTextFromCaretToLineStart(context);
      }
    }
  }

  public static void removeTextFromCaretToLineEnd(EditorContext context) {
    EditorCell_Label selected = TextCellModifier.getSelectedLabel(context);

    if (!(selected instanceof EditorCell_Word)) {
      SNode selectedNode = selected.getSNode();
      selectedNode = SNodeOperations.getNodeAncestor(selectedNode, CONCEPTS.IWord$8d, true, false);
      selected = as_pbhcl_a0a2a2a6(CellTraversalUtil.getNextLeaf(selected), EditorCell_Label.class);
      context.getSelectionManager().setSelection(selected, selected.getText().length());
      SNodeOperations.deleteNode(selectedNode);
    }
    EditorCell_Word endCell = as_pbhcl_a0a3a6(TextCellModifier.getEndCell(selected, TextModificationUtil.isRichtextDescendant(selected.getParent())), EditorCell_Word.class);
    EditorCell_Word selectedCell = as_pbhcl_a0a4a6(context.getSelectedCell(), EditorCell_Word.class);
    selectedCell.changeText(selectedCell.getTextBeforeCaret());
    int startIndex = selectedCell.getWordNum() + 1;
    int endIndex = endCell.getWordNum();
    if (endIndex >= startIndex) {
      selectedCell.getParent().deleteWords(startIndex, endIndex);
    }
    if (isEmptyString(selectedCell.getParent().getTextAfterCaret())) {
      //  We are at the end of the multiline cell but there might be a IWord next to it.
      jetbrains.mps.nodeEditor.cells.EditorCell nextSibling = selectedCell.getParent().getNextSibling();
      if (nextSibling != null) {
        context.selectWRTFocusPolicy(nextSibling);
        removeTextFromCaretToLineEnd(context);
      }
    }

  }
  private static <T> T as_pbhcl_a0a2a1a4(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_pbhcl_a0a2a4(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_pbhcl_a0a3a4(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_pbhcl_a0a2a2a6(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_pbhcl_a0a3a6(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_pbhcl_a0a4a6(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static boolean isEmptyString(String str) {
    return str == null || str.isEmpty();
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IWord$8d = MetaAdapterFactory.getInterfaceConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e7aecL, "de.slisson.mps.richtext.structure.IWord");
  }
}
