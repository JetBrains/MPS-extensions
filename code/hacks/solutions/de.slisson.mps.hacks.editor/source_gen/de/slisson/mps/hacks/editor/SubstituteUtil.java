package de.slisson.mps.hacks.editor;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.cells.SubstituteInfo;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;
import jetbrains.mps.openapi.editor.cells.EditorCellContext;
import java.util.Collection;
import java.util.Collections;
import jetbrains.mps.openapi.editor.menus.transformation.SNodeLocation;
import jetbrains.mps.nodeEditor.cells.EditorCellContextImpl;
import jetbrains.mps.nodeEditor.cellMenu.SChildSubstituteInfo;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.openapi.editor.cells.SubstituteAction;
import jetbrains.mps.nodeEditor.cellMenu.CompletionActionItemAsSubstituteAction;
import jetbrains.mps.openapi.editor.menus.transformation.CompletionActionItem;
import jetbrains.mps.openapi.editor.menus.substitute.SubstituteMenuItem;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import jetbrains.mps.openapi.editor.cells.EditorCellFactory;
import jetbrains.mps.openapi.editor.update.UpdateSession;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;

public class SubstituteUtil {

  public static SubstituteInfo forChild(EditorContext editorContext, SNode parent, @Nullable SNode child, SContainmentLink link) {
    EditorCell dummyContextCell = new EditorCell_Constant(editorContext, (child != null ? child : parent), "");
    dummyContextCell.setSRole(link);
    EditorCellContext cellContext = check_lw3dny_a0c0b(check_lw3dny_a0a2a1(editorContext.getEditorComponent().getUpdater().getCurrentUpdateSession()));
    if (cellContext == null) {
      cellContext = new EditorCellContext() {
        public Collection<String> getHints() {
          return Collections.emptyList();
        }
        public SNodeLocation getNodeLocation() {
          return null;
        }
        public boolean hasContextHint(String p0) {
          return false;
        }
      };
    }
    EditorCellContextImpl newContext = new EditorCellContextImpl(cellContext);
    SNodeLocation location = (child == null ? new SNodeLocation.FromParentAndLink(parent, link) : new SNodeLocation.FromNode(child));
    newContext.setNodeLocation(location);
    dummyContextCell.setCellContext(newContext);
    return forChild(editorContext, dummyContextCell, parent, child, link);
  }
  public static SubstituteInfo forChild(EditorContext editorContext, EditorCell cell, SNode parent, @Nullable SNode child, SContainmentLink link) {
    return new SChildSubstituteInfo(cell, parent, link, null);
  }

  public static SubstituteInfo forChild(EditorContext editorContext, SNode parent, @Nullable SNode child, final SNode linkDeclaration) {

    Iterable<SContainmentLink> links = SNodeOperations.getConcept(parent).getContainmentLinks();
    SContainmentLink slink = Sequence.fromIterable(links).findFirst((it) -> Objects.equals(it.getName(), SPropertyOperations.getString(linkDeclaration, PROPS.name$MnvL)));

    return forChild(editorContext, parent, child, slink);
  }

  public static SAbstractConcept getOutputConcept(SubstituteAction action) {

    // For wrapper substitute actions, CompletionActionItemAsSubstituteAction.getOutputConcept returns the
    // output concept of the wrapped action and not the output concept of the wrapper.
    // This is a fix for this bug.
    // It was introduced in MPS 3.4.3 with the commit 474f7e71d8fc7c8a0a4125f000bbe517f10e02fe.

    if (action instanceof CompletionActionItemAsSubstituteAction) {
      CompletionActionItem actionItem = check_lw3dny_a0a0g0g(((CompletionActionItemAsSubstituteAction) action));
      try {
        Class<?> SubstituteMenuItemAsActionItem = Class.forName("jetbrains.mps.lang.editor.menus.transformation.SubstituteMenuItemAsActionItem");
        if (SubstituteMenuItemAsActionItem.isAssignableFrom(actionItem.getClass())) {
          SubstituteMenuItem substituteItem = ((SubstituteMenuItem) ReflectionUtil.readField(SubstituteMenuItemAsActionItem, actionItem, "mySubstituteItem"));
          return substituteItem.getOutputConcept();
        }
      } catch (ClassNotFoundException ex) {
        throw new RuntimeException(ex);
      }
    }
    return SNodeOperations.asSConcept(SNodeOperations.cast(action.getOutputConcept(), CONCEPTS.AbstractConceptDeclaration$KA));
  }
  private static EditorCellContext check_lw3dny_a0c0b(EditorCellFactory checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCellContext();
    }
    return null;
  }
  private static EditorCellFactory check_lw3dny_a0a2a1(UpdateSession checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCellFactory();
    }
    return null;
  }
  private static CompletionActionItem check_lw3dny_a0a0g0g(CompletionActionItemAsSubstituteAction checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getItem();
    }
    return null;
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept AbstractConceptDeclaration$KA = MetaAdapterFactory.getConcept(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0x1103553c5ffL, "jetbrains.mps.lang.structure.structure.AbstractConceptDeclaration");
  }
}
