package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import java.util.Map;
import org.eclipse.elk.core.math.KVector;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.eclipse.elk.core.options.FixedLayouterOptions;
import org.eclipse.elk.graph.ElkNode;
import org.eclipse.elk.core.util.IElkProgressMonitor;
import de.itemis.mps.editor.diagram.runtime.model.IAccessorKey;
import org.eclipse.elk.graph.ElkPort;
import org.eclipse.elk.graph.ElkEdge;
import org.eclipse.elk.graph.ElkLabel;
import de.itemis.mps.editor.diagram.runtime.model.EdgeLabelType;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;

public class FixedLayouter extends ElkLayouter {

  protected boolean fixedGraphSize;

  private Map<Object, KVector> myNodePositions = MapSequence.fromMap(new HashMap<Object, KVector>());
  private Map<Object, KVector> myPortPositions = MapSequence.fromMap(new HashMap<Object, KVector>());
  private Map<Object, KVector> myLabelPositions = MapSequence.fromMap(new HashMap<Object, KVector>());

  public FixedLayouter() {
    super();
    myAlgorithm = FixedLayouterOptions.ALGORITHM_ID;
  }

  @Override
  public boolean canLayoutLabels() {
    return false;
  }

  @Override
  protected boolean useDummyPort(EdgeDCell edge, boolean isTarget) {
    return false;
  }

  @Override
  protected void addLayoutInformationToGraph(ElkNode graph, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToGraph(graph, progressMonitor);
    ElkNode layout = graph;
    layout.setProperty(FixedLayouterOptions.NODE_SIZE_FIXED_GRAPH_SIZE, fixedGraphSize);

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(layout, "graph", progressMonitor);
    }
  }

  @Override
  protected void addLayoutInformationToNode(ElkNode knode, BoxDCell box, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToNode(knode, box, progressMonitor);
    IAccessorKey ID = box.getBox().getAccessor().getId();
    ElkNode layout = knode;
    KVector position = MapSequence.fromMap(myNodePositions).get(ID);
    if (position != null) {
      layout.setProperty(FixedLayouterOptions.POSITION, position);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(layout, "node", progressMonitor);
    }
  }


  @Override
  protected void addLayoutInformationToPort(ElkNode knode, ElkPort kport, BoxDCell node, PortDCell port, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToPort(knode, kport, node, port, progressMonitor);
    IAccessorKey ID = node.getBox().getAccessor().getId();
    KVector position = MapSequence.fromMap(myPortPositions).get(ID);
    if (position != null) {
      kport.setProperty(FixedLayouterOptions.POSITION, position);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(kport, "port", progressMonitor);
    }
  }

  @Override
  protected void addLayoutInformationToEdgeLabel(ElkEdge kedge, ElkLabel klabel, EdgeDCell edge, EdgeLabelType type, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToEdgeLabel(kedge, klabel, edge, type, progressMonitor);
    IAccessorKey ID = edge.getEdge().getAccessor().getId();
    KVector position = MapSequence.fromMap(myLabelPositions).get(ID);
    if (position != null) {
      klabel.setProperty(FixedLayouterOptions.POSITION, position);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(klabel, "edge label", progressMonitor);
    }
  }

  @Override
  public void setParentsStyle(Style style) {
    super.setParentsStyle(style);
    fixedGraphSize = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-fixed-graph-size"));
  }

  @Override
  public void addNodesStyle(Style style, Object key) {
    super.addNodesStyle(style, key);
    MapSequence.fromMap(myNodePositions).put(key, style.get(StyleAttributes.getInstance().<KVector>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-fixed-position")));
  }


  @Override
  public void addPortsStyle(Style style, Object key) {
    super.addPortsStyle(style, key);
    MapSequence.fromMap(myPortPositions).put(key, style.get(StyleAttributes.getInstance().<KVector>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-fixed-position")));
  }

  @Override
  public void addLabelsStyle(Style style, Object key) {
    super.addLabelsStyle(style, key);
    MapSequence.fromMap(myLabelPositions).put(key, style.get(StyleAttributes.getInstance().<KVector>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-fixed-position")));
  }
}
