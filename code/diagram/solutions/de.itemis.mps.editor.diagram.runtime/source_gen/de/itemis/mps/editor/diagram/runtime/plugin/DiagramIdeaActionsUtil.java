package de.itemis.mps.editor.diagram.runtime.plugin;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.EditorContext;
import de.itemis.mps.editor.diagram.runtime.jgraph.BaseDiagramECell;
import de.itemis.mps.editor.diagram.runtime.jgraph.MyGraph;
import de.itemis.mps.editor.diagram.runtime.jgraph.MyGraphComponent;
import de.itemis.mps.editor.diagram.runtime.jgraph.MPSCell;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.cells.EditorCell_Label;
import jetbrains.mps.openapi.editor.selection.Selection;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import de.itemis.mps.editor.diagram.runtime.jgraph.DiagramActionsUtil;
import jetbrains.mps.project.Project;
import jetbrains.mps.ide.project.ProjectHelper;
import de.itemis.mps.editor.diagram.runtime.jgraph.Palette;
import jetbrains.mps.plugins.projectplugins.ProjectPluginManager;
import jetbrains.mps.nodeEditor.EditorComponent;

public class DiagramIdeaActionsUtil {
  public static void selectAll(EditorContext editorContext) {
    BaseDiagramECell activeDiagram = getActiveDiagram(editorContext);
    if (activeDiagram == null) {
      return;
    }
    MyGraph graph = activeDiagram.getContextGraph();
    MyGraphComponent graphComponent = graph.getGraphComponent();
    MPSCell mpsCell = graphComponent.getCellEditor().getMPSCell();
    EditorCell editorCell = (mpsCell == null ? null : mpsCell.getEditorCell());
    if (editorCell != null && editorCell instanceof EditorCell_Label) {
      DiagramIdeaActionsUtil.selectLabel(editorCell, graphComponent);
    } else {
      Selection selection = editorContext.getSelectionManager().getSelection();
      boolean labelFound = false;
      for (EditorCell ec : ListSequence.fromList(selection.getSelectedCells())) {
        if (ec instanceof EditorCell_Label) {
          DiagramIdeaActionsUtil.selectLabel(ec, graphComponent);
          labelFound = true;
        }
      }
      if (!(labelFound)) {
        selection.executeAction(CellActionType.SELECT_ALL);
      }
    }
  }

  private static void selectLabel(EditorCell ec, MyGraphComponent graphComponent) {
    EditorCell_Label label = ((EditorCell_Label) ec);
    graphComponent.getEditorComponent().getSelectionManager().setSelection(label, label.getCaretPosition(), 0, label.getText().length());
  }

  public static void autolayout(EditorContext editorContext) {
    DiagramActionsUtil.autoLayout(editorContext);
  }

  public static void fitSizeAndAutolayout(EditorContext editorContext) {
    DiagramActionsUtil.fitSizeAll(editorContext, true);
    autolayout(editorContext);
  }
  public static void zoomIn(EditorContext ec) {
    BaseDiagramECell activeDiagram = getActiveDiagram(ec);
    if (activeDiagram == null) {
      return;
    }
    activeDiagram.getContextGraph().getGraphComponent().zoomIn();
  }
  public static void zoomOut(EditorContext ec) {
    BaseDiagramECell activeDiagram = getActiveDiagram(ec);
    if (activeDiagram == null) {
      return;
    }
    activeDiagram.getContextGraph().getGraphComponent().zoomOut();
  }

  public static BaseDiagramECell getActiveDiagram(EditorContext editorContext) {
    Project mpsProject = editorContext.getOperationContext().getProject();
    com.intellij.openapi.project.Project ideaProject = ProjectHelper.toIdeaProject(mpsProject);
    Palette palette = ProjectPluginManager.getInstance(ideaProject).getTool(Diagram_Palette_Tool.class).getPaletteComponent();
    if (palette == null) {
      return null;
    }
    palette.updateActiveDiagramCell(((EditorComponent) editorContext.getEditorComponent()));
    BaseDiagramECell activeDiagram = palette.getActiveDiagram();
    return activeDiagram;
  }
}
