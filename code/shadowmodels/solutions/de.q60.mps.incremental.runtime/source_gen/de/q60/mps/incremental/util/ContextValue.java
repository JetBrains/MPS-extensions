package de.q60.mps.incremental.util;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;

public class ContextValue<E> {

  private E defaultValue;
  private ThreadLocal<List<E>> value = new ThreadLocal<List<E>>();

  public ContextValue() {
  }

  public ContextValue(E defaultValue) {
    this.defaultValue = defaultValue;
  }

  private List<E> getStack() {
    List<E> stack = value.get();
    if (stack == null) {
      stack = ListSequence.fromList(new ArrayList<E>());
      value.set(stack);
    }
    return stack;
  }

  public void runWith(E newValue, Runnable r) {
    try {
      ListSequence.fromList(getStack()).addElement(newValue);
      r.run();
    } finally {
      ListSequence.fromList(getStack()).removeLastElement();
    }
  }

  /**
   * 
   */
  public void runWithFunctionType(E newValue, _FunctionTypes._void_P0_E0 r) {
    try {
      ListSequence.fromList(getStack()).addElement(newValue);
      r.invoke();
    } finally {
      ListSequence.fromList(getStack()).removeLastElement();
    }
  }

  public <T> T computeWith(E newValue, _FunctionTypes._return_P0_E0<? extends T> r) {
    try {
      ListSequence.fromList(getStack()).addElement(newValue);
      return r.invoke();
    } finally {
      ListSequence.fromList(getStack()).removeLastElement();
    }
  }

  public E getValue() {
    List<E> stack = getStack();
    return (ListSequence.fromList(stack).isEmpty() ? defaultValue : ListSequence.fromList(stack).last());
  }

  public Iterable<E> getAllValues() {
    return getStack();
  }

}
