package de.itemis.mps.editor.celllayout.layout;

/*Generated by MPS */

import de.itemis.mps.editor.celllayout.boxmodel.Size;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;

public class GridElement {
  private ILayoutable myLayoutable;
  private int myColumn;
  private int myRow;
  private Grid myGrid;
  private int myColumnSpan = 1;
  private int myRowSpan = 1;

  public GridElement(Grid grid, int column, int row) {
    myGrid = grid;
    myColumn = column;
    myRow = row;
  }

  @Override
  public String toString() {
    String columnPart = "" + myColumn;
    String rowPart = "" + myRow;
    if (myColumnSpan == -1) {
      columnPart += "-?";
    } else if (myColumnSpan > 1) {
      columnPart += "-";
      columnPart += myColumn + myColumnSpan - 1;
    }
    if (myRowSpan == -1) {
      rowPart += "-?";
    } else if (myRowSpan > 1) {
      rowPart += "-";
      rowPart += myRow + myRowSpan - 1;
    }
    return "(" + columnPart + ", " + rowPart + ") " + getLayoutable();
  }

  public ILayoutable getLayoutable() {
    return myLayoutable;
  }

  public void setLayoutable(ILayoutable layoutable) {
    myLayoutable = layoutable;
  }

  public void extendSize(Size size) {
    extendWidth(size.getWidth());
    int ascent = myLayoutable.getAscent(size);
    ascent = Math.min(ascent, size.getHeight());
    int descent = size.getHeight() - ascent;
    extendHeight(ascent, descent);
  }

  public void extendWidth(int width) {
    int delta = width - getWidth();
    if (delta > 0) {
      int singleDelta = delta / getColumnSpan();
      List<Integer> columnsToGrow = ListSequence.fromList(new ArrayList<Integer>());
      List<Integer> spannedColumns = ListSequence.fromList(new ArrayList<Integer>());
      for (int i = getColumnIndex(); i <= getMaxColumnIndex(); i++) {
        ListSequence.fromList(spannedColumns).addElement(i);
        if (myGrid.columnHasAnyGrowX(i)) {
          ListSequence.fromList(columnsToGrow).addElement(i);
        }
      }
      if (ListSequence.fromList(columnsToGrow).isEmpty()) {
        columnsToGrow = spannedColumns;
      }
      if (ListSequence.fromList(columnsToGrow).isNotEmpty()) {
        extendColumns(columnsToGrow, delta);
      }
    }
  }

  protected void extendColumns(List<Integer> columnNumbers, int delta) {
    // TODO do the same for the height
    int singleDelta = delta / ListSequence.fromList(columnNumbers).count();
    for (int i = 0; i < ListSequence.fromList(columnNumbers).count() - 1; i++) {
      int col = ListSequence.fromList(columnNumbers).getElement(i);
      myGrid.setColumnWidth(col, myGrid.getColumnWidth(col) + singleDelta);
      delta -= singleDelta;
    }
    myGrid.setColumnWidth(ListSequence.fromList(columnNumbers).last(), myGrid.getColumnWidth(ListSequence.fromList(columnNumbers).last()) + delta);
  }

  public void extendHeight(int ascent, int descent) {
    if (getRowSpan() == 1) {
      myGrid.extendRowHeight(myRow, ascent, descent);
    } else {
      myGrid.setAscent(getRowIndex(), Math.max(myGrid.getAscent(getRowIndex()), ascent));

      int delta = (ascent + descent) - getHeight();
      if (delta > 0) {
        int singleDelta = delta / getRowSpan();
        for (int i = getRowIndex(); i < getMaxRowIndex(); i++) {
          myGrid.setDescent(i, myGrid.getDescent(i) + singleDelta);
          delta -= singleDelta;
        }
        myGrid.setDescent(getMaxRowIndex(), myGrid.getDescent(getMaxRowIndex()) + delta);
      }
    }
  }

  public int getWidth() {
    int width = 0;
    for (int i = getColumnIndex(); i <= getMaxColumnIndex(); i++) {
      width += myGrid.getColumnWidth(i);
    }
    return width;
  }

  public int getHeight() {
    int height = 0;
    for (int i = getRowIndex(); i <= getMaxRowIndex(); i++) {
      height += myGrid.getRowHeight(i);
    }
    return height;
  }

  public int getPosX() {
    return myGrid.getColumnPosX(myColumn);
  }

  public int getPosY() {
    return myGrid.getRowPosY(myRow);
  }

  public Size getSize() {
    return new Size(getWidth(), getHeight());
  }

  public int getColumnIndex() {
    return myColumn;
  }

  public int getRowIndex() {
    return myRow;
  }

  public int getMaxColumnIndex() {
    return myColumn + myColumnSpan - 1;
  }

  public int getMaxRowIndex() {
    return myRow + myRowSpan - 1;
  }

  public int getColumnSpan() {
    return myColumnSpan;
  }

  public void setColumnSpan(int columnSpan) {
    if (columnSpan < 1) {
      throw new IllegalArgumentException("columnSpan < 1: " + columnSpan);
    }
    myColumnSpan = columnSpan;
  }

  public int getRowSpan() {
    return myRowSpan;
  }

  public void setRowSpan(int rowSpan) {
    if (rowSpan < 1) {
      throw new IllegalArgumentException("rowSpan < 1: " + rowSpan);
    }
    myRowSpan = rowSpan;
  }
}
