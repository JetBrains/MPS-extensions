package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import org.eclipse.elk.alg.radial.options.AnnulusWedgeCriteria;
import org.eclipse.elk.alg.radial.options.CompactionStrategy;
import org.eclipse.elk.alg.radial.options.SortingStrategy;
import org.eclipse.elk.alg.radial.options.RadialTranslationStrategy;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.eclipse.elk.alg.radial.options.RadialOptions;
import org.eclipse.elk.core.data.LayoutMetaDataService;
import org.eclipse.elk.alg.radial.options.RadialMetaDataProvider;
import org.eclipse.elk.graph.ElkNode;
import org.eclipse.elk.core.util.IElkProgressMonitor;
import de.itemis.mps.editor.diagram.runtime.model.IAccessorKey;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;

public class RadialLayouter extends ElkLayouter {
  protected boolean additionalWedgeSpace;
  protected AnnulusWedgeCriteria wedgeCriteria;
  protected boolean centerOnRoot;
  protected CompactionStrategy compactor;
  protected int compactionStepSize;
  protected double nodeSpacing;
  protected boolean omitNodeMicroLayout;
  protected boolean outgoingEdgeAngles;
  protected double radius;
  protected boolean rotate;
  protected SortingStrategy sorter;
  protected double targetAngle;
  protected RadialTranslationStrategy optimizationCriteria;

  protected Map<Object, Integer> myOrderIDs = MapSequence.fromMap(new HashMap<Object, Integer>());

  public RadialLayouter() {
    super();
    myAlgorithm = RadialOptions.ALGORITHM_ID;
  }

  static {
    LayoutMetaDataService.getInstance().registerLayoutMetaDataProviders(new RadialMetaDataProvider());
  }

  @Override
  public boolean canLayoutLabels() {
    return true;
  }
  @Override
  protected boolean useDummyPort(EdgeDCell edge, boolean isTarget) {
    return false;
  }

  @Override
  protected void addLayoutInformationToGraph(ElkNode graph, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToGraph(graph, progressMonitor);
    ElkNode layout = graph;

    layout.setProperty(RadialOptions.ROTATION_COMPUTE_ADDITIONAL_WEDGE_SPACE, additionalWedgeSpace);
    layout.setProperty(RadialOptions.WEDGE_CRITERIA, wedgeCriteria);
    layout.setProperty(RadialOptions.CENTER_ON_ROOT, centerOnRoot);
    layout.setProperty(RadialOptions.COMPACTOR, compactor);
    layout.setProperty(RadialOptions.COMPACTION_STEP_SIZE, compactionStepSize);
    layout.setProperty(RadialOptions.SPACING_NODE_NODE, nodeSpacing);
    layout.setProperty(RadialOptions.OMIT_NODE_MICRO_LAYOUT, omitNodeMicroLayout);
    layout.setProperty(RadialOptions.ROTATION_OUTGOING_EDGE_ANGLES, outgoingEdgeAngles);
    layout.setProperty(RadialOptions.RADIUS, radius);
    layout.setProperty(RadialOptions.ROTATE, rotate);
    layout.setProperty(RadialOptions.SORTER, sorter);
    layout.setProperty(RadialOptions.ROTATION_TARGET_ANGLE, targetAngle);
    layout.setProperty(RadialOptions.OPTIMIZATION_CRITERIA, optimizationCriteria);

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(layout, "graph", progressMonitor);
    }
  }

  @Override
  protected void addLayoutInformationToNode(ElkNode knode, BoxDCell box, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToNode(knode, box, progressMonitor);
    IAccessorKey ID = box.getBox().getAccessor().getId();
    Integer orderID = MapSequence.fromMap(this.myOrderIDs).get(ID);
    if (orderID != null) {
      knode.setProperty(RadialOptions.ORDER_ID, orderID);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(knode, "node", progressMonitor);
    }
  }

  @Override
  public void setParentsStyle(Style style) {
    super.setParentsStyle(style);
    this.additionalWedgeSpace = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-additional-wedge-space"));
    this.wedgeCriteria = style.get(StyleAttributes.getInstance().<AnnulusWedgeCriteria>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-annulus-wedge-criteria"));
    this.centerOnRoot = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-center-on-root"));
    this.compactor = style.get(StyleAttributes.getInstance().<CompactionStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-compaction"));
    this.compactionStepSize = style.get(StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-compaction-step-size"));
    this.nodeSpacing = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-node-spacing"));
    this.omitNodeMicroLayout = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-omit-node-micro-layout"));
    this.outgoingEdgeAngles = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-outgoing-edge-angles"));
    this.radius = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-radius"));
    this.rotate = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-rotate"));
    this.sorter = style.get(StyleAttributes.getInstance().<SortingStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-sorter"));
    this.targetAngle = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-target-angle"));
    this.optimizationCriteria = style.get(StyleAttributes.getInstance().<RadialTranslationStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-translation-optimization"));
  }

  @Override
  public void addNodesStyle(Style style, Object key) {
    super.addNodesStyle(style, key);
    MapSequence.fromMap(this.myOrderIDs).put(key, style.get(StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-radial-orderId")));
  }
}
