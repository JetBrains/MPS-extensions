package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import org.eclipse.elk.core.options.Direction;
import org.eclipse.elk.alg.mrtree.options.EdgeRoutingMode;
import org.eclipse.elk.alg.mrtree.options.TreeifyingOrder;
import org.eclipse.elk.alg.mrtree.options.OrderWeighting;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import java.util.Queue;
import jetbrains.mps.internal.collections.runtime.QueueSequence;
import java.util.LinkedList;
import org.eclipse.elk.alg.mrtree.options.MrTreeOptions;
import org.eclipse.elk.core.data.LayoutMetaDataService;
import org.eclipse.elk.alg.mrtree.options.MrTreeMetaDataProvider;
import org.eclipse.elk.graph.ElkNode;
import org.eclipse.elk.core.util.IElkProgressMonitor;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import org.eclipse.elk.core.math.ElkPadding;
import de.itemis.mps.editor.diagram.runtime.model.IAccessorKey;

public class TreeLayouter extends ElkLayouterWithTopDownPackingSupport {
  protected Double aspectRatio;
  protected Direction direction;
  protected double edgeEndTextureLength;
  protected double edgeNodeSpacing;
  protected EdgeRoutingMode edgeRoutingMode;
  protected boolean fixedGraphSize;
  protected double nodeSpacing;
  protected boolean omitNodeMicroLayout;
  protected TreeifyingOrder searchOrder;
  protected Boolean separateConnectedComponents;
  protected double topdownScaleFactor;
  protected OrderWeighting weighting;

  protected Map<Object, Integer> myPositionConstraints = MapSequence.fromMap(new HashMap<Object, Integer>());
  protected Queue<Integer> myTreeLevels = QueueSequence.fromQueue(new LinkedList<Integer>());

  public TreeLayouter() {
    super();
    myAlgorithm = MrTreeOptions.ALGORITHM_ID;
  }

  static {
    LayoutMetaDataService.getInstance().registerLayoutMetaDataProviders(new MrTreeMetaDataProvider());
  }

  @Override
  public boolean canLayoutLabels() {
    return false;
  }

  @Override
  protected void addLayoutInformationToGraph(ElkNode graph, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToGraph(graph, progressMonitor);
    ElkNode layout = graph;
    if (aspectRatio != null) {
      layout.setProperty(MrTreeOptions.ASPECT_RATIO, aspectRatio);
    }
    layout.setProperty(MrTreeOptions.DIRECTION, direction);
    layout.setProperty(MrTreeOptions.EDGE_END_TEXTURE_LENGTH, edgeEndTextureLength);
    layout.setProperty(MrTreeOptions.SPACING_EDGE_NODE, edgeNodeSpacing);
    layout.setProperty(MrTreeOptions.EDGE_ROUTING_MODE, edgeRoutingMode);
    layout.setProperty(MrTreeOptions.NODE_SIZE_FIXED_GRAPH_SIZE, fixedGraphSize);
    layout.setProperty(MrTreeOptions.SPACING_NODE_NODE, nodeSpacing);
    layout.setProperty(MrTreeOptions.OMIT_NODE_MICRO_LAYOUT, omitNodeMicroLayout);
    layout.setProperty(MrTreeOptions.SEARCH_ORDER, searchOrder);
    if (separateConnectedComponents != null) {

    }
    layout.setProperty(MrTreeOptions.SEPARATE_CONNECTED_COMPONENTS, separateConnectedComponents);
    layout.setProperty(MrTreeOptions.TOPDOWN_SCALE_FACTOR, topdownScaleFactor);
    layout.setProperty(MrTreeOptions.WEIGHTING, weighting);

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(layout, "graph", progressMonitor);
    }
  }

  @Override
  public void setParentsStyle(Style style) {
    super.setParentsStyle(style);
    if (style.isSpecified(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-aspect-ratio"))) {
      this.aspectRatio = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-aspect-ratio"));
    }
    this.direction = style.get(StyleAttributes.getInstance().<Direction>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-direction"));
    this.edgeEndTextureLength = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-tree-edge-end-texture-length"));
    this.edgeNodeSpacing = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-edge-node-spacing"));
    this.edgeRoutingMode = style.get(StyleAttributes.getInstance().<EdgeRoutingMode>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-tree-edge-routing-mode"));
    this.fixedGraphSize = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-fixed-graph-size"));
    this.nodeSpacing = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-node-spacing"));
    this.omitNodeMicroLayout = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-omit-node-micro-layout"));
    this.padding = style.get(StyleAttributes.getInstance().<ElkPadding>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-padding"));
    this.searchOrder = style.get(StyleAttributes.getInstance().<TreeifyingOrder>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-tree-search-order"));
    if (style.isSpecified(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-separate-connected-components"))) {
      this.separateConnectedComponents = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-separate-connected-components"));
    }
    this.topdownScaleFactor = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-topdown-scale-factor"));
    this.weighting = style.get(StyleAttributes.getInstance().<OrderWeighting>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-tree-weighting"));
  }

  @Override
  protected void addLayoutInformationToNode(ElkNode knode, BoxDCell box, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToNode(knode, box, progressMonitor);
    IAccessorKey ID = box.getBox().getAccessor().getId();
    Integer positionConstraint = MapSequence.fromMap(myPositionConstraints).get(ID);
    if (positionConstraint != null) {
      knode.setProperty(MrTreeOptions.POSITION_CONSTRAINT, positionConstraint);
    }

    Integer treeLevel = QueueSequence.fromQueue(myTreeLevels).removeFirstElement();
    if (treeLevel != null) {
      knode.setProperty(MrTreeOptions.TREE_LEVEL, treeLevel);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(knode, "node", progressMonitor);
    }
  }

  @Override
  public void addNodesStyle(Style style, Object key) {
    super.addNodesStyle(style, key);
    MapSequence.fromMap(myPositionConstraints).put(key, style.get(StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-tree-position-constraint")));
    QueueSequence.fromQueue(myTreeLevels).addLastElement(style.get(StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-tree-level")));
  }
}
