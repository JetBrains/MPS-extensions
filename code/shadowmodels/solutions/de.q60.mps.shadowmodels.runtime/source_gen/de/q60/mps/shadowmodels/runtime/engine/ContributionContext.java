package de.q60.mps.shadowmodels.runtime.engine;

/*Generated by MPS */

import org.modelix.model.api.IConcept;
import de.q60.mps.logging.runtime.ShadowLogging;

public class ContributionContext extends RootBuilderContext implements IBuilderContext {

  public ContributionContext(ContainmentTargetRootNodes<TransformationCall> call, TransformationResult result1) {
    super(call, result1);
  }

  @Override
  public IBuilderContext createNode(final IConcept concept, IBuilderContext topmost) {
    if (topmost.getParameter(BuilderContextParameter.LOCAL_LABEL) != null) {
      throw new UnsupportedOperationException("Label not supported in contributions for the root node");
    }
    IResultElement rootElement = result.getFirstRootElement(Integer.parseInt(topmost.getParameter(BuilderContextParameter.ROLE)));
    if (!(rootElement.getConcept().isSubConceptOf(concept))) {
      throw new RuntimeException(rootElement.getConcept() + " is not a subconcept of " + concept);
    }
    if (rootElement.getTransformationResult() != result) {
      RuntimeException ex = new RuntimeException("Attempt to contribute to a transformation whose root is a transformation call");
      ShadowLogging.logError(ex, call, result, rootElement.getTransformationResult());
      throw ex;
    }
    return new ResultElementContext(this, rootElement) {
      @Override
      public IBuilderContext createNode(IConcept childConcept, IBuilderContext topmost) {
        String role = topmost.getParameter(BuilderContextParameter.ROLE);
        if (!(concept.getChildLink(role).isMultiple())) {
          element.clearChildren(role);
        }
        return super.createNode(childConcept, topmost);
      }
    };
  }

  @Override
  public void createNode(IContainmentTarget problem, IBuilderContext topmost) {
    throw new UnsupportedOperationException("Not allowed in contributions");
  }
}
