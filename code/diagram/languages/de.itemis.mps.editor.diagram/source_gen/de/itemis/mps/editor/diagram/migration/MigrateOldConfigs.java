package de.itemis.mps.editor.diagram.migration;

/*Generated by MPS */

import jetbrains.mps.lang.migration.runtime.base.MigrationScriptBase;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.List;
import org.jetbrains.mps.openapi.language.SProperty;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.Objects;
import jetbrains.mps.lang.migration.runtime.base.MigrationScriptReference;
import org.jetbrains.mps.openapi.language.SConcept;

public class MigrateOldConfigs extends MigrationScriptBase {
  private final String description = "MigrateOldConfigs";
  public String getCaption() {
    return description;
  }
  @Override
  public boolean isRerunnable() {
    return true;
  }
  public SNode execute(final SModule m) {
    doExecute(m);
    return null;
  }
  public void doExecute(final SModule m) {
    for (SModel smodel : Sequence.fromIterable(m.getModels())) {
      SModel model = ((SModel) smodel);
      ListSequence.fromList(SModelOperations.nodes(model, CONCEPTS.DiagramLayoutConfig$Y0)).visitAll((it) -> {
        if ((SNodeOperations.getNodeAncestor(it, CONCEPTS.LayeredLayoutAlgorithm$pk, false, false) != null)) {
          SNode newConfig = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xfa13cc63c4764d46L, 0x9c96d53670abe7bcL, 0x2e440a78c2836defL, "de.itemis.mps.editor.diagram.structure.LayeredLayoutConfig"));
          SPropertyOperations.assignEnum(newConfig, PROPS.hierarchyHandling$PAbb, SPropertyOperations.getEnum(it, PROPS.hierarchyHandlingOld$EqTV));
          SPropertyOperations.assignEnum(newConfig, PROPS.edgeRouting$n5ng, SPropertyOperations.getEnum(it, PROPS.edgeRoutingOld$NRI4));
          SNodeOperations.replaceWithAnother(it, newConfig);
        } else {
          SNodeOperations.deleteNode(it);
        }
      });
      ListSequence.fromList(SModelOperations.nodes(model, CONCEPTS.LayeredLayoutConfig$Xm)).visitAll((it) -> {
        List<SProperty> properties = ListSequence.fromListWithValues(new ArrayList<SProperty>(), it.getProperties());
        SProperty edgeRoutingOldProperty = ListSequence.fromList(properties).findFirst(new _FunctionTypes._return_P1_E0<Boolean, SProperty>() {
          public Boolean invoke(SProperty it) {
            return Objects.equals(it.getName(), PROPS.edgeRoutingOld$NRI4);
          }
        });
        SProperty hierarchyHandlingOldProperty = ListSequence.fromList(properties).findFirst(new _FunctionTypes._return_P1_E0<Boolean, SProperty>() {
          public Boolean invoke(SProperty it) {
            return Objects.equals(it.getName(), PROPS.hierarchyHandlingOld$EqTV);
          }
        });
        String edgeRoutingOld = (edgeRoutingOldProperty != null ? it.getProperty(edgeRoutingOldProperty) : null);
        String hierarchHandlingOld = (hierarchyHandlingOldProperty != null ? it.getProperty(hierarchyHandlingOldProperty) : null);
        boolean needsReplacement = edgeRoutingOld != null || hierarchHandlingOld != null;

        SNode config = (needsReplacement ? SNodeOperations.replaceWithNewChild(it, CONCEPTS.LayeredLayoutConfig$Xm) : it);
        if (edgeRoutingOld != null) {
          config.setProperty(PROPS.edgeRouting$n5ng, edgeRoutingOld);
        }
        if (hierarchHandlingOld != null) {
          config.setProperty(PROPS.hierarchyHandling$PAbb, hierarchHandlingOld);
        }
      });

    }
  }
  public MigrationScriptReference getReference() {
    return new MigrationScriptReference(MetaAdapterFactory.getLanguage(0xfa13cc63c4764d46L, 0x9c96d53670abe7bcL, "de.itemis.mps.editor.diagram"), 0);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept DiagramLayoutConfig$Y0 = MetaAdapterFactory.getConcept(0xfa13cc63c4764d46L, 0x9c96d53670abe7bcL, 0x1ca65386c517d77bL, "de.itemis.mps.editor.diagram.structure.DiagramLayoutConfig");
    /*package*/ static final SConcept LayeredLayoutAlgorithm$pk = MetaAdapterFactory.getConcept(0xfa13cc63c4764d46L, 0x9c96d53670abe7bcL, 0x7508d7ca762c219cL, "de.itemis.mps.editor.diagram.structure.LayeredLayoutAlgorithm");
    /*package*/ static final SConcept LayeredLayoutConfig$Xm = MetaAdapterFactory.getConcept(0xfa13cc63c4764d46L, 0x9c96d53670abe7bcL, 0x2e440a78c2836defL, "de.itemis.mps.editor.diagram.structure.LayeredLayoutConfig");
  }

  private static final class PROPS {
    /*package*/ static final SProperty hierarchyHandling$PAbb = MetaAdapterFactory.getProperty(0xfa13cc63c4764d46L, 0x9c96d53670abe7bcL, 0x2e440a78c2836defL, 0x152fc8e2adc2509bL, "hierarchyHandling");
    /*package*/ static final SProperty hierarchyHandlingOld$EqTV = MetaAdapterFactory.getProperty(0xfa13cc63c4764d46L, 0x9c96d53670abe7bcL, 0x1ca65386c517d77bL, 0x2a088652836f372fL, "hierarchyHandlingOld");
    /*package*/ static final SProperty edgeRouting$n5ng = MetaAdapterFactory.getProperty(0xfa13cc63c4764d46L, 0x9c96d53670abe7bcL, 0x2e440a78c2836defL, 0x152fc8e2adc25938L, "edgeRouting");
    /*package*/ static final SProperty edgeRoutingOld$NRI4 = MetaAdapterFactory.getProperty(0xfa13cc63c4764d46L, 0x9c96d53670abe7bcL, 0x1ca65386c517d77bL, 0x2e440a78c2259dddL, "edgeRoutingOld");
  }
}
