package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import de.itemis.mps.editor.diagram.runtime.model.SerializableObjectHolder;
import de.itemis.mps.editor.diagram.runtime.model.Edge;
import java.util.Map;
import de.itemis.mps.editor.diagram.runtime.model.EdgeLabelType;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import java.util.List;
import com.mxgraph.shape.mxIShape;
import com.mxgraph.model.mxGeometry;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.annotations.Nullable;
import java.util.Collections;
import com.mxgraph.canvas.mxGraphics2DCanvas;
import com.mxgraph.view.mxCellState;
import java.awt.Graphics2D;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.intellij.ui.JBColor;
import java.awt.BasicStroke;
import de.itemis.mps.editor.diagram.runtime.model.RelativePosition;
import java.awt.geom.Line2D;
import com.mxgraph.view.mxGraphView;
import de.itemis.mps.editor.diagram.runtime.model.Bounds;
import de.itemis.mps.editor.diagram.runtime.model.Point;
import de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods;
import de.itemis.mps.editor.diagram.runtime.EditorUtil;
import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.nodeEditor.messageTargets.EditorMessageWithTarget;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import de.itemis.mps.editor.diagram.runtime.model.IDiagramElement;

public class EdgeDCell extends BaseDCell implements ISelfPaintingCell, IMPSCellContainer, IDiagramDCell {
  private static final boolean DEBUG = false;

  private SerializableObjectHolder<Edge> myEdge;
  private Map<EdgeLabelType, LabelDCell> myLabelCells = MapSequence.fromMap(new HashMap<EdgeLabelType, LabelDCell>());
  private List<MPSCell> myMPSCells;
  private SerializableObjectHolder<mxIShape> myShape = new SerializableObjectHolder(new MyConnectorShape());

  public EdgeDCell(MyGraph graph) {
    super(null, new mxGeometry(), "", graph);
    setEdge(true);
    this.getGeometry().setRelative(true);
  }

  public boolean isVisible() {
    if (myEdge != null) {
      return check_i7j1ms_a0a0a9(myEdge.get());
    }
    return true;
  }

  public boolean isCurved() {
    return check_i7j1ms_a0a11(check_i7j1ms_a0a0l(myEdge));
  }

  public List<LabelDCell> getAllLabelCells() {
    return Sequence.fromIterable(MapSequence.fromMap(myLabelCells).values()).toList();
  }

  @Nullable
  public LabelDCell getLabelCell(EdgeLabelType type) {
    return MapSequence.fromMap(myLabelCells).get(type);
  }

  public void setLabelCell(EdgeLabelType type, LabelDCell cell) {
    MapSequence.fromMap(myLabelCells).put(type, cell);
  }

  public void setEdge(Edge edge) {
    myEdge = new SerializableObjectHolder<Edge>(edge);
    myMPSCells = Collections.emptyList();
  }

  @Nullable
  public Edge getEdge() {
    return check_i7j1ms_a0a12(myEdge);
  }

  @Override
  public boolean canPaintSelf(mxGraphics2DCanvas canvas, mxCellState state) {
    return true;
  }

  @Override
  public boolean doesAdditionalPaintingOnly() {
    return true;
  }

  @Override
  public void paintBackground(Graphics2D g, mxGraphics2DCanvas canvas, mxCellState state) {
  }
  @Override
  public void paintForeground(Graphics2D g, mxGraphics2DCanvas canvas, mxCellState state) {
    for (MPSCell mpsCell : ListSequence.fromList(myMPSCells)) {
      mpsCell.paint(g, state);
    }
  }
  @Override
  public void paintTop(Graphics2D g, mxGraphics2DCanvas canvas, mxCellState state) {
    if (DEBUG) {
      double scale = state.getView().getScale();
      g.setColor(JBColor.BLACK);
      g.setStroke(new BasicStroke(1.0f));
      for (EdgeLabelType type : EdgeLabelType.values()) {
        RelativePosition relPos = getEdge().getLabelPosition(type);
        if (relPos == null) {
          continue;
        }
        g.draw(new Line2D.Double(relPos.getReferencePoint().getX(), relPos.getReferencePoint().getY(), relPos.getAbsolutePoint(scale).getX(), relPos.getAbsolutePoint(scale).getY()));
      }
    }
  }

  @Override
  public List<MPSCell> getMPSCells() {
    return myMPSCells;
  }

  @Override
  public void updateMPSCellPositions(mxGraphView view, mxCellState state) {
    if (state.getAbsolutePointCount() == 0) {
      return;
    }
    Edge edge = getEdge();

    if (edge == null) {
      return;
    }

    for (EdgeLabelType type : EdgeLabelType.values()) {
      MPSCell mpsCell = getMPSCell(type);
      if (check_i7j1ms_a0b0f0hb(mpsCell) == null) {
        continue;
      }

      RelativePosition labelPosition = edge.getLabelPosition(type);
      if (labelPosition == null) {
        Bounds sourceBounds = CellExtensions.getBounds(this.source);
        Bounds targetBounds = CellExtensions.getBounds(this.target);
        double x = (sourceBounds.getCenterX() + targetBounds.getCenterX()) / 2;
        double y = (sourceBounds.getCenterY() + targetBounds.getCenterY()) / 2;
        labelPosition = new RelativePosition(new Point(0, 0), new Point(x, y));
      }
      Bounds bounds = CellExtensions.getBounds(getLabelCell(type));
      double newX = labelPosition.getAbsolutePoint().getX();
      double newY = labelPosition.getAbsolutePoint().getY();
      if (!(ExtensionMethods.isNear(newX, bounds.getX())) || !(ExtensionMethods.isNear(newY, bounds.getY()))) {
        CellExtensions.setPosition(getLabelCell(type), newX, newY);
        mxCellState labelState = view.getState(getLabelCell(type), true);
        if (labelState != null) {
          labelState.setInvalid(true);
          view.validateCell(labelState);
        }
      }
    }

    EditorUtil.updateBounds(((EditorCell_Collection) edge.getRootCell()));
  }

  public MPSCell getMPSCell(EdgeLabelType type) {
    List<MPSCell> l = check_i7j1ms_a0a0jb(getLabelCell(type), this);
    return ListSequence.fromList(l).first();
  }

  @Override
  @Nullable
  public EditorCell getBigCell() {
    return check_i7j1ms_a0a73(getEdge(), this);
  }

  @Override
  public mxIShape getShape() {
    return myShape.get();
  }

  @Nullable
  @Override
  public Tuples._2<Double, Double> getRequiredSize() {
    return null;
  }

  @Override
  public boolean allowScaling() {
    return false;
  }

  @Override
  public String getTooltipText() {
    EditorCell ecell = getEdge().getRootCell();
    EditorComponent editorComponent = (EditorComponent) ecell.getEditorComponent();
    List<EditorMessageWithTarget> list = ((List<EditorMessageWithTarget>) ReflectionUtil.callMethod(EditorComponent.class, editorComponent, "getEditorMessagesFor", new Class[]{EditorCell.class}, new Object[]{ecell}));
    String messages = IterableUtils.join(ListSequence.fromList(list).select((it) -> it.getMessage()).where((it) -> (it != null && it.length() > 0)), "\n");
    return messages;
  }

  @Nullable
  public IDiagramElement getDiagramElement() {
    return getEdge();
  }

  @Override
  public boolean canDrop(Object data) {
    return getEdge().canDrop(data);
  }

  @Override
  public void drop(Object data) {
    getEdge().drop(data);
  }
  private static boolean check_i7j1ms_a0a0a9(Edge checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.isVisible();
    }
    return false;
  }
  private static boolean check_i7j1ms_a0a11(Edge checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.isCurved();
    }
    return false;
  }
  private static Edge check_i7j1ms_a0a0l(SerializableObjectHolder<Edge> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static Edge check_i7j1ms_a0a12(SerializableObjectHolder<Edge> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static EditorCell check_i7j1ms_a0b0f0hb(MPSCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getEditorCell();
    }
    return null;
  }
  private static List<MPSCell> check_i7j1ms_a0a0jb(LabelDCell checkedDotOperand, EdgeDCell checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getMPSCells();
    }
    return null;
  }
  private static EditorCell check_i7j1ms_a0a73(Edge checkedDotOperand, EdgeDCell checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getRootCell();
    }
    return null;
  }
}
