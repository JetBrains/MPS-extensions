package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import de.itemis.mps.editor.collapsible.runtime.CollapsibleContext;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.openapi.editor.EditorContext;

/**
 * 
 * @deprecated  Use DiagramContext
 */
@Deprecated
public class DiagramCreationContext {
  private static int diagramLevel = 0;
  private static MyGraph rootGraph;

  public static boolean isSubdiagram() {
    return diagramLevel > 1;
  }

  public static void createDiagram(final _FunctionTypes._void_P0_E0 creator) {
    if (diagramLevel == 1 && rootGraph == null) {
      throw new IllegalStateException("The root graph is not set. Cannot enter a sub diagram context.");
    }

    if (diagramLevel > 0) {
      createDiagram_(creator);
    } else {
      CollapsibleContext.withFactory(new DiagramCollapsibleFactory(), () -> createDiagram_(creator));
    }
  }

  public static void ensureInContext(final MyGraph rootGraph, final _FunctionTypes._void_P0_E0 creator) {
    if (isCreatingDiagram()) {
      creator.invoke();
    } else {
      createDiagram(() -> {
        setRootGraph(rootGraph);
        creator.invoke();
      });
    }
  }

  protected static void createDiagram_(_FunctionTypes._void_P0_E0 creator) {
    diagramLevel++;
    try {
      creator.invoke();
    } finally {
      diagramLevel--;
      if (diagramLevel == 0) {
        rootGraph = null;
      }
    }
  }

  public static EditorCell createNodeCell(final SNode snode, final EditorContext editorContext) {
    if (diagramLevel <= 0) {
      throw new RuntimeException("Not inside diagram creation context");
    }
    EditorCell result = editorContext.getEditorComponent().getUpdater().getCurrentUpdateSession().updateChildNodeCell(snode);
    return result;
  }

  public static void setRootGraph(MyGraph graph) {
    if (diagramLevel != 1) {
      throw new IllegalStateException("You can set the root graph only on the root level");
    }
    rootGraph = graph;
  }

  public static MyGraph getRootGraph() {
    return rootGraph;
  }

  public static boolean isCreatingDiagram() {
    return diagramLevel > 0;
  }
}
