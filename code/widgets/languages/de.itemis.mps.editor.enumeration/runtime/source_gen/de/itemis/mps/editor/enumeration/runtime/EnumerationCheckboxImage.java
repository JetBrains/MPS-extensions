package de.itemis.mps.editor.enumeration.runtime;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.awt.Image;
import org.jetbrains.mps.openapi.model.SNode;
import java.awt.image.ImageObserver;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.util.MacrosFactory;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import java.net.URL;
import jetbrains.mps.smodel.language.LanguageRegistry;
import java.util.stream.Stream;
import java.awt.Toolkit;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.project.AbstractModule;
import java.net.MalformedURLException;

public class EnumerationCheckboxImage {
  private static final Logger LOG = Logger.getLogger(EnumerationCheckboxImage.class);
  private Image image;
  private double scale;
  private String next;
  private String state;

  public EnumerationCheckboxImage(String path, double scale, String state, String next, SNode node) {
    image = loadImage(path, node);
    this.scale = scale;
    this.state = state;
    this.next = next;
  }
  public String getNext() {
    return next;
  }
  public String getState() {
    return state;
  }
  public Image getImage() {
    return image;
  }
  public double getScale() {
    return scale;
  }
  public double getWidth(ImageObserver o) {
    double result = image.getWidth(o);
    return result;
  }
  public double getHeight(ImageObserver o) {
    return image.getHeight(o);
  }

  private Image loadImage(String fileName, SNode node) {
    if (fileName == null) {
      return null;
    }

    SModule module = SNodeOperations.getConcept(node).getLanguage().getSourceModule();
    if (module == null) {
      return null;
    }

    if (fileName.startsWith(MacrosFactory.MODULE)) {
      // in case of module local path, use module runtime / classloader mechanism to load the image 
      // NOTE: using MacrosFactory for resolving ${module} is not viable anymore, since for deployed modules it returns src.jar location that doesn't not contain copied resources (like icons)
      final String filePathInModule = fileName.substring(MacrosFactory.MODULE.length() + 1);

      final Wrappers._T<URL> resourceURL = new Wrappers._T<URL>();
      LanguageRegistry.getInstance(SNodeOperations.getModel(node).getRepository()).withModuleRuntime(Stream.of(module.getModuleReference()), (mr) -> resourceURL.value = mr.getModuleClassLoader().getResource(filePathInModule));
      if (resourceURL.value != null) {
        return Toolkit.getDefaultToolkit().getImage(resourceURL.value);
      }
    }

    fileName = MacrosFactory.forModule(module).expandPath(fileName);
    IFile imageFile = ((AbstractModule) module).getFileSystem().findExistingFile(fileName);
    if (imageFile.exists()) {
      try {
        return Toolkit.getDefaultToolkit().getImage(imageFile.getUrl());
      } catch (MalformedURLException e) {
        if (LOG.isErrorLevel()) {
          LOG.error("Failed to load enum checkbox image", e);
        }
      }
    }
    return null;
  }


}
