package de.slisson.mps.tables.runtime.util;

/*Generated by MPS */

import java.util.Map;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.model.SNodeChangeListener;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.WeakHashMap;
import org.jetbrains.mps.openapi.model.EditableSModel;
import java.util.HashMap;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;

public class ModelChangeManager {
  private static ModelChangeManager INSTANCE = new ModelChangeManager();

  public static ModelChangeManager instance() {
    return INSTANCE;
  }

  private Map<SModel, Map<Object, SNodeChangeListener>> modelListeners = MapSequence.fromMap(new WeakHashMap<SModel, Map<Object, SNodeChangeListener>>());

  private void addListener(EditableSModel model, Object uniquenessKey, SNodeChangeListener listener) {
    Map<Object, SNodeChangeListener> keyedListeners = MapSequence.fromMap(modelListeners).get(model);
    if (keyedListeners == null) {
      keyedListeners = MapSequence.fromMap(new HashMap<Object, SNodeChangeListener>());
      MapSequence.fromMap(modelListeners).put(model, keyedListeners);
    }

    SNodeChangeListener existingListener = MapSequence.fromMap(keyedListeners).get(uniquenessKey);
    if (existingListener != null) {
      model.removeChangeListener(existingListener);
    }
    model.addChangeListener(listener);
    MapSequence.fromMap(keyedListeners).put(uniquenessKey, listener);
  }

  private void listenToModel(SNode node, Object uniquenessKey, SNodeChangeListener listener) {
    SModel model = SNodeOperations.getModel(node);
    if (!(model instanceof EditableSModel)) {
      return;
    }
    EditableSModel editableModel = ((EditableSModel) model);
    addListener(editableModel, uniquenessKey, listener);
  }

  public void setNodeDeletionListener(final SNode deletableNode, Object uniquenessKey, final _FunctionTypes._void_P1_E0<? super SNode> listener) {
    listenToModel(deletableNode, uniquenessKey, new NodeDeletionListener(deletableNode) {
      public void nodeDeleted(SNode deletedNode) {
        listener.invoke(deletedNode);
      }
    });
  }
}
