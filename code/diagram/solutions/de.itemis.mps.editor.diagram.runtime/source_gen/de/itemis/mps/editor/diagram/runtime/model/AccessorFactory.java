package de.itemis.mps.editor.diagram.runtime.model;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.EditorComponent;
import org.jetbrains.annotations.NotNull;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import de.itemis.mps.editor.diagram.runtime.jgraph.DiagramCreationContext;
import de.itemis.mps.editor.diagram.runtime.DiagramUtil;
import de.slisson.mps.hacks.editor.EditorCacheHacks;
import de.slisson.mps.hacks.editor.DummyReferenceLink;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import jetbrains.mps.nodeEditor.cellLayout.CellLayout_Vertical;
import org.jetbrains.annotations.Nullable;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.Sequence;

/**
 * Creates the various model access objects to present them in a diagram
 */
public class AccessorFactory implements IAccessorFactory {

  private EditorComponent myEditorComponent;
  private DiagramModel myModel;

  public AccessorFactory(EditorComponent editorComponent, DiagramModel model) {
    myEditorComponent = editorComponent;
    myModel = model;
  }

  /**
   * Turn a MPS node into a diagram accessor --> forwards to fromSNode function, assuming that the call need not be duplicates safe
   * 
   * @param node to be visualized in a diagram
   * @return an element accessor that visualizes the node
   */
  @NotNull
  public List<IDiagramElementAccessor> fromSNode(SNode node) {
    return fromSNode(node, false);
  }

  /**
   * Translate a node into a diagram accessor for visualization
   * 
   * @param node to be visualized in a diagram
   * @param duplicatesSafe TODO
   * @return an element accessor that visualizes the node
   */
  @NotNull
  @Override
  public List<IDiagramElementAccessor> fromSNode(@NotNull final SNode node, final boolean duplicatesSafe) {
    final Wrappers._T<EditorCell> cell = new Wrappers._T<EditorCell>(null);
    List<IDiagramElementAccessor> accessors = null;

    if (!(DiagramCreationContext.isCreatingDiagram())) {
      throw new IllegalStateException("Not in diagram creation context");
    }
    // require that we are currently updating the diagram
    DiagramUtil.checkInUpdateSession(myEditorComponent);

    // disable the cache for reading out the editor cell for the node
    EditorCacheHacks.noCaching(myEditorComponent.getEditorContext(), () -> {
      if (duplicatesSafe) {
        cell.value = myEditorComponent.getUpdater().getCurrentUpdateSession().updateReferencedNodeCell(() -> myEditorComponent.getUpdater().getCurrentUpdateSession().updateChildNodeCell(node), node, new DummyReferenceLink("Diagram" + System.identityHashCode(myModel)));
      } else {
        cell.value = myEditorComponent.getUpdater().getCurrentUpdateSession().updateChildNodeCell(node);
      }
    });
    accessors = collectAccessors(cell.value);

    if (ListSequence.fromList(accessors).isEmpty()) {
      ListSequence.fromList(accessors).addElement(new ArbitraryEditorAccessor(node, cell.value));
    } else {
      if (!(cell.value instanceof IAccessorProvider)) {
        IBoxAccessor boxAccessor = ListSequence.fromList(accessors).ofType(IBoxAccessor.class).first();

        // annotationExternal can be used to pull annotations
        // external --> separate box for annotation
        boolean external = boxAccessor == null || boxAccessor.annotationExternal(cell.value.getSNode());
        boolean isEdgeAccessor = ListSequence.fromList(accessors).first() instanceof SNodeEdgeAccessor;
        if (external) {
          if (isEdgeAccessor && as_q86kb5_a0a0a0g0a0a11a8(ListSequence.fromList(accessors).first(), SNodeEdgeAccessor.class).pullAnnotations()) {
            SNodeEdgeAccessor accessor = as_q86kb5_a0a0a0a6a0a0l0i(ListSequence.fromList(accessors).first(), SNodeEdgeAccessor.class);
            // if label undefined use parent as accessor.getRootCell
            EditorCell_Collection collection = new EditorCell_Collection(myEditorComponent.getEditorContext(), node, new CellLayout_Vertical());
            EditorCell labelCell = accessor.getLabelCell();
            jetbrains.mps.openapi.editor.cells.EditorCell_Collection parent;
            if (labelCell == null) {
              parent = as_q86kb5_a0a0a5a0a6a0a0l0i(accessor.getRootEditorCell(), EditorCell_Collection.class);
            } else {
              parent = labelCell.getParent();
            }
            parent.addEditorCellBefore(collection, labelCell);
            if (labelCell != null) {
              parent.removeCell(labelCell);
              collection.addEditorCell(labelCell);
              collection.addEditorCellBefore(cell.value, labelCell);
            } else {
              collection.addEditorCell(cell.value);
            }
            accessor.setLabelCell(collection);
          } else {
            AnnotationAccessor annotation = new AnnotationAccessor(cell.value.getSNode(), ListSequence.fromList(accessors).first().getId());
            annotation.setRootCell(cell.value);
            ListSequence.fromList(accessors).addElement(annotation);
          }
          for (IDiagramElementAccessor accessor : ListSequence.fromList(accessors)) {
            EditorCell wrappedCell = accessor.getRootEditorCell();
            check_q86kb5_a1a1a6a0a0l0i(as_q86kb5_a0a1a1a6a0a0l0i(wrappedCell.getParent(), EditorCell_Collection.class), wrappedCell);
          }
        } else {
          as_q86kb5_a0a0a0g0a0a11a8_0(ListSequence.fromList(accessors).first(), AbstractDiagramElementAccessor.class).setRootCell(cell.value);
        }
      }
    }

    return accessors;
  }

  @Nullable
  @Override
  public IEdgeAccessor edgeFromSNode(@NotNull SNode node) {
    List<IDiagramElementAccessor> fromSNode = fromSNode(node, false);
    return as_q86kb5_a0b0k(ListSequence.fromList(fromSNode).where((it) -> it instanceof IEdgeAccessor).first(), IEdgeAccessor.class);
  }
  @Nullable
  @Override
  public IBoxAccessor boxFromSNode(@NotNull SNode node) {
    List<IDiagramElementAccessor> fromSNode = fromSNode(node, false);
    return as_q86kb5_a0b0l(ListSequence.fromList(fromSNode).where((it) -> it instanceof IBoxAccessor).first(), IBoxAccessor.class);
  }

  protected List<IDiagramElementAccessor> collectAccessors(EditorCell cell) {
    List<IDiagramElementAccessor> result = new ArrayList<IDiagramElementAccessor>();
    collectAccessors(cell, result);
    return result;
  }

  protected void collectAccessors(final EditorCell rootCell, final List<IDiagramElementAccessor> result) {
    visitAccessorProviders(rootCell, (IAccessorProvider provider) -> {
      for (IDiagramElementAccessor a : provider.getAccessors(AccessorFactory.this)) {
        if (a instanceof AbstractDiagramElementAccessor && ((AbstractDiagramElementAccessor) a).getRootEditorCell() == null) {
          ((AbstractDiagramElementAccessor) a).setRootCell((provider instanceof EditorCell ? ((EditorCell) provider) : rootCell));
        }
        result.add(a);
      }

      for (IEndpointRedirect redirect : ListSequence.fromList(provider.getEndpointRedirects())) {
        myModel.addEndpointRedirect(redirect);
      }
    });
  }

  protected void visitAccessorProviders(EditorCell rootCell, _FunctionTypes._void_P1_E0<? super IAccessorProvider> visitor) {
    visitAccessorProviders(rootCell, rootCell, visitor);
  }

  protected void visitAccessorProviders(EditorCell cell, EditorCell rootCell, _FunctionTypes._void_P1_E0<? super IAccessorProvider> visitor) {
    if (cell instanceof IAccessorProvider) {
      IAccessorProvider provider = (IAccessorProvider) cell;
      visitor.invoke(provider);

    }
    if (cell instanceof jetbrains.mps.openapi.editor.cells.EditorCell_Collection && !(cell instanceof IDiagramCell)) {
      for (EditorCell child : Sequence.fromIterable((jetbrains.mps.openapi.editor.cells.EditorCell_Collection) cell)) {
        if (child instanceof IDiagramCell) {
          continue;
        }
        visitAccessorProviders(child, rootCell, visitor);
      }
    }
  }
  private static void check_q86kb5_a1a1a6a0a0l0i(EditorCell_Collection checkedDotOperand, EditorCell wrappedCell) {
    if (null != checkedDotOperand) {
      checkedDotOperand.removeCell(wrappedCell);
    }

  }
  private static <T> T as_q86kb5_a0a0a0a6a0a0l0i(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_q86kb5_a0a0a5a0a6a0a0l0i(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_q86kb5_a0a0a0g0a0a11a8(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_q86kb5_a0a1a1a6a0a0l0i(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_q86kb5_a0a0a0g0a0a11a8_0(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_q86kb5_a0b0k(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_q86kb5_a0b0l(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
