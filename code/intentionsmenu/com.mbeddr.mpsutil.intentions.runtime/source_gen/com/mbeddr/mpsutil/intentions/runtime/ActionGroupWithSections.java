package com.mbeddr.mpsutil.intentions.runtime;

/*Generated by MPS */

import com.intellij.openapi.actionSystem.DefaultActionGroup;
import org.jetbrains.annotations.NotNull;
import java.util.List;
import com.intellij.openapi.actionSystem.AnAction;
import com.intellij.openapi.actionSystem.AnActionEvent;
import com.intellij.openapi.actionSystem.UpdateSession;
import com.google.common.collect.TreeMultimap;
import java.util.Comparator;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.util.Map;
import java.util.Collection;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import com.intellij.openapi.actionSystem.Separator;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import com.intellij.openapi.actionSystem.Presentation;
import jetbrains.mps.intentions.icons.Icons;

/**
 * An action group that organizes its children into sections according to {@link com.mbeddr.mpsutil.intentions.runtime.ActionSection} 
 */
/*package*/ class ActionGroupWithSections extends DefaultActionGroup {

  @NotNull
  @Override
  public List<AnAction> postProcessVisibleChildren(@NotNull AnActionEvent e, @NotNull List<? extends AnAction> visibleChildren) {
    final UpdateSession updateSession = e.getUpdateSession();
    TreeMultimap<String, AnAction> actionsBySection = TreeMultimap.create(Comparator.<String>naturalOrder(), Comparator.comparing((AnAction action) -> updateSession.presentation(action).getText()));

    for (AnAction action : ListSequence.fromList(visibleChildren)) {
      String section = getSectionAndRemoveFromText(action, updateSession);
      setDefaultIntentionIcon(action, updateSession);
      actionsBySection.put(section, action);
    }

    List<AnAction> result = new ArrayList<>();
    for (Map.Entry<String, Collection<AnAction>> entry : SetSequence.fromSet(actionsBySection.asMap().entrySet())) {
      if (isNotEmptyString(entry.getKey())) {
        ListSequence.fromList(result).addElement(Separator.create(entry.getKey()));
      }

      ListSequence.fromList(result).addSequence(CollectionSequence.fromCollection(entry.getValue()));
    }

    return ListSequence.fromList(result).asUnmodifiable();
  }

  private static String getSectionAndRemoveFromText(AnAction action, UpdateSession session) {
    Presentation presentation = session.presentation(action);

    String section = ActionSection.getSection(presentation);
    if (section != null) {
      // If section was set, it means it was removed from the action already
      return section;
    }

    return ActionSection.setSectionAndText(presentation, presentation.getText());
  }

  private static void setDefaultIntentionIcon(AnAction action, UpdateSession session) {
    Presentation presentation = session.presentation(action);
    if (presentation.getIcon() == null) {
      presentation.setIcon(Icons.REAL_INTENTION);
    }
  }
  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }
}
