package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import java.util.List;
import de.itemis.mps.editor.diagram.runtime.model.IAccessorKey;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import de.itemis.mps.editor.diagram.runtime.model.IDiagramElement;
import de.itemis.mps.editor.diagram.runtime.model.DiagramModel;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Objects;
import de.itemis.mps.editor.diagram.runtime.model.IDiagramElementAccessor;

public class MPSCellReference {

  private MyGraph myGraph;
  private List<IAccessorKey> myIds = ListSequence.fromList(new ArrayList<IAccessorKey>());
  private int myIndex;

  public MPSCellReference(MPSCell mpsCell) {
    IMPSCellContainer container = mpsCell.getContainer();
    IDiagramElement diagramElement = ((BaseDCell) container).getDiagramElement();

    for (DiagramModel m = check_qaenos_a0d0f(diagramElement); m != null; m = m.getParentModel()) {
      ListSequence.fromList(myIds).addElement(m.getDiagramAccessor().getId());
    }
    myIds = ListSequence.fromList(myIds).reversedList().skip(1).toList();
    IAccessorKey id = check_qaenos_a0f0f(check_qaenos_a0a5a5(diagramElement));
    if (id != null) {
      ListSequence.fromList(myIds).addElement(id);
    }

    myGraph = mpsCell.getDiagramCell().getGraph();
    myIndex = container.getMPSCells().indexOf(mpsCell);
  }

  public MPSCellReference(MyGraph graph, List<IAccessorKey> ids, int index) {
    myGraph = graph;
    myIds = ids;
    myIndex = index;
  }

  public MPSCell resolve() {
    IDiagramElement element = resolveElement(myGraph.getRootDiagramModel(), myIds);
    if (element == null) {
      return null;
    }
    String dcellId = JGraphModelSynchronizer.getSynchronizer(myGraph.getRootDiagramModel()).getElementMapper().getCellId(element);
    Object dcell = myGraph.getModel().getCell(dcellId);
    if (!(dcell instanceof IMPSCellContainer)) {
      return null;
    }
    List<MPSCell> cells = ((IMPSCellContainer) dcell).getMPSCells();
    if (myIndex >= ListSequence.fromList(cells).count()) {
      return null;
    }
    return ListSequence.fromList(cells).getElement(myIndex);
  }

  public IDiagramElement resolveElement(DiagramModel parent, final Iterable<IAccessorKey> ids) {
    if (parent == null) {
      return null;
    }
    if (Sequence.fromIterable(ids).isEmpty()) {
      return null;
    }
    if (Sequence.fromIterable(ids).count() == 1) {
      return parent.getElement(Sequence.fromIterable(ids).first());
    } else {
      List<DiagramModel> childModels = parent.getChildModels();
      DiagramModel childModel = ListSequence.fromList(childModels).findFirst((it) -> Objects.equals(it.getDiagramAccessor().getId(), Sequence.fromIterable(ids).first()));
      return resolveElement(childModel, Sequence.fromIterable(ids).skip(1));
    }
  }
  private static DiagramModel check_qaenos_a0d0f(IDiagramElement checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModel();
    }
    return null;
  }
  private static IAccessorKey check_qaenos_a0f0f(IDiagramElementAccessor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getId();
    }
    return null;
  }
  private static IDiagramElementAccessor check_qaenos_a0a5a5(IDiagramElement checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getAccessor();
    }
    return null;
  }
}
