package de.q60.mps.polymorphicfunctions.runtime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.module.SModuleReference;
import jetbrains.mps.smodel.language.LanguageRegistry;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.project.Project;
import org.jetbrains.mps.openapi.model.SNodeReference;
import java.util.Objects;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPointerOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.core.behavior.INamedConcept__BehaviorDescriptor;
import java.util.concurrent.atomic.AtomicReference;
import java.util.stream.Stream;
import java.lang.reflect.Field;

public class ImplementationsFromFunctionModule implements IImplementationProvider {

  private final SModuleReference myModuleReference;
  private final LanguageRegistry myLanguageRegistry;
  private final String myClassName;

  public static ImplementationsFromFunctionModule fromModuleNode(@NotNull Project mpsProject, SNodeReference moduleNodePtr) {
    LanguageRegistry languageRegistry = mpsProject.getPlatform().findComponent(LanguageRegistry.class);
    Objects.requireNonNull(languageRegistry, "language registry must be available");

    // Keep MPS dataflow happy
    assert languageRegistry != null;

    SNode moduleNode = SPointerOperations.resolveNode(moduleNodePtr, mpsProject.getRepository());

    SModuleReference moduleReference = SNodeOperations.getModel(moduleNode).getModule().getModuleReference();
    String className = INamedConcept__BehaviorDescriptor.getFqName_idhEwIO9y.invoke(moduleNode);
    return new ImplementationsFromFunctionModule(languageRegistry, moduleReference, className);
  }

  public ImplementationsFromFunctionModule(@NotNull LanguageRegistry languageRegistry, SModuleReference moduleReference, String className) {
    myLanguageRegistry = languageRegistry;
    myModuleReference = moduleReference;
    myClassName = className;
  }

  public PFModule getModule() {
    final AtomicReference<PFModule> descriptor = new AtomicReference<>();
    myLanguageRegistry.withModuleRuntime(Stream.of(myModuleReference), (mr) -> {
      try {
        Class<?> cls = mr.getOwnClass(myClassName);
        Field instanceField = cls.getDeclaredField("INSTANCE");
        descriptor.set((PFModule) instanceField.get(null));
      } catch (ReflectiveOperationException e) {
        throw new RuntimeException(e);
      }
    });
    return descriptor.get();
  }

  @Override
  public Iterable<IFunctionImplementation> getImplementations(IPFContext context, String declarationId, ParameterList parameters) {
    return getModule().getImplementations(context, declarationId, parameters);
  }

  @Override
  public Iterable<IPriorityRule> getPriorityRules() {
    return getModule().getPriorityRules();
  }
}
