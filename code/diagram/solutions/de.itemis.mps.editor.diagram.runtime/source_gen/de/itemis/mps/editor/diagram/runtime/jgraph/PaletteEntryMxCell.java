package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import com.mxgraph.model.mxCell;
import de.itemis.mps.editor.diagram.runtime.model.SerializableObjectHolder;
import com.mxgraph.model.mxGeometry;
import de.itemis.mps.editor.diagram.runtime.model.IPaletteEntry;
import org.jetbrains.mps.openapi.model.SNode;
import de.itemis.mps.editor.diagram.runtime.model.DiagramModel;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.mps.openapi.language.SAbstractConcept;

public class PaletteEntryMxCell extends mxCell implements ISelfCreatingCell {

  private SerializableObjectHolder<SubstituteData> myData;
  private EdgeDCell myEdgeToSplit;
  private SerializableObjectHolder<BaseDiagramECell> myTargetDiagram;

  public PaletteEntryMxCell(Object value, mxGeometry geometry, String style, IPaletteEntry action, BaseDiagramECell targetDiagram) {
    super(value, geometry, style);

    myData = new SerializableObjectHolder<SubstituteData>(new SubstituteData(action, ""));
    myTargetDiagram = new SerializableObjectHolder<BaseDiagramECell>(targetDiagram);
  }

  public BaseDiagramECell getTargetDiagram() {
    return myTargetDiagram.get();
  }

  public Object readResolve() {
    getData();
    return this;
  }

  protected SubstituteData getData() {
    return myData.get();
  }

  public SNode createModelNode(DiagramModel diagramModel) {
    SubstituteData substituteData = getData();

    final IPaletteEntry originalAction = substituteData.action;

    // if an entry is dropped onto a different (sub-)diagram than it was loaded from,
    // we search for an entry with the same name
    IPaletteEntry contextAction = Sequence.fromIterable(diagramModel.getPaletteEntryProvider().getEntries()).findFirst((it) -> originalAction.isValidReplacement(it));

    return (contextAction != null ? contextAction.execute() : originalAction.execute());

  }

  public IPaletteEntry getEntry() {
    return getData().action;
  }

  public static class SubstituteData {
    private IPaletteEntry action;
    private String pattern;

    public SubstituteData(@NotNull IPaletteEntry action, @Nullable String pattern) {
      if (action == null) {
        throw new NullPointerException("action is null");
      }
      this.action = action;
      this.pattern = pattern;
    }

    public SAbstractConcept getOutputConcept() {
      return action.getOutputConcept();
    }
  }
  @Override
  public EdgeDCell getEdgeToSplit() {
    return myEdgeToSplit;
  }
  public void setEdgeToSplit(EdgeDCell edge) {
    myEdgeToSplit = edge;
  }
}
