package de.q60.mps.shadowmodels.runtime.smodel;

/*Generated by MPS */

import de.q60.mps.shadowmodels.runtime.engine.TransformationEngine;
import de.q60.mps.polymorphicfunctions.runtime.DefaultPFContext;
import de.q60.mps.polymorphicfunctions.runtime.ImplementationsFromGlobalRepository;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.modelix.model.mpsadapters.mps.NodeToSNodeAdapter;
import de.q60.mps.shadowmodels.runtime.engine.TransformationCall;
import de.q60.mps.shadowmodels.runtime.engine.DependencyTrackingNode;
import org.modelix.model.mpsadapters.mps.SNodeToNodeAdapter;
import org.jetbrains.mps.openapi.model.SModel;
import org.modelix.model.mpsadapters.mps.SModelAsNode;
import org.jetbrains.mps.openapi.module.SModule;
import org.modelix.model.mpsadapters.mps.SModuleAsNode;
import org.jetbrains.mps.openapi.model.SNodeReference;

public class ShadowModelsAPI {
  private static TransformationEngine engine = new STransformationEngine(new DefaultPFContext(new ImplementationsFromGlobalRepository() {
    @Override
    protected Iterable<String> getModelNames() {
      return ListSequence.fromListAndArray(new ArrayList<String>(), "pf", "transformations");
    }
  }));
  public static void dispose() {
    engine.dispose();
    engine = null;
  }
  public static SNode transform(final String transformationId, final Object... parameters) {
    return TransformationEngine.CONTEXT_ENGINE.computeWith(engine, () -> {
      Iterable<Object> convertedParameters = Sequence.fromIterable(Sequence.fromArray(parameters)).select((it) -> convertParameter(it));
      SNode output = NodeToSNodeAdapter.wrap(Sequence.fromIterable(engine.executeInCurrentStage(new TransformationCall(transformationId, convertedParameters))).first());
      return output;
    });
  }

  private static Object convertParameter(Object param) {
    if (param instanceof SNode) {
      return DependencyTrackingNode.wrap(SNodeToNodeAdapter.wrap(((SNode) param)));
    } else if (param instanceof SModel) {
      return DependencyTrackingNode.wrap(SModelAsNode.wrap(((SModel) param)));
    } else if (param instanceof SModule) {
      return DependencyTrackingNode.wrap(SModuleAsNode.wrap(((SModule) param)));
    } else if (param instanceof SNodeReference) {
      return SM_ParameterConversion.fromMPS(((SNodeReference) param));
    } else if (param instanceof Iterable) {
      Iterable<Object> iterable = ((Iterable<Object>) param);
      return Sequence.fromIterable(iterable).select((it) -> convertParameter(it)).toList();
    } else {
      return param;
    }
  }
}
