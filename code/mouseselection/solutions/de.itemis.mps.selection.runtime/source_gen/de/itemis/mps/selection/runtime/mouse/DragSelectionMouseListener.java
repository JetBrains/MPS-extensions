package de.itemis.mps.selection.runtime.mouse;

/*Generated by MPS */

import java.awt.event.MouseAdapter;
import java.util.Map;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.WeakHashMap;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.util.List;
import de.itemis.mps.selection.runtime.linear.LinearSelectionHandler;
import java.lang.ref.WeakReference;
import java.awt.Point;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import jetbrains.mps.openapi.editor.selection.Selection;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import java.awt.event.MouseEvent;

public class DragSelectionMouseListener extends MouseAdapter {

  private static Map<EditorComponent, DragSelectionMouseListener> instances = MapSequence.fromMap(new WeakHashMap<EditorComponent, DragSelectionMouseListener>());

  public static DragSelectionMouseListener getOrCreateInstance(EditorComponent editorComponent) {
    DragSelectionMouseListener instance = MapSequence.fromMap(DragSelectionMouseListener.instances).get(editorComponent);
    if (instance == null) {
      instance = new DragSelectionMouseListener(editorComponent);
      MapSequence.fromMap(DragSelectionMouseListener.instances).put(editorComponent, instance);
    }
    return instance;
  }

  @Nullable
  public static DragSelectionMouseListener getInstance(EditorComponent editorComponent) {
    return MapSequence.fromMap(instances).get(editorComponent);
  }

  public static void uninstallAll() {
    for (DragSelectionMouseListener instance : ListSequence.fromListWithValues(new ArrayList<DragSelectionMouseListener>(), MapSequence.fromMap(instances).values())) {
      instance.uninstall();
    }
  }

  private List<IDragSelectionHandler> myDefaultHandlers = ListSequence.fromListAndArray(new ArrayList<IDragSelectionHandler>(), new LabelSelectionHandler(), new NodeRangeSelectionHandler(), new CommonParentSelectionHandler(), new LinearSelectionHandler());
  private WeakReference<EditorComponent> myEditorComponent;
  private Point myStartPos;

  public DragSelectionMouseListener(EditorComponent editorComponent) {
    myEditorComponent = new WeakReference<EditorComponent>(editorComponent);
    editorComponent.addDisposeListener(new EditorComponent.EditorDisposeListener() {
      public void editorWillBeDisposed(EditorComponent editorComponent) {
        editorComponent.removeDisposeListener(this);
        uninstall();
      }
    });
  }

  public EditorComponent getEditorComponent() {
    return myEditorComponent.get();
  }

  public void install() {
    getEditorComponent().addMouseListener(this);
    getEditorComponent().addMouseMotionListener(this);
  }

  public void uninstall() {
    getEditorComponent().removeMouseListener(this);
    getEditorComponent().removeMouseMotionListener(this);
    MapSequence.fromMap(instances).removeKey(getEditorComponent());
  }

  protected EditorCell findCellAtMouse(Point point) {
    if (!(getEditorComponent().isFocusOwner())) {
      return null;
    }
    jetbrains.mps.nodeEditor.cells.EditorCell rootCell = getEditorComponent().getRootCell();
    EditorCell result = rootCell.findLeaf(point.x, point.y);
    if (result == null) {
      result = findDeepestCell(rootCell, point.x, point.y);
    }
    return result;
  }

  protected EditorCell findDeepestCell(@NotNull final EditorCell cell, int x, int y) {
    if (cell.getX() <= x && x < cell.getX() + cell.getWidth() && cell.getY() <= y && y < cell.getY() + cell.getHeight()) {
      if (cell instanceof EditorCell_Collection) {
        for (EditorCell child : (EditorCell_Collection) cell) {
          EditorCell result = findDeepestCell(child, x, y);
          if (result != null) {
            return result;
          }
        }
      }
      return cell;
    }
    return null;
  }

  public boolean contains(EditorCell cell, int x, int y) {
    return cell.getX() <= x && x < cell.getX() + cell.getWidth() && cell.getY() <= y && y < cell.getY() + cell.getHeight();
  }

  protected void updateSelection(Point from, Point to, boolean alternative) {
    if (from.distance(to) <= 2) {
      // consider such a small drag accidental
      return;
    }
    EditorCell startCell = findCellAtMouse(from);
    EditorCell endCell = findCellAtMouse(to);
    if (startCell == null || endCell == null) {
      return;
    }
    Selection selection = createSelection(startCell, endCell, from, to, alternative);
    if (selection != null) {
      getEditorComponent().getSelectionManager().setSelection(selection);
    }
  }

  protected Selection createSelection(@NotNull EditorCell fromCell, @NotNull EditorCell toCell, Point fromPoint, Point toPoint, boolean alternative) {
    for (IDragSelectionHandler handler : Sequence.fromIterable(getSelectionHandlers())) {
      Selection selection = (alternative ? handler.createAlternativeSelection(fromCell, toCell, fromPoint.x, fromPoint.y, toPoint.x, toPoint.y, getEditorComponent()) : handler.createSelection(fromCell, toCell, fromPoint.x, fromPoint.y, toPoint.x, toPoint.y, getEditorComponent()));
      if (selection != null) {
        return selection;
      }
    }
    return null;
  }

  protected Iterable<IDragSelectionHandler> getSelectionHandlers() {
    return Sequence.fromIterable(new ExtensionPoint<IDragSelectionHandler>("de.itemis.mps.selection.runtime.DragSelectionHandlerEP").getObjects()).concat(ListSequence.fromList(myDefaultHandlers)).sort((it) -> it.getPriority(), false);
  }

  protected void updateSelection(MouseEvent e) {
    if (myStartPos != null) {
      updateSelection(myStartPos, e.getPoint(), e.isAltDown());
    }
  }

  @Override
  public void mouseDragged(MouseEvent e) {
    updateSelection(e);
  }
  @Override
  public void mousePressed(MouseEvent e) {
    myStartPos = e.getPoint();
  }
  @Override
  public void mouseReleased(MouseEvent e) {
    myStartPos = null;
  }

}
