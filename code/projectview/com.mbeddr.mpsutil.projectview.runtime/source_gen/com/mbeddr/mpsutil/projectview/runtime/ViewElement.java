package com.mbeddr.mpsutil.projectview.runtime;

/*Generated by MPS */

import jetbrains.mps.project.Project;
import java.util.List;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.ArrayList;
import java.util.Objects;
import javax.swing.Icon;
import org.jetbrains.annotations.NotNull;
import com.intellij.ui.SimpleTextAttributes;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;

public class ViewElement<E> {
  protected E myObject;
  protected ViewElement myParent;
  protected ElementId myDescriptorId;
  protected Project myProject;
  protected List<IViewElementDescriptor> myInheritanceHierachy;
  protected List<IViewElementDescriptor> myFullHierachy;
  protected ViewId myContextView;

  public ViewElement(@Nullable E object, @Nullable ElementId descriptorId, Project project, @Nullable ViewElement parent, ViewId contextView) {
    myObject = object;
    myProject = project;
    myParent = parent;
    myDescriptorId = descriptorId;
    myContextView = contextView;

    if (myDescriptorId != null) {
      myFullHierachy = Sequence.fromIterable(ViewRegistry.getInstance().getInheritanceHierachy(myDescriptorId, contextView)).toList();
      myInheritanceHierachy = ListSequence.fromList(myFullHierachy).where(new _FunctionTypes._return_P1_E0<Boolean, IViewElementDescriptor>() {
        public Boolean invoke(IViewElementDescriptor it) {
          return !(it.isOverride()) || it.isAssignable(myProject, ViewElement.this);
        }
      }).toList();
    } else {
      myFullHierachy = ListSequence.fromList(new ArrayList<IViewElementDescriptor>());
      myInheritanceHierachy = ListSequence.fromList(new ArrayList<IViewElementDescriptor>());
    }
  }

  public ViewId getViewId() {
    return myContextView;
  }

  public E getObject() {
    return myObject;
  }

  public Object getObject(final ElementId id) {
    List<IViewElementDescriptor> hierachy = (myInheritanceHierachy == null ? myFullHierachy : myInheritanceHierachy);
    if (ListSequence.fromList(hierachy).any(new _FunctionTypes._return_P1_E0<Boolean, IViewElementDescriptor>() {
      public Boolean invoke(IViewElementDescriptor it) {
        return Objects.equals(it.getId(), id);
      }
    })) {
      return myObject;
    } else {
      if (myParent != null) {
        return myParent.getObject(id);
      }
    }
    return null;
  }

  public ViewElement getParent() {
    return myParent;
  }

  public void setParent(ViewElement parent) {
    myParent = parent;
  }

  public ElementId getDescriptorId() {
    return myDescriptorId;
  }

  public IViewElementDescriptor getDescriptor() {
    return ViewRegistry.getInstance().getElement(myDescriptorId);
  }

  public String getId() {
    return myDescriptorId.getViewId().getId() + "#" + myDescriptorId.getId() + "#" + getLabel();
  }

  public Project getProject() {
    return myProject;
  }

  public String getLabel() {
    for (IViewElementDescriptor descriptor : ListSequence.fromList(myInheritanceHierachy)) {
      String label = descriptor.getLabel(this);
      if (label != null) {
        return label;
      }
    }
    return null;
  }

  public Icon getIcon() {
    for (IViewElementDescriptor descriptor : ListSequence.fromList(myInheritanceHierachy)) {
      Icon icon = descriptor.getIcon(this);
      if (icon != null) {
        return icon;
      }
    }
    return null;
  }

  @NotNull
  public SimpleTextAttributes getTextAttributes() {
    SimpleTextAttributes attrs = SimpleTextAttributes.REGULAR_ATTRIBUTES;
    for (IViewElementDescriptor descriptor : ListSequence.fromList(myInheritanceHierachy)) {
      SimpleTextAttributes attributes = descriptor.getTextAttributes(this);
      if (attributes != null) {
        attrs = SimpleTextAttributes.merge(attrs, attributes);
      }
    }
    return attrs;
  }

  public String getActionGroupId() {
    for (IViewElementDescriptor descriptor : ListSequence.fromList(myInheritanceHierachy)) {
      String actionGroup = descriptor.getActionGroupId(this);
      if (actionGroup != null) {
        return actionGroup;
      }
    }
    return null;
  }

  public Iterable<String> getFolders() {
    for (IViewElementDescriptor descriptor : ListSequence.fromList(myInheritanceHierachy)) {
      Iterable<String> folders = descriptor.getFolders(this);
      if (folders != null) {
        return folders;
      }
    }
    return null;
  }

  public String getFolderActionGroupId() {
    for (IViewElementDescriptor descriptor : ListSequence.fromList(myInheritanceHierachy)) {
      String actionGroupId = descriptor.getFoldersActiondGroupId(this);
      if (actionGroupId != null) {
        return actionGroupId;
      }
    }
    return null;
  }

  public Iterable<IViewElementDescriptor> getInheritanceHierachy() {
    return myInheritanceHierachy;
  }

  public Set<Class> getPossibleDescendantTypes() {
    Set<Class> result;
    if (ListSequence.fromList(myInheritanceHierachy).isEmpty()) {
      result = SetSequence.fromSetWithValues(new HashSet<Class>(), ViewRegistry.getInstance().getPossibleDescendantTypes(myDescriptorId, myContextView));
    } else {
      result = SetSequence.fromSetWithValues(new HashSet<Class>(), ListSequence.fromList(myInheritanceHierachy).translate(new _FunctionTypes._return_P1_E0<Iterable<Class>, IViewElementDescriptor>() {
        public Iterable<Class> invoke(IViewElementDescriptor it) {
          return ViewRegistry.getInstance().getPossibleDescendantTypes(it.getId(), myContextView);
        }
      }));
    }
    return result;
  }

  public Iterable<IViewElementDescriptor> getChildDescriptors() {
    Iterable<IViewElementDescriptor> concreteDescriptors = ViewRegistry.getInstance().getQueryableElements(myContextView);

    final Set<ElementId> hierachy = SetSequence.fromSetWithValues(new HashSet<ElementId>(), Sequence.fromIterable(this.getInheritanceHierachy()).select(new _FunctionTypes._return_P1_E0<ElementId, IViewElementDescriptor>() {
      public ElementId invoke(IViewElementDescriptor it) {
        return it.getId();
      }
    }));
    return Sequence.fromIterable(concreteDescriptors).where(new _FunctionTypes._return_P1_E0<Boolean, IViewElementDescriptor>() {
      public Boolean invoke(IViewElementDescriptor it) {
        return Objects.equals(it.getParentId(), myDescriptorId) || SetSequence.fromSet(hierachy).contains(it.getParentId());
      }
    });
  }

  public boolean loadLazy() {
    for (IViewElementDescriptor descriptor : ListSequence.fromList(myInheritanceHierachy)) {
      Boolean lazy = descriptor.loadLazy(this);
      if (lazy != null) {
        return lazy;
      }
    }
    return true;
  }

  public boolean loadAsync() {
    for (IViewElementDescriptor descriptor : ListSequence.fromList(myInheritanceHierachy)) {
      Boolean async = descriptor.loadAsync(this);
      if (async != null) {
        return async;
      }
    }
    return false;
  }

  public boolean isAutoUpdate() {
    for (IViewElementDescriptor descriptor : ListSequence.fromList(myInheritanceHierachy)) {
      Boolean autoUpdate = descriptor.isAutoUpdate(this);
      if (autoUpdate != null) {
        return autoUpdate;
      }
    }
    return true;
  }
}
