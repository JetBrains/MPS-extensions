package com.mbeddr.mpsutil.treenotation.runtime;

/*Generated by MPS */

import java.awt.event.MouseListener;
import java.awt.event.MouseMotionListener;
import jetbrains.mps.openapi.editor.style.StyleAttribute;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.Set;
import java.util.HashSet;
import java.awt.event.MouseEvent;
import java.awt.Rectangle;
import jetbrains.mps.openapi.editor.cells.EditorCell;

public class ButtonsMouseListener implements MouseListener, MouseMotionListener {
  private static final String KEY = "ButtonsMouseListener";
  private static final StyleAttribute<_FunctionTypes._return_P1_E0<? extends Double, ? super Double>> TREE_BUTTON_OPACITY = StyleAttributes.getInstance().<_FunctionTypes._return_P1_E0<? extends Double, ? super Double>>getAttribute("com.mbeddr.mpsutil.treenotation.styles", "tree-button-opacity");


  public static void registerCell(Button cell) {
    EditorComponent editorComponent = ((EditorComponent) cell.getEditorComponent());
    ButtonsMouseListener instance = as_w10wuk_a0a1a4(editorComponent.getClientProperty(KEY), ButtonsMouseListener.class);
    if (instance == null) {
      instance = new ButtonsMouseListener();
      editorComponent.putClientProperty(KEY, instance);
      editorComponent.addMouseListener(instance);
      editorComponent.addMouseMotionListener(instance);
    }
    SetSequence.fromSet(instance.myButtons).addElement(cell);
  }

  public static void unregisterUsage(Button cell) {
    EditorComponent editorComponent = ((EditorComponent) cell.getEditorComponent());
    ButtonsMouseListener instance = as_w10wuk_a0a1a6(editorComponent.getClientProperty(KEY), ButtonsMouseListener.class);
    if (instance != null) {
      SetSequence.fromSet(instance.myButtons).removeElement(cell);
      if (SetSequence.fromSet(instance.myButtons).isEmpty()) {
        editorComponent.putClientProperty(KEY, null);
        editorComponent.removeMouseListener(instance);
        editorComponent.removeMouseMotionListener(instance);
      }
    }
  }

  private Set<Button> myButtons = SetSequence.fromSet(new HashSet<Button>());

  public ButtonsMouseListener() {
  }

  protected Button getCellAt(final MouseEvent event) {
    return SetSequence.fromSet(myButtons).findFirst((it) -> new Rectangle(it.getX(), it.getY(), it.getWidth(), it.getHeight()).contains(event.getX(), event.getY()));
  }

  public void mouseClicked(MouseEvent event) {
    Button cell = getCellAt(event);
    if (cell != null) {
      cell.onClick(event);
      event.consume();
    }
  }

  public void mousePressed(MouseEvent event) {
  }
  public void mouseReleased(MouseEvent event) {
  }
  public void mouseEntered(MouseEvent event) {
  }
  public void mouseExited(MouseEvent event) {
    SetSequence.fromSet(myButtons).visitAll((it) -> it.setOpacity(0.0f));
  }
  public void mouseDragged(MouseEvent event) {
  }
  public void mouseMoved(MouseEvent event) {
    Button highlighted = getCellAt(event);
    for (Button button : SetSequence.fromSet(myButtons)) {
      double opacity = 0.0;
      if (button == highlighted) {
        opacity = 1.0;
      } else {
        TreeCell rootTreeCell = getRootTreeCell(button);
        if (rootTreeCell == null) {
          opacity = 0.8;
        } else {
          _FunctionTypes._return_P1_E0<? extends Double, ? super Double> opacityFunction = rootTreeCell.getStyle().get(TREE_BUTTON_OPACITY);
          if (opacityFunction == null) {
            if (EditorCellExtensions.getRect(rootTreeCell).contains(event.getPoint())) {
              opacity = 0.8;
            }
          } else {
            double dX = event.getX() - button.getX();
            double dY = event.getY() - button.getY();
            double distance = Math.sqrt(dX * dX + dY * dY);
            opacity = opacityFunction.invoke(distance);
            if (opacity < 0.0) {
              opacity = 0.0;
            }
            if (opacity > 1.0) {
              opacity = 1.0;
            }
          }
        }
      }
      if (event.getModifiers() != 0) {
        opacity = 0.0;
      }
      button.setOpacity(((float) opacity));
    }
  }

  public TreeCell getRootTreeCell(EditorCell cell) {
    TreeCell root = null;
    for (EditorCell ancestor = cell; ancestor != null; ancestor = ancestor.getParent()) {
      if (ancestor instanceof TreeCell) {
        root = ((TreeCell) ancestor);
      }
    }
    return root;
  }
  private static <T> T as_w10wuk_a0a1a4(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_w10wuk_a0a1a6(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
