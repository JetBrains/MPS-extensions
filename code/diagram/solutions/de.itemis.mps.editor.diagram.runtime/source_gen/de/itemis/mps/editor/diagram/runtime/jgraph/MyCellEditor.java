package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import com.mxgraph.swing.view.mxICellEditor;
import java.util.EventObject;
import java.util.List;
import java.awt.event.MouseEvent;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.cells.CellTraversalUtil;
import jetbrains.mps.openapi.editor.cells.CellConditions;
import java.awt.Dimension;
import com.intellij.ui.JBColor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.mxgraph.view.mxCellState;

public class MyCellEditor implements mxICellEditor {
  private MPSCell myEditingCell;
  private MyGraphComponent myGraphComponent;
  private MPSCellEditor myEditor;
  private MPSCellReference myCurrentCellReference;
  private boolean myDisabled = false;

  public MyCellEditor(MyGraphComponent graphComponent) {
    myGraphComponent = graphComponent;
    myEditor = new MPSCellEditor(graphComponent);
  }

  public Object getEditingCell() {
    return myEditor.getDCell();
  }

  public void startEditing(Object cell, EventObject event) {
    if (myDisabled) {
      return;
    }

    if (myEditingCell != null) {
      stopEditing(true);
    }

    if (!(cell instanceof IMPSCellContainer)) {
      return;
    }
    IMPSCellContainer mpsCellContainer = (IMPSCellContainer) cell;
    List<MPSCell> mpsCells = mpsCellContainer.getMPSCells();
    if (mpsCells.size() == 0) {
      return;
    }
    MPSCell mpsCell = mpsCells.get(0);
    mpsCell.moveCell();

    if (event instanceof MouseEvent) {
      MouseEvent mouseEvent = ((MouseEvent) event);
      boolean selectionChanged = mpsCell.setSelection(mouseEvent.getX(), mouseEvent.getY());
      if (selectionChanged) {
        return;
      }
    }
    EditorCell firstEditableLeaf = getFirstEditableLeaf(mpsCell.getEditorCell());
    if (firstEditableLeaf != null) {
      myGraphComponent.getEditorComponent().getSelectionManager().setSelection(firstEditableLeaf);
    } else {
      startEditing(mpsCell);
    }
  }

  public EditorCell getFirstEditableLeaf(EditorCell parent) {
    EditorCell cellToEdit = CellTraversalUtil.getFirstLeaf(parent);
    if (!(CellConditions.EDITABLE.met(cellToEdit))) {
      cellToEdit = CellTraversalUtil.getNextLeaf(cellToEdit, CellConditions.EDITABLE);
    }
    if (cellToEdit != null && CellTraversalUtil.isAncestorOrEquals(parent, cellToEdit)) {
      return cellToEdit;
    }
    return parent;
  }

  public void startEditing(MPSCell cell) {
    if (myDisabled) {
      return;
    }

    if (myEditingCell != null) {
      stopEditing(true);
    }

    updatePosition(cell.getEditorCell());

    myEditingCell = cell;
    myCurrentCellReference = new MPSCellReference(cell);
    if (cell != null) {
      myEditor.setScale(cell.getTotalScale());
    } else {
      myEditor.setScale(myGraphComponent.getGraph().getView().getScale());
    }
    myEditor.editCell(cell);

    int x = LayoutDependencies.getX(cell.getEditorCell()) - myGraphComponent.getX() - MPSCellEditor.PADDING_SIZE;
    int y = LayoutDependencies.getY(cell.getEditorCell()) - myGraphComponent.getY() - MPSCellEditor.PADDING_SIZE;
    Dimension preferredSize = myEditor.getPreferredSize();
    myEditor.setBounds(x, y, preferredSize.width, preferredSize.height);
    myEditor.setBackground(JBColor.WHITE);
    myEditor.setVisible(true);

    myGraphComponent.getGraphControl().add(myEditor, 0);
    myEditor.revalidate();
    myEditor.repaint();
  }

  private void updatePosition(EditorCell editorCell) {
    IMPSCellContainer container = (IMPSCellContainer) MPSCellEditor.findDCellForEmbeddedCell(editorCell, myGraphComponent.getGraph().getModel());
    if (container == null) {
      return;
    }
    for (MPSCell mpsCell : ListSequence.fromList(container.getMPSCells())) {
      mpsCell.moveCell();
    }
  }

  public void stopEditing(boolean cancel) {
    if (myDisabled) {
      return;
    }

    if (myEditingCell != null) {
      myEditor.transferFocusUpCycle();
      Object cell = myEditingCell;
      myEditingCell = null;
      myCurrentCellReference = null;
      mxCellState state = myGraphComponent.getGraph().getView().getState(cell);
      myGraphComponent.redraw(state);
      if (myEditor.getParent() != null) {
        myEditor.setVisible(true);
        myEditor.getParent().remove(myEditor);
      }
    }
    myGraphComponent.repaint();
  }

  public void updateCell() {
    if (myCurrentCellReference != null) {
      MPSCell cell = myCurrentCellReference.resolve();
      if (cell != null) {
        startEditing(cell);
      } else {
        stopEditing(true);
      }
    }
  }

  public MPSCell getMPSCell() {
    return this.myEditingCell;
  }

  public void setDisabled(boolean flag) {
    myDisabled = flag;
  }
}
