package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import org.eclipse.elk.alg.force.stress.StressMajorization;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.eclipse.elk.alg.force.options.StressOptions;
import org.eclipse.elk.core.data.LayoutMetaDataService;
import org.eclipse.elk.alg.force.options.StressMetaDataProvider;
import org.eclipse.elk.graph.ElkNode;
import org.eclipse.elk.core.util.IElkProgressMonitor;
import de.itemis.mps.editor.diagram.runtime.model.IAccessorKey;
import org.eclipse.elk.graph.ElkEdge;
import org.eclipse.elk.graph.ElkLabel;
import de.itemis.mps.editor.diagram.runtime.model.EdgeLabelType;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;

public class StressLayouter extends ElkLayouter {

  protected double desiredEdgeLength;
  protected int iterationLimit;
  protected StressMajorization.Dimension layoutDimension;
  protected boolean omitNodeMicroLayout;
  protected double stressEpsilon;

  protected Map<Object, Double> myDesiredEdgeLengths = MapSequence.fromMap(new HashMap<Object, Double>());
  protected Map<Object, Boolean> myFixedPositions = MapSequence.fromMap(new HashMap<Object, Boolean>());
  protected Map<Object, Boolean> myInlineEdgeLabels = MapSequence.fromMap(new HashMap<Object, Boolean>());

  public StressLayouter() {
    super();
    myAlgorithm = StressOptions.ALGORITHM_ID;
  }

  static {
    LayoutMetaDataService.getInstance().registerLayoutMetaDataProviders(new StressMetaDataProvider());
  }

  @Override
  public boolean canLayoutLabels() {
    return false;
  }
  @Override
  protected boolean useDummyPort(EdgeDCell edge, boolean isTarget) {
    return false;
  }

  @Override
  protected void addLayoutInformationToGraph(ElkNode graph, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToGraph(graph, progressMonitor);
    ElkNode layout = graph;
    layout.setProperty(StressOptions.DESIRED_EDGE_LENGTH, desiredEdgeLength);
    layout.setProperty(StressOptions.ITERATION_LIMIT, iterationLimit);
    layout.setProperty(StressOptions.DIMENSION, layoutDimension);
    layout.setProperty(StressOptions.OMIT_NODE_MICRO_LAYOUT, omitNodeMicroLayout);
    layout.setProperty(StressOptions.EPSILON, stressEpsilon);

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(layout, "graph", progressMonitor);
    }
  }

  @Override
  protected void addLayoutInformationToNode(ElkNode knode, BoxDCell box, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToNode(knode, box, progressMonitor);
    IAccessorKey ID = box.getBox().getAccessor().getId();
    Boolean fixedPosition = MapSequence.fromMap(this.myFixedPositions).get(ID);
    if (fixedPosition != null) {
      knode.setProperty(StressOptions.FIXED, fixedPosition);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(knode, "node", progressMonitor);
    }
  }

  @Override
  protected void addLayoutInformationToEdge(ElkEdge kedge, EdgeDCell edge, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToEdge(kedge, edge, progressMonitor);
    IAccessorKey ID = edge.getEdge().getAccessor().getId();
    Double desiredEdgeLength = MapSequence.fromMap(this.myDesiredEdgeLengths).get(ID);
    if (desiredEdgeLength != null) {
      kedge.setProperty(StressOptions.DESIRED_EDGE_LENGTH, desiredEdgeLength);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(kedge, "edge", progressMonitor);
    }
  }

  @Override
  protected void addLayoutInformationToEdgeLabel(ElkEdge kedge, ElkLabel klabel, EdgeDCell edge, EdgeLabelType type, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToEdgeLabel(kedge, klabel, edge, type, progressMonitor);
    IAccessorKey ID = edge.getEdge().getAccessor().getId();
    Boolean inlineEdgeLabel = MapSequence.fromMap(this.myInlineEdgeLabels).get(ID);
    if (inlineEdgeLabel != null) {
      kedge.setProperty(StressOptions.EDGE_LABELS_INLINE, inlineEdgeLabel);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(kedge, "edge label", progressMonitor);
    }
  }

  @Override
  public void setParentsStyle(Style style) {
    super.setParentsStyle(style);
    this.desiredEdgeLength = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-stress-desired-edge-length"));
    this.iterationLimit = style.get(StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-stress-iteration-limit"));
    this.layoutDimension = style.get(StyleAttributes.getInstance().<StressMajorization.Dimension>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-stress-layout-dimension"));
    this.omitNodeMicroLayout = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-omit-node-micro-layout"));
    this.stressEpsilon = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-stress-epsilon"));
  }

  @Override
  public void addNodesStyle(Style style, Object key) {
    super.addNodesStyle(style, key);
    MapSequence.fromMap(this.myFixedPositions).put(key, style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-stress-fixed-position")));
  }

  @Override
  public void addEdgesStyle(Style style, Object key) {
    super.addEdgesStyle(style, key);
    MapSequence.fromMap(this.myDesiredEdgeLengths).put(key, style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-stress-desired-edge-length")));
  }

  @Override
  public void addLabelsStyle(Style style, Object key) {
    super.addLabelsStyle(style, key);
    MapSequence.fromMap(this.myInlineEdgeLabels).put(key, style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-stress-inline-edge-labels")));
  }
}
