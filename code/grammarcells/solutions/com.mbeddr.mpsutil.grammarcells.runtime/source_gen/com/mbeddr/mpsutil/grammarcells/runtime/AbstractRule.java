package com.mbeddr.mpsutil.grammarcells.runtime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public abstract class AbstractRule implements IRule {
  public SNode createSNode(PNode parseTree, IRecycledNodes recycledNodes) {
    SNode snode = SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(getOutputConcept()));
    SNode recycledNode = findNodeToRecycle(parseTree, recycledNodes);
    if (recycledNode != null) {
      ListSequence.fromList(SLinkOperations.getChildren(snode, LINKS.smodelAttribute$KJ43)).addSequence(ListSequence.fromList(SLinkOperations.getChildren(recycledNode, LINKS.smodelAttribute$KJ43)));
      for (SProperty property : CollectionSequence.fromCollection(getOutputConcept().getProperties())) {
        snode.setProperty(property, recycledNode.getProperty(property));
      }
    }
    for (PNode child : ListSequence.fromList(parseTree.getChildren())) {
      IToken token = child.getToken();
      if (token == null) {
        token = new ChildToken(child.createSNode(recycledNodes));
      }
      child.getSymbol().write(token, snode);
    }
    return snode;
  }

  @Override
  public boolean isLeftAssociative() {
    return true;
  }

  @Override
  public int getPriority() {
    return 0;
  }

  protected SNode findNodeToRecycle(PNode parseTree, final IRecycledNodes recycledNodes) {
    Iterable<IToken> textTokens = ListSequence.fromList(parseTree.getChildren()).select((it) -> it.getToken()).where((it) -> check_uly4a7_a0a0a0a0a6(it));
    Set<SNode> candidates = SetSequence.fromSetWithValues(new HashSet<SNode>(), Sequence.fromIterable(textTokens).select((it) -> recycledNodes.getOriginalNode(it)));
    SetSequence.fromSet(candidates).removeElement(null);
    SNode result = (SetSequence.fromSet(candidates).count() == 1 ? SetSequence.fromSet(candidates).first() : null);
    return result;
  }
  private static boolean check_uly4a7_a0a0a0a0a6(IToken checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.isText();
    }
    return false;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink smodelAttribute$KJ43 = MetaAdapterFactory.getContainmentLink(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, 0x47bf8397520e5942L, "smodelAttribute");
  }
}
