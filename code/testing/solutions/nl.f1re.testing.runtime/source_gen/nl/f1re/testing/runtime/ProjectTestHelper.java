package nl.f1re.testing.runtime;

/*Generated by MPS */

import jetbrains.mps.project.Project;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.ide.ThreadUtils;
import jetbrains.mps.classloading.ClassLoaderManager;
import jetbrains.mps.progress.EmptyProgressMonitor;
import org.jetbrains.annotations.NotNull;
import java.util.List;
import jetbrains.mps.ide.editor.MPSFileNodeEditor;
import java.util.ArrayList;
import com.intellij.openapi.fileEditor.FileEditor;
import com.intellij.openapi.fileEditor.FileEditorManager;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.openapi.editor.Editor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.concurrent.CountDownLatch;
import jetbrains.mps.editor.runtime.HeadlessEditorComponent;
import jetbrains.mps.messages.IMessageHandler;
import jetbrains.mps.messages.IMessage;
import java.util.concurrent.TimeUnit;
import org.junit.Assert;

/**
 * This class can be called from places where there is no write/read access to the model like editor node test cases.
 */
public class ProjectTestHelper {
  private Project project;

  public ProjectTestHelper(Project project) {
    this.project = project;
  }

  public void reloadModule(final SModule module) {
    ThreadUtils.runInUIThreadAndWait(() -> project.getRepository().getModelAccess().executeCommand(() -> {
      ClassLoaderManager classLoaderManager = project.getComponent(ClassLoaderManager.class);
      classLoaderManager.reloadModule(module);
    }));
  }

  public void reloadModules(final Iterable<? extends SModule> modules) {
    ThreadUtils.runInUIThreadAndWait(() -> project.getRepository().getModelAccess().executeCommand(() -> {
      ClassLoaderManager classLoaderManager = project.getComponent(ClassLoaderManager.class);
      classLoaderManager.reloadModules(modules);
    }));
  }

  public void reloadAll() {
    ThreadUtils.runInUIThreadAndWait(() -> project.getRepository().getModelAccess().executeCommand(() -> {
      ClassLoaderManager classLoaderManager = project.getComponent(ClassLoaderManager.class);
      classLoaderManager.reloadAll(new EmptyProgressMonitor());
    }));
  }

  @NotNull
  public List<MPSFileNodeEditor> getOpenEditors() {
    List<MPSFileNodeEditor> res = new ArrayList<>();
    FileEditor[] editors = FileEditorManager.getInstance(ProjectHelper.toIdeaProject(project)).getAllEditors();
    for (FileEditor editor : editors) {
      if (editor instanceof MPSFileNodeEditor) {
        MPSFileNodeEditor mpsEditor = (MPSFileNodeEditor) editor;
        Editor nodeEditor = mpsEditor.getNodeEditor();
        if (nodeEditor != null) {
          ListSequence.fromList(res).addElement(mpsEditor);
        }
      }
    }
    return res;
  }

  public MPSFileNodeEditor getActiveEditor() {
    FileEditor editor = FileEditorManager.getInstance(ProjectHelper.toIdeaProject(project)).getSelectedEditor();
    if (editor instanceof MPSFileNodeEditor) {
      return as_gtg9y4_a0a0b0m(editor, MPSFileNodeEditor.class);
    }

    return null;
  }

  public void closeOpenEditors() {
    ListSequence.fromList(getOpenEditors()).visitAll((it) -> FileEditorManager.getInstance(ProjectHelper.toIdeaProject(project)).closeFile(it.getFile()));
  }

  public void assertEditorNotBroken(SNode node) throws Exception {
    final CountDownLatch latch = new CountDownLatch(1);

    HeadlessEditorComponent component = new HeadlessEditorComponent(project.getRepository()) {
      @NotNull
      @Override
      public IMessageHandler getMessageHandler() {
        return new IMessageHandler() {
          @Override
          public void handle(@NotNull IMessage message) {
            if (message.getText().contains("Error creating editor cell")) {
              latch.countDown();
            }
          }
        };
      }
    };
    component.editNode(node);

    boolean invoked = false;
    try {
      invoked = latch.await(100, TimeUnit.MILLISECONDS);
    } catch (InterruptedException e) {
      Assert.fail(e.getMessage());
    }
    Assert.assertFalse(invoked);
  }

  private static <T> T as_gtg9y4_a0a0b0m(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
