package de.itemis.mps.editor.pagination.runtime.ui;

/*Generated by MPS */

import com.intellij.ui.SearchTextField;
import de.itemis.mps.editor.pagination.runtime.pages.PagesUserObject;
import jetbrains.mps.openapi.editor.EditorContext;
import java.awt.Color;
import jetbrains.mps.nodeEditor.EditorSettings;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import java.util.regex.Pattern;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.LinkedList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.regex.Matcher;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import com.intellij.ui.ColorUtil;
import com.intellij.ui.DarculaColors;
import jetbrains.mps.ide.search.SearchConditions;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;

public class PaginationSearchField extends SearchTextField {

  private PaginationSearchPanel mySearchPanel;
  private PagesUserObject myUserObj;
  private EditorContext myContext;
  private Color myDefaultBackgroundColor;

  public PaginationSearchField(PagesUserObject userObj, final PaginationSearchPanel searchPanel, final EditorContext context) {
    myUserObj = userObj;
    this.mySearchPanel = searchPanel;
    this.myContext = context;
    this.myDefaultBackgroundColor = getBackground();

    setOpaque(false);
    putClientProperty("ActionToolbar.smallVariant", true);
    setFont(EditorSettings.getInstance().getDefaultEditorFont());
    this.getTextEditor().setOpaque(false);

    setText(PaginationSearchResultManager.getInstance().getLastSearchText(myUserObj));

    getTextEditor().addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent event) {
        executeSearch();
      }
    });
  }

  public void executeSearch() {

    PaginationSearchResultManager.getInstance().setLastSearchText(myUserObj, getText());

    final Pattern pattern = getPattern();
    if (pattern == null) {
      return;
    }

    final List<SNode> foundNodes = ListSequence.fromList(new LinkedList<SNode>());

    myContext.getRepository().getModelAccess().runReadAction(() -> {
      List<SNode> allNodes = myUserObj.getAllChildren();

      ListSequence.fromList(allNodes).visitAll((it) -> PaginationSearchResultManager.getInstance().includeNodeInResults(it, false));

      for (SNode searchableNode : Sequence.fromIterable(SNodeOperations.ofConcept(allNodes, CONCEPTS.INamedConcept$Kd))) {
        Matcher matcher = pattern.matcher(SPropertyOperations.getString(searchableNode, PROPS.name$MnvL));
        if (matcher.find()) {
          ListSequence.fromList(foundNodes).addElement(searchableNode);
        }
      }
      ListSequence.fromList(foundNodes).visitAll((it) -> PaginationSearchResultManager.getInstance().includeNodeInResults(it, true));
      SNode firstResultNode = ListSequence.fromList(foundNodes).first();

      if (firstResultNode != null) {
        PaginationSearchField.this.getTextEditor().setBackground(myDefaultBackgroundColor);
        PaginationSearchResultManager.getInstance().changeSelection(myUserObj, firstResultNode, myContext);
      } else {
        PaginationSearchField.this.getTextEditor().setBackground(ColorUtil.mix(myContext.getEditorComponent().getStyleRegistry().getEditorBackground(), DarculaColors.RED, 0.1));
      }
    });
  }

  public List<SNode> getFoundNode;

  protected Pattern getPattern() {
    String text = getText();
    if (mySearchPanel.getSearchOptionState().isMatchRegex()) {
      return SearchConditions.containsRegexp(text, mySearchPanel.getSearchOptionState().isMatchCase());
    } else
    if (mySearchPanel.getSearchOptionState().isMatchWords()) {
      return SearchConditions.containsWholeWord(text, mySearchPanel.getSearchOptionState().isMatchCase());
    } else {
      return SearchConditions.containsString(text, mySearchPanel.getSearchOptionState().isMatchCase());
    }
  }


  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept INamedConcept$Kd = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, "jetbrains.mps.lang.core.structure.INamedConcept");
  }
}
