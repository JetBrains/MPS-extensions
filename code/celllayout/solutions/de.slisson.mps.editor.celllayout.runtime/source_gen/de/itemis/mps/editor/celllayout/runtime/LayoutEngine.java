package de.itemis.mps.editor.celllayout.runtime;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import jetbrains.mps.openapi.editor.style.StyleAttribute;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import jetbrains.mps.openapi.editor.EditorComponent;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import de.itemis.mps.editor.celllayout.layout.ILayoutable;
import de.itemis.mps.editor.celllayout.boxmodel.Size;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import de.itemis.mps.editor.celllayout.layout.LayoutableExtensions;
import de.itemis.mps.editor.celllayout.boxmodel.LayoutBoxFrame;
import de.itemis.mps.editor.celllayout.boxmodel.LayoutBoxExtensions;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import de.itemis.mps.editor.celllayout.boxmodel.EditorCellBoxModel;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.nodeEditor.EditorSettings;
import jetbrains.mps.nodeEditor.cells.EditorCell_Label;
import java.util.List;
import de.itemis.mps.editor.celllayout.layout.ILayoutableContainer;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import de.itemis.mps.editor.celllayout.boxmodel.BoxModel;
import de.itemis.mps.editor.celllayout.layout.GridLayout;
import de.itemis.mps.editor.celllayout.styles.editor.LayoutStylesUtil;
import de.itemis.mps.editor.celllayout.layout.ILayouter;

public class LayoutEngine {
  private static final Logger LOG = Logger.getLogger(LayoutEngine.class);
  private static final StyleAttribute<Boolean> FULL_WIDTH_ROOT = StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.celllayout.styles", "_full-width-root");
  private static final StyleAttribute<Integer> MARGIN_RIGHT = StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.celllayout.styles", "_margin-right");
  private static final StyleAttribute<String> FONT_FAMILY = StyleAttributes.getInstance().<String>getAttribute("de.itemis.mps.editor.celllayout.styles", "_font-family");
  private static final StyleAttribute<Integer> MARGIN_TOP = StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.celllayout.styles", "_margin-top");
  private static final StyleAttribute<Integer> MARGIN_LEFT = StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.celllayout.styles", "_margin-left");
  private static final StyleAttribute<Integer> MARGIN_BOTTOM = StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.celllayout.styles", "_margin-bottom");
  private static final StyleAttribute<Integer> MARGIN = StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.celllayout.styles", "_margin");

  public void layout(EditorComponent editorComponent) {
    layoutRootCell(editorComponent.getRootCell());
  }

  public void layoutRootCell(EditorCell rootCell) {
    layoutCell(rootCell);
  }

  public void layoutCell(EditorCell cell) {
    layoutSubtree(cell, cell.getX(), cell.getY());
  }

  public void layoutCell(EditorCell cell, final int x, final int y, final int width, final int height) {
    layoutSubtree(cell, (ILayoutable layoutable) -> {
      Size size = new Size(width, height);
      size = size.max(layoutable.getMinSize(size));
      size = size.min(layoutable.getMaxSize(size));
      layoutable.setBounds(x, y, size.getWidth(), size.getHeight());
    });
  }

  public void layoutSubtree(final EditorCell rootCell, final int x, final int y) {
    layoutSubtree(rootCell, (ILayoutable rootLayoutable) -> {
      int preferredWidth = getPreferredRootWidth() - x + 15;
      preferredWidth = Math.max(preferredWidth, rootLayoutable.getMinSize(Size.UNLIMITED_SIZE).getWidth());
      Size preferredSize = rootLayoutable.getPreferredSize(Size.limitedWidth(preferredWidth));
      Style style = rootCell.getStyle();

      if (rootLayoutable.getParent() == null && style.get(FULL_WIDTH_ROOT)) {
        preferredSize = preferredSize.deriveWidth(preferredWidth);
      }
      rootLayoutable.setBounds(x, y, preferredSize.getWidth(), preferredSize.getHeight());
    });
  }

  public Size getPreferredSize(final EditorCell rootCell) {
    final Wrappers._T<Size> result = new Wrappers._T<Size>(null);
    LayoutWatchdog.enter(LayoutWatchdog.DEFAULT_MAX_LAYOUTING_OPERATIONS, () -> {
      preprocessAllCells(rootCell);

      IEditorCellBasedLayoutable rootLayoutable = LayoutableAdapters.getAdapter(rootCell);
      rootLayoutable.readSyncAll();
      preprocessLayoutables(rootLayoutable);

      result.value = rootLayoutable.getPreferredSize(Size.UNLIMITED_SIZE);
    });
    return result.value;
  }

  public void layoutSubtree(EditorCell rootCell, _FunctionTypes._void_P1_E0<? super ILayoutable> boundsSetter) {
    try {
      layoutSubtreeUnsafe(rootCell, boundsSetter);
    } catch (Exception ex) {
      if (LOG.isDebugLevel()) {
        LOG.debug("Layouting failed. Clearing caches and trying again.", ex);
      }
      clearCaches(rootCell);
      layoutSubtreeUnsafe(rootCell, boundsSetter);
    }
  }

  protected void layoutSubtreeUnsafe(final EditorCell rootCell, final _FunctionTypes._void_P1_E0<? super ILayoutable> boundsSetter) {
    LayoutWatchdog.enter(LayoutWatchdog.DEFAULT_MAX_LAYOUTING_OPERATIONS, () -> {
      preprocessAllCells(rootCell);

      IEditorCellBasedLayoutable rootLayoutable = LayoutableAdapters.getAdapter(rootCell);
      rootLayoutable.readSyncAll();
      try {
        preprocessLayoutables(rootLayoutable);

        boundsSetter.invoke(rootLayoutable);
        rootLayoutable.relayout(LayoutableExtensions.getSize(rootLayoutable));
        LayoutableExtensions.visitAll(rootLayoutable, (ILayoutable layoutable) -> {
          LayoutBoxFrame marginBox = layoutable.getBoxModel().getMarginBox();
          int ascent = layoutable.getAscent(LayoutBoxExtensions.getSize(marginBox));
          marginBox.setAscent(ascent);
        });
      } finally {
        rootLayoutable.writeSyncAll();
        LayoutableExtensions.visitAll(rootLayoutable, (ILayoutable layoutable) -> layoutable.setChanged(false));
        if (rootCell instanceof EditorCell_Collection) {
          CellLayoutUtil.fixBoundsForOverflow(((EditorCell_Collection) rootCell));
        }
        CellLayoutUtil.clearRelayoutRequests(rootCell);
      }
    });
  }

  public void clearCaches(EditorCell cell) {
    LayoutableAdapters.clear(cell);
    EditorCellBoxModel.clear(cell);
    cell.requestRelayout();
    if (cell instanceof EditorCell_Collection) {
      for (EditorCell child : Sequence.fromIterable(((EditorCell_Collection) cell))) {
        clearCaches(child);
      }
    }
  }

  protected int getPreferredRootWidth() {
    return EditorSettings.getInstance().getVerticalBoundWidth();
  }

  public void preprocessAllCells(EditorCell cell) {
    if (cell instanceof EditorCell_Collection) {
      for (EditorCell child : Sequence.fromIterable(((EditorCell_Collection) cell))) {
        preprocessAllCells(child);
      }
    } else {
      // font family
      if (cell instanceof EditorCell_Label) {
        String fontFamily = cell.getStyle().get(FONT_FAMILY);
        if (fontFamily != null) {
          CellLayoutUtil.setFontFamily(((EditorCell_Label) cell), fontFamily);
        }
      }
    }
  }

  public void preprocessLayoutables(ILayoutable root) {
    final List<ILayoutableContainer> changedGridLayouts = ListSequence.fromList(new ArrayList<ILayoutableContainer>());

    LayoutableExtensions.visitChanged(root, (ILayoutable layoutable) -> {
      EditorCell editorCell = ((IEditorCellBasedLayoutable) layoutable).getEditorCell();
      Style style = editorCell.getStyle();
      BoxModel boxModel = layoutable.getBoxModel();

      for (ILayoutable child : ListSequence.fromList(check_dlgkye_a4a0a0c0eb(as_dlgkye_a0a0e0b0c0fb(layoutable, ILayoutableContainer.class)))) {
        if (child.isGrowX() || child.isGrowY()) {
          child.setChanged(true);
        }
      }
      if (layoutable.isChanged() && check_dlgkye_a0a5a0a0c0eb(as_dlgkye_a0a0a5a1a2a13(layoutable, ILayoutableContainer.class)) instanceof GridLayout) {
        ListSequence.fromList(changedGridLayouts).addElement(((ILayoutableContainer) layoutable));
      }
      initPadding(layoutable);

      // margin
      LayoutBoxFrame marginBox = boxModel.getMarginBox();
      marginBox.setFrameSize(style.get(MARGIN));
      if (style.isSpecified(MARGIN_TOP)) {
        marginBox.setTopSize(style.get(MARGIN_TOP));
      }
      if (style.isSpecified(MARGIN_BOTTOM)) {
        marginBox.setBottomSize(style.get(MARGIN_BOTTOM));
      }
      if (style.isSpecified(MARGIN_LEFT)) {
        marginBox.setLeftSize(style.get(MARGIN_LEFT));
      }
      if (style.isSpecified(MARGIN_RIGHT)) {
        marginBox.setRightSize(style.get(MARGIN_RIGHT));
      }
    });

    for (ILayoutableContainer gridLayout : ListSequence.fromList(changedGridLayouts)) {
      ListSequence.fromList(gridLayout.getChildren()).visitAll((it) -> LayoutableExtensions.visitAll(it, (ILayoutable layoutable) -> initPadding(layoutable)));
    }
  }

  protected void initPadding(ILayoutable layoutable) {
    EditorCell editorCell = ((IEditorCellBasedLayoutable) layoutable).getEditorCell();
    BoxModel boxModel = layoutable.getBoxModel();

    for (ILayoutable child : ListSequence.fromList(check_dlgkye_a3a23(as_dlgkye_a0a0d0hb(layoutable, ILayoutableContainer.class)))) {
      ((EditorCellBoxModel) child.getBoxModel()).getAdditionalPadding().setFrameSize(0);
    }

    boxModel.getPaddingBox().setFrameSize(0);

    int gap = CellLayoutUtil.getCellGap(layoutable.getParent());
    int gapL = gap / 2;
    int gapR = gap - gapL;
    if (gapL > 0 || gapR > 0) {
      if (LayoutStylesUtil.getLeftBorderSize(editorCell) == 0) {
        gapL = 0;
      }
      if (LayoutStylesUtil.getRightBorderSize(editorCell) == 0) {
        gapR = 0;
      }

      // prevent (visible) double borders
      if (layoutable instanceof ILayoutableContainer) {
        ILayoutable firstChild = ListSequence.fromList(((ILayoutableContainer) layoutable).getChildren()).first();
        if (firstChild != null) {
          if (LayoutStylesUtil.getLeftBorderSize(((IEditorCellBasedLayoutable) firstChild).getEditorCell()) > 0) {
            gapL = 0;
          }
        }
        ILayoutable lastChild = ListSequence.fromList(((ILayoutableContainer) layoutable).getChildren()).first();
        if (lastChild != null) {
          if (LayoutStylesUtil.getRightBorderSize(((IEditorCellBasedLayoutable) lastChild).getEditorCell()) > 0) {
            gapR = 0;
          }
        }
      }

      if (boxModel.getPaddingBox().getLeftSize() != gapL || boxModel.getPaddingBox().getRightSize() != gapR) {
        boxModel.getPaddingBox().setLeftSize(gapL);
        boxModel.getPaddingBox().setRightSize(gapR);
        layoutable.setChanged(true);
      }
    }
  }
  private static List<ILayoutable> check_dlgkye_a4a0a0c0eb(ILayoutableContainer checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getChildren();
    }
    return null;
  }
  private static ILayouter check_dlgkye_a0a5a0a0c0eb(ILayoutableContainer checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLayouter();
    }
    return null;
  }
  private static List<ILayoutable> check_dlgkye_a3a23(ILayoutableContainer checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getChildren();
    }
    return null;
  }
  private static <T> T as_dlgkye_a0a0e0b0c0fb(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_dlgkye_a0a0a5a1a2a13(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_dlgkye_a0a0d0hb(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
