package com.mbeddr.mpsutil.modellisteners.runtime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.smodel.event.SModelListener;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.extapi.model.SModelDescriptorStub;
import jetbrains.mps.smodel.event.SModelChildEvent;
import jetbrains.mps.smodel.FastNodeFinderManager;
import java.util.Objects;
import jetbrains.mps.smodel.event.SModelReferenceEvent;
import jetbrains.mps.smodel.event.SModelPropertyEvent;
import jetbrains.mps.smodel.event.SModelRenamedEvent;
import jetbrains.mps.smodel.event.SModelRootEvent;
import jetbrains.mps.smodel.event.SModelDevKitEvent;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.smodel.event.SModelImportEvent;
import jetbrains.mps.smodel.event.SModelLanguageEvent;
import jetbrains.mps.smodel.loading.ModelLoadingState;
import org.jetbrains.mps.openapi.model.SReference;

/**
 * Forwards all model events to {@link com.mbeddr.mpsutil.modellisteners.runtime.ListenersCollection#forwardEvent(SAbstractConcept, Class<ListenerType>, IForwarder<ListenerType>) }
 */
public class ForwardingModelListener extends GlobalModelListener implements SModelListener {
  private final ListenersCollection listeners;

  public ForwardingModelListener(ListenersCollection destination) {
    this.listeners = destination;
  }

  @Override
  protected void addListener(SModel model) {
    ((SModelDescriptorStub) model).addModelListener(this);
  }

  @Override
  protected void removeListener(SModel model) {
    ((SModelDescriptorStub) model).removeModelListener(this);
  }

  @Override
  public void beforeChildRemoved(final SModelChildEvent event) {
    listeners.forwardEvent(event.getParent().getConcept(), IChildListener.class, new IForwarder<IChildListener>() {
      public void forward(IChildListener listener) {
        if (roleMatches(listener, event)) {
          listener.beforeChildRemoved(event.getParent(), event.getChild());
        }
      }
    });
  }

  @Override
  public void childAdded(final SModelChildEvent event) {
    listeners.forwardEvent(event.getParent().getConcept(), IChildListener.class, new IForwarder<IChildListener>() {
      public void forward(IChildListener listener) {
        if (roleMatches(listener, event)) {
          listener.childAdded(event.getParent(), event.getChild());
        }
      }
    });
  }

  @Override
  public void childRemoved(final SModelChildEvent event) {
    listeners.forwardEvent(event.getParent().getConcept(), IChildListener.class, new IForwarder<IChildListener>() {
      public void forward(IChildListener listener) {
        if (roleMatches(listener, event)) {
          listener.childRemoved(event.getParent(), event.getChild());
        }
      }
    });
    FastNodeFinderManager.dispose(event.getModel());
  }

  protected static boolean roleMatches(IChildListener listener, SModelChildEvent event) {
    return listener.getRole() == null || Objects.equals(listener.getRole(), event.getAggregationLink());
  }
  protected static boolean roleMatches(IReferenceListener listener, SModelReferenceEvent event) {
    return listener.getRole() == null || Objects.equals(listener.getRole(), event.getReference().getLink());
  }
  protected static boolean roleMatches(IPropertyListener listener, SModelPropertyEvent event) {
    return listener.getProperty() == null || Objects.equals(listener.getProperty().getName(), event.getPropertyName());
  }

  @Override
  public void beforeModelDisposed(SModel model) {
  }
  @Override
  public void beforeModelRenamed(SModelRenamedEvent event) {
  }
  @Override
  public void beforeRootRemoved(final SModelRootEvent event) {
    listeners.forwardEvent(event.getRoot().getConcept(), IRootBeforeRemovedListener.class, new IForwarder<IRootBeforeRemovedListener>() {
      public void forward(IRootBeforeRemovedListener listener) {
        listener.beforeRootRemoved(event.getRoot(), event.getModel());
      }
    });
  }
  @Override
  public void devkitAdded(SModelDevKitEvent event) {
  }
  @Override
  public void devkitRemoved(SModelDevKitEvent event) {
  }
  @NotNull
  @Override
  public SModelListener.SModelListenerPriority getPriority() {
    return SModelListener.SModelListenerPriority.CLIENT;
  }
  @Override
  public void importAdded(SModelImportEvent event) {
  }
  @Override
  public void importRemoved(SModelImportEvent event) {
  }
  @Override
  public void languageAdded(SModelLanguageEvent event) {
  }
  @Override
  public void languageRemoved(SModelLanguageEvent event) {
  }
  @Override
  public void modelLoadingStateChanged(SModel model, ModelLoadingState state) {
  }
  @Override
  public void modelRenamed(SModelRenamedEvent event) {
  }
  @Override
  public void modelSaved(SModel model) {
  }
  @Override
  public void propertyChanged(final SModelPropertyEvent event) {
    listeners.forwardEvent(event.getNode().getConcept(), IPropertyListener.class, new IForwarder<IPropertyListener>() {
      public void forward(IPropertyListener listener) {
        if (roleMatches(listener, event)) {
          listener.propertyChanged(event.getNode(), event.getPropertyName(), event.getOldPropertyValue(), event.getNewPropertyValue());
        }
      }
    });
  }
  @Override
  public void referenceAdded(final SModelReferenceEvent event) {
    final SReference reference = event.getReference();
    listeners.forwardEvent(reference.getSourceNode().getConcept(), IReferenceAddedListener.class, new IForwarder<IReferenceAddedListener>() {
      public void forward(IReferenceAddedListener listener) {
        if (roleMatches(listener, event)) {
          listener.referenceAdded(reference.getSourceNode(), reference.getTargetNode(), reference.getLink());
        }
      }
    });
  }
  @Override
  public void referenceRemoved(final SModelReferenceEvent event) {
    final SReference reference = event.getReference();
    listeners.forwardEvent(reference.getSourceNode().getConcept(), IReferenceRemovedListener.class, new IForwarder<IReferenceRemovedListener>() {
      public void forward(IReferenceRemovedListener listener) {
        if (roleMatches(listener, event)) {
          listener.referenceRemoved(reference.getSourceNode(), reference.getTargetNode(), reference.getLink());
        }
      }
    });
  }
  @Deprecated
  @Override
  public void rootAdded(final SModelRootEvent event) {
    listeners.forwardEvent(event.getRoot().getConcept(), IRootAddedListener.class, new IForwarder<IRootAddedListener>() {
      public void forward(IRootAddedListener listener) {
        listener.rootAdded(event.getRoot(), event.getModel());
      }
    });
  }
  @Deprecated
  @Override
  public void rootRemoved(final SModelRootEvent event) {
    listeners.forwardEvent(event.getRoot().getConcept(), IRootRemovedListener.class, new IForwarder<IRootRemovedListener>() {
      public void forward(IRootRemovedListener listener) {
        listener.rootRemoved(event.getRoot(), event.getModel());
      }
    });
  }

}
