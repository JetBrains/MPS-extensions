package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import de.itemis.mps.editor.diagram.runtime.model.IDiagramCell;
import de.itemis.mps.editor.diagram.runtime.model.IScalingInfo;
import de.itemis.mps.editor.diagram.runtime.model.DiagramModel;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import de.itemis.mps.editor.celllayout.runtime.LayoutInterceptor;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import de.itemis.mps.editor.diagram.runtime.coordinates.ICoordinateSystem;
import com.mxgraph.model.mxCell;
import com.mxgraph.view.mxGraph;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.awt.Graphics;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import de.itemis.mps.editor.diagram.runtime.ContextVariables;

public abstract class BaseDiagramECell extends SelectionHandlerWrapperCell implements IDiagramCell, IScalingInfo {
  public static final String CONTEXT_GRAPH_VARIABLE_KEY = BaseDiagramECell.class.getName() + "/contextGraph";

  protected DiagramModel myModel;

  public BaseDiagramECell(EditorContext context, SNode node, DiagramModel model) {
    super(context, node);
    myModel = model;
    LayoutInterceptor.installRecursive(this);
    this.getStyle().set(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.celllayout.styles", "-custom-border-painting"), true);
  }

  protected void handleSelection() {
  }

  public DiagramModel getDiagramModel() {
    return myModel;
  }

  public JGraphModelSynchronizer getSynchronizer() {
    return JGraphModelSynchronizer.getSynchronizer(myModel);
  }

  public DiagramModel getModel() {
    return myModel;
  }

  @Override
  public void clearFixedSize() {
  }

  @Override
  public void setFixedSize(double width, double height) {
  }

  @Override
  @Nullable
  public Tuples._2<Double, Double> getFixedSize() {
    return null;
  }

  @Override
  public void requestRelayout() {
    super.requestRelayout();
  }

  public abstract RootDiagramECell getRootDiagramCell();
  public abstract ICoordinateSystem getCoordinateSystem();
  public abstract mxCell getDCell(mxGraph graph);
  public mxCell getDCell() {
    return getDCell(getContextGraph());
  }

  protected Iterable<EditorCell> getElementRootCells() {
    return Sequence.fromIterable(myModel.getElements()).select((it) -> it.getRootCell()).where((it) -> it != null);
  }

  protected void addCellsFromModel() {
    Sequence.fromIterable(getElementRootCells()).visitAll((it) -> addEditorCell(it));
  }

  @Override
  protected void paintChildCells(Graphics graphics, ParentSettings settings) {
    // they are painted by the diagram component
  }

  @Override
  protected void paintChildDecorations(Graphics graphics) {
    // they are painted by the diagram component
  }

  public MyGraph getContextGraph() {
    MyGraph graph = (MyGraph) check_4z296a_a0a0a53(ContextVariables.getCurrent(), CONTEXT_GRAPH_VARIABLE_KEY);
    if (graph == null) {
      if (getRootDiagramCell() != null) {
        graph = getRootDiagramCell().getGraph();
      } else {
        graph = DiagramCreationContext.getRootGraph();
      }
    }
    if (graph == null) {
      throw new RuntimeException("Context graph not set");
    }
    return graph;
  }

  public static void withContextGraph(MyGraph graph, Runnable runnable) {
    ContextVariables.withValue(CONTEXT_GRAPH_VARIABLE_KEY, graph, runnable);
  }

  public boolean allowScaling() {
    return false;
  }
  private static Object check_4z296a_a0a0a53(ContextVariables checkedDotOperand, String CONTEXT_GRAPH_VARIABLE_KEY) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getValue(CONTEXT_GRAPH_VARIABLE_KEY);
    }
    return null;
  }
}
