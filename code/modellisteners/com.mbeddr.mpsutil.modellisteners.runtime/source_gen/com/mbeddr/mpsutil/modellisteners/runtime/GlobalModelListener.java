package com.mbeddr.mpsutil.modellisteners.runtime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.module.SRepositoryListener;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.module.SModuleListener;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.Set;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.Sequence;

public abstract class GlobalModelListener {

  protected SRepositoryListener repositoryListener = new SRepositoryListener() {
    public void moduleAdded(@NotNull SModule m) {
      start(m);
    }
    public void beforeModuleRemoved(@NotNull SModule m) {
      stop(m);
    }
  };
  protected SModuleListener moduleListener = new SModuleListener() {
    public void modelAdded(SModule module, SModel model) {
      start(model);
    }
    public void beforeModelRemoved(SModule module, SModel model) {
      stop(model);
    }
  };

  protected Set<SRepository> myRepositories = SetSequence.fromSet(new HashSet<SRepository>());
  protected Set<SModule> myModules = SetSequence.fromSet(new HashSet<SModule>());
  protected Set<SModel> myModels = SetSequence.fromSet(new HashSet<SModel>());

  public GlobalModelListener() {
  }

  public void start(final SRepository repo) {
    if (SetSequence.fromSet(myRepositories).contains(repo)) {
      return;
    }
    SetSequence.fromSet(myRepositories).addElement(repo);

    repo.addRepositoryListener(repositoryListener);
    repo.getModelAccess().runReadAction(() -> {
      for (SModule module : Sequence.fromIterable(repo.getModules())) {
        start(module);
      }
    });
  }

  public void start(SModule module) {
    if (SetSequence.fromSet(myModules).contains(module)) {
      return;
    }
    SetSequence.fromSet(myModules).addElement(module);

    module.addModuleListener(moduleListener);
    for (SModel model : Sequence.fromIterable(module.getModels())) {
      start(model);
    }
  }

  public void start(SModel model) {
    if (SetSequence.fromSet(myModels).contains(model)) {
      return;
    }
    SetSequence.fromSet(myModels).addElement(model);

    addListener(model);
  }

  protected abstract void addListener(SModel model);

  public void stop() {
    SetSequence.fromSet(myModels).visitAll((it) -> removeListener(it));
    SetSequence.fromSet(myModules).visitAll((it) -> it.removeModuleListener(moduleListener));
    SetSequence.fromSet(myRepositories).visitAll((it) -> it.removeRepositoryListener(repositoryListener));
    SetSequence.fromSet(myModels).clear();
    SetSequence.fromSet(myModules).clear();
    SetSequence.fromSet(myRepositories).clear();
  }

  public void stop(SRepository repo) {
    if (!(SetSequence.fromSet(myRepositories).contains(repo))) {
      return;
    }
    SetSequence.fromSet(myRepositories).removeElement(repo);

    repo.removeRepositoryListener(repositoryListener);
    for (SModule module : Sequence.fromIterable(repo.getModules())) {
      stop(module);
    }
  }

  public void stop(SModule module) {
    if (!(SetSequence.fromSet(myModules).contains(module))) {
      return;
    }
    SetSequence.fromSet(myModules).removeElement(module);

    module.removeModuleListener(moduleListener);
    for (SModel model : Sequence.fromIterable(module.getModels())) {
      stop(model);
    }
  }

  public void stop(SModel model) {
    if (!(SetSequence.fromSet(myModels).contains(model))) {
      return;
    }
    SetSequence.fromSet(myModels).removeElement(model);

    removeListener(model);
  }

  protected abstract void removeListener(SModel model);

}
