package com.mbeddr.mpsutil.grammarcells.runtime.plugin;

/*Generated by MPS */

import jetbrains.mps.plugins.part.ApplicationPluginPart;
import com.mbeddr.mpsutil.grammarcells.runtimelang.editor.IArbitraryTextDeleteHandler;
import jetbrains.mps.classloading.ClassLoaderManager;
import jetbrains.mps.classloading.DeployListener;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.mpsutil.grammarcells.runtime.Parser;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.ide.MPSCoreComponents;
import org.jetbrains.annotations.NotNull;
import java.util.Set;
import jetbrains.mps.module.ReloadableModule;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import com.mbeddr.mpsutil.grammarcells.runtime.RulesCache;
import com.mbeddr.mpsutil.grammarcells.runtime.EditorHierachyCache;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.Objects;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import com.mbeddr.mpsutil.grammarcells.runtimelang.editor.ArbitraryTextDeleteAction;
import com.mbeddr.mpsutil.grammarcells.runtime.VisibleLanguagesCache;
import com.mbeddr.mpsutil.grammarcells.runtime.DescriptorCache;

public class ApplicationPlugin_AppPluginPart extends ApplicationPluginPart {
  private IArbitraryTextDeleteHandler deleteHandler;
  private ClassLoaderManager classLoaderManager;
  private DeployListener classesListener;
  private boolean myIsDisposed = false;
  public ApplicationPlugin_AppPluginPart() {
  }
  @Override
  public void init() {

    ApplicationPlugin_AppPluginPart.this.deleteHandler = new IArbitraryTextDeleteHandler() {
      public void delete(SNode annotation) {
        SModel model = SNodeOperations.getModel(annotation);
        SNode parent = SNodeOperations.getParent(annotation);
        SNodeOperations.deleteNode(annotation);
        Parser parser = new Parser(model);
        parser.processAfterTextDelete(parser.findRootExpression(parent));
      }
    };


    ApplicationPlugin_AppPluginPart.this.classLoaderManager = ApplicationManager.getApplication().getComponent(MPSCoreComponents.class).getClassLoaderManager();

    ApplicationPlugin_AppPluginPart.this.classesListener = new DeployListener() {

      @Override
      public void onLoaded(@NotNull Set<ReloadableModule> modules, @NotNull ProgressMonitor monitor) {
        RulesCache.invalidateAll();
        EditorHierachyCache.getInstance().invalidate();

        for (ReloadableModule module : SetSequence.fromSet(modules)) {
          if (Objects.equals(module.getModuleReference(), PersistenceFacade.getInstance().createModuleReference("7ac49bcb-77fb-4f0f-9036-e31b86b854b2(com.mbeddr.mpsutil.grammarcells.runtime)"))) {
            ArbitraryTextDeleteAction.setHandler(ApplicationPlugin_AppPluginPart.this.deleteHandler);
            break;
          }
        }
      }
      @Override
      public void onUnloaded(@NotNull Set<ReloadableModule> modules, @NotNull ProgressMonitor monitor) {
        for (ReloadableModule module : SetSequence.fromSet(modules)) {
          if (Objects.equals(module.getModuleReference(), PersistenceFacade.getInstance().createModuleReference("7ac49bcb-77fb-4f0f-9036-e31b86b854b2(com.mbeddr.mpsutil.grammarcells.runtime)"))) {
            ApplicationPlugin_AppPluginPart.this.myIsDisposed = true;
            ArbitraryTextDeleteAction.setHandler(null);
            ApplicationPlugin_AppPluginPart.this.classLoaderManager.removeListener(ApplicationPlugin_AppPluginPart.this.classesListener);
            VisibleLanguagesCache.getInstance().dispose();
            break;
          }
        }

        RulesCache.invalidateAll();
        EditorHierachyCache.getInstance().invalidate();
      }
    };
    ApplicationPlugin_AppPluginPart.this.classLoaderManager.addListener(ApplicationPlugin_AppPluginPart.this.classesListener);

    ArbitraryTextDeleteAction.setHandler(ApplicationPlugin_AppPluginPart.this.deleteHandler);
  }
  @Override
  public void dispose() {
    if (!(ApplicationPlugin_AppPluginPart.this.myIsDisposed)) {
      ArbitraryTextDeleteAction.setHandler(null);
      ApplicationPlugin_AppPluginPart.this.classLoaderManager.removeListener(ApplicationPlugin_AppPluginPart.this.classesListener);
      VisibleLanguagesCache.getInstance().dispose();
      RulesCache.invalidateAll();
      DescriptorCache.getInstance().dispose();
      ApplicationPlugin_AppPluginPart.this.myIsDisposed = true;
    }
  }
}
