package de.q60.mps.shadowmodels.runtime.engine;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Objects;

public class ExternalLabelReferenceTarget implements IReferenceTarget {
  private TransformationCall transformation;
  private String label;

  private ExternalLabelReferenceTarget() {
    // for deserialization
  }

  public ExternalLabelReferenceTarget(TransformationCall transformation, String label) {
    this.transformation = transformation;
    this.label = label;
  }

  @Override
  public IOutputNodeReference resolve(IScope sourceScope, ITransformationEngine engine) {
    final ISubgraphStage stage = sourceScope.getStage(engine);
    if (stage == null) {
      return null;
    }
    List<IOutputNodeReference> outputNodes = Sequence.fromIterable(stage.resolveContent(transformation)).select(new _FunctionTypes._return_P1_E0<ITransformationResult, IUniqueContainmentTarget>() {
      public ITransformationResult invoke(IUniqueContainmentTarget it) {
        return stage.getTransformationResult(it);
      }
    }).select((it) -> it.getLabeledElement(label)).where(new NotNullWhereFilter()).select((it) -> it.getCanonicalReference()).toList();
    if (ListSequence.fromList(outputNodes).count() == 0) {
      return null;
    } else if (ListSequence.fromList(outputNodes).count() == 1) {
      return ListSequence.fromList(outputNodes).first();
    } else {
      throw new RuntimeException("Multiple output nodes found for " + this);
    }
  }

  @Override
  public String toString() {
    return transformation + "#" + label;
  }

  private transient int _cachedHashCode;
  private transient boolean _hashCodeInitialized = false;
  @Override
  public int hashCode() {
    if (!(_hashCodeInitialized)) {
      int c = 0;
      c = 31 * c + Objects.hashCode(label);
      c = 31 * c + Objects.hashCode(transformation);
      _cachedHashCode = c;
      _hashCodeInitialized = true;
    }
    return _cachedHashCode;
  }
  @Override
  public boolean equals(Object o) {
    if (this == o) {
      return true;
    }
    if (o == null || this.getClass() != o.getClass()) {
      return false;
    }
    ExternalLabelReferenceTarget that = (ExternalLabelReferenceTarget) o;
    if (!(Objects.equals(label, that.label))) {
      return false;
    }
    if (!(Objects.equals(transformation, that.transformation))) {
      return false;
    }
    return true;
  }
}
