package de.slisson.mps.richtext.editor;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import de.itemis.mps.editor.celllayout.runtime.CellLayoutUtil;
import de.slisson.mps.editor.multiline.cells.MultilineLayout;
import de.slisson.mps.richtext.runtime.selection.ShiftSelector;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.editor.runtime.cells.AbstractCellAction;
import jetbrains.mps.openapi.editor.EditorContext;
import de.slisson.mps.editor.multiline.cells.EditorCell_Multiline;
import jetbrains.mps.openapi.editor.cells.CellTraversalUtil;
import jetbrains.mps.openapi.editor.cells.CellAction;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import de.slisson.mps.richtext.runtime.selection.RichtextSelection;
import de.slisson.mps.richtext.behavior.Text__BehaviorDescriptor;
import jetbrains.mps.openapi.editor.cells.EditorCell_Label;
import de.slisson.mps.richtext.util.RichtextUtil;
import jetbrains.mps.editor.runtime.cells.EmptyCellAction;
import jetbrains.mps.editor.runtime.deletionApprover.DeletionApproverUtil;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import de.slisson.mps.editor.multiline.cells.WordCellInitializer;
import de.slisson.mps.editor.multiline.cells.EditorCell_Word;
import de.slisson.mps.richtext.runtime.selection.RichtextPasteAction;
import java.util.ArrayList;
import de.slisson.mps.richtext.runtime.WordCellSubstituteInfo;
import de.slisson.mps.richtext.runtime.vcs.DiffPainter;
import jetbrains.mps.openapi.editor.selection.Selection;
import java.util.Objects;
import jetbrains.mps.nodeEditor.NodeEditorActions;
import java.util.LinkedList;
import jetbrains.mps.nodeEditor.selection.EditorCellLabelSelection;
import org.jetbrains.mps.util.Condition;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import javax.swing.SwingUtilities;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class TextCellModifier {
  public static void modify(EditorCell cell) {
    cell.setAction(CellActionType.COPY, new CopyAction(cell));
    cell.setAction(CellActionType.PASTE, new PasteAction(cell));
    for (EditorCell iwordCell : Sequence.fromIterable((EditorCell_Collection) cell)) {
      modifyIWordCell(iwordCell);
    }

    // Replace the indent cell layout to apply some custom changes to the default behavior
    // (where to wrap lines, no indentation after wrapping, ...)
    CellLayoutUtil.setLayout(((EditorCell_Collection) cell), new MultilineLayout());

    ShiftSelector.install((EditorComponent) cell.getEditorComponent());

    cell.setAction(CellActionType.SELECT_ALL, new SelectAllAction(cell));


    cell.setAction(CellActionType.HOME, new StartOfLineAction(cell));
    cell.setAction(CellActionType.END, new EndOfLineAction(cell));
    cell.setAction(CellActionType.ROOT_HOME, new StartOfTextAction(cell));
    cell.setAction(CellActionType.ROOT_END, new EndOfTextAction(cell));
  }

  public static void modifyIWordCell(final EditorCell cell) {
    cell.setAction(CellActionType.DELETE, new AbstractCellAction() {
      public void execute(EditorContext context) {
        // Fix for non working heuristic in EditorCellLabelSelection.processSideDeletes
        if (cell instanceof EditorCell_Multiline) {
          EditorCell selectedCell = context.getSelectedCell();
          if (!(CellTraversalUtil.isAncestorOrEquals(cell, selectedCell))) {
            CellAction selectedCellAction = selectedCell.getAction(CellActionType.DELETE);
            if (selectedCellAction != null && selectedCellAction.canExecute(context)) {
              selectedCellAction.execute(context);
              return;
            }
          }
        }

        SNode nodeToDelete = cell.getSNode();
        while ((SNodeOperations.getParent(nodeToDelete) != null) && (!(SNodeOperations.getContainingLink(nodeToDelete).isMultiple()) && !(SNodeOperations.getContainingLink(nodeToDelete).isOptional()))) {
          nodeToDelete = SNodeOperations.getParent(nodeToDelete);
        }
        SNode parent = SNodeOperations.getParent(nodeToDelete);
        List<EditorCell> ancestors = CellTraversalUtil.getParents(cell, true);
        EditorCell wordCell = ListSequence.fromList(ancestors).subtract(ListSequence.fromList(CellTraversalUtil.getParents(cell, false))).last();
        RichtextSelection.create(wordCell, wordCell).executeDeleteSelected();

        context.flushEvents();
        Text__BehaviorDescriptor.ensureNormalized_id1xf6IA5Se_N.invoke(SNodeOperations.getNodeAncestor(parent, CONCEPTS.Text$bD, true, false), context);
      }
    });
    cell.setAction(CellActionType.BACKSPACE, cell.getAction(CellActionType.DELETE));

    // A delete on a constant cell deletes the node
    for (EditorCell_Label constantCell : ListSequence.fromList(RichtextUtil.getAllConstantCells(cell))) {
      final EditorCell constantCell_ = constantCell;
      CellAction prevAction = constantCell.getAction(CellActionType.DELETE);
      if (prevAction == null || prevAction instanceof EmptyCellAction || prevAction instanceof AbstractCellAction) {
        CellAction deleteAction = new AbstractCellAction() {
          public void execute(EditorContext context) {
            SNode node = constantCell_.getSNode();
            if (DeletionApproverUtil.approve(context, node)) {
              return;
            }
            List<EditorCell> ancestors = CellTraversalUtil.getParents(constantCell_, true);
            EditorCell wordCell = ListSequence.fromList(ancestors).subtract(ListSequence.fromList(CellTraversalUtil.getParents(cell, false))).last();
            RichtextSelection.create(wordCell, wordCell).executeDeleteSelected();
          }
        };
        constantCell.setAction(CellActionType.DELETE, deleteAction);
        constantCell_.setAction(CellActionType.BACKSPACE, deleteAction);
      }
    }

    // remove spaces from the indent layout between plain text and other nodes
    if (!(cell instanceof EditorCell_Multiline)) {
      EditorCell firstLeaf = CellTraversalUtil.getFirstLeaf(cell);
      EditorCell lastLeaf = CellTraversalUtil.getLastLeaf(cell);
      if (firstLeaf != null) {
        boolean editable = !(firstLeaf instanceof jetbrains.mps.nodeEditor.cells.EditorCell_Label) || isEditable((jetbrains.mps.nodeEditor.cells.EditorCell_Label) firstLeaf);
        firstLeaf.getStyle().set(StyleAttributes.PUNCTUATION_LEFT, true);
        firstLeaf.getStyle().set(StyleAttributes.FIRST_POSITION_ALLOWED, true);
      }
      if (lastLeaf != null) {
        boolean editable = !(lastLeaf instanceof jetbrains.mps.nodeEditor.cells.EditorCell_Label) || isEditable((jetbrains.mps.nodeEditor.cells.EditorCell_Label) lastLeaf);
        lastLeaf.getStyle().set(StyleAttributes.PUNCTUATION_RIGHT, true);
        lastLeaf.getStyle().set(StyleAttributes.LAST_POSITION_ALLOWED, true);
      }

    }

    // Override some actions of the EditorCell_Word to make selections work with embedded nodes
    if (cell instanceof EditorCell_Multiline) {
      EditorCell_Multiline mlCell = ((EditorCell_Multiline) cell);
      mlCell.addWordCellInitializer(new WordCellInitializer() {
        public void initialize(EditorCell_Word wordCell) {
          wordCell.setAction(CellActionType.PASTE, new RichtextPasteAction(wordCell));

          List<CellActionType> actionTypes = ListSequence.fromList(new ArrayList<CellActionType>());
          ListSequence.fromList(actionTypes).addElement(CellActionType.SELECT_LEFT);
          ListSequence.fromList(actionTypes).addElement(CellActionType.SELECT_RIGHT);
          ListSequence.fromList(actionTypes).addElement(CellActionType.SELECT_UP);
          ListSequence.fromList(actionTypes).addElement(CellActionType.SELECT_DOWN);
          ListSequence.fromList(actionTypes).addElement(CellActionType.SELECT_PREVIOUS);
          ListSequence.fromList(actionTypes).addElement(CellActionType.SELECT_NEXT);
          ListSequence.fromList(actionTypes).addElement(CellActionType.SELECT_LOCAL_HOME);
          ListSequence.fromList(actionTypes).addElement(CellActionType.SELECT_LOCAL_END);
          ListSequence.fromList(actionTypes).addElement(CellActionType.SELECT_HOME);
          ListSequence.fromList(actionTypes).addElement(CellActionType.SELECT_END);
          for (CellActionType actionType : ListSequence.fromList(actionTypes)) {
            wordCell.setAction(actionType, new MultilineWordCell_SelectAction(actionType, wordCell));
          }

          // substitute info
          wordCell.setSubstituteInfo(new WordCellSubstituteInfo(wordCell));
        }
      });
    }

    // VCS support
    if (cell instanceof EditorCell_Multiline) {
      ((EditorCell_Multiline) cell).addBackgroundPainter(new DiffPainter());
      ((EditorCell_Multiline) cell).disabledDiffPainting();
    }

    cell.getStyle().set(StyleAttributes.INDENT_LAYOUT_NO_WRAP, true);

    // disable shift+mouse selection of multiline
    if (cell instanceof EditorCell_Multiline) {
      ((EditorCell_Multiline) cell).addWordCellInitializer(new WordCellInitializer() {
        public void initialize(EditorCell_Word wordCell) {
          wordCell.disableShiftSelection(true);
          wordCell.setAction(CellActionType.INSERT, new NewLineHandlerAction(wordCell, wordCell.getActionNoHacks(CellActionType.INSERT)));
          wordCell.setAction(CellActionType.INSERT_BEFORE, new NewLineHandlerAction(wordCell, wordCell.getActionNoHacks(CellActionType.INSERT_BEFORE)));
        }
      });
    } else {
      cell.setAction(CellActionType.SELECT_UP, new RichtextAction(cell) {

        @Override
        public String getDescriptionText() {
          return "Select Up";
        }
        @Override
        public boolean canExecute(EditorContext context) {
          return true;
        }
        @Override
        public void execute(EditorContext context) {
          SNode selectedNode = context.getSelectedNode();
          SNode iword = SNodeOperations.getNodeAncestor(selectedNode, CONCEPTS.IWord$8d, true, false);
          EditorCell iwordCell = context.getEditorComponent().findNodeCell(iword);
          Selection selection = context.getSelectionManager().getSelection();
          if (Objects.equals(context.getSelectedCell(), iwordCell) && selection.isExactlyCoveringCell(iwordCell)) {
            new SelectAllAction(cell).execute(context);
          } else {
            NodeEditorActions.SelectUp selectUpAction = new NodeEditorActions.SelectUp();
            if (selectUpAction.canExecute(context)) {
              selectUpAction.execute(context);
            }
          }
        }
      });
      ListSequence.fromList(getDescendantsIncludingSelf(cell)).visitAll((it) -> {
        it.setAction(CellActionType.SELECT_HOME, new SelectionActions.SelectionHomeAction(cell));
        it.setAction(CellActionType.SELECT_END, new SelectionActions.SelectionEndAction(cell));
      });
    }

  }

  private static List<EditorCell> getDescendantsIncludingSelf(EditorCell cell) {
    List<EditorCell> cells = ListSequence.fromList(new LinkedList<EditorCell>());
    ListSequence.fromList(cells).addElement(cell);
    if (cell instanceof EditorCell_Collection) {
      for (EditorCell childCell : Sequence.fromIterable(as_n8knj7_a0a0a2a4(cell, EditorCell_Collection.class))) {
        ListSequence.fromList(cells).addSequence(ListSequence.fromList(getDescendantsIncludingSelf(childCell)));
      }
    }
    return cells;
  }

  public static boolean isEditable(EditorCell_Label cell) {
    return cell.isEditable() && !(cell.getStyle().get(StyleAttributes.READ_ONLY));
  }

  public static EditorCell_Label getSelectedLabel(EditorContext context) {
    EditorCellLabelSelection selection = as_n8knj7_a0a0a8(context.getSelectionManager().getSelection(), EditorCellLabelSelection.class);
    if (selection == null) {
      return null;
    }
    if (selection.getSelectionStart() != selection.getSelectionEnd()) {
      return null;
    }
    return selection.getEditorCellLabel();
  }

  public static abstract class RichtextAction implements CellAction {
    protected Condition<EditorCell> isRichtextDescendant = new Condition<EditorCell>() {
      public boolean met(EditorCell cell) {
        return CellTraversalUtil.isAncestor(myCell, cell);
      }
    };

    protected EditorCell myCell;

    public RichtextAction(EditorCell richtextCell) {
      myCell = richtextCell;
    }

    public boolean executeInCommand() {
      return false;
    }
  }

  public static class PasteAction extends RichtextAction {
    public PasteAction(EditorCell richtextCell) {
      super(richtextCell);
    }

    public boolean canExecute(EditorContext context) {
      return true;
    }

    @Override
    public void execute(final EditorContext context) {
      {
        final SNode text = context.getSelectedNode();
        if (SNodeOperations.isInstanceOf(text, CONCEPTS.Text$bD)) {
          ListSequence.fromList(SLinkOperations.getChildren(text, LINKS.words$C8QZ)).clear();
          SLinkOperations.addNewChild(text, LINKS.words$C8QZ, CONCEPTS.Word$5r);
          context.flushEvents();
          context.getSelectionManager().getSelection().executeAction(CellActionType.PASTE);
        }
      }
      {
        final SNode word = context.getSelectedNode();
        if (SNodeOperations.isInstanceOf(word, CONCEPTS.IWord$8d)) {
          context.getSelectionManager().getSelection().executeAction(CellActionType.DELETE);
          SwingUtilities.invokeLater(() -> context.getSelectionManager().getSelection().executeAction(CellActionType.PASTE));

        }
      }
    }

    public String getDescriptionText() {
      return "Paste Text";
    }

  }


  public static class CopyAction extends RichtextAction {
    public CopyAction(EditorCell richtextCell) {
      super(richtextCell);
    }

    public boolean canExecute(EditorContext context) {
      return true;
    }

    @Override
    public void execute(EditorContext context) {
      {
        final SNode text = context.getSelectedNode();
        if (SNodeOperations.isInstanceOf(text, CONCEPTS.Text$bD)) {
          EditorCell_Label firstLeaf = as_n8knj7_a0a0a1a0a4p(CellTraversalUtil.getFirstLeaf(myCell), EditorCell_Label.class);
          EditorCell_Label lastLeaf = as_n8knj7_a0a1a1a0a4p(CellTraversalUtil.getLastLeaf(myCell), EditorCell_Label.class);
          RichtextSelection richSelection = RichtextSelection.create(firstLeaf, 0, lastLeaf, lastLeaf.getText().length());
          richSelection.copySelectedNodes();
        }
      }
    }

    public String getDescriptionText() {
      return "Copy all the Text";
    }

    private static <T> T as_n8knj7_a0a0a1a0a4p(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
    private static <T> T as_n8knj7_a0a1a1a0a4p(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
  }

  public static class StartOfTextAction extends RichtextAction {
    public StartOfTextAction(EditorCell richtextCell) {
      super(richtextCell);
    }
    public boolean canExecute(EditorContext context) {
      EditorCell_Label selected = getSelectedLabel(context);
      if (selected == null) {
        return false;
      }
      EditorCell_Label firstLeaf = as_n8knj7_a0a2a1r(CellTraversalUtil.getFirstLeaf(myCell), EditorCell_Label.class);
      if (firstLeaf == null) {
        return false;
      }
      if (firstLeaf == selected && firstLeaf.getSelectionStart() == 0 && firstLeaf.getSelectionEnd() == 0) {
        return false;
      }
      return true;
    }
    public void execute(EditorContext context) {
      EditorCell_Label firstLeaf = as_n8knj7_a0a0a2r(CellTraversalUtil.getFirstLeaf(myCell), EditorCell_Label.class);
      context.getSelectionManager().setSelection(firstLeaf, 0);
    }
    public boolean executeInCommand() {
      return false;
    }
    public String getDescriptionText() {
      return "Select Beginning of Text";
    }
    private static <T> T as_n8knj7_a0a2a1r(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
    private static <T> T as_n8knj7_a0a0a2r(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
  }

  public static class SelectAllAction extends RichtextAction {

    public SelectAllAction(EditorCell richtextCell) {
      super(richtextCell);
    }

    public boolean canExecute(EditorContext context) {
      return true;
    }

    public void execute(EditorContext context) {
      SNode selectedNode = context.getSelectedNode();
      Selection selection = context.getSelectionManager().getSelection();
      if (selectedNode == null && selection instanceof RichtextSelection) {
        selectedNode = ListSequence.fromList(((RichtextSelection) selection).getSelectedNodes()).first();
      }
      if (selectedNode == null) {
        return;
      }
      if (!(SNodeOperations.isInstanceOf(selectedNode, CONCEPTS.Text$bD))) {

        SNode text = SNodeOperations.getNodeAncestor(selectedNode, CONCEPTS.Text$bD, false, false);
        EditorCell textCell = context.getEditorComponent().findNodeCell(text);
        context.getSelectionManager().pushSelection(context.getSelectionManager().createSelection(textCell));
      } else {
        NodeEditorActions.SelectAll selectAllAction = new NodeEditorActions.SelectAll();
        if (selectAllAction.canExecute(context)) {
          selectAllAction.execute(context);
        }
      }
    }
    public boolean executeInCommand() {
      return false;
    }
    public String getDescriptionText() {
      return "Select All";
    }
  }


  public static class StartOfLineAction extends RichtextAction {

    public StartOfLineAction(EditorCell richtextCell) {
      super(richtextCell);
    }


    public boolean canExecute(EditorContext context) {
      EditorCell_Label selected = getSelectedLabel(context);
      if (selected == null) {
        return false;
      }
      jetbrains.mps.nodeEditor.cells.EditorCell_Label homeCell = as_n8knj7_a0a2a4w(getHomeCell(selected, isRichtextDescendant), jetbrains.mps.nodeEditor.cells.EditorCell_Label.class);
      return homeCell != null && homeCell.isSelectable();
    }

    public void execute(EditorContext context) {
      EditorCell_Label selected = getSelectedLabel(context);
      jetbrains.mps.nodeEditor.cells.EditorCell_Label homeCell = as_n8knj7_a0a1a6w(getHomeCell(selected, isRichtextDescendant), jetbrains.mps.nodeEditor.cells.EditorCell_Label.class);
      context.getSelectionManager().setSelection(homeCell, 0);
    }
    public boolean executeInCommand() {
      return false;
    }
    public String getDescriptionText() {
      return "Select Start of Line";
    }
    private static <T> T as_n8knj7_a0a2a4w(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
    private static <T> T as_n8knj7_a0a1a6w(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
  }


  public static class EndOfLineAction extends RichtextAction {

    public EndOfLineAction(EditorCell richtextCell) {
      super(richtextCell);
    }


    public boolean canExecute(EditorContext context) {
      EditorCell_Label selected = getSelectedLabel(context);
      if (selected == null) {
        return false;
      }
      jetbrains.mps.nodeEditor.cells.EditorCell_Label endCellCell = as_n8knj7_a0a2a4z(getEndCell(selected, isRichtextDescendant), jetbrains.mps.nodeEditor.cells.EditorCell_Label.class);
      return endCellCell != null && endCellCell.isSelectable();
    }
    public void execute(EditorContext context) {
      EditorCell_Label selected = getSelectedLabel(context);
      jetbrains.mps.nodeEditor.cells.EditorCell_Label endCell = as_n8knj7_a0a1a5z(getEndCell(selected, isRichtextDescendant), jetbrains.mps.nodeEditor.cells.EditorCell_Label.class);
      context.getSelectionManager().setSelection(endCell, endCell.getText().length());
    }
    public boolean executeInCommand() {
      return false;
    }
    public String getDescriptionText() {
      return "Select End of Line";
    }
    private static <T> T as_n8knj7_a0a2a4z(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
    private static <T> T as_n8knj7_a0a1a5z(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
  }

  public static class DeleteToWordEndAction extends RichtextAction {
    public DeleteToWordEndAction(EditorCell richtextCell) {
      super(richtextCell);
    }
    public boolean canExecute(EditorContext context) {
      return true;
    }
    public void execute(EditorContext context) {
      EditorCell_Word selectedWord = as_n8knj7_a0a0a2bb(context.getSelectedCell(), EditorCell_Word.class);
      selectedWord.deleteFollowingCharacter();
    }
    public boolean executeInCommand() {
      return false;
    }
    public String getDescriptionText() {
      return "Delete to Word End";
    }
    private static <T> T as_n8knj7_a0a0a2bb(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
  }


  public static class EndOfTextAction extends RichtextAction {
    public EndOfTextAction(EditorCell richtextCell) {
      super(richtextCell);
    }
    public boolean canExecute(EditorContext context) {
      EditorCell_Label selected = getSelectedLabel(context);
      if (selected == null) {
        return false;
      }
      EditorCell_Label lastLeaf = as_n8knj7_a0a2a1eb(getEndCell(selected, isRichtextDescendant), EditorCell_Label.class);
      if (lastLeaf == null) {
        return false;
      }
      if (lastLeaf == selected && lastLeaf.getSelectionStart() == lastLeaf.getText().length() && lastLeaf.getSelectionEnd() == lastLeaf.getSelectionStart()) {
        return false;
      }
      return true;
    }
    public void execute(EditorContext context) {
      EditorCell_Word lastWord = as_n8knj7_a0a0a2eb(as_n8knj7_a0a0a0a2eb(CellTraversalUtil.getLastLeaf(myCell), EditorCell_Label.class), EditorCell_Word.class);
      int newCaretPosition = lastWord.getText().length();
      if (lastWord.isCaretPositionAllowed(newCaretPosition)) {
        lastWord.setCaretPosition(newCaretPosition);
      }
      context.getSelectionManager().setSelection(lastWord, newCaretPosition);
    }
    public boolean executeInCommand() {
      return false;
    }
    public String getDescriptionText() {
      return "Select End of Text";
    }
    private static <T> T as_n8knj7_a0a2a1eb(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
    private static <T> T as_n8knj7_a0a0a2eb(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
    private static <T> T as_n8knj7_a0a0a0a2eb(Object o, Class<T> type) {
      return (type.isInstance(o) ? (T) o : null);
    }
  }
  public static EditorCell getEndCell(EditorCell thisCell, Condition<EditorCell> condition) {
    EditorCell current = thisCell;
    while (getLeafToRight(current, condition) != null) {
      current = getLeafToRight(current, condition);
    }
    return current;
  }
  public static EditorCell getHomeCell(EditorCell thisCell, Condition<EditorCell> condition) {
    EditorCell current = thisCell;
    while (getLeafToLeft(current, condition) != null) {
      current = getLeafToLeft(current, condition);
    }
    return current;
  }

  public static EditorCell getLeafToLeft(final EditorCell cell, final Condition<EditorCell> condition) {
    return CellTraversalUtil.getPrevLeaf(cell, new Condition<EditorCell>() {
      public boolean met(EditorCell current) {
        return current.isSelectable() && !(isAbove(cell, current)) && !(isBelow(cell, current)) && isToRight(cell, current) && condition.met(current);
      }
    });
  }
  public static EditorCell getLeafToRight(final EditorCell cell, final Condition<EditorCell> condition) {
    return CellTraversalUtil.getNextLeaf(cell, new Condition<EditorCell>() {
      public boolean met(EditorCell current) {
        return current.isSelectable() && !(isAbove(cell, current)) && !(isBelow(cell, current)) && isToLeft(cell, current) && condition.met(current);
      }
    });
  }
  public static boolean isAbove(EditorCell thisCell, EditorCell cell) {
    return thisCell.getY() + thisCell.getHeight() <= cell.getY();
  }
  public static boolean isBelow(EditorCell thisCell, EditorCell cell) {
    return isAbove(cell, thisCell);
  }
  public static boolean isToLeft(EditorCell thisCell, EditorCell cell) {
    return thisCell.getX() + thisCell.getWidth() <= cell.getX();
  }
  public static boolean isToRight(EditorCell thisCell, EditorCell cell) {
    return isToLeft(cell, thisCell);
  }

  public static class NewLineHandlerAction implements CellAction {
    private EditorCell_Word myWordCell;
    private CellAction myDefaultAction;

    public NewLineHandlerAction(EditorCell_Word wordCell, CellAction defaultAction) {
      myWordCell = wordCell;
      myDefaultAction = defaultAction;
    }

    private INewLineHandler getHandler() {
      return myWordCell.getStyle().get(StyleAttributes.getInstance().<INewLineHandler>getAttribute("de.slisson.mps.richtext", "new-line-handler"));
    }

    public boolean hasHandler() {
      return getHandler() != null;
    }

    @Override
    public boolean executeInCommand() {
      return (hasHandler() ? true : myDefaultAction.executeInCommand());
    }

    public void execute(EditorContext context) {
      INewLineHandler handler = getHandler();
      if (handler == null) {
        myDefaultAction.execute(context);
      } else {
        EditorCell_Multiline multilineCell = myWordCell.getParent();
        EditorCell_Collection textCell = multilineCell.getParent();
        SNode textNode = SNodeOperations.as(textCell.getSNode(), CONCEPTS.Text$bD);
        if (textNode == null) {
          textCell = null;
        }
        handler.handle(textNode, textCell, multilineCell, myWordCell);
      }
    }

    public String getDescriptionText() {
      return (hasHandler() ? "(handler)" : myDefaultAction.getDescriptionText());
    }

    public boolean canExecute(EditorContext context) {
      return (hasHandler() ? true : myDefaultAction.canExecute(context));
    }
  }
  private static <T> T as_n8knj7_a0a0a2a4(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_n8knj7_a0a0a8(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Text$bD = MetaAdapterFactory.getConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e4e61L, "de.slisson.mps.richtext.structure.Text");
    /*package*/ static final SInterfaceConcept IWord$8d = MetaAdapterFactory.getInterfaceConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e7aecL, "de.slisson.mps.richtext.structure.IWord");
    /*package*/ static final SConcept Word$5r = MetaAdapterFactory.getConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9f2e0cL, "de.slisson.mps.richtext.structure.Word");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink words$C8QZ = MetaAdapterFactory.getContainmentLink(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e4e61L, 0x237c8da86a9e7aeeL, "words");
  }
}
