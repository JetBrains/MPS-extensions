package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import org.eclipse.elk.alg.force.options.ForceModelStrategy;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.eclipse.elk.alg.force.options.ForceOptions;
import org.eclipse.elk.core.data.LayoutMetaDataService;
import org.eclipse.elk.alg.force.options.ForceMetaDataProvider;
import org.eclipse.elk.graph.ElkNode;
import org.eclipse.elk.core.util.IElkProgressMonitor;
import org.eclipse.elk.graph.ElkEdge;
import de.itemis.mps.editor.diagram.runtime.model.IAccessorKey;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;

public class ForceLayouter extends ElkLayouterWithTopDownPackingSupport {

  protected double aspectRatio;
  protected double eadesRepulsion;
  protected double edgeLabelSpacing;
  protected boolean fixedGraphSize;
  protected ForceModelStrategy forceModel;
  protected double forceTemperature;
  protected boolean inlineEdgeLabels;
  protected int iterations;
  protected double nodeSpacing;
  protected boolean omitNodeMicroLayout;
  protected int randomizationSeed;
  protected Boolean separateConnectedComponents;
  protected double topdownScaleFactor;

  protected Map<Object, Integer> repulsivePowers = MapSequence.fromMap(new HashMap<Object, Integer>());

  public ForceLayouter() {
    super();
    myAlgorithm = ForceOptions.ALGORITHM_ID;
  }

  static {
    LayoutMetaDataService.getInstance().registerLayoutMetaDataProviders(new ForceMetaDataProvider());
  }

  @Override
  public boolean canLayoutLabels() {
    return true;
  }

  @Override
  protected boolean useDummyPort(EdgeDCell edge, boolean isTarget) {
    return false;
  }

  @Override
  protected void addLayoutInformationToGraph(ElkNode graph, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToGraph(graph, progressMonitor);
    ElkNode layout = graph;

    layout.setProperty(ForceOptions.ASPECT_RATIO, aspectRatio);
    layout.setProperty(ForceOptions.REPULSION, eadesRepulsion);
    layout.setProperty(ForceOptions.SPACING_EDGE_LABEL, edgeLabelSpacing);
    layout.setProperty(ForceOptions.NODE_SIZE_FIXED_GRAPH_SIZE, fixedGraphSize);
    layout.setProperty(ForceOptions.MODEL, forceModel);
    layout.setProperty(ForceOptions.TEMPERATURE, forceTemperature);
    layout.setProperty(ForceOptions.EDGE_LABELS_INLINE, inlineEdgeLabels);
    layout.setProperty(ForceOptions.ITERATIONS, iterations);
    layout.setProperty(ForceOptions.SPACING_NODE_NODE, nodeSpacing);
    layout.setProperty(ForceOptions.OMIT_NODE_MICRO_LAYOUT, omitNodeMicroLayout);
    layout.setProperty(ForceOptions.RANDOM_SEED, randomizationSeed);
    if (separateConnectedComponents != null) {
      layout.setProperty(ForceOptions.SEPARATE_CONNECTED_COMPONENTS, separateConnectedComponents);
    }
    layout.setProperty(ForceOptions.TOPDOWN_SCALE_FACTOR, topdownScaleFactor);

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(layout, "graph", progressMonitor);
    }
  }


  @Override
  protected void addLayoutInformationToEdge(ElkEdge kedge, EdgeDCell edge, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToEdge(kedge, edge, progressMonitor);
    IAccessorKey ID = edge.getEdge().getAccessor().getId();
    Integer repulsivePower = MapSequence.fromMap(this.repulsivePowers).get(ID);

    if (repulsivePower != null) {
      kedge.setProperty(ForceOptions.REPULSIVE_POWER, repulsivePower);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(kedge, "edge", progressMonitor);
    }
  }

  @Override
  public void setParentsStyle(Style style) {
    super.setParentsStyle(style);
    if (style.isSpecified(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-aspect-ratio"))) {
      this.aspectRatio = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-aspect-ratio"));
    }
    this.eadesRepulsion = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-force-eades-repulsion"));
    this.edgeLabelSpacing = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-edge-label-spacing"));
    this.fixedGraphSize = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-fixed-graph-size"));
    this.forceModel = style.get(StyleAttributes.getInstance().<ForceModelStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-force-model"));
    this.forceTemperature = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-force-temperature"));
    this.inlineEdgeLabels = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-inline-edge-labels"));
    this.iterations = style.get(StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-force-iterations"));
    this.nodeSpacing = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-node-spacing"));
    this.omitNodeMicroLayout = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-omit-node-micro-layout"));
    this.randomizationSeed = style.get(StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-randomization-seed"));
    if (style.isSpecified(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-separate-connected-components"))) {
      this.separateConnectedComponents = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-separate-connected-components"));
    }
    this.topdownScaleFactor = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-topdown-scale-factor"));
  }

  @Override
  public void addEdgesStyle(Style style, Object key) {
    super.addEdgesStyle(style, key);
    MapSequence.fromMap(this.repulsivePowers).put(key, style.get(StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-force-repulsive-power")));
  }
}
