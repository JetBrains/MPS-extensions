package de.slisson.mps.richtext.runtime.selection;

/*Generated by MPS */

import java.awt.event.MouseListener;
import jetbrains.mps.openapi.editor.selection.SelectionListener;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.logging.Logger;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.openapi.editor.selection.Selection;
import java.awt.event.MouseEvent;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.nodeEditor.selection.EditorCellLabelSelection;
import jetbrains.mps.openapi.editor.cells.EditorCell_Label;
import jetbrains.mps.openapi.editor.selection.SingularSelection;
import de.slisson.mps.editor.multiline.cells.MultilineSelection;

public class ShiftSelector implements MouseListener, SelectionListener, EditorComponent.EditorDisposeListener {
  private static final Logger LOG = Logger.getLogger(ShiftSelector.class);
  private static final Map<EditorComponent, ShiftSelector> INSTANCES = MapSequence.fromMap(new HashMap<EditorComponent, ShiftSelector>());

  public static void install(EditorComponent editorComponent) {
    ShiftSelector instance = MapSequence.fromMap(INSTANCES).get(editorComponent);
    if (instance == null) {
      instance = new ShiftSelector(editorComponent);
      MapSequence.fromMap(INSTANCES).put(editorComponent, instance);
      editorComponent.addMouseListener(instance);
      editorComponent.getSelectionManager().addSelectionListener(instance);
      editorComponent.addDisposeListener(instance);
    }
  }

  public static void uninstall(EditorComponent editorComponent) {
    ShiftSelector instance = MapSequence.fromMap(INSTANCES).get(editorComponent);
    if (instance == null) {
      return;
    }
    editorComponent.removeMouseListener(instance);
    editorComponent.getSelectionManager().removeSelectionListener(instance);
    editorComponent.removeDisposeListener(instance);
    MapSequence.fromMap(INSTANCES).removeKey(editorComponent);
  }

  public static void uninstallAll() {
    for (EditorComponent editorComponent : ListSequence.fromListWithValues(new ArrayList<EditorComponent>(), MapSequence.fromMap(INSTANCES).keySet())) {
      uninstall(editorComponent);
    }
  }

  private jetbrains.mps.openapi.editor.EditorComponent myEditorComponent;
  private Selection myOldOldSelection;
  private Selection myOldSelection;
  private Selection myCurrentSelection;

  public ShiftSelector(jetbrains.mps.openapi.editor.EditorComponent editorComponent) {
    myEditorComponent = editorComponent;
  }
  public void mouseClicked(MouseEvent event) {
  }
  public void mousePressed(MouseEvent event) {
    // shift + left click -> select range
    if (event.isShiftDown() && event.getButton() == MouseEvent.BUTTON1) {
      if (myOldSelection == null || myCurrentSelection == null) {
        return;
      }
      EditorCell from = getSelectedCell(myOldSelection);
      EditorCell to = getSelectedCell(myCurrentSelection);
      if (LOG.isInfoLevel()) {
        LOG.info(check_bvifcg_a0a3a1a51(from) + " -> " + check_bvifcg_a0d0b0p(to));
      }
      if (from == null || to == null) {
        return;
      }
      if (from == to) {
        if ((myOldSelection instanceof EditorCellLabelSelection) && (myCurrentSelection instanceof EditorCellLabelSelection)) {
          EditorCellLabelSelection oldLabelSelection = ((EditorCellLabelSelection) myOldSelection);
          EditorCellLabelSelection newLabelSelection = ((EditorCellLabelSelection) myCurrentSelection);
          int start = oldLabelSelection.getSelectionStart();
          int end = newLabelSelection.getSelectionEnd();
          myEditorComponent.getSelectionManager().setSelection(oldLabelSelection.getEditorCellLabel(), end, start, end);
        }
        if (from instanceof EditorCell_Label) {
        }
        return;
      }

      RichtextSelection rsel = RichtextSelection.create(from, to);
      if (rsel == null) {
        return;
      }
      myEditorComponent.getSelectionManager().setSelection(rsel);
    }
  }
  public void mouseReleased(MouseEvent event) {
  }
  public void mouseEntered(MouseEvent event) {
  }
  public void mouseExited(MouseEvent event) {
  }
  public void selectionChanged(jetbrains.mps.openapi.editor.EditorComponent component, Selection oldSelection, Selection newSelection) {
    myOldOldSelection = myOldSelection;
    myOldSelection = oldSelection;
    myCurrentSelection = newSelection;
  }

  public static EditorCell getSelectedCell(Selection selection) {
    if (selection instanceof SingularSelection) {
      return ((SingularSelection) selection).getEditorCell();
    } else if (selection instanceof MultilineSelection) {
      MultilineSelection multilineSelection = (MultilineSelection) selection;
      return multilineSelection.getCellContainingCaret();
    } else {
      return null;
    }

  }

  public void editorWillBeDisposed(EditorComponent component) {
    uninstall(component);
  }
  private static Class<?> check_bvifcg_a0d0b0p(EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getClass();
    }
    return null;
  }
  private static Class<?> check_bvifcg_a0a3a1a51(EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getClass();
    }
    return null;
  }
}
