package de.q60.mps.shadowmodels.runtime.smodel;

/*Generated by MPS */

import de.q60.mps.shadowmodels.runtime.engine.CopyNodeToTransformationResult;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import de.q60.mps.shadowmodels.runtime.engine.IBuilderContext;
import org.jetbrains.mps.openapi.model.SNode;
import org.modelix.model.mpsadapters.mps.SNodeToNodeAdapter;
import jetbrains.mps.internal.collections.runtime.Sequence;
import de.q60.mps.shadowmodels.runtime.engine.TransformationResult;
import org.modelix.model.api.IChildLink;
import org.modelix.model.api.INode;
import de.q60.mps.shadowmodels.runtime.engine.ResultElementContext;
import org.modelix.model.mpsadapters.mps.SContainmentLinkAdapter;
import org.modelix.model.mpsadapters.mps.NodeToSNodeAdapter;
import org.modelix.model.api.IReferenceLink;
import org.modelix.model.mpsadapters.mps.SReferenceLinkAdapter;
import org.modelix.model.api.IProperty;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.modelix.model.mpsadapters.mps.SPropertyAdapter;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class SM_CopySNodeToTransformationResult extends CopyNodeToTransformationResult {

  private List<ChildHandler> childHandlers = ListSequence.fromList(new ArrayList<ChildHandler>());
  private List<ReferenceHandler> referenceHandlers = ListSequence.fromList(new ArrayList<ReferenceHandler>());
  private List<PropertyHandler> propertyHandlers = ListSequence.fromList(new ArrayList<PropertyHandler>());

  public SM_CopySNodeToTransformationResult(IBuilderContext context) {
    super(context);
  }

  public void addChildHandler(ChildHandler handler) {
    ListSequence.fromList(childHandlers).addElement(handler);
  }
  public void addReferenceHandler(ReferenceHandler handler) {
    ListSequence.fromList(referenceHandlers).addElement(handler);
  }
  public void addPropertyHandler(PropertyHandler handler) {
    ListSequence.fromList(propertyHandlers).addElement(handler);
  }

  public IBuilderContext copy(SNode node) {
    return copy(SNodeToNodeAdapter.wrap(node));
  }

  public void copy(Iterable<SNode> nodes) {
    if (nodes == null) {
      return;
    }
    for (SNode node : Sequence.fromIterable(nodes)) {
      copy(node);
    }
  }

  @Override
  protected void copyChild(TransformationResult.ResultElement parentCopy, IChildLink link, INode originalChild) {
    ResultElementContext contextForHandler = new ResultElementContext(context, parentCopy);
    for (ChildHandler handler : ListSequence.fromList(childHandlers)) {
      if (handler.isApplicable(((SContainmentLinkAdapter) link).getLink(), NodeToSNodeAdapter.wrap(originalChild), contextForHandler)) {
        handler.apply(((SContainmentLinkAdapter) link).getLink(), NodeToSNodeAdapter.wrap(originalChild), contextForHandler);
        return;
      }
    }

    super.copyChild(parentCopy, link, originalChild);
  }

  @Override
  protected void setReferenceTarget(TransformationResult.ResultElement copiedSource, IReferenceLink link, INode originalTarget) {
    ResultElementContext contextForHandler = new ResultElementContext(context, copiedSource);
    if (ListSequence.fromList(referenceHandlers).isNotEmpty()) {
      SNode originalTargetSNode = NodeToSNodeAdapter.wrap(originalTarget);
      if (originalTargetSNode != null) {
        for (ReferenceHandler handler : ListSequence.fromList(referenceHandlers)) {
          if (handler.isApplicable(((SReferenceLinkAdapter) link).getLink(), originalTargetSNode, contextForHandler)) {
            handler.apply(((SReferenceLinkAdapter) link).getLink(), originalTargetSNode, contextForHandler);
            return;
          }
        }
      }
    }

    super.setReferenceTarget(copiedSource, link, originalTarget);
  }

  @Override
  public void setProperty(TransformationResult.ResultElement node, IProperty property, _FunctionTypes._return_P0_E0<? extends String> value_) {
    for (PropertyHandler handler : ListSequence.fromList(propertyHandlers)) {
      String value = value_.invoke();
      if (handler.isApplicable(((SPropertyAdapter) property).getProperty(), value, context)) {
        final String replacement = handler.apply(((SPropertyAdapter) property).getProperty(), value, context);
        super.setProperty(node, property, () -> replacement);
        return;
      }
    }

    super.setProperty(node, property, value_);
  }

  public static abstract class ReferenceHandler {
    public boolean isApplicable(SReferenceLink role, SNode target, IBuilderContext context) {
      return true;
    }
    public abstract void apply(SReferenceLink role, SNode target, IBuilderContext context);
  }

  public static abstract class ChildHandler {
    public boolean isApplicable(SContainmentLink role, SNode child, IBuilderContext context) {
      return true;
    }
    public abstract void apply(SContainmentLink role, SNode child, IBuilderContext context);
  }

  public static abstract class PropertyHandler {
    public boolean isApplicable(SProperty role, String value, IBuilderContext context) {
      return true;
    }
    public abstract String apply(SProperty role, String value, IBuilderContext context);
  }
}
