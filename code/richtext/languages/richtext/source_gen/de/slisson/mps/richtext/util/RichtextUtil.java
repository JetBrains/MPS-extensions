package de.slisson.mps.richtext.util;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.smodel.Language;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.Set;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.LanguageAspect;
import java.lang.reflect.Method;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.util.JavaNameUtil;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.module.ReloadableModule;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import de.slisson.mps.editor.multiline.cells.EditorCell_Word;
import de.slisson.mps.richtext.behavior.IWord__BehaviorDescriptor;
import de.slisson.mps.richtext.behavior.Word__BehaviorDescriptor;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import de.slisson.mps.richtext.behavior.Text__BehaviorDescriptor;
import jetbrains.mps.openapi.editor.cells.EditorCell_Label;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.cells.CellTraversalUtil;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;

public class RichtextUtil {
  public RichtextUtil() {
  }
  public static List<Language> getAllImportedLanguages(SModel model) {
    Set<SLanguage> usedlanguagesSet = model.getModule().getUsedLanguages();
    List<Language> result = ListSequence.fromList(new ArrayList<Language>());
    ListSequence.fromList(result).addSequence(SetSequence.fromSet(usedlanguagesSet).select((it) -> as_5fjl1_a0a0a0a0a0c0b(it.getSourceModule(), Language.class)).where((it) -> it != null));
    return result;
  }
  public static List<SAbstractConcept> getAllImportedWordConcepts(SModel model) {
    List<SAbstractConcept> result = ListSequence.fromList(new ArrayList<SAbstractConcept>());
    ListSequence.fromList(result).addSequence(ListSequence.fromList(getAllImportedLanguages(model)).translate((lang) -> ListSequence.fromList(SModelOperations.nodes(getStructureModel(lang), CONCEPTS.ConceptDeclaration$gH)).select((it) -> SNodeOperations.asSConcept(it)).where((concept) -> SConceptOperations.isSubConceptOf(SNodeOperations.asSConcept(concept), CONCEPTS.IWord$8d))).select((it) -> ((SAbstractConcept) it)).where((it) -> !(it.isAbstract())));
    return result;
  }
  public static SModel getActionsModel(Language language) {
    return LanguageAspect.ACTIONS.get(language);
  }
  public static SModel getStructureModel(Language language) {
    return LanguageAspect.STRUCTURE.get(language);
  }
  public static Method getEnrichmentActionMethod(SModel model, String actionId) {
    final String methodName = "enrichmentAction_" + actionId;
    Class cls = getEnrichmentActionsClass(model);
    if (cls == null) {
      return null;
    }
    Method method = Sequence.fromIterable(Sequence.fromArray(cls.getMethods())).findFirst((it) -> methodName.equals(it.getName()));
    return method;
  }
  public static Class getEnrichmentActionsClass(SModel model) {
    String packageName = JavaNameUtil.packageName(model);
    String className = packageName + ".EnrichmentActions";
    SModule module = model.getModule();

    try {
      return ((ReloadableModule) module).getOwnClass(className);
    } catch (Exception e) {
    }
    return null;
  }
  public static void userTriggeredEnrichment(EditorContext editorContext, SNode word) {
    EditorCell_Word cell = (EditorCell_Word) editorContext.getContextCell();
    int caretPosition = cell.getCaretPosition();
    String s1 = cell.getParent().getTextBeforeCaret();
    String s2 = cell.getParent().getTextAfterCaret();

    for (SAbstractConcept concept : ListSequence.fromList(getAllImportedWordConcepts(SNodeOperations.getModel(word)))) {
      for (String transformKey : IWord__BehaviorDescriptor.getTransformKeys_id7NYWYqYGfSm.invoke(SNodeOperations.asSConcept(concept))) {

        if (s1.endsWith(transformKey)) {
          s1 = s1.substring(0, s1.length() - transformKey.length());
          Word__BehaviorDescriptor.setText_id1JwC6U7zkKz.invoke(word, s1);
          if (s2.length() > 0) {
            SNode nextWord = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9f2e0cL, "de.slisson.mps.richtext.structure.Word"));
            Word__BehaviorDescriptor.setText_id1JwC6U7zkKz.invoke(nextWord, s2);
            SNodeOperations.insertNextSiblingChild(word, nextWord);
          }
          SNode richNode = SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(concept));
          if (s1.length() > 0) {
            SNodeOperations.insertNextSiblingChild(word, richNode);
          } else {
            SNodeOperations.replaceWithAnother(word, richNode);
          }
          break;
        }
      }
    }
    Text__BehaviorDescriptor.ensureNormalized_id3mI$71cQ6Aw.invoke(SNodeOperations.getNodeAncestor(word, CONCEPTS.Text$bD, false, false));
  }
  public static List<EditorCell_Label> getAllConstantCells(EditorCell parentCell) {
    List<EditorCell_Label> result = ListSequence.fromList(new ArrayList<EditorCell_Label>());
    EditorCell currentLeaf = CellTraversalUtil.getFirstLeaf(parentCell);
    while (currentLeaf != null) {
      if (currentLeaf instanceof EditorCell_Label && !(((EditorCell_Label) currentLeaf).isEditable())) {
        ListSequence.fromList(result).addElement((EditorCell_Label) currentLeaf);
      }
      currentLeaf = CellTraversalUtil.getNextLeaf(currentLeaf);
    }
    return result;
  }

  public static String safeSubstring(String str, int start, int end) {
    if (str == null) {
      return "";
    }
    if (start < 0) {
      start = 0;
    }
    if (end > str.length()) {
      end = str.length();
    }
    if (start > end) {
      return "";
    }
    return str.substring(start, end);
  }
  public static String safeSubstring(String str, int start) {
    if (str == null) {
      return "";
    }
    return safeSubstring(str, start, str.length());
  }
  public static String substringAfter(String str, String separator) {
    if ((str == null || str.length() == 0)) {
      return str;
    }
    if (separator == null) {
      return "";
    }
    int pos = str.indexOf(separator);
    if (pos == -1) {
      return "";
    }
    return str.substring(pos + separator.length());
  }
  public static String substringBefore(String str, String separator) {
    if ((str == null || str.length() == 0)) {
      return str;
    }
    if (separator.length() == 0) {
      return "";
    }
    int pos = str.indexOf(separator);
    if (pos == -1) {
      return str;
    }
    return str.substring(0, pos);
  }

  public static boolean _preventSelectionHandling;

  public static void preventSelectionHandling() {
    _preventSelectionHandling = true;
  }
  private static <T> T as_5fjl1_a0a0a0a0a0c0b(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ConceptDeclaration$gH = MetaAdapterFactory.getConcept(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0xf979ba0450L, "jetbrains.mps.lang.structure.structure.ConceptDeclaration");
    /*package*/ static final SInterfaceConcept IWord$8d = MetaAdapterFactory.getInterfaceConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e7aecL, "de.slisson.mps.richtext.structure.IWord");
    /*package*/ static final SConcept Text$bD = MetaAdapterFactory.getConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e4e61L, "de.slisson.mps.richtext.structure.Text");
  }
}
