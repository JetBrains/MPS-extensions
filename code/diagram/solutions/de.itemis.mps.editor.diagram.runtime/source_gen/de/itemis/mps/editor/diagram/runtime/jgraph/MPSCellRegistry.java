package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import org.jetbrains.annotations.NotNull;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Collections;

public class MPSCellRegistry {
  private static final String USER_OBJECT_KEY = MPSCellRegistry.class.getName() + ".mpsCell";

  @NotNull
  private MyGraph myGraph;

  public MPSCellRegistry(@NotNull MyGraph graph) {
    myGraph = graph;
  }

  public MPSCell getInstance(EditorCell cell, IMPSCellContainer container) {
    Object userObject = cell.getUserObject(USER_OBJECT_KEY);
    Iterable<MPSCell> instances;
    if (userObject instanceof MPSCell) {
      instances = Sequence.<MPSCell>singleton((MPSCell) userObject);
    } else if (userObject instanceof MPSCell[]) {
      instances = Sequence.fromArray(((MPSCell[]) userObject));
    } else {
      instances = Sequence.fromIterable(Collections.<MPSCell>emptyList());
    }
    MPSCell instance = Sequence.fromIterable(instances).findFirst((it) -> it.getGraph() == myGraph);

    if (instance == null) {
      instance = new MPSCell(cell, myGraph, container);
      instances = Sequence.fromIterable(instances).concat(Sequence.fromIterable(Sequence.<MPSCell>singleton(instance)));
      cell.putUserObject(USER_OBJECT_KEY, Sequence.fromIterable(instances).toGenericArray(MPSCell.class));
    }
    return instance;
  }

  public MPSCell findAncestor(EditorCell ecell) {
    EditorCell current = ecell;
    while (current != null) {
      MPSCell mpsCell = findInstance(current);
      if (mpsCell != null) {
        return mpsCell;
      }
      current = current.getParent();
    }
    return null;
  }

  public MPSCell findInstance(EditorCell cell) {
    Object userObject = cell.getUserObject(USER_OBJECT_KEY);
    Iterable<MPSCell> instances;
    if (userObject instanceof MPSCell) {
      instances = Sequence.<MPSCell>singleton((MPSCell) userObject);
    } else if (userObject instanceof MPSCell[]) {
      instances = Sequence.fromArray(((MPSCell[]) userObject));
    } else {
      instances = Sequence.fromIterable(Collections.<MPSCell>emptyList());
    }
    return Sequence.fromIterable(instances).findFirst((it) -> it.getGraph() == myGraph);
  }
}
