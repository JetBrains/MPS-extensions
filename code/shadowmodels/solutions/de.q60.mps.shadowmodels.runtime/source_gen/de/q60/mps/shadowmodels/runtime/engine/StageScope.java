package de.q60.mps.shadowmodels.runtime.engine;

/*Generated by MPS */

import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.Objects;

public class StageScope extends AbstractScope implements IScope {
  private IStageReference stageRef;

  private StageScope() {
    // for deserialization
  }

  public StageScope(IStageReference stage) {
    if (stage instanceof FinalStageReference || stage instanceof StepStageReference) {
      throw new RuntimeException("Compute the " + SubstepStageReference.class.getSimpleName() + " first");
    }
    this.stageRef = stage;
  }

  @Override
  public IScope getParent() {
    ISubgraphRef subgraphRef = stageRef.getSubgraphRef();
    if (subgraphRef instanceof ChildSubgraphRef) {
      return ((ChildSubgraphRef) subgraphRef).getCall().getScope();
    } else {
      IStageReference parentStage = subgraphRef.getParent();
      return (parentStage != null ? new StageScope(parentStage) : RootScope.INSTANCE);
    }
  }

  @Override
  public IStageReference getStage() {
    return stageRef;
  }

  @Override
  public Iterable<ScopeImport> getImports(final ITransformationEngine engine) {
    return engine.getIncrementalEngine().evaluate(new CK_StageScope_getImports(this), () -> {
      ISubgraphStage stage = engine.resolveStage(stageRef);
      Iterable<ScopeImport> imports = stage.getDeclaredImports();
      imports = Sequence.fromIterable(imports).concat(Sequence.fromIterable(findSiblings(engine)).select((it) -> new ScopeImport(it)));
      return Sequence.fromIterable(imports).toList();
    });
  }

  protected Iterable<IScope> findSiblings(final ITransformationEngine engine) {
    final ISubgraphStage ownStage = this.getStage(engine);
    final ISubgraphCall ownCall = check_pnbocr_a0b0m(check_pnbocr_a0a1a21(as_pnbocr_a0a0a1a21(this.getStage().getSubgraphRef(), ChildSubgraphRef.class), this), this);
    if (ownCall == null) {
      return ListSequence.fromList(new ArrayList<IScope>());
    }

    final SubgraphStage parentStage = as_pnbocr_a0a4a21(check_pnbocr_a0a4a21(this.getParent(), engine, this), SubgraphStage.class);
    if (parentStage == null) {
      return ListSequence.fromList(new ArrayList<IScope>());
    }

    Iterable<IUniqueContainmentTarget> allSubgraphs = Sequence.fromIterable(parentStage.getAllContent()).where(new _FunctionTypes._return_P1_E0<Boolean, IUniqueContainmentTarget>() {
      public Boolean invoke(IUniqueContainmentTarget it) {
        return it.getTarget() instanceof ISubgraphCall;
      }
    });
    Iterable<IUniqueContainmentTarget> siblingsSubgraphs = Sequence.fromIterable(allSubgraphs).where(new _FunctionTypes._return_P1_E0<Boolean, IUniqueContainmentTarget>() {
      public Boolean invoke(IUniqueContainmentTarget it) {
        return !(Objects.equals(it.getTarget(), ownCall)) && areSiblings(ownCall, (ISubgraphCall) it.getTarget());
      }
    });
    Iterable<IStageReference> siblingStageRefs = Sequence.fromIterable(siblingsSubgraphs).select(new _FunctionTypes._return_P1_E0<IStageReference, IUniqueContainmentTarget>() {
      public IStageReference invoke(IUniqueContainmentTarget it) {
        IStageReference siblingStageRef = getSiblingStageRef(ownStage.getStageReference(), new ChildSubgraphRef(parentStage.getStageReference(), it));
        return engine.resolveStage(siblingStageRef).getStageReference();
      }
    });
    return Sequence.fromIterable(siblingStageRefs).select((it) -> new StageScope(it));
  }

  protected boolean areSiblings(ISubgraphCall a, ISubgraphCall b) {
    if (a instanceof ForkCall) {
      ForkCall cast_it = (ForkCall) a;
      return b instanceof ForkCall && Objects.equals(((ForkCall) b).getId(), cast_it.getId());
    } else if (a instanceof GoalCall) {
      GoalCall cast_it = (GoalCall) a;
      return b instanceof GoalCall && Objects.equals(((GoalCall) b).getGoalId(), cast_it.getGoalId());
    } else {
      return false;
    }
  }

  protected IStageReference getSiblingStageRef(IStageReference sourceStage, ISubgraphRef siblingSubgraph) {
    if (sourceStage instanceof SubstepStageReference) {
      SubstepStageReference cast_it = (SubstepStageReference) sourceStage;
      return new StepStageReference(siblingSubgraph, cast_it.getStepNumber());
    } else if (sourceStage instanceof StepStageReference) {
      StepStageReference cast_it = (StepStageReference) sourceStage;
      return new StepStageReference(siblingSubgraph, cast_it.getStepNumber());
    } else {
      return new FinalStageReference(siblingSubgraph);
    }
  }

  @Override
  public String toString() {
    return stageRef.toString();
  }

  private transient int _cachedHashCode;
  private transient boolean _hashCodeInitialized = false;
  @Override
  public int hashCode() {
    if (!(_hashCodeInitialized)) {
      int c = 0;
      c = 31 * c + Objects.hashCode(stageRef);
      _cachedHashCode = c;
      _hashCodeInitialized = true;
    }
    return _cachedHashCode;
  }
  @Override
  public boolean equals(Object o) {
    if (this == o) {
      return true;
    }
    if (o == null || this.getClass() != o.getClass()) {
      return false;
    }
    StageScope that = (StageScope) o;
    if (!(Objects.equals(stageRef, that.stageRef))) {
      return false;
    }
    return true;
  }
  private static ISubgraphCall check_pnbocr_a0b0m(IUniqueContainmentTarget<ISubgraphCall> checkedDotOperand, StageScope checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getTarget();
    }
    return null;
  }
  private static IUniqueContainmentTarget<ISubgraphCall> check_pnbocr_a0a1a21(ChildSubgraphRef checkedDotOperand, StageScope checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCall();
    }
    return null;
  }
  private static ISubgraphStage check_pnbocr_a0a4a21(IScope checkedDotOperand, ITransformationEngine engine, StageScope checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getStage(engine);
    }
    return null;
  }
  private static <T> T as_pnbocr_a0a0a1a21(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_pnbocr_a0a4a21(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
