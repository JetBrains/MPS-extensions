package de.itemis.mps.selection.runtime.intentions;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.util.Map;
import org.jetbrains.mps.openapi.module.SModule;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.classloading.DeployListener;
import org.jetbrains.annotations.NotNull;
import java.util.Set;
import jetbrains.mps.module.ReloadableModule;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.Objects;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.ide.MPSCoreComponents;
import jetbrains.mps.classloading.ClassLoaderManager;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.LanguageAspect;
import jetbrains.mps.openapi.editor.selection.Selection;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;

public class SelectionIntentionsManager {
  private static final Logger LOG = Logger.getLogger(SelectionIntentionsManager.class);
  public static final String DESCRIPTOR_CLASS_NAME = "SelectionIntentionsDescriptor";

  private static SelectionIntentionsManager INSTANCE = new SelectionIntentionsManager();

  public static SelectionIntentionsManager getInstance() {
    return INSTANCE;
  }

  private Map<SModule, List<ISelectionIntentionFactory>> myFactories = MapSequence.fromMap(new HashMap<SModule, List<ISelectionIntentionFactory>>());
  private DeployListener myClasseslistener = new DeployListener() {
    @Override
    public void onLoaded(@NotNull Set<ReloadableModule> modules, @NotNull ProgressMonitor monitor) {
      try {
        for (ReloadableModule module : SetSequence.fromSet(modules)) {
          loadModule(module);
        }
      } catch (Exception ex) {
        if (LOG.isErrorLevel()) {
          LOG.error("", ex);
        }
      }
    }

    @Override
    public void onUnloaded(@NotNull Set<ReloadableModule> modules, @NotNull ProgressMonitor monitor) {
      try {
        for (ReloadableModule module : SetSequence.fromSet(modules)) {
          if (Objects.equals(module.getModuleReference(), PersistenceFacade.getInstance().createModuleReference("cce85e64-7b37-4ad5-b0e6-9d18324cdfb3(de.itemis.mps.selection.runtime)"))) {
            dispose();
            return;
          }
          unloadModule(module);
        }
      } catch (Exception ex) {
        if (LOG.isErrorLevel()) {
          LOG.error("", ex);
        }
      }
    }
  };

  public void init() {
    MPSCoreComponents.getInstance().getPlatform().findComponent(ClassLoaderManager.class).addListener(myClasseslistener);

    MPSModuleRepository.getInstance().getModelAccess().runReadAction(() -> {
      for (SModule module : Sequence.fromIterable(MPSCoreComponents.getInstance().getPlatform().findComponent(MPSModuleRepository.class).getModules())) {
        if (module instanceof ReloadableModule) {
          loadModule((ReloadableModule) module);
        }
      }
    });
  }

  public void dispose() {
    ClassLoaderManager.getInstance().removeListener(myClasseslistener);
    MapSequence.fromMap(myFactories).clear();
  }

  public void unloadModule(SModule module) {
    MapSequence.fromMap(myFactories).removeKey(module);
  }

  protected void loadModule(ReloadableModule module) {
    String className = module.getModuleName() + "." + LanguageAspect.INTENTIONS.getName() + "." + DESCRIPTOR_CLASS_NAME;
    try {
      Class descriptorClass = module.getOwnClass(className);
      if (descriptorClass == null) {
        return;
      }
      ISelectionIntentionsDescriptor desciptor = (ISelectionIntentionsDescriptor) descriptorClass.newInstance();
      MapSequence.fromMap(myFactories).put(module, desciptor.getFactories());
    } catch (Exception ex) {
    }
  }

  public List<ISelectionIntentionExecutable> getIntentions(Selection selection) {
    List<ISelectionIntentionExecutable> intentions = ListSequence.fromList(new ArrayList<ISelectionIntentionExecutable>());
    for (List<ISelectionIntentionFactory> factories : Sequence.fromIterable(MapSequence.fromMap(myFactories).values())) {
      for (ISelectionIntentionFactory factory : ListSequence.fromList(factories)) {
        ListSequence.fromList(intentions).addSequence(ListSequence.fromList(factory.getInstances(selection)));
      }
    }
    return intentions;
  }

  public List<ISelectionIntentionExecutable> getApplicableIntentions(final Selection selection) {
    final Wrappers._T<List<ISelectionIntentionExecutable>> result = new Wrappers._T<List<ISelectionIntentionExecutable>>(null);
    selection.getEditorComponent().getEditorContext().getRepository().getModelAccess().runReadAction(() -> {
      result.value = ListSequence.fromList(getIntentions(selection)).where(new _FunctionTypes._return_P1_E0<Boolean, ISelectionIntentionExecutable>() {
        public Boolean invoke(ISelectionIntentionExecutable it) {
          return it.isApplicable(selection);
        }
      }).toList();
    });
    return result.value;
  }
}
