package de.q60.mps.shadowmodels.runtime.smodel;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNodeChangeListener;
import java.util.Set;
import de.q60.mps.incremental.runtime.DependencyKey;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.event.SPropertyChangeEvent;
import de.q60.mps.shadowmodels.runtime.engine.RoleDependency;
import org.modelix.model.mpsadapters.mps.SNodeToNodeAdapter;
import org.jetbrains.mps.openapi.event.SReferenceChangeEvent;
import org.jetbrains.mps.openapi.event.SNodeAddEvent;
import de.q60.mps.shadowmodels.runtime.engine.AllChildrenDependency;
import de.q60.mps.shadowmodels.runtime.engine.ContainmentDependency;
import org.jetbrains.mps.openapi.event.SNodeRemoveEvent;

public class SM_DependencyChangeCollector extends SM_GlobalModelListener implements SNodeChangeListener {

  private Set<DependencyKey> changes = SetSequence.fromSet(new HashSet<DependencyKey>());

  public Set<DependencyKey> getChanges() {
    Set<DependencyKey> result = changes;
    changes = SetSequence.fromSet(new HashSet<DependencyKey>());
    return result;
  }

  protected void addChange(DependencyKey change) {
    SetSequence.fromSet(changes).addElement(change);
  }

  @Override
  protected void addListener(SModel model) {
    model.addChangeListener(this);
  }
  @Override
  protected void removeListener(SModel model) {
    model.removeChangeListener(this);
  }

  @Override
  public void propertyChanged(@NotNull SPropertyChangeEvent e) {
    addChange(new RoleDependency(SNodeToNodeAdapter.wrap(e.getNode()).getReference(), e.getProperty().getName()));
  }
  @Override
  public void referenceChanged(@NotNull SReferenceChangeEvent e) {
    addChange(new RoleDependency(SNodeToNodeAdapter.wrap(e.getNode()).getReference(), e.getAssociationLink().getName()));
  }
  @Override
  public void nodeAdded(@NotNull SNodeAddEvent e) {
    if (e.getParent() != null) {
      addChange(new RoleDependency(SNodeToNodeAdapter.wrap(e.getParent()).getReference(), e.getAggregationLink().getName()));
      addChange(new AllChildrenDependency(SNodeToNodeAdapter.wrap(e.getParent()).getReference()));
    }
    addChange(new ContainmentDependency(SNodeToNodeAdapter.wrap(e.getChild()).getReference()));
  }
  @Override
  public void nodeRemoved(@NotNull SNodeRemoveEvent e) {
    if (e.getParent() != null) {
      addChange(new RoleDependency(SNodeToNodeAdapter.wrap(e.getParent()).getReference(), e.getAggregationLink().getName()));
      addChange(new AllChildrenDependency(SNodeToNodeAdapter.wrap(e.getParent()).getReference()));
    }
    addChange(new ContainmentDependency(SNodeToNodeAdapter.wrap(e.getChild()).getReference()));
  }
}
