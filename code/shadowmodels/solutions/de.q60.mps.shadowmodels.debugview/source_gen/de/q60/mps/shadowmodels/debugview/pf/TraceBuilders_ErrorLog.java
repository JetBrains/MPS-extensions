package de.q60.mps.shadowmodels.debugview.pf;

/*Generated by MPS */

import de.q60.mps.polymorphicfunctions.runtime.PFModule;
import jetbrains.mps.logging.Logger;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import de.q60.mps.polymorphicfunctions.runtime.IFunctionImplementation;
import java.util.List;
import de.q60.mps.polymorphicfunctions.runtime.IParameterType;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import de.q60.mps.polymorphicfunctions.runtime.ParameterType_Classifier;
import de.q60.mps.polymorphicfunctions.runtime.IPFContext;
import de.q60.mps.polymorphicfunctions.runtime.ParameterList;
import de.q60.mps.explorer.pf.ExplorerElement;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import de.q60.mps.logging.runtime.LogEntry;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Iterator;
import jetbrains.mps.textgen.trace.DebugInfo;
import jetbrains.mps.textgen.trace.DefaultTraceInfoProvider;
import de.q60.mps.explorer.pf.IExplorerContext;
import jetbrains.mps.util.NameUtil;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.textgen.trace.BaseLanguageNodeLookup;

public class TraceBuilders_ErrorLog extends PFModule {
  private static final Logger LOG = Logger.getLogger(TraceBuilders_ErrorLog.class);
  public static final TraceBuilders_ErrorLog INSTANCE = ((_FunctionTypes._return_P0_E0<TraceBuilders_ErrorLog>) () -> {
    try {
      return new TraceBuilders_ErrorLog();
    } catch (RuntimeException ex) {
      if (LOG.isErrorLevel()) {
        LOG.error("Failed to load " + TraceBuilders_ErrorLog.class.getName(), ex);
      }
      throw ex;
    }
  }).invoke();
  private TraceBuilders_ErrorLog() {
    addImplementation("de.q60.mps.explorer.pf.TraceBuilders_base.buildTrace", new IFunctionImplementation() {
      private List<IParameterType> myParameterTypes = ListSequence.fromListAndArray(new ArrayList<IParameterType>(), new ParameterType_Classifier(ErrorLog.class));
      private List<String> contextIds = ListSequence.fromListAndArray(new ArrayList<String>(), "de.q60.mps.explorer.pf.TraceBuilders_base.explorerContextGroup");
      private List<String> groupIds = ListSequence.fromList(new ArrayList<String>());
      @Override
      public String getId() {
        return "de.q60.mps.shadowmodels.debugview.pf/TraceBuilders_ErrorLog/buildTrace_0";
      }
      public boolean isApplicable(final IPFContext _PFcontext, final ParameterList _PFparameters) {
        if (!(_PFparameters.get(0) == null || _PFparameters.get(0) instanceof ErrorLog)) {
          return false;
        }
        return true;
      }
      public Object execute(final IPFContext _PFcontext, final ParameterList _PFparameters) {
        ExplorerElement result = new ExplorerElement();
        result.transparent = true;
        if (ListSequence.fromList(((ErrorLog) _PFparameters.get(0)).entries).isNotEmpty()) {
          long t0 = ListSequence.fromList(((ErrorLog) _PFparameters.get(0)).entries).select((it) -> it.getTime()).reduceLeft((a, b) -> Math.min(a, b));

          for (Tuples._2<String, Iterable<LogEntry>> thread : Sequence.fromIterable(((ErrorLog) _PFparameters.get(0)).getEntriesPerThread())) {
            Iterable<LogEntry> entries = thread._1();
            ExplorerElement teThread = new ExplorerElement();
            teThread.text = "(" + Sequence.fromIterable(entries).count() + ")" + thread._0();
            for (LogEntry entry : Sequence.fromIterable(entries)) {
              teThread.addChild("[" + (entry.getTime() - t0) + "] ", entry);
            }
            result.addChild(teThread);
          }

        }
        return result;
      }
      @Override
      public Iterable<IParameterType> getParameterTypes() {
        return myParameterTypes;
      }
      @Override
      public Iterable<String> getContextIds() {
        return contextIds;
      }
      @Override
      public Iterable<String> getPriorityGroupIds() {
        return groupIds;
      }
    });
    addImplementation("de.q60.mps.explorer.pf.TraceBuilders_base.buildTrace", new IFunctionImplementation() {
      private List<IParameterType> myParameterTypes = ListSequence.fromListAndArray(new ArrayList<IParameterType>(), new ParameterType_Classifier(LogEntry.class));
      private List<String> contextIds = ListSequence.fromListAndArray(new ArrayList<String>(), "de.q60.mps.explorer.pf.TraceBuilders_base.explorerContextGroup");
      private List<String> groupIds = ListSequence.fromList(new ArrayList<String>());
      @Override
      public String getId() {
        return "de.q60.mps.shadowmodels.debugview.pf/TraceBuilders_ErrorLog/buildTrace_2";
      }
      public boolean isApplicable(final IPFContext _PFcontext, final ParameterList _PFparameters) {
        if (!(_PFparameters.get(0) == null || _PFparameters.get(0) instanceof LogEntry)) {
          return false;
        }
        return true;
      }
      public Object execute(final IPFContext _PFcontext, final ParameterList _PFparameters) {
        ExplorerElement result = new ExplorerElement();
        result.text = ((String) _PFcontext.callFunction("de.q60.mps.explorer.pf.TraceBuilders_base.toString", new ParameterList(new Object[]{((LogEntry) _PFparameters.get(0))})));
        for (Object detail : ((LogEntry) _PFparameters.get(0)).getDetails()) {
          result.addChild(detail);
        }

        ExplorerElement teStackTrace = new ExplorerElement();
        teStackTrace.text = "Stack Trace";
        for (StackTraceElement traceElement : ((LogEntry) _PFparameters.get(0)).getStackTrace()) {
          teStackTrace.addChild(traceElement);
        }
        result.addChild(teStackTrace);

        return result;
      }
      @Override
      public Iterable<IParameterType> getParameterTypes() {
        return myParameterTypes;
      }
      @Override
      public Iterable<String> getContextIds() {
        return contextIds;
      }
      @Override
      public Iterable<String> getPriorityGroupIds() {
        return groupIds;
      }
    });
    addImplementation("de.q60.mps.explorer.pf.TraceBuilders_base.toString", new IFunctionImplementation() {
      private List<IParameterType> myParameterTypes = ListSequence.fromListAndArray(new ArrayList<IParameterType>(), new ParameterType_Classifier(LogEntry.class));
      private List<String> contextIds = ListSequence.fromList(new ArrayList<String>());
      private List<String> groupIds = ListSequence.fromList(new ArrayList<String>());
      @Override
      public String getId() {
        return "de.q60.mps.shadowmodels.debugview.pf/TraceBuilders_ErrorLog/toString_4";
      }
      public boolean isApplicable(final IPFContext _PFcontext, final ParameterList _PFparameters) {
        if (!(_PFparameters.get(0) == null || _PFparameters.get(0) instanceof LogEntry)) {
          return false;
        }
        return true;
      }
      public Object execute(final IPFContext _PFcontext, final ParameterList _PFparameters) {
        return ((LogEntry) _PFparameters.get(0)).getMessage();
      }
      @Override
      public Iterable<IParameterType> getParameterTypes() {
        return myParameterTypes;
      }
      @Override
      public Iterable<String> getContextIds() {
        return contextIds;
      }
      @Override
      public Iterable<String> getPriorityGroupIds() {
        return groupIds;
      }
    });
    addImplementation("de.q60.mps.explorer.pf.TraceBuilders_base.buildTrace", new IFunctionImplementation() {
      private List<IParameterType> myParameterTypes = ListSequence.fromListAndArray(new ArrayList<IParameterType>(), new ParameterType_Classifier(StackTraceElement.class));
      private List<String> contextIds = ListSequence.fromListAndArray(new ArrayList<String>(), "de.q60.mps.explorer.pf.TraceBuilders_base.explorerContextGroup");
      private List<String> groupIds = ListSequence.fromList(new ArrayList<String>());
      @Override
      public String getId() {
        return "de.q60.mps.shadowmodels.debugview.pf/TraceBuilders_ErrorLog/buildTrace_6";
      }
      public boolean isApplicable(final IPFContext _PFcontext, final ParameterList _PFparameters) {
        if (!(_PFparameters.get(0) == null || _PFparameters.get(0) instanceof StackTraceElement)) {
          return false;
        }
        return true;
      }
      public Object execute(final IPFContext _PFcontext, final ParameterList _PFparameters) {
        ExplorerElement result = new ExplorerElement();
        result.text = ((String) _PFcontext.callFunction("de.q60.mps.explorer.pf.TraceBuilders_base.toString", new ParameterList(new Object[]{((StackTraceElement) _PFparameters.get(0))})));
        result.navigationTarget = () -> {
          Iterator<DebugInfo> itr = new DefaultTraceInfoProvider(((IExplorerContext) _PFcontext.getContextParameters("de.q60.mps.explorer.pf.TraceBuilders_base.explorerContextGroup").get(0)).getRepository()).debugInfo(NameUtil.namespaceFromLongName(((StackTraceElement) _PFparameters.get(0)).getClassName())).iterator();
          while (itr.hasNext()) {
            DebugInfo info = itr.next();
            SNodeReference nodeRef = new BaseLanguageNodeLookup(info).getNodeAt(((StackTraceElement) _PFparameters.get(0)).getFileName(), ((StackTraceElement) _PFparameters.get(0)).getLineNumber());
            if (nodeRef == null) {
              continue;
            }
            return nodeRef.resolve(((IExplorerContext) _PFcontext.getContextParameters("de.q60.mps.explorer.pf.TraceBuilders_base.explorerContextGroup").get(0)).getRepository());
          }
          return null;
        };
        return result;
      }
      @Override
      public Iterable<IParameterType> getParameterTypes() {
        return myParameterTypes;
      }
      @Override
      public Iterable<String> getContextIds() {
        return contextIds;
      }
      @Override
      public Iterable<String> getPriorityGroupIds() {
        return groupIds;
      }
    });
    addImplementation("de.q60.mps.explorer.pf.TraceBuilders_base.toString", new IFunctionImplementation() {
      private List<IParameterType> myParameterTypes = ListSequence.fromListAndArray(new ArrayList<IParameterType>(), new ParameterType_Classifier(StackTraceElement.class));
      private List<String> contextIds = ListSequence.fromList(new ArrayList<String>());
      private List<String> groupIds = ListSequence.fromList(new ArrayList<String>());
      @Override
      public String getId() {
        return "de.q60.mps.shadowmodels.debugview.pf/TraceBuilders_ErrorLog/toString_8";
      }
      public boolean isApplicable(final IPFContext _PFcontext, final ParameterList _PFparameters) {
        if (!(_PFparameters.get(0) == null || _PFparameters.get(0) instanceof StackTraceElement)) {
          return false;
        }
        return true;
      }
      public Object execute(final IPFContext _PFcontext, final ParameterList _PFparameters) {
        return ((StackTraceElement) _PFparameters.get(0)).toString();
      }
      @Override
      public Iterable<IParameterType> getParameterTypes() {
        return myParameterTypes;
      }
      @Override
      public Iterable<String> getContextIds() {
        return contextIds;
      }
      @Override
      public Iterable<String> getPriorityGroupIds() {
        return groupIds;
      }
    });
  }
}
