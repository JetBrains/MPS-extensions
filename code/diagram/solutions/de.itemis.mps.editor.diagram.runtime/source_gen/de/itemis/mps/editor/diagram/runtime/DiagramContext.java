package de.itemis.mps.editor.diagram.runtime;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import de.itemis.mps.editor.diagram.runtime.jgraph.BaseDiagramECell;
import de.itemis.mps.editor.diagram.runtime.jgraph.BaseDiagramDCell;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.Sequence;
import de.itemis.mps.editor.diagram.runtime.model.DiagramModel;
import de.itemis.mps.editor.diagram.runtime.jgraph.MyGraph;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import java.util.Collections;

public class DiagramContext {

  private static List<IContext> ourContextStack = ListSequence.fromList(new ArrayList<IContext>());

  public static void withContext(IContext context, Runnable runnable) {
    ListSequence.fromList(ourContextStack).addElement(context);
    try {
      runnable.run();
    } finally {
      ListSequence.fromList(ourContextStack).removeLastElement();
    }
  }

  public static void withContext(BaseDiagramECell cell, Runnable runnable) {
    withContext(new ECellContext(cell), runnable);
  }

  public static void withContext(BaseDiagramDCell cell, Runnable runnable) {
    withContext(new DCellContext(cell), runnable);
  }

  public static void withContext(SNode node, _FunctionTypes._return_P0_E0<? extends BaseDiagramECell> ecellAccessor, Runnable runnable) {
    withContext(new NodeContext(node, ecellAccessor), runnable);
  }

  public static List<SNode> getAllDiagramNodes() {
    return ListSequence.fromList(ourContextStack).select((it) -> it.getSNode()).distinct().toList();
  }

  public static List<BaseDiagramECell> getAllECells() {
    return ListSequence.fromList(ourContextStack).select((it) -> it.getECell()).where((it) -> it != null).translate((it) -> Sequence.fromIterable(getAncestorECells(it)).concat(Sequence.fromIterable(Sequence.<BaseDiagramECell>singleton(it)))).distinct().toList();
  }

  public static List<BaseDiagramDCell> getAllDCells() {
    return ListSequence.fromList(ourContextStack).select((it) -> it.getDCell()).where((it) -> it != null).distinct().toList();
  }

  public static List<DiagramModel> getAllDiagramModels() {
    return ListSequence.fromList(ourContextStack).select((it) -> it.getDiagramModel()).where((it) -> it != null).distinct().toList();
  }

  public static MyGraph getGraph() {
    return ListSequence.fromList(ourContextStack).select((it) -> it.getGraph()).findFirst((it) -> it != null);
  }

  protected static Iterable<BaseDiagramECell> getAncestorECells(BaseDiagramECell cell) {
    return Sequence.fromIterable(getAncestorCells(cell)).ofType(BaseDiagramECell.class);
  }

  protected static Iterable<EditorCell> getAncestorCells(EditorCell cell) {
    EditorCell_Collection parent = cell.getParent();
    if (parent == null) {
      return Sequence.fromIterable(Collections.<EditorCell>emptyList());
    } else {
      return Sequence.fromIterable(getAncestorCells(parent)).concat(Sequence.fromIterable(Sequence.<EditorCell>singleton(cell)));
    }
  }

  public interface IContext {
    SNode getSNode();
    BaseDiagramECell getECell();
    BaseDiagramDCell getDCell();
    MyGraph getGraph();
    DiagramModel getDiagramModel();
  }

  public static abstract class AbstractContext implements IContext {
    public BaseDiagramDCell getDCell() {
      return ((BaseDiagramDCell) getECell().getDCell());
    }
    public DiagramModel getDiagramModel() {
      return getECell().getDiagramModel();
    }
    public MyGraph getGraph() {
      return getDCell()._getGraph();
    }
    public SNode getSNode() {
      return getECell().getSNode();
    }
    public BaseDiagramECell getECell() {
      return getDCell().getECell();
    }
  }

  public static class ECellContext extends AbstractContext {

    private BaseDiagramECell myCell;

    public ECellContext(BaseDiagramECell cell) {
      myCell = cell;
    }
    public BaseDiagramECell getECell() {
      return myCell;
    }
  }
  public static class DCellContext extends AbstractContext {

    private BaseDiagramDCell myCell;

    public DCellContext(BaseDiagramDCell cell) {
      myCell = cell;
    }
    public BaseDiagramDCell getDCell() {
      return myCell;
    }
  }
  public static class NodeContext extends AbstractContext {

    private SNode myNode;
    private _FunctionTypes._return_P0_E0<? extends BaseDiagramECell> myECellAccessor;

    public NodeContext(SNode node, _FunctionTypes._return_P0_E0<? extends BaseDiagramECell> eCellAccessor) {
      myNode = node;
      myECellAccessor = eCellAccessor;
    }

    @Override
    public SNode getSNode() {
      return myNode;
    }

    @Override
    public BaseDiagramECell getECell() {
      return myECellAccessor.invoke();
    }
  }
}
