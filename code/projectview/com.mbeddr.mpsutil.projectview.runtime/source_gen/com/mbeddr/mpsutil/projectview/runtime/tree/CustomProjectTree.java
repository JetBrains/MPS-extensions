package com.mbeddr.mpsutil.projectview.runtime.tree;

/*Generated by MPS */

import jetbrains.mps.ide.ui.tree.MPSTree;
import jetbrains.mps.project.Project;
import com.mbeddr.mpsutil.projectview.runtime.ViewId;
import com.mbeddr.mpsutil.projectview.runtime.tree.highlighter.ProjectPaneTreeHighlighter;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import javax.swing.tree.TreePath;
import java.util.List;
import jetbrains.mps.ide.ui.tree.MPSTreeNode;
import jetbrains.mps.smodel.ModelReadRunnable;
import com.intellij.openapi.actionSystem.ActionGroup;
import com.mbeddr.mpsutil.projectview.runtime.ViewElement;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.workbench.action.ActionUtils;
import org.jetbrains.mps.util.Condition;

public class CustomProjectTree extends MPSTree {

  private final Project myMpsProject;
  private final ViewId myViewId;
  private final ProjectPaneTreeHighlighter myHighlighter;
  private final CustomTreeNodesUpdater myUpdater;

  public CustomProjectTree(final Project mpsProject, final ViewId viewId) {
    myMpsProject = mpsProject;
    myViewId = viewId;
    setCellRenderer(new TreeCellRenderer());
    setRootVisible(false);
    rebuildLater();

    myHighlighter = new ProjectPaneTreeHighlighter(this, myMpsProject);
    myHighlighter.init();
    myUpdater = new CustomTreeNodesUpdater(mpsProject);
    myUpdater.init();

    addMouseListener(new MouseAdapter() {

      @Override
      public void mouseClicked(MouseEvent event) {
        final TreePath path = getPathForLocation(event.getX(), event.getY());
        if (path == null) {
          return;
        }
        final Object selectedObject = path.getLastPathComponent();
        if (selectedObject instanceof CustomTreeNode) {
          final CustomTreeNode treeNode = ((CustomTreeNode) selectedObject);
          if (treeNode.canUpdateManually()) {
            treeNode.updateManually();
          }
        }
      }
    });
  }

  public Project getProject() {
    return myMpsProject;
  }

  public ViewId getViewId() {
    return myViewId;
  }

  @Override
  public void loadState(final List<List<String>> list, final List<List<String>> list1) {
    CustomTreeNode.loadAllImmediately(() -> super_loadState(list, list1));
  }

  protected void super_loadState(final List<List<String>> list, final List<List<String>> list1) {
    super.loadState(list, list1);
  }

  @Override
  protected void doInit(final MPSTreeNode node, final Runnable nodeInitRunnable) {
    super.doInit(node, new ModelReadRunnable(myMpsProject.getModelAccess(), nodeInitRunnable));
  }

  @Override
  public void runRebuildAction(final Runnable rebuildAction, final boolean saveExpansion) {
    super.runRebuildAction(new ModelReadRunnable(myMpsProject.getModelAccess(), rebuildAction), saveExpansion);
  }

  protected MPSTreeNode rebuild() {
    final CustomRootTreeNode rootNode = new CustomRootTreeNode(myMpsProject, myViewId);
    return rootNode;
  }

  @Override
  protected ActionGroup createPopupActionGroup(final MPSTreeNode node) {
    if (node instanceof CustomTreeNode) {
      final CustomTreeNode customNode = ((CustomTreeNode) node);
      if (customNode.isInvalid()) {
        return null;
      }
      final ViewElement element = customNode.getElement();
      final Wrappers._T<ActionGroup> result = new Wrappers._T<ActionGroup>(null);
      myMpsProject.getRepository().getModelAccess().runReadAction(() -> {
        final String actionGroupId = element.getActionGroupId();
        if (actionGroupId != null) {
          result.value = ActionUtils.getGroup(actionGroupId);
        }
      });
      return result.value;
    } else if (node instanceof FolderTreeNode) {
      final FolderTreeNode folderNode = ((FolderTreeNode) node);
      if (folderNode.isInvalid()) {
        return null;
      }

      ActionGroup result = null;
      final String actionGroupId = folderNode.getActionGroupId();
      if (actionGroupId != null) {
        result = ActionUtils.getGroup(actionGroupId);
      }
      return result;
    }
    return null;
  }

  @Override
  public void dispose() {
    if (isDisposed()) {
      return;
    }
    myUpdater.dispose();
    myHighlighter.dispose();
    super.dispose();
  }

  public void expandProjectNode() {
    final CustomTreeNode projectNode = new ProjectTreeFindHelper(this).findTreeNode(getRootNode(), Project.class, Condition.TRUE_CONDITION, Condition.TRUE_CONDITION);
    if (projectNode != null) {
      expandPath(new TreePath(projectNode.getPath()));
    }
  }

  public CustomTreeNodesUpdater getUpdater() {
    return myUpdater;
  }
}
