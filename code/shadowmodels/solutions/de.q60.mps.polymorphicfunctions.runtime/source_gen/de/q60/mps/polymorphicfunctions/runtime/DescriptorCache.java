package de.q60.mps.polymorphicfunctions.runtime;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.util.Map;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import org.jetbrains.mps.openapi.module.SModuleReference;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.smodel.runtime.ModuleDeploymentListener;
import jetbrains.mps.smodel.language.LanguageRegistry;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.smodel.runtime.ModuleDeploymentChange;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import java.util.concurrent.atomic.AtomicReference;
import java.util.stream.Stream;
import java.lang.reflect.Field;

public class DescriptorCache {
  private static final Logger LOG = Logger.getLogger(DescriptorCache.class);

  private static DescriptorCache INSTANCE = new DescriptorCache();

  public static DescriptorCache getInstance() {
    return INSTANCE;
  }

  private Map<Tuples._2<SModuleReference, String>, PFDescriptor> loadedDescriptors = MapSequence.fromMap(new HashMap<>());

  private ModuleDeploymentListener deployListener = null;
  private LanguageRegistry languageRegistry;

  public void init(@NotNull LanguageRegistry languageRegistry) {
    if (this.languageRegistry != null) {
      throw new IllegalStateException("Already initialized");
    }
    this.languageRegistry = languageRegistry;
  }

  public void invalidate() {
    if (LOG.isDebugLevel()) {
      LOG.debug("Invalidate Descriptors");
    }
    MapSequence.fromMap(loadedDescriptors).clear();
  }

  public void dispose() {
    if (deployListener != null) {
      languageRegistry.removeRegistryListener(deployListener);
      deployListener = null;
    }
    loadedDescriptors = null;
    languageRegistry = null;
  }

  @Nullable
  public PFDescriptor getDescriptor(@Nullable SModule module, String modelName) {
    PFDescriptor descriptor = getDescriptor_(module, modelName);
    if (descriptor != null) {
      if (deployListener == null && languageRegistry != null) {
        deployListener = new ModuleDeploymentListener() {
          @Override
          public void deploymentStateChanged(@NotNull ModuleDeploymentChange change) {
            invalidate();
          }
        };
        languageRegistry.addRegistryListener(deployListener);
      }
    }
    return descriptor;
  }

  protected PFDescriptor getDescriptor_(@Nullable SModule module, String modelName) {
    if (module == null || languageRegistry == null) {
      return null;
    }
    final SModuleReference mref = module.getModuleReference();
    if (MapSequence.fromMap(loadedDescriptors).containsKey(MultiTuple.<SModuleReference,String>from(mref, modelName))) {
      return MapSequence.fromMap(loadedDescriptors).get(MultiTuple.<SModuleReference,String>from(mref, modelName));
    }
    PFDescriptor descriptor = getDescriptor__(mref, modelName);
    MapSequence.fromMap(loadedDescriptors).put(MultiTuple.<SModuleReference,String>from(mref, modelName), descriptor);
    return descriptor;
  }

  protected PFDescriptor getDescriptor__(SModuleReference module, String modelName) {
    final String modelFQName = module.getModuleName() + "." + modelName;
    final String className = modelFQName + ".PolymorphicFunctionsDescriptor";
    final AtomicReference<PFDescriptor> rv = new AtomicReference<>();
    languageRegistry.withModuleRuntime(Stream.of(module), (mr) -> {
      try {
        Class<?> cls = mr.getOwnClass(className);
        Field instanceField = (cls == null ? null : cls.getDeclaredField("INSTANCE"));
        if (instanceField != null) {
          PFDescriptor descriptor = as_8t64d5_a0a0a2a0a1a0d0v(instanceField.get(null), PFDescriptor.class);
          if (LOG.isDebugLevel()) {
            LOG.debug("Loaded descriptor from " + modelFQName);
          }
          rv.set(descriptor);
        }
        return;
      } catch (ClassNotFoundException e) {
        // ignore, it's fine
        return;
      } catch (NoClassDefFoundError e) {
        if (LOG.isErrorLevel()) {
          LOG.error("Failed to load class " + className, e);
        }
      } catch (Exception e) {
        if (LOG.isErrorLevel()) {
          LOG.error("", e);
        }
      }
    });
    return rv.get();
  }
  private static <T> T as_8t64d5_a0a0a2a0a1a0d0v(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
