package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import java.util.List;
import de.itemis.mps.editor.diagram.runtime.model.Edge;
import java.util.ArrayList;
import java.util.Set;
import de.itemis.mps.editor.diagram.runtime.model.DiagramModel;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.LinkedHashSet;
import java.util.Map;
import com.mxgraph.model.mxCell;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import java.util.Deque;
import java.util.ArrayDeque;
import java.util.HashSet;
import de.itemis.mps.editor.diagram.runtime.model.IDiagramElement;
import com.mxgraph.view.mxGraph;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.mxgraph.model.mxGraphModel;

public class SyncContext {
  private List<Edge> myUnresolvedEdges = new ArrayList<Edge>();
  private Set<DiagramModel> myModels = SetSequence.fromSet(new LinkedHashSet<DiagramModel>());
  private Map<String, mxCell> myId2cell = MapSequence.fromMap(new HashMap<String, mxCell>());
  private Deque<DiagramModel> myModelStack = new ArrayDeque<DiagramModel>();
  private Set<mxCell> myCellsToKeep = SetSequence.fromSet(new HashSet<mxCell>());
  private Set<IDiagramElement> myElementsToKeep = SetSequence.fromSet(new HashSet<IDiagramElement>());
  private mxGraph myGraph;

  public SyncContext(mxGraph graph) {
    myGraph = graph;
  }

  public void addUnresolvedEdge(Edge edge) {
    myUnresolvedEdges.add(edge);
  }

  public List<Edge> getAndRemoveUnresolvedEdges() {
    List<Edge> result = myUnresolvedEdges;
    myUnresolvedEdges = ListSequence.fromList(new ArrayList<Edge>());
    return result;
  }

  public List<DiagramModel> getModels() {
    return SetSequence.fromSet(myModels).toList();
  }

  public void pushModel(DiagramModel model) {
    myModelStack.addLast(model);
    SetSequence.fromSet(myModels).addElement(model);
  }

  public DiagramModel popModel() {
    return myModelStack.removeLast();
  }

  public DiagramModel getCurrentModel() {
    return myModelStack.getLast();
  }

  public void executeWithModel(DiagramModel model, Runnable runnable) {
    try {
      pushModel(model);
      runnable.run();
    } finally {
      popModel();
    }
  }

  public void registerCell(mxCell cell) {
    MapSequence.fromMap(myId2cell).put(cell.getId(), cell);
  }

  public mxCell getCell(String id) {
    if (id == null) {
      return null;
    }
    mxCell cell;
    mxGraphModel model = (mxGraphModel) myGraph.getModel();
    cell = (mxCell) model.getCell(id);
    if (cell == null) {
      cell = MapSequence.fromMap(myId2cell).get(id);
    }
    return cell;
  }

  public void keepCell(mxCell cell) {
    SetSequence.fromSet(myCellsToKeep).addElement(cell);
  }

  public boolean shouldKeepCell(mxCell cell) {
    return SetSequence.fromSet(myCellsToKeep).contains(cell);
  }

  public void keepElement(IDiagramElement element) {
    SetSequence.fromSet(myElementsToKeep).addElement(element);
  }

  public boolean shouldKeepElement(IDiagramElement element) {
    return SetSequence.fromSet(myElementsToKeep).contains(element);
  }
}
