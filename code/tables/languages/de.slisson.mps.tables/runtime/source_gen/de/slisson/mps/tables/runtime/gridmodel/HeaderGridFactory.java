package de.slisson.mps.tables.runtime.gridmodel;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.editor.runtime.style.StyleImpl;
import jetbrains.mps.openapi.editor.style.Style;
import de.slisson.mps.tables.runtime.style.CloningTableStyleFactory;
import de.slisson.mps.tables.runtime.style.ITableStyleFactory;
import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import java.util.List;
import jetbrains.mps.util.IterableUtil;
import de.slisson.mps.tables.runtime.cells.ChildsTracker;
import jetbrains.mps.openapi.editor.cells.EditorCell_Label;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import jetbrains.mps.editor.runtime.cells.AbstractCellAction;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;

public class HeaderGridFactory {

  private EditorContext myContext;
  private SNode mySNode;
  private boolean myForColumnHeaders;

  public HeaderGridFactory(EditorContext context, SNode snode, boolean forColumnHeaders) {
    myContext = context;
    mySNode = snode;
    myForColumnHeaders = forColumnHeaders;
  }

  public HeaderGrid createFromObject(@Nullable Object object) {
    return createFromObject(object, null, null, null, 0, new StyleImpl(), null);
  }

  public HeaderGrid createFromObject(@Nullable Object object, HeaderReference key, IHeaderNodeInsertAction insertAction, IHeaderNodeDeleteAction deleteAction, int index, Style style, String name) {
    return createFromObject(object, key, insertAction, deleteAction, index, new CloningTableStyleFactory(style), name);
  }

  public HeaderGrid createFromObject(@Nullable Object object, @Nullable HeaderReference key, IHeaderNodeInsertAction insertAction, IHeaderNodeDeleteAction deleteAction, int index, ITableStyleFactory styleFactory, String name) {
    if (object == null) {
      EditorCell_Constant nullCell = new EditorCell_Constant(myContext, mySNode, "");
      nullCell.setDefaultText("<null>");
      if (key == null) {
        key = StringHeaderReference.createUnique();
      }
      return createFromEditorCell(nullCell, key, insertAction, deleteAction, index, styleFactory.createStyle(0, 0));
    } else if (object instanceof EditorCell) {
      return createFromEditorCell((EditorCell) object, key, insertAction, deleteAction, index, styleFactory.createStyle(0, 0));
    } else if (object instanceof SNode) {
      return createFromSNode((SNode) object, key, insertAction, deleteAction, index, styleFactory.createStyle(0, 0));
    } else if (object instanceof String) {
      return createFromString((String) object, key, insertAction, deleteAction, index, styleFactory.createStyle(0, 0));
    } else if (object instanceof List) {
      return createFromObjectList((List) object, key, insertAction, deleteAction, styleFactory, name);
    } else if (object instanceof Iterable) {
      return createFromObjectList(IterableUtil.asList((Iterable) object), key, insertAction, deleteAction, styleFactory, name);
    } else {
      throw new IllegalArgumentException("Argument of type " + object.getClass() + " not supported: " + object);
    }
  }

  public HeaderGrid createFromString(String text, @Nullable HeaderReference key, IHeaderNodeInsertAction insertAction, IHeaderNodeDeleteAction deleteAction, int index, Style style) {
    if (key == null) {
      key = new StringHeaderReference(text);
    }
    EditorCell_Constant cell = new EditorCell_Constant(myContext, mySNode, text);
    return createFromEditorCell(cell, key, insertAction, deleteAction, index, style);
  }

  public HeaderGrid createFromSNode(SNode snode, @Nullable HeaderReference key, int index) {
    return createFromSNode(snode, key, null, null, index, null);
  }

  public HeaderGrid createFromSNode(SNode snode, @Nullable HeaderReference key, IHeaderNodeInsertAction insertAction, IHeaderNodeDeleteAction deleteAction, int index, Style style) {
    if (key == null) {
      key = StringHeaderReference.fromSNode(snode);
    }
    EditorCell cell = myContext.getEditorComponent().getUpdater().getCurrentUpdateSession().updateChildNodeCell(snode);
    ChildsTracker.getInstance().registerChild(cell);
    return createFromEditorCell(cell, key, insertAction, deleteAction, index, style);
  }

  public HeaderGrid createFromEditorCell(EditorCell editorCell, @Nullable HeaderReference key, final IHeaderNodeInsertAction insertAction, final IHeaderNodeDeleteAction deleteAction, final int index, Style style) {
    if (key == null) {
      if (editorCell instanceof EditorCell_Label) {
        key = new StringHeaderReference(((EditorCell_Label) editorCell).getText());
      } else {
        key = new StringHeaderReference(editorCell.getCellId());
      }
    }
    HeaderGrid grid = new HeaderGrid();
    EditorCellHeader header = new EditorCellHeader(key, editorCell);
    if (style != null) {
      editorCell.getStyle().putAll(style);
      header.setStyle(style);
    }
    if (insertAction != null) {
      editorCell.setAction(CellActionType.INSERT, new AbstractCellAction() {
        public void execute(EditorContext p0) {
          insertAction.insertNew(index + 1);
        }
      });
      editorCell.setAction(CellActionType.INSERT_BEFORE, new AbstractCellAction() {
        public void execute(EditorContext p0) {
          insertAction.insertNew(index);
        }
      });
      header.setInsertAction(editorCell.getAction(CellActionType.INSERT));
      header.setInsertBeforeAction(editorCell.getAction(CellActionType.INSERT_BEFORE));
    }
    if (deleteAction != null) {
      editorCell.setAction(CellActionType.DELETE, new AbstractCellAction() {
        public void execute(EditorContext p0) {
          deleteAction.delete(index);
        }
      });
      editorCell.setAction(CellActionType.BACKSPACE, editorCell.getAction(CellActionType.DELETE));
    }
    grid.setElement(0, 0, header);
    return grid;
  }

  public HeaderGrid createFromObjectList(List<Object> objects, @Nullable HeaderReference key, IHeaderNodeInsertAction insertAction, IHeaderNodeDeleteAction deleteAction, ITableStyleFactory style, String name) {

    List<HeaderGrid> grids = new ArrayList<HeaderGrid>(objects.size());
    int index = 0;
    for (Object object : objects) {
      HeaderReference currentKey;
      if (key != null) {
        currentKey = new StringHeaderReference(key.getFallbackText() + "_" + index);
      } else {
        currentKey = StringHeaderReference.fromObject(object);
      }
      grids.add(createFromObject(object, (object == null ? null : currentKey), insertAction, deleteAction, index, style.createStyle(index, index), name + index));
      index++;
    }
    return createFromHeaderGridList(grids);
  }

  public HeaderGrid createFromHeaderGridList(List<HeaderGrid> headerGrids) {
    HeaderGrid result = new HeaderGrid();
    int offset = 0;
    for (HeaderGrid g : ListSequence.fromList(headerGrids)) {
      if (myForColumnHeaders) {
        result.setElements(offset, 0, g);
        offset += g.getSizeX();
      } else {
        result.setElements(0, offset, g);
        offset += g.getSizeY();
      }
    }
    return result;
  }

  private static Iterable<EditorCell> descendantsOfSameNode(EditorCell cell) {
    Iterable<EditorCell> result = Sequence.<EditorCell>singleton(cell);
    if (cell instanceof EditorCell_Collection) {
      Iterable<EditorCell> children = ((EditorCell_Collection) cell);
      result = Sequence.fromIterable(result).concat(Sequence.fromIterable(children).where((it) -> it.getSNode() == it.getParent().getSNode()).translate((it) -> descendantsOfSameNode(it)));
    }
    return result;
  }
}
