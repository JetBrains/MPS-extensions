package de.slisson.mps.tables.runtime.gridmodel;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import java.util.List;
import jetbrains.mps.util.IterableUtil;
import de.slisson.mps.tables.runtime.cells.ChildsTracker;
import de.slisson.mps.tables.runtime.cells.PartialTableExtractor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;

public class GridElementFactory {
  private EditorContext myEditorContext;
  private SNode mySNode;
  private EditorCellFactory myEditorCellFactory;
  private boolean myNodeListAsMultipleCells;
  private boolean myNodeListHorizontal;
  private Grid myParentGrid;

  public GridElementFactory(EditorContext editorContext, SNode snode, boolean nodeListAsMultipleCells, boolean nodeListHorizontal, Grid parentGrid) {
    myEditorContext = editorContext;
    mySNode = snode;
    myEditorCellFactory = new EditorCellFactory(editorContext, snode, parentGrid);
    myNodeListAsMultipleCells = nodeListAsMultipleCells;
    myNodeListHorizontal = nodeListHorizontal;
    myParentGrid = parentGrid;
  }

  public GridElementFactory(EditorContext editorContext, SNode snode) {
    this(editorContext, snode, true, false, null);
  }

  public IGridElement create(Object content) {
    if (content == null) {
      return create(new EditorCell_Null(myEditorContext, mySNode));
    } else if (content instanceof IGridElement) {
      return (IGridElement) content;
    } else if (content instanceof SNode) {
      return create((SNode) content);
    } else if (content instanceof String) {
      return create((String) content);
    } else if (content instanceof EditorCell) {
      return create((EditorCell) content);
    } else if (content instanceof List) {
      return createFromObjectList((List) content);
    } else if (content instanceof Iterable) {
      return createFromObjectList(IterableUtil.asList((Iterable) content));
    } else {
      throw new IllegalArgumentException("Argument of type " + content.getClass().getName() + " not supported: " + content);
    }
  }

  public IGridElement create(String text) {
    EditorCell cell = myEditorCellFactory.createConstant(text);
    ChildsTracker.getInstance().registerChild(cell);
    return create(cell);
  }

  public IGridElement create(EditorCell editorCell) {
    if (myParentGrid != null) {
      IGridElement element = PartialTableExtractor.getGridElementFromEditorCell(editorCell, myParentGrid);
      if (element != null) {
        return element;
      }
    }
    return new EditorCellGridLeaf(editorCell);
  }

  public IGridElement create(SNode snode) {
    EditorCell editorCell = myEditorContext.getEditorComponent().getUpdater().getCurrentUpdateSession().updateChildNodeCell(snode);
    ChildsTracker.getInstance().registerChild(editorCell);
    return create(editorCell);
  }

  public IGridElement createFromObjectList(List<Object> objects) {
    boolean allSNodes = ListSequence.fromList(((List<Object>) objects)).foldLeft(true, (Boolean s, Object it) -> s && it instanceof SNode);
    if (allSNodes) {
      List<SNode> nlist = new ArrayList<SNode>();
      for (Object obj : objects) {
        ListSequence.fromList(nlist).addElement((SNode) obj);
      }
      return createFromSNodeList(nlist);
    }

    List<IGridElement> gridElements = new ArrayList<IGridElement>(objects.size());
    for (Object object : objects) {
      gridElements.add(create(object));
    }
    return createFromGridElementList(gridElements);
  }

  public IGridElement createFromSNodeList(List<SNode> snodes) {
    if (myNodeListAsMultipleCells) {
      return createFromGridElementList(new ArrayList<IGridElement>(ListSequence.fromList(snodes).select((it) -> create(it)).toList()));
    } else {
      EditorCell_Collection collectionCell = (myNodeListHorizontal ? jetbrains.mps.nodeEditor.cells.EditorCell_Collection.createHorizontal(myEditorContext, SNodeOperations.getParent(ListSequence.fromList(snodes).first())) : jetbrains.mps.nodeEditor.cells.EditorCell_Collection.createVertical(myEditorContext, SNodeOperations.getParent(ListSequence.fromList(snodes).first())));
      for (SNode node : ListSequence.fromList(snodes)) {
        EditorCell nodeCell = myEditorContext.getEditorComponent().getUpdater().getCurrentUpdateSession().updateChildNodeCell(node);
        ChildsTracker.getInstance().registerChild(nodeCell);
        collectionCell.addEditorCell(nodeCell);
      }
      return create(collectionCell);
    }
  }

  public IGridElement createFromGridElementList(List<IGridElement> gridElements) {
    Grid result = new Grid();
    for (int i = 0; i < gridElements.size(); i++) {
      if (myNodeListHorizontal) {
        result.setElement(i, 0, gridElements.get(i));
      } else {
        result.setElement(0, i, gridElements.get(i));
      }
    }
    return result;
  }

}
