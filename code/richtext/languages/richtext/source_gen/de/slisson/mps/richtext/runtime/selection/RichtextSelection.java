package de.slisson.mps.richtext.runtime.selection;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.selection.AbstractSelection;
import jetbrains.mps.logging.Logger;
import jetbrains.mps.nodeEditor.cells.EditorCell;
import java.util.List;
import jetbrains.mps.openapi.editor.selection.Selection;
import java.awt.event.KeyListener;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import jetbrains.mps.openapi.editor.EditorComponent;
import java.util.Map;
import jetbrains.mps.openapi.editor.cells.CellInfo;
import jetbrains.mps.openapi.editor.selection.SelectionStoreException;
import jetbrains.mps.nodeEditor.selection.SelectionRestoreException;
import jetbrains.mps.nodeEditor.selection.SelectionInfoImpl;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.openapi.editor.selection.SelectionManager;
import de.slisson.mps.editor.multiline.cells.EditorCell_Multiline;
import de.slisson.mps.editor.multiline.cells.MultilineSelection;
import jetbrains.mps.nodeEditor.cells.EditorCell_Label;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import de.slisson.mps.richtext.editor.TextCellModifier;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import de.slisson.mps.richtext.behavior.Word__BehaviorDescriptor;
import de.slisson.mps.editor.multiline.cells.SelectionUtil;
import jetbrains.mps.openapi.editor.cells.CellTraversalUtil;
import de.slisson.mps.editor.multiline.cells.EditorCell_Word;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import javax.swing.SwingUtilities;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import de.slisson.mps.richtext.behavior.Text__BehaviorDescriptor;
import jetbrains.mps.smodel.CopyUtil;
import de.slisson.mps.richtext.util.RichtextUtil;
import jetbrains.mps.ide.datatransfer.CopyPasteUtil;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import de.slisson.mps.editor.multiline.runtime.ClipboardUtils;
import jetbrains.mps.nodeEditor.selection.EditorCellLabelSelection;
import de.slisson.mps.richtext.util.SelectionUtils;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.openapi.editor.selection.SelectionInfo;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import java.util.Objects;
import java.awt.Graphics2D;
import jetbrains.mps.nodeEditor.selection.SelectionInternal;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.editor.runtime.cells.ReadOnlyUtil;
import jetbrains.mps.nodeEditor.cells.TextLine;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import java.awt.FontMetrics;
import de.slisson.mps.richtext.behavior.IWord__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class RichtextSelection extends AbstractSelection {
  private static final Logger LOG = Logger.getLogger(RichtextSelection.class);
  private static final String PROPERTY_NUM_WORDS = "numCells";
  private static final String PROPERTY_START_TEXT_POS = "startTextPos";
  private static final String PROPERTY_END_TEXT_POS = "endTextPos";
  private static final String PROPERTY_LEFT_TO_RIGHT = "leftToRight";
  private EditorCell myStartCell;
  private int myNumWords;
  private int myStartTextPos = 0;
  private int myEndTextPos = 0;
  private boolean myLeftToRight;
  private List<Selection> subSelections;
  private KeyListener keyListener = new KeyAdapter() {
    @Override
    public void keyTyped(KeyEvent event) {
      processKeyTyped(event);
    }
  };

  public RichtextSelection(EditorComponent editorComponent, Map<String, String> properties, CellInfo cellInfo) throws SelectionStoreException, SelectionRestoreException {
    super(editorComponent);
    if (cellInfo == null) {
      throw new SelectionStoreException("Required CellInfo parameter is null");
    }
    myStartCell = (EditorCell) cellInfo.findCell(((jetbrains.mps.nodeEditor.EditorComponent) editorComponent));
    if (myStartCell == null) {
      throw new SelectionRestoreException();
    }
    myNumWords = SelectionInfoImpl.Util.getIntProperty(properties, PROPERTY_NUM_WORDS);
    myStartTextPos = SelectionInfoImpl.Util.getIntProperty(properties, PROPERTY_START_TEXT_POS);
    myEndTextPos = SelectionInfoImpl.Util.getIntProperty(properties, PROPERTY_END_TEXT_POS);
    myLeftToRight = SelectionInfoImpl.Util.getBooleanProperty(properties, PROPERTY_LEFT_TO_RIGHT);
    initSubSelections();
  }
  public RichtextSelection(EditorComponent editorComponent, EditorCell startCell, int numWords, int startTextPos, int endTextPos, boolean leftToRight) {
    super(editorComponent);
    myStartCell = startCell;
    myNumWords = numWords;
    myStartTextPos = startTextPos;
    myEndTextPos = endTextPos;
    myLeftToRight = leftToRight;
    initSubSelections();
  }
  public void initSubSelections() {
    subSelections = ListSequence.fromList(new ArrayList<Selection>());
    SelectionManager selectionManager = getEditorComponent().getSelectionManager();
    List<jetbrains.mps.openapi.editor.cells.EditorCell> cells = getSelectedCells();
    for (int i = 0; i < cells.size(); ++i) {
      jetbrains.mps.openapi.editor.cells.EditorCell cell = cells.get(i);
      Selection selection;
      if (cell instanceof EditorCell_Multiline) {
        EditorCell_Multiline mlCell = (EditorCell_Multiline) cell;
        int start = (myLeftToRight ? 0 : mlCell.getTextLength());
        int end = (myLeftToRight ? mlCell.getTextLength() : 0);
        if (i == 0) {
          start = myStartTextPos;
        }
        if (i == cells.size() - 1) {
          end = myEndTextPos;
        }
        selection = new MultilineSelection(getEditorComponent(), (EditorCell_Multiline) cell, start, end);
      } else {
        if (cell instanceof EditorCell_Label) {
          ((EditorCell_Label) cell).selectAll();
        }
        selection = selectionManager.createSelection(cell);
      }
      ListSequence.fromList(subSelections).addElement(selection);
    }
  }
  public void activate() {
    installKeyboardListener();
    for (Selection selection : ListSequence.fromList(subSelections)) {
      selection.activate();
    }
    ensureVisible();
  }
  public void deactivate() {
    deinstallKeybordListener();
    for (Selection selection : ListSequence.fromList(subSelections)) {
      selection.deactivate();
    }
  }

  public void installKeyboardListener() {
    jetbrains.mps.nodeEditor.EditorComponent editorComponent = (jetbrains.mps.nodeEditor.EditorComponent) myStartCell.getEditorComponent();
    editorComponent.addKeyListener(keyListener);
  }

  public void deinstallKeybordListener() {
    jetbrains.mps.nodeEditor.EditorComponent editorComponent = (jetbrains.mps.nodeEditor.EditorComponent) myStartCell.getEditorComponent();
    editorComponent.removeKeyListener(keyListener);
  }


  public void ensureVisible() {
    ListSequence.fromList(subSelections).getElement(ListSequence.fromList(subSelections).count() - 1).ensureVisible();
  }
  public void executeAction(final CellActionType type) {
    getEditorComponent().getEditorContext().getRepository().getModelAccess().runReadAction(() -> {
      if (type == CellActionType.SELECT_LEFT) {
        selectLeftRight(true);
      } else if (type == CellActionType.SELECT_ALL) {
        new TextCellModifier.SelectAllAction(ListSequence.fromList(getSelectedCells()).first()).execute(getEditorComponent().getEditorContext());
      } else if (type == CellActionType.SELECT_RIGHT) {
        selectLeftRight(false);
      } else if (type == CellActionType.SELECT_PREVIOUS) {
        selectNextPrevious(true);
      } else if (type == CellActionType.SELECT_NEXT) {
        selectNextPrevious(false);
      } else if (type == CellActionType.SELECT_UP) {
        selectUpDown(false);
      } else if (type == CellActionType.SELECT_DOWN) {
        selectUpDown(true);
      } else if (type == CellActionType.SELECT_LOCAL_HOME) {
        selectLocalHomeEnd(true);
      } else if (type == CellActionType.SELECT_LOCAL_END) {
        selectLocalHomeEnd(false);
      } else if (type == CellActionType.LEFT || type == CellActionType.RIGHT || type == CellActionType.DOWN || type == CellActionType.UP) {
        clearSelection();
      } else if (type == CellActionType.COPY) {
        copySelectedNodes();
      } else if (type == CellActionType.CUT) {
        if (!(isReadOnly())) {
          copySelectedNodes();
          executeDeleteSelected();
        }
      } else if (type == CellActionType.PASTE) {
        pasteFromClipboard();
      } else if (type == CellActionType.DELETE || type == CellActionType.BACKSPACE) {
        executeDeleteSelected();
      } else {
        if (LOG.isWarningLevel()) {
          LOG.warning("Unhandled action in RichtextSelection: " + type);
        }
      }
    });
  }
  public boolean canExecuteAction(CellActionType type) {
    switch (type) {
      case SELECT_LEFT:
      case SELECT_RIGHT:
      case SELECT_PREVIOUS:
      case SELECT_NEXT:
      case SELECT_UP:
      case SELECT_DOWN:
      case SELECT_LOCAL_HOME:
      case SELECT_LOCAL_END:
      case LEFT:
      case RIGHT:
      case DOWN:
      case UP:
      case COPY:
      case CUT:
      case PASTE:
      case DELETE:
      case BACKSPACE:
        return true;
      default:
        return false;
    }
  }
  public void selectLeftRight(boolean left) {
    boolean extend = left != myLeftToRight;
    Iterable<SNode> selectedNodes = Sequence.fromClosure(() -> getSelectedNodes());
    SNode endNode = Sequence.fromIterable(selectedNodes).last();
    int newEndTextPos = (left ? myEndTextPos - 1 : myEndTextPos + 1);
    if (SNodeOperations.isInstanceOf(endNode, CONCEPTS.Word$5r) && (boolean) Word__BehaviorDescriptor.isValidCursorPosition_id635SBilAXqa.invoke(SNodeOperations.cast(endNode, CONCEPTS.Word$5r), ((int) newEndTextPos))) {
      RichtextSelection newSelection = new RichtextSelection(getEditorComponent(), myStartCell, myNumWords, myStartTextPos, newEndTextPos, myLeftToRight);
      getEditorComponent().getSelectionManager().setSelection(newSelection);
    } else {
      SNode newEndNode = (left ? SNodeOperations.getPrevSibling(endNode) : SNodeOperations.getNextSibling(endNode));
      if ((newEndNode == null)) {
        return;
      }
      if (SNodeOperations.isInstanceOf(newEndNode, CONCEPTS.Word$5r)) {
        newEndTextPos = (left ? Word__BehaviorDescriptor.getText_idehGfXvI_DB.invoke(SNodeOperations.cast(newEndNode, CONCEPTS.Word$5r)).length() - 1 : 1);
      }
      RichtextSelection newSelection = new RichtextSelection(getEditorComponent(), myStartCell, myNumWords + ((extend ? 1 : -1)), myStartTextPos, newEndTextPos, myLeftToRight);
      getEditorComponent().getSelectionManager().setSelection(newSelection);
    }
  }
  public void selectNextPrevious(boolean previous) {
    jetbrains.mps.openapi.editor.cells.EditorCell cursorCell = getCursorCell();
    if (!(cursorCell instanceof EditorCell)) {
      return;
    }
    EditorCell internalCursorCell = (EditorCell) cursorCell;
    if (cursorCell == null) {
      return;
    }
    jetbrains.mps.openapi.editor.cells.EditorCell targetCell = (previous ? SelectionUtil.getUpper(internalCursorCell) : SelectionUtil.getLower(internalCursorCell));
    jetbrains.mps.openapi.editor.cells.EditorCell startCell = getStartCell();
    targetCell.setCaretX(cursorCell.getCaretX());
    SNode commonParentText = SNodeOperations.getNodeAncestor(getFirstCommonParentNode(startCell, targetCell), CONCEPTS.Text$bD, true, false);
    if ((commonParentText == null)) {
      targetCell = (previous ? CellTraversalUtil.getNextLeaf(targetCell) : CellTraversalUtil.getPrevLeaf(targetCell));
      if (targetCell instanceof jetbrains.mps.openapi.editor.cells.EditorCell_Label) {
        EditorCell_Label targetLabelCell = ((EditorCell_Label) targetCell);
        int newCaretPosition = (previous ? 0 : targetLabelCell.getText().length());
        if (targetLabelCell.isCaretPositionAllowed(newCaretPosition)) {
          targetLabelCell.setCaretPosition(newCaretPosition);
        }
      }
    }
    int targetCaretPos = ((targetCell instanceof EditorCell_Label) ? ((EditorCell_Label) targetCell).getCaretPosition() : 0);
    int startCaretPos = ((startCell instanceof EditorCell_Label) ? ((EditorCell_Label) startCell).getCaretPosition() : 0);
    RichtextSelection newSelection = create(startCell, startCaretPos, targetCell, targetCaretPos);
    if (newSelection != null) {
      getEditorComponent().getSelectionManager().setSelection(newSelection);
    }
  }
  public void selectUpDown(final boolean down) {
    myStartCell.getEditorComponent().getEditorContext().getRepository().getModelAccess().runReadAction(() -> selectUpDown_(down));
  }
  private void selectUpDown_(boolean down) {
    if (myLeftToRight != down) {
      getEditorComponent().getSelectionManager().popSelection();
      return;
    }

    // select the whole word cell
    if (myNumWords == 1 && myStartCell instanceof EditorCell_Multiline) {
      EditorCell_Multiline mlCell = ((EditorCell_Multiline) myStartCell);
      EditorCell_Word startCell = mlCell.getWordCellContainingPos(myStartTextPos);
      if (startCell == mlCell.getWordCellContainingPos(myEndTextPos)) {
        int start = mlCell.getTextBefore(startCell, 0).length();
        int end = start + startCell.getText().length();
        if (!(down)) {
          // swap start and end
          int temp = start;
          start = end;
          end = temp;
        }

        RichtextSelection newSelection = new RichtextSelection(getEditorComponent(), myStartCell, 1, start, end, down);
        if (!(isSame(newSelection))) {
          getEditorComponent().getSelectionManager().pushSelection(newSelection);
          return;
        }
      }
    }

    // select the whole 'Text' node content
    SNode textNode = SNodeOperations.getNodeAncestor(ListSequence.fromList(getSelectedNodes()).first(), CONCEPTS.Text$bD, false, false);
    jetbrains.mps.openapi.editor.cells.EditorCell firstCell = getEditorComponent().findNodeCell(ListSequence.fromList(SLinkOperations.getChildren(textNode, LINKS.words$C8QZ)).first());
    jetbrains.mps.openapi.editor.cells.EditorCell lastCell = getEditorComponent().findNodeCell(ListSequence.fromList(SLinkOperations.getChildren(textNode, LINKS.words$C8QZ)).last());
    Integer endTextPos = check_irpwvl_a0j0db(as_irpwvl_a0a0j0eb(lastCell, EditorCell_Multiline.class));
    if (endTextPos == null) {
      endTextPos = 0;
    }
    Selection newSelection = (down ? new RichtextSelection(getEditorComponent(), (EditorCell) firstCell, ListSequence.fromList(SLinkOperations.getChildren(textNode, LINKS.words$C8QZ)).count(), 0, endTextPos, down) : new RichtextSelection(getEditorComponent(), (EditorCell) lastCell, ListSequence.fromList(SLinkOperations.getChildren(textNode, LINKS.words$C8QZ)).count(), endTextPos, 0, down));
    if (!(isSame(newSelection))) {
      getEditorComponent().getSelectionManager().pushSelection(newSelection);
      return;
    }

    // select the 'Text' node
    newSelection = getEditorComponent().getSelectionManager().createSelection(getEditorComponent().findNodeCell(textNode));
    getEditorComponent().getSelectionManager().pushSelection(newSelection);

  }

  public void selectLocalHomeEnd(boolean left) {
    Iterable<SNode> selectedNodes = Sequence.fromClosure(() -> getSelectedNodes());
    SNode endNode = Sequence.fromIterable(selectedNodes).last();
    if (endNode == null) {
      return;
    }
    boolean extend = left != myLeftToRight;
    int newEndTextPos = (left ? myEndTextPos - 1 : myEndTextPos + 1);
    if (SNodeOperations.isInstanceOf(endNode, CONCEPTS.Word$5r) && (boolean) Word__BehaviorDescriptor.isValidCursorPosition_id635SBilAXqa.invoke(SNodeOperations.cast(endNode, CONCEPTS.Word$5r), ((int) newEndTextPos))) {
      SNode endWord = SNodeOperations.cast(endNode, CONCEPTS.Word$5r);
      String text = Word__BehaviorDescriptor.getText_idehGfXvI_DB.invoke(endWord);
      int textLen = text.length();

      if (left) {
        newEndTextPos--;
        while (newEndTextPos > 0) {
          if (isWhitespaceChar(text.charAt(newEndTextPos)) != isWhitespaceChar(text.charAt(newEndTextPos - 1))) {
            break;
          }
          newEndTextPos--;
        }
      } else {
        newEndTextPos++;
        while (newEndTextPos < textLen - 1) {
          if (isWhitespaceChar(text.charAt(newEndTextPos - 1)) != isWhitespaceChar(text.charAt(newEndTextPos))) {
            break;
          }
          newEndTextPos++;
        }
      }


      RichtextSelection newSelection = new RichtextSelection(getEditorComponent(), myStartCell, myNumWords, myStartTextPos, newEndTextPos, myLeftToRight);
      getEditorComponent().getSelectionManager().setSelection(newSelection);
    } else {
      SNode newEndNode = (left ? SNodeOperations.getPrevSibling(endNode) : SNodeOperations.getNextSibling(endNode));
      if ((newEndNode == null)) {
        return;
      }
      if (SNodeOperations.isInstanceOf(newEndNode, CONCEPTS.Word$5r)) {
        newEndTextPos = (left ? Word__BehaviorDescriptor.getText_idehGfXvI_DB.invoke(SNodeOperations.cast(newEndNode, CONCEPTS.Word$5r)).length() - 1 : 1);
      }
      RichtextSelection newSelection = new RichtextSelection(getEditorComponent(), myStartCell, myNumWords + ((extend ? 1 : -1)), myStartTextPos, newEndTextPos, myLeftToRight);
      getEditorComponent().getSelectionManager().setSelection(newSelection);

    }
  }

  public boolean isWhitespaceChar(char c) {
    return c == ' ' || c == '\n' || c == '\r' || c == '\t';
  }

  public jetbrains.mps.openapi.editor.cells.EditorCell getCursorCell() {
    jetbrains.mps.openapi.editor.cells.EditorCell collectionCell = ListSequence.fromList(getSelectedCells()).last();
    if (collectionCell == null) {
      return null;
    }
    if (collectionCell instanceof EditorCell_Multiline) {
      EditorCell_Multiline mlCell = ((EditorCell_Multiline) collectionCell);
      return mlCell.getWordCellContainingPos(myEndTextPos);
    } else {
      return (myLeftToRight ? CellTraversalUtil.getLastLeaf(collectionCell) : CellTraversalUtil.getFirstLeaf(collectionCell));
    }
  }
  public jetbrains.mps.openapi.editor.cells.EditorCell getStartCell() {
    jetbrains.mps.openapi.editor.cells.EditorCell collectionCell = ListSequence.fromList(getSelectedCells()).first();
    if (collectionCell == null) {
      return null;
    }
    if (collectionCell instanceof EditorCell_Multiline) {
      EditorCell_Multiline mlCell = ((EditorCell_Multiline) collectionCell);
      return mlCell.getWordCellContainingPos(myStartTextPos);
    } else {
      return (myLeftToRight ? CellTraversalUtil.getFirstLeaf(collectionCell) : CellTraversalUtil.getLastLeaf(collectionCell));
    }
  }
  public void executeDeleteSelected() {
    if (isReadOnly()) {
      return;
    }

    // store caret position (left before the selection)
    final CaretPosition caretPosition = new CaretPosition(getEditorComponent().getEditorContext());
    jetbrains.mps.openapi.editor.cells.EditorCell leftCell = (myLeftToRight ? ListSequence.fromList(getSelectedCells()).first() : ListSequence.fromList(getSelectedCells()).last());
    if (leftCell instanceof EditorCell_Multiline) {
      caretPosition.remember(((EditorCell_Multiline) leftCell), (myLeftToRight ? myStartTextPos : myEndTextPos));
    } else {
      jetbrains.mps.openapi.editor.cells.EditorCell cellBefore = CellTraversalUtil.getPrevSibling(leftCell);
      if (cellBefore instanceof EditorCell_Multiline) {
        EditorCell_Multiline mlCell = ((EditorCell_Multiline) cellBefore);
        caretPosition.remember(mlCell, mlCell.getTextLength());
      } else {
        caretPosition.remember(leftCell);
      }
    }


    if (getEditorComponent().getEditorContext().getRepository().getModelAccess().canWrite()) {
      deleteSelected();


      // Restore selection, but we first have to wait for the current model modification to finish
      SwingUtilities.invokeLater(() -> getEditorComponent().getEditorContext().getRepository().getModelAccess().executeUndoTransparentCommand(() -> {
        getEditorComponent().getEditorContext().flushEvents();
        ((jetbrains.mps.nodeEditor.EditorComponent) getEditorComponent()).getUpdater().flushModelEvents();
        caretPosition.tryRestore();
        getEditorComponent().getSelectionManager().getSelection().ensureVisible();
      }));
    } else {
      getEditorComponent().getEditorContext().getRepository().getModelAccess().executeCommandInEDT(() -> {
        deleteSelected();

        // restore selection
        ((jetbrains.mps.nodeEditor.EditorComponent) getEditorComponent()).getUpdater().flushModelEvents();
        caretPosition.tryRestore();
        getEditorComponent().getSelectionManager().getSelection().ensureVisible();

        getEditorComponent().update();
      });
    }
  }
  public SNode getFirstWordNodeLeft(SNode node) {
    if (node == null) {
      return null;
    }
    if (SNodeOperations.isInstanceOf(node, CONCEPTS.Word$5r)) {
      return SNodeOperations.cast(node, CONCEPTS.Word$5r);
    }
    return getFirstWordNodeLeft(SNodeOperations.getPrevSibling(node));
  }
  private TextPosition deleteSelected() {
    if (isReadOnly()) {
      throw new RuntimeException("Selection is read only");
    }

    List<SNode> selectedNodes = (List<SNode>) getSelectedNodes();
    SNode text = SNodeOperations.as(SNodeOperations.getParent(ListSequence.fromList(selectedNodes).first()), CONCEPTS.Text$bD);
    SNode leftNode = (myLeftToRight ? ListSequence.fromList(selectedNodes).first() : ListSequence.fromList(selectedNodes).last());
    SNode leftWord = getFirstWordNodeLeft(leftNode);
    TextPosition caretPosition = new TextPosition(leftWord, (int) Word__BehaviorDescriptor.getTextLength_id635SBilAXnW.invoke(leftWord));
    for (int i = 0; i < selectedNodes.size(); ++i) {
      SNode node = selectedNodes.get(i);
      boolean isFirst = i == 0;
      boolean isLast = i == selectedNodes.size() - 1;
      if (SNodeOperations.isInstanceOf(node, CONCEPTS.Word$5r) && (isFirst || isLast)) {
        SNode wordNode = SNodeOperations.cast(node, CONCEPTS.Word$5r);
        int removeStart = 0;
        int removeEnd = (int) Word__BehaviorDescriptor.getTextLength_id635SBilAXnW.invoke(wordNode);
        if (myLeftToRight) {
          if (isFirst) {
            removeStart = myStartTextPos;
          }
          if (isLast) {
            removeEnd = myEndTextPos;
          }
        } else {
          if (isFirst && !(isLast)) {
            removeEnd = myStartTextPos;
          }
          if (isLast) {
            removeStart = myEndTextPos;
          }
        }
        if (removeStart > removeEnd) {
          {
            Tuples._2<Integer, Integer> _tmp_irpwvl_a0e0d0h0nb = MultiTuple.<Integer,Integer>from(removeEnd, removeStart);
            removeStart = _tmp_irpwvl_a0e0d0h0nb._0();
            removeEnd = _tmp_irpwvl_a0e0d0h0nb._1();
          }
        }
        String oldText = Word__BehaviorDescriptor.getText_idehGfXvI_DB.invoke(wordNode);
        Word__BehaviorDescriptor.setText_id1JwC6U7zkKz.invoke(wordNode, oldText.substring(0, Math.min(removeStart, removeEnd)) + oldText.substring(Math.max(removeStart, removeEnd), oldText.length()));

        if (node == leftNode) {
          caretPosition.setWord(wordNode);
          caretPosition.setRelativePos(removeStart);
        }
      } else {
        SNodeOperations.deleteNode(node);
      }
    }
    Text__BehaviorDescriptor.ensureNormalized_id3mI$71cQ6Aw.invoke(text);
    return caretPosition;
  }
  public List<SNode> getSelectedWords() {
    List<SNode> nodes = (List<SNode>) CopyUtil.copy(getSelectedNodes());
    SNode firstWord = SNodeOperations.as(ListSequence.fromList(nodes).first(), CONCEPTS.Word$5r);
    SNode lastWord = SNodeOperations.as(ListSequence.fromList(nodes).last(), CONCEPTS.Word$5r);
    if (myLeftToRight) {
      if ((lastWord != null)) {
        Word__BehaviorDescriptor.setText_id1JwC6U7zkKz.invoke(lastWord, RichtextUtil.safeSubstring(Word__BehaviorDescriptor.getText_idehGfXvI_DB.invoke(lastWord), 0, myEndTextPos));
      }
      if ((firstWord != null)) {
        Word__BehaviorDescriptor.setText_id1JwC6U7zkKz.invoke(firstWord, RichtextUtil.safeSubstring(Word__BehaviorDescriptor.getText_idehGfXvI_DB.invoke(firstWord), myStartTextPos));
      }
    } else {
      if ((firstWord != null)) {
        Word__BehaviorDescriptor.setText_id1JwC6U7zkKz.invoke(firstWord, RichtextUtil.safeSubstring(Word__BehaviorDescriptor.getText_idehGfXvI_DB.invoke(firstWord), 0, myStartTextPos));
      }
      if ((lastWord != null)) {
        Word__BehaviorDescriptor.setText_id1JwC6U7zkKz.invoke(lastWord, RichtextUtil.safeSubstring(Word__BehaviorDescriptor.getText_idehGfXvI_DB.invoke(lastWord), myEndTextPos, Integer.MAX_VALUE));
      }
      nodes = ListSequence.fromList(nodes).reversedList();
    }
    return nodes;
  }
  public void copySelectedNodes() {
    List<SNode> words = getSelectedWords();
    if (ListSequence.fromList(words).count() == 1 && SNodeOperations.isInstanceOf(ListSequence.fromList(words).getElement(0), CONCEPTS.Word$5r)) {
      CopyPasteUtil.copyTextToClipboard(Word__BehaviorDescriptor.getText_idehGfXvI_DB.invoke(SNodeOperations.cast(ListSequence.fromList(words).getElement(0), CONCEPTS.Word$5r)));
    } else {
      String plainText = IterableUtils.join(ListSequence.fromList(words).select((it) -> {
        String text = check_irpwvl_a0a0a0a0a0a0b0pb(SNodeOperations.as(it, CONCEPTS.IWord$8d));
        return (text == null ? "" : text);
      }), "");
      CopyPasteUtil.copyNodesAndTextToClipboard(words, null, plainText);
    }
  }
  public void pasteFromClipboard() {
    if (isReadOnly()) {
      return;
    }
    List<SNode> nodesFromClipboard = CopyPasteUtil.getNodesFromClipboard();
    List<SNode> wordsFromClipboard = Sequence.fromIterable(SNodeOperations.ofConcept(nodesFromClipboard, CONCEPTS.IWord$8d)).toList();
    if (ListSequence.fromList(wordsFromClipboard).isNotEmpty()) {
      replaceSelected(wordsFromClipboard);
    } else {
      final TextPosition caretPos = deleteSelected();
      Word__BehaviorDescriptor.insertTextAt_id4YWDi1U$WhW.invoke(caretPos.getWord(), ClipboardUtils.getClipboardText(), ((int) caretPos.getRelativePos()));
      clearSelection();
      SwingUtilities.invokeLater(() -> {
        jetbrains.mps.openapi.editor.cells.EditorCell mlCell = getEditorComponent().findNodeCell(caretPos.getWord());
        if (mlCell instanceof EditorCell_Multiline) {
          ((EditorCell_Multiline) mlCell).setCaretPosition(caretPos.getRelativePos() + ClipboardUtils.getClipboardText().length());
        }
      });
    }
  }
  /**
   * 
   * 
   * @return the replaced IWords
   */
  public List<SNode> replaceSelected(List<SNode> replaceWith) {
    if (isReadOnly()) {
      return new ArrayList<SNode>();
    }

    List<SNode> selectedWords = getSelectedWords();

    TextPosition caretPos = deleteSelected();
    Word__BehaviorDescriptor.insertNodesAt_id4WdkpBdiPQf.invoke(caretPos.getWord(), replaceWith, ((int) caretPos.getRelativePos()));

    return selectedWords;
  }
  public List<SNode> replaceSelected(SNode replaceWith) {
    List<SNode> list = new ArrayList<SNode>();
    ListSequence.fromList(list).addElement(replaceWith);
    return replaceSelected(list);
  }
  public void clearSelection() {
    SelectionManager selectionManager = getEditorComponent().getSelectionManager();
    Selection deepest = selectionManager.getDeepestSelection();
    if (deepest instanceof EditorCellLabelSelection) {
      selectionManager.setSelection(deepest);
      return;
    }

    deactivate();
    Iterable<jetbrains.mps.openapi.editor.cells.EditorCell> selectedCells = Sequence.fromClosure(() -> getSelectedCells());
    jetbrains.mps.openapi.editor.cells.EditorCell cursorCell = Sequence.fromIterable(selectedCells).last();
    selectionManager.clearSelection();
    if (cursorCell instanceof EditorCell_Multiline) {
      ((EditorCell_Multiline) cursorCell).setCaretPosition(myEndTextPos, true);
    } else {
      if (myLeftToRight) {
        SelectionUtils.setCursorAtEndOfCell(cursorCell, getEditorComponent().getEditorContext());
      } else {
        SelectionUtils.setCursorAtBeginningOfCell(cursorCell, getEditorComponent().getEditorContext());
      }
    }
  }
  @NotNull
  public List<jetbrains.mps.openapi.editor.cells.EditorCell> getSelectedCells() {
    List<jetbrains.mps.openapi.editor.cells.EditorCell> result = new ArrayList<jetbrains.mps.openapi.editor.cells.EditorCell>();
    jetbrains.mps.openapi.editor.cells.EditorCell currentCell = myStartCell;
    for (int i = 0; i < myNumWords; ++i) {
      if (currentCell == null) {
        break;
      }
      result.add(currentCell);
      currentCell = (myLeftToRight ? currentCell.getNextSibling() : currentCell.getPrevSibling());
    }
    return result;
  }
  @NotNull
  public List<SNode> getSelectedNodes() {
    List<SNode> result = new ArrayList<SNode>();
    for (jetbrains.mps.openapi.editor.cells.EditorCell cell : ListSequence.fromList(getSelectedCells())) {
      result.add(cell.getSNode());
    }
    return result;
  }
  public SelectionInfo getSelectionInfo() throws SelectionStoreException {
    SelectionInfoImpl selectionInfo = new SelectionInfoImpl(this.getClass().getName(), PersistenceFacade.getInstance().createModuleReference("92d2ea16-5a42-4fdf-a676-c7604efe3504(de.slisson.mps.richtext)"));
    selectionInfo.setCellInfo(myStartCell.getCellInfo());
    selectionInfo.getPropertiesMap().put(PROPERTY_NUM_WORDS, Integer.toString(myNumWords));
    selectionInfo.getPropertiesMap().put(PROPERTY_START_TEXT_POS, Integer.toString(myStartTextPos));
    selectionInfo.getPropertiesMap().put(PROPERTY_END_TEXT_POS, Integer.toString(myEndTextPos));
    selectionInfo.getPropertiesMap().put(PROPERTY_LEFT_TO_RIGHT, Boolean.toString(myLeftToRight));
    return selectionInfo;
  }
  public boolean isSame(Selection other) {
    if (this == other) {
      return true;
    }
    if (other == null || getClass() != other.getClass()) {
      return false;
    }
    RichtextSelection otherRTSelection = (RichtextSelection) other;
    if (!(Objects.equals(myStartCell, otherRTSelection.myStartCell))) {
      return false;
    }
    if (myNumWords != otherRTSelection.myNumWords) {
      return false;
    }
    if (myStartTextPos != otherRTSelection.myStartTextPos) {
      return false;
    }
    if (myEndTextPos != otherRTSelection.myEndTextPos) {
      return false;
    }
    if (myLeftToRight != otherRTSelection.myLeftToRight) {
      return false;
    }
    return true;
  }
  public void paintSelection(Graphics2D d) {
    for (Selection selection : ListSequence.fromList(subSelections)) {
      check_irpwvl_a0a0a05(as_irpwvl_a0a0a0a15(selection, SelectionInternal.class), d);
    }
  }
  public static RichtextSelection create(jetbrains.mps.openapi.editor.cells.EditorCell startLeaf, jetbrains.mps.openapi.editor.cells.EditorCell endLeaf) {
    int startPos = 0;
    int endPos = 0;
    if (startLeaf instanceof EditorCell_Label) {
      startPos = ((EditorCell_Label) startLeaf).getCaretPosition();
    }
    if (endLeaf instanceof EditorCell_Label) {
      endPos = ((EditorCell_Label) endLeaf).getCaretPosition();
    }
    return create(startLeaf, startPos, endLeaf, endPos);
  }
  public static RichtextSelection createWithCoordinates(jetbrains.mps.openapi.editor.cells.EditorCell startLeaf, int startX, jetbrains.mps.openapi.editor.cells.EditorCell endLeaf, int endX) {
    int startPos = 0;
    int endPos = 0;
    if (startLeaf instanceof EditorCell_Label) {
      startPos = xCoordToCaretPos(((EditorCell_Label) startLeaf), startX);
    }
    if (endLeaf instanceof EditorCell_Label) {
      endPos = xCoordToCaretPos(((EditorCell_Label) endLeaf), endX);
    }
    return create(startLeaf, startPos, endLeaf, endPos);
  }

  public static RichtextSelection create(final jetbrains.mps.openapi.editor.cells.EditorCell startLeaf, final int startLeafTextPos, final jetbrains.mps.openapi.editor.cells.EditorCell endLeaf, final int endLeafCursorPos) {
    final Wrappers._T<RichtextSelection> result = new Wrappers._T<RichtextSelection>();

    startLeaf.getEditorComponent().getEditorContext().getRepository().getModelAccess().runReadAction(new _Adapters._return_P0_E0_to_Runnable_adapter(((_FunctionTypes._return_P0_E0<RichtextSelection>) () -> {
      SNode commonParentText = SNodeOperations.getNodeAncestor(getFirstCommonParentNode(startLeaf, endLeaf), CONCEPTS.Text$bD, true, false);
      if ((commonParentText == null)) {
        return null;
      }
      jetbrains.mps.nodeEditor.EditorComponent editor = (jetbrains.mps.nodeEditor.EditorComponent) startLeaf.getEditorComponent();
      SNode startWord = getParentIWord(startLeaf, commonParentText);
      SNode endWord = getParentIWord(endLeaf, commonParentText);
      if (startWord == null || endWord == null) {
        return null;
      }
      int numWords = Math.abs(SNodeOperations.getIndexInParent(startWord) - SNodeOperations.getIndexInParent(endWord)) + 1;
      int endTextPos = 0;
      if (SNodeOperations.isInstanceOf(endWord, CONCEPTS.Word$5r) && endLeaf instanceof EditorCell_Word) {
        EditorCell_Word wordCell = ((EditorCell_Word) endLeaf);
        endTextPos = wordCell.getParent().getAbsoluteTextPosition(wordCell, endLeafCursorPos);
      }
      int startTextPos = 0;
      if (SNodeOperations.isInstanceOf(startWord, CONCEPTS.Word$5r) && startLeaf instanceof EditorCell_Word) {
        EditorCell_Word wordCell = ((EditorCell_Word) startLeaf);
        startTextPos = wordCell.getParent().getAbsoluteTextPosition(wordCell, startLeafTextPos);
      }
      boolean leftToRight = (numWords == 1 ? startLeafTextPos < endTextPos : SNodeOperations.getIndexInParent(startWord) < SNodeOperations.getIndexInParent(endWord));

      EditorCell startCell = editor.findNodeCell(startWord);

      if (startLeaf instanceof EditorCell_Multiline || endLeaf instanceof EditorCell_Multiline) {
        EditorCell_Collection textCell = as_irpwvl_a0a0a51a0a0a0a0c0dc(editor.findNodeCell(commonParentText), EditorCell_Collection.class);

        if (leftToRight) {
          EditorCell_Word lastLeaf = as_irpwvl_a0a0a2a51a0a0a0a0c0dc(CellTraversalUtil.getLastLeaf(textCell), EditorCell_Word.class);
          endTextPos = lastLeaf.getParent().getAbsoluteTextPosition(lastLeaf, 0) + lastLeaf.getText().length();
        } else {
          EditorCell_Word firstLeaf = as_irpwvl_a0a0a0c0p0a0a0a0a2a55(CellTraversalUtil.getFirstLeaf(textCell), EditorCell_Word.class);
          endTextPos = 0;
        }
        numWords = ListSequence.fromList(SNodeOperations.getNodeDescendants(commonParentText, CONCEPTS.IWord$8d, false, new SAbstractConcept[]{})).count();
      }
      return result.value = new RichtextSelection(editor, startCell, numWords, startTextPos, endTextPos, leftToRight);
    })));
    return result.value;
  }
  public static RichtextSelection create(EditorCellLabelSelection selection) {
    EditorCell_Word wordCell = as_irpwvl_a0a0a65(check_irpwvl_a0a0a55(selection), EditorCell_Word.class);
    if (wordCell == null) {
      return null;
    }
    SNode node = wordCell.getSNode();
    if (!(SNodeOperations.isInstanceOf(node, CONCEPTS.Word$5r))) {
      return null;
    }

    int start = wordCell.getParent().getAbsoluteTextPosition(wordCell, wordCell.getSelectionStart());
    int end = wordCell.getParent().getAbsoluteTextPosition(wordCell, wordCell.getSelectionEnd());
    return new RichtextSelection(selection.getEditorComponent(), wordCell.getParent(), 1, start, end, true);
  }
  public static RichtextSelection create(Selection selection) {
    if (selection instanceof RichtextSelection) {
      return (RichtextSelection) selection;
    } else if (selection instanceof EditorCellLabelSelection) {
      return create((EditorCellLabelSelection) selection);
    } else {
      return null;
    }
  }
  public static SNode getParentTextNode(jetbrains.mps.openapi.editor.cells.EditorCell childCell) {
    return SNodeOperations.getNodeAncestor(((SNode) childCell.getSNode()), CONCEPTS.Text$bD, false, false);
  }
  public static SNode getParentIWord(jetbrains.mps.openapi.editor.cells.EditorCell childCell) {
    return SNodeOperations.getNodeAncestor(((SNode) childCell.getSNode()), CONCEPTS.IWord$8d, true, false);
  }
  public static SNode getParentIWord(jetbrains.mps.openapi.editor.cells.EditorCell childCell, SNode asDirectChildOf) {
    SNode cellNode = ((SNode) childCell.getSNode());
    if (SNodeOperations.isInstanceOf(cellNode, CONCEPTS.IWord$8d) && SNodeOperations.getParent(cellNode) == asDirectChildOf) {
      return SNodeOperations.cast(cellNode, CONCEPTS.IWord$8d);
    }
    for (SNode ancestor : ListSequence.fromList(SNodeOperations.getNodeAncestors(cellNode, null, false)).where((it) -> SNodeOperations.isInstanceOf(it, CONCEPTS.IWord$8d))) {
      if (SNodeOperations.getParent(ancestor) == asDirectChildOf) {
        return SNodeOperations.cast(ancestor, CONCEPTS.IWord$8d);
      }
    }
    return null;
  }
  public static jetbrains.mps.openapi.editor.cells.EditorCell getParentIWordRootCell(jetbrains.mps.openapi.editor.cells.EditorCell anyChildCell) {
    jetbrains.mps.openapi.editor.cells.EditorCell prevParent = anyChildCell;
    jetbrains.mps.openapi.editor.cells.EditorCell parent = prevParent.getParent();
    while (parent != null && prevParent.getSNode() == parent.getSNode() || !(SNodeOperations.isInstanceOf(((SNode) prevParent.getSNode()), CONCEPTS.IWord$8d))) {
      prevParent = parent;
      parent = prevParent.getParent();
    }
    return prevParent;
  }
  public static jetbrains.mps.openapi.editor.cells.EditorCell getFirstCommonParent(jetbrains.mps.openapi.editor.cells.EditorCell child1, jetbrains.mps.openapi.editor.cells.EditorCell child2) {
    Set<jetbrains.mps.openapi.editor.cells.EditorCell> child1Ancestors = SetSequence.fromSet(new HashSet<jetbrains.mps.openapi.editor.cells.EditorCell>());
    for (jetbrains.mps.openapi.editor.cells.EditorCell current = child1; current != null; current = current.getParent()) {
      SetSequence.fromSet(child1Ancestors).addElement(current);
    }
    for (jetbrains.mps.openapi.editor.cells.EditorCell current = child2; current != null; current = current.getParent()) {
      if (SetSequence.fromSet(child1Ancestors).contains(current)) {
        return current;
      }
    }
    return null;
  }
  public static SNode getFirstCommonParentNode(jetbrains.mps.openapi.editor.cells.EditorCell child1, jetbrains.mps.openapi.editor.cells.EditorCell child2) {
    return check_irpwvl_a0a26(getFirstCommonParent(child1, child2));
  }

  protected boolean processKeyTyped(final KeyEvent event) {
    if (isReadOnly()) {
      return false;
    }
    if (event.getKeyChar() == '\0') {
      return false;
    }
    if (event.getKeyChar() == '\u001b') {
      // ESCAPE key
      return false;
    }
    if (event.isControlDown() || event.isMetaDown() || event.isAltDown()) {
      return false;
    }
    final TextPosition[] pos = new TextPosition[1];
    getEditorComponent().getEditorContext().getRepository().getModelAccess().executeCommand(() -> {
      pos[0] = deleteSelected();
      Word__BehaviorDescriptor.insertTextAt_id4YWDi1U$WhW.invoke(pos[0].getWord(), "" + event.getKeyChar(), ((int) pos[0].getRelativePos()));
      pos[0].getWord();
    });
    EditorCell_Multiline mlCell = as_irpwvl_a0a6a56(myStartCell.getEditorComponent().findNodeCell(pos[0].getWord()), EditorCell_Multiline.class);
    if (mlCell != null) {
      mlCell.setCaretPosition(pos[0].getRelativePos() + 1, true);
    }
    return true;
  }

  public boolean isReadOnly() {
    return ReadOnlyUtil.isCellsReadOnlyInEditor(getEditorComponent(), getSelectedCells());
  }

  public int getStartTextPos() {
    return myStartTextPos;
  }

  public int getEndTextPos() {
    return myEndTextPos;
  }

  public boolean isLeftToRight() {
    return myLeftToRight;
  }

  private static int xCoordToCaretPos(EditorCell_Label label, int _x) {
    TextLine tl = ((TextLine) ReflectionUtil.readField(EditorCell_Label.class, label, "myTextLine"));
    int x = _x - label.getX() - tl.getPaddingLeft();
    FontMetrics metrics = tl.getFontMetrics();
    char[] chars = tl.getText().toCharArray();
    int caretPos = tl.getText().length();
    int len = 0;
    for (int i = 0; i < tl.getText().length(); i++) {
      int newLen = metrics.charsWidth(chars, 0, i + 1);
      if (x <= (len + newLen + 1) / 2) {
        caretPos = i;
        break;
      }
      len = newLen;
    }
    return caretPos;
  }

  private static int check_irpwvl_a0j0db(EditorCell_Multiline checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getTextLength();
    }
    return 0;
  }
  private static String check_irpwvl_a0a0a0a0a0a0b0pb(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return IWord__BehaviorDescriptor.toTextString_id3Q5enzfMT4t.invoke(checkedDotOperand);
    }
    return null;
  }
  private static void check_irpwvl_a0a0a05(SelectionInternal checkedDotOperand, Graphics2D d) {
    if (null != checkedDotOperand) {
      checkedDotOperand.paintSelection(d);
    }

  }
  private static jetbrains.mps.openapi.editor.cells.EditorCell_Label check_irpwvl_a0a0a55(EditorCellLabelSelection checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getEditorCellLabel();
    }
    return null;
  }
  private static SNode check_irpwvl_a0a26(jetbrains.mps.openapi.editor.cells.EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getSNode();
    }
    return null;
  }
  private static <T> T as_irpwvl_a0a0j0eb(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_irpwvl_a0a0a0a15(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_irpwvl_a0a0a51a0a0a0a0c0dc(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_irpwvl_a0a0a2a51a0a0a0a0c0dc(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_irpwvl_a0a0a0c0p0a0a0a0a2a55(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_irpwvl_a0a0a65(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_irpwvl_a0a6a56(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Word$5r = MetaAdapterFactory.getConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9f2e0cL, "de.slisson.mps.richtext.structure.Word");
    /*package*/ static final SConcept Text$bD = MetaAdapterFactory.getConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e4e61L, "de.slisson.mps.richtext.structure.Text");
    /*package*/ static final SInterfaceConcept IWord$8d = MetaAdapterFactory.getInterfaceConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e7aecL, "de.slisson.mps.richtext.structure.IWord");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink words$C8QZ = MetaAdapterFactory.getContainmentLink(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e4e61L, 0x237c8da86a9e7aeeL, "words");
  }
}
