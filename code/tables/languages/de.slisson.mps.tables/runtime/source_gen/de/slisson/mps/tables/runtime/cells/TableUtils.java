package de.slisson.mps.tables.runtime.cells;

/*Generated by MPS */

import org.jetbrains.mps.util.Condition;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.awt.Graphics;
import java.awt.Color;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import com.intellij.ui.JBColor;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.awt.Rectangle;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.openapi.editor.cells.CellAction;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import de.slisson.mps.tables.runtime.gridmodel.Grid;
import de.slisson.mps.tables.runtime.gridmodel.IGridElement;
import de.slisson.mps.tables.runtime.gridmodel.EditorCellGridLeaf;
import org.jetbrains.mps.openapi.model.SNode;
import de.slisson.mps.tables.runtime.gridmodel.IGrid;
import de.slisson.mps.tables.runtime.simplegrid.GridPosition;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;

public class TableUtils {
  private static Condition<EditorCell> IS_GRID_CELL = new Condition<EditorCell>() {
    public boolean met(EditorCell cell) {
      return cell instanceof EditorCell_GridCell;
    }
  };


  public static int[] createIntArray(int size, int defaultValue) {
    int[] result = new int[size];
    for (int i = 0; i < size; i++) {
      result[i] = defaultValue;
    }
    return result;
  }

  public static Set<EditorCell> collectSelectedCells(EditorCell root) {
    Set<EditorCell> accumulator = SetSequence.fromSet(new HashSet<EditorCell>());
    collectSelectedCells(root, root.isSelected(), accumulator);
    return accumulator;
  }

  public static void collectSelectedCells(EditorCell parent, boolean isSelected, Set<EditorCell> accumulator) {
    if (isSelected) {
      SetSequence.fromSet(accumulator).addElement(parent);
    }
    if (parent instanceof EditorCell_Collection) {
      for (EditorCell child : Sequence.fromIterable(((EditorCell_Collection) parent))) {
        collectSelectedCells(child, isSelected || parent.isSelected(), accumulator);
      }
    }
  }

  public static void paintSelection(Graphics g, Color selectionColor, Iterable<EditorCell> cells, ParentSettings parentSettings) {
    for (EditorCell child : cells) {
      if (g.hitClip(child.getX(), child.getY(), child.getWidth(), child.getHeight())) {
        ParentSettings childSettings = ParentSettings.createSelectedSetting(true).combineWith(parentSettings);

        if (childSettings.isSelectionPainted()) {
          g.setColor(selectionColor);
          g.fillRect(child.getX(), child.getY(), child.getWidth(), child.getHeight());
          g.setColor(JBColor.lightGray);
          g.drawRect(child.getX(), child.getY(), child.getWidth(), child.getHeight());
        }

        ((jetbrains.mps.nodeEditor.cells.EditorCell) child).paintCell(g, childSettings);
        ((jetbrains.mps.nodeEditor.cells.EditorCell) child).paintDecorations(g);
      }
    }

  }

  public static String editorCellsDebugText(EditorCell cell) {
    StringBuilder sb = new StringBuilder();
    editorCellsDebugText(cell, "", sb);
    return sb.toString();
  }

  public static void editorCellsDebugText(EditorCell cell, String indent, StringBuilder buffer) {
    buffer.append(indent).append(cell).append(" [").append(cell.getX()).append(",").append(cell.getY()).append(",").append(cell.getWidth()).append(",").append(cell.getHeight()).append("]").append("\n");

    if (cell instanceof EditorCell_Collection) {
      List<EditorCell> childs = ListSequence.fromList(new ArrayList<EditorCell>());
      ListSequence.fromList(childs).addSequence(Sequence.fromIterable(((EditorCell_Collection) cell)));
      for (EditorCell child : ListSequence.fromList(childs)) {
        editorCellsDebugText(child, indent + "  ", buffer);
      }
    }

  }

  public static Rectangle getCellBounds(EditorCell cell) {
    return new Rectangle(cell.getX(), cell.getY(), cell.getWidth(), cell.getHeight());
  }

  public static void paintBorders(Graphics g, Rectangle bounds, Color topColor, int topWidth, Color leftColor, int leftWidth, Color rightColor, int rightWidth, Color bottomColor, int bottomWidth) {
    if (bounds == null) {
      return;
    }
    if (topWidth > 0) {
      g.setColor(topColor);
      g.fillRect(bounds.x, bounds.y, bounds.width, topWidth);
    }

    if (leftWidth > 0) {
      g.setColor(leftColor);
      g.fillRect(bounds.x, bounds.y, leftWidth, bounds.height);
    }

    if (rightWidth > 0) {
      g.setColor(rightColor);
      g.fillRect(bounds.x + bounds.width - rightWidth + 1, bounds.y, rightWidth, bounds.height);
    }

    if (bottomWidth > 0) {
      g.setColor(bottomColor);
      g.fillRect(bounds.x, bounds.y + bounds.height - bottomWidth + 1, bounds.width, bottomWidth);
    }
  }

  public static void checkForCycles(EditorCell cell) {
    checkForCycles(cell, new ArrayList<EditorCell>());
  }

  public static void checkForCycles(final EditorCell cell, final List<EditorCell> parents) {
    if (ListSequence.fromList(parents).contains(cell)) {
      final _FunctionTypes._return_P1_E0<? extends String, ? super EditorCell> cellText = new _FunctionTypes._return_P1_E0<String, EditorCell>() {
        public String invoke(EditorCell cell) {
          return "[" + cell + "; " + cell.getCellId() + "; " + cell.getSNode() + "; " + cell.getSNode().getConcept() + "]";
        }
      };
      final Wrappers._T<String> msg = new Wrappers._T<String>("");
      cell.getEditorComponent().getEditorContext().getRepository().getModelAccess().runReadAction(() -> msg.value = "Cycle detected: " + ListSequence.fromList(parents).select((it) -> cellText.invoke(it)) + " / " + cellText.invoke(cell));
      throw new RuntimeException(msg.value);
    } else if (cell instanceof EditorCell_Collection) {
      checkChildParentConsistent(((EditorCell_Collection) cell));
      List<EditorCell> parents2 = new ArrayList<EditorCell>(parents);
      ListSequence.fromList(parents2).addElement(cell);
      for (EditorCell child : Sequence.fromIterable(((EditorCell_Collection) cell))) {
        checkForCycles(child, parents2);
      }
    }
  }

  public static void checkChildParentConsistent(EditorCell_Collection parent) {
    for (EditorCell child : Sequence.fromIterable(parent)) {
      if (child.getParent() != parent) {
        throw new RuntimeException(child + ("@" + System.identityHashCode(child)) + " has parent " + child.getParent() + ("@" + System.identityHashCode(child.getParent())) + " but " + parent + ("@" + System.identityHashCode(parent)) + " expected");
      }
    }
  }

  public static boolean isAncestor(EditorCell ancestor, EditorCell child) {
    EditorCell current = child;
    while (current != null) {
      if (current == ancestor) {
        return true;
      }
      current = current.getParent();
    }
    return false;
  }

  public static void addChild(EditorCell_Collection parent, EditorCell child) {
    if (child instanceof jetbrains.mps.nodeEditor.cells.EditorCell && child.getParent() instanceof jetbrains.mps.nodeEditor.cells.EditorCell_Collection) {
      ((jetbrains.mps.nodeEditor.cells.EditorCell_Collection) child.getParent()).removeCell((jetbrains.mps.nodeEditor.cells.EditorCell) child);
    }
    parent.addEditorCell(child);
  }

  public static void wrapCell(EditorCell cell, EditorCell_Collection wrapper) {
    if (cell == null || wrapper == null) {
      return;
    }
    if (wrapper.getClass() == cell.getClass()) {
      throw new RuntimeException("Double wrap. Cell is already a wrapper");
    }
    if (cell.getParent() != null && wrapper.getClass() == cell.getParent().getClass()) {
      throw new RuntimeException("Double wrap. Parent is already a wrapper");
    }
    EditorCell_Collection parent = cell.getParent();
    if (parent != null) {
      parent.addEditorCellBefore(wrapper, cell);
      ((jetbrains.mps.nodeEditor.cells.EditorCell_Collection) parent).removeCell((jetbrains.mps.nodeEditor.cells.EditorCell) cell);
    }
    wrapper.addEditorCell(cell);
  }

  public static void moveChild(EditorCell child, EditorCell_Collection newParent) {
    if (child.getParent() != null) {
      ((jetbrains.mps.nodeEditor.cells.EditorCell_Collection) child.getParent()).removeCell((jetbrains.mps.nodeEditor.cells.EditorCell) child);
    }
    newParent.addEditorCell(child);
  }

  public static void setDeleteActionIfEmpty(EditorCell cell, CellAction action) {
    if (cell == null) {
      return;
    }
    if (cell.getAction(CellActionType.DELETE) == null) {
      cell.setAction(CellActionType.DELETE, action);
    }
    if (cell.getAction(CellActionType.DELETE_TO_WORD_END) == null) {
      cell.setAction(CellActionType.DELETE_TO_WORD_END, action);
    }
  }

  public static List<EditorCell> getEditorCellsFromGrid(Grid grid) {
    List<EditorCell> cells = new ArrayList<EditorCell>();
    getEditorCellsFromGrid(grid, cells);
    return cells;
  }
  private static void getEditorCellsFromGrid(Grid grid, List<EditorCell> accumulator) {
    for (IGridElement e : Sequence.fromIterable(grid)) {
      if (e instanceof Grid) {
        getEditorCellsFromGrid(((Grid) e), accumulator);
      } else if (e instanceof EditorCellGridLeaf) {
        EditorCell cell = ((EditorCellGridLeaf) e).getEditorCell();
        if (cell != null) {
          accumulator.add(cell);
        }
      }
    }
  }

  public static SNode getSNode(IGridElement gridElement) {
    if (gridElement instanceof IGrid) {
      IGrid grid = ((IGrid) gridElement);
      for (IGridElement child : Sequence.fromIterable(grid)) {
        if (child != null) {
          return getSNode(child);
        }
      }
      return null;
    }

    EditorCellGridLeaf editorCellLeaf = as_3ytqdt_a0a2a83(gridElement, EditorCellGridLeaf.class);
    if (editorCellLeaf == null) {
      return null;
    }
    EditorCell editorCell = editorCellLeaf.getEditorCell();
    if (editorCell == null) {
      return null;
    }
    if (editorCell instanceof EditorCell_GridCell) {
      editorCell = ((EditorCell_GridCell) editorCell).getWrappedCell();
    }
    return editorCell.getSNode();
  }

  public static SNode getNodeOfRowNode(EditorCell_GridCell gridCell) {
    if (gridCell == null) {
      return null;
    }
    Grid grid = check_3ytqdt_a0b0ob(gridCell.getTable());
    if (grid == null) {
      return null;
    }
    GridPosition myPosition = gridCell.getGridPosition();

    Set<SNode> nodesInRow = SetSequence.fromSet(new HashSet<SNode>());

    for (int x = 0; x < grid.getSizeX(); x++) {
      EditorCell_GridCell currentCell = (EditorCell_GridCell) check_3ytqdt_a0a0a7a04(as_3ytqdt_a0a0a0a7a04(grid.getElement(x, myPosition.getY()), EditorCellGridLeaf.class));
      if (currentCell == null) {
        continue;
      }
      SetSequence.fromSet(nodesInRow).addElement(currentCell.getWrappedCell().getSNode());
    }
    SNode nodeOfTable = check_3ytqdt_a0i0ob(gridCell.getTable());
    SetSequence.fromSet(nodesInRow).removeElement(nodeOfTable);
    SNode lca = TableTraversalUtil.getLowestCommonAncestor(nodesInRow);
    return (lca == nodeOfTable ? null : lca);
  }


  public static SNode getSNode(IGridElement gridElement, SAbstractConcept ofConcept) {
    SNode node = getSNode(gridElement);
    return (SNodeOperations.isInstanceOf(node, SNodeOperations.asSConcept(ofConcept)) ? node : null);

  }
  private static Grid check_3ytqdt_a0b0ob(TableEditor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getGrid();
    }
    return null;
  }
  private static EditorCell check_3ytqdt_a0a0a7a04(EditorCellGridLeaf checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getEditorCell();
    }
    return null;
  }
  private static SNode check_3ytqdt_a0i0ob(TableEditor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getSNode();
    }
    return null;
  }
  private static <T> T as_3ytqdt_a0a2a83(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_3ytqdt_a0a0a0a7a04(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
