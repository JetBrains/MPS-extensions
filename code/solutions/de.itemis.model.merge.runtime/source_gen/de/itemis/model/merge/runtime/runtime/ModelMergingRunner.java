package de.itemis.model.merge.runtime.runtime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.lang.modelapi.behavior.ModelIdentity__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.util.Collection;
import com.google.common.collect.Lists;
import jetbrains.mps.smodel.tempmodel.TemporaryModels;
import jetbrains.mps.smodel.tempmodel.TempModuleOptions;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class ModelMergingRunner {

  /**
   * Merges left and right model according to policy into resultModel
   * 
   * @param resultModel model
   * @param policy ModelMergingPolicy
   * @param left left
   * @param right right
   */
  public static void run(SModel resultModel, SNode policy, SNode left, SNode right) {
    run(resolveModel(policy, left), resolveModel(policy, right), policy, resultModel);
  }

  private static SModel resolveModel(SNode policy, SNode left) {
    SRepository repository = policy.getModel().getRepository();
    return ModelIdentity__BehaviorDescriptor.toModelReference_id1Bs_61$mvvu.invoke((SLinkOperations.getTarget(left, LINKS.modelRef$l8tE))).resolve(repository);
  }

  public static void runLeftMerge(SNode left, SNode right, SNode policy) {
    runLeftMerge(resolveModel(policy, left), resolveModel(policy, right), policy);
  }

  public static void runLeftMerge(SModel leftModel, SModel rightModel, SNode policy) {
    run(leftModel, rightModel, policy, leftModel);
  }

  public static void run(SModel leftModel, SModel rightModel, SNode policy, SModel resultModel) {
    Collection<SNode> leftRootNodes = Lists.newLinkedList(leftModel.getRootNodes());
    Collection<SNode> rightRootNodes = Lists.newLinkedList(rightModel.getRootNodes());

    ModelMerger merger = ModelMerger.create(policy);
    merger.outputModel = resultModel;
    merger.merge(leftRootNodes, rightRootNodes);
  }

  /**
   * Merges the two given models according to policy
   * 
   * @param policy ModelMergingPolicy
   * @param left left model
   * @param right right model
   * @return a temporary model
   */
  public static SModel run(SNode policy, SModel left, SModel right) {
    SModel resultModel = TemporaryModels.getInstance().createEditable(false, TempModuleOptions.forDefaultModule());
    run(left, right, policy, resultModel);
    return resultModel;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink modelRef$l8tE = MetaAdapterFactory.getContainmentLink(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x19dc9460645cfdd7L, 0x19dc9460645d0827L, "modelRef");
  }
}
