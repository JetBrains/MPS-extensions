package de.itemis.mps.editor.diagram.runtime.model;

/*Generated by MPS */

import com.mxgraph.swing.util.mxGraphTransferable;
import java.awt.datatransfer.DataFlavor;
import org.jetbrains.mps.openapi.module.SRepository;
import com.mxgraph.util.mxRectangle;
import javax.swing.ImageIcon;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.awt.datatransfer.UnsupportedFlavorException;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import java.awt.datatransfer.Transferable;
import java.io.IOException;
import java.awt.dnd.DropTargetDragEvent;
import java.awt.dnd.DropTargetDropEvent;

public class GenericTransferable extends mxGraphTransferable {

  public static final DataFlavor GENERIC_FLAVOR = new DataFlavor(Object.class, "Generic Transferable");

  private transient IPaletteEntry entry;
  private transient SRepository repository;

  public GenericTransferable(IPaletteEntry entry, SRepository repository, Object[] cells, mxRectangle bounds) {
    this(entry, repository, cells, bounds, null);
  }

  public GenericTransferable(IPaletteEntry entry, SRepository repository, Object[] cells, mxRectangle bounds, ImageIcon image) {
    super(cells, bounds, image);
    this.entry = entry;
    this.repository = repository;
  }

  @Override
  protected DataFlavor[] getRicherFlavors() {
    List<DataFlavor> flavors = ListSequence.fromList(new ArrayList<DataFlavor>());
    ListSequence.fromList(flavors).addElement(this.dataFlavor);
    if (entry instanceof IDragPaletteEntry && getDragObject() != null) {
      ListSequence.fromList(flavors).addElement(this.GENERIC_FLAVOR);
    }
    return ListSequence.fromList(flavors).toGenericArray(DataFlavor.class);
  }

  @Override
  public Object getRicherData(DataFlavor flavor) throws UnsupportedFlavorException {
    if (flavor.equals(dataFlavor)) {
      return this;
    } else if (flavor.equals(GenericTransferable.GENERIC_FLAVOR) && entry instanceof IDragPaletteEntry) {
      return getDragObject();
    } else {
      throw new UnsupportedFlavorException(flavor);
    }
  }

  public Object getDragObject() {
    final Wrappers._T<Object> data = new Wrappers._T<Object>();
    repository.getModelAccess().runReadAction(() -> data.value = ((IDragPaletteEntry) entry).getDragObject());
    return data.value;
  }

  public static Object getTransferData(Transferable transferable) {
    try {
      return transferable.getTransferData(GENERIC_FLAVOR);
    } catch (IOException e) {
      throw new RuntimeException(e);
    } catch (UnsupportedFlavorException e) {
      throw new RuntimeException(e);
    }
  }

  public static boolean is(DropTargetDragEvent e) {
    try {
      return e.getTransferable().isDataFlavorSupported(GENERIC_FLAVOR);
    } catch (Exception ex) {
      return false;
    }
  }

  public static boolean is(DropTargetDropEvent e) {
    try {
      return e.getTransferable().isDataFlavorSupported(GENERIC_FLAVOR);
    } catch (Exception ex) {
      return false;
    }
  }
}
