package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import com.mxgraph.swing.handler.mxGraphHandler;
import com.mxgraph.swing.handler.mxCellMarker;
import com.mxgraph.view.mxCellState;
import com.mxgraph.swing.mxGraphComponent;
import java.awt.Rectangle;
import java.awt.GraphicsEnvironment;
import java.awt.event.MouseEvent;
import jetbrains.mps.internal.collections.runtime.Sequence;
import com.mxgraph.model.mxCell;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import de.itemis.mps.editor.collapsible.runtime.CollapseExpandToggleCell;
import jetbrains.mps.project.Project;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.mxgraph.swing.handler.mxMovePreview;
import java.awt.dnd.DropTargetDragEvent;
import de.itemis.mps.editor.diagram.runtime.model.GenericTransferable;
import javax.swing.TransferHandler;
import java.awt.dnd.DropTargetEvent;
import java.awt.dnd.DropTargetDropEvent;
import com.mxgraph.model.mxICell;

public class MyGraphHandler extends mxGraphHandler {

  private boolean myIsValid = false;
  private boolean myMarkerEnabled = false;
  private mxCellMarker myMarker = new mxCellMarker(graphComponent) {
    @Override
    protected boolean isValidState(mxCellState state) {
      return myIsValid;
    }
  };

  public MyGraphHandler(mxGraphComponent graphComponent) {
    super(graphComponent);
    setLivePreview(true);
    setRemoveCellsFromParent(false);
  }

  @Override
  public void setPreviewBounds(Rectangle rectangle) {
    super.setPreviewBounds(rectangle);
    ((MyGraphComponent) getGraphComponent()).getEditorComponent().relayout();
  }
  @Override
  protected void installDragGestureHandler() {
    if (!(GraphicsEnvironment.isHeadless())) {
      super.installDragGestureHandler();
    }
  }


  @Override
  protected void installDropTargetHandler() {
    if (!(GraphicsEnvironment.isHeadless())) {
      super.installDropTargetHandler();
    }
  }


  @Override
  public void mouseDragged(MouseEvent event) {
    getGraphComponent().autoextendOnMove(event);
    super.mouseDragged(event);
  }

  @Override
  public MyGraphComponent getGraphComponent() {
    return (MyGraphComponent) super.getGraphComponent();
  }


  @Override
  public void mousePressed(MouseEvent event) {
    // (sub-)diagram buttons
    for (ContextButtonContainer container : Sequence.fromIterable(getContextButtonContainers())) {
      container.mousePressed(event);
    }
    if (event.isConsumed()) {
      return;
    }

    // allow the user to change the active palette by clicking on a (sub-)diagram
    BaseDiagramECell clickedDiagram = getGraphComponent().getDiagramCell();

    // clicked on a subdiagram?
    Object diagramCell = graphComponent.getCellAt(event.getX(), event.getY(), false);
    do {
      if (diagramCell instanceof SubDiagramDCell) {
        clickedDiagram = ((SubDiagramDCell) diagramCell).getECell();
        break;
      }
      diagramCell = check_a750xw_a0b0j0t(((mxCell) diagramCell));
    } while (diagramCell != null);

    // toggle collapsible
    if (event.getButton() == MouseEvent.BUTTON1) {
      EditorCell leafAtCursor = getGraphComponent().findLeafAtCursor(event);
      if (leafAtCursor instanceof CollapseExpandToggleCell) {
        ((CollapseExpandToggleCell) leafAtCursor).toggle();
        return;
      }
    }

    Project project = clickedDiagram.getEditorComponent().getEditorContext().getOperationContext().getProject();
    check_a750xw_a51a91(Palette.getInstance(project), clickedDiagram);

    if (isVisible() || movePreview.isActive()) {
      reset();
    }
    super.mousePressed(event);
  }


  @Override
  public void mouseMoved(MouseEvent event) {
    // (sub-)diagram buttons
    for (ContextButtonContainer container : Sequence.fromIterable(getContextButtonContainers())) {
      container.mouseMoved(event);
    }

    super.mouseMoved(event);
  }

  @Override
  public void mouseReleased(MouseEvent event) {
    // (sub-)diagram buttons
    for (ContextButtonContainer container : ListSequence.fromList(Sequence.fromIterable(getContextButtonContainers()).toList())) {
      container.mouseReleased(event);
    }
    if (event.isConsumed()) {
      return;
    }

    if (event.isMetaDown() || event.isControlDown()) {
      // prevent selection when a reference is followed (cmd+click)
      boolean wasSelectEnabled = selectEnabled;
      try {
        selectEnabled = false;
        super.mouseReleased(event);
      } finally {
        selectEnabled = wasSelectEnabled;
      }
    } else {
      super.mouseReleased(event);
    }
  }

  @Override
  public boolean isCloneEnabled() {
    return false;
  }

  @Override
  protected mxMovePreview createMovePreview() {
    return new MyMovePreview(graphComponent);
  }

  public Iterable<ContextButtonContainer> getContextButtonContainers() {
    return getGraphComponent().getGraph().getContextButtonContainers();
  }

  @Override
  public void dragEnter(DropTargetDragEvent e) {
    myIsValid = false;
    if (GenericTransferable.is(e)) {
      e.acceptDrag(TransferHandler.COPY_OR_MOVE);
      myIsValid = true;
      myMarker.process(createEvent(e));
    } else {
      myMarker.reset();
      super.dragEnter(e);
    }
  }

  @Override
  public void dragExit(DropTargetEvent e) {
    myIsValid = false;
    myMarker.reset();
    super.dragExit(e);
  }

  @Override
  public void drop(DropTargetDropEvent e) {
    myIsValid = false;
    myMarker.reset();
    super.drop(e);
  }

  @Override
  public void dragOver(DropTargetDragEvent e) {
    myIsValid = false;
    if (GenericTransferable.is(e)) {
      Object cell = getGraphComponent().getCellAt(e.getLocation().x, e.getLocation().y);
      if (cell instanceof IDiagramDCell) {
        IDiagramDCell dcell = ((IDiagramDCell) cell);
        Object data = GenericTransferable.getTransferData(e.getTransferable());
        if (dcell.canDrop(data)) {
          myIsValid = true;
        }
      }
      if (myIsValid) {
        e.acceptDrag(TransferHandler.COPY);
      } else {
        e.rejectDrag();
      }
      myMarker.process(createEvent(e));
    } else {
      myMarker.reset();
      super.dragOver(e);
    }
  }
  private static mxICell check_a750xw_a0b0j0t(mxCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getParent();
    }
    return null;
  }
  private static void check_a750xw_a51a91(Palette checkedDotOperand, BaseDiagramECell clickedDiagram) {
    if (null != checkedDotOperand) {
      checkedDotOperand.diagramClicked(clickedDiagram);
    }

  }
}
