package de.q60.mps.explorer;

/*Generated by MPS */

import com.intellij.openapi.ui.SimpleToolWindowPanel;
import jetbrains.mps.project.Project;
import com.intellij.ui.OnePixelSplitter;
import de.q60.mps.polymorphicfunctions.runtime.ImplementationsFromGlobalRepository;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import de.q60.mps.polymorphicfunctions.runtime.IImplementationProvider;
import jetbrains.mps.internal.collections.runtime.Sequence;
import de.q60.mps.polymorphicfunctions.behavior.PriorityGroupDeclaration__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPointerOperations;
import jetbrains.mps.smodel.SNodePointer;
import com.intellij.ui.ScrollPaneFactory;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.SwingUtilities;
import javax.swing.JComponent;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import jetbrains.mps.workbench.action.ActionUtils;
import com.intellij.openapi.actionSystem.ActionManager;
import com.intellij.openapi.actionSystem.IdeActions;
import com.intellij.openapi.actionSystem.ActionToolbar;
import com.intellij.openapi.actionSystem.ActionPlaces;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import javax.swing.tree.DefaultTreeModel;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.event.TreeWillExpandListener;
import javax.swing.event.TreeExpansionEvent;
import javax.swing.tree.ExpandVetoException;
import javax.swing.event.TreeExpansionListener;
import com.intellij.openapi.application.ApplicationManager;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.SReference;
import javax.swing.tree.MutableTreeNode;
import de.q60.mps.explorer.pf.IExplorerContext;
import org.jetbrains.mps.openapi.module.SRepository;
import de.q60.mps.polymorphicfunctions.runtime.IPFContext;
import de.q60.mps.polymorphicfunctions.runtime.DefaultPFContext;
import de.q60.mps.polymorphicfunctions.runtime.GroupPFContext;
import de.q60.mps.polymorphicfunctions.runtime.ContextPFContext;
import de.q60.mps.polymorphicfunctions.behavior.ContextDeclaration__BehaviorDescriptor;
import de.q60.mps.polymorphicfunctions.runtime.ParameterList;
import de.q60.mps.polymorphicfunctions.behavior.PolymorphicFunctionDeclaration__BehaviorDescriptor;
import de.q60.mps.explorer.pf.ExplorerElement;
import org.jetbrains.mps.openapi.model.SNodeReference;
import javax.swing.tree.DefaultTreeCellRenderer;
import java.awt.Component;
import javax.swing.JTree;
import javax.swing.Icon;
import javax.swing.tree.TreeModel;
import java.awt.event.MouseEvent;
import jetbrains.mps.openapi.navigation.NavigationSupport;
import javax.swing.tree.TreeNode;
import javax.swing.tree.TreePath;

public class TransformationTraceComponent extends SimpleToolWindowPanel {

  private Project myProject;
  private TreeComp myMasterTree;
  private TreeComp myDetailTree;
  private OnePixelSplitter mySplitPane;
  private ImplementationsFromGlobalRepository implProvider;
  private _FunctionTypes._void_P1_E0<? super Runnable> readAccess = (final Runnable r) -> myProject.getRepository().getModelAccess().runReadAction(() -> r.run());

  public TransformationTraceComponent(Project project) {
    super(false, true);
    myProject = project;
    initComponents();
  }

  public _FunctionTypes._void_P1_E0<? super Runnable> getReadAccess() {
    return this.readAccess;
  }

  public void setReadAccess(_FunctionTypes._void_P1_E0<? super Runnable> readAccess) {
    this.readAccess = readAccess;
  }

  protected IImplementationProvider getImplProvider() {
    if (implProvider == null) {
      implProvider = new ImplementationsFromGlobalRepository() {
        @Override
        protected Iterable<String> getModelNames() {
          return Sequence.<String>singleton("pf");
        }
      };
    }
    return implProvider;
  }

  public TreeComp getMasterTree() {
    return this.myMasterTree;
  }

  public TreeComp getDetailTree() {
    return this.myDetailTree;
  }

  public void dispose() {
    if (implProvider != null) {
      implProvider.dispose();
      implProvider = null;
    }
  }

  protected void initComponents() {
    myMasterTree = createTree();
    myDetailTree = createTree();
    myProject.getRepository().getModelAccess().runReadAction(() -> {
      myMasterTree.setPfGroupId(PriorityGroupDeclaration__BehaviorDescriptor.getGroupId_id6EfR$DZON7b.invoke(SPointerOperations.resolveNode(new SNodePointer("r:4629a434-6c59-4e7a-9315-92ac147f2aaa(de.q60.mps.explorer.pf)", "4739596383735507555"), myProject.getRepository())));
      myDetailTree.setPfGroupId(PriorityGroupDeclaration__BehaviorDescriptor.getGroupId_id6EfR$DZON7b.invoke(SPointerOperations.resolveNode(new SNodePointer("r:4629a434-6c59-4e7a-9315-92ac147f2aaa(de.q60.mps.explorer.pf)", "4739596383735595951"), myProject.getRepository())));
    });
    mySplitPane = new OnePixelSplitter(false, 0.5f);
    mySplitPane.setFirstComponent(ScrollPaneFactory.createScrollPane(myMasterTree, true));
    mySplitPane.setSecondComponent(ScrollPaneFactory.createScrollPane(myDetailTree, true));
    setToolbar(createToolbar(myMasterTree));
    setContent(mySplitPane);

    myMasterTree.addTreeSelectionListener((TreeSelectionEvent event) -> {
      final Object detailViewRoot = Sequence.fromIterable(Sequence.fromArray(event.getNewLeadSelectionPath().getPath())).ofType(TNode.class).select((it) -> it.getDetailViewRoot()).last();
      SwingUtilities.invokeLater(() -> loadTrace(detailViewRoot, myDetailTree));
    });
  }

  protected JComponent createToolbar(JComponent targetComp) {
    DefaultActionGroup group = ActionUtils.groupFromActions(ActionManager.getInstance().getAction(IdeActions.ACTION_PIN_ACTIVE_TAB));
    ActionToolbar actionToolbar = ActionManager.getInstance().createActionToolbar(ActionPlaces.TOOLBAR, group, false);
    actionToolbar.setTargetComponent(targetComp);
    return actionToolbar.getComponent();
  }

  protected TreeComp createTree() {
    final Wrappers._T<TreeComp> tree = new Wrappers._T<TreeComp>();
    tree.value = new TreeComp(new DefaultTreeModel(new DefaultMutableTreeNode("Root")));
    tree.value.setRootVisible(false);
    tree.value.setCellRenderer(new Renderer());
    tree.value.addTreeWillExpandListener(new TreeWillExpandListener() {
      public void treeWillExpand(final TreeExpansionEvent e) throws ExpandVetoException {
      }
      public void treeWillCollapse(TreeExpansionEvent e) throws ExpandVetoException {
      }
    });
    tree.value.addTreeExpansionListener(new TreeExpansionListener() {
      public void treeExpanded(final TreeExpansionEvent e) {
        final TNode tnode = as_7hjnts_a0a0a0a0a0a5a62(e.getPath().getLastPathComponent(), TNode.class);
        if (tnode != null) {
          ApplicationManager.getApplication().invokeLater(() -> runRead(() -> {
            boolean wasInititalized = tnode.isInitialized();
            tnode.ensureInitialized((DefaultTreeModel) tree.value.getModel());

            // Ensure the expand/collapse icon shows correctly if there are child nodes
            for (int i = 0; i < tnode.getChildCount(); i++) {
              TNode childTNode = as_7hjnts_a0a0a4a0a0a0a0a0b0a0a0a0f0ab(tnode.getChildAt(i), TNode.class);
              if (childTNode != null && !(childTNode.forceChildrenLazyLoading())) {
                childTNode.ensureInitialized((DefaultTreeModel) tree.value.getModel());
              }
            }

            if (!(wasInititalized)) {
              tree.value.expandPath(e.getPath());

              for (int i = 0; i < tnode.getChildCount(); i++) {
                TNode childTNode = as_7hjnts_a0a0a2a6a0a0a0a0a0b0a0a0a0f0ab(tnode.getChildAt(i), TNode.class);
                if (childTNode != null && childTNode.expandByDefault()) {
                  tree.value.expandPath(e.getPath().pathByAddingChild(childTNode));
                }
              }

            }
          }));
        }
      }
      public void treeCollapsed(TreeExpansionEvent p0) {
      }
    });
    return tree.value;
  }

  public void loadTrace(Object elementToTrace) {
    loadTrace(elementToTrace, myMasterTree);
  }

  public void loadTrace(final Object elementToTrace, final TreeComp tree) {
    runRead(() -> {
      DefaultMutableTreeNode rootNode = new DefaultMutableTreeNode("Root");
      DefaultTreeModel model = new DefaultTreeModel(rootNode);
      if (elementToTrace != null) {
        loadTrace(elementToTrace, model, rootNode, "", tree.getPfGroupId());
      }
      if (elementToTrace instanceof SNode) {
        for (SReference ref : Sequence.fromIterable(((SNode) elementToTrace).getReferences())) {
          SNode refTarget = ref.getTargetNode();
          if (refTarget != null) {
            loadTrace(refTarget, model, rootNode, ref.getLink().getName() + ": ", tree.getPfGroupId());
          }
        }
      }
      tree.setModel(model);
      for (int i = 0; i < tree.getRowCount(); i++) {
        TNode tnode = as_7hjnts_a0a0a5a0a0a03(tree.getPathForRow(i).getLastPathComponent(), TNode.class);
        if (tnode == null || tnode.expandByDefault()) {
          tree.expandRow(i);
        }
      }
    });
  }

  public void runRead(Runnable r) {
    readAccess.invoke(r);
  }

  protected MutableTreeNode loadTrace(final Object element, final DefaultTreeModel model, MutableTreeNode parentTreeNode, String prefix, String pfGroupId) {
    if (element == null) {
      return null;
    }

    IExplorerContext builderContext = new IExplorerContext() {
      public DefaultTreeModel getTreeModel() {
        return model;
      }
      public MutableTreeNode loadTrace(final Object element, MutableTreeNode parentTreeNode, String prefix) {
        throw new UnsupportedOperationException();
      }
      @Override
      public SRepository getRepository() {
        return myProject.getRepository();
      }
    };

    IPFContext pfcontext = new DefaultPFContext(getImplProvider());
    pfcontext = new GroupPFContext(pfcontext, pfGroupId);
    pfcontext = new ContextPFContext(pfcontext, ContextDeclaration__BehaviorDescriptor.getContextId_id2Vy1$4N2l38.invoke(SPointerOperations.resolveNode(new SNodePointer("r:4629a434-6c59-4e7a-9315-92ac147f2aaa(de.q60.mps.explorer.pf)", "3378269547578044726"), myProject.getRepository())), new ParameterList(new Object[]{builderContext}));

    MutableTreeNode treeNode = (MutableTreeNode) pfcontext.callFunction(PolymorphicFunctionDeclaration__BehaviorDescriptor.getId_id3jJoUQ7114V.invoke(SPointerOperations.resolveNode(new SNodePointer("r:4629a434-6c59-4e7a-9315-92ac147f2aaa(de.q60.mps.explorer.pf)", "4645130142491897652"), myProject.getRepository())), new ParameterList(new Object[]{((prefix != null && prefix.length() > 0) ? new ExplorerElement.Child(prefix, element) : element), parentTreeNode, builderContext}));

    return treeNode;
  }



  public SNode resolveTraceInfo(String info) {
    if (info == null) {
      return null;
    }
    SNodeReference declRef;
    try {
      declRef = SNodePointer.deserialize(info);
    } catch (Exception ex) {
      return null;
    }
    return declRef.resolve(myProject.getRepository());
  }

  public static String shorterTransformationName(String longName) {
    String separator = ".transformations.";
    int index = longName.indexOf(separator);
    if (index == -1) {
      return longName;
    }
    return longName.substring(index + separator.length());
  }


  public class Renderer extends DefaultTreeCellRenderer {

    @Override
    public Component getTreeCellRendererComponent(JTree tree, Object value, boolean sel, boolean expanded, boolean leaf, int row, boolean hasFocus) {
      super.getTreeCellRendererComponent(tree, value, sel, expanded, leaf, row, hasFocus);
      if (value instanceof TNode) {
        Icon icon = ((TNode) value).getIcon();
        if (icon != null) {
          setIcon(icon);
        }
      }
      return this;
    }
  }

  public class TreeComp extends JTree {
    private String pfGroupId;

    public TreeComp(TreeModel m) {
      super(m);
    }

    @Override
    protected void processMouseEvent(MouseEvent event) {
      if (event.getClickCount() == 2 && event.getButton() == MouseEvent.BUTTON1) {
        event.consume();

        // Navigate to node
        final TNode selectedNode = as_7hjnts_a0a3a0a4tb(check_7hjnts_a0a3a0a4tb(this.getSelectionPath(), this), TNode.class);
        if (selectedNode != null) {
          myProject.getRepository().getModelAccess().executeCommand(() -> {
            SNode target = selectedNode.getNavigationTarget();
            if (target != null) {
              NavigationSupport.getInstance().openNode(myProject, target, true, true);
            }
          });
        }

        // Don't expand/collapse nodes on double click
        return;
      }
      super.processMouseEvent(event);
    }

    public void expandAll() {
      for (int i = 0; i < getRowCount(); i++) {
        expandRow(i);
      }
    }

    public String getPfGroupId() {
      return this.pfGroupId;
    }

    public void setPfGroupId(String pfGroupId) {
      this.pfGroupId = pfGroupId;
    }

    public TreeNode find(final ITreeNodeFinder finder) {
      final TreeNode root = (DefaultMutableTreeNode) getModel().getRoot();
      final Wrappers._T<TreeNode> found = new Wrappers._T<TreeNode>(null);
      runRead(() -> found.value = find(root, finder));
      return found.value;
    }

    protected TreeNode find(TreeNode tnode, ITreeNodeFinder finder) {
      if (tnode instanceof TNode) {
        ((TNode) tnode).ensureInitialized((DefaultTreeModel) getModel());
      }
      for (int i = 0; i < tnode.getChildCount(); i++) {
        TreeNode child = tnode.getChildAt(i);
        if (finder.matches(child)) {
          return child;
        }
        if (finder.searchInside(child)) {
          TreeNode found = find(child, finder);
          if (found != null) {
            return found;
          }
        }
      }
      return null;
    }

  }
  private static Object check_7hjnts_a0a3a0a4tb(TreePath checkedDotOperand, TreeComp checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLastPathComponent();
    }
    return null;
  }
  private static <T> T as_7hjnts_a0a0a0a0a0a5a62(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_7hjnts_a0a0a4a0a0a0a0a0b0a0a0a0f0ab(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_7hjnts_a0a0a2a6a0a0a0a0a0b0a0a0a0f0ab(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_7hjnts_a0a0a5a0a0a03(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_7hjnts_a0a3a0a4tb(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
