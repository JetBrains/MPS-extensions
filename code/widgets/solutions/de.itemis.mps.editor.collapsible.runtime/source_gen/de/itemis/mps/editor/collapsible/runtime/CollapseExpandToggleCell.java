package de.itemis.mps.editor.collapsible.runtime;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.cells.EditorCell_Basic;
import de.itemis.mps.mouselistener.runtime.MouseListenerProvider;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import java.awt.Rectangle;
import java.awt.Graphics;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import java.awt.Graphics2D;
import com.intellij.ui.JBColor;
import java.awt.BasicStroke;
import java.awt.Dimension;
import java.awt.event.MouseListener;
import java.awt.event.MouseMotionListener;

public class CollapseExpandToggleCell extends EditorCell_Basic implements MouseListenerProvider {


  private CollapsibleCell myCollapsibleCell;
  private MouseAdapter myMouseListener = new MouseAdapter() {
    @Override
    public void mouseClicked(MouseEvent event) {
      if (getBounds().contains(event.getX(), event.getY())) {
        toggle();
      }
    }

    @Override
    public void mouseMoved(MouseEvent event) {
      boolean wasHighlighted = myIsHighlighted;
      myIsHighlighted = getBounds().contains(event.getX(), event.getY());
      if (myIsHighlighted != wasHighlighted) {
        ((EditorComponent) getEditorComponent()).repaint(getBounds());
      }
    }
  };
  private boolean myIsHighlighted = false;
  private Tuples._2<Integer, Integer> myPreferredSize;
  private Integer myAscent = null;

  public CollapseExpandToggleCell(EditorContext context, SNode node, CollapsibleCell collapsibleCell) {
    super(context, node);
    myCollapsibleCell = collapsibleCell;
    setSelectable(false);
  }

  public void toggle() {
    myCollapsibleCell.setCollapsibleCollapsed(!(myCollapsibleCell.isCollapsibleCollapsed()));
  }

  public void setPreferredSize(int w, int h) {
    myPreferredSize = MultiTuple.<Integer,Integer>from(w, h);
  }

  @Override
  public int getAscent() {
    return (myAscent == null ? super.getAscent() : myAscent);
  }

  public void setAscent(Integer ascent) {
    myAscent = ascent;
  }

  public Rectangle getBounds() {
    return new Rectangle(getX() + getLeftGap(), getY(), getWidth() - getLeftGap() - getRightGap(), getHeight());
  }

  @Override
  public void paintContent(Graphics g_, ParentSettings settings) {
    Graphics2D g = (Graphics2D) g_.create();
    try {
      if (!(myCollapsibleCell.paintNodeCustom(g, getBounds(), myIsHighlighted))) {
        return;
      }

      Rectangle bounds = getBounds();
      bounds.grow(-1, -1);

      g.setColor((myIsHighlighted ? JBColor.LIGHT_GRAY : JBColor.WHITE));
      g.fill(bounds);

      g.setStroke(new BasicStroke(1.0f));
      g.setColor(JBColor.GRAY);
      g.draw(bounds);

      bounds.grow(-bounds.width / 4, -bounds.width / 4);
      g.drawLine(bounds.x, bounds.y + bounds.height / 2, bounds.x + bounds.width, bounds.y + bounds.height / 2);
      if (isCollapsibleCollapsed()) {
        g.drawLine(bounds.x + bounds.width / 2, bounds.y, bounds.x + bounds.width / 2, bounds.y + bounds.height);
      }
    } finally {
      g.dispose();
    }
  }

  @Override
  protected void relayoutImpl() {
    int w = 13;
    int h = 13;

    Dimension customSize = myCollapsibleCell.myCallback.getNodeSize();
    if (customSize != null) {
      w = customSize.width;
      h = customSize.height;
    }

    if (myPreferredSize != null) {
      w = (int) myPreferredSize._0();
      h = (int) myPreferredSize._1();
    }
    w = Math.max(w, 10);
    h = Math.max(h, 10);
    if (w % 2 == 1) {
      w--;
    }
    if (h % 2 == 1) {
      h--;
    }
    setWidth(w);
    setHeight(h);
  }

  public boolean isCollapsibleCollapsed() {
    return myCollapsibleCell.isCollapsibleCollapsed();
  }

  @Override
  public MouseListener getMouseListener() {
    return myMouseListener;
  }

  @Override
  public MouseMotionListener getMouseMotionListener() {
    return myMouseListener;
  }

}
