package de.itemis.model.merge.runtime.runtime;

/*Generated by MPS */

import com.google.common.collect.ImmutableMap;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.Set;
import org.jetbrains.mps.openapi.language.SProperty;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.lang.structure.behavior.PropertyDeclaration__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractLink;
import jetbrains.mps.lang.structure.behavior.LinkDeclaration__BehaviorDescriptor;
import com.google.common.collect.Maps;
import org.apache.commons.lang3.builder.ToStringBuilder;
import org.apache.commons.lang3.builder.ToStringStyle;

public class MergerResolverImpl implements MergerResolver {
  public ImmutableMap<SAbstractConcept, MapWrapper<SNode, ContentHolder<PropertyMerger>>> propertyMergePolicy;
  public ImmutableMap<SAbstractConcept, MapWrapper<SNode, ContentHolder<ConceptChildMerger>>> childMergePolicy;
  public ImmutableMap<SAbstractConcept, MapWrapper<SNode, ContentHolder<ConceptRefMerger>>> referenceMergePolicy;

  public ImmutableMap<SAbstractConcept, ContentHolder<Identity>> conceptIdFunc;

  public ImmutableMap<SAbstractConcept, MergerResolver> attributeConceptsToMergeResolver;

  public MergerResolverImpl(ImmutableMap<SAbstractConcept, MapWrapper<SNode, ContentHolder<PropertyMerger>>> p, ImmutableMap<SAbstractConcept, MapWrapper<SNode, ContentHolder<ConceptChildMerger>>> c, ImmutableMap<SAbstractConcept, MapWrapper<SNode, ContentHolder<ConceptRefMerger>>> r, ImmutableMap<SAbstractConcept, ContentHolder<Identity>> i) {
    this.propertyMergePolicy = p;
    this.childMergePolicy = c;
    this.referenceMergePolicy = r;
    this.conceptIdFunc = i;
  }

  public ImmutableMap<SAbstractConcept, Set<SNode>> conceptToProperty() {
    return transform(this.propertyMergePolicy);
  }
  public ImmutableMap<SAbstractConcept, Set<SNode>> conceptToChildLink() {
    return transform(this.childMergePolicy);
  }

  public ImmutableMap<SAbstractConcept, Set<SNode>> conceptToReferenceLink() {
    return transform(this.referenceMergePolicy);
  }

  @Override
  public PropertyMerger propertyMergerFor(SAbstractConcept sac, SProperty property) {
    for (Map.Entry<SNode, ContentHolder<PropertyMerger>> e : SetSequence.fromSet(this.propertyMergePolicy.get(sac).entries())) {
      if ((boolean) PropertyDeclaration__BehaviorDescriptor.is_id4MKjpUYnih4.invoke(e.getKey(), property)) {
        return e.getValue().content();
      }
    }
    return null;
  }

  @Override
  public ConceptChildMerger childMergerFor(SAbstractConcept concept, SAbstractLink link) {
    for (Map.Entry<SNode, ContentHolder<ConceptChildMerger>> e : SetSequence.fromSet(this.childMergePolicy.get(concept).entries())) {
      SNode ld = e.getKey();
      if ((boolean) LinkDeclaration__BehaviorDescriptor.is_id4MKjpUYniHA.invoke(ld, link)) {
        return e.getValue().content();
      }
    }
    return null;
  }

  @Override
  public ConceptRefMerger referenceMergerFor(SAbstractConcept concept, SAbstractLink link) {
    for (Map.Entry<SNode, ContentHolder<ConceptRefMerger>> e : SetSequence.fromSet(this.referenceMergePolicy.get(concept).entries())) {
      SNode ld = e.getKey();

      if ((boolean) LinkDeclaration__BehaviorDescriptor.is_id4MKjpUYniHA.invoke(ld, link)) {
        return e.getValue().content();
      }
    }
    return null;
  }
  public ImmutableMap<SAbstractConcept, Identity> conceptToIdFunction() {
    Map<SAbstractConcept, Identity> conceptToIdentity = Maps.transformValues(this.conceptIdFunc, (ContentHolder<Identity> stuff) -> stuff.content());
    return ImmutableMap.copyOf(Maps.filterValues(conceptToIdentity, (Identity id) -> id != null));
  }

  public Set<SAbstractConcept> conceptsWithId() {
    return Maps.filterValues(this.conceptIdFunc, (ContentHolder<Identity> stuff) -> stuff.content() != null).keySet();
  }

  private static <X, C> ImmutableMap<SAbstractConcept, Set<X>> transform(ImmutableMap<SAbstractConcept, MapWrapper<X, ContentHolder<C>>> input) {
    Map<SAbstractConcept, Set<X>> transformValues = Maps.transformValues(input, (MapWrapper<X, ContentHolder<C>> mw) -> mw.keys());
    return ImmutableMap.copyOf(transformValues);
  }
  @Override
  public String toString() {
    return new ToStringBuilder(this, ToStringStyle.MULTI_LINE_STYLE).append("Concept-Property: ", this.propertyMergePolicy).append("Concept-Child", this.childMergePolicy).append("Concept-Ref: ", this.referenceMergePolicy).build();
  }

}
