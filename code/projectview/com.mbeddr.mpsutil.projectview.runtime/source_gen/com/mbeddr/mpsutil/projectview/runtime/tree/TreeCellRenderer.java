package com.mbeddr.mpsutil.projectview.runtime.tree;

/*Generated by MPS */

import javax.swing.JPanel;
import javax.swing.JLabel;
import jetbrains.mps.ide.ui.tree.MPSTreeNode;
import javax.swing.Icon;
import com.intellij.icons.AllIcons;
import java.awt.BorderLayout;
import java.awt.Component;
import javax.swing.JTree;
import com.intellij.util.ui.UIUtil;
import com.intellij.ui.JBColor;
import java.awt.Font;
import javax.swing.UIManager;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.AlphaComposite;
import jetbrains.mps.ide.ui.tree.ErrorState;
import jetbrains.mps.nodeEditor.MPSColors;
import jetbrains.mps.openapi.editor.ColorConstants;
import jetbrains.mps.ide.util.ColorAndGraphicsUtil;
import java.awt.Composite;

public class TreeCellRenderer extends JPanel implements javax.swing.tree.TreeCellRenderer {
  private JLabel myMainTextLabel = new JLabel();
  private JLabel myAdditionalTextLabel = new JLabel();
  private MPSTreeNode myNode;

  private Icon myRefreshIcon = new NoAlphaIcon(AllIcons.Actions.Refresh);

  public TreeCellRenderer() {
    setLayout(new BorderLayout());
    setOpaque(false);
    add(myMainTextLabel, BorderLayout.CENTER);
    add(myAdditionalTextLabel, BorderLayout.EAST);
  }

  @Override
  public Component getTreeCellRendererComponent(JTree tree, Object value, boolean selected, boolean expanded, boolean leaf, int row, boolean hasFocus) {
    setOpaque(false);

    myMainTextLabel.setForeground((selected ? UIUtil.getTreeSelectionForeground(tree.hasFocus()) : UIUtil.getTreeForeground()));
    myAdditionalTextLabel.setForeground((selected ? myMainTextLabel.getForeground() : JBColor.GRAY));

    Icon icon = null;
    String text = value.toString();
    String additionalText = null;
    if (value instanceof MPSTreeNode) {
      MPSTreeNode treeNode = (MPSTreeNode) value;
      icon = treeNode.getIcon(expanded);
      text = treeNode.getText();
      additionalText = treeNode.getAdditionalText();
      Font newFont = tree.getFont().deriveFont(treeNode.getFontStyle());
      newFont = newFont.deriveFont(treeNode.getFontAttributes());
      myMainTextLabel.setFont(newFont);
      myAdditionalTextLabel.setFont(tree.getFont());
      if (!(selected)) {
        myMainTextLabel.setForeground(treeNode.getColor());
      }
      myNode = treeNode;
    } else {
      myMainTextLabel.setFont(tree.getFont());
      myAdditionalTextLabel.setFont(tree.getFont());
      myNode = null;
    }
    myMainTextLabel.setText(text);
    if (additionalText != null) {
      myAdditionalTextLabel.setText(" (" + additionalText + ") ");
    } else {
      myAdditionalTextLabel.setText(" ");
    }
    if (icon == null) {
      if (leaf) {
        icon = UIManager.getIcon("Tree.leafIcon");
      } else
      if (expanded) {
        icon = UIManager.getIcon("Tree.openIcon");
      } else {
        icon = UIManager.getIcon("Tree.closedIcon");
      }
    }
    if (check_hzroup_a21a8(as_hzroup_a0a21a8(value, CustomTreeNode.class))) {
      icon = myRefreshIcon;
    }
    myMainTextLabel.setIcon(icon);
    return this;
  }

  @Override
  public void paint(Graphics g_) {
    Graphics2D g = ((Graphics2D) g_.create());
    try {
      if (check_hzroup_a0a1a01(as_hzroup_a0a0a1a01(myNode, ITreeNode.class))) {
        g.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER, 0.3f));
      }

      super.paint(g);
      int imageOffset;
      Icon icon = myMainTextLabel.getIcon();
      if (icon != null) {
        imageOffset = icon.getIconWidth() + Math.max(0, myMainTextLabel.getIconTextGap() - 1);
      } else {
        imageOffset = 0;
      }
      if (myNode != null && myNode.getAggregatedErrorState() != ErrorState.NONE) {
        if (myNode.getAggregatedErrorState() == ErrorState.ERROR) {
          g.setColor(MPSColors.RED);
        } else {
          g.setColor(new JBColor(ColorConstants.WARNING, ColorConstants.WARNING_DARK));
        }
        ColorAndGraphicsUtil.drawWave(g, imageOffset, getWidth(), getHeight() - ColorAndGraphicsUtil.WAVE_HEIGHT - 1);
      }
    } finally {
      g.dispose();
    }
  }

  public class NoAlphaIcon implements Icon {
    private Icon myIcon;
    public NoAlphaIcon(Icon icon) {
      myIcon = icon;
    }
    public int getIconHeight() {
      return myIcon.getIconHeight();
    }
    public int getIconWidth() {
      return myIcon.getIconWidth();
    }
    public void paintIcon(Component component, Graphics g, int x, int y) {
      Composite composite = ((Graphics2D) g).getComposite();
      ((Graphics2D) g).setComposite(AlphaComposite.SrcOver);
      myIcon.paintIcon(component, g, x, y);
      ((Graphics2D) g).setComposite(composite);

    }
  }
  private static boolean check_hzroup_a21a8(CustomTreeNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.canUpdateManually();
    }
    return false;
  }
  private static boolean check_hzroup_a0a1a01(ITreeNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.isInvalid();
    }
    return false;
  }
  private static <T> T as_hzroup_a0a21a8(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_hzroup_a0a0a1a01(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
