package de.q60.mps.shadowmodels.runtime.typesystem;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import org.jetbrains.mps.openapi.model.SNode;
import org.modelix.model.mpsadapters.mps.NodeToSNodeAdapter;
import de.q60.mps.shadowmodels.runtime.engine.DependencyTrackingNode;
import org.modelix.model.mpsadapters.mps.SNodeToNodeAdapter;
import org.modelix.model.mpsadapters.mps.EModelMode;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.typesystem.inference.TypeCheckerHelper;
import jetbrains.mps.typechecking.TypecheckingFacade;
import jetbrains.mps.ide.MPSCoreComponents;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.newTypesystem.context.TargetTypecheckingContext;
import org.modelix.model.mpsadapters.mps.ANode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;

public class ShadowTypesystemUtil {
  private static final Logger LOG = Logger.getLogger(ShadowTypesystemUtil.class);
  public static SNode getType(final SNode node) {
    if (node instanceof NodeToSNodeAdapter) {
      DependencyTrackingNode.checkHasTracking(SNodeToNodeAdapter.wrap(node));
      ((NodeToSNodeAdapter) node).setModelMode(EModelMode.NULL);
    }
    final Wrappers._T<SNode> type = new Wrappers._T<SNode>();
    final TypeCheckerHelper th = TypecheckingFacade.getFromContext().getData(TypeCheckerHelper.class);
    MPSCoreComponents.getInstance().getPlatform().findComponent(MPSModuleRepository.class).getModelAccess().runReadAction(() -> type.value = new TargetTypecheckingContext(node, th).getTypeOf_generationMode(ANode.wrap(node)));
    if (type.value == null) {
      if (LOG.isDebugLevel()) {
        LOG.debug("Type is null for " + SNodeOperations.present(node), new Exception(""));
      }
    }
    return NodeToSNodeAdapter.wrap(DependencyTrackingNode.wrap(SNodeToNodeAdapter.wrap(ANode.unwrap(type.value))));
  }
}
