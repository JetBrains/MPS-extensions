package de.q60.mps.shadowmodels.runtime.engine;

/*Generated by MPS */

import org.modelix.model.api.IConcept;
import jetbrains.mps.internal.collections.runtime.Sequence;

public class RootBuilderContext extends BuilderContextBase implements IBuilderContext {
  protected final ContainmentTargetRootNodes<TransformationCall> call;
  protected final TransformationResult result;

  public RootBuilderContext(ContainmentTargetRootNodes<TransformationCall> call, TransformationResult result) {
    this.call = call;
    this.result = result;
  }

  @Override
  public TransformationResult getTransformationResult() {
    return result;
  }

  @Override
  public IBuilderContext createNode(IConcept concept, IBuilderContext topmost) {
    String role = topmost.getParameter(BuilderContextParameter.ROLE);
    String id = idWithPrefix(topmost);
    String localLabel = topmost.getParameter(BuilderContextParameter.LOCAL_LABEL);
    IScope scope = topmost.getParameter(BuilderContextParameter.SCOPE);
    TransformationResult.ResultElement resultElement = result.createNode(Integer.parseInt(role), id, concept, scope);
    IBuilderContext resultContext = new ResultElementContext(topmost, resultElement);
    if (localLabel != null) {
      resultElement.addLabel(localLabel);
      resultContext = resultContext.withLabel(null);
    }
    MappingLabelCall labelCall = topmost.getParameter(BuilderContextParameter.MAPPING_LABEL);
    if (labelCall != null) {
      getTransformationResult().mappingLabels().putEntry(labelCall, resultElement.getCanonicalReference());
      resultContext = resultContext.withParameter(BuilderContextParameter.MAPPING_LABEL, null);
    }
    return resultContext;
  }
  @Override
  public void createNode(IContainmentTarget call, IBuilderContext topmost) {
    IUniqueContainmentTarget<IContainmentTarget> registered = result.createNode(Integer.parseInt(topmost.getParameter(BuilderContextParameter.ROLE)), call, topmost.getParameter(BuilderContextParameter.SCOPE));

    MappingLabelCall labelCall = topmost.getParameter(BuilderContextParameter.MAPPING_LABEL);
    if (labelCall != null) {
      getTransformationResult().mappingLabels().putEntry(labelCall, new ContainmentTargetRootNodes((SubstepStageReference) result.getStageRef(), registered));
    }
  }

  @Override
  public Object getInput() {
    return getInput(0);
  }

  @Override
  public Object getInput(int index) {
    return Sequence.fromIterable(call.getContainmentTarget().getTarget().getParameters().asSequence()).skip(index).first();
  }

  @Override
  public ITransformationEngine getEngine() {
    return result.getEngine();
  }
  @Override
  public <T> T getParameter(BuilderContextParameter<T> parameter) {
    if (BuilderContextParameter.UNDERSCORE.equals(parameter)) {
      return (T) getInput(0);
    }
    if (BuilderContextParameter.SCOPE.equals(parameter)) {
      return (T) result.getScope();
    }
    return super.getParameter(parameter);
  }

  @Override
  public void addWeaving(IWeaving weaving) {
    result.addWeaving(weaving);
  }
}
