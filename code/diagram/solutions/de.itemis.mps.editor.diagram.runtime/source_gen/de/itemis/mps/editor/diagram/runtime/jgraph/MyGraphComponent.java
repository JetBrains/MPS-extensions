package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import com.mxgraph.swing.mxGraphComponent;
import java.awt.Dimension;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import de.itemis.mps.editor.diagram.runtime.model.IDiagramAccessor;
import javax.swing.JScrollPane;
import java.awt.event.MouseListener;
import java.awt.event.MouseEvent;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import com.mxgraph.swing.view.mxInteractiveCanvas;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import com.mxgraph.model.mxCell;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import de.itemis.mps.editor.diagram.runtime.model.Point;
import de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import com.mxgraph.swing.handler.mxConnectionHandler;
import com.intellij.openapi.actionSystem.AnAction;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.actionSystem.AnActionEvent;
import com.intellij.openapi.actionSystem.ActionUpdateThread;
import com.intellij.openapi.actionSystem.CustomShortcutSet;
import com.intellij.openapi.actionSystem.KeyboardShortcut;
import javax.swing.KeyStroke;
import java.awt.event.KeyEvent;
import java.awt.event.MouseAdapter;
import jetbrains.mps.openapi.editor.cells.EditorCell_Label;
import java.awt.geom.Rectangle2D;
import java.util.List;
import java.util.ArrayList;
import javax.swing.TransferHandler;
import com.mxgraph.swing.handler.mxGraphHandler;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.openapi.editor.style.StyleAttribute;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import com.mxgraph.swing.handler.mxCellHandler;
import com.mxgraph.view.mxCellState;
import com.mxgraph.view.mxEdgeStyle;
import java.awt.Rectangle;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import java.awt.Graphics;
import java.awt.Graphics2D;
import com.mxgraph.view.mxGraphView;
import com.mxgraph.util.mxPoint;
import com.mxgraph.swing.handler.mxMovePreview;
import java.awt.AWTEvent;
import javax.swing.SwingUtilities;
import de.itemis.mps.editor.diagram.runtime.plugin.MPSCellMouseListener;
import jetbrains.mps.nodeEditor.selection.EditorCellSelection;
import java.awt.event.MouseWheelEvent;
import com.mxgraph.model.mxICell;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import com.mxgraph.model.mxGeometry;
import com.mxgraph.model.mxIGraphModel;
import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;

public class MyGraphComponent extends mxGraphComponent implements ISupportButtonHiding {
  public static final String ALWAYS_SHOW_PORT_LABELS = "__always_show_port_labels";

  private static final String MAXIMIZED_KEY = MyGraphComponent.class.getName() + ".Maximized";
  public static final double DEFAULT_ARROW_KEY_MOVE_AMOUNT = 10.0;
  public static final double DEFAULT_ARROW_KEY_MOVE_AMOUNT_SLOW = 1.0;
  public static final double DEFAULT_PAN_AMOUNT = 20.0;
  public static final double DEFAULT_PAN_AMOUNT_SLOW = 2.0;
  public static final double DEFAULT_MINIMUM_SCALE = 0.83;
  private RootDiagramECell myDiagramCell;
  private Dimension myFixedSize;
  private boolean myWasMaximizedMode = false;

  private AlignEnum align = AlignEnum.RIGHT;
  protected Map<Integer, Boolean> buttonVisibility = MapSequence.fromMap(new HashMap<Integer, Boolean>());

  @Override
  public Map<Integer, Boolean> getButtonVisibilityMap() {
    return buttonVisibility;
  }

  public MyGraphComponent(MyGraph graph) {
    super(graph);
    IDiagramAccessor diagramAccessor = graph.getRootDiagramModel().getDiagramAccessor();
    graph.setGraphComponent(this);
    setFocusable(false);
    setToolTips(true);
    setDragEnabled(false);
    setOpaque(false);
    getViewport().setOpaque(false);
    setPreviewAlpha(0.5f);
    setGridVisible(diagramAccessor.showGrid());
    if (diagramAccessor.getGridColor() != null) {
      setGridColor(diagramAccessor.getGridColor());
    }
    setGridStyle(diagramAccessor.getGridStyle());
    new MyRubberband(this);
    GraphPanning.install(this);

    initActions();
    setCellEditor(new MyCellEditor(this));

    setHorizontalScrollBarPolicy(JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);
    setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_NEVER);

    getGraphControl().addMouseListener(new MouseListener() {
      public void mouseClicked(MouseEvent e) {
        for (MouseListener l : Sequence.fromIterable(new ExtensionPoint<MouseListener>("de.itemis.mps.editor.diagram.runtime.GlobalDiagramMouseListener").getObjects())) {
          l.mouseClicked(e);
        }
      }
      public void mousePressed(MouseEvent e) {
        for (MouseListener l : Sequence.fromIterable(new ExtensionPoint<MouseListener>("de.itemis.mps.editor.diagram.runtime.GlobalDiagramMouseListener").getObjects())) {
          l.mousePressed(e);
        }
      }
      public void mouseReleased(MouseEvent e) {
        for (MouseListener l : Sequence.fromIterable(new ExtensionPoint<MouseListener>("de.itemis.mps.editor.diagram.runtime.GlobalDiagramMouseListener").getObjects())) {
          l.mouseReleased(e);
        }
      }
      public void mouseEntered(MouseEvent e) {
        for (MouseListener l : Sequence.fromIterable(new ExtensionPoint<MouseListener>("de.itemis.mps.editor.diagram.runtime.GlobalDiagramMouseListener").getObjects())) {
          l.mouseEntered(e);
        }
      }
      public void mouseExited(MouseEvent e) {
        for (MouseListener l : Sequence.fromIterable(new ExtensionPoint<MouseListener>("de.itemis.mps.editor.diagram.runtime.GlobalDiagramMouseListener").getObjects())) {
          l.mouseExited(e);
        }
      }
    });
  }

  /**
   * 
   * @deprecated does nothing, will be removed
   */
  @Deprecated(forRemoval = true, since = "2020.3")
  public void cleanup() {
  }

  @Override
  public void setBounds(int x, int y, int w, int h) {
    super.setBounds(x, y, w, h);
    getGraph().getView().invalidate();
  }

  @Override
  public mxInteractiveCanvas createCanvas() {
    return new MyInteractiveCanvas();
  }

  public EditorCell findLeafAtCursor(MouseEvent event) {
    return findLeafAtPosition(event.getX(), event.getY());
  }
  public EditorCell findLeafAtPosition(int x, int y) {
    mxCell dcell = (mxCell) getCellAt(x, y);
    if (dcell instanceof IMPSCellContainer) {
      for (MPSCell mpsCell : ListSequence.fromList(((IMPSCellContainer) dcell).getMPSCells())) {
        if (mpsCell.getBoundsInDiagram().contains(x, y)) {
          EditorCell leaf = mpsCell.findLeaf(x, y);
          if (leaf != null) {
            return leaf;
          }
        }
      }
    }

    Tuples._2<Integer, Integer> convertedPos = convertPoint(x, y);
    return getEditorComponent().getRootCell().findLeaf((int) convertedPos._0(), (int) convertedPos._1());
  }

  public MouseEvent convertMouseEvent(MouseEvent sourceEvent) {
    Point p = new Point(sourceEvent.getX(), sourceEvent.getY());
    int x;
    int y;
    {
      Tuples._2<Integer, Integer> _tmp_lqcsnx_d0cb = convertPoint(ExtensionMethods.toInt(p.getX()), ExtensionMethods.toInt(p.getY()));
      x = _tmp_lqcsnx_d0cb._0();
      y = _tmp_lqcsnx_d0cb._1();
    }
    MouseEvent converted = new MouseEvent(getEditorComponent(), sourceEvent.getID(), sourceEvent.getWhen(), sourceEvent.getModifiers() | sourceEvent.getModifiersEx(), x, y, sourceEvent.getXOnScreen(), sourceEvent.getYOnScreen(), sourceEvent.getClickCount(), sourceEvent.isPopupTrigger(), sourceEvent.getButton());
    return converted;
  }

  public Tuples._2<Integer, Integer> convertPoint(int x, int y) {
    return MultiTuple.<Integer,Integer>from(getX() + x, getY() + y);
  }

  public void setMaximizedMode(boolean newValue) {
    if (newValue == isMaxmimizedMode()) {
      return;
    }
    if (getEditorComponent() == null) {
      return;
    }

    if (newValue) {
      MyGraphComponent current = as_lqcsnx_a0a0a3a23(getEditorComponent().getClientProperty(MAXIMIZED_KEY), MyGraphComponent.class);
      getEditorComponent().putClientProperty(MAXIMIZED_KEY, this);
      if (current != null) {
        current.updateMaximizedMode();
      }
    } else {
      getEditorComponent().putClientProperty(MAXIMIZED_KEY, null);
    }
    updateMaximizedMode();
  }

  protected void updateMaximizedMode() {
    boolean newValue = isMaxmimizedMode();
    boolean oldValue = myWasMaximizedMode;
    myWasMaximizedMode = newValue;
    if (oldValue != newValue) {
      getDiagramCell().maximizedModeChanged(isMaxmimizedMode());
    }
  }

  public boolean isMaxmimizedMode() {
    return check_lqcsnx_a0a0kb(getEditorComponent(), MAXIMIZED_KEY, this) == this;
  }

  public void scaleAndTranslate(double newScale, double newTranslateX, double newTranslateY) {
    getGraph().getView().scaleAndTranslate(newScale, newTranslateX, newTranslateY);
    getEditorComponent().relayout();
    getEditorComponent().repaint();
  }

  @Override
  public void zoomIn() {
    super.zoomIn();
    getGraph().updateViewOrigin();
    MyGraphView view = getGraph().getView();
    view.scaleAndTranslate(view.getScale(), view.getDefaultTranslation().getX(), view.getDefaultTranslation().getY());
    getEditorComponent().relayout();
    getEditorComponent().repaint();
  }
  @Override
  public void zoomOut() {
    MyGraphView view = getGraph().getView();
    if (view.getScale() <= getGraph().getRootDiagramModel().getDiagramAccessor().getMinimumScale()) {
      return;
    }
    super.zoomOut();
    getGraph().updateViewOrigin();
    view.scaleAndTranslate(view.getScale(), view.getDefaultTranslation().getX(), view.getDefaultTranslation().getY());
    getEditorComponent().relayout();
    getEditorComponent().repaint();
  }

  @Override
  protected mxConnectionHandler createConnectionHandler() {
    return new MyConnectionHandler(this);
  }

  public void showPortLabelsIfNecessary() {
    MyGraphControl control = ((MyGraphControl) getGraphControl());
    if (control.alwaysShowPortLabels()) {
      control.updatePortLabelOpacity(-10000, -10000);
    }
  }

  public void initActions() {
    AnAction deleteAction = new AnAction() {
      public void actionPerformed(@NotNull AnActionEvent event) {
        if (getEditorComponent().getSelectionManager().getSelection() instanceof GraphSelection) {
          getGraph().getModel().beginUpdate();
          try {
            getGraph().removeCells();
            getEditorComponent().getSelectionManager().setSelection(getDiagramCell());
          } finally {
            getGraph().getModel().endUpdate();
          }
        }
      }

      @NotNull
      @Override
      public ActionUpdateThread getActionUpdateThread() {
        return ActionUpdateThread.BGT;
      }

    };
    CustomShortcutSet shortcuts = new CustomShortcutSet(new KeyboardShortcut(KeyStroke.getKeyStroke(KeyEvent.VK_BACK_SPACE, 0), null), new KeyboardShortcut(KeyStroke.getKeyStroke(KeyEvent.VK_DELETE, 0), null));
    deleteAction.registerCustomShortcutSet(shortcuts, this);
  }

  public RootDiagramECell getDiagramCell() {
    return myDiagramCell;
  }

  public void setDiagramCell(RootDiagramECell cell) {
    myDiagramCell = cell;
  }

  @Override
  protected void installDoubleClickHandler() {
    graphControl.addMouseListener(new MouseAdapter() {
      public void mouseReleased(MouseEvent e) {
        if (isEnabled()) {
          if (!(e.isConsumed()) && isEditEvent(e)) {
            if (!(editGraphCell(e))) {
              MPSCell mpsCell = findMPSCell(e.getX(), e.getY());
              if (mpsCell != null) {
                editMPSCell(mpsCell, e);
              }
            }
          } else {
            stopEditing(!(invokesStopCellEditing));
          }
        }
      }

      public void editMPSCell(MPSCell mpsCell, MouseEvent e) {
        EditorCell leaf = mpsCell.findLeaf(e.getX(), e.getY());
        if (leaf != null) {
          if (leaf instanceof EditorCell_Label) {
            EditorCell_Label labelLeaf = ((EditorCell_Label) leaf);
            labelLeaf.setCaretX(ExtensionMethods.toInt((double) mpsCell.convertPosition(e.getX(), e.getY())._0()));
            leaf.getContext().getSelectionManager().setSelection(labelLeaf);
          } else {
            leaf.getContext().getSelectionManager().setSelection(leaf);
          }
        } else {
          startEdit(mpsCell);
        }
      }

      public boolean editGraphCell(MouseEvent e) {
        Object cell = getCellAt(e.getX(), e.getY(), false);
        if (cell != null && getGraph().isCellEditable(cell)) {
          startEditingAtCell(cell, e);
          return true;
        }
        return false;
      }
    });
  }

  public MPSCell findMPSCell(double x, double y) {
    MPSCell smallest = null;
    Rectangle2D smallestBounds = null;
    for (MPSCell m : ListSequence.fromList(getAllMPSCells())) {
      Rectangle2D bounds = m.getBoundsInDiagram();
      if (bounds.contains(x, y)) {
        if (smallestBounds == null || getArea(bounds) <= getArea(smallestBounds)) {
          smallest = m;
          smallestBounds = bounds;
        }
      }
    }
    return smallest;
  }

  public double getArea(Rectangle2D rect) {
    return rect.getWidth() * rect.getHeight();
  }

  public List<MPSCell> getAllMPSCells() {
    final List<MPSCell> result = ListSequence.fromList(new ArrayList<MPSCell>());
    JGraphUtil.visitAllCells(getGraph().getModel(), (mxCell cell) -> {
      if (cell instanceof IMPSCellContainer) {
        ListSequence.fromList(result).addSequence(ListSequence.fromList(((IMPSCellContainer) cell).getMPSCells()));
      }
    });
    return result;
  }

  public void startEdit(MPSCell editorCell) {
    ((MyCellEditor) getCellEditor()).startEditing(editorCell);
  }

  @Override
  public void setSize(int w, int h) {
    if ((getWidth() != w || getHeight() != h) && myDiagramCell != null) {
      myDiagramCell.requestRelayout();
    }
    super.setSize(w, h);
  }

  @Override
  protected mxGraphComponent.mxGraphControl createGraphControl() {
    return new MyGraphControl();
  }

  @Override
  protected TransferHandler createTransferHandler() {
    return new MyGraphTransferHandler(this);
  }

  @Override
  public MyGraph getGraph() {
    return (MyGraph) super.getGraph();
  }

  @Override
  public MyCellEditor getCellEditor() {
    return (MyCellEditor) super.getCellEditor();
  }

  @Override
  protected mxGraphHandler createGraphHandler() {
    return new MyGraphHandler(this);
  }

  public EditorComponent getEditorComponent() {
    if (myDiagramCell != null) {
      return myDiagramCell.getEditor();
    }
    return (EditorComponent) getParent();
  }

  public MyGraphComponent getGraphComponent() {
    return this;
  }

  public void setButtonLayout(final Style style, AlignEnum align, List<StyleAttribute> styleAttribute) {
    this.align = align;
    ListSequence.fromList(styleAttribute).visitAll(new _FunctionTypes._void_P1_E0<StyleAttribute>() {
      public void invoke(StyleAttribute it) {
        setButtonVisibilityFromStyle(style, it);
      }
    });
  }

  public List<StyleAttribute> getStyleButtonAttributes() {
    return Sequence.fromIterable(Sequence.fromArray(new StyleAttribute[]{StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram.styles", "__align-buttons"), StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram.styles", "__fit-size-button"), StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram.styles", "__reorder-ports-button"), StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram.styles", "__open-node-buttons"), StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram.styles", "__relayout-edges-button"), StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram.styles", "__show-all-edges-button"), StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram.styles", "__hide-all-edges-button"), StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram.styles", "__hide-edge-button"), StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram.styles", "__create-edge-button"), StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram.styles", "__sync-with-model-button")})).toList();
  }

  @Override
  public mxCellHandler createHandler(mxCellState state) {
    Object objectCell = state.getCell();
    if (graph.getModel().isEdge(objectCell)) {
      mxEdgeStyle.mxEdgeStyleFunction style = graph.getView().getEdgeStyle(state, null, null, null);
      boolean isDefaulEdgeStyle = style != null && style.getClass().getName().startsWith(mxEdgeStyle.class.getName());
      if (style == MyEdgeStyle.getInstance() || isDefaulEdgeStyle) {
        return new MyEdgeHandler(this, state, getButtonVisibilityMap(), isDefaulEdgeStyle);
      }
    } else if (graph.getModel().isVertex(objectCell)) {
      if (objectCell instanceof BoxDCell) {
        BoxDCell boxDCell = (BoxDCell) objectCell;
        if (boxDCell != null && boxDCell.getBox() != null && boxDCell.getBox().getStyle() != null) {
          Style style = boxDCell.getBox().getStyle();
          setButtonLayout(style, AlignEnum.valueOf(style.get(StyleAttributes.getInstance().<String>getAttribute("de.itemis.mps.editor.diagram.styles", "__align-enum"))), getStyleButtonAttributes());
        }
      }
      return new MyVertexHandler(this, state, align, getButtonVisibilityMap());
    }
    return super.createHandler(state);
  }

  @Override
  public Dimension getPreferredSize() {
    if (myFixedSize != null) {
      return myFixedSize;
    }

    Dimension preferredSize = super.getPreferredSize();
    preferredSize.width = Math.max(preferredSize.width, 300);
    preferredSize.height = Math.max(preferredSize.height, 200);
    Rectangle preview = ((Rectangle) ReflectionUtil.readField(mxGraphHandler.class, getGraphHandler(), "previewBounds"));
    if (preview != null) {
      preferredSize.width = Math.max(preferredSize.width, preview.x + preview.width);
      preferredSize.height = Math.max(preferredSize.height, preview.y + preview.height);
    }
    if (lastMovePosition != null) {
      preferredSize.width = Math.max(preferredSize.width, (int) lastMovePosition._0() + 70);
      preferredSize.height = Math.max(preferredSize.height, (int) lastMovePosition._1() + 70);
    }
    preferredSize.width += 12;
    preferredSize.height += 12;
    return preferredSize;
  }

  public void setFixedSize(Dimension size) {
    myFixedSize = size;
  }

  @Override
  public void selectCellForEvent(Object cell, MouseEvent event) {
    if (cell instanceof SubDiagramDCell) {
      cell = ((SubDiagramDCell) cell).getParent();
    }
    super.selectCellForEvent(cell, event);
  }

  private Tuples._2<Integer, Integer> lastMovePosition;
  public void autoextendOnMove(MouseEvent event) {
    if (getConnectionHandler().getConnectPreview().isActive()) {
      return;
    }

    lastMovePosition = MultiTuple.<Integer,Integer>from(event.getX(), event.getY());
    check_lqcsnx_a3a29(myDiagramCell.getParent());
    EditorComponent editorComponent = getEditorComponent();
    if ((int) lastMovePosition._0() < 0 || (int) lastMovePosition._1() < 0) {
      this.panView(-(Math.min((int) lastMovePosition._0() - 10, 0) + 0), -Math.min((int) lastMovePosition._1() - 10, 0));
    } else {
      editorComponent.relayout();
    }
  }

  private boolean forwardTransformedRepaint = false;
  @Override
  public void paint(Graphics graphics) {
    Graphics2D g2d = (Graphics2D) graphics;
    super.paint(graphics);

    if (forwardTransformedRepaint) {
      Rectangle clipBounds = graphics.getClipBounds();
      mxGraphView view = check_lqcsnx_a0b0d0rd(getGraph(), this);
      if (view != null && clipBounds != null) {
        Point xy = JGraphUtil.convertToView(view, new Point(clipBounds.getX(), clipBounds.getY()));
        forwardTransformedRepaint = false;
        super.repaint(JGraphUtil.toInt(xy.getX()) - 1, JGraphUtil.toInt(xy.getY()) - 1, JGraphUtil.toInt(clipBounds.getWidth() * view.getScale()) + 2, JGraphUtil.toInt(clipBounds.getHeight() * view.getScale()) + 2);
      }
    } else {
      forwardTransformedRepaint = true;
    }
  }

  public void panView(double deltaX, double deltaY) {
    mxGraphView view = getGraph().getView();
    view.setTranslate(new mxPoint(view.getTranslate().getX() + deltaX, view.getTranslate().getY() + deltaY));
    this.getGraph().updateViewOrigin();
    getEditorComponent().relayout();
    getEditorComponent().repaint();
  }

  @Override
  public Object[] importCells(Object[] cells, double dx, double dy, Object target, java.awt.Point location) {
    Object[] result = super.importCells(cells, dx, dy, target, location);

    // For some reason, the drag preview is still visible after the drop is processed
    mxMovePreview movePreview = getGraphHandler().getMovePreview();
    if (getGraphHandler().isVisible()) {
      getGraphHandler().reset();
    }

    return result;
  }

  public class MyGraphControl extends mxGraphComponent.mxGraphControl {
    private boolean portsLabelsAlwaysVisible = false;

    public boolean alwaysShowPortLabels() {
      String[] editorHintsForNode = getEditorComponent().getEditorHintsForNode((getGraph().getRootDiagramModel()).getSNode());
      boolean alwaysShowPortLabel = Sequence.fromIterable(Sequence.fromArray(editorHintsForNode)).any((it) -> it.endsWith(ALWAYS_SHOW_PORT_LABELS));
      return alwaysShowPortLabel;
    }

    public MyGraphControl() {
      enableEvents(AWTEvent.MOUSE_WHEEL_EVENT_MASK);
      setFocusable(false);

      MouseAdapter portLabelOpacityUpdater = new MouseAdapter() {
        @Override
        public void mouseExited(MouseEvent event) {
          updatePortLabelOpacity(-10000, -10000);
        }
        @Override
        public void mouseMoved(MouseEvent event) {
          updatePortLabelOpacity(event.getX(), event.getY());
        }

        @Override
        public void mouseDragged(MouseEvent event) {
          updatePortLabelOpacity(event.getX(), event.getY());
        }
      };
      addMouseListener(portLabelOpacityUpdater);
      addMouseMotionListener(portLabelOpacityUpdater);
    }

    @Override
    protected void processMouseEvent(MouseEvent event) {
      // focus
      if (event.getID() == MouseEvent.MOUSE_CLICKED) {
        getEditorComponent().requestFocusInWindow();
      }

      super.processMouseEvent(event);

      // right click
      if (event.getButton() == MouseEvent.BUTTON3) {
        getEditorComponent().dispatchEvent(SwingUtilities.convertMouseEvent(this, event, getEditorComponent()));
      }

      for (MPSCell mpsCell : ListSequence.fromList(getAllMPSCells())) {
        if (mpsCell.couldHandleMouseEvent(event)) {
          for (MPSCellMouseListener l : Sequence.fromIterable(new ExtensionPoint<MPSCellMouseListener>("de.itemis.mps.editor.diagram.runtime.GlobalDiagramMPSCellClickListener").getObjects())) {
            switch (event.getID()) {
              case MouseEvent.MOUSE_CLICKED:
                l.mouseClicked(mpsCell, event);
            }
          }

        }
        boolean handled = mpsCell.handleMouseEvent(event);
        if (handled) {
          return;
        }
      }

      if (!(event.isConsumed()) && event.getButton() == MouseEvent.BUTTON1 && event.getID() == MouseEvent.MOUSE_CLICKED) {
        if (!(event.isMetaDown()) && !(event.isControlDown()) && !(event.isAltDown()) && !(event.isAltGraphDown()) && !(event.isShiftDown())) {
          Object cellAt = getCellAt(event.getX(), event.getY());
          if (cellAt == null) {
            getEditorComponent().getSelectionManager().setSelection(new EditorCellSelection(getDiagramCell()));
            event.consume();
          }
        }
      }
    }


    @Override
    protected void processMouseMotionEvent(MouseEvent event) {
      super.processMouseMotionEvent(event);
      if (getEditorComponent() != null) {
        if (event.getID() != MouseEvent.MOUSE_DRAGGED) {
          getEditorComponent().dispatchEvent(convertMouseEvent(event));
        }
      }
    }

    @Override
    protected void processMouseWheelEvent(MouseWheelEvent event) {
      if (event.isAltDown() || isMaxmimizedMode()) {
        int amount = -event.getUnitsToScroll();
        double scaleFactor = Math.pow(1.015, amount);
        changeZoom(event.getX(), event.getY(), scaleFactor);
      } else {
        getEditorComponent().dispatchEvent(SwingUtilities.convertMouseEvent(getGraphComponent(), event, getEditorComponent()));
      }
    }

    public void changeZoom(double x, double y, double scaleFactor) {
      mxGraphView view = getGraph().getView();
      double oldScale = view.getScale();
      double newScale = oldScale * scaleFactor;
      if (newScale < 0.01 && newScale < oldScale) {
        return;
      }
      if (newScale > 1000.0 && newScale > oldScale) {
        return;
      }

      double oldTranslateX = view.getTranslate().getX();
      double oldTranslateY = view.getTranslate().getY();

      double mouseX = x / oldScale - oldTranslateX;
      double mouseY = y / oldScale - oldTranslateY;

      double newTranslateX = x / newScale - mouseX;
      double newTranslateY = y / newScale - mouseY;

      scaleAndTranslate(newScale, newTranslateX, newTranslateY);
    }

    public void togglePortsLabelsAlwaysVisible() {
      portsLabelsAlwaysVisible = !(portsLabelsAlwaysVisible);
    }

    public void updatePortLabelOpacity(double cursorX, double cursorY) {

      mxICell cellAtCursor = (mxCell) getCellAt(ExtensionMethods.toInt(cursorX), ExtensionMethods.toInt(cursorY));
      if (cellAtCursor instanceof PortDCell) {
        cellAtCursor = cellAtCursor.getParent();
      }
      if (cellAtCursor instanceof SubDiagramDCell) {
        cellAtCursor = cellAtCursor.getParent();
      }
      Set<PortDCell> portAtCursor = SetSequence.fromSetWithValues(new HashSet<PortDCell>(), getPortCells(cellAtCursor, true));
      boolean anyChanged = false;
      boolean alwaysShowPortLabel = alwaysShowPortLabels();
      for (PortDCell portCell : ListSequence.fromList(getPortCells(getGraph().getModel().getRoot(), false))) {
        double opacity;
        if (portsLabelsAlwaysVisible || alwaysShowPortLabel) {
          opacity = 0.7;
        } else {
          opacity = (SetSequence.fromSet(portAtCursor).contains(portCell) ? 1.0 : 0.0);
        }
        anyChanged |= portCell.setLabelOpacity(opacity);
      }
      if (anyChanged) {
        repaint();
      }
    }

    public List<PortDCell> getPortCells(Object parent, boolean firstLevelOnly) {
      List<PortDCell> result = ListSequence.fromList(new ArrayList<PortDCell>());
      collectPortCells(parent, result, firstLevelOnly);
      return result;
    }

    public void collectPortCells(Object parent, List<PortDCell> accumulator, boolean firstLevelOnly) {
      if (parent instanceof PortDCell) {
        accumulator.add((PortDCell) parent);
      }
      for (Object child : getGraph().getChildCells(parent)) {
        if (firstLevelOnly && child instanceof BoxDCell) {
          continue;
        }
        collectPortCells(child, accumulator, firstLevelOnly);
      }
    }

    public Rectangle2D getAbsolutePortBounds(PortDCell cell) {
      mxGeometry parentGeo = cell.getParent().getGeometry();
      mxGeometry portGeo = cell.getGeometry();
      return new Rectangle2D.Double(parentGeo.getX() + portGeo.getX() * parentGeo.getWidth() + check_lqcsnx_a0a0c0x101(portGeo.getOffset()), parentGeo.getY() + portGeo.getY() * parentGeo.getHeight() + check_lqcsnx_a1a0c0x101(portGeo.getOffset()), portGeo.getWidth(), portGeo.getHeight());
    }

    @Override
    protected void drawFromRootCell() {
      super.drawFromRootCell();
      drawTop(getGraph().getModel().getRoot());
    }

    public void drawTop(final Object parentCell) {
      if (parentCell instanceof ISelfPaintingCell) {
        final mxCellState state = getGraph().getView().getState(parentCell);
        DrawUtil.executeWithGraphicsCopy(canvas.getGraphics(), canvas, (Graphics2D g) -> ((ISelfPaintingCell) parentCell).paintTop(g, canvas, state));
      }
      mxIGraphModel model = getGraph().getModel();
      for (int i = model.getChildCount(parentCell) - 1; i >= 0; i--) {
        drawTop(model.getChildAt(parentCell, i));
      }
    }
  }
  private static Object check_lqcsnx_a0a0kb(EditorComponent checkedDotOperand, String MAXIMIZED_KEY, MyGraphComponent checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getClientProperty(MAXIMIZED_KEY);
    }
    return null;
  }
  private static void check_lqcsnx_a3a29(EditorCell_Collection checkedDotOperand) {
    if (null != checkedDotOperand) {
      checkedDotOperand.requestRelayout();
    }

  }
  private static MyGraphView check_lqcsnx_a0b0d0rd(MyGraph checkedDotOperand, MyGraphComponent checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getView();
    }
    return null;
  }
  private static double check_lqcsnx_a0a0c0x101(mxPoint checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getX();
    }
    return 0;
  }
  private static double check_lqcsnx_a1a0c0x101(mxPoint checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getY();
    }
    return 0;
  }
  private static <T> T as_lqcsnx_a0a0a3a23(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
