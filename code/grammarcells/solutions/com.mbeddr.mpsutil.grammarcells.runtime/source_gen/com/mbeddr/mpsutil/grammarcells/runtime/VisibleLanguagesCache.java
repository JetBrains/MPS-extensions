package com.mbeddr.mpsutil.grammarcells.runtime;

/*Generated by MPS */

import jetbrains.mps.smodel.event.SModelListener;
import jetbrains.mps.smodel.event.SModelLanguageEvent;
import jetbrains.mps.smodel.event.SModelImportEvent;
import jetbrains.mps.smodel.event.SModelDevKitEvent;
import jetbrains.mps.smodel.event.SModelRootEvent;
import jetbrains.mps.smodel.event.SModelRenamedEvent;
import jetbrains.mps.smodel.event.SModelPropertyEvent;
import jetbrains.mps.smodel.event.SModelChildEvent;
import jetbrains.mps.smodel.event.SModelReferenceEvent;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.loading.ModelLoadingState;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.module.SModuleListener;
import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.model.SModelReference;
import org.jetbrains.mps.openapi.module.SDependency;
import org.jetbrains.mps.openapi.language.SLanguage;
import org.jetbrains.mps.openapi.module.SRepositoryListener;
import org.jetbrains.mps.openapi.module.SModuleReference;
import org.jetbrains.mps.openapi.module.SRepository;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.smodel.SModelInternal;
import jetbrains.mps.smodel.SLanguageHierarchy;
import jetbrains.mps.smodel.SModelOperations;

public class VisibleLanguagesCache {

  private static VisibleLanguagesCache ourInstance = new VisibleLanguagesCache();

  public static VisibleLanguagesCache getInstance() {
    return ourInstance;
  }

  protected SModelListener myModelListener = new SModelListener() {
    public void languageAdded(SModelLanguageEvent p0) {
      invalidate();
    }
    public void languageRemoved(SModelLanguageEvent p0) {
      invalidate();
    }
    public void importAdded(SModelImportEvent p0) {
      invalidate();
    }
    public void importRemoved(SModelImportEvent p0) {
      invalidate();
    }
    public void devkitAdded(SModelDevKitEvent p0) {
      invalidate();
    }
    public void devkitRemoved(SModelDevKitEvent p0) {
      invalidate();
    }
    @Deprecated
    public void rootAdded(SModelRootEvent p0) {
    }
    @Deprecated
    public void rootRemoved(SModelRootEvent p0) {
    }
    public void beforeRootRemoved(SModelRootEvent p0) {
    }
    public void beforeModelRenamed(SModelRenamedEvent p0) {
    }
    public void modelRenamed(SModelRenamedEvent p0) {
      invalidate();
    }
    public void propertyChanged(SModelPropertyEvent p0) {
    }
    public void childAdded(SModelChildEvent p0) {
    }
    public void childRemoved(SModelChildEvent p0) {
    }
    public void beforeChildRemoved(SModelChildEvent p0) {
    }
    public void referenceAdded(SModelReferenceEvent p0) {
    }
    public void referenceRemoved(SModelReferenceEvent p0) {
    }
    public void modelSaved(SModel p0) {
    }
    public void modelLoadingStateChanged(SModel p0, ModelLoadingState p1) {
    }
    public void beforeModelDisposed(SModel p0) {
      invalidate();
    }
    @NotNull
    public SModelListener.SModelListenerPriority getPriority() {
      return SModelListener.SModelListenerPriority.CLIENT;
    }
  };

  protected SModuleListener myModuleListener = new SModuleListener() {
    public void modelAdded(SModule p0, SModel p1) {
    }
    public void beforeModelRemoved(SModule p0, SModel p1) {
    }
    public void modelRemoved(SModule p0, SModelReference p1) {
    }
    public void beforeModelRenamed(SModule p0, SModel p1, SModelReference p2) {
    }
    public void modelRenamed(SModule p0, SModel p1, SModelReference p2) {
    }
    public void dependencyAdded(SModule p0, SDependency p1) {
      invalidate();
    }
    public void dependencyRemoved(SModule p0, SDependency p1) {
      invalidate();
    }
    public void languageAdded(SModule p0, SLanguage p1) {
      invalidate();
    }
    public void languageRemoved(SModule p0, SLanguage p1) {
      invalidate();
    }
    public void moduleChanged(SModule p0) {
    }
  };

  protected SRepositoryListener myRepoListener = new SRepositoryListener() {
    public void moduleAdded(@NotNull SModule p0) {
      invalidate();
    }
    public void beforeModuleRemoved(@NotNull SModule p0) {
      invalidate();
    }
    public void moduleRemoved(@NotNull SModuleReference p0) {
      invalidate();
    }
    @Deprecated
    public void commandStarted(SRepository p0) {
    }
    @Deprecated
    public void commandFinished(SRepository p0) {
    }
    @Deprecated
    public void updateStarted(SRepository p0) {
    }
    @Deprecated
    public void updateFinished(SRepository p0) {
    }
    @Deprecated
    public void repositoryCommandStarted(SRepository p0) {
    }
    @Deprecated
    public void repositoryCommandFinished(SRepository p0) {
    }
  };

  private Set<SRepository> myActiveRepos = SetSequence.fromSet(new HashSet<SRepository>());
  private Set<SModule> myActiveModules = SetSequence.fromSet(new HashSet<SModule>());
  private Set<SModel> myActiveModels = SetSequence.fromSet(new HashSet<SModel>());
  private Map<SModel, Set<SLanguage>> myCache = MapSequence.fromMap(new HashMap<SModel, Set<SLanguage>>());
  private Map<SModel, SModuleReference[]> myReferencesCache = MapSequence.fromMap(new HashMap<SModel, SModuleReference[]>());

  public void init() {
  }

  public void dispose() {
    invalidate();
  }

  protected void listenTo(SModel model) {
    ((SModelInternal) model).addModelListener(myModelListener);
  }

  protected void listenTo(SModule module) {
    module.addModuleListener(myModuleListener);
    listenTo(module.getRepository());
  }

  protected void listenTo(SRepository repo) {
    repo.addRepositoryListener(myRepoListener);
  }

  public Set<SLanguage> getVisibleLanguages(SModel model) {
    Set<SLanguage> result = MapSequence.fromMap(myCache).get(model);
    if (result == null) {
      result = calcVisibleLanguages(model);
      MapSequence.fromMap(myCache).put(model, result);
    }
    return result;
  }

  public SModuleReference[] getVisibleLanguageReferences(SModel model) {
    SModuleReference[] result = MapSequence.fromMap(myReferencesCache).get(model);
    if (result == null) {
      result = SetSequence.fromSet(getVisibleLanguages(model)).select((it) -> it.getSourceModule().getModuleReference()).toGenericArray(SModuleReference.class);
      MapSequence.fromMap(myReferencesCache).put(model, result);
    }
    return result;
  }

  public void invalidate() {
    SetSequence.fromSet(myActiveModels).visitAll((it) -> ((SModelInternal) it).removeModelListener(myModelListener));
    SetSequence.fromSet(myActiveModules).visitAll((it) -> it.removeModuleListener(myModuleListener));
    SetSequence.fromSet(myActiveRepos).visitAll((it) -> it.removeRepositoryListener(myRepoListener));
    SetSequence.fromSet(myActiveModels).clear();
    SetSequence.fromSet(myActiveModules).clear();
    SetSequence.fromSet(myActiveRepos).clear();

    MapSequence.fromMap(myCache).clear();
    MapSequence.fromMap(myReferencesCache).clear();
  }

  protected Set<SLanguage> calcVisibleLanguages(SModel contextModel) {
    return SetSequence.fromSetWithValues(new HashSet<SLanguage>(), new SLanguageHierarchy(SModelOperations.getAllLanguageImports(contextModel)).getExtended());
  }

}
