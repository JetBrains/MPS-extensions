package de.itemis.mps.comparator.code;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SRepository;
import de.itemis.mps.compare.behavior.IDiffable__BehaviorDescriptor;
import jetbrains.mps.project.Project;
import jetbrains.mps.project.ProjectManager;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.vcs.diff.ui.StructDifferenceDialog;
import jetbrains.mps.ide.project.ProjectHelper;
import com.intellij.openapi.application.ApplicationManager;
import org.jetbrains.annotations.Nullable;
import javax.swing.JComponent;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import javax.swing.JButton;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import org.jetbrains.annotations.NotNull;
import javax.swing.Action;
import jetbrains.mps.smodel.tempmodel.TemporaryModels;
import jetbrains.mps.smodel.tempmodel.TempModuleOptions;
import jetbrains.mps.extapi.module.TransientSModule;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class DiffView {

  public static void showNonEditibleDiff(final SNode expected, final SNode actual, MPSNodeComparisonResult result, SNode input, final SRepository repo) {
    if ((boolean) IDiffable__BehaviorDescriptor.isDiffEnabled_id6Od11GY7tN$.invoke(input) && (expected != null) && (actual != null)) {
      Project project = ProjectManager.getInstance().getOpenedProjects().get(0);
      String leftCaption = "expected output (in root \"" + expected.toString() + "\" in model " + SModelOperations.getModelName(SNodeOperations.getModel(expected)) + ")";
      String rightCaption = "actual output (in root \"" + actual.toString() + "\" in generated model)";

      final Wrappers._T<SNode> expectedCleaned = new Wrappers._T<SNode>();
      final Wrappers._T<SNode> actualCleaned = new Wrappers._T<SNode>();

      repo.getModelAccess().runReadAction(() -> {
        expectedCleaned.value = cloneNode(expected);
        actualCleaned.value = cloneNode(actual);
      });

      final SModel expectedModel = SNodeOperations.getModel(expectedCleaned.value);
      final SModel actualModel = SNodeOperations.getModel(actualCleaned.value);

      final StructDifferenceDialog dialog = new StructDifferenceDialog(ProjectHelper.toIdeaProject(project), expectedCleaned.value, actualCleaned.value, leftCaption, rightCaption) {
        @Override
        protected void dispose() {
          super.dispose();
          disposeTmpModel(expectedModel, repo);
          disposeTmpModel(actualModel, repo);
        }
      };
      dialog.setModal(false);
      ApplicationManager.getApplication().invokeLater(() -> dialog.show());
    }
  }
  public static void showDiffDialog(final SNode expected, final SNode actual, MPSNodeComparisonResult result, SNode input, final SRepository repo) {

    if ((boolean) IDiffable__BehaviorDescriptor.isDiffEnabled_id6Od11GY7tN$.invoke(input) && (expected != null) && (actual != null)) {
      Project project = ProjectManager.getInstance().getOpenedProjects().get(0);
      String leftCaption = "expected output (in root \"" + expected.toString() + "\" in model " + SModelOperations.getModelName(SNodeOperations.getModel(expected)) + ")";
      String rightCaption = "actual output (in root \"" + actual.toString() + "\" in generated model)";

      final Wrappers._T<SNode> expectedCleaned = new Wrappers._T<SNode>();
      final Wrappers._T<SNode> actualCleaned = new Wrappers._T<SNode>();

      repo.getModelAccess().runReadAction(() -> {
        expectedCleaned.value = cloneNode(expected);
        actualCleaned.value = cloneNode(actual);
      });

      final SModel expectedModel = SNodeOperations.getModel(expectedCleaned.value);
      final SModel actualModel = SNodeOperations.getModel(actualCleaned.value);

      final StructDifferenceDialog dialog = new StructDifferenceDialog(ProjectHelper.toIdeaProject(project), expectedCleaned.value, actualCleaned.value, leftCaption, rightCaption) {

        @Nullable
        @Override
        protected JComponent createSouthPanel() {
          return createButtonsPanel(ListSequence.fromListAndArray(new ArrayList<JButton>(), createJButtonForAction(getOKAction())));
        }
        @Override
        protected void doOKAction() {
          repo.getModelAccess().executeCommand(() -> {
            SNode originalLabel = SNodeOperations.deleteNode(new IAttributeDescriptor.NodeAttribute(CONCEPTS.TestNodeAnnotation$27).get(expected));
            SNode newOne = SNodeOperations.replaceWithAnother(expected, SNodeOperations.copyNode(expectedCleaned.value));
            new IAttributeDescriptor.NodeAttribute(CONCEPTS.TestNodeAnnotation$27).set(newOne, originalLabel);
          });
          super.doOKAction();
        }
        @NotNull
        @Override
        protected Action[] createActions() {
          return new Action[]{getOKAction()};
        }

        @Override
        protected void dispose() {
          super.dispose();
          disposeTmpModel(expectedModel, repo);
          disposeTmpModel(actualModel, repo);
        }
      };
      dialog.setOKActionEnabled(true);
      dialog.setModal(false);

      ApplicationManager.getApplication().invokeLater(() -> dialog.show());
    }
  }

  /**
   * Any testlabel will be detached
   * 
   * @param expected node in assert
   * @return Clone of expected model placed in temp. model
   */
  @Nullable
  public static SNode cloneNode(SNode expected) {
    SNode copy = SNodeOperations.copyNode(expected);

    if ((new IAttributeDescriptor.NodeAttribute(CONCEPTS.TestNodeAnnotation$27).get(expected) != null)) {
      // remove test label from diff view
      SNodeOperations.deleteNode(new IAttributeDescriptor.NodeAttribute(CONCEPTS.TestNodeAnnotation$27).get(copy));
    }
    addToTempModel(copy);
    return copy;
  }

  /**
   * 
   * 
   * @param node nodes in assert
   */
  @Nullable
  private static SModel addToTempModel(SNode node) {
    // in memory ast
    if (node.getModel() == null) {
      SModel tmp = TemporaryModels.getInstance().createEditable(true, TempModuleOptions.forDefaultModule());
      SModelOperations.addRootNode(tmp, node);
      return tmp;
    }
    // in generator output
    if (node.getModel().getModule() instanceof TransientSModule) {
      SModel tmp = TemporaryModels.getInstance().createEditable(true, TempModuleOptions.forDefaultModule());
      SModelOperations.addRootNode(tmp, node);
      return tmp;
    }
    return null;
  }
  /**
   * requires read access
   * 
   * @param tmpModel temporal model in memory
   */
  private static void disposeTmpModel(final SModel tmpModel, SRepository repo) {
    if (tmpModel != null && TemporaryModels.isTemporary(tmpModel)) {
      repo.getModelAccess().runWriteAction(() -> TemporaryModels.getInstance().dispose(tmpModel));
    }
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept TestNodeAnnotation$27 = MetaAdapterFactory.getConcept(0x8585453e6bfb4d80L, 0x98deb16074f1d86cL, 0x119e1c6609cL, "jetbrains.mps.lang.test.structure.TestNodeAnnotation");
  }
}
