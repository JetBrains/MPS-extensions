package de.itemis.mps.editor.celllayout.layout;

/*Generated by MPS */

import org.jetbrains.annotations.NotNull;
import de.itemis.mps.editor.celllayout.boxmodel.Size;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;

public class GridLayout extends AbstractGridLayout implements ILayouter {

  public GridLayout() {
    super(true, false);
  }

  @Override
  public void layout(ILayoutableContainer container, @NotNull Size sizeConstraint) {
    super.layout(container, sizeConstraint);

    layoutIntermediateCollections(container);
  }

  @Override
  protected Grid loadGrid(ILayoutableContainer container) {
    DynamicGrid<ILayoutable> dynamicGrid = loadSubgrid(container);
    Grid grid = createGrid(dynamicGrid.getSizeX(), dynamicGrid.getSizeY());
    for (int x = 0; x < dynamicGrid.getSizeX(); x++) {
      for (int y = 0; y < dynamicGrid.getSizeY(); y++) {
        ILayoutable layoutable = dynamicGrid.getElement(x, y);
        if (layoutable == null) {
          continue;
        }
        GridElement gridElement = grid.getElement(x, y);
        gridElement.setLayoutable(layoutable);
        gridElement.setColumnSpan(Math.max(1, getColumnSpan(layoutable)));
        gridElement.setRowSpan(Math.max(1, getRowSpan(layoutable)));
      }
    }
    autoAdjustSpan(grid);
    return grid;
  }

  protected void autoAdjustSpan(Grid grid) {
    for (int x = 0; x < grid.getSizeX(); x++) {
      for (int y = 0; y < grid.getSizeY(); y++) {
        GridElement gridElement = grid.getElement(x, y);
        if (gridElement.getLayoutable() == null) {
          continue;
        }
        if (getColumnSpan(gridElement.getLayoutable()) < 0) {
          int span = 1;
          while (x + span < grid.getSizeX() && grid.getElement(x + span, y).getLayoutable() == null) {
            span++;
          }
          gridElement.setColumnSpan(span);
        }
        if (getRowSpan(gridElement.getLayoutable()) < 0) {
          int span = 1;
          while (y + span < grid.getSizeY() && grid.getElement(x, y + span).getLayoutable() == null) {
            span++;
          }
          gridElement.setRowSpan(span);
        }
      }
    }
  }

  protected DynamicGrid<ILayoutable> loadSubgrid(ILayoutableContainer container) {
    DynamicGrid<ILayoutable> result = new DynamicGrid<ILayoutable>();
    for (ILayoutable child : ListSequence.fromList(container.getChildren())) {
      if (isIntermediate(child)) {
        if (isVertical(container)) {
          result.setElements(0, result.getSizeY(), loadSubgrid(((ILayoutableContainer) child)));
        } else {
          result.setElements(result.getSizeX(), 0, loadSubgrid(((ILayoutableContainer) child)));
        }
      } else {
        int x;
        int y;
        if (isVertical(container)) {
          x = 0;
          y = result.getSizeY();
          result.setElement(x, y, child);
        } else {
          x = result.getSizeX();
          y = 0;
        }
        result.setElement(x, y, child);
        int requiredAdditionalSpaceX = Math.max(1, getColumnSpan(child)) - 1;
        int existingAdditionalSpaceX = result.getSizeX() - x - 1;
        int requiredAdditionalSpaceY = Math.max(1, getRowSpan(child)) - 1;
        int existingAdditionalSpaceY = result.getSizeY() - y - 1;
        for (int i = requiredAdditionalSpaceX - existingAdditionalSpaceX; i > 0; i--) {
          result.setElement(x + i, y, null);
        }
        for (int i = requiredAdditionalSpaceY - existingAdditionalSpaceY; i > 0; i--) {
          result.setElement(x, y + i, null);
        }
      }
    }
    return result;
  }

  protected int getColumnSpan(ILayoutable layoutable) {
    return layoutable.getColumnSpan();
  }

  protected int getRowSpan(ILayoutable layoutable) {
    return layoutable.getRowSpan();
  }

  protected boolean isIntermediate(ILayoutable layoutable) {
    if (isHorizontal(layoutable) && check_kg35zs_a0a0a51(layoutable.getParent()) instanceof GridLayout) {
      return true;
    }
    return (isVertical(layoutable) || isHorizontal(layoutable)) && ((ILayoutableContainer) layoutable).isFlattenInGrid();
  }

  protected boolean isVertical(ILayoutable layoutable) {
    ILayouter layouter = check_kg35zs_a0a0r(as_kg35zs_a0a0a0r(layoutable, ILayoutableContainer.class));
    return layouter instanceof VerticalLayout || layouter instanceof GridLayout;
  }

  protected boolean isHorizontal(ILayoutable layoutable) {
    return check_kg35zs_a0a0t(as_kg35zs_a0a0a0t(layoutable, ILayoutableContainer.class)) instanceof HorizontalLayout;
  }

  public void layoutIntermediateCollections(ILayoutableContainer gridRoot) {
    for (ILayoutableContainer intermediateCollection : ListSequence.fromList(gridRoot.getChildren()).ofType(ILayoutableContainer.class)) {
      layoutIntermediateCollection(intermediateCollection);
    }
  }

  protected void layoutIntermediateCollection(ILayoutableContainer intermediateCollection) {
    if (ListSequence.fromList(intermediateCollection.getChildren()).isEmpty()) {
      intermediateCollection.setBounds(intermediateCollection.getParent().getInnerX(), intermediateCollection.getParent().getInnerY(), 0, 0);
    } else {
      List<ILayoutableContainer> emptyIntermediates = ListSequence.fromList(new ArrayList<ILayoutableContainer>());
      for (ILayoutableContainer flattened : ListSequence.fromList(intermediateCollection.getChildren()).ofType(ILayoutableContainer.class).where((it) -> isIntermediate(it))) {
        if (ListSequence.fromList(flattened.getChildren()).isEmpty()) {
          ListSequence.fromList(emptyIntermediates).addElement(flattened);
        } else {
          layoutIntermediateCollection(flattened);
        }
      }
      LayoutableContainerExtensions.adjustToChildren(intermediateCollection, ListSequence.fromList(intermediateCollection.getChildren()).subtract(ListSequence.fromList(emptyIntermediates).ofType(ILayoutable.class)));
      for (ILayoutableContainer empty : ListSequence.fromList(emptyIntermediates)) {
        layoutIntermediateCollection(empty);
      }
    }
  }

  @Override
  protected Iterable<ILayoutable> getChildrenToMove(ILayoutableContainer container) {
    return Sequence.fromIterable(loadGrid(container).getValidElements()).select((it) -> it.getLayoutable());
  }

  @Override
  public void moveChildren(ILayoutableContainer container, int deltaX, int deltaY) {
    super.moveChildren(container, deltaX, deltaY);
    layoutIntermediateCollections(container);
  }
  private static ILayouter check_kg35zs_a0a0a51(ILayoutableContainer checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLayouter();
    }
    return null;
  }
  private static ILayouter check_kg35zs_a0a0r(ILayoutableContainer checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLayouter();
    }
    return null;
  }
  private static ILayouter check_kg35zs_a0a0t(ILayoutableContainer checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLayouter();
    }
    return null;
  }
  private static <T> T as_kg35zs_a0a0a0r(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_kg35zs_a0a0a0t(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
