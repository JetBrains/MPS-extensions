package de.q60.mps.polymorphicfunctions.runtime;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import jetbrains.mps.classloading.DeployListener;
import java.util.List;
import java.util.Set;
import jetbrains.mps.classloading.ModuleClassLoader;
import de.q60.mps.util.invalidation.Invalidatable;
import jetbrains.mps.ide.MPSCoreComponents;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.module.ReloadableModule;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.classloading.ClassLoaderManager;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.ListSequence;

public abstract class ImplementationsFromGlobalRepository extends ImplementationsFromRepository {
  private static final Logger LOG = Logger.getLogger(ImplementationsFromGlobalRepository.class);

  private DeployListener deployListener = null;
  private List<PFModule> pfModules;
  private Set<ModuleClassLoader> classLoaders;
  private Invalidatable invalidatable = new Invalidatable("Polymorphic functions descriptor cache (" + this.getClass().getName() + ")", () -> invalidate());

  public ImplementationsFromGlobalRepository() {
    super(MPSCoreComponents.getInstance().getPlatform().findComponent(MPSModuleRepository.class));
  }

  @Override
  public synchronized Iterable<PFModule> getPFModules() {
    if (deployListener == null) {
      deployListener = new DeployListener() {
        public void onUnloaded(Set<ReloadableModule> modules, @NotNull ProgressMonitor p1) {
          invalidate();
        }
        public void onLoaded(Set<ReloadableModule> modules, @NotNull ProgressMonitor p1) {
          invalidate();
        }
      };
      ClassLoaderManager classLoaderManager = ApplicationManager.getApplication().getComponent(MPSCoreComponents.class).getClassLoaderManager();
      classLoaderManager.addListener(deployListener);
    }

    if (classLoaders != null) {
      if (SetSequence.fromSet(classLoaders).any((it) -> it.isDisposed())) {
        classLoaders = null;
        pfModules = null;
      }
    }

    if (pfModules == null) {
      MPSCoreComponents.getInstance().getPlatform().findComponent(MPSModuleRepository.class).getModelAccess().runReadAction(() -> {
        pfModules = Sequence.fromIterable(super_getPFModules()).toList();
        classLoaders = SetSequence.fromSetWithValues(new HashSet<ModuleClassLoader>(), ListSequence.fromList(pfModules).select((it) -> it.getClass().getClassLoader()).ofType(ModuleClassLoader.class));
      });
    }
    return pfModules;
  }

  private Iterable<PFModule> super_getPFModules() {
    return super.getPFModules();
  }

  public void invalidate() {
    if (LOG.isDebugLevel()) {
      LOG.debug("Invalidate Transformation Descriptors Cache");
    }
    pfModules = null;
  }

  public void dispose() {
    if (deployListener != null) {
      ClassLoaderManager classLoaderManager = ApplicationManager.getApplication().getComponent(MPSCoreComponents.class).getClassLoaderManager();
      classLoaderManager.removeListener(deployListener);
    }
    invalidatable.dispose();
  }
}
