package de.itemis.mps.comparator.code;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.util.Map;
import java.io.File;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import com.intellij.openapi.vfs.VirtualFile;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.vfs.ex.dummy.DummyFileSystem;
import java.nio.charset.StandardCharsets;
import java.nio.charset.Charset;
import java.io.IOException;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.ArrayList;
import java.util.Collections;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.project.Project;
import org.jetbrains.annotations.Nullable;
import java.util.Comparator;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.function.Predicate;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.ide.project.ProjectHelper;
import com.intellij.diff.requests.DiffRequest;
import java.util.stream.Stream;
import java.nio.file.Files;
import com.intellij.diff.chains.SimpleDiffRequestChain;
import com.intellij.diff.DiffManager;
import com.intellij.diff.DiffDialogHints;
import java.io.StringWriter;
import jetbrains.mps.util.MacrosFactory;
import com.intellij.openapi.vfs.LocalFileSystem;
import com.intellij.openapi.vfs.VirtualFileManager;
import java.io.FileNotFoundException;
import jetbrains.mps.internal.collections.runtime.IMapping;
import jetbrains.mps.text.TextUnit;
import java.util.Collection;
import jetbrains.mps.text.rt.TextGenAspectDescriptor;
import jetbrains.mps.text.impl.TextGenRegistry;
import jetbrains.mps.text.impl.ModelOutline;
import jetbrains.mps.text.rt.TextGenAspectBase;
import com.intellij.diff.requests.SimpleDiffRequest;
import com.intellij.openapi.vcs.FilePath;
import com.intellij.openapi.vcs.LocalFilePath;
import com.intellij.diff.contents.DiffContent;
import com.intellij.diff.DiffContentFactory;

/**
 * When comparing generated text files with existing files, we deal with different kind of contents: test files coming from real folders
 * or packaged JARS on the CI and generated files from MPS that don't exist on disk. The easiest way to compare them is to read the reference
 *  folder through LocalFileSystem/VirtualFileManager as a virtual file. This is a class coming from the the Intellij platform. For the generated
 * file, we create a virtual file system and add them through createPath. Those virtual files are easy to read and iterate over and can be displayed
 * by the diff tool of the Intellij platform.
 */
public class TextComparison {
  private static final Logger LOG = Logger.getLogger(TextComparison.class);
  private Map<File, String> mapping = MapSequence.fromMap(new HashMap<File, String>());

  public static VirtualFile createPath(@NotNull DummyFileSystem fileSystem, @NotNull VirtualFile root, @NotNull String path, String content) throws Exception {
    return createPath(fileSystem, root, path, content, StandardCharsets.UTF_8);
  }

  public static VirtualFile createPath(@NotNull DummyFileSystem fileSystem, @NotNull VirtualFile root, @NotNull String path, String content, Charset encoding) throws IOException {
    String normalizedPath = path.replace("\\", "/");
    Path normalized = Paths.get(normalizedPath).normalize();

    List<String> parts = new ArrayList<>();
    for (Path part : normalized) {
      parts.add(part.toString());
    }
    if (parts.isEmpty()) {
      throw new IllegalArgumentException("Path must not be empty or only contain slashes.");
    }
    // Determine if we're creating a file or directory
    boolean isFile = (content != null) && !(normalizedPath.endsWith("/"));
    int directoryDepth = (isFile ? parts.size() - 1 : parts.size());
    VirtualFile current = root;
    // Create directory structure
    for (int i = 0; i < directoryDepth; i++) {
      String dirName = parts.get(i);
      if (dirName.isEmpty()) {
        continue;
      }
      VirtualFile next = current.findChild(dirName);
      if (next == null) {
        next = fileSystem.createChildDirectory(null, current, dirName);
      }
      current = next;
    }
    // Handle file creation if needed
    if (isFile) {
      String fileName = parts.get(parts.size() - 1);
      VirtualFile file = current.findChild(fileName);
      if (file == null) {
        file = fileSystem.createChildFile(null, current, fileName);
      }
      file.setBinaryContent(content.getBytes(encoding));
      return file;
    }
    return current;
  }


  public Map<File, String> getMapping() {
    return Collections.unmodifiableMap(mapping);
  }

  public void doTextGen(@NotNull SModel model, @NotNull Project project, @Nullable Comparator<SNode> comparator, @Nullable Predicate<SNode> filterCondition) {
    ListSequence.fromList(breakdownToUnits(model, project, comparator, filterCondition)).visitAll((it) -> {
      it.generate();
      MapSequence.fromMap(mapping).put(new File(it.getFilePath(), it.getFileName()), new String(it.getBytes(), it.getEncoding()));
    });
  }

  public void showDiff(@NotNull final com.intellij.openapi.project.Project ideaProject, @NotNull SModel model, @NotNull String path, @Nullable Comparator<SNode> comparator, @Nullable Predicate<SNode> filterCondition) throws IOException {
    doTextGen(model, ProjectHelper.fromIdeaProjectOrFail(ideaProject), comparator, filterCondition);
    final List<DiffRequest> requests = ListSequence.fromList(new ArrayList<DiffRequest>());

    Path resolvedPath = Paths.get(path).normalize();

    try (Stream<Path> walk = Files.walk(resolvedPath)) {
      walk.filter(Files::isRegularFile).forEach((file) -> {
        try {
          String expectedContent = Files.readString(file);
          File filePath = file.toFile();
          ListSequence.fromList(requests).addElement(createDiffRequestFromDifferentContents(ideaProject, filePath, expectedContent));
        } catch (IOException e) {
          throw new RuntimeException(e);
        }
      });
    }

    SimpleDiffRequestChain chain = new SimpleDiffRequestChain(requests);
    DiffManager.getInstance().showDiff(ideaProject, chain, DiffDialogHints.DEFAULT);
  }

  public TextComparisonResult textualDiff(Project project, @NotNull String path, @NotNull SModel model, @Nullable Comparator<SNode> comparator, @Nullable Predicate<SNode> filterCondition) throws Exception {
    return textualDiff(project, path, model, comparator, filterCondition, new PatchGenerator.PatchGeneratorOptions());
  }

  public TextComparisonResult textualDiff(Project project, @NotNull String path, @NotNull SModel model, @Nullable Comparator<SNode> comparator, @Nullable Predicate<SNode> filterCondition, PatchGenerator.PatchGeneratorOptions patchGeneratorOptions) throws Exception {
    doTextGen(model, project, comparator, filterCondition);

    StringWriter writer = new StringWriter();

    DummyFileSystem dummyFS = DummyFileSystem.getInstance();
    VirtualFile root = dummyFS.createRoot("");

    String expandPath = MacrosFactory.getGlobal().expandPath(path);

    Path resolvedPath = Paths.get(expandPath).normalize();

    VirtualFile expectedFolder = LocalFileSystem.getInstance().findFileByPath(resolvedPath.toString());
    if (expectedFolder == null) {
      expectedFolder = VirtualFileManager.getInstance().findFileByUrl((expandPath.startsWith("jar://") ? expandPath : "jar://" + expandPath));
    }
    if (expectedFolder == null) {
      throw new FileNotFoundException("The expected folder could not be found:" + path);
    }

    for (IMapping<File, String> entry : MapSequence.fromMap(mapping)) {
      VirtualFile generatedFile = createPath(dummyFS, root, entry.key().toString(), entry.value().toString());
      if (LOG.isDebugLevel()) {
        LOG.debug("Generated file:" + generatedFile.toString());
      }
    }

    new PatchGenerator(patchGeneratorOptions).generateDiff(expectedFolder, root, writer);
    return new TextComparisonResult(expectedFolder, root, writer.toString());
  }


  public class TextComparisonResult {
    private VirtualFile expectedFolder;
    private VirtualFile actualFolder;
    @Nullable
    private String diff;

    public TextComparisonResult(@NotNull VirtualFile expectedFolder, @NotNull VirtualFile actualFolder, @Nullable String diff) {
      this.expectedFolder = expectedFolder;
      this.actualFolder = actualFolder;
      this.diff = diff;
    }

    public VirtualFile getExpectedFolder() {
      return expectedFolder;
    }

    public VirtualFile getActualFolder() {
      return actualFolder;
    }

    public String getDiff() {
      return diff;
    }
  }

  protected List<TextUnit> breakdownToUnits(@NotNull SModel model, @NotNull Project project, @Nullable final Comparator<SNode> comparator, @Nullable final Predicate<SNode> filterCondition) {
    Collection<TextGenAspectDescriptor> tgad = TextGenRegistry.getInstance().getAspects(model);
    ModelOutline rv = new ModelOutline(model, project.getPlatform());
    for (TextGenAspectDescriptor d : tgad) {
      if (d instanceof TextGenAspectBase) {
        ((TextGenAspectBase) d).breakdownToUnits(rv);
      }
    }
    List<TextUnit> units = rv.getUnits();
    if (filterCondition != null) {
      units = ListSequence.fromList(units).where((it) -> filterCondition.test(it.getStartNode())).toList();
    }

    if (comparator != null) {
      return ListSequence.fromList(units).sort((a, b) -> comparator.compare(a.getStartNode(), b.getStartNode()), true).toList();
    }
    return units;
  }

  protected SimpleDiffRequest createDiffRequestFromDifferentContents(@NotNull com.intellij.openapi.project.Project ideaProject, @NotNull File filePath, @Nullable String expectedContent) {
    FilePath filePathObj = new LocalFilePath(filePath.toString(), false);
    DiffContent expectedDiffContent = DiffContentFactory.getInstance().create(ideaProject, (expectedContent != null ? expectedContent : ""), filePathObj);
    DiffContent actualDiffContent;

    if (MapSequence.fromMap(mapping).containsKey(filePath)) {
      String actualContent = MapSequence.fromMap(mapping).get(filePath);
      MapSequence.fromMap(mapping).removeKey(filePath);
      actualDiffContent = DiffContentFactory.getInstance().create(ideaProject, actualContent, filePathObj);
    } else {
      actualDiffContent = DiffContentFactory.getInstance().createEmpty();
    }
    return new SimpleDiffRequest(filePath.toString(), expectedDiffContent, actualDiffContent, "expected", "actual");
  }

}
