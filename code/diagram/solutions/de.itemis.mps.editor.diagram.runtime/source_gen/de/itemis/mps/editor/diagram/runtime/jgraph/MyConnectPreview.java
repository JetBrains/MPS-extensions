package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import com.mxgraph.swing.handler.mxConnectPreview;
import com.mxgraph.swing.mxGraphComponent;
import java.awt.event.MouseEvent;
import de.itemis.mps.editor.diagram.runtime.model.ConnectionTypeChooser;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import de.itemis.mps.editor.diagram.runtime.model.Box;
import com.mxgraph.model.mxCell;
import java.util.List;
import de.itemis.mps.editor.diagram.runtime.model.IConnectionType_Internal;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.mxgraph.model.mxICell;
import com.intellij.openapi.actionSystem.AnAction;
import com.intellij.openapi.actionSystem.AnActionEvent;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.actionSystem.ActionUpdateThread;
import com.intellij.openapi.actionSystem.DataContext;
import com.intellij.ide.DataManager;
import com.intellij.openapi.ui.popup.ListPopup;
import com.intellij.openapi.ui.popup.JBPopupFactory;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import com.intellij.ui.awt.RelativePoint;
import javax.swing.Icon;
import java.awt.Component;
import java.awt.Graphics;
import java.awt.geom.Rectangle2D;
import java.awt.Graphics2D;
import java.awt.BasicStroke;
import com.intellij.ui.JBColor;

public class MyConnectPreview extends mxConnectPreview {

  public MyConnectPreview(mxGraphComponent graphComponent) {
    super(graphComponent);
  }

  @Override
  public Object stop(final boolean commit, final MouseEvent event) {
    if (commit) {
      final MyGraph graph = (MyGraph) graphComponent.getGraph();
      final ConnectionTypeChooser connectionTypeChooser = graph.getConnectionTypeChooser();
      JGraphModelSynchronizer synchronizer = graph.getSynchronizer();
      Tuples._2<Box, String> source = synchronizer.getEdgeSourceTarget((mxCell) previewState.getCell(), false, (mxCell) graph.getDefaultParent());
      Tuples._2<Box, String> target = synchronizer.getEdgeSourceTarget((mxCell) previewState.getCell(), true, (mxCell) graph.getDefaultParent());
      List<IConnectionType_Internal> applicableTypes = connectionTypeChooser.getAllApplicable(source._0(), source._1(), target._0(), target._1(), new ArrayList<String>());
      if (ListSequence.fromList(applicableTypes).count() > 1) {
        final mxCell previewCell = (mxCell) previewState.getCell();
        final mxICell src = previewCell.getTerminal(true);
        final mxICell trg = previewCell.getTerminal(false);

        List<AnAction> actions = ListSequence.fromList(applicableTypes).sort((it) -> it.getName(), true).select((final IConnectionType_Internal it) -> {
          return as_8ai88l_a0a0a0a0a4a6a0a3(new AnAction(it.getName(), "", new ConnectionTypeIcon(it)) {
            public void actionPerformed(AnActionEvent event) {
              connectionTypeChooser.setPreferred(it);
              graph.addCell(previewCell, null, null, src, trg);
            }

            @NotNull
            @Override
            public ActionUpdateThread getActionUpdateThread() {
              return ActionUpdateThread.BGT;
            }
          }, AnAction.class);
        }).toList();
        DataContext dataContext = DataManager.getInstance().getDataContext(event.getComponent());
        ListPopup createListPopup = JBPopupFactory.getInstance().createActionGroupPopup("Applicable Connection Types", new DefaultActionGroup(actions), dataContext, JBPopupFactory.ActionSelectionAid.SPEEDSEARCH, false, null, 10);
        createListPopup.show(new RelativePoint(event));

        return super.stop(false, event);
      }
    }
    return super.stop(commit, event);
  }

  public static class ConnectionTypeIcon implements Icon {
    private IConnectionType_Internal myConnectionType;

    public ConnectionTypeIcon(IConnectionType_Internal myConnectionType1) {
      myConnectionType = myConnectionType1;
    }

    public int getIconHeight() {
      return (myConnectionType.getIcon() != null ? myConnectionType.getIcon().getIconHeight() : 16);
    }

    public int getIconWidth() {
      return (myConnectionType.getIcon() != null ? myConnectionType.getIcon().getIconWidth() : 16);
    }

    public void paintIcon(Component component, Graphics g_, int x, int y) {
      if (myConnectionType.getIcon() != null) {
        myConnectionType.getIcon().paintIcon(component, g_, x, y);
        return;
      }

      int w = getIconWidth();
      int h = getIconHeight();
      final Rectangle2D.Double bounds = new Rectangle2D.Double(x, y, w, h);

      DrawUtil.executeWithGraphicsCopy(((Graphics2D) g_), (Graphics2D g) -> {
        g.setColor(RootDiagramECell.DEFAULT_BACKGROUND_COLOR);
        g.fill(bounds);
        g.setColor(ContextButton.LINE_COLOR);
        g.setStroke(new BasicStroke(1.0f));
        g.draw(bounds);
        g.setColor(JBColor.BLACK);
        myConnectionType.drawIcon(g, bounds);
      });
    }
  }
  private static <T> T as_8ai88l_a0a0a0a0a4a6a0a3(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
