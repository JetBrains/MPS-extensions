package de.q60.mps.shadowmodels.runtime.engine;

/*Generated by MPS */

import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.modelix.model.api.INode;
import de.q60.mps.shadowmodels.runtime.util.IdShortener;
import org.modelix.model.api.IProperty;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.modelix.model.api.IChildLink;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.modelix.model.api.IReferenceLink;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;

public class CopyNodeToTransformationResult {

  protected IBuilderContext context;
  private String idPrefix = "";
  private Set<String> generatedIds = SetSequence.fromSet(new HashSet<String>());
  private String traceInfo;

  public CopyNodeToTransformationResult(IBuilderContext context) {
    this.context = context;
  }

  public void setIdPrefix(String prefix) {
    idPrefix = prefix;
  }

  public void setTraceInfo(String info) {
    this.traceInfo = info;
  }

  public String generateId(INode input) {
    String base = IdShortener.shorten(input.getReference().toString(), 5);
    int sequence = 0;
    String id = base;
    while (SetSequence.fromSet(generatedIds).contains(id)) {
      id = base + sequence++;
    }
    SetSequence.fromSet(generatedIds).addElement(id);
    return idPrefix + "!" + id;
  }

  public IBuilderContext copy(INode node) {
    if (node == null) {
      return null;
    }
    IBuilderContext newContext = context.withParameter(BuilderContextParameter.ID, generateId(node)).createNode(node.getConcept());
    TransformationResult.ResultElement copy = newContext.getResultElement();
    if (traceInfo != null) {
      copy.setTraceInfo(traceInfo);
    }
    copy(node, copy);
    return newContext;
  }

  protected void copy(final INode source, TransformationResult.ResultElement copy) {
    for (final IProperty property : ListSequence.fromList(source.getConcept().getAllProperties())) {
      setProperty(copy, property, () -> source.getPropertyValue(property.getName()));
      copy.setPropertyWriteHandler(property.getName(), new SimplePropertyWriteHandler(source, property));
    }

    for (IChildLink link : ListSequence.fromList(source.getConcept().getAllChildLinks())) {
      for (INode child : Sequence.fromIterable(source.getChildren(link.getName()))) {
        copyChild(copy, link, child);
      }
      copy.setChildAddHandler(link.getName(), new SimpleChildAddHandler(link, source));
    }

    for (IReferenceLink link : ListSequence.fromList(source.getConcept().getAllReferenceLinks())) {
      setReferenceTarget(copy, link, source.getReferenceTarget(link.getName()));
      copy.setReferenceWriteHandler(link.getName(), new LiftingReferenceWriteHandler(source, link));
    }
  }

  protected void copyChild(TransformationResult.ResultElement parentCopy, IChildLink link, INode originalChild) {
    parentCopy.addChild(link.getName(), new RewriteCall(originalChild, traceInfo), parentCopy.getScope());
  }

  protected void setReferenceTarget(TransformationResult.ResultElement copiedSource, IReferenceLink link, final INode originalTarget) {
    copiedSource.setReferenceTarget(link.getName(), new FirstRootRefTarget(new RewriteCall(originalTarget, traceInfo)));
  }

  public void setProperty(TransformationResult.ResultElement node, IProperty property, _FunctionTypes._return_P0_E0<? extends String> value) {
    node.setProperty(property.getName(), value);
  }
}
