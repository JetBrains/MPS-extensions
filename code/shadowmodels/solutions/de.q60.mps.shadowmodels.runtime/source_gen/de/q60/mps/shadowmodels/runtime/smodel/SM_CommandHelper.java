package de.q60.mps.shadowmodels.runtime.smodel;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import javax.swing.Timer;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import jetbrains.mps.project.Project;
import java.util.List;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.ide.ThreadUtils;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.ide.MPSCoreComponents;
import jetbrains.mps.project.ProjectManager;
import com.intellij.serviceContainer.AlreadyDisposedException;

public class SM_CommandHelper {
  private static final Logger LOG = Logger.getLogger(SM_CommandHelper.class);

  private static Timer timer = new Timer(10, new ActionListener() {
    public void actionPerformed(ActionEvent e) {
      Project project = getProject();
      if (project == null) {
        return;
      }
      timer.stop();
      final List<_FunctionTypes._void_P0_E0> queueCopy = ListSequence.fromListWithValues(new ArrayList<_FunctionTypes._void_P0_E0>(), queue);
      ListSequence.fromList(queue).clear();
      project.getRepository().getModelAccess().executeCommand(() -> {
        for (_FunctionTypes._void_P0_E0 r : ListSequence.fromList(queueCopy)) {
          try {
            r.invoke();
          } catch (Exception ex) {
            if (LOG.isErrorLevel()) {
              LOG.error("", ex);
            }
          }
        }
      });
    }
  });
  private static List<_FunctionTypes._void_P0_E0> queue = ListSequence.fromList(new ArrayList<_FunctionTypes._void_P0_E0>());

  public static void runInCommand(final _FunctionTypes._void_P0_E0 runnable) {
    final Project project = getProject();
    if (project == null) {
      ListSequence.fromList(queue).addElement(runnable);
      if (!(timer.isRunning())) {
        timer.start();
      }
    } else {
      if (ThreadUtils.isInEDT()) {
        project.getRepository().getModelAccess().executeCommand(() -> runnable.invoke());
      } else {
        ApplicationManager.getApplication().invokeAndWait(() -> project.getRepository().getModelAccess().executeCommand(() -> runnable.invoke()));
      }
    }
  }

  protected static Project getProject() {
    try {
      List<Project> projects = MPSCoreComponents.getInstance().getPlatform().findComponent(ProjectManager.class).getOpenedProjects();
      return ListSequence.fromList(projects).first();
    } catch (AlreadyDisposedException e) {
      return null;
    }
  }
}
