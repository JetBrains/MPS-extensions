package de.q60.mps.shadowmodels.debugview.plugin;

/*Generated by MPS */

import jetbrains.mps.workbench.action.BaseAction;
import javax.swing.Icon;
import com.intellij.openapi.actionSystem.AnActionEvent;
import java.util.Map;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.actionSystem.CommonDataKeys;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.ide.actions.MPSCommonDataKeys;
import org.jetbrains.annotations.NotNull;
import de.q60.mps.shadowmodels.runtime.engine.IOutputNodeReference;
import de.q60.mps.shadowmodels.runtime.smodel.SM_TransformationTrace;
import org.modelix.model.mpsadapters.mps.NodeToSNodeAdapter;
import de.q60.mps.shadowmodels.runtime.engine.OutputNodeReferenceAsNode;
import de.q60.mps.explorer.TransformationTraceComponent;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import javax.swing.tree.TreeNode;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import de.q60.mps.explorer.ITreeNodeFinder;
import de.q60.mps.explorer.TNode;
import de.q60.mps.explorer.pf.ExplorerElement;
import org.modelix.model.api.INode;
import java.util.Objects;
import javax.swing.tree.TreePath;
import de.q60.mps.explorer.pf.TreeNodeExtensions;
import jetbrains.mps.plugins.projectplugins.ProjectPluginManager;
import de.q60.mps.explorer.plugin.GenericExplorerTool_Tool;

public class LoadNodeInShadowExplorer_Action extends BaseAction {
  private static final Icon ICON = null;

  public LoadNodeInShadowExplorer_Action() {
    super("Shadow Models: Show in Explorer", "", ICON);
    this.setIsAlwaysVisible(false);
    this.setExecuteOutsideCommand(true);
    updateInBackground(true);
  }
  @Override
  public boolean isDumbAware() {
    return true;
  }
  @Override
  protected boolean collectActionData(AnActionEvent event, final Map<String, Object> _params) {
    if (!(super.collectActionData(event, _params))) {
      return false;
    }
    {
      Project p = event.getData(CommonDataKeys.PROJECT);
      if (p == null) {
        return false;
      }
    }
    {
      SNode node = event.getData(MPSCommonDataKeys.NODE);
      if (node == null) {
        return false;
      }
    }
    return true;
  }
  @Override
  public void doExecute(@NotNull final AnActionEvent event, final Map<String, Object> _params) {
    final IOutputNodeReference selectedNode = SM_TransformationTrace.getOutputNodeReference(event.getData(MPSCommonDataKeys.NODE));
    if (selectedNode == null) {
      return;
    }
    final SNode selectedSNode = NodeToSNodeAdapter.wrap(OutputNodeReferenceAsNode.create(SM_TransformationTrace.getEngine(event.getData(MPSCommonDataKeys.NODE)), selectedNode));

    TransformationTraceComponent comp = ShadowActionsUtil.loadShadowRepositoryExplorer(event.getData(CommonDataKeys.PROJECT));
    final TransformationTraceComponent.TreeComp tree = comp.getMasterTree();
    final Wrappers._T<TreeNode> found = new Wrappers._T<TreeNode>(null);
    comp.runRead(() -> {
      final Set<IOutputNodeReference> ancestors = SetSequence.fromSetWithValues(new HashSet<IOutputNodeReference>(), ListSequence.fromList(SNodeOperations.getNodeAncestors(selectedSNode, null, false)).select((it) -> SM_TransformationTrace.getOutputNodeReference(it)).where(new NotNullWhereFilter()));
      found.value = tree.find(new ITreeNodeFinder() {
        @Override
        public boolean matches(TreeNode tnode) {
          Object owner = check_rpql9i_a0a0a0a0a0a1a0a0h0a(as_3urqok_a0a0a0a0a0a0a1a0a0h0f(check_rpql9i_a0a0a0a0a0a0a1a0a0h0a(as_3urqok_a0a0a0a0a0a0a0a0b0a0a7a5(tnode, TNode.class)), ExplorerElement.class));
          IOutputNodeReference onr = getONR(tnode);
          if (owner instanceof INode) {
            onr = SM_TransformationTrace.getOutputNodeReference((INode) owner);
          }
          if (owner instanceof SNode) {
            onr = SM_TransformationTrace.getOutputNodeReference((SNode) owner);
          }
          return Objects.equals(onr, selectedNode);
        }

        @Override
        public boolean searchInside(TreeNode tnode) {
          IOutputNodeReference onr = getONR(tnode);
          if (onr == null) {
            return true;
          }
          if (!(SetSequence.fromSet(ancestors).contains(onr))) {
            return false;
          }
          return true;
        }
        public IOutputNodeReference getONR(TreeNode tnode) {
          Object owner = check_rpql9i_a0a0d0a0a0a1a0a0h0a(as_3urqok_a0a0a0d0a0a0a1a0a0h0f(check_rpql9i_a0a0a0d0a0a0a1a0a0h0a(as_3urqok_a0a0a0a0a3a0a0a0b0a0a7a5(tnode, TNode.class)), ExplorerElement.class));
          if (owner instanceof INode) {
            return SM_TransformationTrace.getOutputNodeReference((INode) owner);
          }
          if (owner instanceof SNode) {
            return SM_TransformationTrace.getOutputNodeReference((SNode) owner);
          }
          return null;
        }
      });
    });
    if (found.value == null) {
      return;
    }
    TreePath path = TreeNodeExtensions.getPath(found.value);
    tree.scrollPathToVisible(path);
    tree.setSelectionPath(path);
    ProjectPluginManager.getInstance(event.getData(CommonDataKeys.PROJECT)).getTool(GenericExplorerTool_Tool.class).openTool(true);


  }
  private static Object check_rpql9i_a0a0a0a0a0a1a0a0h0a(ExplorerElement checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.owner;
    }
    return null;
  }
  private static Object check_rpql9i_a0a0a0a0a0a0a1a0a0h0a(TNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getUserObject();
    }
    return null;
  }
  private static Object check_rpql9i_a0a0d0a0a0a1a0a0h0a(ExplorerElement checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.owner;
    }
    return null;
  }
  private static Object check_rpql9i_a0a0a0d0a0a0a1a0a0h0a(TNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getUserObject();
    }
    return null;
  }
  private static <T> T as_3urqok_a0a0a0a0a0a0a1a0a0h0f(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_3urqok_a0a0a0a0a0a0a0a0b0a0a7a5(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_3urqok_a0a0a0d0a0a0a1a0a0h0f(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_3urqok_a0a0a0a0a3a0a0a0b0a0a7a5(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
