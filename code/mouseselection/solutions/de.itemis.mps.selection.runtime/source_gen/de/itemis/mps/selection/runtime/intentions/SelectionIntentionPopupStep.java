package de.itemis.mps.selection.runtime.intentions;

/*Generated by MPS */

import com.intellij.openapi.ui.popup.util.BaseListPopupStep;
import jetbrains.mps.openapi.editor.selection.Selection;
import org.jetbrains.mps.openapi.module.SRepository;
import com.intellij.openapi.ui.popup.ListPopup;
import com.intellij.openapi.ui.popup.JBPopupFactory;
import com.intellij.openapi.ui.popup.PopupStep;
import java.util.List;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.intellij.ui.awt.RelativePoint;
import jetbrains.mps.nodeEditor.EditorComponent;
import java.awt.Point;
import org.jetbrains.annotations.NotNull;

public class SelectionIntentionPopupStep extends BaseListPopupStep<ISelectionIntentionExecutable> {

  public static void showPopup(final Selection selection) {
    final SRepository repo = selection.getEditorComponent().getEditorContext().getRepository();
    ListPopup popup = JBPopupFactory.getInstance().createListPopup(new SelectionIntentionPopupStep(selection) {
      @Override
      public PopupStep onChosen(final ISelectionIntentionExecutable intention, boolean finalChoice) {
        repo.getModelAccess().executeCommand(() -> intention.execute(selection));
        return super.onChosen(intention, finalChoice);
      }
    });
    List<EditorCell> selectedCells = selection.getSelectedCells();
    EditorCell selectedCell = ListSequence.fromList(selectedCells).first();
    if (selectedCell == null) {
      return;
    }
    popup.show(new RelativePoint((EditorComponent) selection.getEditorComponent(), new Point(selectedCell.getX(), selectedCell.getY())));
  }

  private Selection mySelection;

  public SelectionIntentionPopupStep(Selection selection) {
    super("Intentions", SelectionIntentionsManager.getInstance().getApplicableIntentions(selection));
    mySelection = selection;
  }

  @NotNull
  @Override
  public String getTextFor(ISelectionIntentionExecutable executable) {
    return executable.getDescription(mySelection);
  }
}
