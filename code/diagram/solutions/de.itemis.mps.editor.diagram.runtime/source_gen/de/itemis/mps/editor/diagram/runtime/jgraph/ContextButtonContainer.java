package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import com.mxgraph.view.mxGraphView;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.awt.Rectangle;
import de.itemis.mps.editor.diagram.runtime.model.ExtensionMethods;
import java.awt.event.MouseEvent;
import jetbrains.mps.internal.collections.runtime.Sequence;
import de.itemis.mps.editor.diagram.runtime.model.Point;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.geom.Rectangle2D;

public class ContextButtonContainer {
  public static final double BUTTON_SPACING = ContextButton.DEFAULT_BUTTON_SPACING;

  private mxGraphView myView;
  private List<ContextButton> myButtons = ListSequence.fromList(new ArrayList<ContextButton>());
  private ContextButton myLastButtonPressed = null;
  private ContextButton myHighlightedButton = null;
  private ContextButton myLastHighlightedButton = null;
  private Rectangle myBounds = new Rectangle(0, 0, 0, 0);
  private double myScale = 0.0;

  public ContextButtonContainer(mxGraphView view) {
    myView = view;
  }

  public void setScale(double scale) {
    if (myScale != scale) {
      myScale = scale;
      relayout();
    }
  }

  public double getScale() {
    return (myScale != 0.0 ? myScale : myView.getScale());
  }

  public void setButtons(List<ContextButton> buttons) {
    myButtons = ListSequence.fromListWithValues(new ArrayList<ContextButton>(), buttons);
    layoutButtons();
  }

  public void moveTo(int x, int y) {
    myBounds.x = x;
    myBounds.y = y;
    layoutButtons();
  }

  public void moveTo(double x, double y) {
    moveTo(ExtensionMethods.toInt(x), ExtensionMethods.toInt(y));
  }

  public double getButtonSpacing() {
    return ContextButton.DEFAULT_BUTTON_SPACING * getScale();
  }

  public double getButtonSpacing(ContextButton button) {
    return button.getSpacing() * getScale();
  }

  public void mouseMoved(MouseEvent event) {
    ContextButton button = getButtonAt(event);
    if (button != myHighlightedButton) {
      if (button != null) {
        button.repaint();
      }
      if (myHighlightedButton != null) {
        myHighlightedButton.repaint();
      }
    }
    myHighlightedButton = button;
    if (myHighlightedButton != null && ListSequence.fromList(myButtons).contains(myHighlightedButton)) {
      if (myHighlightedButton != myLastHighlightedButton) {
        if (myLastHighlightedButton != null) {
          for (ContextButton c : ListSequence.fromList(myLastHighlightedButton.getChildButtons())) {
            c.repaint();
          }
        }
        for (ContextButton c : ListSequence.fromList(myHighlightedButton.getChildButtons())) {
          c.repaint();
        }
      }
      myLastHighlightedButton = myHighlightedButton;
    }
  }

  public void mouseReleased(MouseEvent event) {
    ContextButton button = getButtonAt(event);
    if (button != null && myLastButtonPressed == button) {
      myLastButtonPressed = null;
      button.execute();
      event.consume();
    }
  }

  public void mouseDragged(MouseEvent event) {
    if (myLastButtonPressed != null) {
      myLastButtonPressed.mouseDragged(event);
    }
  }

  public void mousePressed(MouseEvent event) {
    ContextButton button = getButtonAt(event);
    if (button != null) {
      myLastButtonPressed = button;
      event.consume();
    }
  }

  public Iterable<ContextButton> getVisibleButtons() {
    Iterable<ContextButton> result = myButtons;
    if (myLastHighlightedButton != null && ListSequence.fromList(myButtons).contains(myLastHighlightedButton)) {
      result = Sequence.fromIterable(result).concat(ListSequence.fromList(myLastHighlightedButton.getChildButtons()));
    }
    return result;
  }

  public ContextButton getButtonAt(MouseEvent event) {
    for (ContextButton button : Sequence.fromIterable(getVisibleButtons())) {
      if (button.getBounds().contains(new Point(event.getX(), event.getY()))) {
        return button;
      }
    }
    return null;
  }

  public String getToolTipText(int x, int y) {
    for (ContextButton button : Sequence.fromIterable(getVisibleButtons())) {
      if (button.getBounds().contains(new Point(x, y))) {
        return button.getTooltip();
      }
    }
    return null;
  }

  public void paint(Graphics g_) {
    for (ContextButton button : Sequence.fromIterable(getVisibleButtons())) {
      paintButton(g_, button);
    }
  }

  protected void paintButton(Graphics g_, final ContextButton button) {
    DrawUtil.executeWithGraphicsCopy((Graphics2D) g_, (Graphics2D g) -> button.paint(g, myHighlightedButton == button));
  }

  public void relayout() {
    layoutButtons();
  }

  protected void layoutButtons() {
    double x = myBounds.x;
    double y = myBounds.y;
    for (ContextButton button : ListSequence.fromList(myButtons)) {
      button.setPos(x, y);
      x += getButtonSpacing(button) + button.getWidth();
      layoutChildButtons(button);
    }
    updateBounds();
  }

  protected void layoutChildButtons(ContextButton parent) {
    double x = parent.getBounds().getX();
    double y = parent.getBounds().getMaxY() + getButtonSpacing();
    for (ContextButton child : ListSequence.fromList(parent.getChildButtons())) {
      child.setPos(x, y);
      y = child.getBounds().getMaxY() + getButtonSpacing();
    }
  }

  protected void updateBounds() {
    Rectangle newBounds = getBounds();
    newBounds.width = 0;
    newBounds.height = 0;
    for (ContextButton button : ListSequence.fromList(myButtons)) {
      Rectangle2D buttonBounds = de.itemis.mps.editor.diagram.runtime.jgraph.ExtensionMethods.toRectangle2D(button.getBounds());
      if (newBounds == null) {
        newBounds = de.itemis.mps.editor.diagram.runtime.jgraph.ExtensionMethods.toRectangle(buttonBounds);
      } else {
        newBounds.add(buttonBounds);
      }
      for (ContextButton child : ListSequence.fromList(button.getChildButtons())) {
        newBounds.add(de.itemis.mps.editor.diagram.runtime.jgraph.ExtensionMethods.toRectangle2D(child.getBounds()));
      }
    }
    myBounds = newBounds;
  }

  public Rectangle getBounds() {
    return new Rectangle(myBounds);
  }
}
