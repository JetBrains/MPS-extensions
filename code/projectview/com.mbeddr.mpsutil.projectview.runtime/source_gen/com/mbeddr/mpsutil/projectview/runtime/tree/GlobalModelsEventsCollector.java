package com.mbeddr.mpsutil.projectview.runtime.tree;

/*Generated by MPS */

import org.jetbrains.mps.openapi.module.SRepositoryListener;
import org.jetbrains.mps.openapi.module.SRepositoryListenerBase;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.module.SRepository;
import java.util.List;
import jetbrains.mps.smodel.event.SModelEvent;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.module.SModuleListener;
import org.jetbrains.mps.openapi.module.SModuleListenerBase;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.event.SModelListener;
import jetbrains.mps.smodel.SModelAdapter;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.extapi.model.SModelDescriptorStub;

public abstract class GlobalModelsEventsCollector {

  protected SRepositoryListener repositoryListener = new SRepositoryListenerBase() {
    public void moduleAdded(@NotNull SModule m) {
      start(m);
    }
    public void beforeModuleRemoved(@NotNull SModule m) {
      stop(m);
    }
    @Override
    public void commandFinished(SRepository repository) {
      List<SModelEvent> events = collectedEvents;
      collectedEvents = new ArrayList<SModelEvent>();
      eventsHappened(events);
    }
  };
  protected SModuleListener moduleListener = new SModuleListenerBase() {
    public void modelAdded(SModule module, SModel model) {
      start(model);
    }
    public void beforeModelRemoved(SModule module, SModel model) {
      stop(model);
    }
  };
  protected SModelListener modelListener = new SModelAdapter() {
    @Override
    public void eventFired(SModelEvent event) {
      collectedEvents.add(event);
    }
  };

  protected SRepository repository;
  protected List<SModelEvent> collectedEvents = new ArrayList<SModelEvent>();

  public GlobalModelsEventsCollector(SRepository repo) {
    this.repository = repo;
  }

  public void start() {
    repository.addRepositoryListener(repositoryListener);
    repository.getModelAccess().runReadAction(() -> {
      for (SModule module : Sequence.fromIterable(repository.getModules())) {
        start(module);
      }
    });
  }

  protected void start(SModule module) {
    module.addModuleListener(moduleListener);
    for (SModel model : Sequence.fromIterable(module.getModels())) {
      start(model);
    }
  }

  protected void start(SModel model) {
    ((SModelDescriptorStub) model).addModelListener(modelListener);
  }

  public void stop() {
    repository.getModelAccess().runReadAction(() -> {
      repository.removeRepositoryListener(repositoryListener);
      for (SModule module : Sequence.fromIterable(repository.getModules())) {
        stop(module);
      }
    });
  }

  protected void stop(SModule module) {
    module.removeModuleListener(moduleListener);
    for (SModel model : Sequence.fromIterable(module.getModels())) {
      stop(model);
    }
  }

  protected void stop(SModel model) {
    ((SModelDescriptorStub) model).removeModelListener(modelListener);
  }

  protected abstract void eventsHappened(List<SModelEvent> events);
}
