package de.itemis.mps.editor.bool.runtime;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.awt.Image;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.util.MacrosFactory;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import java.net.URL;
import jetbrains.mps.smodel.language.LanguageRegistry;
import java.util.stream.Stream;
import java.awt.Toolkit;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.project.AbstractModule;
import java.net.MalformedURLException;

public class ImageLoading {
  private static final Logger LOG = Logger.getLogger(ImageLoading.class);
  /**
   * 
   * @deprecated use the overload with the repository parameter. Left for compatibility with existing generated code.
   */
  @Deprecated(since = "2025-10", forRemoval = true)
  public static Image loadImage(String fileName, SNode sourceNode) {
    return loadImage(SNodeOperations.getModel(sourceNode).getRepository(), fileName, sourceNode);
  }

  public static Image loadImage(@NotNull SRepository repository, @Nullable String fileName, @NotNull SNode sourceNode) {
    if (fileName == null) {
      return null;
    }

    SModule module = SNodeOperations.getConcept(sourceNode).getLanguage().getSourceModule();
    if (module == null) {
      return null;
    }

    if (fileName.startsWith(MacrosFactory.MODULE)) {
      if (fileName.length() < MacrosFactory.MODULE.length() + 2) {
        return null;
      }
      // in case of module local path, use module runtime / classloader mechanism to load the image 
      // NOTE: using MacrosFactory for resolving ${module} is not viable anymore, since for deployed modules it returns src.jar location that doesn't not contain copied resources (like icons)
      final String filePathInModule = fileName.substring(MacrosFactory.MODULE.length() + 1);

      final Wrappers._T<URL> resourceURL = new Wrappers._T<URL>();
      LanguageRegistry.getInstance(repository).withModuleRuntime(Stream.of(module.getModuleReference()), (mr) -> resourceURL.value = mr.getModuleClassLoader().getResource(filePathInModule));
      if (resourceURL.value != null) {
        return Toolkit.getDefaultToolkit().getImage(resourceURL.value);
      }
    }

    fileName = MacrosFactory.forModule(module).expandPath(fileName);
    IFile imageFile = ((AbstractModule) module).getFileSystem().getFile(fileName);
    if (imageFile.exists()) {
      try {
        return Toolkit.getDefaultToolkit().getImage(imageFile.getUrl());
      } catch (MalformedURLException e) {
        if (LOG.isErrorLevel()) {
          LOG.error("Failed to load checkbox image", e);
        }
      }
    }
    return null;

  }
}
