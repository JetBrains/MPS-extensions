package de.slisson.mps.tables.runtime.simplegrid;

/*Generated by MPS */

import java.util.List;
import java.util.ArrayList;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Iterator;

public class SimpleGrid<E> implements Cloneable, Iterable<E>, IGridLike<E> {
  private static final ElementFactory NULL_ELEMENT_FACTORY = new ElementFactory() {
    public Object createNewElement() {
      return null;
    }
  };

  protected int sizeX = 0;
  protected int sizeY = 0;
  protected List<List<E>> elements = new ArrayList<List<E>>();
  private ElementFactory<? extends E> defaultElementFactory = NULL_ELEMENT_FACTORY;
  private boolean myAllowNulls = true;

  public SimpleGrid() {
  }

  public SimpleGrid(E initalElement) {
    setElement(0, 0, initalElement);
  }

  public SimpleGrid<E> allowNulls(boolean allow) {
    myAllowNulls = allow;
    return this;
  }

  public void setDefaultElementFactory(@NotNull ElementFactory<? extends E> factory) {
    defaultElementFactory = factory;
  }

  private E createNewElement() {
    return createNewElement(null);
  }

  private E createNewElement(ElementFactory<? extends E> factory) {
    E e;
    if (factory == null) {
      e = defaultElementFactory.createNewElement();
    } else {
      e = factory.createNewElement();
    }
    if (myAllowNulls == false && e == null) {
      throw new NullPointerException("factory returned null. factory = " + factory);
    }
    return e;
  }

  protected void processElementAfterSet(int x, int y, E element) {
  }

  public void processElementAfterRemove(int x, int y, E element) {
  }

  @Override
  public SimpleGrid<E> clone() {
    try {
      SimpleGrid<E> clone = (SimpleGrid<E>) super.clone();
      clone.elements = new ArrayList<List<E>>();
      clone.sizeX = 0;
      clone.sizeY = 0;
      clone.setValues(this);
      return clone;

    } catch (CloneNotSupportedException ex) {
      throw new RuntimeException(ex);
    }
  }

  public void setValues(SimpleGrid<E> source) {
    setSize(source.getSizeX(), source.getSizeY());
    for (int x = 0; x < getSizeX(); x++) {
      for (int y = 0; y < getSizeY(); y++) {
        setElement(x, y, source.getElement(x, y));
      }
    }
  }

  public void moveRow(int from, int to) {
    if (from < 0 || from >= getSizeY()) {
      throw new IndexOutOfBoundsException("from: " + from + ", sizeX: " + getSizeY());
    }
    if (to < 0 || to >= getSizeY()) {
      throw new IndexOutOfBoundsException("to: " + to + ", sizeX: " + getSizeY());
    }
    List<E> removed = elements.remove(from);
    elements.add(to, removed);
  }

  public void moveColumn(int from, int to) {
    if (from < 0 || from >= getSizeX()) {
      throw new IndexOutOfBoundsException("from: " + from + ", sizeX: " + getSizeX());
    }
    if (to < 0 || to >= getSizeX()) {
      throw new IndexOutOfBoundsException("to: " + to + ", sizeX: " + getSizeX());
    }
    for (int y = 0; y < elements.size(); y++) {
      E removed = elements.get(y).remove(from);
      elements.get(y).add(to, removed);
    }
  }

  public void insertRows(int x, int y, SimpleGrid<E> rows) {
    if (rows == null) {
      return;
    }
    for (int i = 0; i < rows.getSizeY(); i++) {
      insertRow(y);
    }
    replaceElements(x, y, rows);
  }

  public SimpleGrid<E> subgridSafe(int fromX, int toX, int fromY, int toY) {
    return subgrid(fromX, Math.min(toX, getSizeX() - 1), fromY, Math.min(toY, getSizeY() - 1));
  }

  public SimpleGrid<E> subgrid(int fromX, int toX, int fromY, int toY) {
    if (fromX < 0) {
      fromX = 0;
    }
    if (toX < 0) {
      toX = getSizeX() - 1;
    }
    if (fromY < 0) {
      fromY = 0;
    }
    if (toY < 0) {
      toY = getSizeY() - 1;
    }

    SimpleGrid<E> subgrid = new SimpleGrid<E>();
    for (int x = fromX; x <= toX; x++) {
      for (int y = fromY; y <= toY; y++) {
        subgrid.setElement(x - fromX, y - fromY, getElement(x, y));
      }
    }
    return subgrid;
  }

  public void insertColumns(int x, int y, SimpleGrid<E> columns) {
    if (columns == null) {
      return;
    }
    for (int i = 0; i < columns.getSizeX(); i++) {
      insertColumn(x);
    }
    replaceElements(x, y, columns);
  }

  public void expandElements(int x, int y, SimpleGrid<E> childGrid) {
    if (childGrid == null || childGrid.isEmpty()) {
      setElement(x, y, null);
      return;
    }

    for (int i = 1; i < childGrid.getSizeX(); i++) {
      insertColumn(x);
    }
    for (int i = 1; i < childGrid.getSizeY(); i++) {
      insertRow(y);
    }

    replaceElements(x, y, childGrid);
  }

  public void replaceElements(int x, int y, IGridLike<E> childGrid) {
    if (childGrid == null || childGrid.getSizeX() == 0 || childGrid.getSizeY() == 0) {
      setElement(x, y, createNewElement());
      return;
    }

    for (int childX = 0; childX < childGrid.getSizeX(); childX++) {
      for (int childY = 0; childY < childGrid.getSizeY(); childY++) {
        setElement(childX + x, childY + y, childGrid.getElement(childX, childY));
      }
    }
  }

  public boolean isEmpty() {
    return sizeX == 0 || sizeY == 0;
  }

  public boolean hasNonNullElements() {
    for (List<E> row : ListSequence.fromList(elements)) {
      for (E el : ListSequence.fromList(row)) {
        if (el != null) {
          return true;
        }
      }
    }
    return false;
  }

  public int getSizeX() {
    return sizeX;
  }

  public int getSizeY() {
    return sizeY;
  }

  public boolean isValidPosition(GridPosition pos) {
    return isValidPosition(pos.getX(), pos.getY());
  }

  public boolean isValidPosition(int x, int y) {
    return x < getSizeX() && y < getSizeY() && x >= 0 && y >= 0;
  }

  public E getElement(int x, int y) {
    if (x >= getSizeX()) {
      throw new IndexOutOfBoundsException("IndexX: " + x + ", SizeX: " + getSizeX());
    }
    if (y >= getSizeY()) {
      throw new IndexOutOfBoundsException("IndexY: " + y + ", SizeY: " + getSizeY());
    }
    return elements.get(y).get(x);
  }

  public E getElement(GridPosition pos) {
    if (pos == null) {
      return null;
    }
    return getElement(pos.getX(), pos.getY());
  }

  public void setElement(int x, int y, E element) {
    if (myAllowNulls == false && element == null) {
      throw new NullPointerException("element is null, x= " + x + ", y = " + y);
    }
    ensureSize(x + 1, y + 1);
    E before = getElement(x, y);
    elements.get(y).set(x, element);
    if (before != null) {
      processElementAfterRemove(x, y, element);
    }
    processElementAfterSet(x, y, element);
  }

  public void insertRow(int pos) {
    insertRow(pos, null);
  }

  public void insertRow(int pos, ElementFactory<? extends E> elementFactory) {
    ensureSize(sizeX, pos);
    elements.add(pos, createEmptyElementsList(sizeX, elementFactory));
    setSize(sizeX, sizeY + 1);
  }

  public void insertRows(int pos, int count, ElementFactory<? extends E> elementFactory) {
    for (int i = 0; i < count; i++) {
      insertRow(pos, elementFactory);
    }
  }

  public void insertColumn(int pos) {
    insertColumn(pos, null);
  }

  public void insertColumn(int pos, ElementFactory<? extends E> elementFactory) {
    ensureSize(pos, sizeY, elementFactory);
    for (List<E> row : ListSequence.fromList(elements)) {
      row.add(pos, createNewElement(elementFactory));
    }
    setSize(sizeX + 1, sizeY, elementFactory);
  }

  public void insertColumns(int pos, int count, ElementFactory<? extends E> elementFactory) {
    for (int i = 0; i < count; i++) {
      insertColumn(pos, elementFactory);
    }
  }

  public void ensureSize(int minSizeX, int minSizeY) {
    ensureSize(minSizeX, minSizeY, null);
  }

  public void ensureSize(int minSizeX, int minSizeY, ElementFactory<? extends E> elementFactory) {
    setSize(Math.max(minSizeX, sizeX), Math.max(minSizeY, sizeY), elementFactory);
  }

  public void setSize(int newSizeX, int newSizeY) {
    setSize(newSizeX, newSizeY, null);
  }

  public void setSize(int newSizeX, int newSizeY, ElementFactory<? extends E> elementFactory) {
    if (newSizeX == sizeX && newSizeY == sizeY) {
      return;
    }

    while (elements.size() < newSizeY) {
      elements.add(createEmptyElementsList(newSizeX, elementFactory));
    }
    while (elements.size() > newSizeY) {
      elements.remove(elements.size() - 1);
    }

    for (List<E> row : ListSequence.fromList(elements)) {
      while (row.size() < newSizeX) {
        row.add(createNewElement(elementFactory));
      }
      while (row.size() > newSizeX) {
        row.remove(row.size() - 1);
      }
    }

    sizeX = newSizeX;
    sizeY = newSizeY;
  }

  public void deleteColumn(int columnIndex) {
    moveColumn(columnIndex, getSizeX() - 1);
    setSize(getSizeX() - 1, getSizeY(), null);
  }

  public void deleteRow(int rowIndex) {
    moveRow(rowIndex, getSizeY() - 1);
    setSize(getSizeX(), getSizeY() - 1, null);
  }

  public void transposeInPlace() {
    if (getSizeX() == 1 && getSizeY() == 1) {
      return;
    }

    int newSizeX = sizeY;
    int newSizeY = sizeX;

    List<List<E>> oldElements = elements;

    elements = new ArrayList<List<E>>(newSizeY);
    for (int y = 0; y < newSizeY; y++) {
      List<E> row = new ArrayList<E>(newSizeX);
      elements.add(row);
      for (int x = 0; x < newSizeX; x++) {
        row.add(oldElements.get(x).get(y));
      }
    }
    this.sizeX = newSizeX;
    this.sizeY = newSizeY;
  }

  public SimpleGrid transposeCloned() {
    SimpleGrid transposed = clone();
    transposed.setSize(getSizeY(), getSizeX(), null);

    for (int x = 0; x < getSizeX(); x++) {
      for (int y = 0; y < getSizeY(); y++) {
        transposed.setElement(y, x, getElement(x, y));
      }
    }

    return transposed;
  }

  public void setElements(int offsetX, int offsetY, SimpleGrid<E> elements) {
    for (int x = 0; x < elements.getSizeX(); x++) {
      for (int y = 0; y < elements.getSizeY(); y++) {
        setElement(x + offsetX, y + offsetY, elements.getElement(x, y));
      }
    }
  }

  @Override
  public Iterator<E> iterator() {
    return new SimpleGridIterator<E>(this);
  }

  public String toString2() {
    StringBuilder sb = new StringBuilder("{");
    boolean firstRow = true;
    for (List<E> row : ListSequence.fromList(elements)) {
      if (!(firstRow)) {
        sb.append("\n");
      }
      boolean firstElement = true;
      for (E element : ListSequence.fromList(row)) {
        if (!(firstElement)) {
          sb.append(", ");
        }
        sb.append(element).append("@").append(System.identityHashCode(element));
        firstElement = false;
      }
      firstRow = false;
    }
    sb.append("}");
    return sb.toString();
  }

  @Override
  public String toString() {
    StringBuilder sb = new StringBuilder("SimpleGrid[" + getSizeX() + "x" + getSizeY() + "]{\n");
    boolean firstRow = true;
    for (int y = 0; y < getSizeY(); y++) {
      if (!(firstRow)) {
        sb.append("\n");
      }
      for (int x = 0; x < this.getSizeX(); x++) {
        E element = this.getElement(x, y);
        String elementText = "" + element;
        elementText = prefixLines(elementText, "  [" + x + "," + y + "] ");
        sb.append(elementText);
      }
      firstRow = false;
    }
    sb.append("}");
    return sb.toString();
  }

  private static String prefixLines(String text, String linePrefix) {
    StringBuilder result = new StringBuilder();
    String[] textLines = text.split("\n");
    for (String line : textLines) {
      result.append(linePrefix).append(line).append("\n");
    }
    return result.toString();
  }

  public List<E> getRow(int y) {
    return new ArrayList<E>(elements.get(y));
  }

  public List<E> getColumn(int x) {
    List<E> result = new ArrayList<E>();
    for (int y = 0; y < getSizeY(); y++) {
      result.add(getElement(x, y));
    }
    return result;
  }

  public void fillNulls(int startX, int startY, SimpleGrid<E> values) {
    if (values == null || values.isEmpty()) {
      return;
    }
    if (values.getSizeY() == 1) {
      int thisX = startX;
      for (int valuesX = 0; valuesX < values.getSizeX(); valuesX++) {
        while (thisX < getSizeX() && getElement(thisX, startY) != null) {
          thisX++;
        }
        if (thisX == getSizeX()) {
          insertColumn(thisX);
        }
        setElement(thisX, startY, values.getElement(valuesX, 0));
      }
    } else if (values.getSizeX() == 1) {
      int thisY = startY;
      for (int valuesY = 0; valuesY < values.getSizeY(); valuesY++) {
        while (thisY < getSizeY() && getElement(startX, thisY) != null) {
          thisY++;
        }
        if (thisY == getSizeY()) {
          insertColumn(thisY);
        }
        setElement(startX, thisY, values.getElement(0, valuesY));
      }
    } else {
      throw new IllegalArgumentException("values must be a vector (size of one dimension == 1)");
    }
  }

  private List<E> createEmptyElementsList(int size, ElementFactory<? extends E> elementFactory) {
    List<E> list = new ArrayList<E>(size);
    for (int i = 0; i < size; i++) {
      list.add(createNewElement(elementFactory));
    }
    return list;
  }

  public static <T> SimpleGrid<T> createRow(List<T> elements) {
    SimpleGrid<T> grid = new SimpleGrid<T>();
    grid.setSize(elements.size(), 1);
    for (int x = 0; x < elements.size(); x++) {
      grid.setElement(x, 0, elements.get(x));
    }
    return grid;
  }

  public static <T> SimpleGrid<T> createColumn(List<T> elements) {
    SimpleGrid<T> grid = new SimpleGrid<T>();
    grid.setSize(1, elements.size());
    for (int y = 0; y < elements.size(); y++) {
      grid.setElement(0, y, elements.get(y));
    }
    return grid;
  }

}
