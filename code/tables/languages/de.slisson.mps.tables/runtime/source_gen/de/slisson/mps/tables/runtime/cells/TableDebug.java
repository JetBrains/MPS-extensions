package de.slisson.mps.tables.runtime.cells;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.EditorComponent;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import java.io.File;
import jetbrains.mps.util.FileUtil;
import java.io.IOException;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import jetbrains.mps.internal.collections.runtime.Sequence;
import de.slisson.mps.tables.runtime.gridmodel.Grid;
import jetbrains.mps.project.Project;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.project.FileBasedProject;

public class TableDebug {
  private static final boolean DEBUG_ENABLED = false;

  public static boolean isDebugEnabled() {
    return DEBUG_ENABLED;
  }

  public static void sout(String text) {
    if (!(DEBUG_ENABLED)) {
      return;
    }
    System.out.println(text);
  }

  public static void writeEditorState(EditorComponent component) {
    if (!(DEBUG_ENABLED)) {
      return;
    }
    writeEditorState(component.getRootCell());
  }

  public static void writeEditorState(EditorCell cell) {
    if (!(DEBUG_ENABLED)) {
      return;
    }
    writeEditorState(cell, new File(getProjectFolder(cell), "editor_states" + File.separator + System.nanoTime() + ".txt"));
  }

  private static void writeEditorState(EditorCell cell, File file) {
    if (!(DEBUG_ENABLED)) {
      return;
    }
    try {
      String text = getStackTrace(new Exception()) + "\n\n" + buildEditorStateText(cell);
      FileUtil.writeFile(file, text);
    } catch (IOException ex) {
      throw new RuntimeException(ex);
    }
  }

  private static String buildEditorStateText(EditorCell cell) {
    StringBuilder sb = new StringBuilder();
    buildEditorStateText(cell, sb, "");
    return sb.toString();
  }

  private static void buildEditorStateText(EditorCell cell, StringBuilder sb, String linePrefix) {
    buildCellText(cell, sb, linePrefix);
    if (cell instanceof EditorCell_Collection) {
      String childsPrefix = linePrefix + "\t";
      for (EditorCell child : Sequence.fromIterable((EditorCell_Collection) cell)) {
        buildEditorStateText(child, sb, childsPrefix);
      }
    }
  }

  private static void buildCellText(EditorCell cell, StringBuilder sb, String linePrefix) {
    sb.append(linePrefix).append(cell).append("@").append(System.identityHashCode(cell)).append(" / ").append(cell.getSNode()).append(" #").append(cell.getSNode().getNodeId()).append(" / xywh: ").append(cell.getX()).append(" ").append(cell.getY()).append(" ").append(cell.getWidth()).append(" ").append(cell.getHeight()).append(" / parent: @").append(System.identityHashCode(cell.getParent())).append("\n");

    buildGridText(check_3u0mg2_a0c0q(as_3u0mg2_a0a0c0q(cell, AbstractTableEditor.class)), sb, linePrefix + "\t\t# ");
    buildGridText(check_3u0mg2_a0d0q(as_3u0mg2_a0a0d0q(cell, TableEditor.class)), sb, linePrefix + "\t\t* ");
  }

  private static void buildGridText(Grid grid, StringBuilder sb, String linePrefix) {
    if (grid == null) {
      return;
    }
    appendLines(grid.toString(), sb, linePrefix);
  }

  private static void appendLines(String text, StringBuilder sb, String linePrefix) {
    String[] lines = text.split("\n");
    for (String line : lines) {
      sb.append(linePrefix).append(line).append("\n");
    }
  }

  private static File getProjectFolder(EditorCell cell) {
    Project project = ProjectHelper.getProject(cell.getContext().getRepository());
    if (project instanceof FileBasedProject) {
      return ((FileBasedProject) project).getProjectFile();
    }
    return new File(System.getProperty("user.home"));
  }

  private static String getStackTrace(Exception ex) {
    StringBuilder sb = new StringBuilder();
    for (StackTraceElement e : ex.getStackTrace()) {
      sb.append(e).append("\n");
    }
    return sb.toString();
  }
  private static Grid check_3u0mg2_a0c0q(AbstractTableEditor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getGrid();
    }
    return null;
  }
  private static Grid check_3u0mg2_a0d0q(TableEditor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getOriginalGrid();
    }
    return null;
  }
  private static <T> T as_3u0mg2_a0a0c0q(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_3u0mg2_a0a0d0q(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
