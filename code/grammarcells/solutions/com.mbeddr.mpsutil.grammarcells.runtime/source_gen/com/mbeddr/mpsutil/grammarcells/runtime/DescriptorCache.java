package com.mbeddr.mpsutil.grammarcells.runtime;

/*Generated by MPS */

import java.util.Map;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.classloading.DeployListener;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.ide.MPSCoreComponents;
import org.jetbrains.annotations.Nullable;
import java.util.Set;
import jetbrains.mps.module.ReloadableModule;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.smodel.LanguageAspect;
import de.slisson.mps.reflection.runtime.ReflectionUtil;

public class DescriptorCache {

  private static DescriptorCache INSTANCE = new DescriptorCache();

  public static DescriptorCache getInstance() {
    return INSTANCE;
  }

  private Map<SModule, IGrammarActionsDescriptor> loadedDescriptors = MapSequence.fromMap(new HashMap<SModule, IGrammarActionsDescriptor>());

  private DeployListener deployListener = null;

  public void invalidate() {
    MapSequence.fromMap(loadedDescriptors).clear();
  }

  public void dispose() {
    if (deployListener != null) {
      ApplicationManager.getApplication().getComponent(MPSCoreComponents.class).getClassLoaderManager().removeListener(deployListener);
    }
  }

  @Nullable
  public IGrammarActionsDescriptor getDescriptor(@Nullable SModule module) {
    IGrammarActionsDescriptor descriptor = doGetDescriptor(module);
    if (descriptor != null) {
      if (deployListener == null) {
        deployListener = new DeployListener() {
          public void onUnloaded(Set<ReloadableModule> p0, @NotNull ProgressMonitor p1) {
            invalidate();
          }
          public void onLoaded(Set<ReloadableModule> p0, @NotNull ProgressMonitor p1) {
            invalidate();
          }
        };
        ApplicationManager.getApplication().getComponent(MPSCoreComponents.class).getClassLoaderManager().addListener(deployListener);
      }
    }
    return descriptor;
  }

  @Nullable
  protected IGrammarActionsDescriptor doGetDescriptor(@Nullable SModule module) {
    if (module == null) {
      return null;
    }
    if (!(module instanceof ReloadableModule)) {
      return null;
    }
    ReloadableModule reloadableModule = (ReloadableModule) module;
    if (MapSequence.fromMap(loadedDescriptors).containsKey(module)) {
      return MapSequence.fromMap(loadedDescriptors).get(module);
    }
    IGrammarActionsDescriptor descriptor = null;
    try {
      String descriptorClassName = reloadableModule.getModuleName() + "." + LanguageAspect.EDITOR.getName() + "." + IGrammarActionsDescriptor.CLASS_NAME;
      Class descriptorClass = reloadableModule.getOwnClass(descriptorClassName);
      descriptor = ((IGrammarActionsDescriptor) ReflectionUtil.readField(descriptorClass, null, IGrammarActionsDescriptor.INSTANCE_FIELD_NAME));
    } catch (ClassNotFoundException ex) {
    }
    MapSequence.fromMap(loadedDescriptors).put(module, descriptor);
    return descriptor;
  }
}
