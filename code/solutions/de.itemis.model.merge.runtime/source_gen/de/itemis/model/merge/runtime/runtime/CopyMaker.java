package de.itemis.model.merge.runtime.runtime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.List;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.model.SReference;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class CopyMaker {
  private static final String MERGEDID_KEY = "MERGEID";

  public static SNode deepCopy(SNode originalNode) {
    return deepCopy(originalNode, newInstanceOf(originalNode));
  }

  public static SNode newInstanceOf(SNode originalNode) {
    SConcept concept = originalNode.getConcept();
    SNode newInstance = SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(concept));
    ((jetbrains.mps.smodel.SNode) newInstance).setId(originalNode.getNodeId());
    String mergeid = (String) originalNode.getUserObject(MERGEDID_KEY);
    newInstance.putUserObject(MERGEDID_KEY, mergeid);

    return newInstance;
  }

  private static SNode deepCopy(SNode originalNode, SNode newInstance) {
    for (SProperty property : Sequence.fromIterable(originalNode.getProperties())) {
      String value = originalNode.getProperty(property);
      newInstance.setProperty(property, value);
    }

    List<SNode> originalNodeAttributes = SLinkOperations.getChildren(((SNode) originalNode), LINKS.smodelAttribute$KJ43);

    List<SNode> attributesCopy = ListSequence.fromList(originalNodeAttributes).select((attribute) -> {
      SNode newInstanceOfAttribute = newInstanceOf(attribute);
      deepCopy(attribute, newInstanceOfAttribute);
      return SNodeOperations.cast(newInstanceOfAttribute, CONCEPTS.Attribute$g1);
    }).distinct().toList();

    ListSequence.fromList((SLinkOperations.getChildren(((SNode) newInstance), LINKS.smodelAttribute$KJ43))).addSequence(ListSequence.fromList(attributesCopy));

    Iterable<? extends SNode> children = originalNode.getChildren();
    for (SNode child : Sequence.fromIterable(children).subtract(ListSequence.fromList(originalNodeAttributes))) {
      SNode newInstanceOfChild = newInstanceOf(child);
      deepCopy(child, newInstanceOfChild);
      newInstance.addChild(child.getContainmentLink(), newInstanceOfChild);
    }

    for (SReference ref : Sequence.fromIterable(originalNode.getReferences())) {
      newInstance.setReference(ref.getLink(), ref.getTargetNodeReference());
    }

    return newInstance;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink smodelAttribute$KJ43 = MetaAdapterFactory.getContainmentLink(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, 0x47bf8397520e5942L, "smodelAttribute");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Attribute$g1 = MetaAdapterFactory.getConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x47bf8397520e5939L, "jetbrains.mps.lang.core.structure.Attribute");
  }
}
