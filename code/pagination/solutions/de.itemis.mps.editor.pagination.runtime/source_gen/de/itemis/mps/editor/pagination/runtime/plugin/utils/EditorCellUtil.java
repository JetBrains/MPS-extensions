package de.itemis.mps.editor.pagination.runtime.plugin.utils;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Collections;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import jetbrains.mps.baseLanguage.closures.runtime.YieldingIterator;
import java.util.Iterator;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.adapter.MetaAdapterByDeclaration;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.openapi.editor.EditorComponent;
import jetbrains.mps.project.Project;
import jetbrains.mps.openapi.navigation.NavigationSupport;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import org.jetbrains.mps.openapi.model.SNodeReference;
import org.jetbrains.mps.openapi.language.SConceptFeature;
import jetbrains.mps.openapi.editor.Editor;

public class EditorCellUtil {

  public static Iterable<EditorCell> getAncestors(final EditorCell cell, boolean includeStart) {
    if (cell == null) {
      return Sequence.fromIterable(Collections.<EditorCell>emptyList());
    }

    Iterable<EditorCell> initialCells = (includeStart ? Sequence.<EditorCell>singleton(cell) : Sequence.fromIterable(Collections.<EditorCell>emptyList()));

    return Sequence.fromIterable(initialCells).concat(Sequence.fromIterable(Sequence.fromClosure(() -> getAncestors(cell.getParent(), true))));
  }

  public static Iterable<EditorCell> getDescendants(EditorCell cell, boolean includeStart) {
    if (cell == null) {
      return Sequence.fromIterable(Collections.<EditorCell>emptyList());
    }

    Iterable<EditorCell> initialCells = (includeStart ? Sequence.<EditorCell>singleton(cell) : Sequence.fromIterable(Collections.<EditorCell>emptyList()));

    if (!(cell instanceof EditorCell_Collection)) {
      return initialCells;
    }
    final EditorCell_Collection cellAsCollection = as_eu2c9k_a0a5a3(cell, EditorCell_Collection.class);

    return Sequence.fromIterable(initialCells).concat(Sequence.fromIterable(Sequence.fromClosure(() -> {
      return (Iterable<EditorCell>) () -> {
        return new YieldingIterator<EditorCell>() {
          private int __CP__ = 0;
          protected boolean moveToNext() {
__loop__:
            do {
__switch__:
              switch (this.__CP__) {
                case -1:
                  assert false : "Internal error";
                  return false;
                case 2:
                  this._2_childEditorCell_it = cellAsCollection.iterator();
                case 3:
                  if (!(this._2_childEditorCell_it.hasNext())) {
                    this.__CP__ = 1;
                    break;
                  }
                  this._2_childEditorCell = this._2_childEditorCell_it.next();
                  this.__CP__ = 4;
                  break;
                case 5:
                  this.__CP__ = 3;
                  this.yield(_2_childEditorCell);
                  return true;
                case 0:
                  this.__CP__ = 2;
                  break;
                case 4:
                  this.__CP__ = 5;
                  break;
                default:
                  break __loop__;
              }
            } while (true);
            return false;
          }
          private EditorCell _2_childEditorCell;
          private Iterator<EditorCell> _2_childEditorCell_it;
        };
      };
    })).translate((childEditorCell) -> getDescendants(childEditorCell, true)));
  }

  public static SContainmentLink geContainmentLinkInRole(EditorCell paginatedCell) {
    SRepository repository = paginatedCell.getEditorComponent().getEditorContext().getRepository();
    SNode paginatedLinkDecl = check_eu2c9k_a0b0f(check_eu2c9k_a0a1a5(paginatedCell.getSRole()), repository);
    if (paginatedLinkDecl == null) {
      return null;
    }
    return MetaAdapterByDeclaration.getContainmentLink(paginatedLinkDecl);
  }

  public static SReferenceLink getReferenceLinkInRole(EditorCell refCell, SRepository repository) {
    SNode refCellLinkDecl = check_eu2c9k_a0a0h(check_eu2c9k_a0a0a7(refCell.getSRole()), repository);
    if (refCellLinkDecl == null) {
      return null;
    }
    return MetaAdapterByDeclaration.getReferenceLink(refCellLinkDecl);
  }

  public static SNode getReferenceTargetInRole(EditorCell refCell, SRepository repository) {
    SNode nodeForRefCell = refCell.getSNode();
    if (nodeForRefCell == null) {
      return null;
    }

    SReferenceLink refCellLink = getReferenceLinkInRole(refCell, repository);
    if (refCellLink == null) {
      return null;
    }

    return SLinkOperations.getTargetNode(SNodeOperations.getReference(nodeForRefCell, refCellLink));
  }

  public static EditorComponent openEditorComponentForNode(SNode node, Project project) {
    if (SNodeOperations.getModel(node) != null) {
      return check_eu2c9k_a0a0a11(NavigationSupport.getInstance().openNode(project, node, true, true));
    }
    return null;
  }

  public static Iterable<EditorCell> getNodesWithCell(Iterable<SNode> nodeSeq, final EditorComponent editorComponent) {
    return Sequence.fromIterable(nodeSeq).select((n) -> editorComponent.findNodeCell(n)).where(new NotNullWhereFilter());
  }

  private static SNode check_eu2c9k_a0b0f(SNodeReference checkedDotOperand, SRepository repository) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.resolve(repository);
    }
    return null;
  }
  private static SNodeReference check_eu2c9k_a0a1a5(SConceptFeature checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getSourceNode();
    }
    return null;
  }
  private static SNode check_eu2c9k_a0a0h(SNodeReference checkedDotOperand, SRepository repository) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.resolve(repository);
    }
    return null;
  }
  private static SNodeReference check_eu2c9k_a0a0a7(SConceptFeature checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getSourceNode();
    }
    return null;
  }
  private static EditorComponent check_eu2c9k_a0a0a11(Editor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCurrentEditorComponent();
    }
    return null;
  }
  private static <T> T as_eu2c9k_a0a5a3(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
