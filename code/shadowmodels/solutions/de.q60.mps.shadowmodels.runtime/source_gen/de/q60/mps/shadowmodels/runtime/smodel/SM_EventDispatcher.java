package de.q60.mps.shadowmodels.runtime.smodel;

/*Generated by MPS */

import java.util.Map;
import de.q60.mps.shadowmodels.runtime.engine.ITransformationEngine;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.WeakHashMap;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.module.SRepository;
import java.util.Objects;
import java.lang.ref.WeakReference;
import java.util.List;
import jetbrains.mps.smodel.event.SModelListener;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import de.q60.mps.incremental.runtime.IInvalidationListener;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.NodeReadAccessCasterInEditor;
import jetbrains.mps.smodel.NodeReadEventsCaster;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.modelix.model.mpsadapters.mps.ANode;
import org.jetbrains.mps.openapi.model.SModelReference;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.model.SNodeId;

public class SM_EventDispatcher {

  private static Map<ITransformationEngine, SM_EventDispatcher> instances = MapSequence.fromMap(new WeakHashMap<ITransformationEngine, SM_EventDispatcher>());
  public static SM_EventDispatcher getInstance(@NotNull ITransformationEngine engine, SRepository repository) {
    SM_EventDispatcher instance = MapSequence.fromMap(instances).get(engine);
    if (instance == null) {
      instance = new SM_EventDispatcher(engine, repository);
      MapSequence.fromMap(instances).put(engine, instance);
    }
    if (instance.repository == null) {
      instance.repository = repository;
    }
    if (repository != null && !(Objects.equals(repository, instance.repository))) {
      throw new RuntimeException(repository + " != " + instance.repository);
    }
    return instance;
  }

  private WeakReference<ITransformationEngine> engine;
  private SRepository repository;
  private List<SModelListener> smodelListeners = ListSequence.fromList(new ArrayList<SModelListener>());
  private List<org.jetbrains.mps.openapi.model.SModelListener> openapiSmodelListeners = ListSequence.fromList(new ArrayList<org.jetbrains.mps.openapi.model.SModelListener>());
  private IInvalidationListener invalidationListener = new IInvalidationListener() {
    @Override
    public void invalidated(Iterable<Object> keys) {
    }
    @Override
    public void invalidatedAll() {
      final SM_DummySModel model = SM_DummySModel.getInstance(engine.get(), repository);
      ListSequence.fromList(openapiSmodelListeners).visitAll((it) -> it.modelReplaced(model));
    }
  };

  public SM_EventDispatcher(ITransformationEngine engine, SRepository repository) {
    this.engine = new WeakReference<ITransformationEngine>(engine);
    engine.addInvalidationListener(invalidationListener);
  }

  public void addModelListener(SModelListener l) {
    ListSequence.fromList(smodelListeners).addElement(l);
  }

  public void removeModelListener(SModelListener l) {
    ListSequence.fromList(smodelListeners).removeElement(l);
  }

  public void addModelListener(org.jetbrains.mps.openapi.model.SModelListener l) {
    ListSequence.fromList(openapiSmodelListeners).addElement(l);
  }

  public void removeModelListener(org.jetbrains.mps.openapi.model.SModelListener l) {
    ListSequence.fromList(openapiSmodelListeners).removeElement(l);
  }

  public void propertyRead(SNode node, SProperty property, String value) {
    NodeReadAccessCasterInEditor.firePropertyReadAccessed(wrap(node), property.getName(), false);
    NodeReadEventsCaster.fireNodePropertyReadAccess(wrap(node), property.getName(), value);
  }

  public void referenceRead(SNode node, SReferenceLink link, @Nullable SNode target) {
    NodeReadAccessCasterInEditor.fireReferenceTargetReadAccessed(wrap(node), check_32c3fy_b0a0w(check_32c3fy_a1a0a22(target)), check_32c3fy_c0a0w(target));
    NodeReadEventsCaster.fireNodeReferentReadAccess(wrap(node), link.getName(), wrap(target));
  }

  public void firstChildRead(SNode parent, SNode child) {
    if (child != null) {
      NodeReadAccessCasterInEditor.fireNodeReadAccessed(wrap(child));
    }
  }

  public void lastChildRead(SNode parent, SNode child) {
    if (child != null) {
      NodeReadAccessCasterInEditor.fireNodeReadAccessed(wrap(child));
    }
  }

  public void childrenRead(SNode parent) {
  }

  public void childrenRead(SNode parent, SContainmentLink link) {
  }


  public void prevSiblingRead(SNode parent, SNode node, @Nullable SNode sibling) {
    siblingRead(parent, node, sibling);
  }

  public void nextSiblingRead(SNode parent, SNode node, @Nullable SNode sibling) {
    siblingRead(parent, node, sibling);
  }

  private void siblingRead(SNode parent, SNode node, @Nullable SNode sibling) {
    if (parent != null) {
      NodeReadAccessCasterInEditor.fireNodeReadAccessed(wrap(parent));
      NodeReadEventsCaster.fireNodeUnclassifiedReadAccess(wrap(parent));
    }
    if (sibling != null) {
      NodeReadAccessCasterInEditor.fireNodeReadAccessed(wrap(sibling));
      NodeReadEventsCaster.fireNodeUnclassifiedReadAccess(wrap(sibling));
    }
  }

  public void containmentLinkRead(SNode child) {
  }

  public void parentRead(SNode parent, SNode child) {
    if (parent != null) {
      NodeReadAccessCasterInEditor.fireNodeReadAccessed(wrap(parent));
      NodeReadEventsCaster.fireNodeUnclassifiedReadAccess(wrap(parent));
    }
  }

  public SNode wrap(SNode node) {
    return ANode.wrap(node);
  }
  private static SModelReference check_32c3fy_b0a0w(SModel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getReference();
    }
    return null;
  }
  private static SModel check_32c3fy_a1a0a22(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModel();
    }
    return null;
  }
  private static SNodeId check_32c3fy_c0a0w(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getNodeId();
    }
    return null;
  }
}
