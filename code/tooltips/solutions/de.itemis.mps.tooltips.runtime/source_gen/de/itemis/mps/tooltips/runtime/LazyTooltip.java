package de.itemis.mps.tooltips.runtime;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import de.slisson.mps.hacks.editor.EditorCellCreator;
import jetbrains.mps.openapi.editor.cells.EditorCellFactory;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.nodeEditor.EditorComponent;
import java.awt.Graphics;

public abstract class LazyTooltip {
  private static final String TOOLTIP_HINT = "de.itemis.mps.tooltips.editor.tooltip.tooltipHint";

  private TooltipId myTooltipId;
  private EditorCell myTooltipCell;
  private EditorContext myEditorContext;
  private SNode myNode;
  private EditorCellCreator myEditorCellCreator;
  private Boolean myIsEnabled = null;
  private boolean myDisableLazyLoading;

  public LazyTooltip(EditorContext context, SNode node, TooltipId tooltipId, boolean disableLazyLoading) {
    myEditorContext = context;
    myNode = node;
    myTooltipId = tooltipId;
    myDisableLazyLoading = disableLazyLoading;

    EditorCellFactory cellFactory = context.getEditorComponent().getUpdater().getCurrentUpdateSession().getCellFactory();
    if (cellFactory.getCellContext().getHints().contains(TOOLTIP_HINT)) {
      return;
    }

    if (disableLazyLoading) {
      myIsEnabled = isEnabled();
      if (myIsEnabled) {
        try {
          cellFactory.pushCellContext();
          cellFactory.addCellContextHints(TOOLTIP_HINT);
          myTooltipCell = buildTooltipCell();
        } finally {
          cellFactory.popCellContext();
        }
      }
    } else {
      if (TooltipLazyLoadingContext.getCurrentContext() != null) {
        try {
          cellFactory.pushCellContext();
          cellFactory.addCellContextHints(TOOLTIP_HINT);
          // This cell is create again for actually loading the tooltip.
          myTooltipCell = buildTooltipCell();
          TooltipLazyLoadingContext.getCurrentContext().registerTooltipCell(myTooltipId, myTooltipCell);
        } finally {
          cellFactory.popCellContext();
        }
      }
    }
  }

  public LazyTooltip(EditorContext context, SNode node, TooltipId tooltipId) {
    this(context, node, tooltipId, false);
  }

  protected abstract EditorCell buildTooltipCell();
  protected boolean isEnabled() {
    return true;
  }

  public boolean isInitialized() {
    return myIsEnabled != null;
  }

  @Nullable
  public EditorCell getTooltipCell() {
    if (myDisableLazyLoading) {
      return myTooltipCell;
    }

    if (myIsEnabled == null) {
      myIsEnabled = isEnabled();
    }
    if (!(myIsEnabled)) {
      return null;
    }
    if (myTooltipCell == null) {
      myEditorContext.getRepository().getModelAccess().runReadAction(() -> TooltipLazyLoadingContext.inNewContext(() -> {
        myEditorCellCreator = new EditorCellCreator(myEditorContext.getRepository());
        myEditorCellCreator.createEditorCell(myNode, ((EditorComponent) myEditorContext.getEditorComponent()).getEditorHintsForNode(myNode));
        myTooltipCell = TooltipLazyLoadingContext.getCurrentContext().getTooltipCell(myTooltipId);

      }));
    }
    return myTooltipCell;
  }

  public void paint(Graphics graphics) {
    if (myTooltipCell != null) {
      ((jetbrains.mps.nodeEditor.cells.EditorCell) myTooltipCell).paint(graphics);
    }
  }

  public void dispose() {
    if (myDisableLazyLoading) {
      return;
    }

    if (myEditorCellCreator != null) {
      myEditorCellCreator.dispose();
    }
    myEditorCellCreator = null;
    myTooltipCell = null;
  }
}
