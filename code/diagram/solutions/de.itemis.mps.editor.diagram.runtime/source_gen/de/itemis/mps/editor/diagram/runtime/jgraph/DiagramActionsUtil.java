package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.EditorContext;
import de.itemis.mps.editor.diagram.runtime.plugin.DiagramIdeaActionsUtil;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import org.jetbrains.annotations.Nullable;
import java.util.Set;
import de.itemis.mps.editor.diagram.runtime.model.Edge;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import de.itemis.mps.editor.diagram.runtime.model.Box;
import de.itemis.mps.editor.diagram.runtime.model.EndpointUtil;
import com.mxgraph.model.mxCell;
import de.itemis.mps.editor.diagram.runtime.model.IDiagramCell;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.project.Project;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.plugins.projectplugins.ProjectPluginManager;
import de.itemis.mps.editor.diagram.runtime.plugin.Diagram_Viewer_Tool;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.openapi.editor.Editor;
import jetbrains.mps.openapi.navigation.NavigationSupport;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.nodeEditor.cells.CellFinderUtil;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import de.itemis.mps.editor.diagram.runtime.model.Bounds;
import de.itemis.mps.editor.diagram.runtime.model.BoxBase;
import de.itemis.mps.editor.diagram.runtime.model.Point;
import java.util.LinkedList;
import de.itemis.mps.editor.diagram.runtime.model.EdgeLabel;
import de.itemis.mps.editor.diagram.runtime.model.EdgeLabelType;
import de.itemis.mps.editor.diagram.runtime.model.RelativePosition;
import de.itemis.mps.editor.diagram.runtime.model.Annotation;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class DiagramActionsUtil {

  public static void fitSizeAll(EditorContext editorContext, boolean selectionOnly) {
    BaseDiagramECell activeDiagram = DiagramIdeaActionsUtil.getActiveDiagram(editorContext);
    if (activeDiagram == null) {
      return;
    }
    MyGraph graph = activeDiagram.getContextGraph();
    fitSizeAll(graph, selectionOnly);
  }

  public static void fitSizeAll(MyGraph graph, boolean selectionOnly) {
    MyGraphModel model = graph.getModel();
    model.beginUpdate();
    try {
      List<BaseDCell> cells;
      if (selectionOnly) {
        cells = Sequence.fromIterable(Sequence.fromArray(graph.getSelectionCells())).ofType(BaseDCell.class).toList();
      } else {
        cells = ListSequence.fromList(ListSequence.fromListWithValues(new ArrayList<>(), model.getCells().values())).ofType(BaseDCell.class).toList();
      }
      for (BaseDCell cell : ListSequence.fromList(cells)) {
        BaseDCell box = ((BaseDCell) cell);
        box.fitSize();
      }
    } finally {
      model.endUpdate();
    }
  }

  public static void autoLayout(EditorContext editorContext) {
    BaseDiagramECell activeDiagram = DiagramIdeaActionsUtil.getActiveDiagram(editorContext);
    if (activeDiagram == null) {
      return;
    }

    BaseDiagramDCell dcell = ((BaseDiagramDCell) activeDiagram.getDCell());
    if (dcell == null) {
      return;
    }

    dcell.runLayouter();
  }

  public static void autoLayout(BaseDiagramDCell cell) {
    cell.runLayouter();
  }

  public static void clearLayoutData(RootDCell cell) {
    RootDiagramECell eCell = cell.getECell();
    final SNode node = eCell.getSNode();
    eCell.getEditorComponent().getEditorContext().getRepository().getModelAccess().executeCommand(() -> SNodeOperations.deleteNode(new IAttributeDescriptor.NodeAttribute(CONCEPTS.LayoutMap$4m).get(node)));
  }

  public static void toggleAllEdgesVisibility(MyGraph graph, @Nullable Object cell, final boolean visibility) {
    if (cell == null) {
      for (BoxBaseDCell boxCell : Sequence.fromIterable(Sequence.fromArray(graph.getChildCells(graph.getRootDCell()))).ofType(BoxBaseDCell.class)) {
        toggleAllEdgesVisibility(graph, boxCell, visibility);
      }
      return;
    }
    Set<Edge> edges = SetSequence.fromSet(new HashSet<Edge>());

    if (cell instanceof BoxDCell) {
      BoxDCell boxCell = ((BoxDCell) cell);
      final Box box = boxCell.getBox();

      SetSequence.fromSet(edges).addSequence(Sequence.fromIterable(box.getModel().getEdges()).where((it) -> EndpointUtil.getBox(it.getResolvedEndpointFrom()) == box || EndpointUtil.getBox(it.getResolvedEndpointTo()) == box));

    }

    SetSequence.fromSet(edges).visitAll((it) -> it.setVisible(visibility));

    BaseDiagramDCell parentDiagramDCell = JGraphUtil.getAncestor(((mxCell) cell), BaseDiagramDCell.class);
    IDiagramCell diagramCell = check_wg2tx2_a0i0l(parentDiagramDCell);
    if (diagramCell == null) {
      return;
    }

    graph.getRootDiagramModel().synchronizeWrite(graph.getGraphComponent().getDiagramCell());

    diagramCell.requestRelayout();
    diagramCell.relayout();
  }


  public static void hideEdge(MyGraph graph, Object cell) {
    if (cell instanceof EdgeDCell) {
      EdgeDCell edgeCell = ((EdgeDCell) cell);
      Edge edge = edgeCell.getEdge();
      if (edge != null) {
        edge.setVisible(false);
      }
    }

    BaseDiagramDCell parentDiagramDCell = JGraphUtil.getAncestor(((mxCell) cell), BaseDiagramDCell.class);
    IDiagramCell diagramCell = check_wg2tx2_a0d0o(parentDiagramDCell);
    if (diagramCell == null) {
      return;
    }

    graph.getRootDiagramModel().synchronizeWrite(graph.getGraphComponent().getDiagramCell());

    diagramCell.requestRelayout();
    diagramCell.relayout();
  }

  public static void moveToViewer(MyGraph graph, SRepository repository) {
    Project mpsProject = ProjectHelper.getProject(repository);
    if (mpsProject == null) {
      return;
    }
    com.intellij.openapi.project.Project ideaProject = ProjectHelper.toIdeaProject(mpsProject);
    if (ideaProject == null) {
      return;
    }

    if (ideaProject.getComponent(ProjectPluginManager.class).getTool(Diagram_Viewer_Tool.class) != null) {
      RootDCell rootCell = (RootDCell) graph.getDefaultParent();
      RootDiagramECell diagramCell = rootCell.getECell();
      ideaProject.getComponent(ProjectPluginManager.class).getTool(Diagram_Viewer_Tool.class).update(diagramCell, diagramCell.getEditorComponent(), true);
    }
  }

  public static void syncWithModel(MyGraph graph) {
    MyGraphComponent graphComponent = graph.getGraphComponent();
    graph.getRootDiagramModel().setForceReadFromModel(true);
    EditorComponent editorComponent = graphComponent.getEditorComponent();
    editorComponent.update();
  }

  public static void openNode(MyGraph graph, final SNode target) {
    final MyGraphComponent graphComponent = graph.getGraphComponent();
    RootDiagramECell diagramCell = graphComponent.getDiagramCell();
    EditorContext context = diagramCell.getContext();
    IOperationContext operationContext = context.getOperationContext();
    final Project project = operationContext.getProject();
    context.getRepository().getModelAccess().runWriteAction(() -> {
      boolean wasMaximized = graphComponent.isMaxmimizedMode();
      if (wasMaximized) {
        graphComponent.setMaximizedMode(false);
      }
      Editor editor = NavigationSupport.getInstance().openNode(project, target, true, true);
      if (editor != null && wasMaximized) {
        EditorCell selectedCell = editor.getEditorContext().getSelectedCell();
        RootDiagramECell rootDiagramCell = CellFinderUtil.findChildByConditionAndClass(selectedCell, (EditorCell c) -> true, RootDiagramECell.class, true, true);
        if (rootDiagramCell != null) {
          rootDiagramCell.getGraph().getGraphComponent().setMaximizedMode(true);
        }
      }
    });
  }

  public static void reorderPorts(MyGraph graph, Object cell) {
    if (cell instanceof BoxDCell) {
      BaseDCell box = ((BaseDCell) cell);

      Iterable<PortDCell> ports = ListSequence.fromList(JGraphUtil.getChildCells(box)).ofType(PortDCell.class);
      for (PortDCell port : Sequence.fromIterable(ports)) {
        port.getPort().setOrdinal(port.getNewOrdinal());
      }
    }

    graph.getRootDiagramModel().synchronizeWrite(graph.getGraphComponent().getDiagramCell());
  }

  public static void togglePortLabels(MyGraph graph) {
    MyGraphComponent graphComponent = graph.getGraphComponent();
    MyGraphComponent.MyGraphControl graphControl = (MyGraphComponent.MyGraphControl) graphComponent.getGraphControl();
    graphControl.togglePortsLabelsAlwaysVisible();
  }

  public static void translateToOrigin(MyGraph graph, int offsetX, int offsetY) {
    MyGraphComponent graphComponent = graph.getGraphComponent();

    final Wrappers._int leftmostX = new Wrappers._int(Integer.MAX_VALUE);
    final Wrappers._int topmostY = new Wrappers._int(Integer.MAX_VALUE);
    Sequence.fromIterable(graphComponent.getDiagramCell().myModel.getBoxes()).visitAll((it) -> {
      Bounds bounds = it.getBounds();
      leftmostX.value = (leftmostX.value < bounds.getXInt() ? leftmostX.value : bounds.getXInt());
      topmostY.value = (topmostY.value < bounds.getYInt() ? topmostY.value : bounds.getYInt());
    });

    final int translateX = -leftmostX.value + offsetX;
    final int translateY = -topmostY.value + offsetY;

    RootDiagramECell diagramCell = graphComponent.getDiagramCell();
    Sequence.fromIterable(diagramCell.myModel.getElements()).visitAll((it) -> {
      if (it instanceof BoxBase) {
        BoxBase crtBox = ((BoxBase) it);
        Bounds bounds = crtBox.getBounds();
        crtBox.setBounds(new Bounds(bounds.getX() + translateX, bounds.getY() + translateY, bounds.getWidth(), bounds.getHeight()));
      } else if (it instanceof Edge) {
        Edge crtEdge = ((Edge) it);
        List<Point> newAnchorPoints = ListSequence.fromList(new LinkedList<Point>());
        for (Point p : ListSequence.fromList(crtEdge.getAnchorPoints())) {
          ListSequence.fromList(newAnchorPoints).addElement(new Point(p.getX() + translateX, p.getY() + translateY));
        }
        crtEdge.setAnchorPoints(newAnchorPoints);
        EdgeLabel label = crtEdge.getLabel(EdgeLabelType.LABEL);
        RelativePosition position = label.getPosition();
        if (position != null) {
          position.setReferencePoint(position.getReferencePoint().getX() + translateX, position.getReferencePoint().getY() + translateY);
        }
      } else if (it instanceof Annotation) {
        Annotation crtAnnotation = ((Annotation) it);
        Bounds bounds = crtAnnotation.getBounds();
        crtAnnotation.setBounds(new Bounds(bounds.getX() + translateX, bounds.getY() + translateY, bounds.getWidth(), bounds.getHeight()));
      }
    });
    diagramCell.getDiagramModel().synchronizeWrite(diagramCell);
  }

  public static void updateViewer(com.intellij.openapi.project.Project ideaProject, RootDiagramECell rootCell, jetbrains.mps.openapi.editor.EditorComponent component) {
    if (ideaProject.getComponent(ProjectPluginManager.class).getTool(Diagram_Viewer_Tool.class) != null) {
      ideaProject.getComponent(ProjectPluginManager.class).getTool(Diagram_Viewer_Tool.class).update(rootCell, component, false);
    }
  }
  private static BaseDiagramECell check_wg2tx2_a0i0l(BaseDiagramDCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getECell();
    }
    return null;
  }
  private static BaseDiagramECell check_wg2tx2_a0d0o(BaseDiagramDCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getECell();
    }
    return null;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept LayoutMap$4m = MetaAdapterFactory.getConcept(0x8ca79d43eb454791L, 0xbdd40d6130ff895bL, 0x7c646f09bb3f148eL, "de.itemis.mps.editor.diagram.layout.structure.LayoutMap");
  }
}
