package de.slisson.mps.richtext.editor;

/*Generated by MPS */

import jetbrains.mps.editor.runtime.cells.AbstractCellAction;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import de.slisson.mps.editor.multiline.cells.EditorCell_Word;
import org.jetbrains.mps.util.Condition;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.openapi.editor.selection.SelectionManager;
import de.slisson.mps.editor.multiline.cells.EditorCell_Multiline;
import jetbrains.mps.internal.collections.runtime.Sequence;
import de.slisson.mps.richtext.runtime.selection.RichtextSelection;

public class MultilineWordCell_SelectAction extends AbstractCellAction {
  private CellActionType myActionType;
  private EditorCell_Word myWordCell;

  protected Condition<EditorCell> trueCondition = new Condition<EditorCell>() {
    public boolean met(EditorCell cell) {
      return true;
    }
  };

  public MultilineWordCell_SelectAction(CellActionType actionType, EditorCell_Word wordCell) {
    myActionType = actionType;
    myWordCell = wordCell;
  }
  public void execute(EditorContext context) {
    if (myActionType == CellActionType.SELECT_LEFT || myActionType == CellActionType.SELECT_RIGHT) {
      int newPosition = ((myActionType == CellActionType.SELECT_LEFT) ? myWordCell.getCaretPosition() - 1 : myWordCell.getCaretPosition() + 1);
      if (myWordCell.isCaretPositionAllowed(newPosition)) {
        myWordCell.setCaretPosition(newPosition, true);
        myWordCell.ensureCaretVisible();
        return;
      }
    }

    SelectionManager selectionManager = context.getEditorComponent().getSelectionManager();
    EditorCell_Multiline mlCell = myWordCell.getParent();
    int index = Sequence.fromIterable(mlCell.getWordCells()).indexOf(myWordCell);
    int wordStart = myWordCell.getParent().getTextBefore(myWordCell, 0).length();
    int selectionStart = ((isRightToLeft() ? myWordCell.getSelectionEnd() : myWordCell.getSelectionStart())) + wordStart;
    int selectionEnd = ((isRightToLeft() ? myWordCell.getSelectionStart() : myWordCell.getSelectionEnd())) + wordStart;
    RichtextSelection selection = new RichtextSelection(myWordCell.getEditor(), mlCell, 1, selectionStart, selectionEnd, isLeftToRight());
    if (myActionType == CellActionType.SELECT_HOME) {
      SelectionActions.SelectionHomeAction action = new SelectionActions.SelectionHomeAction(myWordCell);
      if (action.canExecute(context)) {
        action.execute(context);
      }
    } else if (myActionType == CellActionType.SELECT_END) {
      SelectionActions.SelectionEndAction action = new SelectionActions.SelectionEndAction(myWordCell);
      if (action.canExecute(context)) {
        action.execute(context);
      }
    } else {
      selectionManager.pushSelection(selection);
    }

    selection.executeAction(myActionType);
  }
  public boolean isLeftToRight() {
    return !(isRightToLeft());
  }
  public boolean isRightToLeft() {
    switch (myActionType) {
      case SELECT_LEFT:
      case SELECT_PREVIOUS:
      case SELECT_LOCAL_HOME:
      case SELECT_HOME:
      case SELECT_UP:
        return true;
      default:
        return false;
    }
  }
}
