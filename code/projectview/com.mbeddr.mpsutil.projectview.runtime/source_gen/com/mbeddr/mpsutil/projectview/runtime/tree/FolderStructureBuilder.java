package com.mbeddr.mpsutil.projectview.runtime.tree;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.ide.ui.tree.MPSTreeNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Map;
import java.util.TreeMap;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;

public class FolderStructureBuilder {

  public static void build(List<CustomTreeNode> nodes, MPSTreeNode parentNode) {
    Folder rootFolder = new Folder("root", null);

    for (CustomTreeNode node : ListSequence.fromList(nodes)) {
      Folder folder = rootFolder;
      Iterable<String> folders = node.getElement().getFolders();
      if (folders != null) {
        for (String folderName : folders) {
          if (folderName != null) {
            folder = folder.getOrCreateFolder(folderName, node.getElement().getFolderActionGroupId());
          }
        }
      }
      folder.addNode(node);
    }

    rootFolder.build(parentNode);
  }

  public static class Folder {
    private String myName;
    private String myActionGroupId;
    private Map<String, Folder> childFolders = new TreeMap<String, Folder>();
    private List<MPSTreeNode> childNodes = ListSequence.fromList(new ArrayList<MPSTreeNode>());

    public Folder(String name, String actionGroupId) {
      myName = name;
      myActionGroupId = actionGroupId;
    }

    public String getName() {
      return myName;
    }

    public Folder getOrCreateFolder(String name, String actionGroupId) {
      Folder child = MapSequence.fromMap(childFolders).get(name);
      if (child == null) {
        child = new Folder(name, actionGroupId);
        MapSequence.fromMap(childFolders).put(name, child);
      }
      return child;
    }

    public void addNode(MPSTreeNode node) {
      ListSequence.fromList(childNodes).addElement(node);
    }

    public void build(final MPSTreeNode thisFolderNode) {
      for (Folder childFolder : Sequence.fromIterable(MapSequence.fromMap(childFolders).values())) {
        FolderTreeNode subfolder = new FolderTreeNode(childFolder.getName(), childFolder.myActionGroupId);
        childFolder.build(subfolder);
        thisFolderNode.add(subfolder);
      }
      for (MPSTreeNode childNode : ListSequence.fromList(childNodes)) {
        thisFolderNode.add(childNode);
      }
      if (thisFolderNode instanceof FolderTreeNode) {
        while (thisFolderNode.getChildCount() == 1 && thisFolderNode.getFirstChild() instanceof FolderTreeNode) {
          FolderTreeNode singleSubFolder = (FolderTreeNode) thisFolderNode.getFirstChild();
          thisFolderNode.setText(thisFolderNode.getText() + "." + singleSubFolder.getText());
          thisFolderNode.setNodeIdentifier(thisFolderNode.getNodeIdentifier() + "." + singleSubFolder.getNodeIdentifier());
          thisFolderNode.removeAllChildren();
          ListSequence.fromList(Sequence.fromIterable(((Iterable<MPSTreeNode>) singleSubFolder)).toList()).visitAll((it) -> thisFolderNode.add(it));
        }
      }
    }
  }
}
