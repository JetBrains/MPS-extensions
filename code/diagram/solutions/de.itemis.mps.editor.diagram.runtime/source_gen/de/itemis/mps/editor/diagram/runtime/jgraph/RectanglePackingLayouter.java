package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import org.eclipse.elk.alg.rectpacking.p2packing.PackingStrategy;
import java.util.EnumSet;
import org.eclipse.elk.core.options.ContentAlignment;
import org.eclipse.elk.alg.rectpacking.options.OptimizationGoal;
import org.eclipse.elk.alg.rectpacking.p3whitespaceelimination.WhiteSpaceEliminationStrategy;
import org.eclipse.elk.alg.rectpacking.p1widthapproximation.WidthApproximationStrategy;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.eclipse.elk.alg.rectpacking.options.RectPackingOptions;
import org.eclipse.elk.core.data.LayoutMetaDataService;
import org.eclipse.elk.alg.rectpacking.options.RectPackingMetaDataProvider;
import org.eclipse.elk.graph.ElkNode;
import org.eclipse.elk.core.util.IElkProgressMonitor;
import de.itemis.mps.editor.diagram.runtime.model.IAccessorKey;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;

public class RectanglePackingLayouter extends ElkLayouter {
  protected Double aspectRatio;
  protected int compactionIterations;
  protected PackingStrategy compactionStrategy;
  protected EnumSet<ContentAlignment> contentAlignment;
  protected boolean fixedGraphSize;
  protected double nodeSpacing;
  protected boolean omitNodeMicroLayout;
  protected OptimizationGoal optimizationGoal;
  protected boolean rowHeightReevaluation;
  protected boolean shiftLastPlaced;
  protected double targetWidth;
  protected boolean tryBoxLayoutFirst;
  protected WhiteSpaceEliminationStrategy whiteSpaceEliminationStrategy;
  protected WidthApproximationStrategy widthApproximationStrategy;

  protected Map<Object, Integer> myDesiredIndexOfNodes = MapSequence.fromMap(new HashMap<Object, Integer>());
  protected Map<Object, Boolean> myInNewRows = MapSequence.fromMap(new HashMap<Object, Boolean>());

  public RectanglePackingLayouter() {
    super();
    myAlgorithm = RectPackingOptions.ALGORITHM_ID;
  }

  static {
    LayoutMetaDataService.getInstance().registerLayoutMetaDataProviders(new RectPackingMetaDataProvider());
  }

  @Override
  public boolean canLayoutLabels() {
    return false;
  }
  @Override
  protected boolean useDummyPort(EdgeDCell edge, boolean isTarget) {
    return false;
  }

  @Override
  protected void addLayoutInformationToGraph(ElkNode graph, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToGraph(graph, progressMonitor);
    ElkNode layout = graph;
    if (aspectRatio != null) {
      layout.setProperty(RectPackingOptions.ASPECT_RATIO, aspectRatio);
    }
    layout.setProperty(RectPackingOptions.PACKING_COMPACTION_ITERATIONS, compactionIterations);
    layout.setProperty(RectPackingOptions.PACKING_STRATEGY, compactionStrategy);
    layout.setProperty(RectPackingOptions.CONTENT_ALIGNMENT, contentAlignment);
    layout.setProperty(RectPackingOptions.NODE_SIZE_FIXED_GRAPH_SIZE, fixedGraphSize);
    layout.setProperty(RectPackingOptions.SPACING_NODE_NODE, nodeSpacing);
    layout.setProperty(RectPackingOptions.OMIT_NODE_MICRO_LAYOUT, omitNodeMicroLayout);
    layout.setProperty(RectPackingOptions.WIDTH_APPROXIMATION_OPTIMIZATION_GOAL, optimizationGoal);
    layout.setProperty(RectPackingOptions.PACKING_COMPACTION_ROW_HEIGHT_REEVALUATION, rowHeightReevaluation);
    layout.setProperty(RectPackingOptions.WIDTH_APPROXIMATION_LAST_PLACE_SHIFT, shiftLastPlaced);
    layout.setProperty(RectPackingOptions.WIDTH_APPROXIMATION_TARGET_WIDTH, targetWidth);
    layout.setProperty(RectPackingOptions.TRYBOX, tryBoxLayoutFirst);
    layout.setProperty(RectPackingOptions.WHITE_SPACE_ELIMINATION_STRATEGY, whiteSpaceEliminationStrategy);
    layout.setProperty(RectPackingOptions.WIDTH_APPROXIMATION_STRATEGY, widthApproximationStrategy);

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(layout, "graph", progressMonitor);
    }
  }

  @Override
  protected void addLayoutInformationToNode(ElkNode knode, BoxDCell box, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToNode(knode, box, progressMonitor);
    IAccessorKey ID = box.getBox().getAccessor().getId();
    Integer desiredIndex = MapSequence.fromMap(myDesiredIndexOfNodes).get(ID);
    if (desiredIndex != null) {
      knode.setProperty(RectPackingOptions.DESIRED_POSITION, desiredIndex);
    }

    Boolean inNewRow = MapSequence.fromMap(myInNewRows).get(ID);
    if (inNewRow != null) {
      knode.setProperty(RectPackingOptions.IN_NEW_ROW, inNewRow);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(knode, "node", progressMonitor);
    }
  }

  @Override
  public void setParentsStyle(Style style) {
    super.setParentsStyle(style);
    if (style.isSpecified(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-aspect-ratio"))) {
      this.aspectRatio = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-aspect-ratio"));
    }
    this.compactionIterations = style.get(StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-compaction-iterations"));
    this.compactionStrategy = style.get(StyleAttributes.getInstance().<PackingStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-compaction-strategy"));
    this.contentAlignment = style.get(StyleAttributes.getInstance().<EnumSet<ContentAlignment>>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-content-alignment"));
    this.fixedGraphSize = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-fixed-graph-size"));
    this.nodeSpacing = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-node-spacing"));
    this.omitNodeMicroLayout = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-omit-node-micro-layout"));
    this.optimizationGoal = style.get(StyleAttributes.getInstance().<OptimizationGoal>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-optimization-goal"));
    this.rowHeightReevaluation = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-row-height-reevaluation"));
    this.shiftLastPlaced = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-shift-last-placed"));
    this.targetWidth = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-target-width"));
    this.tryBoxLayoutFirst = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-try-box-layout-first"));
    this.whiteSpaceEliminationStrategy = style.get(StyleAttributes.getInstance().<WhiteSpaceEliminationStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-white-space-approximation-strategy"));
    this.widthApproximationStrategy = style.get(StyleAttributes.getInstance().<WidthApproximationStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-width-approximation-strategy"));
  }

  @Override
  public void addNodesStyle(Style style, Object key) {
    super.addNodesStyle(style, key);
    MapSequence.fromMap(myDesiredIndexOfNodes).put(key, style.get(StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-desired-index-of-node")));
    MapSequence.fromMap(myInNewRows).put(key, style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-rectpacking-in-new-row")));
  }
}
