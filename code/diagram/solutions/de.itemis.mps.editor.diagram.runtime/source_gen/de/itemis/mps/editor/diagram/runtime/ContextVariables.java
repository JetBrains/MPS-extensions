package de.itemis.mps.editor.diagram.runtime;

/*Generated by MPS */

import org.jetbrains.annotations.Nullable;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.Map;
import java.util.HashMap;

public class ContextVariables {

  private static ContextVariables myCurrentContext;

  protected static void pushContext() {
    myCurrentContext = new ContextVariables(myCurrentContext);
  }

  protected static void popContext() {
    myCurrentContext = myCurrentContext.myParent;
  }

  @Nullable
  public static ContextVariables getCurrent() {
    return myCurrentContext;
  }

  public static void enterNewContext(Runnable r) {
    try {
      pushContext();
      r.run();
    } finally {
      popContext();
    }
  }

  public static void withValue(final String key, final Object value, final Runnable r) {
    enterNewContext(() -> {
      getCurrent().setValue(key, value);
      r.run();
    });
  }

  public static void withParentAndValue(final ContextVariables parent, final String key, final Object value, final Runnable r) {
    withParentContext(parent, () -> withValue(key, value, r));
  }

  public static void withParentContext(final ContextVariables parent, final Runnable r) {
    ContextVariables previous = myCurrentContext;
    try {
      myCurrentContext = new ContextVariables(parent);
      r.run();
    } finally {
      myCurrentContext = previous;
    }
  }

  public Object getValue(String key) {
    Object value = MapSequence.fromMap(myValues).get(key);
    if (value != null) {
      return value;
    }
    if (myParent != null) {
      return myParent.getValue(key);
    }
    return null;
  }

  public void setValue(String key, Object value) {
    MapSequence.fromMap(myValues).put(key, value);
  }

  @Nullable
  private ContextVariables myParent;
  private Map<String, Object> myValues = MapSequence.fromMap(new HashMap<String, Object>());

  public ContextVariables(@Nullable ContextVariables parent) {
    myParent = parent;
  }


}
