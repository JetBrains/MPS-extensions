package de.q60.mps.shadowmodels.transformation.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractInferenceRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.InferenceRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import de.q60.mps.shadowmodels.transformation.behavior.IIfMacro__BehaviorDescriptor;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.structure.behavior.AbstractConceptDeclaration__BehaviorDescriptor;
import jetbrains.mps.typesystem.inference.EquationInfo;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class typeof_IIfMacro_InferenceRule extends AbstractInferenceRule_Runtime implements InferenceRule_Runtime {
  public typeof_IIfMacro_InferenceRule() {
  }
  public void applyRule(final SNode n, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {

    // Workaround for the typesystem not returning the most specific common supertype for two SNodeTypes
    {
      final SNode thenType = typeCheckingContext.typeOf(IIfMacro__BehaviorDescriptor.getThenPart_id7POzUCrfyOi.invoke(n), "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "6159853882136241438", true);
      typeCheckingContext.whenConcrete(thenType, () -> {
        {
          final SNode elseType = typeCheckingContext.typeOf(IIfMacro__BehaviorDescriptor.getElsePart_id7POzUCrfyOu.invoke(n), "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "6159853882136243362", true);
          typeCheckingContext.whenConcrete(elseType, () -> {
            Set<SNode> thenConcepts = SetSequence.fromSet(new HashSet<SNode>());
            Set<SNode> elseConcepts = SetSequence.fromSet(new HashSet<SNode>());

            _FunctionTypes._void_P2_E0<? super SNode, ? super Set<SNode>> collectConcepts = new _FunctionTypes._void_P2_E0<SNode, Set<SNode>>() {
              public void invoke(SNode c, Set<SNode> acc) {
                if (SNodeOperations.isInstanceOf(c, CONCEPTS.MeetType$ZG)) {
                  for (SNode a : ListSequence.fromList(SLinkOperations.getChildren(SNodeOperations.cast(c, CONCEPTS.MeetType$ZG), LINKS.argument$r2cT))) {
                    invoke(a, acc);
                  }
                } else if (SNodeOperations.isInstanceOf(c, CONCEPTS.SNodeType$hR)) {
                  invoke(SLinkOperations.getTarget(SNodeOperations.cast(c, CONCEPTS.SNodeType$hR), LINKS.concept$OMgE), acc);
                } else if (SNodeOperations.isInstanceOf(c, CONCEPTS.AbstractConceptDeclaration$KA)) {
                  if (!(SetSequence.fromSet(acc).contains(SNodeOperations.cast(c, CONCEPTS.AbstractConceptDeclaration$KA)))) {
                    SetSequence.fromSet(acc).addElement(SNodeOperations.cast(c, CONCEPTS.AbstractConceptDeclaration$KA));
                    for (SNode s : Sequence.fromIterable(AbstractConceptDeclaration__BehaviorDescriptor.getAllSuperConcepts_id2A8AB0rAWpG.invoke(SNodeOperations.cast(c, CONCEPTS.AbstractConceptDeclaration$KA), ((boolean) false)))) {
                      invoke(s, acc);
                    }
                  }
                }
              }
            };
            collectConcepts.invoke(typeCheckingContext.getExpandedNode(thenType), thenConcepts);
            collectConcepts.invoke(typeCheckingContext.getExpandedNode(elseType), elseConcepts);

            if (SetSequence.fromSet(thenConcepts).isNotEmpty() && SetSequence.fromSet(elseConcepts).isNotEmpty()) {
              Set<SNode> mostSpecificConcepts = SetSequence.fromSet(new HashSet<SNode>());
              for (final SNode commonConcept : SetSequence.fromSet(thenConcepts).intersect(SetSequence.fromSet(elseConcepts))) {
                SetSequence.fromSet(mostSpecificConcepts).removeSequence(Sequence.fromIterable(AbstractConceptDeclaration__BehaviorDescriptor.getAllSuperConcepts_id2A8AB0rAWpG.invoke(commonConcept, ((boolean) false))));
                if (!(SetSequence.fromSet(mostSpecificConcepts).any((it) -> (boolean) AbstractConceptDeclaration__BehaviorDescriptor.isSubconceptOf_id73yVtVlWOga.invoke(it, commonConcept)))) {
                  SetSequence.fromSet(mostSpecificConcepts).addElement(commonConcept);
                }
              }
              if (SetSequence.fromSet(mostSpecificConcepts).isEmpty()) {
                {
                  SNode _nodeToCheck_1029348928467 = n;
                  EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "6159853882137341249", 0, null);
                  typeCheckingContext.createEquation((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "6159853882137340615", true), (SNode) createSNodeType_21flxx_a1a0c0a0c0h0b0a1a0a1a0b0c0b(), _info_12389875345);
                }
              } else if (SetSequence.fromSet(mostSpecificConcepts).count() == 1) {
                {
                  SNode _nodeToCheck_1029348928467 = n;
                  EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "6159853882137366649", 0, null);
                  typeCheckingContext.createEquation((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "6159853882137366654", true), (SNode) createSNodeType_21flxx_a1a0c0a0a2a7a1a0b0a0b0a1a2a1(SetSequence.fromSet(mostSpecificConcepts).first()), _info_12389875345);
                }
              } else {
                SNode type = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x7a5dda6291404668L, 0xab76d5ed1746f2b2L, 0x114b68ad132L, "jetbrains.mps.lang.typesystem.structure.MeetType"));
                ListSequence.fromList(SLinkOperations.getChildren(type, LINKS.argument$r2cT)).addSequence(SetSequence.fromSet(mostSpecificConcepts).select((it) -> createSNodeType_21flxx_a0a0a0a0b0a2a7a1a0b0a0b0a1a2a1(it)));
                {
                  SNode _nodeToCheck_1029348928467 = n;
                  EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "6159853882137379967", 0, null);
                  typeCheckingContext.createEquation((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "6159853882137379977", true), (SNode) type, _info_12389875345);
                }
              }
            } else {
              {
                SNode _nodeToCheck_1029348928467 = IIfMacro__BehaviorDescriptor.getThenPart_id7POzUCrfyOi.invoke(n);
                EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5890381613100810424", 0, null);
                typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5890381613100810430", true), (SNode) typeCheckingContext.typeOf(n, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5890381613100810427", true), false, true, _info_12389875345);
              }
              {
                SNode _nodeToCheck_1029348928467 = IIfMacro__BehaviorDescriptor.getElsePart_id7POzUCrfyOu.invoke(n);
                EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5890381613100810737", 0, null);
                typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5890381613100810739", true), (SNode) typeCheckingContext.typeOf(n, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "5890381613100810744", true), false, true, _info_12389875345);
              }
            }
          }, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "6159853882136243360", false, false);
        }
      }, "r:fd3ba2d5-05a9-4b3b-93ad-a566c0e12538(de.q60.mps.shadowmodels.transformation.typesystem)", "6159853882136240389", false, false);
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.IIfMacro$Tk;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }
  private static SNode createSNodeType_21flxx_a1a0c0a0c0h0b0a1a0a1a0b0c0b() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.SNodeType$hR);
    return n0.getResult();
  }
  private static SNode createSNodeType_21flxx_a1a0c0a0a2a7a1a0b0a0b0a1a2a1(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.SNodeType$hR);
    n0.setReferenceTarget(LINKS.concept$OMgE, p0);
    return n0.getResult();
  }
  private static SNode createSNodeType_21flxx_a0a0a0a0b0a2a7a1a0b0a0b0a1a2a1(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.SNodeType$hR);
    n0.setReferenceTarget(LINKS.concept$OMgE, p0);
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept MeetType$ZG = MetaAdapterFactory.getConcept(0x7a5dda6291404668L, 0xab76d5ed1746f2b2L, 0x114b68ad132L, "jetbrains.mps.lang.typesystem.structure.MeetType");
    /*package*/ static final SConcept SNodeType$hR = MetaAdapterFactory.getConcept(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x108f968b3caL, "jetbrains.mps.lang.smodel.structure.SNodeType");
    /*package*/ static final SConcept AbstractConceptDeclaration$KA = MetaAdapterFactory.getConcept(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0x1103553c5ffL, "jetbrains.mps.lang.structure.structure.AbstractConceptDeclaration");
    /*package*/ static final SInterfaceConcept IIfMacro$Tk = MetaAdapterFactory.getInterfaceConcept(0x94b64715a2634c36L, 0xa1388da14705ffa7L, 0x7d748faa1b3e2cfbL, "de.q60.mps.shadowmodels.transformation.structure.IIfMacro");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink argument$r2cT = MetaAdapterFactory.getContainmentLink(0x7a5dda6291404668L, 0xab76d5ed1746f2b2L, 0x114b68ad132L, 0x114b68b040bL, "argument");
    /*package*/ static final SReferenceLink concept$OMgE = MetaAdapterFactory.getReferenceLink(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x108f968b3caL, 0x1090e46ca51L, "concept");
  }
}
