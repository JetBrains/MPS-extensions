package de.q60.mps.shadowmodels.runtime.smodel;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import jetbrains.mps.classloading.DeployListener;
import java.util.List;
import de.q60.mps.polymorphicfunctions.runtime.PFModule;
import de.q60.mps.util.invalidation.Invalidatable;
import de.q60.mps.polymorphicfunctions.runtime.DescriptorCache;
import jetbrains.mps.smodel.MPSModuleRepository;
import java.util.Set;
import jetbrains.mps.module.ReloadableModule;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.classloading.ClassLoaderManager;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.ide.MPSCoreComponents;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.classloading.ModuleClassLoader;
import jetbrains.mps.internal.collections.runtime.Sequence;

public class SM_TransformationsFromGlobalRepository extends SM_TransformationsFromRepository {
  private static final Logger LOG = Logger.getLogger(SM_TransformationsFromGlobalRepository.class);

  private static final SM_TransformationsFromGlobalRepository INSTANCE = new SM_TransformationsFromGlobalRepository();

  public static SM_TransformationsFromGlobalRepository getInstance() {
    return INSTANCE;
  }

  private DeployListener deployListener = null;
  private List<PFModule> pfModules;
  private Invalidatable invalidatable = new Invalidatable("Transformation aspect descriptors", () -> {
    DescriptorCache.getInstance().invalidate();
    invalidate();
  });

  public SM_TransformationsFromGlobalRepository() {
    super(MPSModuleRepository.getInstance());
  }

  @Override
  public Iterable<PFModule> getPFModules() {
    if (deployListener == null) {
      deployListener = new DeployListener() {
        public void onUnloaded(Set<ReloadableModule> modules, @NotNull ProgressMonitor p1) {
          invalidate();
        }
        public void onLoaded(Set<ReloadableModule> modules, @NotNull ProgressMonitor p1) {
          invalidate();
        }
      };
      ClassLoaderManager classLoaderManager = ApplicationManager.getApplication().getComponent(MPSCoreComponents.class).getClassLoaderManager();
      classLoaderManager.addListener(deployListener);
    }

    if (pfModules != null) {
      if (ListSequence.fromList(pfModules).select((it) -> it.getClass().getClassLoader()).ofType(ModuleClassLoader.class).any((it) -> it.isDisposed())) {
        pfModules = null;
      }
    }

    if (pfModules == null) {
      MPSModuleRepository.getInstance().getModelAccess().runReadAction(() -> pfModules = Sequence.fromIterable(super_getPFModules()).toList());
    }
    return pfModules;
  }

  private Iterable<PFModule> super_getPFModules() {
    return super.getPFModules();
  }

  public void invalidate() {
    if (LOG.isDebugLevel()) {
      LOG.debug("Invalidate Transformation Descriptors Cache");
    }
    pfModules = null;
  }

  public void dispose() {
    if (deployListener != null) {
      ClassLoaderManager classLoaderManager = ApplicationManager.getApplication().getComponent(MPSCoreComponents.class).getClassLoaderManager();
      classLoaderManager.removeListener(deployListener);
    }
    invalidatable.dispose();
  }
}
