package de.slisson.mps.tables.runtime.cells;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import de.slisson.mps.tables.runtime.gridmodel.Grid;
import jetbrains.mps.internal.collections.runtime.IMapping;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.openapi.editor.cells.CellAction;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.awt.Graphics;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import com.intellij.ui.ColorUtil;
import com.intellij.ui.JBColor;

public class RowEndCell extends EditorCell_Constant {

  private boolean myLeftEnd;

  public RowEndCell(EditorContext context, SNode snode, boolean leftEnd) {
    super(context, snode, "", false);
    myLeftEnd = leftEnd;

    // INSERT action is only called on cells that have SRole set
    setSRole(DummySLink.INSTANCE);
    ChildsTracker.getInstance().registerChild(this);
  }

  public boolean isLeft() {
    return myLeftEnd;
  }

  public void initializeActions(Grid grid) {
    for (IMapping<CellActionType, _FunctionTypes._return_P2_E0<? extends CellAction, ? super EditorCell, ? super Boolean>> entry : MapSequence.fromMap(grid.getEndCellActionsCreator())) {
      this.setAction(entry.key(), entry.value().invoke(this, myLeftEnd));
    }
  }

  @Override
  public void paintContent(Graphics graphics, ParentSettings settings) {
    super.paintContent(graphics, settings);

    EditorCell selectedCell = getContext().getSelectedCell();
    if (getTopmostTable(selectedCell) == getTopmostTable(this)) {
      graphics.setColor(ColorUtil.withAlpha(JBColor.BLACK, 0.117));
      graphics.fillRect(getX() + getLeftGap(), getY() + 1, getWidth() - getLeftGap() - getRightGap(), getHeight() - 2);
    }

  }

  protected static TableEditor getTopmostTable(EditorCell descendant) {
    TableEditor result = null;
    for (EditorCell c = descendant; c != null; c = c.getParent()) {
      if (c instanceof TableEditor) {
        result = (TableEditor) c;
      }
    }
    return result;
  }


  @Override
  public void setWidth(int i) {
    super.setWidth(i);
  }

  @Override
  public String getRole() {
    // if this methods returns null, the insert action is not always executed
    return "";
  }
}
