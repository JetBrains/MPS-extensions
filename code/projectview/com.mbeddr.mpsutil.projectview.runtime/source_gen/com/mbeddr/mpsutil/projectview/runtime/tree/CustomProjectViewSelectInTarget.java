package com.mbeddr.mpsutil.projectview.runtime.tree;

/*Generated by MPS */

import jetbrains.mps.ide.projectPane.AbstractProjectViewSelectInTarget;
import com.intellij.ide.SelectInContext;
import org.jetbrains.mps.openapi.model.SModel;
import com.intellij.openapi.vfs.VirtualFile;
import jetbrains.mps.fileTypes.MPSFileTypesManager;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.smodel.SModelFileTracker;
import jetbrains.mps.ide.project.ProjectHelper;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.ide.ui.tree.module.ProjectModuleTreeNode;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.ide.vfs.IdeaFileSystem;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.nodefs.MPSNodeVirtualFile;
import com.intellij.openapi.fileEditor.FileEditor;
import com.intellij.openapi.fileEditor.FileEditorManager;
import jetbrains.mps.ide.editor.MPSFileNodeEditor;
import jetbrains.mps.openapi.editor.EditorComponent;

public class CustomProjectViewSelectInTarget extends AbstractProjectViewSelectInTarget {

  private CustomProjectView myView;

  public CustomProjectViewSelectInTarget(CustomProjectView view) {
    super(view.getProject(), view.getId(), view.getWeight(), view.getTitle());
    myView = view;
  }
  @Override
  public boolean canSelect(SelectInContext context) {
    return getNode(context) != null || getModel(context) != null || getModule(context) != null;
  }
  @Override
  protected void doSelectIn(SelectInContext context, boolean requestFocus) {
    if (getNode(context) != null) {
      myView.selectNode(getNode(context), requestFocus);
    } else
    if (getModel(context) != null) {
      myView.selectModel(getModel(context), requestFocus);
    } else
    if (getModule(context) != null) {
      myView.selectModule(getModule(context), requestFocus);
    }
  }
  private SModel getModel(SelectInContext context) {
    VirtualFile virtualFile = context.getVirtualFile();
    if (!(MPSFileTypesManager.isModelFile(virtualFile))) {
      return null;
    }
    IFile modelFile = toIFile(virtualFile);
    if (modelFile == null) {
      return null;
    }
    return SModelFileTracker.getInstance(ProjectHelper.getProjectRepository(context.getProject())).findModel(modelFile);
  }
  private SModule getModule(SelectInContext context) {
    VirtualFile virtualFile = context.getVirtualFile();
    if (!(MPSFileTypesManager.isModuleFile(virtualFile))) {
      return null;
    }
    IFile moduleFile = toIFile(virtualFile);
    if (moduleFile == null) {
      return null;
    }
    ProjectModuleTreeNode module = new ProjectTreeFindHelper(myView.getTree()).findModuleTreeNode(moduleFile);
    return check_10rqz3_a5a7(module);
  }

  @Nullable
  private IFile toIFile(VirtualFile vf) {
    IdeaFileSystem fs = myView.getMPSProject().getFileSystem();
    return (fs.canConvert(vf) ? fs.fromVirtualFile(vf) : null);
  }

  private SNode getNode(SelectInContext context) {
    VirtualFile virtualFile = context.getVirtualFile();
    if (!(virtualFile instanceof MPSNodeVirtualFile)) {
      return null;
    }
    MPSNodeVirtualFile file = (MPSNodeVirtualFile) virtualFile;
    FileEditor[] editors = FileEditorManager.getInstance(myView.getProject()).getEditors(file);
    if (editors.length != 0) {
      FileEditor editor = editors[0];
      if (!(editor instanceof MPSFileNodeEditor)) {
        return null;
      }
      EditorComponent editorComponent = ((MPSFileNodeEditor) editor).getNodeEditor().getCurrentEditorComponent();
      if (editorComponent == null) {
        return null;
      }
      return editorComponent.getEditedNode();
    } else {
      return file.getNode();
    }
  }
  private static SModule check_10rqz3_a5a7(ProjectModuleTreeNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModule();
    }
    return null;
  }
}
