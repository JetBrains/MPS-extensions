package de.q60.mps.shadowmodels.runtime.engine;

/*Generated by MPS */

import org.modelix.model.api.INode;
import org.modelix.model.api.INodeReference;
import org.jetbrains.annotations.NotNull;
import org.modelix.model.area.IArea;
import org.jetbrains.annotations.Nullable;
import org.modelix.model.api.IConcept;
import org.modelix.model.api.IConceptReference;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.modelix.model.api.IChildLink;
import org.modelix.model.api.ILanguageRepository;
import java.util.List;
import org.modelix.model.api.IProperty;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.modelix.model.api.IReferenceLink;

public class OutputNodeReferenceAsNode implements INode, INodeReference {
  @NotNull
  public static INode create(@NotNull ITransformationEngine engine, @NotNull IOutputNodeReference ref) {
    if (ref instanceof NodeAsOutputNodeReference) {
      return ((NodeAsOutputNodeReference) ref).getNode();
    } else {
      return new OutputNodeReferenceAsNode(engine, ref);
    }
  }

  private ITransformationEngine engine;
  private IOutputNodeReference ref;

  protected OutputNodeReferenceAsNode(@NotNull ITransformationEngine engine, @NotNull IOutputNodeReference ref) {
    this.engine = engine;
    this.ref = ref;
  }

  protected INode wrap(IOutputNodeReference node) {
    if (node == null) {
      return null;
    }
    return DependencyTrackingNode.unwrap(OutputNodeReferenceAsNode.create(engine, node));
  }

  protected INode wrapChild(IOutputNodeReference child, String role) {
    if (child == null) {
      return null;
    }
    engine.rememberContainment(child, new KnownContainment(ref, role));
    return OutputNodeReferenceAsNode.create(engine, child);
  }

  @NotNull
  @Override
  public IArea getArea() {
    return new TransformationOutputArea(engine);
  }

  public ITransformationEngine getEngine() {
    return this.engine;
  }

  public IOutputNodeReference getOutputNodeReference() {
    return this.ref;
  }

  public IOutputNode resolveNode() {
    return ref.resolve(engine);
  }

  @Nullable
  @Override
  public INode resolveNode(IArea context) {
    return (this.isValid() ? this : null);
  }

  @Override
  public boolean isValid() {
    return resolveNode() != null;
  }

  @Override
  public INodeReference getReference() {
    return this;
  }

  @Override
  public IConcept getConcept() {
    return resolveNode().getConcept();
  }

  @Nullable
  @Override
  public IConceptReference getConceptReference() {
    return resolveNode().getConcept().getReference();
  }

  public IContainment getContainment() {
    IContainment containment = engine.resolveContainment(ref);
    if (containment == null) {
      containment = IContainment.NULL;
    }
    return containment;
  }

  @Override
  public String getRoleInParent() {
    return getContainment().getRole();
  }

  @Override
  public INode getParent() {
    return wrap(getContainment().getParent());
  }

  @Override
  public Iterable<INode> getChildren(final String role) {
    return Sequence.fromIterable(resolveNode().getChildren(role)).select((it) -> wrapChild(it, role));
  }

  @Override
  public Iterable<INode> getAllChildren() {
    final IOutputNode n = resolveNode();
    Iterable<IChildLink> childLinks = n.getConcept().getAllChildLinks();
    return Sequence.fromIterable(childLinks).translate((final IChildLink link) -> Sequence.fromIterable(n.getChildren(link.getName())).select((child) -> wrapChild(child, link.getName())));
  }

  @Override
  public void moveChild(String role, int index, INode node) {
    throw new UnsupportedOperationException();
  }

  @Override
  public INode addNewChild(String role, int index, @Nullable IConcept concept) {
    resolveNode().addNewChild(role, index, concept);
    return null;
  }
  @NotNull
  @Override
  public INode addNewChild(@Nullable String role, int index, @Nullable IConceptReference concept) {
    return addNewChild(role, index, ILanguageRepository.Companion.resolveConcept(concept));
  }

  @Override
  public void removeChild(INode child) {
    throw new UnsupportedOperationException();
  }

  @Override
  public INode getReferenceTarget(String role) {
    return wrap(resolveNode().getReferenceTarget(role));
  }

  @Nullable
  @Override
  public INodeReference getReferenceTargetRef(@NotNull String role) {
    return getReferenceTarget(role).getReference();
  }

  @Override
  public void setReferenceTarget(String role, INode target) {
    resolveNode().setReferenceTarget(role, target);
  }

  @Override
  public void setReferenceTarget(@NotNull String role, @Nullable INodeReference target) {
    throw new UnsupportedOperationException();
  }

  @Override
  public String getPropertyValue(String role) {
    return resolveNode().getPropertyValue(role);
  }

  @Override
  public void setPropertyValue(String role, String value) {
    resolveNode().setPropertyValue(role, value);
  }

  @NotNull
  @Override
  public List<String> getPropertyRoles() {
    List<IProperty> allProperties = getConcept().getAllProperties();
    return ListSequence.fromList(allProperties).select((it) -> it.getName()).toList();
  }
  @NotNull
  @Override
  public List<String> getReferenceRoles() {
    List<IReferenceLink> links = getConcept().getAllReferenceLinks();
    return ListSequence.fromList(links).select((it) -> it.getName()).toList();
  }

  @Override
  public String toString() {
    return "" + ref;
  }

  @Override
  public boolean equals(Object o) {
    if (this == o) {
      return true;
    }
    if (o == null || this.getClass() != o.getClass()) {
      return false;
    }

    OutputNodeReferenceAsNode that = (OutputNodeReferenceAsNode) o;
    if ((engine != null ? !(engine.equals(that.engine)) : that.engine != null)) {
      return false;
    }
    if ((ref != null ? !(ref.equals(that.ref)) : that.ref != null)) {
      return false;
    }

    return true;
  }

  @Override
  public int hashCode() {
    int result = 0;
    result = 31 * result + ((engine != null ? ((Object) engine).hashCode() : 0));
    result = 31 * result + ((ref != null ? ((Object) ref).hashCode() : 0));
    return result;
  }
}
