package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import org.eclipse.elk.alg.spore.options.CompactionStrategy;
import org.eclipse.elk.alg.spore.options.SpanningTreeCostFunction;
import org.eclipse.elk.alg.spore.options.RootSelection;
import org.eclipse.elk.alg.spore.options.StructureExtractionStrategy;
import org.eclipse.elk.alg.spore.options.TreeConstructionStrategy;
import org.eclipse.elk.alg.spore.options.SporeCompactionOptions;
import org.eclipse.elk.core.data.LayoutMetaDataService;
import org.eclipse.elk.alg.spore.options.SporeMetaDataProvider;
import org.eclipse.elk.graph.ElkNode;
import org.eclipse.elk.core.util.IElkProgressMonitor;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;

public class SPOrECompactionLayouter extends ElkLayouter {
  protected CompactionStrategy compactionStrategy;
  protected SpanningTreeCostFunction spanningTreeCostFunction;
  protected double nodeSpacing;
  protected boolean orthogonalCompaction;
  protected String processingOrderPreferredRoot;
  protected RootSelection processingOrderRootSelection;
  protected StructureExtractionStrategy structureExtractionStrategy;
  protected TreeConstructionStrategy treeConstructionStrategy;
  protected String underlyingLayoutAlgorithm;
  protected ElkLayouter layouterForAlgorithmInstance;

  public SPOrECompactionLayouter() {
    super();
    myAlgorithm = SporeCompactionOptions.ALGORITHM_ID;
  }

  static {
    LayoutMetaDataService.getInstance().registerLayoutMetaDataProviders(new SporeMetaDataProvider());
  }

  @Override
  public boolean canLayoutLabels() {
    return false;
  }

  @Override
  protected boolean useDummyPort(EdgeDCell edge, boolean isTarget) {
    return false;
  }

  @Override
  protected void addLayoutInformationToGraph(ElkNode graph, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToGraph(graph, progressMonitor);
    ElkNode layout = graph;
    layout.setProperty(SporeCompactionOptions.COMPACTION_COMPACTION_STRATEGY, compactionStrategy);
    layout.setProperty(SporeCompactionOptions.PROCESSING_ORDER_SPANNING_TREE_COST_FUNCTION, spanningTreeCostFunction);
    layout.setProperty(SporeCompactionOptions.SPACING_NODE_NODE, nodeSpacing);
    layout.setProperty(SporeCompactionOptions.COMPACTION_ORTHOGONAL, orthogonalCompaction);
    layout.setProperty(SporeCompactionOptions.PROCESSING_ORDER_PREFERRED_ROOT, processingOrderPreferredRoot);
    layout.setProperty(SporeCompactionOptions.PROCESSING_ORDER_ROOT_SELECTION, processingOrderRootSelection);
    layout.setProperty(SporeCompactionOptions.STRUCTURE_STRUCTURE_EXTRACTION_STRATEGY, structureExtractionStrategy);
    layout.setProperty(SporeCompactionOptions.PROCESSING_ORDER_TREE_CONSTRUCTION, treeConstructionStrategy);

    if (layouterForAlgorithmInstance != null) {
      layout.setProperty(SporeCompactionOptions.UNDERLYING_LAYOUT_ALGORITHM, underlyingLayoutAlgorithm);
      layouterForAlgorithmInstance.addLayoutInformationToGraph(graph, progressMonitor);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(layout, "graph", progressMonitor);
    }
  }

  @Override
  public void setParentsStyle(Style style) {
    super.setParentsStyle(style);
    this.compactionStrategy = style.get(StyleAttributes.getInstance().<CompactionStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-spore-compaction-strategy"));
    this.spanningTreeCostFunction = style.get(StyleAttributes.getInstance().<SpanningTreeCostFunction>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-spore-cost-function-for-spanning-tree"));
    this.nodeSpacing = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-node-spacing"));
    this.orthogonalCompaction = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-spore-orthogonal-compaction"));
    this.processingOrderPreferredRoot = style.get(StyleAttributes.getInstance().<String>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-spore-root-node-for-spanning-tree-construction"));
    this.processingOrderRootSelection = style.get(StyleAttributes.getInstance().<RootSelection>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-spore-root-selection-for-spanning-tree"));
    this.structureExtractionStrategy = style.get(StyleAttributes.getInstance().<StructureExtractionStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-spore-structure-extraction-strategy"));
    this.treeConstructionStrategy = style.get(StyleAttributes.getInstance().<TreeConstructionStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-spore-tree-construction-strategy"));
    this.underlyingLayoutAlgorithm = style.get(StyleAttributes.getInstance().<String>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-spore-underlying-layout-algorithm"));

    ElkLayouter usedLayouter = LayouterManager.getLayouterForAlgorithm(this.underlyingLayoutAlgorithm);

    if (this.underlyingLayoutAlgorithm != null && !(usedLayouter instanceof SPOrECompactionLayouter) && !(usedLayouter instanceof SPOrEOverlapRemovalLayouter)) {
      layouterForAlgorithmInstance = usedLayouter;
      layouterForAlgorithmInstance.setParentsStyle(style);
    }
  }

}
