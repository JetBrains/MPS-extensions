package com.mbeddr.mpsutil.grammarcells.generatorutils;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.mbeddr.mpsutil.grammarcells.behavior.ICellWrapper__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class GeneratorUtils {

  public static SNode getCellToUnwrap(final SNode deletedCell) {
    SNode rootCell = getRootCell(deletedCell);
    List<SNode> wrapperCells = SNodeOperations.getNodeDescendants(rootCell, CONCEPTS.WrapperCell$wv, false, new SAbstractConcept[]{});
    Iterable<SNode> wrappedCells = ListSequence.fromList(wrapperCells).select((it) -> SNodeOperations.as(ICellWrapper__BehaviorDescriptor.getWrappedLeaf_id3O7ZvCZLQaV.invoke(it), CONCEPTS.CellModel_RefNode$8)).where((it) -> SLinkOperations.getTarget(it, LINKS.relationDeclaration$E2hc) != null);

    return Sequence.fromIterable(wrappedCells).findFirst((it) -> SLinkOperations.getTarget(it, LINKS.relationDeclaration$E2hc) != SLinkOperations.getTarget(SNodeOperations.as(deletedCell, CONCEPTS.CellModel_RefNode$8), LINKS.relationDeclaration$E2hc));
  }

  public static SNode getRootCell(SNode deletedCell) {
    return ListSequence.fromList(SNodeOperations.getNodeAncestors(deletedCell, CONCEPTS.EditorCellModel$gN, false)).last();
  }

  public static boolean isBefore(SNode deletedCell, SNode unwrappedLink) {
    List<SNode> leafsAfter = CellModelTraversalUtil.collectLeafsBeforeAfter(deletedCell, true, CONCEPTS.GrammarInfoCell$HL);
    return ListSequence.fromList(leafsAfter).select((it) -> SLinkOperations.getTarget(SNodeOperations.as(it, CONCEPTS.CellModel_RefNode$8), LINKS.relationDeclaration$E2hc)).contains(unwrappedLink);
  }

  public static boolean isConstant(SNode cell) {
    return SNodeOperations.isInstanceOf(cell, CONCEPTS.CellModel_Constant$4e) || SNodeOperations.isInstanceOf(cell, CONCEPTS.IConstantCell$y2) || SNodeOperations.isInstanceOf(cell, CONCEPTS.CellModel_ReadOnlyModelAccessor$6d);
  }

  public static boolean isCollection(SNode cell) {
    return SNodeOperations.isInstanceOf(cell, CONCEPTS.CellModel_Collection$Og) || SNodeOperations.isInstanceOf(cell, CONCEPTS.ICollectionLikeCell$Y);
  }

  public static boolean componentCellRequiresInline(SNode componentCell) {
    if ((new IAttributeDescriptor.NodeAttribute(CONCEPTS.DisableComponentInline$Ng).get(componentCell) != null)) {
      return false;
    }
    if (componentRequiresInline(SLinkOperations.getTarget(componentCell, LINKS.editorComponent$DNa7))) {
      return true;
    }

    SNode rootCell = ListSequence.fromList(SNodeOperations.getNodeAncestors(componentCell, CONCEPTS.EditorCellModel$gN, false)).last();
    if (ListSequence.fromList(SNodeOperations.getNodeDescendants(rootCell, CONCEPTS.EditorCellModel$gN, true, new SAbstractConcept[]{})).any((it) -> cellRequiresComponentInline(it))) {
      return true;
    }

    return false;
  }

  public static boolean componentRequiresInline(SNode componentDecl) {
    return ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(componentDecl, LINKS.cellModel$L8Uc), CONCEPTS.EditorCellModel$gN, true, new SAbstractConcept[]{})).any((it) -> cellRequiresComponentInline(it));
  }

  public static boolean cellRequiresComponentInline(SNode cell) {
    return SNodeOperations.isInstanceOf(cell, CONCEPTS.IActionGeneratingCell$DN) || SNodeOperations.isInstanceOf(cell, CONCEPTS.IGrammarCell$v$);
  }

  public static boolean ignoreActionsFrom(SNode cell) {
    SNode component = SNodeOperations.getNodeAncestor(cell, CONCEPTS.EditorComponentDeclaration$WM, false, false);
    if (component == null) {
      return false;
    }
    return componentRequiresInline(component);
  }

  public static boolean allowActionsFrom(SNode cell) {
    return !(ignoreActionsFrom(cell));
  }

  public static SNode getRenderingCondition(SNode cell) {
    return ListSequence.fromList(SNodeOperations.getNodeAncestors(cell, CONCEPTS.EditorCellModel$gN, true)).select((it) -> SLinkOperations.getTarget(it, LINKS.renderingCondition$O1b5)).findFirst((it) -> (it != null));
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept WrapperCell$wv = MetaAdapterFactory.getConcept(0x9d69e71978c84286L, 0x90dbfb19c107d049L, 0x6630b0153289825dL, "com.mbeddr.mpsutil.grammarcells.structure.WrapperCell");
    /*package*/ static final SConcept CellModel_RefNode$8 = MetaAdapterFactory.getConcept(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xf9eb05cdc7L, "jetbrains.mps.lang.editor.structure.CellModel_RefNode");
    /*package*/ static final SConcept EditorCellModel$gN = MetaAdapterFactory.getConcept(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xf9eafb9a39L, "jetbrains.mps.lang.editor.structure.EditorCellModel");
    /*package*/ static final SConcept GrammarInfoCell$HL = MetaAdapterFactory.getConcept(0x9d69e71978c84286L, 0x90dbfb19c107d049L, 0x29cc3d1b55ff5285L, "com.mbeddr.mpsutil.grammarcells.structure.GrammarInfoCell");
    /*package*/ static final SConcept CellModel_ReadOnlyModelAccessor$6d = MetaAdapterFactory.getConcept(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0x11d6d56c00cL, "jetbrains.mps.lang.editor.structure.CellModel_ReadOnlyModelAccessor");
    /*package*/ static final SConcept CellModel_Constant$4e = MetaAdapterFactory.getConcept(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xf9eb01232eL, "jetbrains.mps.lang.editor.structure.CellModel_Constant");
    /*package*/ static final SInterfaceConcept IConstantCell$y2 = MetaAdapterFactory.getInterfaceConcept(0x9d69e71978c84286L, 0x90dbfb19c107d049L, 0x27b90b5c5707f207L, "com.mbeddr.mpsutil.grammarcells.structure.IConstantCell");
    /*package*/ static final SInterfaceConcept ICollectionLikeCell$Y = MetaAdapterFactory.getInterfaceConcept(0xb4f35ed845af4efaL, 0xabe400ac26956e69L, 0x5d1c7fe110fe3bb8L, "com.mbeddr.mpsutil.grammarcells.runtimelang.structure.ICollectionLikeCell");
    /*package*/ static final SConcept CellModel_Collection$Og = MetaAdapterFactory.getConcept(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xf9eaff2517L, "jetbrains.mps.lang.editor.structure.CellModel_Collection");
    /*package*/ static final SConcept DisableComponentInline$Ng = MetaAdapterFactory.getConcept(0x9d69e71978c84286L, 0x90dbfb19c107d049L, 0x231b79e4b09eb750L, "com.mbeddr.mpsutil.grammarcells.structure.DisableComponentInline");
    /*package*/ static final SInterfaceConcept IGrammarCell$v$ = MetaAdapterFactory.getInterfaceConcept(0x9d69e71978c84286L, 0x90dbfb19c107d049L, 0x27b90b5c56f5af94L, "com.mbeddr.mpsutil.grammarcells.structure.IGrammarCell");
    /*package*/ static final SInterfaceConcept IActionGeneratingCell$DN = MetaAdapterFactory.getInterfaceConcept(0x9d69e71978c84286L, 0x90dbfb19c107d049L, 0x6630b015328a6ef4L, "com.mbeddr.mpsutil.grammarcells.structure.IActionGeneratingCell");
    /*package*/ static final SConcept EditorComponentDeclaration$WM = MetaAdapterFactory.getConcept(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xfb35c2bb47L, "jetbrains.mps.lang.editor.structure.EditorComponentDeclaration");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink relationDeclaration$E2hc = MetaAdapterFactory.getReferenceLink(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0x10964446123L, 0x10973779681L, "relationDeclaration");
    /*package*/ static final SReferenceLink editorComponent$DNa7 = MetaAdapterFactory.getReferenceLink(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xfb35c96896L, 0xfb35c96897L, "editorComponent");
    /*package*/ static final SContainmentLink cellModel$L8Uc = MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xfba0eb7c50L, 0xfba0ec5415L, "cellModel");
    /*package*/ static final SContainmentLink renderingCondition$O1b5 = MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xf9eafb9a39L, 0x10a19696199L, "renderingCondition");
  }
}
