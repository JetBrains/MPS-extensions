package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import com.mxgraph.canvas.mxGraphics2DCanvas;
import com.mxgraph.view.mxCellState;
import com.mxgraph.shape.mxIShape;
import java.util.Map;
import java.awt.Graphics2D;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import java.util.List;
import de.itemis.mps.editor.diagram.runtime.CompartmentCell;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.openapi.editor.style.Style;
import de.itemis.mps.editor.diagram.styles.editor.StyleUtils;
import com.mxgraph.util.mxPoint;
import java.awt.geom.Line2D;
import de.itemis.mps.editor.diagram.runtime.shape.IShape;
import java.awt.Shape;
import de.itemis.mps.editor.diagram.runtime.shape.GradientShapeStyle;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import de.itemis.mps.editor.diagram.runtime.model.IDiagramCell;
import jetbrains.mps.internal.collections.runtime.Sequence;

public class DrawUtil {
  public static void drawShape(mxGraphics2DCanvas canvas, mxCellState state) {
    mxIShape shape = state.getShape();
    if (shape == null) {
      Map<String, Object> style = state.getStyle();
      shape = canvas.getShape(style);
    }
    shape.paintShape(canvas, state);
  }

  public static void drawCompartments(Graphics2D g, final EditorCell parentCell, final mxCellState state, double offsetX, final double offsetY, final double scale) {
    final List<CompartmentCell> compartmentCells = new ArrayList<CompartmentCell>();
    collectCompartmentCells(parentCell, compartmentCells);

    executeWithGraphicsCopy(g, new _FunctionTypes._void_P1_E0<Graphics2D>() {
      public void invoke(Graphics2D g) {
        for (CompartmentCell compartmentCell : ListSequence.fromList(compartmentCells)) {
          Style style = compartmentCell.getStyle();
          StyleUtils.configureLineStyle(g, style, scale);
          JGraphUtil.convertToView(state.getView(), new mxPoint(state.getX(), state.getY()));
          double y = state.getY() + offsetY * 1.0 + (compartmentCell.getY() - parentCell.getY()) * scale + 1;
          double x1 = state.getX();
          double x2 = state.getX() + state.getWidth();


          Line2D.Double line = new Line2D.Double(x1 + 1, y, x2, y);
          Object cell = state.getCell();
          mxIShape mxshape = check_t7np37_a0k0a0b0d0c(as_t7np37_a0a0k0a0a0a1a3a2(cell, BoxDCell.class));
          IShape wrapped = check_t7np37_a0l0a0b0d0c(as_t7np37_a0a0l0a0a0a1a3a2(mxshape, ShapeAdapter.class));
          Shape shape = check_t7np37_a0m0a0b0d0c(wrapped, state);
          if (shape != null) {
            g.clip(shape);
          }
          g.draw(line);

        }
      }
    });
  }

  public static void drawCompartments(Graphics2D g, final MPSCell mpsCell, final mxCellState state) {
    double scale = state.getView().getScale();
    DrawUtil.executeWithGraphicsCopy(g, new _FunctionTypes._void_P1_E0<Graphics2D>() {
      public void invoke(Graphics2D g) {
        new GradientShapeStyle(true).configureBorder(g, JGraphUtil.toRectangle2D(state));
        Style style = mpsCell.getEditorCell().getStyle();
        drawCompartments(g, mpsCell.getEditorCell(), state, mpsCell.getStateRelativeX(), mpsCell.getStateRelativeY(), mpsCell.getTotalScale());
      }
    });
  }

  private static void collectCompartmentCells(EditorCell parent, List<CompartmentCell> accumulator) {
    if (parent instanceof CompartmentCell) {
      accumulator.add(((CompartmentCell) parent));
    }
    if (parent instanceof EditorCell_Collection && !(parent instanceof IDiagramCell)) {
      for (EditorCell child : Sequence.fromIterable(((EditorCell_Collection) parent))) {
        collectCompartmentCells(child, accumulator);
      }
    }
  }

  public static void executeWithGraphicsCopy(Graphics2D g, _FunctionTypes._void_P1_E0<? super Graphics2D> draw) {
    Graphics2D g2 = (Graphics2D) g.create();
    try {
      draw.invoke(g2);
    } finally {
      g2.dispose();
    }
  }

  public static void executeWithGraphicsCopy(final Graphics2D g, final mxGraphics2DCanvas canvas, final _FunctionTypes._void_P1_E0<? super Graphics2D> draw) {
    executeWithGraphicsCopy(g, (Graphics2D g2) -> {
      Graphics2D prevG = canvas.getGraphics();
      try {
        canvas.setGraphics(g2);
        draw.invoke(g2);
      } finally {
        canvas.setGraphics(prevG);
      }
    });
  }

  private static mxIShape check_t7np37_a0k0a0b0d0c(BoxDCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getShape();
    }
    return null;
  }
  private static IShape check_t7np37_a0l0a0b0d0c(ShapeAdapter checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getWrapped();
    }
    return null;
  }
  private static Shape check_t7np37_a0m0a0b0d0c(IShape checkedDotOperand, mxCellState state) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getShape(ExtensionMethods.toRectangle2D(state));
    }
    return null;
  }
  private static <T> T as_t7np37_a0a0k0a0a0a1a3a2(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_t7np37_a0a0l0a0a0a1a3a2(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
