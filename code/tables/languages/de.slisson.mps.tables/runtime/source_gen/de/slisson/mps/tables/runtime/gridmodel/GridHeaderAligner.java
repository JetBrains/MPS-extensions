package de.slisson.mps.tables.runtime.gridmodel;

/*Generated by MPS */

import jetbrains.mps.internal.collections.runtime.Sequence;
import de.slisson.mps.tables.runtime.simplegrid.SimpleGrid;
import java.util.List;
import java.util.Set;
import java.util.HashSet;

public class GridHeaderAligner {

  private static boolean alignmentDisabled = false;

  public static void withAlignmentDisabled(Runnable runnable) {
    boolean wasDisabled = alignmentDisabled;
    try {
      alignmentDisabled = true;
      runnable.run();
    } finally {
      alignmentDisabled = wasDisabled;
    }
  }

  public static void alignColumnsAndRows(Grid grid, int x, int y, Grid subgrid) {
    GridHeaderAligner merger = new GridHeaderAligner(grid);
    merger.alignColumnsAndRows(x, y, subgrid);
  }


  private Grid myGrid;

  protected GridHeaderAligner(Grid grid) {
    myGrid = grid;
  }

  public void alignColumnsAndRows(int x, int y, Grid subgrid) {
    if (alignmentDisabled) {
      return;
    }
    boolean hasRowHeaders = !(myGrid.rowHeadersEmpty()) || !(subgrid.rowHeadersEmpty());
    for (int pass = 1; pass <= 2; pass++) {
      alignColumns_(x, y, subgrid);
      if (hasRowHeaders) {
        // TODO does subgrid must be transposed, too?
        myGrid.transpose();
        alignColumns_(y, x, subgrid);
        myGrid.transpose();
      }
    }
  }

  protected boolean hasRowHeaders(IGrid grid) {
    if (!(grid.getRowHeaders().isEmpty())) {
      return true;
    }
    for (IGridElement element : Sequence.fromIterable(grid)) {
      if (element instanceof IGrid) {
        IGrid subgrid = ((IGrid) element);
        if (hasRowHeaders(subgrid)) {
          return true;
        }
      }
    }

    return false;
  }

  private void alignColumns_(int x, int y, Grid subgrid) {
    moveChildHeadersToParent(x, y, subgrid);
    sortChildByParentColumns(x, y, subgrid);
  }

  private void moveChildHeadersToParent(int x, int y, Grid subgrid) {
    // move headers to parent grid if all new
    if (subgrid.getColumnHeadersSizeX() > 0 && !(anyElementInBoth(subgrid.getColumnHeaders(), myGrid.getColumnHeaders().subgridSafe(x, x + subgrid.getSpanX() - 1, -1, -1)))) {
      int requiredAdditionalColumns = subgrid.getColumnHeadersSizeX() - subgrid.getSpanX();
      for (int i = 0; i < requiredAdditionalColumns; i++) {
        myGrid.insertColumnAndSpan(x + 1);
      }
      int parentY = getFreeColumnHeadersY(x, x + subgrid.getColumnHeadersSizeX() - 1);
      for (int childX = 0; childX < subgrid.getColumnHeadersSizeX(); childX++) {
        for (int childY = 0; childY < subgrid.getColumnHeadersSizeY(); childY++) {
          myGrid.setColumnHeader(x + childX, parentY + childY, subgrid.getColumnHeader(childX, childY));
        }
      }
    }
  }

  private void sortChildByParentColumns(int x, int y, IGrid subgrid) {
    // sort columns of child by the headers in parent
    if (myGrid.getColumnHeadersSizeY() == 1 && subgrid.getColumnHeadersSizeY() == 1) {
      SimpleGrid<HeaderReference> columnGrid = myGrid.getColumnHeaders();
      List<HeaderReference> parentHeaders = columnGrid.getRow(0);
      for (int parentIndex = x; parentIndex < parentHeaders.size(); parentIndex++) {
        if (parentHeaders.get(parentIndex) == null) {
          continue;
        }
        // spanning headers are not supported yet
        if (GridUtils.getSpanningBounds(parentIndex, 0, columnGrid).getWidth() > 1) {
          continue;
        }
        SimpleGrid<HeaderReference> subgridColumnGrid = subgrid.getColumnHeaders();
        int subgridIndex = subgridColumnGrid.getRow(0).indexOf(parentHeaders.get(parentIndex));
        if (subgridIndex != -1) {
          // spanning headers are not supported yet
          if (GridUtils.getSpanningBounds(subgridIndex, 0, subgridColumnGrid).getWidth() > 1) {
            continue;
          }
          subgrid.ensureSize(parentIndex + 1 - x, subgrid.getSizeY());
          subgrid.moveColumn(subgridIndex, parentIndex - x);
        }
      }
    }
  }

  private int getFreeColumnHeadersY(int fromX, int toX) {
    int freeYStart = myGrid.getColumnHeadersSizeY();
    for (int y = freeYStart - 1; y >= 0; y--) {
      if (isColumnHeadersYFree(fromX, toX, y)) {
        freeYStart = y;
      }
    }
    return freeYStart;
  }

  private boolean isColumnHeadersYFree(int fromX, int toX, int y) {
    if (y >= myGrid.getColumnHeadersSizeY()) {
      return true;
    }
    for (int x = fromX; x <= toX; x++) {
      if (myGrid.getColumnHeader(x, y) != null) {
        return false;
      }
    }
    return true;
  }

  private boolean anyElementInBoth(SimpleGrid g1, SimpleGrid g2) {
    Set g1Elements = new HashSet();
    for (Object e : g1) {
      g1Elements.add(e);
    }
    for (Object e : g2) {
      if (e != null && g1Elements.contains(e)) {
        return true;
      }
    }
    return false;
  }

}
