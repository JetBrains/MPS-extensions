package de.itemis.mps.editor.celllayout.runtime;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import de.itemis.mps.editor.celllayout.boxmodel.LayoutBox;
import de.itemis.mps.editor.celllayout.boxmodel.Size;
import de.itemis.mps.editor.celllayout.boxmodel.LayoutBoxFrame;
import de.itemis.mps.editor.celllayout.boxmodel.LayoutBoxFrameExtensions;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.openapi.editor.cells.EditorCell_Label;

public class LayoutableAdapter extends AbstractLayoutableAdapter {
  private static final Logger LOG = Logger.getLogger(LayoutableAdapter.class);

  public LayoutableAdapter(EditorCell cell) {
    super(cell);
  }

  @Override
  public void writeSyncAll() {
    int oldX = myCell.getX();
    int oldY = myCell.getY();
    myBoxModel.writeSync(true);
    int newX = myCell.getX();
    int newY = myCell.getY();

    int oldWidth = myCell.getWidth();
    int oldHeight = myCell.getHeight();
    if (myCell.wasRelayoutRequested()) {
      CellLayoutUtil.relayout(myCell);
    }
  }

  @Override
  public void readSyncAll() {
    if (isGrowX() || isGrowY()) {
      myCell.requestRelayout();
    }
    myCell.relayout();

    LayoutBox expectedBounds = getBoxModel().getBorderBox().getInnerBox();
    if (myCell.wasRelayoutRequested() || myCell.getWidth() != expectedBounds.getWidth() || myCell.getHeight() != expectedBounds.getHeight() || isChanged()) {
      CellLayoutUtil.relayout(myCell);
    }
    super.readSyncAll();
  }

  @Override
  public void setSize(int width, int height) {
    Size minSize = getMinSize(new Size(width, height));
    Size maxSize = getMaxSize(new Size(width, height));
    if (width < minSize.getWidth()) {
      if (LOG.isWarningLevel()) {
        LOG.warning("Width set to " + width + ". Minimum width is " + minSize.getWidth());
      }
    }
    if (width > maxSize.getWidth()) {
      if (LOG.isWarningLevel()) {
        LOG.warning("Width set to " + width + ". Maximum width is " + maxSize.getWidth());
      }
    }
    if (height < minSize.getHeight()) {
      if (LOG.isWarningLevel()) {
        LOG.warning("Height set to " + height + ". Minimum height is " + minSize.getHeight());
      }
    }
    if (height > maxSize.getHeight()) {
      if (LOG.isWarningLevel()) {
        LOG.warning("Height set to " + height + ". Maximum height is " + maxSize.getHeight());
      }
    }

    int deltaW = width - myBoxModel.getMarginBox().getWidth();
    int deltaH = height - myBoxModel.getMarginBox().getHeight();
    LayoutBoxFrame additionalPadding = myBoxModel.getAdditionalPadding();
    int deltaR = Math.max(-additionalPadding.getRightSize(), deltaW);
    int deltaL = deltaW - deltaR;
    int deltaT = Math.max(-additionalPadding.getLeftSize(), deltaH);
    int deltaB = deltaH - deltaT;
    LayoutBoxFrameExtensions.addLeftSize(additionalPadding, deltaL);
    LayoutBoxFrameExtensions.addRightSize(additionalPadding, deltaR);
    LayoutBoxFrameExtensions.addTopSize(additionalPadding, deltaT);
    LayoutBoxFrameExtensions.addBottomSize(additionalPadding, deltaB);
    additionalPadding.move(deltaL, deltaT);
    updateAlignment();
  }

  protected void updateAlignment() {
    LayoutBoxFrame additionalPadding = myBoxModel.getAdditionalPadding();
    if (CellLayoutUtil.isAlignRight(this)) {
      additionalPadding.setLeftSize(additionalPadding.getLeftSize() + additionalPadding.getRightSize());
      additionalPadding.setRightSize(0);
    } else if (CellLayoutUtil.isAlignHorizontalCenter(this)) {
      int total = additionalPadding.getLeftSize() + additionalPadding.getRightSize();
      int left = total / 2;
      int right = total - left;
      additionalPadding.setLeftSize(left);
      additionalPadding.setRightSize(right);
    } else {
      additionalPadding.setRightSize(additionalPadding.getLeftSize() + additionalPadding.getRightSize());
      additionalPadding.setLeftSize(0);
    }
  }

  @Override
  public void setHeight(int height) {
    setSize(getWidth(), height);
  }

  @Override
  public void setWidth(int width) {
    setSize(width, getHeight());
  }

  @NotNull
  @Override
  public Size getPreferredSize(@NotNull Size sizeConstraint) {
    int width = myBoxModel.getMarginBox().getWidth();
    width -= myBoxModel.getAdditionalPadding().getLeftSize();
    width -= myBoxModel.getAdditionalPadding().getRightSize();
    int height = myBoxModel.getMarginBox().getHeight();
    height -= myBoxModel.getAdditionalPadding().getTopSize();
    height -= myBoxModel.getAdditionalPadding().getBottomSize();
    return new Size(width, height);
  }

  @NotNull
  @Override
  public Size getMinSize(@NotNull Size sizeConstraint) {
    return getPreferredSize(sizeConstraint);
  }

  @Override
  public int getAscent(@NotNull Size size) {
    int ascent = myBoxModel.getMarginBox().getAscent();
    return Math.min(ascent, size.getHeight());
  }

  @NotNull
  @Override
  public Size getMaxSize(@NotNull Size sizeConstraint) {
    Size size = getPreferredSize(sizeConstraint);
    if (myCell instanceof EditorCell_Label) {
      size = size.deriveWidth(Size.UNLIMITED);
    }
    if (isGrowX()) {
      size = size.deriveWidth(Size.UNLIMITED);
    }
    if (isGrowY()) {
      size = size.deriveHeight(Size.UNLIMITED);
    }
    return size;
  }
}
