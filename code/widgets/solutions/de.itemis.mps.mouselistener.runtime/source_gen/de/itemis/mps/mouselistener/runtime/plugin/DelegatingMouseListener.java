package de.itemis.mps.mouselistener.runtime.plugin;

/*Generated by MPS */

import java.awt.event.MouseListener;
import java.awt.event.MouseMotionListener;
import java.util.Map;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.WeakHashMap;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.lang.ref.WeakReference;
import java.awt.event.MouseEvent;
import jetbrains.mps.nodeEditor.cells.EditorCell;
import de.itemis.mps.mouselistener.runtime.MouseListenerProvider;

public class DelegatingMouseListener implements MouseListener, MouseMotionListener {

  private static Map<EditorComponent, DelegatingMouseListener> instances = MapSequence.fromMap(new WeakHashMap<EditorComponent, DelegatingMouseListener>());

  public static DelegatingMouseListener getOrCreateInstance(EditorComponent editorComponent) {
    DelegatingMouseListener instance = MapSequence.fromMap(DelegatingMouseListener.instances).get(editorComponent);
    if (instance == null) {
      instance = new DelegatingMouseListener(editorComponent);
      MapSequence.fromMap(DelegatingMouseListener.instances).put(editorComponent, instance);
    }
    return instance;
  }

  @Nullable
  public static DelegatingMouseListener getInstance(EditorComponent editorComponent) {
    return MapSequence.fromMap(instances).get(editorComponent);
  }

  public static void uninstallAll() {
    for (DelegatingMouseListener instance : ListSequence.fromListWithValues(new ArrayList<DelegatingMouseListener>(), MapSequence.fromMap(instances).values())) {
      instance.uninstall();
    }
  }

  private WeakReference<EditorComponent> myEditorComponent;
  private MouseMotionListener myLastMotionListener;

  public DelegatingMouseListener(EditorComponent editorComponent) {
    myEditorComponent = new WeakReference<EditorComponent>(editorComponent);
    editorComponent.addDisposeListener(new EditorComponent.EditorDisposeListener() {
      public void editorWillBeDisposed(EditorComponent editorComponent) {
        editorComponent.removeDisposeListener(this);
        uninstall();
      }
    });

  }

  public EditorComponent getEditorComponent() {
    return myEditorComponent.get();
  }

  public void install() {
    getEditorComponent().addMouseListener(this);
    getEditorComponent().addMouseMotionListener(this);
  }

  public void uninstall() {
    getEditorComponent().removeMouseListener(this);
    getEditorComponent().removeMouseMotionListener(this);
    MapSequence.fromMap(instances).removeKey(getEditorComponent());
  }

  public <T> T findListenerAtMouse(MouseEvent e, Class<T> type) {
    if (!(getEditorComponent().isFocusOwner())) {
      return null;
    }
    EditorCell myRootCell = getEditorComponent().getRootCell();
    if (myRootCell == null) {
      return null;
    }
    jetbrains.mps.openapi.editor.cells.EditorCell cell = myRootCell.findLeaf(e.getX(), e.getY());
    while (cell != null) {
      if (cell instanceof MouseListenerProvider) {
        T listener = getListenerFromProvider(((MouseListenerProvider) cell), type);
        if (listener != null) {
          return listener;
        }
      }
      if (type.isInstance(cell)) {
        return (T) cell;
      }
      cell = cell.getParent();
    }
    return null;
  }

  public <T> T getListenerFromProvider(MouseListenerProvider provider, Class<T> type) {
    if (type.isAssignableFrom(MouseListener.class)) {
      return (T) provider.getMouseListener();
    } else if (type.isAssignableFrom(MouseMotionListener.class)) {
      return (T) provider.getMouseMotionListener();
    } else {
      return null;
    }
  }

  @Override
  public void mouseClicked(MouseEvent e) {
    MouseListener listener = findListenerAtMouse(e, MouseListener.class);
    if (listener != null) {
      listener.mouseClicked(e);
    }
  }
  @Override
  public void mouseDragged(MouseEvent e) {
    MouseMotionListener listener = findListenerAtMouse(e, MouseMotionListener.class);
    if (listener != null) {
      listener.mouseDragged(e);
    }
  }
  @Override
  public void mouseEntered(MouseEvent e) {
    MouseListener listener = findListenerAtMouse(e, MouseListener.class);
    if (listener != null) {
      listener.mouseEntered(e);
    }
  }
  @Override
  public void mouseExited(MouseEvent e) {
    MouseListener listener = findListenerAtMouse(e, MouseListener.class);
    if (listener != null) {
      listener.mouseExited(e);
    }
  }
  @Override
  public void mouseMoved(MouseEvent e) {
    MouseMotionListener listener = findListenerAtMouse(e, MouseMotionListener.class);
    if (myLastMotionListener != null && myLastMotionListener != listener) {
      // Because there are no enter/exit events for individual cells, we fire an additional motion event when the
      // cursor leaves the cell
      myLastMotionListener.mouseMoved(e);
    }
    if (listener != null) {
      listener.mouseMoved(e);
    }
    myLastMotionListener = listener;
  }
  @Override
  public void mousePressed(MouseEvent e) {
    MouseListener listener = findListenerAtMouse(e, MouseListener.class);
    if (listener != null) {
      listener.mousePressed(e);
    }
  }
  @Override
  public void mouseReleased(MouseEvent e) {
    MouseListener listener = findListenerAtMouse(e, MouseListener.class);
    if (listener != null) {
      listener.mouseReleased(e);
    }
  }
}
