package com.mbeddr.mpsutil.grammarcells.generatorutils;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.util.Condition;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import com.mbeddr.mpsutil.grammarcells.runtimelang.behavior.ICollectionLikeCell__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class CellModelTraversalUtil {
  public static SNode findLeaf(SNode start, SAbstractConcept type, boolean next) {
    SNode leaf = prevNextLeaf(start, next, Condition.FALSE_CONDITION);
    while ((leaf != null)) {
      if (SConceptOperations.isSubConceptOf(SNodeOperations.asSConcept(SNodeOperations.getConcept(leaf)), CONCEPTS.EditorCellModel$gN) && SConceptOperations.isSubConceptOf(SNodeOperations.asSConcept(SNodeOperations.getConcept(leaf)), SNodeOperations.asSConcept(type)) && isAllowedLeaf(leaf)) {
        return SNodeOperations.cast(leaf, CONCEPTS.EditorCellModel$gN);
      }
      leaf = prevNextLeaf(leaf, next, Condition.FALSE_CONDITION);
    }
    return null;
  }

  public static boolean isAllowedLeaf(SNode node) {
    return SNodeOperations.isInstanceOf(node, CONCEPTS.EditorCellModel$gN) && !(SNodeOperations.isInstanceOf(node, CONCEPTS.INotALeaf$rm)) && !(SNodeOperations.isInstanceOf(node, CONCEPTS.CellModel_Collection$Og));
  }

  public static List<SNode> collectLeafsBeforeAfter(SNode start, boolean after) {
    return collectLeafsBeforeAfter(start, after, CONCEPTS.GrammarInfoCell$HL);
  }

  public static List<SNode> collectLeafsBeforeAfter(SNode start, boolean after, final SAbstractConcept parentStopConcept) {
    return collectLeafsBeforeAfter(start, after, new Condition<SNode>() {
      public boolean met(SNode parent) {
        return SNodeOperations.isInstanceOf(parent, SNodeOperations.asSConcept(parentStopConcept));
      }
    });
  }

  public static List<SNode> collectLeafsBeforeAfter(SNode start, boolean after, Condition<SNode> parentStopCondition) {
    List<SNode> result = ListSequence.fromList(new ArrayList<SNode>());
    SNode leaf = prevNextLeaf(start, after, parentStopCondition);

    while (leaf != null) {
      if (isAllowedLeaf(leaf)) {
        ListSequence.fromList(result).addElement(SNodeOperations.cast(leaf, CONCEPTS.EditorCellModel$gN));
      }

      leaf = prevNextLeaf(leaf, after, parentStopCondition);
    }
    return (after ? result : ListSequence.fromList(result).reversedList());
  }

  public static List<SNode> collectDescendantLeafs(final SNode ancestor) {
    List<SNode> result = ListSequence.fromList(new ArrayList<SNode>());
    SNode leaf = firstLastLeaf(ancestor, true);

    while (leaf != null) {
      if (!(ListSequence.fromList(SNodeOperations.getNodeAncestors(leaf, null, true)).contains(ancestor))) {
        break;
      }
      if (isAllowedLeaf(leaf)) {
        ListSequence.fromList(result).addElement(SNodeOperations.cast(leaf, CONCEPTS.EditorCellModel$gN));
      }

      leaf = prevNextLeaf(leaf, true, new Condition<SNode>() {
        public boolean met(SNode parent) {
          return parent == SNodeOperations.getParent(ancestor);
        }
      });
    }
    return result;
  }

  private static SNode prevNextLeaf(SNode node, boolean next, Condition<SNode> parentStopCondition) {
    SNode sibling = prevNextSibling(node, next, parentStopCondition);
    if ((sibling != null)) {
      return firstLastLeaf(sibling, next);
    }

    SNode parent = SNodeOperations.getParent(node);
    if ((parent != null) && !(parentStopCondition.met(parent))) {
      return prevNextLeaf(parent, next, parentStopCondition);
    }

    return null;
  }

  private static SNode prevNextSibling(SNode node, boolean next, Condition<SNode> parentStopCondition) {
    if ((SNodeOperations.getParent(node) != null)) {
      if (parentStopCondition.met(SNodeOperations.getParent(node))) {
        return null;
      }
      if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(node), CONCEPTS.EditorCellModel$gN)) {
        List<? extends SNode> children = getChildren(SNodeOperations.getParent(node));
        int siblingIndex = ListSequence.fromList(children).indexOf(node) + ((next ? 1 : -1));
        if (0 <= siblingIndex && siblingIndex < ListSequence.fromList(children).count()) {
          return ListSequence.fromList(children).getElement(siblingIndex);
        } else {
          return null;
        }

      }
    }
    return (next ? node.getNextSibling() : node.getPrevSibling());
  }

  private static SNode firstLastLeaf(SNode node, boolean first) {
    if (SNodeOperations.isInstanceOf(node, CONCEPTS.EditorCellModel$gN) && ListSequence.fromList(SNodeOperations.getNodeDescendants(node, CONCEPTS.EditorCellModel$gN, false, new SAbstractConcept[]{})).isEmpty()) {
      return node;
    }
    List<? extends SNode> children = getChildren(node);
    return (ListSequence.fromList(children).isEmpty() ? node : firstLastLeaf((first ? ListSequence.fromList(children).first() : ListSequence.fromList(children).last()), first));
  }

  private static List<? extends SNode> getChildren(SNode cell) {
    if (SNodeOperations.isInstanceOf(cell, CONCEPTS.ICollectionLikeCell$Y)) {
      return ICollectionLikeCell__BehaviorDescriptor.getChildren_id5OsvY4gZzTI.invoke(SNodeOperations.cast(cell, CONCEPTS.ICollectionLikeCell$Y));
    }
    if (SNodeOperations.isInstanceOf(cell, CONCEPTS.CellModel_Tooltip$vF)) {
      return ListSequence.fromListAndArray(new ArrayList<SNode>(), SLinkOperations.getTarget(SNodeOperations.cast(cell, CONCEPTS.CellModel_Tooltip$vF), LINKS.visibleCell$VE5n));
    }
    if (SNodeOperations.isInstanceOf(cell, CONCEPTS.EditorCellModel$gN)) {
      if (SNodeOperations.isInstanceOf(cell, CONCEPTS.CellModel_Collection$Og)) {
        return SLinkOperations.getChildren(SNodeOperations.cast(cell, CONCEPTS.CellModel_Collection$Og), LINKS.childCellModel$HAw7);
      } else if (SNodeOperations.isInstanceOf(cell, CONCEPTS.CellModel_CustomFactory$1K)) {
        return ListSequence.fromListAndArray(new ArrayList<SNode>(), SLinkOperations.getTarget(SNodeOperations.cast(cell, CONCEPTS.CellModel_CustomFactory$1K), LINKS.childCellModel$XMHB));
      } else if (SNodeOperations.isInstanceOf(cell, CONCEPTS.CellModel_Alternation$uR)) {
        return ListSequence.fromListAndArray(new ArrayList<SNode>(), SLinkOperations.getTarget(SNodeOperations.cast(cell, CONCEPTS.CellModel_Alternation$uR), LINKS.ifTrueCellModel$tpU2));
      } else {
        return null;
      }
    } else {
      return SNodeOperations.getChildren(cell);
    }
  }

  public static List<SNode> inlineComponents(List<SNode> cells, final _FunctionTypes._return_P1_E0<? extends List<SNode>, ? super SNode> cellExtractor) {
    return ListSequence.fromList(cells).translate((it) -> {
      if (SNodeOperations.isInstanceOf(it, CONCEPTS.CellModel_Component$d$)) {
        return inlineComponents(cellExtractor.invoke(SLinkOperations.getTarget(SLinkOperations.getTarget(SNodeOperations.cast(it, CONCEPTS.CellModel_Component$d$), LINKS.editorComponent$DNa7), LINKS.cellModel$L8Uc)), cellExtractor);
      } else {
        return Sequence.<SNode>singleton(it);
      }
    }).toList();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept EditorCellModel$gN = MetaAdapterFactory.getConcept(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xf9eafb9a39L, "jetbrains.mps.lang.editor.structure.EditorCellModel");
    /*package*/ static final SConcept CellModel_Collection$Og = MetaAdapterFactory.getConcept(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xf9eaff2517L, "jetbrains.mps.lang.editor.structure.CellModel_Collection");
    /*package*/ static final SInterfaceConcept INotALeaf$rm = MetaAdapterFactory.getInterfaceConcept(0x9d69e71978c84286L, 0x90dbfb19c107d049L, 0x43a748540d9a9c8eL, "com.mbeddr.mpsutil.grammarcells.structure.INotALeaf");
    /*package*/ static final SConcept GrammarInfoCell$HL = MetaAdapterFactory.getConcept(0x9d69e71978c84286L, 0x90dbfb19c107d049L, 0x29cc3d1b55ff5285L, "com.mbeddr.mpsutil.grammarcells.structure.GrammarInfoCell");
    /*package*/ static final SInterfaceConcept ICollectionLikeCell$Y = MetaAdapterFactory.getInterfaceConcept(0xb4f35ed845af4efaL, 0xabe400ac26956e69L, 0x5d1c7fe110fe3bb8L, "com.mbeddr.mpsutil.grammarcells.runtimelang.structure.ICollectionLikeCell");
    /*package*/ static final SConcept CellModel_Tooltip$vF = MetaAdapterFactory.getConcept(0xb1ab8c10c1184755L, 0xbf2acebab35cf533L, 0x11d794d84ece7c48L, "jetbrains.mps.lang.editor.tooltips.structure.CellModel_Tooltip");
    /*package*/ static final SConcept CellModel_CustomFactory$1K = MetaAdapterFactory.getConcept(0x52733268be244f5fL, 0xab84a73b7c0c03b0L, 0x228f1e46dd6e9f14L, "de.slisson.mps.richtext.customcell.structure.CellModel_CustomFactory");
    /*package*/ static final SConcept CellModel_Alternation$uR = MetaAdapterFactory.getConcept(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xfd766383e4L, "jetbrains.mps.lang.editor.structure.CellModel_Alternation");
    /*package*/ static final SConcept CellModel_Component$d$ = MetaAdapterFactory.getConcept(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xfb35c96896L, "jetbrains.mps.lang.editor.structure.CellModel_Component");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink visibleCell$VE5n = MetaAdapterFactory.getContainmentLink(0xb1ab8c10c1184755L, 0xbf2acebab35cf533L, 0x11d794d84ece7c48L, 0x7f7a04fd2c64819dL, "visibleCell");
    /*package*/ static final SContainmentLink childCellModel$HAw7 = MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xf9eaff2517L, 0xf9eaff2518L, "childCellModel");
    /*package*/ static final SContainmentLink childCellModel$XMHB = MetaAdapterFactory.getContainmentLink(0x52733268be244f5fL, 0xab84a73b7c0c03b0L, 0x228f1e46dd6e9f14L, 0xf9eaff2518L, "childCellModel");
    /*package*/ static final SContainmentLink ifTrueCellModel$tpU2 = MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xfd766383e4L, 0xfd76638039L, "ifTrueCellModel");
    /*package*/ static final SReferenceLink editorComponent$DNa7 = MetaAdapterFactory.getReferenceLink(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xfb35c96896L, 0xfb35c96897L, "editorComponent");
    /*package*/ static final SContainmentLink cellModel$L8Uc = MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L, 0xa83a7ff23bde13baL, 0xfba0eb7c50L, 0xfba0ec5415L, "cellModel");
  }
}
