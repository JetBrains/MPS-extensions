package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import java.awt.Color;
import com.intellij.ui.JBColor;
import de.itemis.mps.editor.diagram.runtime.shape.IShape;
import de.itemis.mps.editor.diagram.runtime.shape.DefaultShape;
import java.awt.Graphics2D;
import java.awt.Shape;
import java.awt.BasicStroke;
import de.itemis.mps.editor.diagram.runtime.model.SerializableObjectHolder;
import de.itemis.mps.editor.diagram.runtime.model.Annotation;
import com.mxgraph.model.mxGeometry;
import java.util.Collections;
import com.mxgraph.canvas.mxGraphics2DCanvas;
import com.mxgraph.view.mxCellState;
import org.apache.commons.math3.geometry.euclidean.twod.Vector2D;
import de.itemis.mps.editor.diagram.runtime.model.Bounds;
import de.itemis.mps.editor.diagram.styles.editor.StyleUtils;
import de.itemis.mps.editor.diagram.styles.editor.LineStyle;
import java.awt.geom.Line2D;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import de.itemis.mps.editor.diagram.runtime.model.Box;
import de.itemis.mps.editor.diagram.runtime.model.IDiagramElement;

public class AnnotationDCell extends BoxBaseDCell implements ISelfPaintingCell {
  private static final Color LINE_COLOR = JBColor.GRAY;
  public static final IShape ANNOTATION_SHAPE = new DefaultShape() {
    @Override
    public void drawShapeBorder(Graphics2D g, Shape shape) {
      g.setStroke(new BasicStroke(1.0f));
      g.setColor(LINE_COLOR);
      super.drawShapeBorder(g, shape);
    }

    @Override
    public void drawShape(Graphics2D g, Shape shape) {
      g.setColor(new JBColor(new Color(250, 250, 250), JBColor.WHITE.getDarkVariant()));
      super.drawShape(g, shape);
    }
  };

  private SerializableObjectHolder<Annotation> myAnnotation;

  public AnnotationDCell(MyGraph graph) {
    super(graph);
    mxGeometry geometry = new mxGeometry(50, -50, 50, 50);
    geometry.setRelative(false);
    setGeometry(geometry);

    setVertex(true);

  }

  public void setAnnotation(Annotation annotation) {
    myAnnotation = new SerializableObjectHolder<Annotation>(annotation);
    setContentCells(Collections.singletonList(annotation.getRootCell()));
  }

  public Annotation getAnnotation() {
    return myAnnotation.get();
  }

  @Override
  public boolean constrainPosition() {
    return false;
  }

  public void paintTop(Graphics2D g, mxGraphics2DCanvas canvas, mxCellState state) {
    super.paintTop(g, canvas, state);
    Object parentCell = state.getView().getGraph().getModel().getParent(state.getCell());
    if (parentCell == null) {
      return;
    }
    mxCellState parentState = state.getView().getState(parentCell);
    if (parentState == null) {
      return;
    }

    Vector2D p1 = new Vector2D(state.getCenterX(), state.getCenterY());
    Vector2D p2 = new Vector2D(parentState.getCenterX(), parentState.getCenterY());
    Bounds bounds1 = ExtensionMethods.toBounds(ExtensionMethods.toMxRectangle(state.getRectangle()));

    if (parentState.getCell() instanceof EdgeDCell) {
      p2 = LabelDCell.nearestPointOnEdge(parentState, p1);
      p1 = LabelDCell.findNearestPositionOnBorder(bounds1, p2);
      p2 = LabelDCell.nearestPointOnEdge(parentState, p1);
    } else {
      Bounds bounds2 = ExtensionMethods.toBounds(ExtensionMethods.toMxRectangle(parentState.getRectangle()));
      p2 = LabelDCell.findNearestPositionOnBorder(bounds2, p1);
      p1 = LabelDCell.findNearestPositionOnBorder(bounds1, p2);
      p2 = LabelDCell.findNearestPositionOnBorder(bounds2, p1);
    }

    g.setColor(LINE_COLOR);
    g.setStroke(StyleUtils.createStroke(1.0f, LineStyle.DASHED));
    g.draw(new Line2D.Double(p1.getX(), p1.getY(), p2.getX(), p2.getY()));
  }

  @Nullable
  public EditorCell getBigCell() {
    return check_6viynf_a0a51(getAnnotation(), this);
  }

  public boolean allowScaling() {
    return check_6viynf_a0a71(as_6viynf_a0a0a71(check_6viynf_a0a0a71(getAnnotation(), this), Box.class), this);
  }

  @Nullable
  public IDiagramElement getDiagramElement() {
    return getAnnotation();
  }
  private static EditorCell check_6viynf_a0a51(Annotation checkedDotOperand, AnnotationDCell checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getRootCell();
    }
    return null;
  }
  private static boolean check_6viynf_a0a71(Box checkedDotOperand, AnnotationDCell checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.isScalingAllowed();
    }
    return false;
  }
  private static IDiagramElement check_6viynf_a0a0a71(Annotation checkedDotOperand, AnnotationDCell checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getAnnotatedElement();
    }
    return null;
  }
  private static <T> T as_6viynf_a0a0a71(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
