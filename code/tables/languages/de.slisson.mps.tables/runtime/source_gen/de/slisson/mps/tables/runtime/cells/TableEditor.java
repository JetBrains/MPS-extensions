package de.slisson.mps.tables.runtime.cells;

/*Generated by MPS */

import de.slisson.mps.tables.runtime.gridmodel.Grid;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import de.itemis.mps.editor.celllayout.runtime.TopDownCellLayoutAdapter;
import de.slisson.mps.tables.runtime.gridmodel.GridFinalizer;
import de.slisson.mps.tables.runtime.gridmodel.EditorCellFactory;
import de.slisson.mps.tables.runtime.gridmodel.GridAdapter;
import de.slisson.mps.tables.runtime.substitute.SubstituteInfoFactory;
import de.slisson.mps.tables.runtime.gridmodel.IGridElement;
import de.slisson.mps.tables.runtime.gridmodel.EditorCellGridLeaf;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import de.slisson.mps.tables.runtime.gridmodel.Header;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import de.slisson.mps.tables.runtime.gridmodel.EditorCellHeader;
import java.awt.Graphics;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import java.util.Set;
import java.util.HashSet;
import java.util.Objects;
import de.slisson.mps.tables.runtime.simplegrid.GridPosition;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.annotations.Nullable;

public class TableEditor extends AbstractTableEditor {
  private Grid myOriginalGrid;
  private IGridPostprocessor myGridPostprocessor;
  private boolean myDisableLeftRowEndCells = false;
  private boolean myDisableRightRowEndCells = false;
  private boolean myRowUIActions = false;
  private boolean myColumnUIActions = false;

  public List<EditorCell_GridCell> horizontallyStickyCells = ListSequence.fromList(new ArrayList<EditorCell_GridCell>());
  public List<EditorCell_GridCell> verticallyStickyCells = ListSequence.fromList(new ArrayList<EditorCell_GridCell>());

  public TableEditor(EditorContext context, SNode snode, Grid grid) {
    this(context, snode, grid, null);
  }
  public TableEditor(EditorContext context, SNode snode, Grid grid, IGridPostprocessor gridPostprocessor) {
    super(context, snode, new TopDownCellLayoutAdapter(new TableLayout()), grid);
    myOriginalGrid = grid;
    myGridPostprocessor = gridPostprocessor;
  }

  public void disableLeftRowEndCells(boolean hide) {
    myDisableLeftRowEndCells = hide;
  }

  public void disableRightRowEndCells(boolean hide) {
    myDisableRightRowEndCells = hide;
  }

  public void toggleRowUIActions(boolean flag) {
    myRowUIActions = flag;
  }

  public void toggleColumnUIActions(boolean flag) {
    myColumnUIActions = flag;
  }

  public boolean rowUIActionsAllowed() {
    return myRowUIActions;
  }

  public boolean columnUIActionsAllowed() {
    return myColumnUIActions;
  }

  public void init() {
    replacePartialTablesByGrid(myGrid);
    myGrid = myGrid.clone();
    myGrid.flatten();
    GridFinalizer finalizer = new GridFinalizer(myGrid, new EditorCellFactory(getContext(), getSNode(), myGrid));
    finalizer.finalizeGrid(myDisableLeftRowEndCells, myDisableRightRowEndCells);
    if (myGridPostprocessor != null) {
      myGridPostprocessor.postprocess(new GridAdapter(myGrid, getContext(), getSNode()), getSNode(), getContext(), new SubstituteInfoFactory(getContext()));
      finalizer.finalizeEditorCellLeafs();

      for (int x = 0; x < myGrid.getSizeX(); x++) {
        for (int y = 0; y < myGrid.getSizeY(); y++) {
          IGridElement element = myGrid.getElement(x, y);
          if (element instanceof EditorCellGridLeaf) {
            EditorCellGridLeaf leaf = ((EditorCellGridLeaf) element);
            EditorCell cell = leaf.getEditorCell();
            if (cell.getParent() == null) {
              addEditorCell(cell);
            }
          }
        }
      }
    }
    initChilds(ChildsTracker.getInstance());
    TableUtils.checkForCycles(this);
    TableDebug.writeEditorState(this);
    wrapGridCells(myGrid);

    TableEditorActions.setActions(this, getContext());


    TableDebug.writeEditorState(this);
    TableUtils.checkForCycles(this);
    TableDebug.writeEditorState(this);
    TableDebug.writeEditorState(this);
  }
  @Override
  protected boolean allowAddGridCell(EditorCell cell, ChildsTracker childsTracker) {
    return childsTracker.isRegistered(cell) || childsTracker.isRegisteredHeader(cell);
  }

  private void addHeadersToThis(Grid grid) {
    for (Header header : SetSequence.fromSet(grid.getAllHeaders()).where((it) -> it instanceof EditorCellHeader)) {
      addEditorCell(((EditorCellHeader) header).getEditorCell());
    }
  }

  public Grid getOriginalGrid() {
    return myOriginalGrid;
  }

  public static void replacePartialTablesByGrid(Grid grid) {
    for (int x = 0; x < grid.getSizeX(); x++) {
      for (int y = 0; y < grid.getSizeY(); y++) {
        IGridElement element = grid.getElement(x, y);
        if (element instanceof Grid) {
          replacePartialTablesByGrid((Grid) element);
        } else if (element instanceof EditorCellGridLeaf) {
          EditorCellGridLeaf leaf = ((EditorCellGridLeaf) element);
          EditorCell cell = leaf.getEditorCell();
          if (cell instanceof EditorCell_GridCell) {
            cell = ((EditorCell_GridCell) cell).getWrappedCell();
          }
          if (cell instanceof PartialTableEditor) {
            Grid childGrid = ((PartialTableEditor) cell).getGrid().clone();
            childGrid.setSpanX(leaf.getSpanX());
            childGrid.setSpanY(leaf.getSpanY());
            grid.setElement(x, y, childGrid);
          }
        }
      }
    }
  }

  @Override
  public void paintCell(Graphics g, ParentSettings parentSettings) {
    RowColumnStylePainter rowStylePainter = new RowColumnStylePainter(myGrid, false);
    RowColumnStylePainter columnStylePainter = new RowColumnStylePainter(myGrid, true);

    ParentSettings settings = isSelectionPaintedOnAncestor(parentSettings);
    if (!(settings.isSelectionPainted())) {
      settings = (fillBackground(g, parentSettings));
      rowStylePainter.paintBackground(g, settings);
      columnStylePainter.paintBackground(g, settings);
    }
    paintSelectionIfRequired(g, parentSettings);
    paintContent(g, parentSettings);

    Set<EditorCell> selectedCells = TableUtils.collectSelectedCells(this);
    for (IGridElement element : getGrid()) {
      EditorCellGridLeaf leaf = as_cj6dzx_a0a0a9a43(element, EditorCellGridLeaf.class);
      EditorCell child = check_cj6dzx_a0b0j0ib(leaf);
      if (child == null) {
        continue;
      }
      if (g.hitClip(child.getX(), child.getY(), child.getWidth(), child.getHeight())) {
        ParentSettings childSettings = ParentSettings.createSelectedSetting(SetSequence.fromSet(selectedCells).contains(child)).combineWith(settings);

        if (childSettings.isSelectionPainted()) {
          g.setColor(getSelectionColor());
          g.fillRect(child.getX(), child.getY(), child.getWidth(), child.getHeight());
        }

        ((jetbrains.mps.nodeEditor.cells.EditorCell) child).paintCell(g, childSettings);
        ((jetbrains.mps.nodeEditor.cells.EditorCell) child).paintDecorations(g);

      }
    }
    paintDecorations(g);
    rowStylePainter.paintForeground(g, settings);
    columnStylePainter.paintForeground(g, settings);

    for (PartialTableEditor partTab : ListSequence.fromList(getDescendantPartialTables())) {
      partTab.paintMessages(g);
    }
  }

  private void wrapGridCells(Grid grid) {
    Set<EditorCell_GridCell> usedWrappers = SetSequence.fromSet(new HashSet<EditorCell_GridCell>());
    for (int x = 0; x < grid.getSizeX(); x++) {
      for (int y = 0; y < grid.getSizeY(); y++) {
        EditorCellGridLeaf leaf = as_cj6dzx_a0a0a0a1a63(grid.getElement(x, y), EditorCellGridLeaf.class);
        if (leaf == null) {
          continue;
        }

        EditorCell_GridCell wrapper = as_cj6dzx_a0a3a0a1a63(leaf.getEditorCell(), EditorCell_GridCell.class);
        if (wrapper == null) {
          SNode nodeForGridCell = getSNode();
          if (leaf.getEditorCell().getParent() != null && Objects.equals(leaf.getEditorCell().getParent().getSNode(), leaf.getEditorCell().getSNode())) {
            nodeForGridCell = leaf.getEditorCell().getSNode();
          }
          wrapper = new EditorCell_GridCell(getContext(), nodeForGridCell, leaf.getEditorCell());
          EditorCell leafCell = leaf.getEditorCell();
          while (leafCell.getParent() instanceof EditorCell_GridCell) {
            ((EditorCell_GridCell) leafCell.getParent()).unwrap();
          }
          TableUtils.wrapCell(leaf.getEditorCell(), wrapper);
          leaf.setEditorCell(wrapper);
        }
        wrapper.setTable(this);
        wrapper.setPosition(new GridPosition(x, y));
        wrapper.clearStyle();
        Style style = leaf.getStyle();
        if (style != null) {
          wrapper.getTableStyle().putAll(style);
        }
        SetSequence.fromSet(usedWrappers).addElement(wrapper);
      }
    }
    sortChildren();
  }

  public List<PartialTableEditor> getDescendantPartialTables() {
    return (List) TableTraversalUtil.getDescendants(this, (EditorCell cell) -> cell instanceof PartialTableEditor);
  }

  private static void setAllIndentLayoutMaxWidth(EditorCell parent, Integer width) {
    if (as_cj6dzx_a0a0a04(parent, EditorCell_Collection.class) != null) {
      Style style = parent.getStyle();
      if (!(style.isSpecified(StyleAttributes.MAX_WIDTH))) {
        style.set(StyleAttributes.MAX_WIDTH, width);
      }
    }
    for (EditorCell child : Sequence.fromIterable(as_cj6dzx_a0a1a04(parent, jetbrains.mps.openapi.editor.cells.EditorCell_Collection.class))) {
      setAllIndentLayoutMaxWidth(child, width);
    }
  }

  public static void setAllIndentLayoutMaxWidth(Grid grid, Integer width) {
    for (IGridElement e : Sequence.fromIterable(grid)) {
      if (e instanceof EditorCellGridLeaf) {
        setAllIndentLayoutMaxWidth(((EditorCellGridLeaf) e).getEditorCell(), width);
      }
      if (e instanceof Grid) {
        setAllIndentLayoutMaxWidth(((Grid) e), width);
      }
    }
  }

  public int getHorizonalStickyCellOffset(@Nullable EditorCell_GridCell gridCell) {
    int offset = 0;
    int lastX = -1;

    if (ListSequence.fromList(this.horizontallyStickyCells).isEmpty()) {
      return offset;
    }

    for (EditorCell_GridCell stickyCell : ListSequence.fromList(this.horizontallyStickyCells)) {
      if (lastX == -1) {
        lastX = stickyCell.getX();
      } else {
        offset += stickyCell.getX() - lastX;
        lastX = stickyCell.getX();
      }
      if (Objects.equals(stickyCell, gridCell)) {
        return offset;
      }
    }

    if (gridCell == null) {
      return offset + ListSequence.fromList(this.horizontallyStickyCells).first().getHeight();
    }
    return offset;
  }

  public int getVerticalStickyCellOffset(@Nullable EditorCell_GridCell gridCell) {
    int offset = 0;
    int lastY = -1;

    if (ListSequence.fromList(this.verticallyStickyCells).isEmpty()) {
      return offset;
    }

    for (EditorCell_GridCell stickyCell : ListSequence.fromList(this.verticallyStickyCells)) {
      if (lastY == -1) {
        lastY = stickyCell.getY();
      } else {
        offset += stickyCell.getY() - lastY;
        lastY = stickyCell.getY();
      }
      if (Objects.equals(stickyCell, gridCell)) {
        return offset;
      }
    }
    if (gridCell == null) {
      return offset + ListSequence.fromList(this.verticallyStickyCells).first().getHeight();
    }
    return offset;
  }
  private static EditorCell check_cj6dzx_a0b0j0ib(EditorCellGridLeaf checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getEditorCell();
    }
    return null;
  }
  private static <T> T as_cj6dzx_a0a0a9a43(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_cj6dzx_a0a0a0a1a63(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_cj6dzx_a0a3a0a1a63(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_cj6dzx_a0a0a04(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_cj6dzx_a0a1a04(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
