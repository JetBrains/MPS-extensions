package de.itemis.mps.editor.celllayout.runtime;

/*Generated by MPS */

import de.itemis.mps.editor.celllayout.layout.AbstractLayoutable;
import de.itemis.mps.editor.celllayout.layout.ILayoutable;
import jetbrains.mps.openapi.editor.style.StyleAttribute;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import de.itemis.mps.editor.celllayout.boxmodel.EditorCellBoxModel;
import jetbrains.mps.nodeEditor.cellLayout.PunctuationUtil;
import org.jetbrains.annotations.Nullable;
import de.itemis.mps.editor.celllayout.layout.ILayoutableContainer;
import de.itemis.mps.editor.celllayout.boxmodel.Size;
import de.itemis.mps.editor.celllayout.boxmodel.BoxModel;
import org.jetbrains.annotations.NotNull;
import de.itemis.mps.editor.celllayout.boxmodel.LayoutBoxExtensions;
import de.itemis.mps.editor.celllayout.boxmodel.DefaultBoxModel;
import de.itemis.mps.editor.celllayout.styles.editor.LayoutStylesUtil;
import jetbrains.mps.openapi.editor.TextBuilder;

public abstract class AbstractLayoutableAdapter extends AbstractLayoutable implements ILayoutable, IEditorCellBasedLayoutable {
  private static final StyleAttribute<Integer> GRID_LAYOUT_ROW_SPAN = StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.celllayout.styles", "_grid-layout-row-span");
  private static final StyleAttribute<Boolean> GROW_Y = StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.celllayout.styles", "_grow-y");
  private static final StyleAttribute<Boolean> GROW_X = StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.celllayout.styles", "_grow-x");
  private static final StyleAttribute<Integer> BORDER_SIZE = StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.celllayout.styles", "_border-size");
  private static final StyleAttribute<Boolean> OVERFLOW_Y = StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.celllayout.styles", "_overflow-y");
  private static final StyleAttribute<Boolean> PUSH_X = StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.celllayout.styles", "_push-x");
  private static final StyleAttribute<Boolean> OVERFLOW_X = StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.celllayout.styles", "_overflow-x");
  private static final StyleAttribute<Boolean> PUSH_Y = StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.celllayout.styles", "_push-y");
  private static final StyleAttribute<Integer> GRID_LAYOUT_COLUMN_SPAN = StyleAttributes.getInstance().<Integer>getAttribute("de.itemis.mps.editor.celllayout.styles", "_grid-layout-column-span");

  private LayoutableCollectionAdapter myParent;
  protected final EditorCell myCell;
  protected EditorCellBoxModel myBoxModel;
  private boolean myHasPunctuationLeft;
  private boolean myHasPunctuationRight;
  private boolean myIsPushX;
  private boolean myIsPushY;
  private boolean myIsOverflowX;
  private boolean myIsOverflowY;
  private Boolean myHasIndent;
  private boolean myHasBorderLeft;
  private boolean myHasBorderRight;
  private boolean myIsBaselineCell;
  private int myColumnSpan;
  private int myRowSpan;
  private CachingValue<Boolean> myIsGrowX = new CachingValue<Boolean>() {
    protected Boolean calculate() {
      return calcIsGrowX();
    }
  };
  private CachingValue<Boolean> myIsGrowY = new CachingValue<Boolean>() {
    protected Boolean calculate() {
      return calcIsGrowY();
    }
  };

  public AbstractLayoutableAdapter(EditorCell cell) {
    myCell = cell;
    myBoxModel = EditorCellBoxModel.getInstance(cell);
    myHasPunctuationLeft = PunctuationUtil.hasPunctuationLeft(cell);
    myHasPunctuationRight = PunctuationUtil.hasPunctuationRight(cell);
  }

  @Override
  public String toString() {
    return "" + myCell;
  }

  @Override
  public void setChanged(boolean changed) {
    super.setChanged(changed);
    if (changed && myParent != null) {
      myParent.setChanged(true);
    }
  }

  @Nullable
  @Override
  public LayoutableCollectionAdapter getParent() {
    return myParent;
  }

  public void setParent(ILayoutableContainer parent) {
    myParent = ((LayoutableCollectionAdapter) parent);
  }

  @Override
  public EditorCell getEditorCell() {
    return myCell;
  }
  @Override
  public int getX() {
    return myBoxModel.getMarginBox().getX();
  }
  @Override
  public int getY() {
    return myBoxModel.getMarginBox().getY();
  }
  @Override
  public int getWidth() {
    return myBoxModel.getMarginBox().getWidth();
  }
  @Override
  public int getHeight() {
    return myBoxModel.getMarginBox().getHeight();
  }
  @Override
  public void setX(int x) {
    myBoxModel.getMarginBox().setX(x);
  }
  @Override
  public void setY(int y) {
    myBoxModel.getMarginBox().setY(y);
  }
  @Override
  public void setWidth(int width) {
    myBoxModel.getMarginBox().setWidth(width);
  }
  @Override
  public void setHeight(int height) {
    myBoxModel.getMarginBox().setHeight(height);
  }
  @Override
  public void setBounds(int x, int y, int width, int height) {
    setSize(width, height);
    setPosition(x, y);
  }
  @Override
  public int getAscent() {
    return getAscent(new Size(getWidth(), getHeight()));
  }
  @Override
  public void setPosition(int x, int y) {
    myBoxModel.getMarginBox().setX(x);
    myBoxModel.getMarginBox().setY(y);
  }
  @Override
  public BoxModel getBoxModel() {
    return myBoxModel;
  }
  @Override
  public void setSize(int width, int height) {
    myBoxModel.getMarginBox().setSize(width, height);
  }
  @NotNull
  @Override
  public Size getPreferredSize(@NotNull Size sizeConstraint) {
    return LayoutBoxExtensions.getSize(myBoxModel.getMarginBox());
  }
  @NotNull
  @Override
  public Size getMinSize(@NotNull Size sizeConstraint) {
    return getPreferredSize(sizeConstraint);
  }
  @Override
  public abstract int getAscent(@NotNull Size size);
  @NotNull
  @Override
  public Size getMaxSize(@NotNull Size sizeConstraint) {
    return getPreferredSize(sizeConstraint);
  }
  @Override
  public void relayout(@NotNull Size sizeConstraint) {
  }

  @Override
  public void readSyncAll() {
    if (myCell.wasRelayoutRequested()) {
      setChanged(true);
    }


    if (isChanged()) {
      // border
      if (myCell.getStyle().get(StyleAttributes.DRAW_BORDER)) {
        if (myCell.getStyle().get(BORDER_SIZE) == 0) {
          myCell.getStyle().set(BORDER_SIZE, 1);
        }
        myCell.getStyle().set(StyleAttributes.DRAW_BORDER, false);
      }

      myBoxModel.readSync();
    } else {
      DefaultBoxModel old = myBoxModel.clone();
      myBoxModel.readSync();
      if (!(myBoxModel.equals(old))) {
        setChanged(true);
      }
    }

    if (isChanged()) {
      readSyncChildren();
    }

    myHasBorderLeft = calcHasBorder(true);
    myHasBorderRight = calcHasBorder(false);
    myIsPushX = calcIsPushX();
    myIsPushY = calcIsPushY();
    myIsOverflowX = calcIsOverflowX();
    myIsOverflowY = calcIsOverflowY();
    myColumnSpan = calcColumnSpan();
    myRowSpan = calcRowSpan();
    myIsBaselineCell = calcBaseLineCell();
    myIsGrowX.invalidate();
    myIsGrowY.invalidate();

    myHasIndent = null;
  }

  protected void readSyncChildren() {
  }

  @Override
  public void writeSyncAll() {
    myBoxModel.writeSync(false);
  }

  public boolean hasPunctuationLeft() {
    return myHasPunctuationLeft;
  }

  public boolean hasPunctuationRight() {
    return myHasPunctuationRight;
  }

  public boolean hasBorder(boolean left) {
    return (left ? myHasBorderLeft : myHasBorderRight);
  }

  protected boolean calcHasBorder(boolean left) {
    return ((left ? LayoutStylesUtil.getLeftBorderSize(myCell) : LayoutStylesUtil.getRightBorderSize(myCell))) > 0;
  }

  @Override
  public boolean isGrowX() {
    return myIsGrowX.getValue();
  }

  protected boolean calcIsGrowX() {
    return (myCell.getStyle().isSpecified(GROW_X) ? myCell.getStyle().get(GROW_X) : myCell.getStyle().get(GROW_X) || isPushX());
  }

  @Override
  public boolean isGrowY() {
    return myIsGrowY.getValue();
  }

  protected boolean calcIsGrowY() {
    return (myCell.getStyle().isSpecified(GROW_Y) ? myCell.getStyle().get(GROW_Y) : myCell.getStyle().get(GROW_Y) || isPushY());
  }

  @Override
  public boolean isPushX() {
    return myIsPushX;
  }

  protected boolean calcIsPushX() {
    return myCell.getStyle().get(PUSH_X);
  }

  @Override
  public boolean isPushY() {
    return myIsPushY;
  }

  protected boolean calcIsPushY() {
    return myCell.getStyle().get(PUSH_Y);
  }

  @Override
  public boolean isOverflowX() {
    return myIsOverflowX;
  }

  protected boolean calcIsOverflowX() {
    return myCell.getStyle().get(OVERFLOW_X);
  }

  @Override
  public boolean isOverflowY() {
    return myIsOverflowY;
  }

  protected boolean calcIsOverflowY() {
    return myCell.getStyle().get(OVERFLOW_Y);
  }

  @Override
  public boolean hasIndent() {
    if (myHasIndent == null) {
      myHasIndent = CellLayoutUtil.hasIndent(myCell);
    }
    return myHasIndent;
  }

  @Override
  public int getColumnSpan() {
    return myColumnSpan;
  }

  protected int calcColumnSpan() {
    return myCell.getStyle().get(GRID_LAYOUT_COLUMN_SPAN);
  }

  @Override
  public int getRowSpan() {
    return myRowSpan;
  }

  protected int calcRowSpan() {
    return myCell.getStyle().get(GRID_LAYOUT_ROW_SPAN);
  }

  @Override
  public boolean isNoWrap() {
    return myCell.getStyle().get(StyleAttributes.INDENT_LAYOUT_NO_WRAP);
  }

  @Override
  public int getMaxWidth() {
    Integer maxWidth = myCell.getStyle().get(StyleAttributes.MAX_WIDTH);
    return (maxWidth != null ? maxWidth : Integer.MAX_VALUE);
  }

  @Override
  public boolean isBaseLineCell() {
    return myIsBaselineCell;
  }

  protected boolean calcBaseLineCell() {
    return myCell.getStyle().get(StyleAttributes.BASE_LINE_CELL);
  }

  @Override
  public TextBuilder toText() {
    return myCell.renderText();
  }

  public void cellAndDescendantsWereMoved() {
    myBoxModel.readSyncPosition();
  }
}
