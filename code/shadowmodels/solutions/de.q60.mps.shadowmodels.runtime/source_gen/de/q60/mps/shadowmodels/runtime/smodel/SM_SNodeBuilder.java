package de.q60.mps.shadowmodels.runtime.smodel;

/*Generated by MPS */

import java.util.Map;
import org.modelix.model.api.INode;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.jetbrains.mps.openapi.language.SConcept;
import org.modelix.model.mpsadapters.mps.SConceptAdapter;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class SM_SNodeBuilder {

  private Map<INode, SNode> createdNodes = MapSequence.fromMap(new HashMap<INode, SNode>());

  public org.jetbrains.mps.openapi.model.SNode build(INode node) {
    if (node == null) {
      return null;
    }
    SNode snode = MapSequence.fromMap(createdNodes).get(node);
    if (snode != null) {
      return snode;
    }

    SConcept concept = (SConcept) ((SConceptAdapter) node.getConcept()).getAdapted();
    snode = new SNode(concept);
    MapSequence.fromMap(createdNodes).put(node, snode);

    for (SProperty property : CollectionSequence.fromCollection(concept.getProperties())) {
      String value = node.getPropertyValue(property.getName());
      if (value != null) {
        snode.setProperty(property, value);
      }
    }

    for (SContainmentLink link : CollectionSequence.fromCollection(concept.getContainmentLinks())) {
      for (INode child : Sequence.fromIterable(node.getChildren(link.getName()))) {
        org.jetbrains.mps.openapi.model.SNode childSNode = build(child);
        if (childSNode.getParent() != null) {
          throw new RuntimeException("Node already has a parent");
        }
        snode.addChild(link, childSNode);
      }
    }

    for (SReferenceLink link : CollectionSequence.fromCollection(concept.getReferenceLinks())) {
      INode target = node.getReferenceTarget(link.getName());
      org.jetbrains.mps.openapi.model.SNode snodeTarget = build(target);
      if (snode.getReferenceTarget(link) != snodeTarget) {
        snode.setReferenceTarget(link, snodeTarget);
      }
    }

    return snode;
  }

}
