package de.q60.mps.polymorphicfunctions.runtime;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.util.Map;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.classloading.DeployListener;
import jetbrains.mps.classloading.ClassLoaderManager;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.ide.MPSCoreComponents;
import org.jetbrains.annotations.Nullable;
import java.util.Set;
import jetbrains.mps.module.ReloadableModule;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import java.lang.reflect.Field;
import jetbrains.mps.classloading.ModuleClassNotFoundException;
import jetbrains.mps.module.ModuleClassLoaderIsNullException;

public class DescriptorCache {
  private static final Logger LOG = Logger.getLogger(DescriptorCache.class);

  private static DescriptorCache INSTANCE = new DescriptorCache();

  public static DescriptorCache getInstance() {
    return INSTANCE;
  }

  private Map<Tuples._2<SModule, String>, PFDescriptor> loadedDescriptors = MapSequence.fromMap(new HashMap<Tuples._2<SModule, String>, PFDescriptor>());

  private DeployListener deployListener = null;

  public void invalidate() {
    if (LOG.isDebugLevel()) {
      LOG.debug("Invalidate Descriptors");
    }
    MapSequence.fromMap(loadedDescriptors).clear();
  }

  public void dispose() {
    if (deployListener != null) {
      ClassLoaderManager classLoaderManager = ApplicationManager.getApplication().getComponent(MPSCoreComponents.class).getClassLoaderManager();
      classLoaderManager.removeListener(deployListener);
    }
    loadedDescriptors = null;
  }

  @Nullable
  public PFDescriptor getDescriptor(@Nullable SModule module, String modelName) {
    PFDescriptor descriptor = getDescriptor_(module, modelName);
    if (descriptor != null) {
      if (deployListener == null) {
        deployListener = new DeployListener() {
          public void onUnloaded(Set<ReloadableModule> modules, @NotNull ProgressMonitor p1) {
            invalidate();
          }
          public void onLoaded(Set<ReloadableModule> modules, @NotNull ProgressMonitor p1) {
            invalidate();
          }
        };
        // The non deprecated API doesn't work when executing tests from the command line, because getApplication returns NULL.
        ClassLoaderManager classLoaderManager = ClassLoaderManager.getInstance();
        classLoaderManager.addListener(deployListener);
      }
    }
    return descriptor;
  }

  protected PFDescriptor getDescriptor_(@Nullable SModule module, String modelName) {
    if (module == null) {
      return null;
    }
    if (!(module instanceof ReloadableModule)) {
      return null;
    }
    if (MapSequence.fromMap(loadedDescriptors).containsKey(MultiTuple.<SModule,String>from(module, modelName))) {
      return MapSequence.fromMap(loadedDescriptors).get(MultiTuple.<SModule,String>from(module, modelName));
    }
    PFDescriptor descriptor = getDescriptor__((ReloadableModule) module, modelName);
    MapSequence.fromMap(loadedDescriptors).put(MultiTuple.<SModule,String>from(module, modelName), descriptor);
    return descriptor;
  }

  protected PFDescriptor getDescriptor__(ReloadableModule module, String modelName) {
    String modelFQName = module.getModuleName() + "." + modelName;
    String className = modelFQName + ".PolymorphicFunctionsDescriptor";
    try {
      Class cls = module.getOwnClass(className);
      Field instanceField = cls.getDeclaredField("INSTANCE");
      PFDescriptor descriptor = as_8t64d5_a0a2a2a81(instanceField.get(null), PFDescriptor.class);
      if (LOG.isDebugLevel()) {
        LOG.debug("Loaded descriptor from " + modelFQName);
      }
      return descriptor;
    } catch (ModuleClassNotFoundException e) {
      return null;
    } catch (IllegalStateException ex) {
      // Module is not part of the repository anymore
      return null;
    } catch (ModuleClassLoaderIsNullException e) {
      return null;
    } catch (ClassNotFoundException e) {
      return null;
    } catch (NoClassDefFoundError e) {
      if (LOG.isErrorLevel()) {
        LOG.error("Failed to load class " + className, e);
      }
      return null;
    } catch (Exception e) {
      if (LOG.isErrorLevel()) {
        LOG.error("", e);
      }
      return null;
    }
  }

  private static <T> T as_8t64d5_a0a2a2a81(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
