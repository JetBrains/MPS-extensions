package de.slisson.mps.tables.runtime.gridmodel;

/*Generated by MPS */

import java.util.Map;
import java.util.List;
import java.util.HashMap;
import org.jetbrains.annotations.NotNull;
import java.util.ArrayList;
import java.util.Objects;

public class GridHeadersUtil {
  private Grid myGrid;
  private Map<IGridElement, List<HeaderReference>> myElementHeaders = new HashMap<IGridElement, List<HeaderReference>>();

  public GridHeadersUtil(@NotNull Grid grid) {
    myGrid = grid;
    rememberHeaders();
  }

  public void rememberHeaders() {
    myElementHeaders.clear();
    for (int x = 0; x < myGrid.getSizeX(); x++) {
      for (int y = 0; y < myGrid.getSizeY(); y++) {
        IGridElement element = myGrid.getElement(x, y);
        if (!(element instanceof IMetaGridElement)) {
          rememberHeaders(element, calcColumnHeaders(x, y));
        }
      }
    }
  }

  private void rememberHeaders(IGridElement element, List<HeaderReference> headers) {
    myElementHeaders.put(element, new ArrayList<HeaderReference>(headers));
  }

  private List<HeaderReference> calcColumnHeaders(int elementX, int elementY) {
    IGridElement element = myGrid.getElement(elementX, elementY);
    List<HeaderReference> result = new ArrayList<HeaderReference>();
    for (int columnY = 0; columnY < myGrid.getColumnHeadersSizeX(); columnY++) {
      if (isColumnHeaderSpanningWholeCell(elementX, columnY, element.getSpanX())) {
        if (result != null) {
          result.add(myGrid.getColumnHeader(elementX, columnY));
        }
      }
    }

    return result;

  }

  private boolean isColumnHeaderSpanningWholeCell(int x, int y, int spanX) {
    HeaderReference header = myGrid.getColumnHeader(x, y);
    for (int i = 1; i < spanX; i++) {
      if (!(Objects.equals(header, myGrid.getColumnHeader(x + i, y)))) {
        return false;
      }
    }
    return true;
  }

  public List<HeaderReference> getRememberedHeaders(IGridElement element) {
    List<HeaderReference> result = myElementHeaders.get(element);
    return (result == null ? new ArrayList<HeaderReference>() : result);
  }

}
