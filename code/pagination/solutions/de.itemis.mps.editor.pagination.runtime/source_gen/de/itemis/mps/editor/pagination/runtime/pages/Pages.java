package de.itemis.mps.editor.pagination.runtime.pages;

/*Generated by MPS */

import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;

public class Pages implements PageIterator<Pages> {
  private final _FunctionTypes._return_P0_E0<? extends Integer> elementsCountFn;
  private final Page currentPage;

  public Pages(final Iterable<SNode> nodes, int pageSize) {
    this(() -> Sequence.fromIterable(nodes).count(), new Page(pageSize));
  }

  public Pages(final List<SNode> nodes, int pageSize) {
    this(() -> ListSequence.fromList(nodes).count(), new Page(pageSize));
  }

  public Pages(_FunctionTypes._return_P0_E0<? extends Integer> elementsCountFn, int pageSize) {
    this(elementsCountFn, new Page(pageSize));
  }

  public Pages(_FunctionTypes._return_P0_E0<? extends Integer> elementsCountFn, Page currentPage) {
    this.elementsCountFn = elementsCountFn;
    this.currentPage = currentPage;
  }

  public int size() {
    final int pageSize = currentPage.getPageSize();
    if (pageSize == 0) {
      return 0;
    }
    return (int) Math.ceil(((double) getCurrentElementsCount()) / pageSize);
  }

  public boolean doesPageExist(Page page) {
    return doesPageExist(page.getPageNumber());
  }

  public boolean doesPageExist(PageNumber pageNumber) {
    return pageNumber.getValue() <= size();
  }

  public Page getCurrentPage() {
    return this.currentPage;
  }

  public int getCurrentElementsCount() {
    return this.elementsCountFn.invoke();
  }

  public _FunctionTypes._return_P0_E0<? extends Integer> getElementsCountFn() {
    return this.elementsCountFn;
  }

  public boolean hasNext() {
    return getCurrentPage().getPageNumber().getValue() < size();
  }

  public Pages next() {
    return (hasNext() ? new Pages(getElementsCountFn(), currentPage.next()) : this);
  }

  public boolean hasPrevious() {
    return getCurrentPage().hasPrevious();
  }

  public Pages previous() {
    return (hasPrevious() ? new Pages(getElementsCountFn(), currentPage.previous()) : this);
  }

  public boolean contains(SNode n) {
    return getCurrentPage().contains(SNodeOperations.getIndexInParent(n));
  }

  public boolean contains(int nodeIndex) {
    return getCurrentPage().contains(nodeIndex);
  }

  public Pages getPagesWith(int pageNumber) {
    return getPagesWith(new PageNumber(pageNumber));
  }

  public Pages getPagesWith(PageNumber pageNumber) {
    return getPagesWith(new Page(pageNumber, getPageSize()));
  }

  public Pages getPagesWith(Page page) {
    if (page.getPageNumber().getValue() > size()) {
      throw new IllegalArgumentException("Page number " + page.getPageNumber() + " greater than the amount of pages (" + this + ")");
    }
    return new Pages(getElementsCountFn(), page);
  }

  public Page findPageFor(int index) {
    if (index < 0 || index > getCurrentElementsCount()) {
      throw new IllegalArgumentException("Invalid index " + index + " with " + getCurrentElementsCount() + " elements (" + this + ")");
    }
    return new Page(new PageNumber((index / getPageSize()) + 1), getPageSize());
  }

  public Page findPageFor(SNode n) {
    return findPageFor(SNodeOperations.getIndexInParent(n));
  }

  public int getPageSize() {
    return getCurrentPage().getPageSize();
  }

  @Override
  public boolean equals(Object obj) {
    if (obj instanceof Pages) {
      Pages otherAsPages = ((Pages) obj);
      return otherAsPages.getCurrentElementsCount() == getCurrentElementsCount() && otherAsPages.getCurrentPage().equals(getCurrentPage());
    }
    return super.equals(obj);
  }

  @Override
  public int hashCode() {
    return getCurrentPage().hashCode() * 31 + getCurrentElementsCount();
  }

  @Override
  public String toString() {
    return String.format("on (%s) of %d pages", getCurrentPage(), size());
  }

}
