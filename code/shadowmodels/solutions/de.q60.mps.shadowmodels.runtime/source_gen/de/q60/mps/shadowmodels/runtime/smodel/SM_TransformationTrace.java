package de.q60.mps.shadowmodels.runtime.smodel;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import de.q60.mps.shadowmodels.runtime.engine.IOutputNodeReference;
import org.modelix.model.api.INode;
import java.util.Collections;
import org.modelix.model.mpsadapters.mps.NodeToSNodeAdapter;
import org.modelix.model.mpsadapters.mps.ANode;
import de.q60.mps.shadowmodels.runtime.engine.ITransformationEngine;
import de.q60.mps.shadowmodels.runtime.engine.OutputNodeReferenceAsNode;
import org.jetbrains.annotations.Nullable;
import de.q60.mps.shadowmodels.runtime.engine.IResultElement;
import de.q60.mps.shadowmodels.runtime.engine.ResultElementAsOutputNode;
import de.q60.mps.shadowmodels.runtime.engine.DependencyTrackingNode;
import de.q60.mps.shadowmodels.runtime.engine.IStageReference;
import de.q60.mps.shadowmodels.runtime.engine.IOutputNode;
import de.q60.mps.shadowmodels.runtime.engine.IScope;

public class SM_TransformationTrace {
  public static SNode getInputNode(final SNode outputSNode_) {
    return Sequence.fromIterable(getInputNodes(outputSNode_, false, true)).first();
  }

  public static Iterable<SNode> getInputNodes(final SNode outputSNode_) {
    return getInputNodes(outputSNode_, true, true);
  }

  public static SNode tryGetInputNode(final SNode outputSNode_) {
    return Sequence.fromIterable(getInputNodes(outputSNode_, false, false)).first();
  }

  public static Iterable<SNode> tryGetInputNodes(final SNode outputSNode_) {
    return getInputNodes(outputSNode_, true, false);
  }

  public static Iterable<SNode> tryGetOriginalInputNodes(SNode outputNode) {
    return Sequence.fromIterable(getInputNodes(outputNode, true, false)).translate((it) -> getOriginalInputNodesOrSelf(it));
  }

  private static Iterable<SNode> getOriginalInputNodesOrSelf(final SNode outputSNode_) {
    Iterable<SNode> inputNodes = getInputNodes(outputSNode_, true, false);
    if (Sequence.fromIterable(inputNodes).isEmpty()) {
      return Sequence.<SNode>singleton(outputSNode_);
    }
    return Sequence.fromIterable(inputNodes).translate((it) -> getOriginalInputNodesOrSelf(it));
  }

  private static Iterable<SNode> getInputNodes(final SNode outputSNode_, boolean allowMultiple, boolean throwExeceptions) {
    IOutputNodeReference outputNodeReference = getOutputNodeReference(outputSNode_);
    if (outputNodeReference != null) {
      Iterable<INode> inputNodes = outputNodeReference.getInputNodes();
      if (Sequence.fromIterable(inputNodes).count() == 0) {
        if (!(throwExeceptions)) {
          return Sequence.fromIterable(Collections.<SNode>emptyList());
        }
        throw new RuntimeException(outputNodeReference + " has no input nodes");
      }
      if (!(allowMultiple) && Sequence.fromIterable(inputNodes).count() > 1) {
        if (!(throwExeceptions)) {
          return Sequence.fromIterable(Collections.<SNode>emptyList());
        }
        throw new RuntimeException(outputNodeReference + " has multiple input nodes");
      }
      return Sequence.fromIterable(inputNodes).select((it) -> {
        SNode inputSNode = NodeToSNodeAdapter.wrap(it);
        if (outputSNode_ instanceof ANode) {
          inputSNode = ANode.wrap(inputSNode);
        }
        return inputSNode;
      });
    }
    if (!(throwExeceptions)) {
      return Sequence.fromIterable(Collections.<SNode>emptyList());
    }
    throw new RuntimeException("Not the output of a transformation: " + outputSNode_);
  }

  public static ITransformationEngine getEngine(INode node) {
    if (node instanceof OutputNodeReferenceAsNode) {
      return ((OutputNodeReferenceAsNode) node).getEngine();
    }
    return null;
  }

  public static ITransformationEngine getEngine(SNode node) {
    return getEngine(getINode(node));
  }

  public static IOutputNodeReference getOutputNodeReference(INode outputNode) {
    if (outputNode instanceof OutputNodeReferenceAsNode) {
      return ((OutputNodeReferenceAsNode) outputNode).getOutputNodeReference();
    }
    return null;
  }

  public static IOutputNodeReference getOutputNodeReference(SNode outputSNode) {
    return getOutputNodeReference(getINode(outputSNode));
  }

  @Nullable
  public static IResultElement getResultElement(SNode outputSNode) {
    OutputNodeReferenceAsNode proxy = getResultElementProxy(outputSNode);
    if (proxy == null) {
      return null;
    }
    return check_i1vg9n_a2a22(as_i1vg9n_a0a2a22(proxy.resolveNode(), ResultElementAsOutputNode.class));
  }

  @Nullable
  public static OutputNodeReferenceAsNode getResultElementProxy(SNode outputSNode) {
    INode outputNode = getINode(outputSNode);
    if (outputNode instanceof OutputNodeReferenceAsNode) {
      return ((OutputNodeReferenceAsNode) outputNode);
    }
    return null;
  }

  public static INode getINode(SNode outputSNode_) {
    SNode outputSNode = ANode.unwrap(outputSNode_);
    INode outputNode = null;
    if (outputSNode instanceof NodeToSNodeAdapter) {
      outputNode = ((NodeToSNodeAdapter) outputSNode).getWrapped();
    } else {
      if (SM_RepositoryModulesManager.isEnabled()) {
        outputNode = SM_RepositoryModulesManager.getInstance().getTransformationOutputNode(outputSNode);
      }
    }
    outputNode = DependencyTrackingNode.unwrap(outputNode);
    return outputNode;
  }

  public static IStageReference getSubgraphStage(INode node) {
    return getSubgraphStage(getOutputNodeReference(node));
  }

  public static IStageReference getSubgraphStage(SNode node) {
    return getSubgraphStage(getINode(node));
  }

  public static IStageReference getSubgraphStage(IOutputNodeReference nodeRef) {
    if (nodeRef == null) {
      return null;
    }
    return nodeRef.getStageRef();
  }

  public static IOutputNode getOutputNode(INode node) {
    return check_i1vg9n_a0a43(as_i1vg9n_a0a0a43(node, OutputNodeReferenceAsNode.class));
  }

  public static IOutputNode getOutputNode(SNode node) {
    return getOutputNode(getINode(node));
  }

  public static IScope getScope(SNode node) {
    return getScope(getINode(node));
  }

  public static IScope getScope(INode node) {
    return getScope(as_i1vg9n_a0a0a04(node, OutputNodeReferenceAsNode.class));
  }

  public static IScope getScope(OutputNodeReferenceAsNode node) {
    if (node == null) {
      return null;
    }
    return node.getOutputNodeReference().getScope(node.getEngine());
  }
  private static IResultElement check_i1vg9n_a2a22(ResultElementAsOutputNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getElement();
    }
    return null;
  }
  private static IOutputNode check_i1vg9n_a0a43(OutputNodeReferenceAsNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.resolveNode();
    }
    return null;
  }
  private static <T> T as_i1vg9n_a0a2a22(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_i1vg9n_a0a0a43(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_i1vg9n_a0a0a04(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
