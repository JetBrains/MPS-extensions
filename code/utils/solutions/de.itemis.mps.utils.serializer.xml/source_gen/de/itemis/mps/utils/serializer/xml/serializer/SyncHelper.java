package de.itemis.mps.utils.serializer.xml.serializer;

/*Generated by MPS */

import org.jdom2.Document;
import org.jdom2.JDOMException;
import java.io.IOException;
import java.io.File;
import org.jdom2.input.SAXBuilder;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import java.util.List;
import org.jdom2.Element;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SProperty;

public class SyncHelper {

  public SyncHelper() {
  }


  protected Document openDocument(String filename) throws JDOMException, IOException {
    File f = new File(filename);
    ClassLoader cl = Thread.currentThread().getContextClassLoader();
    try {
      Thread.currentThread().setContextClassLoader(this.getClass().getClassLoader());
      SAXBuilder sax = new SAXBuilder();
      return sax.build(f);
    } finally {
      Thread.currentThread().setContextClassLoader(cl);
    }
  }



  protected void removeDeleted(SNode block, SAbstractConcept c, List<Element> elements) {
    Sequence.fromIterable(findDeleted(block, c, elements)).visitAll((it) -> SNodeOperations.deleteNode(it));
  }

  protected Iterable<SNode> findDeleted(SNode block, SAbstractConcept c, final List<Element> elements) {
    List<SNode> all = SNodeOperations.getNodeDescendants(block, SNodeOperations.asSConcept(c), false, new SAbstractConcept[]{});
    return ListSequence.fromList(all).where((final SNode desc) -> !(ListSequence.fromList(elements).any((it) -> it.getAttributeValue("name").equals(SPropertyOperations.getString(SNodeOperations.cast(desc, CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL)))));
  }

  protected Iterable<Element> findNew(SNode block, SAbstractConcept c, List<Element> elements) {
    final List<SNode> all = SNodeOperations.getNodeDescendants(block, SNodeOperations.asSConcept(c), false, new SAbstractConcept[]{});
    return ListSequence.fromList(elements).where((final Element el) -> !(ListSequence.fromList(all).any((node) -> SPropertyOperations.getString(SNodeOperations.cast(node, CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL).equals(el.getAttributeValue("name")))));
  }

  protected Iterable<Tuples._2<SNode, Element>> findExisting(SNode context, SAbstractConcept c, final List<Element> elements) {
    List<SNode> all = SNodeOperations.getNodeDescendants(context, SNodeOperations.asSConcept(c), false, new SAbstractConcept[]{});
    return ListSequence.fromList(all).where((final SNode node) -> ListSequence.fromList(elements).any((el) -> {
      String name = el.getAttributeValue("name");
      return name != null && name.equals(SPropertyOperations.getString(SNodeOperations.cast(node, CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL));
    })).select((final SNode node) -> MultiTuple.<SNode,Element>from(node, ListSequence.fromList(elements).findFirst((el) -> el.getAttributeValue("name").equals(SPropertyOperations.getString(SNodeOperations.cast(node, CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL)))));
  }
  protected Iterable<SNode> findExisting(SNode context, SAbstractConcept c, final String name) {
    List<SNode> all = SNodeOperations.getNodeDescendants(context, SNodeOperations.asSConcept(c), false, new SAbstractConcept[]{});
    return ListSequence.fromList(all).where((node) -> SPropertyOperations.getString(SNodeOperations.cast(node, CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL).equals(name));
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept INamedConcept$Kd = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, "jetbrains.mps.lang.core.structure.INamedConcept");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
