package de.itemis.mps.selection.runtime.intentions;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.util.Map;
import org.jetbrains.mps.openapi.module.SModuleReference;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.smodel.runtime.ModuleDeploymentListener;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.smodel.runtime.ModuleDeploymentChange;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.smodel.runtime.ModuleRuntime;
import jetbrains.mps.smodel.LanguageAspect;
import jetbrains.mps.openapi.editor.selection.Selection;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;

public class SelectionIntentionsManager {
  private static final Logger LOG = Logger.getLogger(SelectionIntentionsManager.class);
  public static final String DESCRIPTOR_CLASS_NAME = "SelectionIntentionsDescriptor";

  private static SelectionIntentionsManager INSTANCE = new SelectionIntentionsManager();

  public static SelectionIntentionsManager getInstance() {
    return INSTANCE;
  }

  private final Map<SModuleReference, List<ISelectionIntentionFactory>> myFactories = MapSequence.fromMap(new HashMap<>());

  private LanguageRegistry myLanguageRegistry;
  private final ModuleDeploymentListener myClasseslistener = new ModuleDeploymentListener() {
    @Override
    public void deploymentStateChanged(@NotNull ModuleDeploymentChange change) {
      change.forEachRemoved(SelectionIntentionsManager.this::unloadModule);
      change.forEachReloaded(SelectionIntentionsManager.this::unloadModule);
      change.forEachReloaded(SelectionIntentionsManager.this::loadModule);
      change.forEachAdded(SelectionIntentionsManager.this::loadModule);
    }
  };

  public void init(@NotNull LanguageRegistry languageRegistry) {
    if (myLanguageRegistry != null) {
      throw new IllegalStateException("SelectionIntentionsManager already initialized");
    }

    myLanguageRegistry = languageRegistry;
    languageRegistry.addRegistryListener(myClasseslistener);
    languageRegistry.withModuleRuntime(languageRegistry.getAllLanguages().stream().map(SLanguage::getSourceModuleReference), this::loadModule);
  }

  public void dispose() {
    if (myLanguageRegistry != null) {
      myLanguageRegistry.removeRegistryListener(myClasseslistener);
      myLanguageRegistry = null;
      MapSequence.fromMap(myFactories).clear();
    }
  }

  /*package*/ void unloadModule(ModuleRuntime module) {
    MapSequence.fromMap(myFactories).removeKey(module.getSourceModule());
  }

  /*package*/ void loadModule(ModuleRuntime module) {
    String className = module.getSourceModule().getModuleName() + "." + LanguageAspect.INTENTIONS.getName() + "." + DESCRIPTOR_CLASS_NAME;
    try {
      Class<?> descriptorClass = module.getOwnClass(className);
      ISelectionIntentionsDescriptor descriptor = (ISelectionIntentionsDescriptor) descriptorClass.getDeclaredConstructor().newInstance();
      MapSequence.fromMap(myFactories).put(module.getSourceModule(), descriptor.getFactories());
    } catch (ClassNotFoundException ex) {
      // Module does not have a selection intentions descriptor, this is normal
    } catch (Exception e) {
      // Module has a descriptor but it could not be loaded, report and continue
      if (LOG.isErrorLevel()) {
        LOG.error("Could not load class " + className + " from module " + module.getSourceModule(), e);
      }
    }
  }

  public List<ISelectionIntentionExecutable> getIntentions(Selection selection) {
    List<ISelectionIntentionExecutable> intentions = ListSequence.fromList(new ArrayList<ISelectionIntentionExecutable>());
    for (List<ISelectionIntentionFactory> factories : Sequence.fromIterable(MapSequence.fromMap(myFactories).values())) {
      for (ISelectionIntentionFactory factory : ListSequence.fromList(factories)) {
        ListSequence.fromList(intentions).addSequence(ListSequence.fromList(factory.getInstances(selection)));
      }
    }
    return intentions;
  }

  public List<ISelectionIntentionExecutable> getApplicableIntentions(final Selection selection) {
    final Wrappers._T<List<ISelectionIntentionExecutable>> result = new Wrappers._T<List<ISelectionIntentionExecutable>>(null);
    selection.getEditorComponent().getEditorContext().getRepository().getModelAccess().runReadAction(() -> {
      result.value = ListSequence.fromList(getIntentions(selection)).where(new _FunctionTypes._return_P1_E0<Boolean, ISelectionIntentionExecutable>() {
        public Boolean invoke(ISelectionIntentionExecutable it) {
          return it.isApplicable(selection);
        }
      }).toList();
    });
    return result.value;
  }
}
