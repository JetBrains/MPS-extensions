package com.mbeddr.mpsutil.editor.querylist.runtime;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import org.jetbrains.mps.openapi.model.SNode;

public class QueryListContext {

  private static List<QueryListContext> ourContextStack = ListSequence.fromList(new ArrayList<QueryListContext>());

  protected static void pushContext(QueryListContext context) {
    ListSequence.fromList(ourContextStack).addElement(context);
  }

  protected static void popContext() {
    ListSequence.fromList(ourContextStack).removeLastElement();
  }

  public static void runWithContext(QueryListContext context, final Runnable runnable) {
    pushContext(context);
    try {
      runnable.run();
    } finally {
      popContext();
    }
  }

  public static <T> T computeWithContext(QueryListContext context, final _FunctionTypes._return_P0_E0<? extends T> runnable) {
    final Wrappers._T<T> result = new Wrappers._T<T>(null);
    runWithContext(context, () -> result.value = runnable.invoke());
    return result.value;
  }

  public static QueryListContext getCurrentContext() {
    return ListSequence.fromList(ourContextStack).last();
  }

  private SNode mySNode;
  private int currentIndex = 0;

  public QueryListContext(SNode node) {
    mySNode = node;
  }

  public SNode getSNode() {
    return mySNode;
  }

  public void increaseIndex() {
    currentIndex++;
  }

  public int getIndex() {
    return currentIndex;
  }

  public QueryListContext getParentContext() {
    int index = ListSequence.fromList(ourContextStack).indexOf(this) - 1;
    if (0 <= index && index < ListSequence.fromList(ourContextStack).count()) {
      return ListSequence.fromList(ourContextStack).getElement(index);
    }
    return null;
  }
}
