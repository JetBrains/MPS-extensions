package com.mbeddr.mpsutil.grammarcells.runtime.menu;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.menus.transformation.TransformationMenuLookup;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.annotations.NotNull;
import java.util.Collection;
import jetbrains.mps.openapi.editor.descriptor.TransformationMenu;
import org.jetbrains.mps.openapi.language.SLanguage;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.IterableUtils;

public class CompositeTransformationMenuLookup implements TransformationMenuLookup {
  public static TransformationMenuLookup combine(TransformationMenuLookup lookup1, TransformationMenuLookup lookup2) {
    if (lookup1 == null) {
      return lookup2;
    }
    if (lookup2 == null) {
      return lookup1;
    }
    return new CompositeTransformationMenuLookup(lookup1, lookup2).flatten();
  }
  public static void add(EditorCell cell, TransformationMenuLookup lookup) {
    cell.setTransformationMenuLookup(combine(cell.getTransformationMenuLookup(), lookup));
  }
  public static void filter(EditorCell cell, _FunctionTypes._return_P1_E0<? extends Boolean, ? super TransformationMenuLookup> condition) {
    TransformationMenuLookup lookup = cell.getTransformationMenuLookup();
    if (lookup == null) {
      return;
    }
    CompositeTransformationMenuLookup compositeLookup = (lookup instanceof CompositeTransformationMenuLookup ? ((CompositeTransformationMenuLookup) lookup) : new CompositeTransformationMenuLookup(lookup));
    cell.setTransformationMenuLookup(compositeLookup.filter(condition));
  }

  private TransformationMenuLookup[] lookups;
  private CompositeTransformationMenuLookup(TransformationMenuLookup... lookups) {
    this.lookups = lookups;
  }

  public TransformationMenuLookup filter(final _FunctionTypes._return_P1_E0<? extends Boolean, ? super TransformationMenuLookup> condition) {
    TransformationMenuLookup[] filtered = Sequence.fromIterable(getLookups()).where((it) -> condition.invoke(it)).toGenericArray(TransformationMenuLookup.class);
    if (filtered.length == 1) {
      return filtered[0];
    }
    return new CompositeTransformationMenuLookup(filtered);
  }

  public Iterable<TransformationMenuLookup> getLookups() {
    return Sequence.fromArray(lookups);
  }

  @NotNull
  @Override
  public Collection<TransformationMenu> lookup(@NotNull final Collection<SLanguage> usedLanguages, @NotNull final String menuLocation) {
    return Sequence.fromIterable(Sequence.fromArray(lookups)).translate((it) -> it.lookup(usedLanguages, menuLocation)).toList();
  }

  public TransformationMenuLookup flatten() {
    if (Sequence.fromIterable(Sequence.fromArray(lookups)).ofType(CompositeTransformationMenuLookup.class).isEmpty()) {
      return this;
    }
    List<TransformationMenuLookup> flatList = Sequence.fromIterable(Sequence.fromArray(lookups)).select((it) -> (it instanceof CompositeTransformationMenuLookup ? ((CompositeTransformationMenuLookup) it).flatten() : it)).translate((it) -> (it instanceof CompositeTransformationMenuLookup ? Sequence.fromArray(((CompositeTransformationMenuLookup) it).lookups) : Sequence.<TransformationMenuLookup>singleton(it))).toList();
    return (ListSequence.fromList(flatList).count() == 1 ? ListSequence.fromList(flatList).first() : new CompositeTransformationMenuLookup(ListSequence.fromList(flatList).toGenericArray(TransformationMenuLookup.class)));
  }

  @Override
  public String toString() {
    if (lookups.length == 0) {
      return "empty composite";
    }
    return IterableUtils.join(Sequence.fromIterable(Sequence.fromArray(lookups)).select((it) -> it.toString()), " + ");
  }
}
