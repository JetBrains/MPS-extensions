package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import com.mxgraph.swing.handler.mxGraphTransferHandler;
import javax.swing.ImageIcon;
import com.mxgraph.swing.mxGraphComponent;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import javax.swing.JComponent;
import java.awt.datatransfer.DataFlavor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import de.itemis.mps.editor.diagram.runtime.model.GenericTransferable;
import javax.swing.TransferHandler;
import java.awt.Point;

public class MyGraphTransferHandler extends mxGraphTransferHandler {

  private MyGraphComponent myGraphComponent;

  public MyGraphTransferHandler(MyGraphComponent graphComponent) {
    myGraphComponent = graphComponent;
  }

  @Override
  public ImageIcon createTransferableImage(final mxGraphComponent component, final Object[] cells) {
    final Wrappers._T<ImageIcon> result = new Wrappers._T<ImageIcon>(null);
    myGraphComponent.getGraph().getView().suspendMPSCellLayouting(() -> result.value = MyGraphTransferHandler.super.createTransferableImage(component, cells));
    return result.value;
  }

  @Override
  public boolean canImport(JComponent comp, DataFlavor[] flavors) {
    if (Sequence.fromIterable(Sequence.fromArray(flavors)).contains(GenericTransferable.GENERIC_FLAVOR)) {
      return true;
    }
    return super.canImport(comp, flavors);
  }

  @Override
  public boolean importData(TransferHandler.TransferSupport support) {
    if (support.getTransferable().isDataFlavorSupported(GenericTransferable.GENERIC_FLAVOR)) {
      Point dropPoint = support.getDropLocation().getDropPoint();
      Object cell = myGraphComponent.getCellAt(dropPoint.x, dropPoint.y);
      final Wrappers._boolean imported = new Wrappers._boolean(false);
      if (cell instanceof IDiagramDCell) {
        final IDiagramDCell dcell = ((IDiagramDCell) cell);
        final Object data = GenericTransferable.getTransferData(support.getTransferable());
        myGraphComponent.getEditorComponent().getEditorContext().getRepository().getModelAccess().executeCommand(() -> {
          if (dcell.canDrop(data)) {
            dcell.drop(data);
            imported.value = true;
          }
        });
      }
      return imported.value;
    }

    return super.importData(support);
  }
}
