package com.mbeddr.mpsutil.grammarcells.runtime.insertpopup;

/*Generated by MPS */

import com.intellij.openapi.ui.popup.util.BaseListPopupStep;
import java.util.List;
import com.intellij.openapi.ui.popup.PopupStep;
import javax.swing.Icon;
import jetbrains.mps.nodeEditor.cellMenu.CompletionActionItemAsSubstituteAction;
import jetbrains.mps.smodel.runtime.IconResource;
import jetbrains.mps.ide.icons.GlobalIconManager;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SAbstractLink;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.openapi.editor.cells.SubstituteAction;

public class InsertActionListPopupStep extends BaseListPopupStep<CellActionExecuter> {
  public InsertActionListPopupStep(List<CellActionExecuter> values) {
    super("Insert New Node", values);
  }
  @Override
  public PopupStep onChosen(final CellActionExecuter chosenAction, final boolean finalChoice) {
    if (finalChoice) {
      chosenAction.execute();
      return FINAL_CHOICE;
    } else {
      return new SubStep(chosenAction, new AlwaysChooseThis(chosenAction), new DisableInsertPopup(chosenAction));
    }
  }
  @Override
  public Icon getIconFor(CellActionExecuter value) {
    CompletionActionItemAsSubstituteAction unwrappedAction = as_4rhhyt_a0a0a2(check_4rhhyt_a0a0a2(as_4rhhyt_a0a0a0a0c(value.getAction(), SubstituteActionAsCellAction.class)), CompletionActionItemAsSubstituteAction.class);
    if (unwrappedAction != null) {
      IconResource icon = unwrappedAction.getIcon("");
      if (icon != null) {
        return GlobalIconManager.getInstance().getIconForResource(icon);
      }
      SNode iconNode = unwrappedAction.getIconNode("");
      if (iconNode != null) {
        return GlobalIconManager.getInstance().getIconFor(iconNode);
      }
      SNode actionType = unwrappedAction.getActionType("");
      if (actionType != null) {
        return GlobalIconManager.getInstance().getIconFor(actionType);
      }
      SNode outputConcept = unwrappedAction.getOutputConcept();
      if (outputConcept != null) {
        return GlobalIconManager.getInstance().getIconFor(outputConcept);
      }
    }

    SAbstractLink role = value.getRole();
    if (role != null) {
      return GlobalIconManager.getInstance().getIconFor(role.getTargetConcept());
    }
    return super.getIconFor(value);
  }
  @Override
  public boolean hasSubstep(CellActionExecuter selectedValue) {
    return true;
  }

  public static class SubStep extends BaseListPopupStep<SettingsAction> {

    private CellActionExecuter action;

    public SubStep(CellActionExecuter action, InsertActionListPopupStep.SettingsAction... actions) {
      super("Settings", actions);
      this.action = action;
    }
    @Nullable
    @Override
    public PopupStep<?> onChosen(InsertActionListPopupStep.SettingsAction selectedValue, boolean finalChoice) {
      if (finalChoice) {
        selectedValue.execute();
      }
      return super.onChosen(selectedValue, finalChoice);
    }

    @NotNull
    @Override
    public String getTextFor(InsertActionListPopupStep.SettingsAction value) {
      return value.text;
    }
  }

  public abstract class SettingsAction {
    private String text;
    protected CellActionExecuter action;
    public SettingsAction(String text, CellActionExecuter action) {
      this.text = text;
      this.action = action;
    }
    public abstract void execute();
  }

  public class AlwaysChooseThis extends SettingsAction {

    public AlwaysChooseThis(CellActionExecuter action) {
      super("Always Choose This", action);
    }
    @Override
    public void execute() {
      List<CellActionExecuter> availableOptions = getValues();
      List<String> options = ListSequence.fromList(availableOptions).select((it) -> it.toString()).toList();
      InsertPopupSettings.INSTANCE.storeResolvedAmbiguity(options, ListSequence.fromList(availableOptions).indexOf(action));
      action.execute();
    }
  }
  public class NeverShowThis extends SettingsAction {

    public NeverShowThis(CellActionExecuter action) {
      super("Never Show This", action);
    }
    @Override
    public void execute() {
    }
  }
  public class DisableInsertPopup extends SettingsAction {

    public DisableInsertPopup(CellActionExecuter action) {
      super("Disable This Menu", action);
    }
    @Override
    public void execute() {
      InsertPopupSettings.INSTANCE.setPopupDisabled(true);
    }
  }

  private static SubstituteAction check_4rhhyt_a0a0a2(SubstituteActionAsCellAction checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getAction();
    }
    return null;
  }
  private static <T> T as_4rhhyt_a0a0a2(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_4rhhyt_a0a0a0a0c(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
