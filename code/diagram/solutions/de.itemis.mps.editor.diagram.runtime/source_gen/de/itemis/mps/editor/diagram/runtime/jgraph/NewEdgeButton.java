package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import de.itemis.mps.editor.diagram.runtime.model.IConnectionType_Internal;
import com.mxgraph.view.mxCellState;
import org.jetbrains.annotations.Nullable;
import java.awt.Graphics2D;
import de.itemis.mps.editor.diagram.runtime.model.Bounds;
import de.itemis.mps.editor.diagram.runtime.model.Point;
import java.awt.event.MouseEvent;
import com.mxgraph.swing.handler.mxConnectionHandler;
import de.slisson.mps.reflection.runtime.ReflectionUtil;

public class NewEdgeButton extends ContextButton {
  private IConnectionType_Internal myConnectionType;

  public NewEdgeButton(double size, mxCellState state) {
    this(size, state, null);
  }

  public NewEdgeButton(double size, mxCellState state, @Nullable IConnectionType_Internal connectionType) {
    super(size, state);
    myConnectionType = connectionType;
  }

  @Override
  protected void paintSymbol(Graphics2D g_) {
    if (myConnectionType == null) {
      DrawUtil.executeWithGraphicsCopy(g_, (Graphics2D g) -> {
        g.setColor(g.getColor().brighter());

        Bounds bounds = getBounds();
        bounds.scale(0.6);
        bounds.move(getLineWidth() * 1.0, getLineWidth() * 1.0);

        Point centerTop = new Point(bounds.getCenterX(), bounds.getY());
        Point centerBottom = new Point(bounds.getCenterX(), bounds.getMaxY());

        drawLine(g, bounds.getRightTop(), centerTop);
        drawLine(g, centerTop, centerBottom);
        drawLine(g, centerBottom, bounds.getLeftBottom());
      });
      DrawUtil.executeWithGraphicsCopy(g_, (Graphics2D g) -> {
        g.setColor(g.getColor().darker());

        Bounds plusBounds = getBounds();
        plusBounds.scale(0.4);
        plusBounds.setRightBottom(new Point(getBounds().getMaxX() - getLineWidth() * 1.0, getBounds().getMaxY() - getLineWidth() * 1.0));
        drawLine(g, new Point(plusBounds.getCenterX(), plusBounds.getMinY()), new Point(plusBounds.getCenterX(), plusBounds.getMaxY()));
        drawLine(g, new Point(plusBounds.getMinX(), plusBounds.getCenterY()), new Point(plusBounds.getMaxX(), plusBounds.getCenterY()));
      });
    } else {
      DrawUtil.executeWithGraphicsCopy(g_, (Graphics2D g) -> myConnectionType.drawIcon(g, ExtensionMethods.toRectangle2D(getBounds())));
    }

  }

  @Override
  public void mouseDragged(MouseEvent event) {
    mxConnectionHandler connectionHandler = getGraph().getGraphComponent().getConnectionHandler();
    if (!(connectionHandler.isConnecting())) {
      MyGraph graph = (MyGraph) myCellState.getView().getGraph();
      graph.getConnectionTypeChooser().setForced(myConnectionType);
      ReflectionUtil.writeField(mxConnectionHandler.class, connectionHandler, "active", true);
      ReflectionUtil.writeField(mxConnectionHandler.class, connectionHandler, "source", myCellState);
      connectionHandler.start(event, myCellState);
      event.consume();

    }
  }

  @Override
  public String getTooltip() {
    return (myConnectionType == null ? "Create connection" : "Create connection: " + myConnectionType.getName());
  }
}
