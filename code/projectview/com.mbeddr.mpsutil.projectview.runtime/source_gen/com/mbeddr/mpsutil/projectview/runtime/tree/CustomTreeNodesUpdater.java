package com.mbeddr.mpsutil.projectview.runtime.tree;

/*Generated by MPS */

import jetbrains.mps.project.Project;
import java.util.List;
import jetbrains.mps.smodel.event.SModelEvent;
import jetbrains.mps.ide.ThreadUtils;
import jetbrains.mps.smodel.ModelReadRunnable;
import java.util.Set;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.LinkedHashSet;
import jetbrains.mps.smodel.event.SModelEventVisitorAdapter;
import jetbrains.mps.smodel.event.SModelRootEvent;
import jetbrains.mps.smodel.event.SModelChildEvent;
import jetbrains.mps.smodel.event.SModelPropertyEvent;
import jetbrains.mps.smodel.event.SModelReferenceEvent;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;

public class CustomTreeNodesUpdater {

  private Project myProject;
  private DependencyRecorder<CustomTreeNode> myChildrenRecorder = new DependencyRecorder<CustomTreeNode>();
  private DependencyRecorder<CustomTreeNode> myPresentationRecorder = new DependencyRecorder<CustomTreeNode>();
  private GlobalModelsEventsCollector myEventsCollector;

  public CustomTreeNodesUpdater(Project project) {
    myProject = project;
    myEventsCollector = new GlobalModelsEventsCollector(myProject.getRepository()) {
      protected void eventsHappened(List<SModelEvent> events) {
        update(events);
      }
    };
  }

  public void init() {
    myEventsCollector.start();
  }

  public void dispose() {
    myEventsCollector.stop();
  }

  public void recordChildrenLoad(CustomTreeNode treeNode, Runnable runnable) {
    myChildrenRecorder.rebuild(treeNode, runnable);
  }

  public void recordPresentationLoad(CustomTreeNode treeNode, Runnable runnable) {
    myPresentationRecorder.rebuild(treeNode, runnable);
  }

  protected void update(final List<SModelEvent> events) {
    ThreadUtils.runInUIThreadNoWait(new ModelReadRunnable(myProject.getModelAccess(), () -> doUpdate(events)));
  }

  protected void doUpdate(List<SModelEvent> events) {
    if (myProject.isDisposed()) {
      return;
    }

    final Set<SNode> changedNodes = SetSequence.fromSet(new HashSet<SNode>());
    final Set<SModel> changedModels = SetSequence.fromSet(new HashSet<SModel>());
    collectChanges(events, changedNodes, changedModels);

    Set<CustomTreeNode> treeNodesToUpdateChildren = new LinkedHashSet<CustomTreeNode>();
    Set<CustomTreeNode> treeNodesToUpdatePresentation = new LinkedHashSet<CustomTreeNode>();
    for (SNode changedNode : changedNodes) {
      SetSequence.fromSet(treeNodesToUpdateChildren).addSequence(SetSequence.fromSet(myChildrenRecorder.getDependOn(changedNode)));
      SetSequence.fromSet(treeNodesToUpdatePresentation).addSequence(SetSequence.fromSet(myPresentationRecorder.getDependOn(changedNode)));
    }
    for (SModel changedModel : changedModels) {
      SetSequence.fromSet(treeNodesToUpdateChildren).addSequence(SetSequence.fromSet(myChildrenRecorder.getDependOn(changedModel)));
      SetSequence.fromSet(treeNodesToUpdatePresentation).addSequence(SetSequence.fromSet(myPresentationRecorder.getDependOn(changedModel)));
    }
    updateChildrens(treeNodesToUpdateChildren);
    updatePresentations(treeNodesToUpdatePresentation);
  }

  protected void collectChanges(List<SModelEvent> events, final Set<SNode> changedNodes, final Set<SModel> changesModels) {
    for (SModelEvent event : events) {
      event.accept(new SModelEventVisitorAdapter() {
        @Override
        public void visitRootEvent(SModelRootEvent event) {
          SetSequence.fromSet(changedNodes).addElement(event.getRoot());
          SetSequence.fromSet(changesModels).addElement(event.getModel());
        }
        @Override
        public void visitChildEvent(SModelChildEvent event) {
          SetSequence.fromSet(changedNodes).addElement(event.getParent());
          SetSequence.fromSet(changedNodes).addElement(event.getChild());
        }
        @Override
        public void visitPropertyEvent(SModelPropertyEvent event) {
          SetSequence.fromSet(changedNodes).addElement(event.getNode());
        }
        @Override
        public void visitReferenceEvent(SModelReferenceEvent event) {
          SetSequence.fromSet(changedNodes).addElement(event.getReference().getSourceNode());
        }
      });
    }
  }

  protected void updateChildrens(Iterable<CustomTreeNode> parentTreeNodes) {
    Sequence.fromIterable(parentTreeNodes).visitAll(new _FunctionTypes._void_P1_E0<CustomTreeNode>() {
      public void invoke(CustomTreeNode it) {
        updateChildren(it);
      }
    });
  }

  protected void updateChildren(CustomTreeNode parentTreeNode) {
    myChildrenRecorder.remove(parentTreeNode);
    if (parentTreeNode.isAutoUpdate()) {
      if (parentTreeNode.isInTree()) {
        parentTreeNode.updateSubTree();
      }
    } else {
      parentTreeNode.setInvalid(true);
    }
  }

  protected void updatePresentations(Iterable<CustomTreeNode> treeNodes) {
    Sequence.fromIterable(treeNodes).visitAll(new _FunctionTypes._void_P1_E0<CustomTreeNode>() {
      public void invoke(CustomTreeNode it) {
        updatePresentation(it);
      }
    });
  }

  protected void updatePresentation(CustomTreeNode treeNode) {
    myPresentationRecorder.remove(treeNode);
    if (treeNode.isInTree()) {
      treeNode.renewPresentation();
    }
  }

}
