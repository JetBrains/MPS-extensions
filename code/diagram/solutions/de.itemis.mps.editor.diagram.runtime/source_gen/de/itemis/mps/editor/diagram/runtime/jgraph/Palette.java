package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import javax.swing.JPanel;
import jetbrains.mps.logging.Logger;
import javax.swing.ImageIcon;
import jetbrains.mps.ide.icons.IdeIcons;
import java.awt.Color;
import com.intellij.ui.JBColor;
import jetbrains.mps.project.Project;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.plugins.projectplugins.ProjectPluginManager;
import de.itemis.mps.editor.diagram.runtime.plugin.Diagram_Palette_Tool;
import java.lang.ref.WeakReference;
import de.itemis.mps.editor.diagram.runtime.model.IPaletteEntryProvider;
import de.itemis.mps.editor.diagram.runtime.model.DiagramModel;
import java.util.Map;
import java.util.TreeMap;
import javax.swing.Timer;
import org.jetbrains.annotations.NotNull;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import java.awt.BorderLayout;
import javax.swing.BoxLayout;
import javax.swing.JComponent;
import javax.swing.JScrollPane;
import javax.swing.BorderFactory;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.awt.Component;
import com.intellij.openapi.wm.IdeFrame;
import com.intellij.openapi.wm.WindowManager;
import java.util.List;
import com.intellij.ui.tabs.JBTabs;
import com.intellij.openapi.util.Condition;
import jetbrains.mps.nodeEditor.EditorComponent;
import java.util.ArrayList;
import java.awt.Rectangle;
import java.util.ListIterator;
import java.util.Collections;
import java.util.Comparator;
import java.util.Objects;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import org.jetbrains.annotations.Nullable;
import de.itemis.mps.editor.diagram.runtime.model.IPaletteEntryExtensionProvider;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import de.itemis.mps.editor.diagram.runtime.model.IPaletteEntry;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.IMapping;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import javax.swing.JLabel;
import javax.swing.Icon;
import java.awt.datatransfer.Transferable;
import java.awt.dnd.DragSource;
import java.awt.dnd.DnDConstants;
import java.awt.dnd.DragGestureListener;
import java.awt.dnd.DragGestureEvent;
import java.awt.Point;
import com.mxgraph.model.mxCell;
import com.mxgraph.model.mxGeometry;
import de.itemis.mps.editor.diagram.runtime.model.GenericTransferable;
import com.mxgraph.util.mxRectangle;
import jetbrains.mps.openapi.editor.cells.SubstituteAction;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.ide.icons.GlobalIconManager;
import com.intellij.openapi.util.IconLoader;
import java.awt.Image;
import java.awt.GraphicsEnvironment;
import java.awt.GraphicsDevice;
import java.awt.GraphicsConfiguration;
import java.awt.image.BufferedImage;
import java.awt.Transparency;
import java.awt.Graphics2D;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import com.intellij.ide.IdeTooltip;
import com.intellij.ide.IdeTooltipManager;
import java.awt.event.MouseMotionAdapter;
import java.awt.Graphics;
import com.intellij.ui.ColorUtil;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import javax.swing.border.Border;
import java.awt.Container;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import java.awt.BasicStroke;
import java.awt.geom.GeneralPath;
import com.intellij.ui.tabs.TabInfo;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class Palette extends JPanel {
  private static final Logger LOG = Logger.getLogger(Palette.class);
  private static ImageIcon DEFAULT_TRANSFERABLE_ICO = paintToImageIcon(IdeIcons.DEFAULT_ICON);

  private static final Color TITLE_BACKGROUND_COLOR = new JBColor(new Color(220, 220, 220), new Color(100, 100, 100));
  private static final Color TITLE_BORDER_COLOR = new Color(190, 190, 190);
  public static final Color DIAGRAM_HIGHLIGHT_COLOR = new JBColor(new Color(255, 255, 0, 80), new Color(255, 255, 255, 80));
  public static final float DIAGRAM_HIGHLIGHT_WIDTH = 3.0f;

  public static Palette getInstance(Project project) {
    if (project == null) {
      return null;
    }
    if (ProjectHelper.toIdeaProject(project).getComponent(ProjectPluginManager.class).getTool(Diagram_Palette_Tool.class) == null) {
      return null;
    }
    return ProjectHelper.toIdeaProject(project).getComponent(ProjectPluginManager.class).getTool(Diagram_Palette_Tool.class).getPaletteComponent();
  }

  private WeakReference<BaseDiagramECell> myActiveDiagramCell;
  private WeakReference<IPaletteEntryProvider> myEntryProvider;
  private WeakReference<DiagramModel> myModel;
  private JPanel itemPanel = new JPanel();
  private Map<String, Folder> myFolders = new TreeMap<String, Folder>();
  private Timer myUpdateActiveDiagramTimer;
  private WeakReference<BaseDiagramECell> myLastClickedDiagram;
  private com.intellij.openapi.project.Project myProject;

  private String myFilterString = "";
  private PaletteSearchField mySearchField = new PaletteSearchField() {
    public void executeSearch(boolean next) {
      myFilterString = mySearchField.getText();
      reloadItems();
    }
  };

  public Palette(@NotNull com.intellij.openapi.project.Project project) {
    myProject = project;
    initComponents();

    myUpdateActiveDiagramTimer = new Timer(1000, new ActionListener() {
      public void actionPerformed(ActionEvent p0) {
        try {
          updateActiveDiagramCell();
        } catch (Exception ex) {
          if (LOG.isWarningLevel()) {
            LOG.warning("Failed to update the palette", ex);
          }
        }
      }
    });
    myUpdateActiveDiagramTimer.start();
  }

  public void diagramClicked(BaseDiagramECell cell) {
    myLastClickedDiagram = new WeakReference(cell);
  }

  public void dispose() {
    myUpdateActiveDiagramTimer.stop();
  }

  private void initComponents() {
    setLayout(new BorderLayout());

    itemPanel.setLayout(new BoxLayout(itemPanel, BoxLayout.Y_AXIS));

    JComponent viewport = new JPanel();
    viewport.setLayout(new BorderLayout());
    viewport.add(itemPanel, BorderLayout.NORTH);
    JScrollPane scrollPane = new JScrollPane(viewport);
    scrollPane.setBorder(BorderFactory.createEmptyBorder());
    scrollPane.getVerticalScrollBar().setUnitIncrement(16);
    scrollPane.getHorizontalScrollBar().setUnitIncrement(8);
    add(scrollPane, BorderLayout.CENTER);
    add(mySearchField, BorderLayout.NORTH);

    setBackground(JBColor.WHITE);
    viewport.setOpaque(false);
    itemPanel.setOpaque(false);
  }

  protected void reloadItems() {
    Project mpsProject = ProjectHelper.toMPSProject(myProject);
    if (mpsProject != null) {
      mpsProject.getModelAccess().runReadAction(() -> {
        itemPanel.removeAll();
        for (JComponent item : ListSequence.fromList(createItems())) {
          item.setAlignmentX(Component.LEFT_ALIGNMENT);
          itemPanel.add(item);
        }
      });
    }

    doLayout();
    invalidate();
    revalidate();
    repaint();
  }
  public MyGraph getGraph() {
    return check_75pxkd_a0a03(check_75pxkd_a0a0eb(myActiveDiagramCell));
  }

  public BaseDiagramECell findActiveDiagramCell(JComponent anyComponentInWindow) {
    IdeFrame ideFrame = WindowManager.getInstance().getIdeFrame(myProject);
    if (ideFrame == null) {
      return null;
    }
    List<JBTabs> tabs = ((List<JBTabs>) (List) findDescendantAWTComponents(WindowManager.getInstance().getIdeFrame(myProject).getComponent(), new Condition<Component>() {
      public boolean value(Component candidate) {
        return candidate instanceof JBTabs;
      }
    }));
    if (tabs == null) {
      return null;
    }

    List<JComponent> selectedTabs = ListSequence.fromList(tabs).select((it) -> check_75pxkd_a0a0a0a0a5a23(it.getSelectedInfo())).where((it) -> it != null).toList();
    if (ListSequence.fromList(selectedTabs).isEmpty()) {
      return null;
    }

    List<EditorComponent> editorComponents = ListSequence.fromList(selectedTabs).select((it) -> {
      return (EditorComponent) findDescendantAWTComponent(it, new Condition<Component>() {
        public boolean value(Component candidate) {
          return candidate instanceof EditorComponent;
        }
      });
    }).where((it) -> it != null).toList();
    if (ListSequence.fromList(editorComponents).isEmpty()) {
      return null;
    }

    List<BaseDiagramECell> allDiagramCells = ListSequence.fromList(new ArrayList<BaseDiagramECell>());
    for (EditorComponent editorComponent : ListSequence.fromList(editorComponents)) {
      List<BaseDiagramECell> diagramCells = new ArrayList<BaseDiagramECell>();
      collectDiagramCells(editorComponent.getRootCell(), diagramCells);

      if (diagramCells.isEmpty()) {
        continue;
      }

      // remove non visible
      Rectangle visibleRect = editorComponent.getVisibleRect();
      ListIterator<BaseDiagramECell> listIterator = diagramCells.listIterator();
      while (listIterator.hasNext()) {
        BaseDiagramECell next = listIterator.next();
        if (!(visibleRect.intersects(next.getX(), next.getY(), next.getWidth(), next.getHeight()))) {
          listIterator.remove();
        }
      }

      if (diagramCells.isEmpty()) {
        continue;
      }

      // prefer diagram closest to the center of the editor
      final int editorCenterY = (int) visibleRect.getCenterY();
      Collections.sort(diagramCells, new Comparator<BaseDiagramECell>() {
        public int compare(BaseDiagramECell o1, BaseDiagramECell o2) {
          return distanceTo(o1, editorCenterY) - distanceTo(o2, editorCenterY);
        }
      });

      ListSequence.fromList(allDiagramCells).addSequence(ListSequence.fromList(diagramCells));
    }

    if (ListSequence.fromList(allDiagramCells).isEmpty()) {
      return null;
    }

    // allow the user to choose the palette by clicking into the diagram
    final BaseDiagramECell lastClickedDiagram = check_75pxkd_a0r0gb(myLastClickedDiagram);
    if (lastClickedDiagram != null) {
      if (ListSequence.fromList(allDiagramCells).contains(lastClickedDiagram.getRootDiagramCell())) {
        return lastClickedDiagram;
      }
      BaseDiagramECell updatedCell = ListSequence.fromList(allDiagramCells).findFirst((it) -> Objects.equals(it.getCellInfo(), lastClickedDiagram.getCellInfo()));
      if (updatedCell != null) {
        return updatedCell;
      }
    }

    BaseDiagramECell closest = ListSequence.fromList(allDiagramCells).first();

    return closest;
  }

  public int distanceTo(EditorCell cell, int posY) {
    int y = LayoutDependencies.getY(cell);
    int y2 = y + LayoutDependencies.getHeight(cell);

    if (y <= posY && posY <= y2) {
      return 0;
    }

    return Math.min(Math.abs(y - posY), Math.abs(y2 - posY));
  }

  public void changeActiveDiagramCell(BaseDiagramECell diagramCell) {
    BaseDiagramECell activeDiagramCell = check_75pxkd_a0a0kb(myActiveDiagramCell);
    if (diagramCell != activeDiagramCell) {
      if (activeDiagramCell != null) {
        ((EditorComponent) activeDiagramCell.getEditor()).repaint(activeDiagramCell);
      }
      myActiveDiagramCell = new WeakReference(diagramCell);
      if (diagramCell != null) {
        ((EditorComponent) diagramCell.getEditorComponent()).repaint(diagramCell);
      }
      DiagramModel model = check_75pxkd_a0d0b0kb(diagramCell);
      myModel = new WeakReference<DiagramModel>(model);
      myEntryProvider = new WeakReference<IPaletteEntryProvider>(check_75pxkd_a0a0f0b0kb(model));
      reloadItems();
    }
  }

  public void updateActiveDiagramCell() {
    updateActiveDiagramCell(this);
  }

  public void updateActiveDiagramCell(JComponent anyComponentInWindow) {
    changeActiveDiagramCell(findActiveDiagramCell(anyComponentInWindow));
  }

  public BaseDiagramECell getActiveDiagram() {
    return check_75pxkd_a0a24(myActiveDiagramCell);
  }

  @NotNull
  protected List<JComponent> createItems() {
    return createItems(myFilterString);
  }

  @NotNull
  protected List<JComponent> createItems(@Nullable String pattern) {
    myFolders.clear();
    final DiagramModel model = myModel.get();
    IPaletteEntryProvider entryProvider = check_75pxkd_a0c0ub(myEntryProvider);
    if (entryProvider != null && model != null) {
      Iterable<IPaletteEntryExtensionProvider> additionalEntriesProviders = new ExtensionPoint<IPaletteEntryExtensionProvider>("de.itemis.mps.editor.diagram.runtime.diagramPaletteEntryProvider").getObjects();
      Iterable<IPaletteEntry> additionalEntries = Sequence.fromIterable(additionalEntriesProviders).where(new _FunctionTypes._return_P1_E0<Boolean, IPaletteEntryExtensionProvider>() {
        public Boolean invoke(IPaletteEntryExtensionProvider it) {
          return it.appliesFor(SNodeOperations.getConcept(model.getSNode()));
        }
      }).translate(new _FunctionTypes._return_P1_E0<Iterable<IPaletteEntry>, IPaletteEntryExtensionProvider>() {
        public Iterable<IPaletteEntry> invoke(IPaletteEntryExtensionProvider it) {
          Iterable<IPaletteEntry> entries = it.getEntries(model.getSNode(), model.getEditorContext());
          return (entries != null ? entries : Sequence.fromIterable(Collections.<IPaletteEntry>emptyList()));
        }
      });
      for (IPaletteEntry action : Sequence.fromIterable(entryProvider.getEntries()).union(Sequence.fromIterable(additionalEntries))) {
        String folderName = getFolderName(action);
        String entryText = action.getText();
        if ((myFilterString == null || myFilterString.length() == 0) || entryText.toLowerCase().contains(myFilterString.toLowerCase()) || check_75pxkd_a0c0c0d0ub(folderName, myFilterString)) {
          getOrCreateFolder(folderName).addItem(createItem(pattern, action));
        }
      }
    }

    List<Folder> folders = ListSequence.fromList(new ArrayList<Folder>());
    for (IMapping<String, Folder> f : MapSequence.fromMap(myFolders)) {
      if (!(f.key().contains(FOLDER_SUBFOLDER_SEPARATOR_MARKER))) {
        ListSequence.fromList(folders).addElement(f.value());
      }
    }
    return ListSequence.fromList(folders).select((it) -> it.getComponent()).toList();
  }

  private static final String FOLDER_SUBFOLDER_SEPARATOR_MARKER = "/";

  protected String getFolderName(IPaletteEntry action) {
    String paletteFolder;
    paletteFolder = action.getFolderName();
    if (paletteFolder != null) {
      return paletteFolder;
    }
    paletteFolder = check_75pxkd_a0d0yb(check_75pxkd_a0a3a05(myModel), action);
    if (paletteFolder != null) {
      return paletteFolder;
    }
    return (paletteFolder == null ? "" : paletteFolder);
  }

  public Folder getOrCreateFolder(String folderName) {
    Folder folder = myFolders.get(folderName);
    if (folder == null) {
      if (folderName.contains(FOLDER_SUBFOLDER_SEPARATOR_MARKER)) {
        int idx = folderName.lastIndexOf(FOLDER_SUBFOLDER_SEPARATOR_MARKER);
        String parentFolderName = folderName.substring(0, idx);
        Folder parent = getOrCreateFolder(parentFolderName);
        Folder child = new Folder(folderName.substring(idx + 1));
        child.setCollapsed(true);
        parent.addItem(child.getComponent());
        folder = child;
      } else {
        folder = new Folder(folderName);
      }
      myFolders.put(folderName, folder);
    }
    return folder;
  }

  protected JComponent createItem(String pattern, IPaletteEntry action) {
    JLabel item = new HoverLabel(action.getText());

    Icon icon = action.getIcon();
    if (icon == null) {
      icon = IdeIcons.DEFAULT_ICON;
    }
    final ImageIcon imageIcon = icon2imageIcon(icon);
    item.setIcon(imageIcon);

    final Transferable transferable = createTransferable(action, check_75pxkd_b0a7a45(myActiveDiagramCell));
    if (transferable != null) {
      DragSource dragSource = new DragSource();
      dragSource.createDefaultDragGestureRecognizer(item, DnDConstants.ACTION_COPY, new DragGestureListener() {
        public void dragGestureRecognized(DragGestureEvent event) {
          event.startDrag(null, imageIcon.getImage(), new Point(), transferable, null);
        }
      });
    }

    item.setOpaque(false);
    return item;
  }

  protected Transferable createTransferable(final IPaletteEntry entry, final BaseDiagramECell diagramCell) {
    final ImageIcon imageIcon = DEFAULT_TRANSFERABLE_ICO;
    mxCell cell = new PaletteEntryMxCell(entry.getText(), new mxGeometry(0, 0, 80, 30), null, entry, diagramCell);
    cell.setVertex(true);
    return new GenericTransferable(entry, diagramCell.getContext().getRepository(), new Object[]{cell}, (mxRectangle) cell.getGeometry().clone(), imageIcon);
  }

  protected Icon getIcon(String pattern, SubstituteAction action) {
    Icon icon;
    SNode iconNode = action.getIconNode(pattern);
    if (iconNode != null) {
      icon = (SNodeOperations.isInstanceOf(iconNode, CONCEPTS.AbstractConceptDeclaration$KA) && !(action.isReferentPresentation()) ? GlobalIconManager.getInstance().getIconFor(SNodeOperations.asSConcept(SNodeOperations.cast(iconNode, CONCEPTS.AbstractConceptDeclaration$KA))) : GlobalIconManager.getInstance().getIconFor(iconNode));
    } else {
      icon = IdeIcons.DEFAULT_ICON;
    }
    return icon;
  }

  public static ImageIcon icon2imageIcon(Icon icon) {
    if (icon instanceof ImageIcon) {
      return ((ImageIcon) icon);
    }
    if (icon instanceof IconLoader.CachedImageIcon) {
      return new ImageIcon(paintToImage(IconLoader.getIconSnapshot(icon)));
    }
    return new ImageIcon(paintToImage(icon));
  }

  private static Image iconToImage(Icon icon) {
    if (icon instanceof ImageIcon) {
      return ((ImageIcon) icon).getImage();
    } else {
      return paintToImage(icon);
    }
  }

  private static ImageIcon paintToImageIcon(Icon icon) {
    if (GraphicsEnvironment.isHeadless()) {
      return null;
    }

    return new ImageIcon(paintToImage(icon));
  }

  private static Image paintToImage(Icon icon) {
    int w = icon.getIconWidth();
    int h = icon.getIconHeight();
    GraphicsEnvironment ge = GraphicsEnvironment.getLocalGraphicsEnvironment();
    GraphicsDevice gd = ge.getDefaultScreenDevice();
    GraphicsConfiguration gc = gd.getDefaultConfiguration();
    BufferedImage image = gc.createCompatibleImage(w, h, Transparency.TRANSLUCENT);
    Graphics2D g = image.createGraphics();
    icon.paintIcon(null, g, 0, 0);
    g.dispose();
    return image;
  }

  private static class HoverLabel extends JLabel {

    private boolean isHovered = false;
    private boolean strong = false;

    private HoverLabel(String text) {
      super(text);

      addMouseListener(new MouseAdapter() {
        @Override
        public void mouseEntered(MouseEvent event) {
          isHovered = true;
          repaint();
        }
        @Override
        public void mouseExited(MouseEvent event) {
          isHovered = false;
          strong = false;
          repaint();
        }

        @Override
        public void mousePressed(MouseEvent event) {
          strong = true;
          repaint();
        }

        @Override
        public void mouseReleased(MouseEvent event) {
          strong = false;
          repaint();
        }

        @Override
        public void mouseClicked(MouseEvent event) {
          IdeTooltip tooltip = new IdeTooltip(HoverLabel.this, new Point(event.getX(), event.getY()), new JLabel("Use Drag and Drop"));
          IdeTooltipManager.getInstance().show(tooltip, true, true);
        }
      });

      addMouseMotionListener(new MouseMotionAdapter() {
        @Override
        public void mouseDragged(MouseEvent event) {
          isHovered = false;
          strong = false;
          repaint();
        }
      });
    }

    protected boolean isHighlighted() {
      return isHovered;
    }

    protected boolean isStrong() {
      return strong;
    }

    protected boolean isStronglyHightlight() {
      return isHighlighted() && isStrong();
    }

    @Override
    public void paint(Graphics g_) {
      if (isHighlighted() || isStronglyHightlight()) {
        Graphics g = g_.create();
        try {
          g.setColor(ColorUtil.withAlpha(JBColor.BLUE, (isStronglyHightlight() ? 0.235 : 0.078)));
          g.fillRect(0, 0, getWidth(), getHeight());
          g.setColor(ColorUtil.withAlpha(JBColor.BLUE, (isStronglyHightlight() ? 0.39 : 0.157)));
          g.drawRect(0, 0, getWidth() - 1, getHeight() - 1);
        } finally {
          g.dispose();
        }
      }

      super.paint(g_);
    }
  }

  public static class Folder {
    private static Set<String> ourCollapsedStates = SetSequence.fromSet(new HashSet<String>());

    private String myName;
    private JPanel myComponent;
    private JPanel myItemContainer;
    @Nullable
    private JLabel myTitleComponent;

    public Folder(String name) {
      this.myName = name;
      myComponent = new JPanel(new BorderLayout(0, 0));

      if (name != null && name.length() > 0) {
        myTitleComponent = buildTitle(name);
        myTitleComponent.addMouseListener(new MouseAdapter() {
          @Override
          public void mouseClicked(MouseEvent event) {
            setCollapsed(!(isCollapsed()));
          }
        });
        myComponent.add(myTitleComponent, BorderLayout.NORTH);
      }
      myItemContainer = new JPanel();
      myItemContainer.setLayout(new BoxLayout(myItemContainer, BoxLayout.Y_AXIS));
      myItemContainer.setBorder(BorderFactory.createEmptyBorder(6, 3, 12, 3));
      myComponent.add(myItemContainer, BorderLayout.CENTER);

      myComponent.setOpaque(false);
      myItemContainer.setOpaque(false);

      setCollapsed(wasCollapsed());
    }

    public void addItem(JComponent item) {
      item.setAlignmentX(Component.LEFT_ALIGNMENT);
      myItemContainer.add(item);
    }

    public JComponent getComponent() {
      return myComponent;
    }

    public String getName() {
      return myName;
    }

    public boolean isCollapsed() {
      return !(myItemContainer.isVisible());
    }

    public void setCollapsed(boolean collapsed) {
      myItemContainer.setVisible(!(collapsed));
      check_75pxkd_a1a71sc(myTitleComponent, collapsed);
      if (collapsed) {
        SetSequence.fromSet(ourCollapsedStates).addElement(getName());
      } else {
        SetSequence.fromSet(ourCollapsedStates).removeElement(getName());
      }
    }

    public boolean wasCollapsed() {
      return SetSequence.fromSet(ourCollapsedStates).contains(getName());
    }
    private static void check_75pxkd_a1a71sc(JLabel checkedDotOperand, Boolean collapsed) {
      if (null != checkedDotOperand) {
        checkedDotOperand.setIcon(new ExpandCollapseIcon(collapsed));
      }

    }
  }

  public static JLabel buildTitle(String text) {
    JLabel label = new JLabel(text);
    Border border = BorderFactory.createMatteBorder(1, 0, 1, 0, TITLE_BORDER_COLOR);
    border = BorderFactory.createCompoundBorder(border, BorderFactory.createEmptyBorder(3, 6, 3, 6));
    label.setBorder(border);
    label.setBackground(TITLE_BACKGROUND_COLOR);
    label.setOpaque(true);
    return label;
  }

  private static Component findDescendantAWTComponent(Component root, Condition<Component> condition) {
    if (condition.value(root)) {
      return root;
    }

    if (root instanceof Container) {
      for (Component child : ((Container) root).getComponents()) {
        Component match = findDescendantAWTComponent(child, condition);
        if (match != null) {
          return match;
        }
      }
    }

    return null;
  }
  private static void findDescendantAWTComponents(Component root, Condition<Component> condition, List<Component> result) {
    if (condition.value(root)) {
      result.add(root);
    }

    if (root instanceof Container) {
      for (Component child : ((Container) root).getComponents()) {
        findDescendantAWTComponents(child, condition, result);
      }
    }
  }
  private static List<Component> findDescendantAWTComponents(Component root, Condition<Component> condition) {
    List<Component> result = new ArrayList<Component>();
    findDescendantAWTComponents(root, condition, result);
    return result;
  }

  private static Component findParentAWTComponent(Component descendant, Condition<Component> condition) {
    if (descendant == null) {
      return null;
    }

    Component parent = descendant;
    while (parent != null) {
      if (condition.value(parent)) {
        return parent;
      }
      parent = parent.getParent();
    }

    return null;
  }

  public static void collectDiagramCells(EditorCell root, List<BaseDiagramECell> result) {
    if (root instanceof BaseDiagramECell) {
      result.add(((BaseDiagramECell) root));
    }
    if (root instanceof EditorCell_Collection) {
      for (EditorCell child : Sequence.fromIterable((EditorCell_Collection) root)) {
        collectDiagramCells(child, result);
      }
    }
  }

  public static void paintHighlightingIfActive(Graphics2D g_, BaseDiagramECell diagram, Rectangle bounds) {
    boolean highlight = isActive(diagram);
    if (highlight) {
      Graphics2D g = ((Graphics2D) g_.create());
      try {
        g_.setColor(ColorUtil.withAlpha(JBColor.YELLOW, 0.314));
        g_.setStroke(new BasicStroke(3.0f));
        g_.drawRect(bounds.x + 2, bounds.y + 2, bounds.width - 4, bounds.height - 4);
      } finally {
        g.dispose();
      }
    }
  }

  public static boolean isActive(BaseDiagramECell diagram) {
    return check_75pxkd_a0a0gd(getInstance(diagram.getContext().getOperationContext().getProject())) == diagram;
  }

  public static class ExpandCollapseIcon implements Icon {
    private boolean collapsed;
    public ExpandCollapseIcon(boolean collapsed1) {
      collapsed = collapsed1;
    }
    public int getIconHeight() {
      return 8;
    }
    public int getIconWidth() {
      return getIconHeight();
    }
    public void paintIcon(Component component, Graphics g_, int x, int y) {
      Graphics2D g = ((Graphics2D) g_);
      GeneralPath shape = new GeneralPath();
      shape.moveTo(x, y);
      int w = getIconWidth();
      int h = getIconHeight();
      if (collapsed) {
        w--;
        shape.lineTo(x + w, y + 0.5 * h);
        shape.lineTo(x, y + h);
      } else {
        h--;
        shape.lineTo(x + w, y);
        shape.lineTo(x + 0.5 * w, y + h);
      }
      shape.closePath();
      g.setColor(JBColor.GRAY);
      g.fill(shape);
    }
  }
  private static MyGraph check_75pxkd_a0a03(BaseDiagramECell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getContextGraph();
    }
    return null;
  }
  private static BaseDiagramECell check_75pxkd_a0a0eb(WeakReference<BaseDiagramECell> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static JComponent check_75pxkd_a0a0a0a0a5a23(TabInfo checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getComponent();
    }
    return null;
  }
  private static BaseDiagramECell check_75pxkd_a0r0gb(WeakReference<BaseDiagramECell> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static BaseDiagramECell check_75pxkd_a0a0kb(WeakReference<BaseDiagramECell> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static DiagramModel check_75pxkd_a0d0b0kb(BaseDiagramECell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModel();
    }
    return null;
  }
  private static IPaletteEntryProvider check_75pxkd_a0a0f0b0kb(DiagramModel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getPaletteEntryProvider();
    }
    return null;
  }
  private static BaseDiagramECell check_75pxkd_a0a24(WeakReference<BaseDiagramECell> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static IPaletteEntryProvider check_75pxkd_a0c0ub(WeakReference<IPaletteEntryProvider> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static boolean check_75pxkd_a0c0c0d0ub(String checkedDotOperand, String myFilterString) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.contains(myFilterString);
    }
    return false;
  }
  private static String check_75pxkd_a0d0yb(DiagramModel checkedDotOperand, IPaletteEntry action) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getPaletteFolder(action);
    }
    return null;
  }
  private static DiagramModel check_75pxkd_a0a3a05(WeakReference<DiagramModel> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static BaseDiagramECell check_75pxkd_b0a7a45(WeakReference<BaseDiagramECell> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }
  private static BaseDiagramECell check_75pxkd_a0a0gd(Palette checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getActiveDiagram();
    }
    return null;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept AbstractConceptDeclaration$KA = MetaAdapterFactory.getConcept(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0x1103553c5ffL, "jetbrains.mps.lang.structure.structure.AbstractConceptDeclaration");
  }
}
