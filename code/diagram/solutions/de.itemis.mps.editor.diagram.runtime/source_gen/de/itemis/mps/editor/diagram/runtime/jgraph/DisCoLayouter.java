package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import org.eclipse.elk.alg.disco.options.CompactionStrategy;
import org.eclipse.elk.alg.common.compaction.options.HighLevelSortingCriterion;
import org.eclipse.elk.alg.common.compaction.options.LowLevelSortingCriterion;
import org.eclipse.elk.alg.common.compaction.options.TraversalStrategy;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.eclipse.elk.alg.disco.options.DisCoOptions;
import org.eclipse.elk.core.data.LayoutMetaDataService;
import org.eclipse.elk.alg.disco.options.DisCoMetaDataProvider;
import org.eclipse.elk.graph.ElkNode;
import org.eclipse.elk.core.util.IElkProgressMonitor;
import org.eclipse.elk.graph.ElkEdge;
import de.itemis.mps.editor.diagram.runtime.model.IAccessorKey;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;

public class DisCoLayouter extends ElkLayouter {
  protected Double aspectRatio;
  protected double componentsSpacing;
  protected CompactionStrategy componentCompactionStrategy;
  protected String componentLayoutAlgorithm;
  protected ElkLayouter componentLayoutAlgorithmInstance;

  protected boolean fillPolyominoes;
  protected HighLevelSortingCriterion polyominoHighLevelSort;
  protected LowLevelSortingCriterion polyominoLowLevelSort;
  protected TraversalStrategy polyominoTraversalStrategy;

  private Map<Object, Double> myEdgeThicknesses = MapSequence.fromMap(new HashMap<Object, Double>());

  public DisCoLayouter() {
    super();
    myAlgorithm = DisCoOptions.ALGORITHM_ID;
  }

  static {
    LayoutMetaDataService.getInstance().registerLayoutMetaDataProviders(new DisCoMetaDataProvider());
  }

  @Override
  public boolean canLayoutLabels() {
    return true;
  }

  @Override
  protected boolean useDummyPort(EdgeDCell edge, boolean isTarget) {
    return false;
  }

  @Override
  protected void addLayoutInformationToGraph(ElkNode graph, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToGraph(graph, progressMonitor);
    ElkNode layout = graph;
    if (aspectRatio != null) {
      layout.setProperty(DisCoOptions.ASPECT_RATIO, aspectRatio);
    }
    layout.setProperty(DisCoOptions.SPACING_COMPONENT_COMPONENT, componentsSpacing);
    layout.setProperty(DisCoOptions.COMPONENT_COMPACTION_STRATEGY, componentCompactionStrategy);

    if (componentLayoutAlgorithmInstance != null) {
      layout.setProperty(DisCoOptions.COMPONENT_COMPACTION_COMPONENT_LAYOUT_ALGORITHM, componentLayoutAlgorithm);
      componentLayoutAlgorithmInstance.addLayoutInformationToGraph(graph, progressMonitor);
    }

    layout.setProperty(DisCoOptions.POLYOMINO_FILL, fillPolyominoes);
    layout.setProperty(DisCoOptions.POLYOMINO_HIGH_LEVEL_SORT, polyominoHighLevelSort);
    layout.setProperty(DisCoOptions.POLYOMINO_LOW_LEVEL_SORT, polyominoLowLevelSort);
    layout.setProperty(DisCoOptions.POLYOMINO_TRAVERSAL_STRATEGY, polyominoTraversalStrategy);

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(graph, "graph", progressMonitor);
    }
  }


  @Override
  protected void addLayoutInformationToEdge(ElkEdge kedge, EdgeDCell edge, IElkProgressMonitor progressMonitor) {
    super.addLayoutInformationToEdge(kedge, edge, progressMonitor);
    IAccessorKey ID = edge.getEdge().getAccessor().getId();
    Double edgeThickness = MapSequence.fromMap(myEdgeThicknesses).get(ID);
    if (edgeThickness != null) {
      kedge.setProperty(DisCoOptions.EDGE_THICKNESS, edgeThickness);
    }

    if (LOG.isDebugEnabled()) {
      JGraphUtil.dumpOptions(kedge, "edge", progressMonitor);
    }
  }

  @Override
  public void setParentsStyle(Style style) {
    super.setParentsStyle(style);
    if (style.isSpecified(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-aspect-ratio"))) {
      aspectRatio = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-aspect-ratio"));
    }

    this.componentsSpacing = style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-components-spacing"));
    this.componentCompactionStrategy = style.get(StyleAttributes.getInstance().<CompactionStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-disco-connected-components-compaction-strategy"));
    this.componentLayoutAlgorithm = style.get(StyleAttributes.getInstance().<String>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-disco-connected-components-layout-algorithm"));
    this.fillPolyominoes = style.get(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-polyomino-fill-polyominoes"));
    this.polyominoHighLevelSort = style.get(StyleAttributes.getInstance().<HighLevelSortingCriterion>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-polyomino-primary-sorting-criterion"));
    this.polyominoLowLevelSort = style.get(StyleAttributes.getInstance().<LowLevelSortingCriterion>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-polyomino-secondary-sorting-criterion"));
    this.polyominoTraversalStrategy = style.get(StyleAttributes.getInstance().<TraversalStrategy>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-polyomino-traversal-strategy"));

    ElkLayouter usedLayouter = LayouterManager.getLayouterForAlgorithm(this.componentLayoutAlgorithm);

    if (this.componentLayoutAlgorithm != null) {
      componentLayoutAlgorithmInstance = usedLayouter;
      componentLayoutAlgorithmInstance.setParentsStyle(style);
    }
  }

  @Override
  public void addEdgesStyle(Style style, Object key) {
    super.addEdgesStyle(style, key);

    MapSequence.fromMap(myEdgeThicknesses).put(key, style.get(StyleAttributes.getInstance().<Double>getAttribute("de.itemis.mps.editor.diagram", "diagram-layout-edge-thickness")));
  }
}
