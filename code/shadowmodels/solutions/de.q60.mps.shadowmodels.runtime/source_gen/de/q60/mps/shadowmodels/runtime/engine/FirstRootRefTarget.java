package de.q60.mps.shadowmodels.runtime.engine;

/*Generated by MPS */

import org.jetbrains.annotations.Nullable;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.Objects;
import jetbrains.mps.internal.collections.runtime.ListSequence;

public class FirstRootRefTarget implements IReferenceTarget {
  @Nullable
  public static FirstRootRefTarget create(@Nullable IContainmentTarget t) {
    return (t == null ? null : new FirstRootRefTarget(t));
  }
  private IContainmentTarget containmentTarget;

  private FirstRootRefTarget() {
    // for deserialization
  }

  public FirstRootRefTarget(IContainmentTarget containmentTarget) {
    this.containmentTarget = containmentTarget;
  }

  public IContainmentTarget getContainmentTarget() {
    return this.containmentTarget;
  }

  @Override
  public IOutputNodeReference resolve(IScope sourceScope, final ITransformationEngine engine) {
    final Wrappers._T<IOutputNodeReference> resolvedNode = new Wrappers._T<IOutputNodeReference>(null);
    sourceScope.visitScopes((final IScope scope) -> {
      final ISubgraphStage stage = scope.getStage(engine);
      if (stage == null) {
        return true;
      }

      List<IOutputNodeReference> outputNodes = Sequence.fromIterable(stage.resolveContent(containmentTarget)).translate(new _FunctionTypes._return_P1_E0<Iterable<IOutputNodeReference>, IUniqueContainmentTarget>() {
        public Iterable<IOutputNodeReference> invoke(IUniqueContainmentTarget it) {
          return stage.resolveContainmentTarget(it);
        }
      }).where((it) -> Objects.equals(it.getScope(engine), scope)).toList();

      if (ListSequence.fromList(outputNodes).count() == 1) {
        resolvedNode.value = ListSequence.fromList(outputNodes).first();
        return false;
      } else if (ListSequence.fromList(outputNodes).count() > 1) {
        throw new RuntimeException("Multiple output nodes found for " + containmentTarget);
      }

      return true;
    }, engine);
    if (resolvedNode.value != null) {
      return resolvedNode.value;
    }

    if (containmentTarget instanceof RewriteCall) {
      return NodeAsOutputNodeReference.create(((RewriteCall) containmentTarget).getInput());
    }
    return null;
  }

  @Override
  public String toString() {
    return "firstRoot(" + containmentTarget + ")";
  }

  private transient int _cachedHashCode;
  private transient boolean _hashCodeInitialized = false;
  @Override
  public int hashCode() {
    if (!(_hashCodeInitialized)) {
      int c = 0;
      c = 31 * c + Objects.hashCode(containmentTarget);
      _cachedHashCode = c;
      _hashCodeInitialized = true;
    }
    return _cachedHashCode;
  }
  @Override
  public boolean equals(Object o) {
    if (this == o) {
      return true;
    }
    if (o == null || this.getClass() != o.getClass()) {
      return false;
    }
    FirstRootRefTarget that = (FirstRootRefTarget) o;
    if (!(Objects.equals(containmentTarget, that.containmentTarget))) {
      return false;
    }
    return true;
  }
}
