package de.slisson.mps.richtext.runtime.selection;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.openapi.editor.selection.Selection;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.selection.SelectionManager;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import de.slisson.mps.editor.multiline.cells.EditorCell_Multiline;
import de.slisson.mps.editor.multiline.cells.EditorCell_Word;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class RichtextHelper {

  private EditorComponent editorComponent;
  private Selection selection;
  private EditorCell firstSelectedCell;
  private boolean leftToRight = true;
  private int selectionStartPosition = -1;

  public RichtextHelper(EditorComponent editorComponent) {
    this.editorComponent = editorComponent;
    SelectionManager selectionManager = editorComponent.getSelectionManager();
    this.selection = selectionManager.getSelection();

    if (selection instanceof RichtextSelection) {
      RichtextSelection richSelection = ((RichtextSelection) selection);
      selectionStartPosition = richSelection.getStartTextPos();
      leftToRight = richSelection.isLeftToRight();
    }

    this.firstSelectedCell = editorComponent.getSelectedCell();
    if (this.firstSelectedCell == null && this.selection != null) {
      this.firstSelectedCell = ((leftToRight ? ListSequence.fromList(getSelectedCells()).last() : ListSequence.fromList(getSelectedCells()).first()));
      if (this.firstSelectedCell instanceof EditorCell_Multiline) {
        this.firstSelectedCell = as_z9dqxn_a0a0a0b0h0h(this.firstSelectedCell, EditorCell_Multiline.class).getWordCellContainingPos(selectionStartPosition);
      }
    }
  }

  public int getCaretPositionOfFirstSelectedCell() {
    int endPos = 0;
    if (firstSelectedCell instanceof EditorCell_Word) {
      endPos = as_z9dqxn_a0a0a0b0j(firstSelectedCell, EditorCell_Word.class).getCaretPosition();
      if (selectionStartPosition != -1) {
        endPos = as_z9dqxn_a0a0a0b0b0j(firstSelectedCell, EditorCell_Word.class).getCaretFromAbsolutePosition(selectionStartPosition);
      }
    }
    return endPos;
  }

  public boolean isLeftToRight() {
    return this.leftToRight;
  }

  public EditorCell getFirstSelectedCell() {
    return this.firstSelectedCell;
  }

  public List<EditorCell> getSelectedCells() {
    return this.selection.getSelectedCells();
  }

  public List<SNode> getSelectedNodes() {
    return this.selection.getSelectedNodes();
  }

  public SNode getTextNode() {
    return SNodeOperations.getNodeAncestor(ListSequence.fromList(getSelectedNodes()).first(), CONCEPTS.Text$bD, false, false);
  }

  public EditorCell_Collection getTextNodeCell() {
    return as_z9dqxn_a0a0v(this.editorComponent.findNodeCell(getTextNode()), EditorCell_Collection.class);
  }
  private static <T> T as_z9dqxn_a0a0a0b0h0h(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_z9dqxn_a0a0a0b0j(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_z9dqxn_a0a0a0b0b0j(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_z9dqxn_a0a0v(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Text$bD = MetaAdapterFactory.getConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e4e61L, "de.slisson.mps.richtext.structure.Text");
  }
}
