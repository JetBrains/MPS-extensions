package de.slisson.mps.tables.runtime.substitute;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.cellMenu.AbstractNodeSubstituteInfo;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.Objects;
import java.util.List;
import jetbrains.mps.openapi.editor.cells.SubstituteAction;
import jetbrains.mps.nodeEditor.menus.substitute.DefaultSubstituteMenuContext;
import jetbrains.mps.nodeEditor.menus.EditorMenuTraceImpl;
import jetbrains.mps.lang.editor.menus.substitute.DefaultSubstituteMenuLookup;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.openapi.editor.menus.substitute.SubstituteMenuItem;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.editor.menus.substitute.SubstituteMenuItemWrapper;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.annotations.NotNull;

public abstract class CellQuerySubstituteInfo extends AbstractNodeSubstituteInfo {

  private SNode myParentNode;
  private SNode myCurrentNode;
  private SAbstractConcept myWrappedConcept;
  private SContainmentLink myLastLink;

  public CellQuerySubstituteInfo(EditorContext editorContext, SNode parentNode, SNode currentNode, SAbstractConcept wrappedConcept, SContainmentLink lastLink) {
    super(editorContext);

    myParentNode = parentNode;
    myCurrentNode = currentNode;
    myWrappedConcept = wrappedConcept;
    myLastLink = lastLink;
  }

  public SContainmentLink getLink() {
    if (myCurrentNode != null) {
      return myCurrentNode.getContainmentLink();
    }
    if (myWrappedConcept != null && myParentNode != null) {
      for (SContainmentLink link : CollectionSequence.fromCollection(SNodeOperations.getConcept(myParentNode).getContainmentLinks())) {
        if (Objects.equals(link.getTargetConcept(), myWrappedConcept)) {
          return link;
        }
      }
      for (SContainmentLink link : CollectionSequence.fromCollection(SNodeOperations.getConcept(myParentNode).getContainmentLinks())) {
        if (myWrappedConcept.isSubConceptOf(link.getTargetConcept())) {
          return link;
        }
      }
    }
    return null;
  }

  @Override
  protected List<SubstituteAction> createActions() {

    DefaultSubstituteMenuContext context = DefaultSubstituteMenuContext.createInitialContextForNode(myLastLink, myWrappedConcept, myParentNode, myCurrentNode, getEditorContext(), new EditorMenuTraceImpl());
    DefaultSubstituteMenuLookup lookup = new DefaultSubstituteMenuLookup(LanguageRegistry.getInstance(getEditorContext().getRepository()), myWrappedConcept);
    List<SubstituteMenuItem> items = context.createItems(lookup);
    return ListSequence.fromList(items).select((it) -> {
      SubstituteAction action = new SubstituteMenuItemAsSubstituteAction(new SubstituteMenuItemWrapper(it) {
        @Nullable
        @Override
        public SNode createNode(@NotNull String pattern) {
          SNode toWrap = super.createNode(pattern);
          return substituteNode(myCurrentNode, toWrap);
        }
      }, myCurrentNode, getEditorContext().getRepository());
      return action;
    }).toList();
  }

  public abstract SNode substituteNode(SNode currentNode, SNode newValue);
}
