package de.itemis.mps.editor.celllayout.boxmodel;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.nodeEditor.cells.EditorCell_Basic;
import de.itemis.mps.editor.celllayout.styles.editor.LayoutStylesUtil;
import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;

public class EditorCellBoxModel extends DefaultBoxModel implements BoxModel {
  private static final String USER_OBJECT_KEY = "EditorCellBoxModel";
  public static final int BRACKET_WIDTH = 7;

  public static EditorCellBoxModel getInstance(EditorCell cell) {
    EditorCellBoxModel box = as_rhf012_a0a0a3(cell.getUserObject(USER_OBJECT_KEY), EditorCellBoxModel.class);
    if (box == null) {
      box = new EditorCellBoxModel(cell);
      cell.putUserObject(USER_OBJECT_KEY, box);
    }
    return box;
  }

  public static void clear(EditorCell cell) {
    if (cell.getUserObject(USER_OBJECT_KEY) != null) {
      cell.putUserObject(USER_OBJECT_KEY, null);
    }
  }

  protected LayoutBoxFrame myBracketsBox;
  protected LayoutBoxFrame myAdditionalPadding;
  protected EditorCell myEditorCell;

  public EditorCellBoxModel(EditorCell editorCell) {
    myEditorCell = editorCell;
    myContentBox = new DefaultLayoutBox();
    myPaddingBox = new CalcOnWriteFrame(myContentBox);
    myAdditionalPadding = new CalcOnWriteFrame(myPaddingBox);
    myBracketsBox = new CalcOnWriteFrame(myAdditionalPadding);
    myBorderBox = new CalcOnWriteFrame(myBracketsBox);
    myMarginBox = new CalcOnWriteFrame(myBorderBox);

    readSync();
  }

  @Override
  protected void init() {
  }

  public LayoutBoxFrame getAdditionalPadding() {
    return myAdditionalPadding;
  }

  public LayoutBoxFrame getBracketsBox() {
    return myBracketsBox;
  }

  public void readSync() {
    boolean bracketsEnabled = (myEditorCell instanceof EditorCell_Basic ? ((EditorCell_Basic) myEditorCell).isDrawBrackets() : false);
    myBracketsBox.setLeftSize((bracketsEnabled ? BRACKET_WIDTH : 0));
    myBracketsBox.setRightSize((bracketsEnabled ? BRACKET_WIDTH : 0));

    int leftPad = myEditorCell.getLeftGap() - getAdditionalPadding().getLeftSize();
    int rightPad = myEditorCell.getRightGap() - getAdditionalPadding().getRightSize();
    if (leftPad < 0) {
      LayoutBoxFrameExtensions.addLeftSize(getAdditionalPadding(), leftPad);
      leftPad = 0;
    }
    if (rightPad < 0) {
      LayoutBoxFrameExtensions.addRightSize(getAdditionalPadding(), rightPad);
      rightPad = 0;
    }
    getPaddingBox().setLeftSize(leftPad);
    getPaddingBox().setRightSize(rightPad);

    int width = myEditorCell.getWidth();
    int height = myEditorCell.getHeight();
    if (width < LayoutBoxExtensions.getTotalFrameSizeHorizontal(getBorderBox().getInnerBox())) {
      getAdditionalPadding().setLeftSize(0);
      getAdditionalPadding().setRightSize(0);
    }
    if (height < LayoutBoxExtensions.getTotalFrameSizeVertical(getBorderBox().getInnerBox())) {
      getAdditionalPadding().setTopSize(0);
      getAdditionalPadding().setBottomSize(0);
    }
    width = Math.max(width, LayoutBoxExtensions.getTotalFrameSizeHorizontal(getBorderBox().getInnerBox()));
    height = Math.max(height, LayoutBoxExtensions.getTotalFrameSizeVertical(getBorderBox().getInnerBox()));
    getBorderBox().getInnerBox().setSize(width, height);

    getBorderBox().getInnerBox().setX(myEditorCell.getX());
    getBorderBox().getInnerBox().setY(myEditorCell.getY());
    getBorderBox().getInnerBox().setAscent(myEditorCell.getAscent());

    // The default behavior of MPS is not to reserve any space for the border and let it overlap
    // That's why we let them overlap here by one pixel.
    getBorderBox().setLeftSize(Math.max(0, LayoutStylesUtil.getLeftBorderSize(myEditorCell) - 1));
    getBorderBox().setRightSize(Math.max(0, LayoutStylesUtil.getRightBorderSize(myEditorCell) - 1));
    getBorderBox().setTopSize(Math.max(0, LayoutStylesUtil.getTopBorderSize(myEditorCell) - 1));
    getBorderBox().setBottomSize(Math.max(0, LayoutStylesUtil.getBottomBorderSize(myEditorCell) - 1));
  }

  public void readSyncPosition() {
    getBorderBox().getInnerBox().setX(myEditorCell.getX());
    getBorderBox().getInnerBox().setY(myEditorCell.getY());
  }

  public void writeSync(boolean useMove) {
    myEditorCell.setLeftGap(getPaddingBox().getLeftSize() + getAdditionalPadding().getLeftSize());
    myEditorCell.setRightGap(getPaddingBox().getRightSize() + getAdditionalPadding().getRightSize());
    myEditorCell.setWidth(getBorderBox().getInnerBox().getWidth());
    myEditorCell.setHeight(getBorderBox().getInnerBox().getHeight());
    if (useMove) {
      myEditorCell.moveTo(getBorderBox().getInnerBox().getX(), getBorderBox().getInnerBox().getY());
    } else {
      myEditorCell.setX(getBorderBox().getInnerBox().getX());
      myEditorCell.setY(getBorderBox().getInnerBox().getY());
    }
    if (myEditorCell instanceof EditorCell_Collection) {
      ((EditorCell_Collection) myEditorCell).setAscent(getBorderBox().getInnerBox().getAscent());
      ((EditorCell_Collection) myEditorCell).setDescent(getBorderBox().getInnerBox().getDescent());
    }
  }

  @Override
  public DefaultBoxModel clone() {
    EditorCellBoxModel clone = ((EditorCellBoxModel) super.clone());
    clone.myMarginBox = myMarginBox.clone();
    clone.myBorderBox = ((LayoutBoxFrame) clone.myMarginBox.getInnerBox());
    clone.myBracketsBox = ((LayoutBoxFrame) clone.myBorderBox.getInnerBox());
    clone.myPaddingBox = ((LayoutBoxFrame) clone.myBracketsBox.getInnerBox());
    clone.myContentBox = clone.myPaddingBox.getInnerBox();
    return clone;
  }

  @Override
  public boolean equals(Object o) {
    if (this == o) {
      return true;
    }
    if (o == null || this.getClass() != o.getClass()) {
      return false;
    }

    EditorCellBoxModel that = (EditorCellBoxModel) o;
    if ((myMarginBox != null ? !(myMarginBox.equals(that.myMarginBox)) : that.myMarginBox != null)) {
      return false;
    }
    if ((myEditorCell != null ? !(myEditorCell.equals(that.myEditorCell)) : that.myEditorCell != null)) {
      return false;
    }

    return true;
  }

  @Override
  public int hashCode() {
    int result = 0;
    result = 31 * result + ((myMarginBox != null ? ((Object) myMarginBox).hashCode() : 0));
    result = 31 * result + ((myEditorCell != null ? ((Object) myEditorCell).hashCode() : 0));
    return result;
  }
  private static <T> T as_rhf012_a0a0a3(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
