package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import com.mxgraph.shape.mxIShape;
import java.io.Serializable;
import java.util.concurrent.atomic.AtomicLong;
import java.util.Map;
import de.itemis.mps.editor.diagram.runtime.shape.IShape;
import com.intellij.util.containers.ContainerUtil;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import com.mxgraph.canvas.mxGraphics2DCanvas;
import com.mxgraph.view.mxCellState;
import com.mxgraph.view.mxGraphView;
import java.awt.geom.Rectangle2D;
import com.mxgraph.util.mxUtils;
import com.mxgraph.util.mxConstants;
import java.awt.Graphics2D;
import de.itemis.mps.editor.diagram.runtime.shape.GradientShapeStyle;
import de.itemis.mps.editor.diagram.runtime.shape.BoxStyleFromMPSStyle;

public class ShapeAdapter implements mxIShape, Serializable {
  private static AtomicLong ID_SEQUENCE = new AtomicLong();
  private static Map<Long, IShape> ourShapes = ContainerUtil.createWeakValueMap();

  private transient IShape myShape;
  private long myId = ID_SEQUENCE.incrementAndGet();

  public ShapeAdapter(IShape shape) {
    myShape = shape;
    MapSequence.fromMap(ourShapes).put(myId, shape);
  }

  public Object readResolve() {
    myShape = MapSequence.fromMap(ourShapes).get(myId);
    return this;
  }

  public void paintShape(mxGraphics2DCanvas canvas, final mxCellState state) {
    if (state.getWidth() <= 2 && state.getHeight() <= 2) {
      // performance optimization
      return;
    }

    mxGraphView view = state.getView();
    final double scale = view.getScale();
    final Rectangle2D rect = JGraphUtil.toRectangle2D(state);
    final boolean hasShadow = mxUtils.isTrue(state.getStyle(), mxConstants.STYLE_SHADOW, false);
    rect.setRect(rect.getX() - view.getTranslate().getX(), rect.getY() - view.getTranslate().getY(), rect.getWidth() / scale, rect.getHeight() / scale);

    DrawUtil.executeWithGraphicsCopy(canvas.getGraphics(), (Graphics2D graphics) -> {
      graphics.translate(state.getX(), state.getY());
      graphics.scale(scale, scale);
      graphics.translate(-rect.getX(), -rect.getY());
      GradientShapeStyle style = new GradientShapeStyle(hasShadow);

      // Use style from the EditorCell
      Object dcell = state.getCell();
      BoxDCell boxDCell = null;
      if (dcell instanceof BoxDCell) {
        boxDCell = ((BoxDCell) dcell);
      }
      if (dcell instanceof PortDCell) {
        boxDCell = ((PortDCell) dcell).getBox();
      }
      if (boxDCell != null) {
        style = new BoxStyleFromMPSStyle(boxDCell.getBox().getStyle(), hasShadow);
      }

      myShape.draw(graphics, rect, style);
    });
  }

  public IShape getWrapped() {
    return myShape;
  }
}
