package com.mbeddr.mpsutil.projectview.runtime.tree.highlighter;

/*Generated by MPS */

import java.util.List;
import com.mbeddr.mpsutil.projectview.runtime.tree.CustomTreeNode;
import java.util.ArrayList;
import java.util.concurrent.Semaphore;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.classloading.ClassLoaderManager;
import java.util.Collections;
import jetbrains.mps.classloading.DeployListener;
import java.util.Set;
import jetbrains.mps.module.ReloadableModule;
import org.jetbrains.mps.openapi.util.ProgressMonitor;

/**
 * Control listeners that track changes to module node.
 * Use {@link #startListening()}/{@link #startListening()} to turn change tracking on and off.
 * Use {@link #attach(jetbrains.mps.ide.ui.tree.module.ProjectModuleTreeNode)} and {@link #detach(jetbrains.mps.ide.ui.tree.module.ProjectModuleTreeNode)}
 * to include/exclude given node from update.
 */
public final class ModuleNodeListeners {
  private final List<CustomTreeNode> myNodes = new ArrayList<CustomTreeNode>();
  private final Semaphore myListAccess;
  private final TreeUpdateVisitor myChecker;
  private final MyReloadAdapter myHandler = new MyReloadAdapter();
  public ModuleNodeListeners(@NotNull TreeUpdateVisitor errorChecker) {
    myChecker = errorChecker;
    myListAccess = new Semaphore(1);
  }
  public void startListening() {
    ClassLoaderManager.getInstance().addListener(myHandler);
  }
  public void stopListening() {
    ClassLoaderManager.getInstance().removeListener(myHandler);
  }
  public void attach(@NotNull CustomTreeNode node) {
    myListAccess.acquireUninterruptibly();
    try {
      myNodes.add(node);
    } finally {
      myListAccess.release();
    }
    node.accept(myChecker);
  }
  public void detach(@NotNull CustomTreeNode node) {
    myListAccess.acquireUninterruptibly();
    try {
      myNodes.remove(node);
    } finally {
      myListAccess.release();
    }
  }
  /*package*/ void refreshTreeNodes() {
    List<CustomTreeNode> a = Collections.emptyList();
    myListAccess.acquireUninterruptibly();
    try {
      a = new ArrayList<CustomTreeNode>(myNodes);
    } finally {
      myListAccess.release();
    }
    for (CustomTreeNode n : a) {
      n.accept(myChecker);
    }
  }
  private class MyReloadAdapter implements DeployListener {

    @Override
    public void onLoaded(@NotNull Set<ReloadableModule> loadedModules, @NotNull ProgressMonitor monitor) {
      refreshTreeNodes();
    }

    @Override
    public void onUnloaded(@NotNull Set<ReloadableModule> unloadedModules, @NotNull ProgressMonitor monitor) {
    }
  }
}
