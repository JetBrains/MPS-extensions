package nl.f1re.testing.runtime;

/*Generated by MPS */

import com.intellij.openapi.project.Project;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import com.intellij.ide.CopyPasteManagerEx;
import java.awt.datatransfer.Transferable;
import java.awt.datatransfer.StringSelection;
import com.intellij.notification.Notification;
import java.util.concurrent.atomic.AtomicBoolean;
import com.intellij.notification.Notifications;
import org.jetbrains.annotations.NotNull;
import com.intellij.util.messages.MessageBusConnection;
import com.intellij.util.WaitFor;
import com.intellij.ide.PowerSaveMode;
import org.jetbrains.annotations.Nullable;
import java.util.List;
import com.intellij.diagnostic.AbstractMessage;
import com.intellij.diagnostic.MessagePool;
import org.junit.Assert;
import jetbrains.mps.internal.collections.runtime.ListSequence;

/**
 * This class can be called from places where there is no write/read access to the model like editor node test cases.
 */
public class PlatformTestHelper {
  private Project ideaProject;
  private jetbrains.mps.project.Project project;

  public PlatformTestHelper(jetbrains.mps.project.Project project) {
    this.ideaProject = ProjectHelper.toIdeaProject(project);
    this.project = project;
  }

  public void withClipboardData(_FunctionTypes._void_P0_E0 action, String data) {
    CopyPasteManagerEx manager = CopyPasteManagerEx.getInstanceEx();
    Transferable oldContents = manager.getContents();
    manager.setContents(new StringSelection(data));
    action.invoke();
    if (oldContents != null) {
      manager.setContents(oldContents);
    }
  }

  public void findNotification(_FunctionTypes._void_P0_E0 triggerNotification, final _FunctionTypes._void_P1_E0<? super Notification> action, int timeout) {
    final AtomicBoolean notificationFound = new AtomicBoolean(false);

    Notifications notifications = new Notifications() {
      @Override
      public void notify(@NotNull Notification notification) {
        action.invoke(notification);
        notificationFound.set(true);
      }
    };
    MessageBusConnection connection = ideaProject.getMessageBus().connect();
    connection.subscribe(Notifications.TOPIC, notifications);
    triggerNotification.invoke();

    boolean found = new WaitFor(timeout) {
      @Override
      protected boolean condition() {
        return notificationFound.get();
      }
    }.condition();
    connection.disconnect();

    assert found : "Notification not found";
  }

  public void withPowerSaveModelEnabled(_FunctionTypes._void_P0_E0 code) {
    boolean wasEnabled = PowerSaveMode.isEnabled();
    try {
      PowerSaveMode.setEnabled(true);
      code.invoke();
    } finally {
      PowerSaveMode.setEnabled(wasEnabled);
    }
  }

  public void assertHasFatalError(@Nullable String errorText) {
    List<AbstractMessage> fatalErrors = MessagePool.getInstance().getFatalErrors(true, true);
    if (errorText != null) {
      Assert.assertEquals(errorText, ListSequence.fromList(fatalErrors).last().getMessage());
    } else {
      Assert.assertTrue(ListSequence.fromList(fatalErrors).isNotEmpty());
    }
  }
}
