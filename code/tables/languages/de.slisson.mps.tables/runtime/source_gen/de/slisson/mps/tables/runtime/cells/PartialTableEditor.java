package de.slisson.mps.tables.runtime.cells;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import de.slisson.mps.tables.runtime.gridmodel.Grid;
import de.itemis.mps.editor.celllayout.runtime.TopDownCellLayoutAdapter;
import jetbrains.mps.openapi.editor.cells.CellAction;
import jetbrains.mps.editor.runtime.cells.AbstractCellAction;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import java.awt.Graphics;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import java.util.List;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.nodeEditor.EditorMessage;
import jetbrains.mps.openapi.editor.cells.CellMessagesUtil;
import java.awt.Rectangle;
import jetbrains.mps.nodeEditor.cells.GeometryUtil;

public class PartialTableEditor extends AbstractTableEditor {

  private EditorCell_Collection myOriginalParent;

  public PartialTableEditor(EditorContext context, final SNode snode, Grid grid) {
    super(context, snode, new TopDownCellLayoutAdapter(new PartialTableLayout()), grid);
    ChildsTracker instance = ChildsTracker.getInstance();
    if (instance == null) {
      throw new IllegalStateException("ChildsTracker is null: the partial table might not be part of a table.");
    }
    instance.registerChild(this);
    CellAction deleteAction = new AbstractCellAction() {
      public void execute(EditorContext p0) {
        SNodeOperations.deleteNode(snode);
      }
    };
    setAction(CellActionType.DELETE, deleteAction);
    setAction(CellActionType.BACKSPACE, deleteAction);
  }

  public void memorizeOriginalParent() {
    myOriginalParent = getParent();
  }

  public void resetToOriginalParent() {
    if (myOriginalParent != null) {
      myOriginalParent.addEditorCell(this);
    }
  }

  public void init() {
  }

  @Override
  protected void paintContent(Graphics graphics, ParentSettings parentSettings) {
    ParentSettings settings = isSelectionPaintedOnAncestor(parentSettings);
    if (settings.isSelectionPainted()) {
      List<EditorCell> cells = TableUtils.getEditorCellsFromGrid(myGrid);
      cells = ListSequence.fromList(cells).select((it) -> (it.getParent() instanceof EditorCell_GridCell ? it.getParent() : it)).toList();
      TableUtils.paintSelection(graphics, getSelectionColor(), cells, parentSettings);
    }
  }

  public void paintMessages(Graphics g) {
    List<EditorMessage> messages = CellMessagesUtil.getMessages(this, EditorMessage.class);
    for (EditorMessage message : messages) {
      if (message != null && !(message.isBackground())) {
        message.paint(g, getEditor(), this);
      }
    }
  }

  public void updateBounds() {
    List<EditorCell> cells = TableUtils.getEditorCellsFromGrid(myGrid);
    if (cells.size() > 0) {
      Rectangle bounds = GeometryUtil.getBounds(cells.toArray(new EditorCell[cells.size()]));
      myX = bounds.x;
      myY = bounds.y;
      myWidth = bounds.width;
      myHeight = bounds.height;
    } else {
      EditorCell_Collection parent = getParent();
      if (parent != null) {
        myX = parent.getX();
        myY = parent.getY();
        myWidth = 0;
        myHeight = 0;
      }
    }
  }
}
