package com.mbeddr.mpsutil.projectview.runtime.tree;

/*Generated by MPS */

import jetbrains.mps.ide.ui.tree.MPSTreeNode;
import jetbrains.mps.logging.Logger;
import com.mbeddr.mpsutil.projectview.runtime.ViewElement;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.ide.ui.tree.MPSTree;
import com.intellij.ui.SimpleTextAttributes;
import java.awt.font.TextAttribute;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.ide.ui.tree.TextTreeNode;
import com.intellij.openapi.application.ApplicationManager;
import java.util.List;
import jetbrains.mps.ide.ThreadUtils;
import jetbrains.mps.project.Project;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import com.mbeddr.mpsutil.projectview.runtime.IViewElementDescriptor;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.openapi.navigation.EditorNavigator;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.module.SModule;
import javax.swing.Icon;

public class CustomTreeNode<E> extends MPSTreeNode implements ITreeNode {
  private static final Logger LOG = Logger.getLogger(CustomTreeNode.class);

  private static boolean ourLoadImmediately = false;

  public static void loadAllImmediately(Runnable r) {
    final boolean wasLoadImmediately = ourLoadImmediately;
    try {
      ourLoadImmediately = true;
      r.run();
    } finally {
      ourLoadImmediately = wasLoadImmediately;
    }
  }

  private final ViewElement<E> myElement;
  private boolean myInitialized = false;
  private final boolean myHasChildDescriptors;
  private boolean myIsInvalid = false;

  public CustomTreeNode(ViewElement element) {
    myElement = element;
    setNodeIdentifier(element.getId());
    myHasChildDescriptors = Sequence.fromIterable(getChildDescriptors()).isNotEmpty();
  }

  @Override
  public void setTree(MPSTree tree) {
    super.setTree(((CustomProjectTree) tree));
  }

  @Override
  public CustomProjectTree getTree() {
    final MPSTree tree = super.getTree();
    return (CustomProjectTree) tree;
  }

  public boolean isInTree() {
    return super.getTree() != null;
  }

  protected void doUpdatePresentation() {
    super.doUpdatePresentation();
    CustomProjectTree tree = getTree();
    if (tree == null) {
      return;
    }
    tree.getUpdater().recordPresentationLoad(this, () -> {
      SimpleTextAttributes attrs = myElement.getTextAttributes();
      setColor(attrs.getFgColor());
      addFontAttribute(TextAttribute.BACKGROUND, attrs.getBgColor());
      setFontStyle(attrs.getFontStyle());
      setText(myElement.getLabel());
      setIcon(myElement.getIcon());
      if (myElement.getObject() instanceof SNode) {
        setAutoExpandable(!(isRootSNode(as_fdekl4_a0a0a0a6a1a0d0t(myElement.getObject(), SNode.class))));
        setToggleClickCount(-1);
      }
    });
  }

  public ViewElement<E> getElement() {
    return myElement;
  }

  @Override
  public boolean isInitialized() {
    return myInitialized;
  }

  @Override
  protected void doInit() {
    removeAllChildren();
    if (isLoadingAsync()) {
      add(new TextTreeNode("loading..."));
      if (isInTree()) {
        (getTree().getDFTreeModel()).nodeStructureChanged(this);
      }
      myInitialized = true;
      setInvalid(false);
      ApplicationManager.getApplication().executeOnPooledThread(() -> queryAndLoadChildren());
    } else {
      queryAndLoadChildren();
    }
  }

  protected void queryAndLoadChildren() {
    getTree().getUpdater().recordChildrenLoad(this, () -> {
      try {
        final List<ViewElement> queryResult = queryChildElements();
        ThreadUtils.runInUIThreadAndWait(() -> {
          if (isInTree()) {
            loadChildElements(queryResult);
          }
        });
      } catch (Exception ex) {
        myInitialized = false;
        removeAllChildren();
        if (LOG.isErrorLevel()) {
          LOG.error("", ex);
        }
      }
    });
  }

  protected List<ViewElement> queryChildElements() {
    final Project project = myElement.getProject();
    final List<ViewElement> result = ListSequence.fromList(new ArrayList<ViewElement>());
    project.getRepository().getModelAccess().runReadAction(() -> {
      for (IViewElementDescriptor childDescriptor : Sequence.fromIterable(getChildDescriptors())) {
        if (!(childDescriptor.isApplicable(project, myElement))) {
          continue;
        }
        final Iterable<ViewElement<Object>> elements = childDescriptor.queryElements(project, myElement, myElement.getViewId());
        Sequence.fromIterable(elements).visitAll((it) -> it.setParent(myElement));
        ListSequence.fromList(result).addSequence(Sequence.fromIterable(elements));
      }
    });
    return result;
  }

  protected void loadChildElements(final List<ViewElement> queryResult) {
    myElement.getProject().getRepository().getModelAccess().runReadAction(() -> {
      removeAllChildren();
      FolderStructureBuilder.build(ListSequence.fromList(queryResult).select(new _FunctionTypes._return_P1_E0<CustomTreeNode, ViewElement>() {
        public CustomTreeNode invoke(ViewElement it) {
          return new CustomTreeNode(it);
        }
      }).toList(), CustomTreeNode.this);
      myInitialized = true;
      setInvalid(false);
      if (isInTree()) {
        (getTree().getDFTreeModel()).nodeStructureChanged(CustomTreeNode.this);
      }
    });
  }

  @Override
  protected void doUpdate() {
    removeAllChildren();
    myInitialized = false;
  }

  protected Iterable<IViewElementDescriptor> getChildDescriptors() {
    return myElement.getChildDescriptors();
  }

  @Override
  public boolean isLeaf() {
    if (!(myHasChildDescriptors)) {
      return true;
    }
    if (!(myInitialized)) {
      return false;
    }
    return super.isLeaf();
  }

  @Override
  public void doubleClick() {
    if (myElement.getObject() instanceof SNode) {
      final SNode node = ((SNode) myElement.getObject());
      new EditorNavigator(myElement.getProject()).shallFocus(true).selectIfChild().open(node.getReference());
    } else if (myElement.getObject() instanceof Tuples._1) {
      final Tuples._1 t = (Tuples._1) myElement.getObject();
      final Object _0 = t._0();
      if (_0 instanceof jetbrains.mps.smodel.SNode) {
        SNodeOperations.getModel(((SNode) _0)).getRepository().getModelAccess().runReadAction(() -> new EditorNavigator(myElement.getProject()).shallFocus(true).selectIfChild().open(((jetbrains.mps.smodel.SNode) _0).getReference()));
      }
    }
  }

  public boolean isRootSNode(final SNode node) {
    if (node == null) {
      return false;
    }
    return node.getModel() != null && node.getParent() == null;
  }

  @Override
  protected boolean canBeOpened() {
    if (myElement.getObject() instanceof SNode) {
      return true;
    }
    if (myElement.getObject() instanceof Tuples._1) {
      return true;
    }
    return false;
  }

  public void accept(@NotNull final ITreeVisitor visitor) {
    final Object obj = myElement.getObject();
    if (obj instanceof SModel) {
      visitor.visitModelNode(this);
    } else if (obj instanceof SModule) {
      visitor.visitModuleNode(this);
    } else if (obj instanceof Project) {
      visitor.visitProjectNode(this);
    }
  }

  public E getObject() {
    return myElement.getObject();
  }

  public <T> T getObject(Class<T> type) {
    final Object obj = getObject();
    return (type.isInstance(obj) ? ((T) obj) : null);
  }

  public SModel getModel() {
    return getObject(SModel.class);
  }

  public SModule getModule() {
    return getObject(SModule.class);
  }

  public Project getProject() {
    return getObject(Project.class);
  }

  public SNode getSNode() {
    return getObject(SNode.class);
  }

  public Icon getDefaultIcon() {
    return myElement.getIcon();
  }

  @Override
  protected void onAdd() {
    super.onAdd();
    if (!(myElement.loadLazy())) {
      init();
    }
  }

  public boolean isLoadingAsync() {
    return myElement.loadAsync() && !(ourLoadImmediately);
  }

  public static void initIfNotAsync(final MPSTreeNode treeNode) {
    if (treeNode instanceof CustomTreeNode) {
      if (((CustomTreeNode) treeNode).isLoadingAsync()) {
        return;
      }
    }
    treeNode.init();
  }

  public void setInvalid(final boolean newValue) {
    myIsInvalid = newValue;
    getTree().repaint();
  }

  public boolean isInvalid() {
    return myIsInvalid || check_fdekl4_a0a0qc(as_fdekl4_a0a0a0rc(getParent(), ITreeNode.class), this);
  }

  public boolean isAutoUpdate() {
    return myElement.isAutoUpdate();
  }

  public boolean canUpdateManually() {
    return isInvalid() && !(check_fdekl4_a0a0a27(as_fdekl4_a0a0a0a37(getParent(), ITreeNode.class), this));
  }

  public void updateManually() {
    myInitialized = false;
    init();
  }
  private static <E> boolean check_fdekl4_a0a0qc(ITreeNode checkedDotOperand, CustomTreeNode<E> checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.isInvalid();
    }
    return false;
  }
  private static <E> boolean check_fdekl4_a0a0a27(ITreeNode checkedDotOperand, CustomTreeNode<E> checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.isInvalid();
    }
    return false;
  }
  private static <T> T as_fdekl4_a0a0a0a6a1a0d0t(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_fdekl4_a0a0a0rc(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_fdekl4_a0a0a0a37(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
