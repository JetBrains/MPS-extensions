package de.itemis.mps.selection.runtime.mouse;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.selection.Selection;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.EditorComponent;
import org.jetbrains.mps.util.Condition;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import jetbrains.mps.nodeEditor.cells.CellFinderUtil;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.Objects;

public class NodeRangeSelectionHandler extends AbstractDragSelectionHandler {
  public Selection createSelection(final EditorCell fromCell, EditorCell toCell, int fromX, int fromY, int toX, int toY, EditorComponent editorComponent) {

    final EditorCell commonParent = findCommonParent(fromCell, toCell);

    Condition<EditorCell_Collection> directChildOfCommonParent = new Condition<EditorCell_Collection>() {
      public boolean met(EditorCell_Collection cell) {
        return cell.getParent() == commonParent;
      }
    };

    final EditorCell_Collection childFrom = CellFinderUtil.findParent(fromCell, directChildOfCommonParent);
    final EditorCell_Collection childTo = CellFinderUtil.findParent(toCell, directChildOfCommonParent);
    if (childFrom != null && childTo != null) {
      final Wrappers._T<Selection> selection = new Wrappers._T<Selection>(null);
      editorComponent.getEditorContext().getRepository().getModelAccess().runReadAction(() -> {
        SNode fromNode = childFrom.getSNode();
        SNode toNode = childTo.getSNode();
        if (SNodeOperations.getParent(fromNode) != null && fromNode != toNode && SNodeOperations.getParent(fromNode) == SNodeOperations.getParent(toNode) && Objects.equals(SNodeOperations.getContainingLink(fromNode), SNodeOperations.getContainingLink(toNode))) {
          selection.value = fromCell.getEditorComponent().getSelectionManager().createRangeSelection(fromNode, toNode);
        }
      });
      return selection.value;
    }

    return null;
  }

  @Override
  public int getPriority() {
    return -200;
  }
}
