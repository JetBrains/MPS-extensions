package com.mbeddr.mpsutil.treenotation.runtime;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.cells.EditorCell;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.editor.runtime.cells.ReadOnlyUtil;
import jetbrains.mps.nodeEditor.cells.CellFinderUtil;
import org.jetbrains.mps.util.Condition;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import jetbrains.mps.openapi.editor.cells.CellAction;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import java.awt.Graphics2D;
import java.awt.BasicStroke;
import com.intellij.ui.JBColor;
import java.awt.geom.Line2D;

public class DeleteButton extends Button {

  private EditorCell myCellToDelete;

  public DeleteButton(@NotNull EditorContext editorContext, SNode node, EditorCell cellToDelete) {
    super(editorContext, node);
    myCellToDelete = cellToDelete;
  }

  @Override
  public void onClick() {
    if (ReadOnlyUtil.isCellReadOnly(this)) {
      return;
    }

    getContext().getRepository().getModelAccess().executeCommand(() -> {
      TreeCell treeCell = CellFinderUtil.findChildByClass(myCellToDelete, TreeCell.class, true, true);
      if (treeCell == null) {
        Condition<EditorCell_Collection> condition = new Condition<EditorCell_Collection>() {
          @Override
          public boolean met(EditorCell_Collection collection) {
            return collection instanceof TreeCell;
          }
        };
        treeCell = as_qkmoa6_a0a1a1a0a0c0f(CellFinderUtil.findParent(myCellToDelete, condition), TreeCell.class);
      }

      if (treeCell != null) {
        IDeleteHandler deleteHandler = treeCell.getDeleteHandler();
        if (deleteHandler != null) {
          deleteHandler.delete(treeCell.getContext(), treeCell.getSNode());
          return;
        }
      }
      CellAction cellAction = myCellToDelete.getAction(CellActionType.DELETE);
      if (cellAction != null && cellAction.canExecute(myCellToDelete.getContext())) {
        cellAction.execute(myCellToDelete.getContext());
        return;
      }

      cellAction = myCellToDelete.getAction(CellActionType.BACKSPACE);
      if (cellAction != null && cellAction.canExecute(myCellToDelete.getContext())) {
        cellAction.execute(myCellToDelete.getContext());
        return;
      }

    });
  }

  @Override
  protected void paintSymbol(Graphics2D g) {
    if (ReadOnlyUtil.isCellReadOnly(this)) {
      return;
    }

    double width = getWidth();
    double padding = width * 0.2;
    g.setStroke(new BasicStroke(2.0f));
    g.setColor(JBColor.RED);
    g.draw(new Line2D.Double(getX() + padding, getY() + padding, getX() + getWidth() - padding, getY() + getHeight() - padding));
    g.draw(new Line2D.Double(getX() + getWidth() - padding, getY() + padding, getX() + padding, getY() + getHeight() - padding));
  }

  private static <T> T as_qkmoa6_a0a1a1a0a0c0f(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
