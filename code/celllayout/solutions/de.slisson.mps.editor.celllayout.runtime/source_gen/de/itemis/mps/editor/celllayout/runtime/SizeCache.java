package de.itemis.mps.editor.celllayout.runtime;

/*Generated by MPS */

import de.itemis.mps.editor.celllayout.boxmodel.Size;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;

/**
 * Optimized for memory efficiency
 */
public class SizeCache {
  private static final int KEY_SIZE = 2;
  private static final int VALUE_SIZE = 2;
  private static final int RECORD_SIZE = KEY_SIZE + VALUE_SIZE;

  private int[] myData = new int[0];

  public int getSize() {
    return myData.length / RECORD_SIZE;
  }

  protected Size getKey(int index) {
    int offset = index * RECORD_SIZE;
    return new Size(myData[offset], myData[offset + 1]);
  }

  protected Size getValue(int index) {
    int offset = index * RECORD_SIZE + KEY_SIZE;
    return new Size(myData[offset], myData[offset + 1]);
  }

  protected void setValue(int index, Size value) {
    int offset = index * RECORD_SIZE + KEY_SIZE;
    myData[offset] = value.getWidth();
    myData[offset + 1] = value.getHeight();
  }

  protected void setKey(int index, Size key) {
    int offset = index * RECORD_SIZE;
    myData[offset] = key.getWidth();
    myData[offset + 1] = key.getHeight();
  }

  protected int indexOf(Size key) {
    int low = 0;
    int high = getSize() - 1;
    while (low <= high) {
      int mid = (low + high) >>> 1;
      Size midKey = getKey(mid);
      int cmp = midKey.compareTo(key);
      if (cmp < 0) {
        low = mid + 1;
      } else if (cmp > 0) {
        high = mid - 1;
      } else {
        return mid;
      }
    }
    return -(low + 1);
  }

  public void clear() {
    myData = new int[0];
  }

  public Size get(Size key) {
    int index = indexOf(key);
    return (index >= 0 ? getValue(index) : null);
  }

  public void put(Size key, Size value) {
    int index = indexOf(key);
    if (index >= 0) {
      setValue(index, value);
    } else {
      index = -index - 1;
      int[] newData = new int[myData.length + RECORD_SIZE];
      System.arraycopy(myData, 0, newData, 0, index * RECORD_SIZE);
      System.arraycopy(myData, index * RECORD_SIZE, newData, (index + 1) * RECORD_SIZE, myData.length - index * RECORD_SIZE);
      myData = newData;
      setKey(index, key);
      setValue(index, value);
    }
  }

  public void visitEntries(_FunctionTypes._return_P2_E0<? extends Boolean, ? super Size, ? super Size> visitor) {
    for (int i = 0; i < getSize(); i++) {
      if (!(visitor.invoke(getKey(i), getValue(i)))) {
        return;
      }
    }
  }
}
