package com.dslfoundry.plaintextgen.plugin;

/*Generated by MPS */

import java.awt.datatransfer.Transferable;
import com.intellij.ide.CopyPasteManagerEx;
import java.awt.datatransfer.DataFlavor;
import java.awt.datatransfer.UnsupportedFlavorException;
import java.io.IOException;
import jetbrains.mps.baseLanguage.logging.rt.LogContext;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.Stack;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class PlaintextPaster {
  public static String getStringFromClipboard() {
    Transferable contents = null;

    for (Transferable trf : CopyPasteManagerEx.getInstanceEx().getAllContents()) {
      if (trf != null && trf.isDataFlavorSupported(DataFlavor.stringFlavor)) {
        contents = trf;
      }
      break;
    }
    if (contents == null) {
      return null;
    }
    if (contents.isDataFlavorSupported(DataFlavor.stringFlavor)) {
      try {
        Object data = contents.getTransferData(DataFlavor.stringFlavor);
        if (data instanceof String) {
          return (String) data;
        }
      } catch (UnsupportedFlavorException ex) {
        return null;
      } catch (IOException ex) {
        LogContext.with(PlaintextPaster.class, ex, null, null).error("Pasting from clipboard went wrong!");
      }
    }
    return null;
  }

  private static Integer IndentationLevel(String s) {
    if ((s == null || s.length() == 0)) {
      return 0;
    }
    for (int i = 0; i < s.length(); ++i) {
      if (s.charAt(i) != ' ') {
        return i;
      }
    }
    return s.length();
  }

  private static String ToIndent(int level) {
    StringBuilder b = new StringBuilder();
    for (int i = 0; i < level; ++i) {
      b.append(" ");
    }
    return b.toString();
  }

  public static void pastePlainText(SNode node) {
    Stack<Integer> levels = new Stack();
    Stack<SNode> containers = new Stack<SNode>();
    containers.add(SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0xfe48d5fcaff41e5L, "com.dslfoundry.plaintextgen.structure.VerticalLines")));
    levels.add(0);

    String text = getStringFromClipboard();
    if ((text != null && text.length() > 0)) {
      for (String line : text.split("\\r?\\n")) {
        SNode lineNode = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0xfe48d5fcafd47efL, "com.dslfoundry.plaintextgen.structure.Line"));
        SLinkOperations.setNewChild(lineNode, LINKS.newlineMarker$LMfW, null);
        if (isEmptyString(line.trim())) {
          ListSequence.fromList(SLinkOperations.getChildren(lineNode, LINKS.words$teE6)).removeElementAt(0);
        } else {
          // MPS text fields strip away the tabs, so we replace them by spaces.
          String l = line.replaceAll("\t", "    ");
          Integer lvl = IndentationLevel(l);
          SPropertyOperations.assign(SNodeOperations.cast(ListSequence.fromList(SLinkOperations.getChildren(lineNode, LINKS.words$teE6)).getElement(0), CONCEPTS.word$dj), PROPS.name$MnvL, l.trim());
          SNode last_container = containers.peek();
          int last_level = levels.peek();
          while (lvl < levels.peek()) {
            last_container = containers.pop();
            last_level = levels.pop();
          }
          Integer current = levels.peek();
          if (current < lvl) {
            SNode container = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0xfe48d5fcafd47e9L, "com.dslfoundry.plaintextgen.structure.SpaceIndentedText"));
            SPropertyOperations.assign(container, PROPS.indent$WJd, ToIndent(lvl - current));
            ListSequence.fromList(SLinkOperations.getChildren(containers.peek(), LINKS.lines$u7C)).addElement(container);
            containers.add(container);
            levels.add(lvl);
            if (lvl < last_level) {
              ListSequence.fromList(SLinkOperations.getChildren(container, LINKS.lines$u7C)).addElement(last_container);
              SPropertyOperations.assign(SNodeOperations.cast(last_container, CONCEPTS.SpaceIndentedText$2u), PROPS.indent$WJd, ToIndent(last_level - lvl));
            }
          }
        }
        ListSequence.fromList(SLinkOperations.getChildren(containers.peek(), LINKS.lines$u7C)).addElement(lineNode);
      }
      SNodeOperations.replaceWithAnother(node, containers.firstElement());
    }
  }

  /**
   * Preserve tabs
   */
  public static void pastePlainTextWithTabs(SNode node) {
    Stack<Integer> levels = new Stack();
    Stack<SNode> containers = new Stack<SNode>();
    containers.add(SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0xfe48d5fcaff41e5L, "com.dslfoundry.plaintextgen.structure.VerticalLines")));
    levels.add(0);

    String text = getStringFromClipboard();
    if ((text != null && text.length() > 0)) {
      for (String line : text.split("\\r?\\n")) {
        SNode lineNode = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0xfe48d5fcafd47efL, "com.dslfoundry.plaintextgen.structure.Line"));
        SLinkOperations.setNewChild(lineNode, LINKS.newlineMarker$LMfW, null);
        if (isEmptyString(line.trim())) {
          ListSequence.fromList(SLinkOperations.getChildren(lineNode, LINKS.words$teE6)).removeElementAt(0);
        } else {
          // MPS text fields strip away the tabs, so we replace them by spaces.
          ListSequence.fromList(SLinkOperations.getChildren(lineNode, LINKS.words$teE6)).clear();
          String[] parts = line.split("\t", -1);
          for (String x : parts) {
            SPropertyOperations.assign(SLinkOperations.addNewChild(lineNode, LINKS.words$teE6, CONCEPTS.word$dj), PROPS.name$MnvL, x);
            SLinkOperations.addNewChild(lineNode, LINKS.words$teE6, CONCEPTS.tab$tC);
          }
          if ((line != null && line.length() > 0)) {
            ListSequence.fromList(SLinkOperations.getChildren(lineNode, LINKS.words$teE6)).removeLastElement();
          }
        }
        ListSequence.fromList(SLinkOperations.getChildren(containers.peek(), LINKS.lines$u7C)).addElement(lineNode);
      }
      SNodeOperations.replaceWithAnother(node, containers.firstElement());
    }
  }
  private static boolean isEmptyString(String str) {
    return str == null || str.isEmpty();
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink newlineMarker$LMfW = MetaAdapterFactory.getContainmentLink(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0xfe48d5fcafd47efL, 0x4687342eecce49c3L, "newlineMarker");
    /*package*/ static final SContainmentLink words$teE6 = MetaAdapterFactory.getContainmentLink(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0xfe48d5fcafd47efL, 0xfe48d5fcafd47f2L, "words");
    /*package*/ static final SContainmentLink lines$u7C = MetaAdapterFactory.getContainmentLink(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0x64208511ac2f6788L, 0x64208511ac2f6798L, "lines");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept word$dj = MetaAdapterFactory.getConcept(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0xfe48d5fcafd47f4L, "com.dslfoundry.plaintextgen.structure.word");
    /*package*/ static final SConcept SpaceIndentedText$2u = MetaAdapterFactory.getConcept(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0xfe48d5fcafd47e9L, "com.dslfoundry.plaintextgen.structure.SpaceIndentedText");
    /*package*/ static final SConcept tab$tC = MetaAdapterFactory.getConcept(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0x2785a009e0883ec8L, "com.dslfoundry.plaintextgen.structure.tab");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty indent$WJd = MetaAdapterFactory.getProperty(0x990507d335274c54L, 0xbfe90ca3c9c6247aL, 0xfe48d5fcafd47e9L, 0x48241aad8b2b218cL, "indent");
  }
}
