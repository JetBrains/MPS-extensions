package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import org.jetbrains.annotations.NotNull;
import java.util.List;
import com.mxgraph.view.mxCellState;
import com.mxgraph.view.mxGraphView;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import com.mxgraph.model.mxCell;
import com.mxgraph.util.mxPoint;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;

public class SmartGuide_PortConnection implements ISmartGuide {

  @NotNull
  public List<SnapResult> snap(double dx, double dy, double distanceLimit, mxCellState movingState, List<mxCellState> otherStates, mxGraphView view) {

    List<SnapResult> result = ListSequence.fromList(new ArrayList<SnapResult>());

    BoxDCell movingCell = as_rdktr9_a0a3a1(movingState.getCell(), BoxDCell.class);
    if (movingCell != null) {
      List<mxCell> edges = collectEdged(movingCell);
      for (mxCell edge : ListSequence.fromList(edges)) {
        mxCellState edgeState = view.getState(edge);
        if (edgeState == null) {
          continue;
        }
        mxPoint p1 = edgeState.getAbsolutePoint(0);
        mxPoint p2 = edgeState.getAbsolutePoint(edgeState.getAbsolutePointCount() - 1);
        if (JGraphUtil.isAncestor(movingCell, ((mxCell) edge.getTerminal(false)))) {
          {
            Tuples._2<mxPoint, mxPoint> _tmp_rdktr9_a0e0b0e0b = MultiTuple.<mxPoint,mxPoint>from(p2, p1);
            p1 = _tmp_rdktr9_a0e0b0e0b._0();
            p2 = _tmp_rdktr9_a0e0b0e0b._1();
          }
        }
        p1 = new mxPoint(p1.getX() + dx, p1.getY() + dy);

        SnapResult snapResult = new SnapResult();
        snapResult.setSnapDistanceX(0);
        snapResult.setSnapDistanceY(p2.getY() - p1.getY());
        snapResult.setGuideLine(p1.getX(), p1.getY() + snapResult.getSnapDistanceY(), p2.getX(), p2.getY());

        if (Math.abs(snapResult.getSnapDistanceY()) < distanceLimit) {
          ListSequence.fromList(result).addElement(snapResult);
        }
      }
    }

    return result;
  }

  public List<mxCell> collectEdged(mxCell cell) {
    List<mxCell> result = ListSequence.fromList(new ArrayList<mxCell>());
    collectEdges(cell, cell, result);
    return result;
  }

  public void collectEdges(mxCell start, mxCell current, List<mxCell> edges) {
    for (int i = 0; i < current.getEdgeCount(); i++) {
      mxCell edge = (mxCell) current.getEdgeAt(i);
      mxCell fromTerminal = ((mxCell) edge.getTerminal(false));
      mxCell toTerminal = ((mxCell) edge.getTerminal(true));
      if (fromTerminal != null && toTerminal != null) {
        if (!(JGraphUtil.isAncestor(start, fromTerminal)) || !(JGraphUtil.isAncestor(start, toTerminal))) {
          ListSequence.fromList(edges).addElement(edge);
        }
      }
    }
    for (int i = 0; i < current.getChildCount(); i++) {
      collectEdges(start, ((mxCell) current.getChildAt(i)), edges);
    }
  }


  private static <T> T as_rdktr9_a0a3a1(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
