package de.itemis.mps.editor.diagram.runtime.model;

/*Generated by MPS */

import java.util.Map;
import org.jetbrains.mps.openapi.model.SNode;
import java.lang.ref.WeakReference;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.WeakHashMap;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.HashMap;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class LayoutMap {

  private static Map<SNode, WeakReference<LayoutMap>> instances = MapSequence.fromMap(new WeakHashMap<SNode, WeakReference<LayoutMap>>());

  public static LayoutMap getInstance(@NotNull SNode host) {
    LayoutMap instance = check_57e9y1_a0a0d(MapSequence.fromMap(instances).get(host));
    if (instance == null || !(instance.isValid())) {
      instance = new LayoutMap(host);
      MapSequence.fromMap(instances).put(host, new WeakReference<LayoutMap>(instance));
    }
    return instance;
  }

  private SNode myHost;
  private SNode myOriginalMapNode;

  public static final String USER_OBJECT_CACHE_KEY = LayoutMap.class.getName() + "_CACHE_KEY";

  private LayoutMap(SNode host) {
    myHost = host;
  }

  public boolean isValid() {
    return new IAttributeDescriptor.NodeAttribute(CONCEPTS.LayoutMap$4m).get(myHost) == myOriginalMapNode;
  }

  protected void initCache(SNode mapNode) {
    SProperty property = PROPS.key$MW00;

    for (SNode entry : ListSequence.fromList(SLinkOperations.getChildren(mapNode, LINKS.entries$808Q))) {
      MapSequence.fromMap(getCache()).put(((String) property.getType().fromString(entry.getProperty(property))), entry);
    }
    myOriginalMapNode = mapNode;
  }

  protected void initCache() {
    if ((new IAttributeDescriptor.NodeAttribute(CONCEPTS.LayoutMap$4m).get(myHost) != null)) {
      initCache(new IAttributeDescriptor.NodeAttribute(CONCEPTS.LayoutMap$4m).get(myHost));
    }
  }

  public void setValue(@NotNull String key, @Nullable SNode value, boolean persist) {
    SNode mapNode = new IAttributeDescriptor.NodeAttribute(CONCEPTS.LayoutMap$4m).get(myHost);
    if (mapNode == null) {
      if (value == null) {
        return;
      } else if (persist) {
        mapNode = new IAttributeDescriptor.NodeAttribute(CONCEPTS.LayoutMap$4m).setNew(myHost);
      }
    }

    if (MapSequence.fromMap(getCache()).isEmpty()) {
      initCache(mapNode);
    }

    SNode entry = MapSequence.fromMap(getCache()).get(key);
    if (entry == null) {
      if (value == null) {
        return;
      } else {
        if (persist) {
          entry = SLinkOperations.addNewChild(mapNode, LINKS.entries$808Q, null);
        } else {
          entry = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x8ca79d43eb454791L, 0xbdd40d6130ff895bL, 0x7c646f09bb3f149fL, "de.itemis.mps.editor.diagram.layout.structure.LayoutMapEntry"));
        }
        SPropertyOperations.assign(entry, PROPS.key$MW00, key);
        MapSequence.fromMap(getCache()).put(key, entry);
      }
    }

    if (value == null) {
      SNodeOperations.deleteNode(entry);
      MapSequence.fromMap(getCache()).removeKey(key);
    } else {
      SLinkOperations.setTarget(entry, LINKS.value$MWW4, value);
    }
  }

  protected Map<String, SNode> getCache() {
    Map<String, SNode> cache = (Map<String, SNode>) myHost.getUserObject(USER_OBJECT_CACHE_KEY);
    if (cache == null) {
      cache = MapSequence.fromMap(new HashMap<String, SNode>());
      myHost.putUserObject(USER_OBJECT_CACHE_KEY, cache);
    }
    return cache;
  }

  @Nullable
  public SNode getValue(@NotNull String key) {
    if (MapSequence.fromMap(getCache()).isEmpty()) {
      SNode mapNode = new IAttributeDescriptor.NodeAttribute(CONCEPTS.LayoutMap$4m).get(myHost);
      if (mapNode == null) {
        return null;
      }
      initCache(mapNode);
    }

    SNode entry = MapSequence.fromMap(getCache()).get(key);
    return SLinkOperations.getTarget(entry, LINKS.value$MWW4);
  }

  public boolean hasAnyLayoutData() {
    return ListSequence.fromList(SLinkOperations.getChildren(new IAttributeDescriptor.NodeAttribute(CONCEPTS.LayoutMap$4m).get(myHost), LINKS.entries$808Q)).isNotEmpty();
  }
  private static LayoutMap check_57e9y1_a0a0d(WeakReference<LayoutMap> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get();
    }
    return null;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept LayoutMap$4m = MetaAdapterFactory.getConcept(0x8ca79d43eb454791L, 0xbdd40d6130ff895bL, 0x7c646f09bb3f148eL, "de.itemis.mps.editor.diagram.layout.structure.LayoutMap");
  }

  private static final class PROPS {
    /*package*/ static final SProperty key$MW00 = MetaAdapterFactory.getProperty(0x8ca79d43eb454791L, 0xbdd40d6130ff895bL, 0x7c646f09bb3f149fL, 0x7c646f09bb3f2e00L, "key");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink entries$808Q = MetaAdapterFactory.getContainmentLink(0x8ca79d43eb454791L, 0xbdd40d6130ff895bL, 0x7c646f09bb3f148eL, 0x7c646f09bb3f14a0L, "entries");
    /*package*/ static final SContainmentLink value$MWW4 = MetaAdapterFactory.getContainmentLink(0x8ca79d43eb454791L, 0xbdd40d6130ff895bL, 0x7c646f09bb3f149fL, 0x7c646f09bb3f2e04L, "value");
  }
}
