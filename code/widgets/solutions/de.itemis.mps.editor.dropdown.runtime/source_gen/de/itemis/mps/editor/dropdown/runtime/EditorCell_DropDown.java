package de.itemis.mps.editor.dropdown.runtime;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.nodeEditor.cellLayout.CellLayout_Horizontal;
import java.awt.Graphics;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import java.awt.Graphics2D;
import com.intellij.ide.ui.laf.darcula.DarculaUIUtil;
import java.awt.BasicStroke;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.nodeEditor.cells.EditorCell_Basic;
import de.itemis.mps.mouselistener.runtime.MouseListenerProvider;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.Rectangle;
import jetbrains.mps.openapi.editor.cells.CellTraversalUtil;
import jetbrains.mps.nodeEditor.EditorSettings;
import com.intellij.ui.JBColor;
import com.intellij.util.ui.JBUI;
import java.awt.Dimension;
import java.awt.Shape;
import com.intellij.util.ui.JBInsets;
import com.intellij.ui.scale.JBUIScale;
import java.awt.geom.Path2D;
import java.awt.event.MouseListener;
import java.awt.event.MouseMotionListener;

public class EditorCell_DropDown extends EditorCell_Collection {

  private DropDownButtonCell myButtonCell;
  private EditorCell myLabelCell;

  public EditorCell_DropDown(EditorContext editorContext, SNode node, EditorCell labelCell) {
    super(editorContext, node, new CellLayout_Horizontal(), null);
    addEditorCell(labelCell);
    myLabelCell = labelCell;
    myButtonCell = new DropDownButtonCell(editorContext, node);
    addEditorCell(myButtonCell);
  }


  @Override
  protected void paintContent(Graphics g_, ParentSettings settings) {
    Graphics2D g = ((Graphics2D) g_.create());
    try {
      g.setColor(DarculaUIUtil.getOutlineColor(true, false));
      g.setStroke(new BasicStroke(1.0f));
      g.drawRect(getX(), getY(), getWidth(), getHeight());
    } finally {
      g.dispose();
    }
  }

  public void openMenu() {
    EditorComponent editorComponent = (EditorComponent) getEditorComponent();
    editorComponent.activateNodeSubstituteChooser(unwrap(myLabelCell), true, false);
  }

  public EditorCell unwrap(EditorCell cell) {
    if (cell instanceof jetbrains.mps.openapi.editor.cells.EditorCell_Collection && ((jetbrains.mps.openapi.editor.cells.EditorCell_Collection) cell).getCellsCount() == 1) {
      return unwrap(Sequence.fromIterable(((Iterable<EditorCell>) ((jetbrains.mps.openapi.editor.cells.EditorCell_Collection) cell))).first());
    } else {
      return cell;
    }
  }

  public class DropDownButtonCell extends EditorCell_Basic implements MouseListenerProvider {
    private MouseAdapter myMouseListener = new MouseAdapter() {
      @Override
      public void mouseMoved(MouseEvent event) {
        setHighlighted(new Rectangle(getX(), getY(), getWidth(), getHeight()).contains(event.getX(), event.getY()));
      }
      @Override
      public void mousePressed(MouseEvent event) {
        openMenu();
      }
    };
    private boolean isHighlighted;

    public DropDownButtonCell(EditorContext editorContext, SNode node) {
      super(editorContext, node);
    }

    public void setHighlighted(boolean highlighted) {
      if (highlighted != isHighlighted) {
        isHighlighted = highlighted;
        ((EditorComponent) getEditorComponent()).repaint(this);
      }
    }

    @Override
    protected void relayoutImpl() {
      int height = 10;
      EditorCell label = CellTraversalUtil.getFirstLeaf(myLabelCell);
      if (label != null) {
        label.relayout();
        height = label.getHeight();
      }
      setHeight(height);
      setWidth(height);
    }

    @Override
    public int getAscent() {
      return check_bhu800_a0a9n(CellTraversalUtil.getFirstLeaf(myLabelCell));
    }

    protected void paintContent(Graphics g_, ParentSettings settings) {
      Graphics2D g = (Graphics2D) g_.create();
      try {
        Rectangle bounds = new Rectangle(getX(), getY(), getWidth(), getHeight());

        g.setColor((isHighlighted ? EditorSettings.getInstance().getSelectionBackgroundColor() : JBColor.WHITE));
        g.fill(bounds);
        g.setColor(DarculaUIUtil.getOutlineColor(true, false));
        g.setStroke(new BasicStroke(1.0f));
        g.draw(bounds);
        g.setColor(JBUI.CurrentTheme.Arrow.foregroundColor(true));
        g.fill(getArrowShape(new Dimension(getWidth(), getHeight())));
      } finally {
        g.dispose();
      }
    }

    public Shape getArrowShape(Dimension dimension) {
      Rectangle r = new Rectangle(dimension);
      JBInsets.removeFrom(r, JBUI.insets(1, 0, 1, 1));
      int tW = JBUIScale.scale(9);
      int tH = JBUIScale.scale(5);
      int xU = (r.width - tW) / 2 - JBUIScale.scale(1);
      int yU = (r.height - tH) / 2 + JBUIScale.scale(1);
      Path2D path = new Path2D.Float();
      path.moveTo(getX() + xU, getY() + yU);
      path.lineTo(getX() + xU + tW, getY() + yU);
      path.lineTo(getX() + xU + tW / 2.0f, getY() + yU + tH);
      path.lineTo(getX() + xU, getY() + yU);
      path.closePath();
      return path;
    }


    @Override
    public MouseListener getMouseListener() {
      return myMouseListener;
    }

    @Override
    public MouseMotionListener getMouseMotionListener() {
      return myMouseListener;
    }
  }

  private static int check_bhu800_a0a9n(EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getAscent();
    }
    return 0;
  }
}
