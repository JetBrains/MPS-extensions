package de.q60.mps.shadowmodels.runtime.mpslike;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import java.util.Objects;

public class GenplanGenerator {

  public Genplan generate(List<MappingConfiguration> mappingConfigurationsList, List<IGenplanRule> rules) {
    Genplan plan = new Genplan(Sequence.<GenplanStep>singleton(new GenplanStep(ListSequence.fromList(mappingConfigurationsList).select((it) -> it.getId()))));

    Map<MappingConfigurationId, MappingConfiguration> mcs = MapSequence.fromMap(new HashMap<MappingConfigurationId, MappingConfiguration>());
    for (MappingConfiguration mc : ListSequence.fromList(mappingConfigurationsList)) {
      MapSequence.fromMap(mcs).put(mc.getId(), mc);
    }

    rules = Sequence.fromIterable(Sequence.<IGenplanRule>singleton(new GenplanRule_InputOutputLanguages())).concat(ListSequence.fromList(rules)).toList();

    Genplan prevPlan;
    for (int timeout = 10; timeout > 0; timeout--) {
      prevPlan = plan;
      for (IGenplanRule rule : ListSequence.fromList(rules)) {
        plan = rule.apply(plan, mcs, timeout);
      }
      if (Objects.equals(prevPlan, plan)) {
        return plan;
      }
    }

    throw new RuntimeException("Failed to compute a valid generation plan");
  }

}
