package de.itemis.mps.utils.serializer.xml.serializer;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import org.jdom2.Element;
import org.jdom2.output.XMLOutputter;
import org.jdom2.output.Format;
import java.io.StringWriter;
import java.io.IOException;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.adapter.ids.MetaIdHelper;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import org.jetbrains.mps.openapi.model.SNodeAccessUtil;
import org.jetbrains.mps.openapi.language.SEnumerationLiteral;
import jetbrains.mps.lang.structure.behavior.DataTypeDeclaration__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import java.util.Objects;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;

public class NodeSerializer extends XMLConstants {

  private SNode root;
  private SModel model;
  private boolean shortForm;
  private boolean ignoreNames;
  private boolean ignoreAnnotations = false;
  private List<String> ignoredPropertyNames;
  private boolean useDefaultValueForUnsetProperty;
  private SerializerProcessor serializerProcessor = new SerializerProcessor();

  public NodeSerializer(SModel model, boolean shortForm, String attrPrefix) {
    this(model, shortForm, attrPrefix, false);
  }

  public NodeSerializer(SModel model, boolean shortForm, String attrPrefix, boolean ignoreNames) {
    super(attrPrefix);
    this.model = model;
    this.shortForm = shortForm;
    this.ignoreNames = ignoreNames;
    this.useDefaultValueForUnsetProperty = false;
  }

  public NodeSerializer(SNode root, boolean shortForm, String attrPrefix) {
    this(root, shortForm, attrPrefix, false);
  }

  public NodeSerializer(SNode root, boolean shortForm, String attrPrefix, boolean ignoreNames) {
    super(attrPrefix);
    this.root = root;
    this.shortForm = shortForm;
    this.ignoreNames = ignoreNames;
    this.useDefaultValueForUnsetProperty = false;
  }

  public void useDefaultValueForUnsetProperty(boolean value) {
    this.useDefaultValueForUnsetProperty = value;
  }

  public void addIgnoredPropertyName(String pname) {
    if (ignoredPropertyNames == null) {
      ignoredPropertyNames = ListSequence.fromList(new ArrayList<String>());
    }
    ListSequence.fromList(ignoredPropertyNames).addElement(pname);
  }

  public void removeIgnoredPropertyName(String pname) {
    if (ignoredPropertyNames != null) {
      ListSequence.fromList(ignoredPropertyNames).removeElement(pname);
    }
  }

  public void ignoreAnnotations() {
    this.ignoreAnnotations = true;
  }

  private boolean isPropertyNameIgnored(String pname) {
    if (ignoredPropertyNames == null) {
      return false;
    }
    return ListSequence.fromList(ignoredPropertyNames).contains(pname);
  }

  public Element getXML() {
    if (this.model != null) {
      return build(this.model);
    } else {
      return build(this.root, ROOT);
    }
  }

  public String getXMLAsString() {
    XMLOutputter p = new XMLOutputter(Format.getPrettyFormat());
    StringWriter writer = new StringWriter();
    try {
      Element xmlRoot = getXML();
      serializerProcessor.postProcessXMLRoot(xmlRoot);
      p.output(xmlRoot, writer);
    } catch (Exception ignore) {
    }
    return writer.getBuffer().toString();
  }

  public void printXML() {
    try {
      XMLOutputter p = new XMLOutputter(Format.getPrettyFormat());
      p.output(getXML(), System.out);
    } catch (IOException ex) {
      ex.printStackTrace();
    }
  }

  private Element build(SModel model) {
    Element result = new Element(MODEL);
    result.setAttribute(MODEL_ID, model.getModelId().toString());
    result.setAttribute(MODEL_FQN, model.getName().getLongName());

    for (SNode root : ListSequence.fromList(SModelOperations.roots(model, null))) {
      Element child = build(root, ROOT);
      if (serializerProcessor.postProcess(child, root)) {
        result.addContent(child);
      }
    }

    return result;
  }

  private void setAttribute(Element result, String attrName, String attrValue) {
    if (!(isPropertyNameIgnored(attrName))) {
      result.setAttribute(attrName, attrValue);
    }
  }

  public void setSerializerProcessor(SerializerProcessor serializerProcessor) {
    this.serializerProcessor = serializerProcessor;
  }

  private String getEnumDefaultValue(SNode enumDecl) {
    SNode def = SLinkOperations.getTarget(enumDecl, LINKS.defaultMember$vlmG);
    if ((def == null)) {
      def = ListSequence.fromList(SLinkOperations.getChildren(enumDecl, LINKS.members$wmsL)).first();
    }
    return SPropertyOperations.getString(def, PROPS.name$MnvL);
  }

  private Element build(SNode n, String role) {
    Element result = new Element(role);
    SNode snode = n;
    SAbstractConcept concept = SNodeOperations.getConcept(n);
    setAttribute(result, NODE_ID, snode.getNodeId().toString());
    setAttribute(result, CONCEPT_FQN, snode.getConcept().getQualifiedName());
    setAttribute(result, CONCEPT_ID, MetaIdHelper.getConcept(snode.getConcept()).serialize());
    if (ROOT.equals(role) && !(shortForm)) {
      setAttribute(result, MODEL_ID, SNodeOperations.getModel(n).getModelId().toString());
      setAttribute(result, MODEL_FQN, SNodeOperations.getModel(n).getName().getLongName().toString());
    } else {
      setAttribute(result, LINK_TYPE, LINK_TYPE_CHILD);
    }

    for (SProperty property : CollectionSequence.fromCollection(concept.getProperties())) {
      if (property.getName().equals("name") && ignoreNames) {
        continue;
      }
      if (isPropertyNameIgnored(property.getName())) {
        continue;
      }

      SNode dataType = SLinkOperations.getTarget(SNodeOperations.cast(property.getDeclarationNode(), CONCEPTS.PropertyDeclaration$1S), LINKS.dataType$5j5Y);
      String value;

      if (SNodeOperations.isInstanceOf(dataType, CONCEPTS.EnumerationDeclaration$hv)) {
        // MPS 2019.2+: Enums are serialized by their name
        Object valueObj = SNodeAccessUtil.getPropertyValue(n, property);
        value = (valueObj instanceof SEnumerationLiteral ? ((SEnumerationLiteral) valueObj).getName() : null);
      } else {
        value = SNodeAccessUtil.getProperty(n, property);
      }

      if (value == null && useDefaultValueForUnsetProperty) {
        if ((boolean) DataTypeDeclaration__BehaviorDescriptor.isSimpleInteger_idhKtGkcn.invoke(dataType)) {
          value = "0";
        } else if ((boolean) DataTypeDeclaration__BehaviorDescriptor.isSimpleString_idhKtFG6a.invoke(dataType)) {
          value = "";
        } else if ((boolean) DataTypeDeclaration__BehaviorDescriptor.isSimpleBoolean_idhKtGpIQ.invoke(dataType)) {
          value = "false";
        } else if (SNodeOperations.isInstanceOf(dataType, CONCEPTS.EnumerationDeclaration$hv)) {
          value = getEnumDefaultValue(SNodeOperations.cast(dataType, CONCEPTS.EnumerationDeclaration$hv));
        }
      }

      if (value != null) {
        result.setAttribute(property.getName(), value);
      }
    }

    for (SContainmentLink containmentLink : CollectionSequence.fromCollection(concept.getContainmentLinks())) {
      if ((Objects.equals(containmentLink, LINKS.smodelAttribute$KJ43)) && ignoreAnnotations) {
        continue;
      }

      for (SNode c : snode.getChildren(containmentLink)) {
        Element child = build(c, containmentLink.getName());
        if (serializerProcessor.postProcess(child, c)) {
          result.addContent(child);
        }
      }
    }

    for (SReferenceLink referenceLink : CollectionSequence.fromCollection(concept.getReferenceLinks())) {
      if ((Objects.equals(referenceLink, LINKS.smodelAttribute$KJ43)) && ignoreAnnotations) {
        continue;
      }
      Element refElement = new Element(referenceLink.getName());
      SNode target = snode.getReferenceTarget(referenceLink);
      if (target != null) {
        setAttribute(refElement, LINK_TYPE, LINK_TYPE_REF);
        setAttribute(refElement, TARGET_NODE_ID, target.getNodeId().toString());
        setAttribute(refElement, TARGET_MODEL_ID, target.getModel().getModelId().toString());
        if (!(shortForm)) {
          setAttribute(refElement, TARGET_MODEL_FQN, target.getModel().getModelName());
          setAttribute(refElement, TARGET_CONCEPT_FQN, target.getConcept().getQualifiedName());
          if (!(ignoreNames) && target.getProperty(PROPS.name$MnvL) != null) {
            setAttribute(refElement, TARGET_NAME, target.getProperty(PROPS.name$MnvL));
          }
        }
        result.addContent(refElement);
      }
    }
    return result;
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink defaultMember$vlmG = MetaAdapterFactory.getReferenceLink(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0x2e770ca32c607c5fL, 0xeeb344f63fe016cL, "defaultMember");
    /*package*/ static final SContainmentLink members$wmsL = MetaAdapterFactory.getContainmentLink(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0x2e770ca32c607c5fL, 0x2e770ca32c607cc1L, "members");
    /*package*/ static final SReferenceLink dataType$5j5Y = MetaAdapterFactory.getReferenceLink(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0xf979bd086bL, 0xfc26f42fe5L, "dataType");
    /*package*/ static final SContainmentLink smodelAttribute$KJ43 = MetaAdapterFactory.getContainmentLink(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, 0x47bf8397520e5942L, "smodelAttribute");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept PropertyDeclaration$1S = MetaAdapterFactory.getConcept(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0xf979bd086bL, "jetbrains.mps.lang.structure.structure.PropertyDeclaration");
    /*package*/ static final SConcept EnumerationDeclaration$hv = MetaAdapterFactory.getConcept(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0x2e770ca32c607c5fL, "jetbrains.mps.lang.structure.structure.EnumerationDeclaration");
  }
}
