package de.slisson.mps.tables.runtime.gridmodel;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.smodel.IllegalModelAccessError;
import jetbrains.mps.smodel.action.NodeFactoryManager;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class ChildNodesInsertAction implements IHeaderNodeInsertAction {
  private SNode myParentNode;
  private SNode myLinkDeclaration;

  public ChildNodesInsertAction(SNode parentNode, SNode linkDeclaration) {
    myParentNode = parentNode;
    myLinkDeclaration = linkDeclaration;
  }

  public void insertNew(int index) {
    Iterable<SContainmentLink> links = SNodeOperations.getConcept(myParentNode).getContainmentLinks();
    SContainmentLink link = Sequence.fromIterable(links).findFirst((it) -> Objects.equals(it.getRoleName(), SPropertyOperations.getString(myLinkDeclaration, PROPS.role$Nsjf)));

    SNode newChild = createNewChild();
    List<SNode> childs = SNodeOperations.getChildren(myParentNode, link);
    try {
      ListSequence.fromList(childs).insertElement(index, newChild);
    } catch (IllegalModelAccessError error) {
      ListSequence.fromList(childs).addElement(newChild);
    }
  }

  protected SNode createNewChild() {
    return NodeFactoryManager.createNode(SNodeOperations.asSConcept(SLinkOperations.getTarget(myLinkDeclaration, LINKS.target$m40F)), null, myParentNode, SNodeOperations.getModel(myParentNode));
  }

  private static final class PROPS {
    /*package*/ static final SProperty role$Nsjf = MetaAdapterFactory.getProperty(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0xf979bd086aL, 0xf98052f333L, "role");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink target$m40F = MetaAdapterFactory.getReferenceLink(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0xf979bd086aL, 0xf98055fef0L, "target");
  }
}
