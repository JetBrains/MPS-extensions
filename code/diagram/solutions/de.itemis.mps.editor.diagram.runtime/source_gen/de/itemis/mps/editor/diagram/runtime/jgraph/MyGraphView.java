package de.itemis.mps.editor.diagram.runtime.jgraph;

/*Generated by MPS */

import com.mxgraph.view.mxGraphView;
import com.mxgraph.util.mxPoint;
import com.mxgraph.view.mxCellState;
import jetbrains.mps.openapi.editor.EditorComponent;
import de.itemis.mps.editor.diagram.runtime.model.ScalableEditorCell;
import jetbrains.mps.internal.collections.runtime.IMapping;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import com.mxgraph.util.mxRectangle;
import com.mxgraph.model.mxGeometry;
import de.itemis.mps.editor.diagram.runtime.model.Edge;
import com.mxgraph.view.mxPerimeter;
import java.awt.Shape;
import java.awt.geom.PathIterator;
import org.apache.commons.math3.geometry.euclidean.twod.Vector2D;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.awt.geom.Line2D;
import de.itemis.mps.editor.diagram.runtime.shape.IShape;
import de.itemis.mps.editor.diagram.runtime.model.Box;

public class MyGraphView extends mxGraphView {

  private boolean myMPSCellLayoutingSuspended = false;
  private mxPoint myDefaultTranslation = new mxPoint(0.0, ContextButton.DEFAULT_BUTTON_SIZE + ContextButton.DEFAULT_BUTTON_SPACING * 2);
  private boolean wasAutoLayout = false;

  public MyGraphView(MyGraph graph) {
    super(graph);
    setScale(1.0);
    setTranslate(getDefaultTranslation());
  }

  public void setWasAutoLayout(boolean flag) {
    synchronized (this) {
      wasAutoLayout = flag;
    }
  }

  public boolean wasAutoLayout() {
    synchronized (this) {
      return wasAutoLayout;
    }
  }

  public mxPoint getDefaultTranslation() {
    return new mxPoint(myDefaultTranslation);
  }

  @Override
  public MyGraph getGraph() {
    return (MyGraph) super.getGraph();
  }

  @Override
  public void updateCellState(final mxCellState state) {
    EditorComponent editorComponent = getGraph().getEditorComponent();
    LayoutDependencies ldep = LayoutDependencies.getInstance(editorComponent);
    ldep.layoutAndRecordDependencies(new LayoutDependencies.mxCellStateLayoutable(state) {
      @Override
      public void layout() {
        MyGraphView.super.updateCellState(state);

        // embedded editor cells
        if (!(myMPSCellLayoutingSuspended)) {
          if (state.getCell() instanceof IMPSCellContainer) {
            ScalableEditorCell.withScalingDisabled(() -> BaseDiagramECell.withContextGraph(getGraph(), () -> {
              IMPSCellContainer mpsCellContainer = (IMPSCellContainer) state.getCell();
              mpsCellContainer.updateMPSCellPositions(MyGraphView.this, state);
            }));
          }
        }

        // buttons on (sub-)diagrams
        if (state.getCell() instanceof BaseDiagramDCell) {
          BaseDiagramDCell diagramDCell = (BaseDiagramDCell) state.getCell();
          diagramDCell.updateButtons(state);
        }
      }
    });
  }

  public void suspendMPSCellLayouting(Runnable runnable) {
    boolean wasSuspended = myMPSCellLayoutingSuspended;
    try {
      myMPSCellLayoutingSuspended = true;
      runnable.run();
    } finally {
      myMPSCellLayoutingSuspended = wasSuspended;
    }
  }

  public void updateCellStyles() {
    for (IMapping<Object, mxCellState> state : MapSequence.fromMap(states)) {
      state.value().setStyle(graph.getCellStyle(state.key()));
    }
  }


  @Override
  public void updateLabelBounds(mxCellState state) {
    // performance optimization
    String label = state.getLabel();
    if (label == null || "".equals(label)) {
      state.setLabelBounds(new mxRectangle(state.getX(), state.getY(), 1, 1));
      return;
    }

    super.updateLabelBounds(state);
  }

  @Override
  public void updateEdgeState(mxCellState state, mxGeometry geometry) {
    super.updateEdgeState(state, geometry);
    Edge edge = check_fobz2r_a0b0y(as_fobz2r_a0a0b0y(state.getCell(), EdgeDCell.class));
  }


  @Override
  public mxPerimeter.mxPerimeterFunction getPerimeterFunction(mxCellState state) {

    Shape shape = check_fobz2r_a0b0bb(check_fobz2r_a0a1a72(check_fobz2r_a0a0b0bb(as_fobz2r_a0a0a0b0bb(check_fobz2r_a0a0a0b0bb(state), BoxDCell.class))), state);
    if (shape != null) {
      return new mxPerimeter.mxPerimeterFunction() {
        @Override
        public mxPoint apply(mxRectangle bounds, mxCellState vertex, final mxPoint next, boolean orthogonal) {
          Shape shape = check_fobz2r_a0a0a0a0a0c0bb(check_fobz2r_a0a0a0a0a0a2a72(check_fobz2r_a0a0a0a0a0a0c0bb(as_fobz2r_a0a0a0a0a0a0a0c0bb(check_fobz2r_a0a0a0a0a0a0a0c0bb(vertex), BoxDCell.class))), bounds);
          PathIterator itr = shape.getPathIterator(null, 1.0);
          Vector2D firstPoint = null;
          final Wrappers._T<Vector2D> closestPoint = new Wrappers._T<Vector2D>(null);
          final Wrappers._double closestDistance = new Wrappers._double(0.0);
          Vector2D lastPoint = null;
          double[] coordinates = new double[6];
          _FunctionTypes._void_P1_E0<? super Line2D> lineHandler = (Line2D line) -> {
            Vector2D projectedPoint = JGraphUtil.projectPointOnLine(VectorExtensions.toVector2D(next), line, true);
            double currentDistance = projectedPoint.distance(VectorExtensions.toVector2D(next));
            if (closestPoint.value == null || currentDistance < closestDistance.value) {
              closestPoint.value = projectedPoint;
              closestDistance.value = currentDistance;
            }
          };
          while (!(itr.isDone())) {
            int type = itr.currentSegment(coordinates);
            Vector2D currentPoint = new Vector2D(coordinates[0], coordinates[1]);
            switch (type) {
              case PathIterator.SEG_LINETO:
                lineHandler.invoke(VectorExtensions.lineTo(lastPoint, currentPoint));
                lastPoint = currentPoint;
                break;
              case PathIterator.SEG_MOVETO:
                lastPoint = currentPoint;
                break;
              case PathIterator.SEG_CLOSE:
                lineHandler.invoke(VectorExtensions.lineTo(lastPoint, firstPoint));
                lastPoint = firstPoint;
                break;
            }
            if (firstPoint == null) {
              firstPoint = lastPoint;
            }
            itr.next();
          }

          return (closestPoint.value != null ? VectorExtensions.toMxPoint(closestPoint.value) : null);
        }
      };
    }

    return super.getPerimeterFunction(state);
  }
  private static Edge check_fobz2r_a0b0y(EdgeDCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getEdge();
    }
    return null;
  }
  private static Shape check_fobz2r_a0b0bb(IShape checkedDotOperand, mxCellState state) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getShape(ExtensionMethods.toRectangle2D(ExtensionMethods.toBounds(state)));
    }
    return null;
  }
  private static IShape check_fobz2r_a0a1a72(Box checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getShape();
    }
    return null;
  }
  private static Box check_fobz2r_a0a0b0bb(BoxDCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getBox();
    }
    return null;
  }
  private static Object check_fobz2r_a0a0a0b0bb(mxCellState checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCell();
    }
    return null;
  }
  private static Shape check_fobz2r_a0a0a0a0a0c0bb(IShape checkedDotOperand, mxRectangle bounds) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getShape(ExtensionMethods.toRectangle2D(bounds));
    }
    return null;
  }
  private static IShape check_fobz2r_a0a0a0a0a0a2a72(Box checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getShape();
    }
    return null;
  }
  private static Box check_fobz2r_a0a0a0a0a0a0c0bb(BoxDCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getBox();
    }
    return null;
  }
  private static Object check_fobz2r_a0a0a0a0a0a0a0c0bb(mxCellState checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getCell();
    }
    return null;
  }
  private static <T> T as_fobz2r_a0a0b0y(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_fobz2r_a0a0a0b0bb(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_fobz2r_a0a0a0a0a0a0a0c0bb(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
