package com.mbeddr.mpsutil.treenotation.runtime;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import java.awt.event.MouseEvent;
import jetbrains.mps.editor.runtime.cells.ReadOnlyUtil;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.editor.runtime.commands.EditorCommand;
import com.intellij.openapi.ui.popup.util.BaseListPopupStep;
import com.intellij.openapi.ui.popup.PopupStep;
import com.intellij.openapi.ui.popup.ListPopup;
import com.intellij.openapi.ui.popup.JBPopupFactory;
import com.intellij.ui.awt.RelativePoint;
import java.awt.Graphics2D;
import jetbrains.mps.nodeEditor.MPSColors;
import java.awt.geom.Line2D;
import javax.swing.Icon;
import java.awt.Component;
import java.awt.Graphics;
import java.awt.geom.Rectangle2D;
import com.intellij.ui.JBColor;
import java.awt.BasicStroke;
import java.awt.FontMetrics;

public class InsertButton extends Button {

  private List<IInsertHandler> myInsertHandlers;
  private int myIndex;
  private _FunctionTypes._return_P0_E0<? extends Boolean> myLeftToRight;

  public InsertButton(@NotNull EditorContext editorContext, SNode node, List<IInsertHandler> insertHandlers, int index, _FunctionTypes._return_P0_E0<? extends Boolean> leftToRight) {
    super(editorContext, node);
    myInsertHandlers = insertHandlers;
    myLeftToRight = leftToRight;
    myIndex = index;
  }

  @Override
  public void onClick(MouseEvent event) {
    if (ReadOnlyUtil.isCellReadOnly(this)) {
      return;
    }

    if (ListSequence.fromList(myInsertHandlers).isEmpty()) {

    } else if (ListSequence.fromList(myInsertHandlers).count() == 1) {
      getContext().getRepository().getModelAccess().executeCommand(new EditorCommand(getContext()) {
        @Override
        protected void doExecute() {
          ListSequence.fromList(myInsertHandlers).first().insert(getContext(), getSNode(), myIndex);
        }
      });
    } else {
      BaseListPopupStep<IInsertHandler> popupStep = new ConnectionTypePopupStep(myInsertHandlers) {
        @Override
        public PopupStep onChosen(final IInsertHandler selected, final boolean finalChoice) {
          getContext().getRepository().getModelAccess().executeCommand(new EditorCommand(getContext()) {
            @Override
            protected void doExecute() {
              selected.insert(getContext(), getSNode(), myIndex);
            }
          });
          return super.onChosen(selected, finalChoice);
        }
      };
      ListPopup createListPopup = JBPopupFactory.getInstance().createListPopup(popupStep);
      createListPopup.show(new RelativePoint(event));
    }
  }

  @Override
  protected void paintSymbol(Graphics2D g) {
    if (ReadOnlyUtil.isCellReadOnly(this)) {
      return;
    }

    double width = getWidth();
    double padding = width * 0.2;
    g.setColor(MPSColors.DARK_GREEN);
    if (myLeftToRight.invoke()) {
      g.draw(new Line2D.Double(getX() + padding, getY() + padding, getX() + getWidth() - padding, getY() + getHeight() / 2));
      g.draw(new Line2D.Double(getX() + padding, getY() + getHeight() - padding, getX() + getWidth() - padding, getY() + getHeight() / 2));
    } else {
      g.draw(new Line2D.Double(getX() + padding, getY() + padding, getX() + getWidth() / 2, getY() + getHeight() - padding));
      g.draw(new Line2D.Double(getX() + getWidth() - padding, getY() + padding, getX() + getWidth() / 2, getY() + getHeight() - padding));
    }
  }

  public class ConnectionTypePopupStep extends BaseListPopupStep<IInsertHandler> {

    public ConnectionTypePopupStep(List<IInsertHandler> values) {
      super("Choose Child to Insert", values);
    }

    @NotNull
    @Override
    public String getTextFor(IInsertHandler type) {
      return "" + type.getDescription();
    }

    @Override
    public Icon getIconFor(IInsertHandler type) {
      Icon icon = type.getIcon();
      if (icon == null) {
        icon = new FirstCharIcon(type);
      } else {
        icon = new ScaledIcon(16, 16, icon);
      }
      return icon;
    }
  }

  public static class FirstCharIcon implements Icon {
    private IInsertHandler myHandler;

    public FirstCharIcon(IInsertHandler handler) {
      myHandler = handler;
    }

    public int getIconHeight() {
      return 16;
    }

    public int getIconWidth() {
      return 16;
    }

    public void paintIcon(Component component, Graphics g_, int x, int y) {
      int w = getIconWidth();
      int h = getIconHeight();
      Rectangle2D.Double bounds = new Rectangle2D.Double(x, y, w, h);

      Graphics2D g = ((Graphics2D) g_.create());
      try {
        g.setColor(JBColor.WHITE);
        g.fill(bounds);
        g.setColor(JBColor.GRAY);
        g.setStroke(new BasicStroke(1.0f));
        g.draw(bounds);
        g.setColor(JBColor.BLACK);

        String text = myHandler.getDescription();
        if (text == null) {
          text = "";
        }
        if (text.length() > 1) {
          text = text.substring(0, 1);
        }
        drawText(g, text, bounds);
      } finally {
        g.dispose();
      }
    }

    public void drawText(Graphics2D g, String text, Rectangle2D bounds) {
      double padding = bounds.getWidth() * 0.1;
      bounds = new Rectangle2D.Double(bounds.getX() + padding, bounds.getY() + padding, bounds.getWidth() - padding * 2, bounds.getHeight() - padding * 2);
      g.setFont(g.getFont().deriveFont(7.0f));
      FontMetrics fontMetrics = g.getFontMetrics();
      Rectangle2D stringBounds = fontMetrics.getStringBounds(text, g);
      g.translate(bounds.getX(), bounds.getY());
      g.scale(bounds.getWidth() / stringBounds.getWidth(), bounds.getHeight() / stringBounds.getHeight());
      g.translate(-stringBounds.getX(), -stringBounds.getY());
      g.drawString(text, 0.0f, 0.0f);
    }
  }

}
