package de.itemis.mps.comparator.code;

/*Generated by MPS */

import jetbrains.mps.generator.GenerationStatus;
import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.SModelReference;
import com.intellij.openapi.project.Project;
import jetbrains.mps.messages.IMessageHandler;
import jetbrains.mps.generator.GenerationParametersProvider;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPointerOperations;
import jetbrains.mps.generator.GenerationOptions;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.generator.InterpretedPlanProvider;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.generator.ModelGenerationPlan;
import jetbrains.mps.generator.GenPlanExtractor;
import jetbrains.mps.generator.impl.plan.GenerationPlan;
import jetbrains.mps.generator.TransientModelsProvider;
import jetbrains.mps.progress.EmptyProgressMonitor;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.generator.GenerationFacade;
import jetbrains.mps.generator.GenerationTaskRecorder;
import jetbrains.mps.generator.GeneratorTask;

public class GeneratorFacade {

  public GenerationStatus runGenerator(SRepository repo, @Nullable SNode plan, SModelReference modelToGenerate, Project project, IMessageHandler messageHandler) {
    return runGenerator(repo, plan, modelToGenerate, project, messageHandler, ((GenerationParametersProvider) null));
  }

  public GenerationStatus runGenerator(SRepository repo, @Nullable SNode plan, SModel modelToGenerate, Project project, IMessageHandler messageHandler) {
    return runGenerator(repo, plan, modelToGenerate, project, messageHandler, ((GenerationParametersProvider) null));
  }

  public GenerationStatus runGenerator(SRepository repo, SNode plan, SModelReference modelToGenerate, Project project, IMessageHandler messageHandler, GenerationParametersProvider paramsProvider) {
    return runGenerator(repo, plan, SPointerOperations.resolveModel(modelToGenerate, repo), project, messageHandler, paramsProvider);
  }

  public GenerationStatus runGenerator(SRepository repo, SNode plan, SModel modelToGenerate, Project project, IMessageHandler messageHandler, GenerationParametersProvider paramsProvider) {

    GenerationOptions.OptionsBuilder defaults = defaultOptionsBuilder(paramsProvider);
    return runGenerator(repo, plan, modelToGenerate, project, messageHandler, defaults);
  }

  public static GenerationOptions.OptionsBuilder defaultOptionsBuilder(GenerationParametersProvider paramsProvider) {
    GenerationOptions.OptionsBuilder defaults = GenerationOptions.getDefaults();
    defaults.saveTransientModels(false);
    defaults.generateInParallel(true, 4);
    if (paramsProvider != null) {
      defaults.parameters(paramsProvider);
    }
    return defaults;
  }

  public GenerationStatus runGenerator(SRepository repo, @Nullable SNode plan, SModelReference modelToGenerate, Project project, IMessageHandler messageHandler, @NotNull GenerationOptions.OptionsBuilder defaults) {
    return runGenerator(repo, plan, SPointerOperations.resolveModel(modelToGenerate, repo), project, messageHandler, defaults);
  }

  public GenerationStatus runGenerator(SRepository repo, @Nullable SNode plan, SModel modelToGenerate, Project project, IMessageHandler messageHandler, @NotNull GenerationOptions.OptionsBuilder defaults) {
    if (defaults.create().getCustomPlan(modelToGenerate) == null) {
      if ((plan != null)) {
        InterpretedPlanProvider planProvider = new InterpretedPlanProvider(LanguageRegistry.getInstance(repo), messageHandler, SNodeOperations.getPointer(plan), repo);
        ModelGenerationPlan genPlan = planProvider.getPlan(modelToGenerate);
        assert genPlan != null;
        defaults.customPlan(modelToGenerate, genPlan);
      } else {
        GenPlanExtractor extractor = new GenPlanExtractor(repo, messageHandler);
        ModelGenerationPlan genPlan;
        if (extractor.hasPlan(modelToGenerate)) {
          genPlan = extractor.getPlan(modelToGenerate);
        } else {
          genPlan = new GenerationPlan(modelToGenerate);
        }
        defaults.customPlan(modelToGenerate, genPlan);
      }

    }

    GenerationOptions options = defaults.create();
    TransientModelsProvider tmp = project.getComponent(TransientModelsProvider.class);
    return runGenerator(repo, options, modelToGenerate, tmp, messageHandler, new EmptyProgressMonitor());
  }

  public GenerationStatus runGenerator(SRepository repo, GenerationOptions options, SModel modelToGenerate, TransientModelsProvider tmp, IMessageHandler messageHandler, ProgressMonitor monitor) {

    GenerationFacade genFacade = new GenerationFacade(repo, options);
    tmp.removeAllTransient();

    GenerationTaskRecorder<GeneratorTask> taskHandler = new GenerationTaskRecorder<GeneratorTask>(null);
    genFacade.transients(tmp).messages(messageHandler).taskHandler(taskHandler);
    GenerationStatus process = genFacade.process(monitor, modelToGenerate);

    return process;
  }


}
